{"id":"bd-179","title":"MCP Agent Mail Rust: 100% feature parity + conformance + benchmarks","description":"Goal: complete the Rust port of legacy_python_mcp_agent_mail_code with 100% behavior/feature coverage, proven by fixture-based conformance tests + benchmarks (similar standard as rich_rust/beads_rust).\n\nNon-negotiables:\n- Prefer local crates over upstream ecosystem where applicable:\n  - MCP: /dp/fastmcp_rust\n  - SQLite: /dp/sqlmodel_rust\n  - IO/concurrency: /dp/asupersync (avoid tokio unless unavoidable)\n  - Console UI: /dp/frankentui\n  - Beads: /dp/beads_rust\n  - Agent detection: /dp/coding_agent_session_search\n- No destructive commands or file deletions without explicit permission.\n\nAcceptance criteria:\n-  passes\n-  passes\n- \nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 2 tests\ntest load_and_validate_fixture_schema ... ok\ntest run_fixtures_against_rust_server_router ... ok\n\ntest result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.08s\n\n\nrunning 7 tests\ntest config::tests::test_default_config ... ok\ntest error::tests::test_error_types ... ok\ntest config::tests::test_from_env ... ok\ntest error::tests::test_recoverable ... ok\ntest models::tests::test_invalid_agent_names ... ok\ntest models::tests::test_generate_agent_name ... ok\ntest models::tests::test_valid_agent_names ... ok\n\ntest result: ok. 7 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 8 tests\ntest pool::tests::test_sqlite_path_parsing ... ok\ntest timestamps::tests::test_iso_to_micros ... ok\ntest timestamps::tests::test_epoch_boundary ... ok\ntest timestamps::tests::test_negative_timestamps ... ok\ntest timestamps::tests::test_now_micros ... ok\ntest timestamps::tests::test_round_trip ... ok\ntest timestamps::tests::test_micros_to_iso ... ok\ntest pool::tests::test_schema_init_in_memory ... ok\n\ntest result: ok. 8 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 1 test\ntest crates/mcp-agent-mail-core/src/models.rs - models::is_valid_agent_name (line 318) ... ok\n\ntest result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\nall doctests ran in 0.18s; merged doctests compilation took 0.17s\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s passes\n- Conformance harness covers *all* MCP tools and resources, including error cases + nondeterministic field normalization.\n- Benchmarks include DB/tool hot paths + archive write throughput once storage layer is implemented.\n","status":"tombstone","priority":0,"issue_type":"epic","created_at":"2026-02-05T05:04:26.956492167Z","created_by":"ubuntu","updated_at":"2026-02-05T05:38:40.435532507Z","closed_at":"2026-02-05T05:05:57.078301787Z","close_reason":"Superseded by br-2ei (correct prefix + clean description)","source_repo":".","deleted_at":"2026-02-05T05:38:40.435526636Z","deleted_by":"ubuntu","delete_reason":"bad prefix legacy epic; superseded by br-2ei","original_type":"epic","compaction_level":0,"original_size":0}
{"id":"br-1bm","title":"HTTP Server Parity: Legacy Python Exact Match","description":"Purpose:\nAchieve exact HTTP + MCP parity with legacy Python mcp_agent_mail server behavior. This epic owns every remaining HTTP-path gap and ensures parity is proven with unit tests, conformance fixtures (where applicable), and detailed E2E scripts. No \"best-of-both-worlds\" deviations.\n\nScope (must be 1:1 with Python behavior):\n- JWT auth: HS256 + JWKS, audience/issuer validation, role claim extraction\n- RBAC behavior tied to roles and localhost bypass\n- Redis-backed token-bucket rate limiting with Lua script parity\n- Accurate client peer address detection for localhost bypass + rate limit identity\n- Stateless Streamable HTTP MCP transport behavior (Accept/Content-Type normalization, base path mount, passthrough route, Authorization injection)\n- SSR Mail UI under /mail/* with template + markdown/sanitization parity\n- HTTP request logging + optional OTEL hooks parity (if enabled in config)\n- CORS parity (origins/methods/headers/credentials)\n\nNon-goals:\n- No new endpoints or UX changes beyond legacy behavior\n- No compatibility shims; fix Rust directly\n- No tokio usage; only asupersync/fastmcp/sqlmodel/etc per repo rules\n\nCross-repo dependencies:\n- Client peer address requires upstream asupersync work (tracked here as br-2ei.6.3).\n\nNotes for future maintainers:\n- Always compare against legacy mcp_agent_mail/src/mcp_agent_mail/http.py\n- Prefer explicit test vectors over implicit correctness\n- Keep error payloads identical (status + JSON body)\n\n## Success Criteria\n1. All child tasks under br-1bm are complete.\n2. Unit + integration tests pass for each HTTP subsystem (JWT, bearer, rate limit, peer addr, streamable, /mail UI, CORS, logging/OTEL, health endpoints).\n3. HTTP E2E parity suite (br-2ei.9.6) passes with detailed transcripts + server logs.\n4. Manual spot-check parity passes (health endpoints, auth flows, rate limiting, /mail UI).","status":"open","priority":1,"issue_type":"epic","created_at":"2026-02-05T05:32:32.057076856Z","created_by":"ubuntu","updated_at":"2026-02-05T06:12:20.184213913Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:48:14.330942304Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.1","title":"JWT Auth Parity (HS256 + JWKS + role claim)","description":"Objective:\nImplement JWT authentication exactly as in legacy Python (mcp_agent_mail/http.py). This includes HS256 HMAC and JWKS verification paths, audience/issuer validation, role extraction, and error semantics. Must be 1:1 on outputs and failure modes.\n\nLegacy Reference Behavior (must match):\n- If JWT enabled and Authorization missing or not Bearer: 401 {\"detail\":\"Unauthorized\"}\n- Decode token using:\n  - If JWKS URL set: fetch JWKS, select key by header.kid, verify\n  - Else if secret set: verify with HMAC secret\n  - Algorithms from HTTP_JWT_ALGORITHMS (default HS256)\n- Validate audience/issuer if configured; otherwise ignore\n- On any failure: 401 {\"detail\":\"Unauthorized\"}\n- Extract roles from claim HTTP_JWT_ROLE_CLAIM (default \"role\")\n  - String -> singleton set\n  - List/tuple -> set of strings\n  - Else -> empty\n- If roles empty, use HTTP_RBAC_DEFAULT_ROLE\n- Store claims for rate limit identity (sub) and any downstream uses\n\nImplementation Considerations:\n- JWKS fetch must be async-safe via asupersync HTTP client (no tokio)\n- Cache JWKS by URL with TTL to avoid per-request latency\n- Must not change external response schema or status codes\n- Log auth failures at debug/trace (no extra HTTP output)\n\nTests and E2E (with detailed logging):\nUnit tests:\n- Missing Authorization header -> 401\n- Non-Bearer Authorization -> 401\n- HS256 valid/invalid signatures\n- JWKS valid/invalid (kid missing, bad signature)\n- Audience/issuer mismatch -> 401\n- Role claim variants (string, list, missing)\nIntegration tests:\n- Start server with HTTP_JWT_* env vars; make requests with valid/invalid JWT\n- Verify RBAC path uses roles correctly\nE2E:\n- Covered by `br-1bm.1.5` (uses shared harness `br-2ei.9.1`).\n\nNotes:\n- Localhost bypass logic is owned by `br-1bm.3` + `br-1bm.8`; JWT must still match legacy in the non-bypass path.\n\n## Acceptance Criteria\n- JWT behavior matches legacy for all vectors extracted in `br-1bm.1.1`.\n- Role extraction matches Python behavior across all supported claim shapes.\n- `br-1bm.1.5` unit+integration+E2E suite passes and produces high-signal artifacts on failure.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:32:46.671284098Z","created_by":"ubuntu","updated_at":"2026-02-05T06:39:02.211123869Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.1","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.1.1","title":"JWT Parity: extract legacy behavior + test vectors","description":"Purpose:\nExtract exact legacy JWT behavior and define concrete test vectors so Rust matches Python 1:1.\n\nLegacy Implementation Notes (from http.py):\n- Header parse: token.split(\".\",1)[0]; base64url decode with padding; JSON parse. Any error -> None.\n- If jwks_url set:\n  - httpx.AsyncClient(timeout=5) GET jwks_url -> .json()\n  - JsonWebKey.import_key_set(jwks)\n  - kid = header.get(\"kid\"); key = find_by_kid(kid) if present else key_set.keys[0]\n- Else if secret set:\n  - JsonWebKey.import_key(secret, {\"kty\":\"oct\"})\n- If key None -> Unauthorized.\n- jwt.decode(token, key) using algs from HTTP_JWT_ALGORITHMS (default [\"HS256\"]). Any error -> Unauthorized.\n- If audience configured: claims.validate_aud(audience)\n- If issuer configured: if str(claims.get(\"iss\") or \"\") != issuer -> Unauthorized (no fallback)\n- claims.validate() (handles exp/nbf/iat if present)\n- Returns dict(claims) on success.\n\nConcrete Test Vectors (must implement):\n1) Missing Authorization header -> 401 {\"detail\":\"Unauthorized\"}\n2) Authorization not Bearer -> 401\n3) Header parse fail (malformed base64 / non-JSON header) -> 401\n4) JWKS path:\n   - jwks_url set, kid present, matching key -> success\n   - jwks_url set, kid present, no matching key -> 401\n   - jwks_url set, kid missing -> uses first key in key_set\n   - jwks fetch fails / invalid JSON -> 401\n5) Secret path:\n   - jwt_secret set, HS256 valid -> success\n   - jwt_secret set, signature invalid -> 401\n6) Algorithms:\n   - alg not in HTTP_JWT_ALGORITHMS -> 401\n7) Audience:\n   - jwt_audience set, token aud matches -> success\n   - jwt_audience set, token aud mismatch -> 401\n8) Issuer:\n   - jwt_issuer set, token iss matches exactly -> success\n   - jwt_issuer set, token iss missing or different -> 401\n9) Claims validate:\n   - exp in past -> 401\n   - nbf in future -> 401\n   - exp/nbf absent -> ok\n10) Role claim:\n   - role claim string -> roles={string}\n   - role claim list -> roles={strings}\n   - role claim missing/invalid -> roles empty -> default role applied downstream\n\nDeliverable:\n- A markdown or JSON matrix of inputs -> expected HTTP status/body and roles extracted.\n- Must be explicit enough that Rust tests can be derived directly.\n\nDependencies: none (spec extraction only).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:37:09.570324403Z","created_by":"ubuntu","updated_at":"2026-02-05T07:37:27.060998320Z","closed_at":"2026-02-05T07:37:27.060980056Z","close_reason":"Extracted legacy JWT behavior + explicit test vectors in bead description","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.1.1","depends_on_id":"br-1bm.1","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.1.2","title":"JWT Parity: JWKS fetch + cache","description":"Implement JWKS retrieval via `asupersync` HTTP client with cache + TTL.\n\nRequirements:\n- Select key by JWT header `kid`.\n- Support key rotation (refresh on cache expiry and/or kid-miss per legacy).\n- On fetch failure or missing key, reject with 401 (legacy-equivalent body).\n- Log debug details without changing HTTP output.\n\n## Acceptance Criteria\n- Cache behavior matches legacy:\n  - TTL respected\n  - refresh behavior on kid-miss matches spec\n- Failure semantics:\n  - network failure → 401 with legacy body\n  - JWKS parse failure → 401 with legacy body\n  - kid missing/unknown → 401 with legacy body\n- Tests:\n  - Unit tests cover cache hit/miss, TTL expiry, and kid-miss refresh.\n  - Integration test uses a local JWKS HTTP fixture server and validates rotation behavior.\n- No tokio runtime required (uses asupersync).","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:37:13.638466525Z","created_by":"ubuntu","updated_at":"2026-02-05T06:32:58.041505984Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.1.2","depends_on_id":"br-1bm.1","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.1.2","depends_on_id":"br-1bm.1.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.1.3","title":"JWT Parity: HS256 HMAC validation","description":"Implement HS256 validation path using shared secret when JWKS URL is not set.\n\nRequirements:\n- Respect `HTTP_JWT_ALGORITHMS` allowlist.\n- Reject if algorithm not allowed or signature invalid.\n- Match legacy failure semantics (401 Unauthorized + legacy JSON body).\n\n## Acceptance Criteria\n- Valid HS256 tokens are accepted when configured.\n- Tokens with disallowed algorithms are rejected.\n- Invalid signatures are rejected.\n- Tests:\n  - Unit tests validate success/failure vectors from `br-1bm.1.1`.\n  - Integration test covers HS256 path via real HTTP request to server.\n- Implementation is deterministic and does not leak secret material into logs.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:37:17.486504145Z","created_by":"ubuntu","updated_at":"2026-02-05T06:33:03.911818575Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.1.3","depends_on_id":"br-1bm.1","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.1.3","depends_on_id":"br-1bm.1.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.1.4","title":"JWT Parity: claim validation + RBAC role extraction","description":"Implement claim validation and RBAC role extraction exactly as legacy.\n\nScope:\n- `aud`/`iss` validation rules\n- `exp`/`nbf` validation (including any skew)\n- Role extraction:\n  - claim name = `HTTP_JWT_ROLE_CLAIM`\n  - defaults when empty/missing\n  - accepted claim types (string/array/etc) per legacy\n- Store claims in request context for downstream logic (rate-limit identity via `sub`).\n\n## Acceptance Criteria\n- Validation behavior matches vectors from `br-1bm.1.1` (status + body).\n- Role extraction matches legacy for:\n  - missing claim\n  - empty claim\n  - wrong type claim\n  - multiple roles claim (if supported)\n- Request context contains the same fields used by downstream code (sub/roles/etc).\n- Tests:\n  - Unit tests cover all validation failure modes.\n  - Integration tests validate that rate-limit identity prefers JWT sub when present.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:37:21.209581347Z","created_by":"ubuntu","updated_at":"2026-02-05T06:33:13.364872020Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.1.4","depends_on_id":"br-1bm.1","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.1.4","depends_on_id":"br-1bm.1.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.1.4","depends_on_id":"br-1bm.1.3","type":"blocks","created_at":"2026-02-05T05:37:39.080720838Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.1.5","title":"JWT Parity: unit + integration + E2E tests","description":"Build comprehensive JWT parity tests with detailed logging + artifacts.\n\nTest layers:\n- Unit tests:\n  - parsing/validation failures\n  - HS256 success/failure\n  - JWKS success/failure\n  - audience/issuer mismatch\n  - role claim parsing\n- Integration tests:\n  - spin up server with env config\n  - hit representative HTTP endpoints\n- E2E script:\n  - scripted curl/httpx cases\n  - log expected vs actual status/body\n  - store artifacts under `tests/artifacts/jwt/<timestamp>/`\n\n## Acceptance Criteria\n- Vector coverage:\n  - All vectors defined in `br-1bm.1.1` are exercised.\n- Deterministic logs:\n  - E2E output includes a per-case diff on mismatch (expected vs actual JSON).\n  - Artifacts include server logs + client transcripts.\n- Exit behavior:\n  - Script exits non-zero on first mismatch.\n- No secret leakage:\n  - Logs do not print shared secrets or private keys.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:37:26.048333340Z","created_by":"ubuntu","updated_at":"2026-02-05T06:33:20.587563217Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.1.5","depends_on_id":"br-1bm.1","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.1.5","depends_on_id":"br-1bm.1.4","type":"blocks","created_at":"2026-02-05T05:37:41.877811316Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.1.5","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:55.883829187Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.10","title":"HTTP Background Workers Parity: ack TTL + escalation + metrics emit + cleanup","description":"Port legacy Python HTTP background worker behavior (spawned at HTTP app startup).\n\nLegacy (Python `http.py`):\n- Startup spawns background tasks when enabled by config:\n  - file reservations cleanup worker\n  - ACK TTL worker + escalation\n  - tool metrics emit worker\n  - retention/quota report worker (best-effort)\n\nRust constraints:\n- No tokio runtime; use asupersync scheduling primitives or dedicated threads.\n- Workers must be best-effort: never crash the HTTP server.\n\n## Success Criteria\n1. Worker enable/disable flags match legacy env parsing + defaults.\n2. ACK TTL worker matches legacy query semantics and escalation modes.\n3. Worker logs are structured + non-spammy; errors are suppressed as in legacy.\n4. Unit/integration/E2E tests cover ACK TTL worker (and at least smoke tool metrics emit).\n5. Cleanup + retention/quota + metrics workers have unit/integration coverage and E2E smoke paths with captured logs.","status":"open","priority":1,"issue_type":"epic","created_at":"2026-02-05T07:32:28.058041886Z","created_by":"ubuntu","updated_at":"2026-02-05T08:50:59.702582866Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.10","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T07:32:28.058041886Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.10.1","title":"Workers Spec: extract legacy ack TTL + escalation + metrics/cleanup worker semantics","description":"Extract exact legacy Python HTTP background worker behavior into a self-contained spec.\n\nLegacy sources:\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/http.py`:\n  - _startup task creation conditions\n  - _worker_ack_ttl (query + logging + escalation)\n  - _worker_tool_metrics (snapshot + log)\n  - _worker_cleanup (expire stale reservations)\n  - _worker_retention_quota (best-effort reporting)\n- Config defaults in `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/config.py`\n- Tests:\n  - `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_http_workers_and_options.py` (ACK TTL)\n\nMust capture verbatim:\n- Worker enable flags + defaults:\n  - FILE_RESERVATIONS_CLEANUP_ENABLED / INTERVAL\n  - ACK_TTL_ENABLED / ACK_TTL_SECONDS / ACK_TTL_SCAN_INTERVAL_SECONDS\n  - ACK_ESCALATION_* (enabled/mode/claim_ttl/exclusive/holder_name)\n  - TOOL_METRICS_EMIT_ENABLED / INTERVAL\n  - RETENTION_REPORT_ENABLED / INTERVAL + RETENTION_MAX_AGE_DAYS + ignore patterns\n  - QUOTA_ENABLED + quota thresholds (even if best-effort)\n- ACK TTL worker semantics:\n  - SQL query that selects overdue ack-required messages\n  - timezone normalization behavior for SQLite timestamps\n  - rich panel vs plain fallback logging\n  - escalation mode `file_reservation`:\n    - path_pattern format (inbox path for created_ts YYYY/MM)\n    - holder agent resolution/auto-create behavior\n    - DB insert shape + archive artifact write shape\n- Tool metrics emit:\n  - snapshot shape and sorting rules\n- Cleanup worker:\n  - how stale file reservations are found and expired\n\nDeliverables:\n- Add a “HTTP Background Workers” section to `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md`.\n\n## Acceptance Criteria\n- Spec is complete enough to implement without re-reading Python.\n- Spec includes the exact SQL statements and path_pattern format.\n- Spec includes failure handling expectations (never crash server).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:32:42.715316596Z","created_by":"ubuntu","updated_at":"2026-02-05T07:58:32.321908509Z","closed_at":"2026-02-05T07:58:32.321887118Z","close_reason":"Added HTTP Background Workers spec (ack TTL, escalation, metrics emit, cleanup, retention/quota) to EXISTING_MCP_AGENT_MAIL_STRUCTURE.md","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.10.1","depends_on_id":"br-1bm.10","type":"parent-child","created_at":"2026-02-05T07:32:42.715316596Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.10.2","title":"Workers Impl: ACK TTL scan + escalation (log + file_reservation)","description":"Implement ACK TTL background worker to match legacy Python.\n\nWork:\n- Config (core): add parsing for:\n  - ACK_TTL_ENABLED / ACK_TTL_SECONDS / ACK_TTL_SCAN_INTERVAL_SECONDS\n  - ACK_ESCALATION_ENABLED / ACK_ESCALATION_MODE\n  - ACK_ESCALATION_CLAIM_TTL_SECONDS / ACK_ESCALATION_CLAIM_EXCLUSIVE / ACK_ESCALATION_CLAIM_HOLDER_NAME\n- Worker scheduling:\n  - start worker at HTTP server startup when ACK_TTL_ENABLED\n  - tokio-free: asupersync timers or dedicated thread loop\n  - worker must never crash server; suppress exceptions like legacy\n- Scan logic:\n  - run the exact SQL query from spec `br-1bm.10.1`\n  - compute age against now in UTC with the same timezone normalization semantics\n  - log overdue warnings in rich panel when enabled, else plain line; also emit structured log event\n- Escalation:\n  - when enabled and mode=file_reservation:\n    - compute inbox path_pattern based on message created_ts (YYYY/MM)\n    - resolve holder agent name/id; optionally auto-create ops holder and write profile.json to archive\n    - insert file_reservation row in DB with correct timestamps/expires\n    - write archive JSON artifact via existing reservation writer\n\n## Acceptance Criteria\n1. Legacy parity proven by unit/integration tests from `br-1bm.10.6`.\n2. In file_reservation escalation mode, a reservation artifact is created for overdue ack messages.\n3. Worker is best-effort and does not crash the server on DB/archive errors.\n4. No tokio runtime introduced.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T07:32:55.972684006Z","created_by":"ubuntu","updated_at":"2026-02-05T07:33:43.795582397Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.10.2","depends_on_id":"br-1bm.10","type":"parent-child","created_at":"2026-02-05T07:32:55.972684006Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.10.2","depends_on_id":"br-1bm.10.1","type":"blocks","created_at":"2026-02-05T07:33:43.795538585Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.10.3","title":"Workers Impl: tool metrics emit loop (tool_metrics_snapshot logging)","description":"Implement the legacy tool-metrics background emitter.\n\nLegacy behavior:\n- When TOOL_METRICS_EMIT_ENABLED, periodically logs a `tool_metrics_snapshot` event with aggregated per-tool {calls, errors}.\n- Interval controlled by TOOL_METRICS_EMIT_INTERVAL_SECONDS (min sleep clamp).\n- Best-effort: never crashes server.\n\nWork:\n- Config parsing for TOOL_METRICS_EMIT_ENABLED / TOOL_METRICS_EMIT_INTERVAL_SECONDS.\n- Implement a tokio-free periodic loop at HTTP server startup.\n- Ensure metrics snapshot matches legacy shape + stable ordering.\n\n## Acceptance Criteria\n- Snapshot log event name and shape match spec `br-1bm.10.1`.\n- Worker obeys interval and never panics.\n- Unit test covers snapshot determinism and enabled/disabled behavior.\n- Integration test runs worker tick with synthetic metrics and asserts logged snapshot contents.\n- E2E HTTP suite captures `tool_metrics_snapshot` logs and stores artifacts under `tests/artifacts/http/<timestamp>/`.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T07:33:03.809583907Z","created_by":"ubuntu","updated_at":"2026-02-05T08:50:54.322071916Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.10.3","depends_on_id":"br-1bm.10","type":"parent-child","created_at":"2026-02-05T07:33:03.809583907Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.10.3","depends_on_id":"br-1bm.10.1","type":"blocks","created_at":"2026-02-05T07:33:43.981645329Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.10.4","title":"Workers Impl: file reservations cleanup (expire stale)","description":"Implement the legacy file reservations cleanup worker.\n\nLegacy behavior:\n- When FILE_RESERVATIONS_CLEANUP_ENABLED, periodically scans projects and expires stale file reservations.\n- Uses DB queries to find distinct project_ids and applies stale-expire logic per project.\n- Logs a short summary (projects_scanned, stale_released) and never crashes server.\n\nWork:\n- Wire existing stale-expire helpers into a scheduled HTTP-startup worker.\n- Ensure tokio-free scheduling.\n\n## Acceptance Criteria\n- Worker runs when enabled, is a no-op when disabled.\n- Worker does not panic on DB errors and continues.\n- Summary log event exists (structured and human-readable).\n- Unit tests cover: enabled/disabled behavior, stale expiration path, and DB error suppression (assert log output).\n- Integration test (HTTP startup) proves the worker triggers and writes expected log entries without crashing.\n- E2E smoke in `scripts/e2e_test.sh` (workers path) captures logs and writes artifacts for the cleanup run.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T07:33:10.639336897Z","created_by":"ubuntu","updated_at":"2026-02-05T08:49:07.816371510Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.10.4","depends_on_id":"br-1bm.10","type":"parent-child","created_at":"2026-02-05T07:33:10.639336897Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.10.4","depends_on_id":"br-1bm.10.1","type":"blocks","created_at":"2026-02-05T07:33:44.068109290Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.10.5","title":"Workers Impl: retention/quota report loop (best-effort)","description":"Port the legacy retention/quota background reporter.\n\nLegacy behavior (Python):\n- When RETENTION_REPORT_ENABLED or QUOTA_ENABLED, periodically scans storage_root and reports:\n  - old message counts (mtime older than cutoff)\n  - per-project inbox counts\n  - attachment bytes usage\n- Applies ignore patterns for project dirs.\n- Best-effort: suppresses errors, never crashes server.\n\nWork:\n- Config parsing for:\n  - RETENTION_REPORT_ENABLED / RETENTION_REPORT_INTERVAL_SECONDS / RETENTION_MAX_AGE_DAYS / RETENTION_IGNORE_PROJECT_PATTERNS\n  - QUOTA_ENABLED / QUOTA_ATTACHMENTS_LIMIT_BYTES / QUOTA_INBOX_LIMIT_COUNT\n- Implement tokio-free periodic scan at HTTP startup.\n- Emit a structured log event with counts (no user-facing API changes).\n\n## Acceptance Criteria\n- Worker runs only when enabled; does nothing otherwise.\n- Worker emits structured logs with per-project summary.\n- Worker never crashes server on missing dirs/permissions.\n- Unit tests cover ignore-pattern filtering, quota thresholds, and best-effort error suppression (assert log output).\n- Integration test runs with a temp storage_root and verifies log summaries + no crash on unreadable dirs.\n- E2E smoke in `scripts/e2e_test.sh` captures retention/quota logs and stores artifacts for debugging.","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-05T07:33:18.880305805Z","created_by":"ubuntu","updated_at":"2026-02-05T08:49:13.287166398Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.10.5","depends_on_id":"br-1bm.10","type":"parent-child","created_at":"2026-02-05T07:33:18.880305805Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.10.5","depends_on_id":"br-1bm.10.1","type":"blocks","created_at":"2026-02-05T07:33:44.158130884Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.10.6","title":"Workers Tests: ACK TTL + metrics emit + cleanup + retention","description":"Add comprehensive tests for HTTP background workers parity (ACK TTL + escalation, tool metrics emit, cleanup, retention/quota), with deterministic logs and E2E smoke coverage.\n\nWork:\n- Unit tests:\n  - factor each worker scan into a single-tick function (no sleeps)\n  - ACK TTL: overdue selection + age calc (timezone normalization)\n  - ACK escalation: path_pattern formatting (YYYY/MM inbox path), optional holder auto-create\n  - Tool metrics emit: snapshot payload shape + interval gating\n  - Cleanup: stale reservation expiry logic + inactivity grace\n  - Retention/quota: non-destructive reporting thresholds (attachments/inbox)\n- Integration tests:\n  - mirror legacy `test_http_workers_and_options.py`:\n    - ACK_TTL_ENABLED=true, ACK_TTL_SECONDS=0, scan interval short\n    - create ack_required message\n    - ensure worker tick runs (without flaky sleeps)\n    - assert expected log event exists\n  - file_reservation escalation mode:\n    - enable ACK_ESCALATION_MODE=file_reservation\n    - assert reservation row/artifact exists\n  - tool metrics emit:\n    - enable TOOL_METRICS_EMIT_ENABLED\n    - assert `tool_metrics_snapshot` log emitted\n  - cleanup:\n    - create stale reservation and assert cleanup removes/marks released\n- E2E:\n  - extend scripts/e2e_http.sh (`br-2ei.9.6`):\n    - ACK TTL smoke (ttl=0) + `ack_overdue` log\n    - tool metrics emit smoke (`tool_metrics_snapshot` in logs)\n    - cleanup smoke (stale reservation resolved)\n\n## Acceptance Criteria\n- Unit/integration tests cover ACK TTL, escalation, tool metrics emit, cleanup, retention/quota.\n- E2E HTTP suite includes worker smokes with high-signal artifacts.\n- Tests are deterministic (no flaky sleeps; worker ticks controllable).","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T07:33:32.489216204Z","created_by":"ubuntu","updated_at":"2026-02-05T14:06:38.232911937Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.10.6","depends_on_id":"br-1bm.10","type":"parent-child","created_at":"2026-02-05T07:33:32.489216204Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.10.6","depends_on_id":"br-1bm.10.2","type":"blocks","created_at":"2026-02-05T07:33:44.244450112Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.10.6","depends_on_id":"br-1bm.10.3","type":"blocks","created_at":"2026-02-05T14:06:38.045327096Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.10.6","depends_on_id":"br-1bm.10.4","type":"blocks","created_at":"2026-02-05T14:06:38.145684595Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.10.6","depends_on_id":"br-1bm.10.5","type":"blocks","created_at":"2026-02-05T14:06:38.232870379Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.2","title":"Redis Rate Limiting Parity (token bucket)","description":"Objective:\nImplement Redis-backed token-bucket rate limiting exactly as legacy Python when HTTP_RATE_LIMIT_BACKEND=redis and HTTP_RATE_LIMIT_ENABLED=true. Must match key format, Lua script semantics, TTL, and fallback behavior.\n\nLegacy Reference Behavior:\n- Enabled when settings.http.rate_limit_enabled.\n- Key format: \"rl:{kind}:{endpoint}:{identity}\".\n- Identity uses request.client.host unless JWT claims sub present (then use \"sub:{sub}\").\n- Lua token bucket (HMGET/HMSET, EXPIRE with ceil(burst/max(rate,0.001))).\n- Burst defaults to max(1, rpm) when configured burst is 0.\n- On Redis failure, fallback to in-memory bucket.\n- HTTP response payloads identical (429 + {\"detail\":\"Rate limit exceeded\"}).\n\nImplementation Considerations:\n- Use asupersync Redis client (no tokio, no external redis crate).\n- Ensure monotonic time source for token math.\n- Memory buckets cleanup identical to Python (evict after 1h idle).\n\nTests and E2E (with detailed logging):\n- Vector/spec extraction: `br-1bm.2.1`\n- Implementation: `br-1bm.2.2`..`br-1bm.2.4`\n- Tests: `br-1bm.2.5` (uses shared harness `br-2ei.9.1`)\n\n## Acceptance Criteria\n- Redis backend decisions match Python for identical sequences (vectors from `br-1bm.2.1`).\n- Fallback-to-memory path is correct and observable via logs (without changing HTTP outputs).\n- `br-1bm.2.5` unit+integration+E2E suite passes with high-signal artifacts on failure.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:32:59.767161877Z","created_by":"ubuntu","updated_at":"2026-02-05T06:39:21.410846691Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.2","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2","depends_on_id":"br-1bm.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2","depends_on_id":"br-1bm.3","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.2.1","title":"Rate Limit Parity: extract legacy Lua + vectors","description":"Purpose:\nExtract exact legacy Redis token-bucket behavior and test vectors for parity.\n\nLegacy Lua Script (verbatim):\nlocal key = KEYS[1]\nlocal now = tonumber(ARGV[1])\nlocal rate = tonumber(ARGV[2])\nlocal burst = tonumber(ARGV[3])\nlocal state = redis.call('HMGET', key, 'tokens', 'ts')\nlocal tokens = tonumber(state[1]) or burst\nlocal ts = tonumber(state[2]) or now\nlocal delta = now - ts\ntokens = math.min(burst, tokens + delta * rate)\nlocal allowed = 0\nif tokens >= 1 then\n  tokens = tokens - 1\n  allowed = 1\nend\nredis.call('HMSET', key, 'tokens', tokens, 'ts', now)\nredis.call('EXPIRE', key, math.ceil(burst / math.max(rate, 0.001)))\nreturn allowed\n\nCall pattern:\n- EVAL lua 1 \"rl:{key}\" now rate_per_sec burst\n- allowed = bool(int(result or 0) == 1)\n\nIn-memory fallback:\n- tokens, ts = buckets.get(key, (burst, now))\n- elapsed = max(0, now - ts)\n- tokens = min(burst, tokens + elapsed * rate)\n- if tokens < 1 -> deny, else tokens -= 1 -> allow\n- cleanup buckets idle > 3600s\n\nTest Vectors (examples to codify):\n1) per_minute<=0 -> allow always (no Redis call)\n2) burst default = max(1, rpm) when configured burst == 0\n3) First request at t0 with tokens missing -> tokens=burst -> allow, new tokens=burst-1\n4) Subsequent request before 1/rate sec -> deny if tokens <1\n5) After sufficient elapsed, tokens replenished to min(burst, tokens + elapsed*rate)\n6) Redis failure (exception) -> fallback to memory bucket and still enforce limits\n7) TTL calculation: EXPIRE = ceil(burst / max(rate, 0.001))\n\nDeliverable:\n- Matrix of (rpm, burst, time sequence, expected allow/deny, expected TTL)\n- Explicit Redis key format: \"rl:{kind}:{endpoint}:{identity}\"","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:38:01.226828600Z","created_by":"ubuntu","updated_at":"2026-02-05T07:38:06.586289822Z","closed_at":"2026-02-05T07:38:06.586222836Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.2.1","depends_on_id":"br-1bm.2","type":"parent-child","created_at":"2026-02-05T05:38:01.226828600Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.2.2","title":"Rate Limit Parity: Redis Lua implementation","description":"Implement the Redis-backed token bucket using `asupersync` Redis client, matching legacy Lua exactly.\n\nRequirements:\n- Use the verbatim Lua + semantics extracted in `br-1bm.2.1`.\n- Match:\n  - HMGET/HMSET field names\n  - token + timestamp math\n  - EXPIRE/TTL updates\n  - key prefix `rl:` and any namespacing rules\n- On Redis errors, log diagnostics and fall back cleanly (per legacy) without changing HTTP output.\n\n## Acceptance Criteria\n- Redis path parity:\n  - Unit tests (using vectors from `br-1bm.2.1`) pass against a Redis test instance.\n  - Allow/deny outcomes and TTLs match expected values.\n- Failure behavior:\n  - Redis connection failure triggers fallback without changing HTTP responses.\n  - Errors are logged at the correct level and are not spammy.\n- Tests:\n  - Integration test runs Redis-backed limiter through an allow→deny burst sequence.\n  - Key format tests assert exact Redis keys used.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:38:06.336149143Z","created_by":"ubuntu","updated_at":"2026-02-05T06:32:21.751948178Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.2.2","depends_on_id":"br-1bm.2","type":"parent-child","created_at":"2026-02-05T05:38:06.336149143Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2.2","depends_on_id":"br-1bm.2.1","type":"blocks","created_at":"2026-02-05T05:38:25.448726996Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.2.3","title":"Rate Limit Parity: identity derivation (host/sub)","description":"Implement rate-limit identity selection logic (host/sub) exactly as legacy.\n\nRule:\n- Prefer JWT `sub` when available.\n- Otherwise use client host derived from peer_addr.\n- Forwarded headers must not override peer_addr.\n\n## Acceptance Criteria\n- Identity precedence and formatting match legacy.\n- Forwarded headers cannot spoof identity.\n- Tests:\n  - Unit tests cover precedence and formatting.\n  - Integration test proves identity value is fed into Redis key creation (matches `br-1bm.2.1` spec).","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:38:11.555148799Z","created_by":"ubuntu","updated_at":"2026-02-05T06:32:27.263971087Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.2.3","depends_on_id":"br-1bm.1","type":"blocks","created_at":"2026-02-05T05:38:28.472191315Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2.3","depends_on_id":"br-1bm.2","type":"parent-child","created_at":"2026-02-05T05:38:11.555148799Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2.3","depends_on_id":"br-1bm.3","type":"blocks","created_at":"2026-02-05T05:38:31.440415087Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.2.4","title":"Rate Limit Parity: memory fallback + cleanup","description":"Implement in-memory token bucket fallback identical to legacy.\n\nRequirements:\n- Trigger fallback on Redis errors (and only those errors) without changing HTTP output semantics.\n- Use monotonic time for rate math (per legacy).\n- Implement burst/rate math exactly like legacy.\n- Cleanup:\n  - remove buckets idle > 1h (or exact threshold per spec)\n  - ensure cleanup is efficient and does not grow unbounded\n\n## Acceptance Criteria\n- Fallback decisions match the vectors extracted in `br-1bm.2.1`.\n- Cleanup behavior is tested (idle buckets removed, active buckets preserved).\n- Redis failure path is transparent to clients (only logs differ).\n- Tests:\n  - unit tests cover token math determinism\n  - integration test simulates Redis down and asserts fallback engages","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:38:15.478842333Z","created_by":"ubuntu","updated_at":"2026-02-05T06:32:34.447302563Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.2.4","depends_on_id":"br-1bm.2","type":"parent-child","created_at":"2026-02-05T05:38:15.478842333Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2.4","depends_on_id":"br-1bm.2.1","type":"blocks","created_at":"2026-02-05T05:38:36.248864408Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.2.5","title":"Rate Limit Parity: unit + integration + E2E tests","description":"Comprehensive tests for rate limiting parity, with detailed logging + artifacts.\n\nTest layers:\n- Unit tests:\n  - key format\n  - burst/rate defaults\n  - deterministic token math\n  - TTL calculation\n  - in-memory cleanup\n- Integration tests:\n  - Redis-backed allow/deny sequences using vectors from `br-1bm.2.1`\n  - fallback path when Redis is unavailable\n- E2E script:\n  - run request bursts against HTTP server\n  - log expected vs actual allow/deny decisions\n  - capture Redis state snapshots (best effort)\n  - store artifacts under `tests/artifacts/rate_limit/<timestamp>/`\n\n## Acceptance Criteria\n- Unit tests validate both Redis and fallback implementations against the same vector suite.\n- Integration tests are deterministic (fixed timestamps/time mocking as needed).\n- E2E script:\n  - prints per-request decision trace\n  - writes a summary JSON (pass/fail + diffs)\n  - exits non-zero on mismatch\n- Failures include enough context to debug (identity, key, tokens, ttl).","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:38:19.738397651Z","created_by":"ubuntu","updated_at":"2026-02-05T06:32:42.016519079Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.2.5","depends_on_id":"br-1bm.2","type":"parent-child","created_at":"2026-02-05T05:38:19.738397651Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2.5","depends_on_id":"br-1bm.2.2","type":"blocks","created_at":"2026-02-05T05:38:39.208248679Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2.5","depends_on_id":"br-1bm.2.3","type":"blocks","created_at":"2026-02-05T05:38:44.191099431Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2.5","depends_on_id":"br-1bm.2.4","type":"blocks","created_at":"2026-02-05T05:38:47.255125276Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2.5","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:55.976511422Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.3","title":"Client Peer Address + Localhost Bypass Parity","description":"Objective:\nAccurately detect client host/peer address for localhost bypass, RBAC, and rate limiting identity. Must match legacy Python logic, including IPv4-mapped IPv6 handling and forwarded-header safeguards.\n\nLegacy Reference Behavior:\n- Determine client_host from request.client.host\n- If forwarded headers present (x-forwarded-for/proto/host or forwarded), treat as non-local\n- Localhost if client_host in {\"127.0.0.1\",\"::1\",\"localhost\"} or IPv4-mapped ::ffff:127.0.0.1\n- When localhost allowed and bearer token set, auto-inject Authorization in base path passthrough\n\nImplementation Plan:\n1. Integrate peer_addr from asupersync Http1Request (blocked on upstream `br-2ei.6.3`).\n2. Add helper to normalize peer_addr to client_host string (supports IPv4-mapped IPv6).\n3. Update allow_local_unauthenticated checks to use peer_addr + forwarded headers.\n4. Use client_host for rate-limit identity when JWT sub absent.\n\nTests and E2E (with detailed logging):\n- Unit tests for address parsing + forwarded header behavior.\n- Integration tests with simulated Http1Request peer_addr.\n- E2E coverage via `br-1bm.3.4` (uses shared harness `br-2ei.9.1`).\n\n## Acceptance Criteria\n- Localhost bypass behavior matches legacy Python for all address forms and forwarded-header cases.\n- Rate-limit identity uses peer_addr-derived host when JWT sub is missing.\n- `br-1bm.3.4` unit+integration+E2E suite passes and produces high-signal artifacts on failure.","status":"in_progress","priority":1,"issue_type":"task","assignee":"ubuntu","created_at":"2026-02-05T05:33:10.708760957Z","created_by":"ubuntu","updated_at":"2026-02-05T08:38:52.923665836Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.3","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}],"comments":[{"id":2,"issue_id":"br-1bm.3","author":"Dicklesworthstone","text":"Integrated peer_addr (asupersync), localhost helper + rate-limit identity, and added unit/integration tests. E2E still pending in br-1bm.3.4 (blocked by br-2ei.9.1).","created_at":"2026-02-05T08:38:52Z"}]}
{"id":"br-1bm.3.1","title":"Peer Addr Parity: integrate asupersync Http1Request.peer_addr","description":"Integrate `peer_addr` from `asupersync::Http1Request` into server logic.\n\nThis task is blocked on upstream asupersync work tracked as `br-2ei.6.3`.\n\nWork:\n- Once `Http1Request.peer_addr` is available, plumb it through the HTTP server request handling.\n- Expose a helper to derive a stable `client_host` string from peer_addr (legacy-equivalent formatting).\n- Ensure forwarded headers do not override peer_addr.\n\n## Acceptance Criteria\n- Server has access to peer_addr for each request and uses it consistently for:\n  - localhost bypass decisions\n  - rate-limit identity (when JWT sub absent)\n- `client_host` formatting matches legacy for:\n  - IPv4\n  - IPv6\n  - IPv4-mapped IPv6\n- Tests:\n  - Unit tests validate formatting and “forwarded headers do not override peer_addr”.\n  - Integration tests validate peer_addr is populated in the request path (using simulated Http1Request / test harness).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:39:05.220643258Z","created_by":"ubuntu","updated_at":"2026-02-05T08:38:05.917468187Z","closed_at":"2026-02-05T08:38:05.917450805Z","close_reason":"Integrated peer_addr from asupersync and wired into server logic","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.3.1","depends_on_id":"br-1bm.3","type":"parent-child","created_at":"2026-02-05T05:39:05.220643258Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.3.1","depends_on_id":"br-2ei.6.3","type":"blocks","created_at":"2026-02-05T06:08:07.059047396Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.3.2","title":"Peer Addr Parity: localhost detection helper","description":"Implement localhost detection helper for peer_addr-based bypass logic.\n\nRequirements:\n- Handle IPv4, IPv6, and IPv4-mapped IPv6 localhost forms.\n- Treat forwarded headers as disqualifying for localhost bypass (no spoofing).\n- Use this helper consistently in bearer auth, RBAC decisions, and any other localhost-only paths.\n\n## Acceptance Criteria\n- Correct detection:\n  - `127.0.0.1`, `::1`, and IPv4-mapped `::ffff:127.0.0.1` are treated as localhost.\n  - Non-localhost private IPs are *not* treated as localhost.\n- Forwarded headers:\n  - Presence of `X-Forwarded-For`/`Forwarded` (per legacy) disables localhost bypass.\n- Tests:\n  - Unit tests cover all address forms and forwarded-header cases.\n  - Integration test verifies bypass behavior is controlled exclusively by peer_addr + forwarded headers (not client-provided host headers).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:39:09.028452900Z","created_by":"ubuntu","updated_at":"2026-02-05T08:38:09.584845027Z","closed_at":"2026-02-05T08:38:09.584827845Z","close_reason":"Added peer_addr localhost helper + forwarded header safeguards + tests","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.3.2","depends_on_id":"br-1bm.3","type":"parent-child","created_at":"2026-02-05T05:39:09.028452900Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.3.2","depends_on_id":"br-1bm.3.1","type":"blocks","created_at":"2026-02-05T05:39:26.736664544Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.3.3","title":"Peer Addr Parity: rate-limit identity plumbing","description":"Implement rate-limit identity plumbing for peer_addr-derived host.\n\nRule:\n- Use JWT `sub` as the default rate-limit identity when present.\n- Otherwise, use `client_host` derived from peer_addr.\n- Identity string must match legacy formatting and be used consistently for rate limiter key creation.\n\n## Acceptance Criteria\n- Identity derivation matches legacy precedence and formatting.\n- Forwarded headers do not affect identity (peer_addr only).\n- Tests:\n  - Unit tests cover precedence (JWT sub vs peer_addr) and formatting.\n  - Integration test asserts Redis key prefix + identity combine exactly as legacy expects.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:39:12.867654737Z","created_by":"ubuntu","updated_at":"2026-02-05T08:38:13.146794229Z","closed_at":"2026-02-05T08:38:13.146772948Z","close_reason":"Rate-limit identity now uses peer_addr; helper covers JWT sub precedence","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.3.3","depends_on_id":"br-1bm.3","type":"parent-child","created_at":"2026-02-05T05:39:12.867654737Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.3.3","depends_on_id":"br-1bm.3.1","type":"blocks","created_at":"2026-02-05T05:39:30.103821388Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.3.4","title":"Peer Addr Parity: unit + integration + E2E tests","description":"Add comprehensive tests for peer_addr + localhost bypass logic, with detailed logging + artifacts.\n\nTest layers:\n- Unit tests:\n  - host parsing/formatting\n  - localhost detection (IPv4/IPv6/mapped)\n  - forwarded-header disqualification\n- Integration tests:\n  - simulate Http1Request peer_addr values through server request path\n  - validate identity derivation used by rate limiter\n- E2E script:\n  - start server\n  - send requests with/without Authorization\n  - include forwarded header cases\n  - log expected vs actual outcomes and store artifacts under `tests/artifacts/peer_addr/<timestamp>/`\n\n## Acceptance Criteria\n- Unit tests cover all address forms + forwarded-header cases.\n- Integration tests prove peer_addr is used and forwarded headers cannot spoof it.\n- E2E script writes:\n  - HTTP transcripts\n  - server logs\n  - summary JSON (pass/fail + diffs)\n- Failures provide actionable diffs (which header/value differed).","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:39:17.375993949Z","created_by":"ubuntu","updated_at":"2026-02-05T08:38:33.776431104Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.3.4","depends_on_id":"br-1bm.3","type":"parent-child","created_at":"2026-02-05T05:39:17.375993949Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.3.4","depends_on_id":"br-1bm.3.2","type":"blocks","created_at":"2026-02-05T05:39:34.102447983Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.3.4","depends_on_id":"br-1bm.3.3","type":"blocks","created_at":"2026-02-05T05:39:37.109851077Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.3.4","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:56.060674456Z","created_by":"ubuntu","metadata":"{}","thread_id":""}],"comments":[{"id":1,"issue_id":"br-1bm.3.4","author":"Dicklesworthstone","text":"Added unit/integration tests in mcp-agent-mail-server (peer_addr localhost + forwarded header + rate-limit identity). E2E script still blocked on br-2ei.9.1 harness.","created_at":"2026-02-05T08:38:33Z"}]}
{"id":"br-1bm.4","title":"Stateless Streamable HTTP MCP Parity","description":"Objective:\nReproduce legacy Python stateless Streamable HTTP behavior for MCP requests, including header normalization, base path mount semantics, passthrough route, and localhost Authorization injection. Must be wire-compatible for existing MCP clients.\n\nLegacy Reference Behavior:\n- Per-request StreamableHTTPServerTransport, stateless=True\n- Accept header forced to \"application/json, text/event-stream\"\n- Content-Type added for POST if missing\n- Base path mounted at both /base and /base/ (no redirect)\n- Direct POST handler at base path that forwards to mounted app\n- If localhost + allow_localhost_unauthenticated + bearer token set, inject Authorization if missing\n- Responses passed through without extra wrapping\n\nImplementation Considerations:\n- Use fastmcp_rust transport primitives (no tokio)\n- Preserve request/response JSON-RPC payloads exactly\n- Avoid breaking SSE/streaming semantics\n\nTests and E2E (with detailed logging):\n- Spec + fixtures: `br-1bm.4.1`\n- Implementation: `br-1bm.4.2`..`br-1bm.4.5`\n- Tests: `br-1bm.4.6` (uses shared harness `br-2ei.9.1`)\n\nDependencies:\n- peer address parity (`br-1bm.3`) for localhost detection.\n\n## Acceptance Criteria\n- Wire behavior matches legacy Python for all fixture cases from `br-1bm.4.1`.\n- Streaming responses remain incremental (not buffered) and have correct headers.\n- `br-1bm.4.6` unit+integration+E2E suite passes with high-signal artifacts on failure.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:33:19.242331091Z","created_by":"ubuntu","updated_at":"2026-02-05T06:39:44.206098931Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.4","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4","depends_on_id":"br-1bm.3","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.4.1","title":"Streamable HTTP Parity: extract legacy behaviors + fixtures","description":"Purpose:\nExtract exact legacy HTTP streamable behaviors and define fixture cases for parity.\n\nLegacy Behavior (from http.py):\n- Mount base:\n  - mount_base = settings.http.path or \"/api\"\n  - if not startswith(\"/\"): prefix \"/\"\n  - base_no_slash = mount_base.rstrip(\"/\") or \"/\"\n  - base_with_slash = base_no_slash if \"/\" else base_no_slash + \"/\"\n  - fastapi_app.mount(base_no_slash, stateless_app)\n  - fastapi_app.mount(base_with_slash, stateless_app)\n- Direct POST handler at base_no_slash:\n  - Forwards to stateless_app with path=base_with_slash\n  - Collects response status/headers/body by intercepting send()\n  - Parses body as JSON (empty => {})\n- Header normalization:\n  - Remove any existing Accept headers\n  - Add Accept: \"application/json, text/event-stream\"\n  - If POST and Content-Type missing, add Content-Type: \"application/json\"\n- Localhost Authorization injection in passthrough:\n  - If allow_localhost_unauthenticated and client_host in {127.0.0.1, ::1, localhost} and no Authorization header, inject Bearer token when configured\n\nFixture Cases (minimum):\n1) Request to /api and /api/ both route to stateless app (no redirect)\n2) POST /api with missing Accept -> Accept forced to \"application/json, text/event-stream\"\n3) POST /api with existing Accept -> replaced (single header) with forced value\n4) POST /api missing Content-Type -> set to application/json\n5) POST /api with Content-Type present -> preserved\n6) Direct POST handler returns exact status/body from stateless app\n7) Localhost injection adds Authorization when missing (only if allow_localhost_unauthenticated + bearer token)\n8) Forwarded headers present -> no localhost injection\n\nDeliverable:\n- Written fixture table (inputs -> expected headers + status + body)\n- Use as baseline for br-1bm.4.* implementation/tests","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:39:51.705065959Z","created_by":"ubuntu","updated_at":"2026-02-05T07:38:24.514040016Z","closed_at":"2026-02-05T07:38:24.513965806Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.4.1","depends_on_id":"br-1bm.4","type":"parent-child","created_at":"2026-02-05T05:39:51.705065959Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.4.2","title":"Streamable HTTP Parity: header normalization","description":"Implement `Accept` and `Content-Type` normalization to match legacy.\n\nRules (per `br-1bm.4.1` spec):\n- Force/ensure `Accept` includes `application/json` and `text/event-stream` in the legacy-equivalent way.\n- Add `Content-Type` for POST when missing (legacy default).\n- Avoid duplicating headers when already present.\n- Must not alter unrelated headers.\n\n## Acceptance Criteria\n- Parity:\n  - Unit tests driven by `br-1bm.4.1` fixtures pass (exact header outcomes).\n  - Existing `Accept` values are preserved except for required normalization behavior.\n- Safety:\n  - No header injection beyond the explicit normalization targets.\n- Tests:\n  - Unit tests cover: missing headers, already-present headers, multiple Accept values, and case-insensitive matching.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:39:57.051364879Z","created_by":"ubuntu","updated_at":"2026-02-05T06:31:06.400648222Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.4.2","depends_on_id":"br-1bm.4","type":"parent-child","created_at":"2026-02-05T05:39:57.051364879Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.2","depends_on_id":"br-1bm.4.1","type":"blocks","created_at":"2026-02-05T05:40:24.386470843Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.4.3","title":"Streamable HTTP Parity: base path mount + passthrough","description":"Implement base path handling to match legacy.\n\nRequirements (per `br-1bm.4.1` spec):\n- Support mount at both `/base` and `/base/`.\n- Provide a direct POST handler at `/base` (no redirect) that forwards into the mounted app.\n- Normalize paths exactly like legacy (base_no_slash + base_with_slash semantics).\n\n## Acceptance Criteria\n- Requests to `/base` and `/base/` behave exactly as legacy (status codes, redirects/no-redirects).\n- POST to `/base` is handled without redirect and reaches the underlying MCP handler.\n- Unit + integration tests cover:\n  - GET/POST behavior for `/base` vs `/base/`\n  - path joining edge cases (`//`, trailing slashes)","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:40:00.975157750Z","created_by":"ubuntu","updated_at":"2026-02-05T06:31:12.691088727Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.4.3","depends_on_id":"br-1bm.4","type":"parent-child","created_at":"2026-02-05T05:40:00.975157750Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.3","depends_on_id":"br-1bm.4.1","type":"blocks","created_at":"2026-02-05T05:40:27.257455205Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.4.4","title":"Streamable HTTP Parity: localhost auth injection","description":"Implement localhost unauthenticated bypass behavior (Authorization injection) exactly as legacy.\n\nRule (per `br-1bm.4.1` spec):\n- If `allow_localhost_unauthenticated` is enabled AND\n  - peer_addr is localhost AND\n  - `Authorization` header is missing AND\n  - a bearer token is configured\n  then inject `Authorization: Bearer <token>` for the base-path passthrough request.\n- Must *not* bypass when forwarded headers are present (no spoofing).\n\n## Acceptance Criteria\n- Positive case:\n  - localhost peer_addr + missing Authorization results in injected header for passthrough routes.\n- Negative cases:\n  - non-localhost peer_addr does not inject\n  - forwarded headers present does not inject\n  - bearer token not configured does not inject\n  - Authorization already present does not overwrite\n- Tests:\n  - Unit tests cover all cases above.\n  - Integration/E2E tests validate behavior via real HTTP requests.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:40:05.682494755Z","created_by":"ubuntu","updated_at":"2026-02-05T06:31:19.612235344Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.4.4","depends_on_id":"br-1bm.3","type":"blocks","created_at":"2026-02-05T05:40:38.923281128Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.4","depends_on_id":"br-1bm.4","type":"parent-child","created_at":"2026-02-05T05:40:05.682494755Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.4","depends_on_id":"br-1bm.4.1","type":"blocks","created_at":"2026-02-05T05:40:35.525843824Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.4.5","title":"Streamable HTTP Parity: stateless transport pass-through","description":"Implement per-request stateless “streamable HTTP” transport.\n\nRequirements (per `br-1bm.4.1` spec):\n- For each incoming HTTP request, run the MCP server handler and pass JSON-RPC responses through without wrapping.\n- Preserve status codes and headers required for JSON and for streaming/SSE.\n- Ensure streaming behavior remains intact (no buffering that changes chunking semantics).\n- Must not leak per-request state across requests.\n\n## Acceptance Criteria\n- JSON parity:\n  - Requests return the same JSON body as legacy for representative tool calls.\n- Streaming/SSE parity:\n  - Streaming responses are delivered incrementally (not buffered) and have the correct content-type.\n  - Basic “chunked response sanity” test passes (client receives multiple chunks for a streaming endpoint).\n- Statelessness:\n  - Two sequential requests with different auth/headers do not interfere with each other.\n- Tests:\n  - Unit tests cover handler-level pass-through semantics.\n  - Integration tests cover end-to-end HTTP requests for both JSON and streaming paths.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:40:10.252618982Z","created_by":"ubuntu","updated_at":"2026-02-05T06:31:28.347492683Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.4.5","depends_on_id":"br-1bm.4","type":"parent-child","created_at":"2026-02-05T05:40:10.252618982Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.5","depends_on_id":"br-1bm.4.1","type":"blocks","created_at":"2026-02-05T05:40:32.362475538Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.4.6","title":"Streamable HTTP Parity: unit + integration + E2E tests","description":"Comprehensive tests for streamable HTTP parity, with detailed logging + artifacts.\n\nTest layers:\n- Unit tests:\n  - header normalization\n  - base path normalization\n  - Authorization injection logic\n- Integration tests:\n  - `/api` and `/api/` parity\n  - passthrough correctness (status/headers/body)\n- E2E script:\n  - cover missing headers\n  - cover localhost auth injection\n  - cover streaming response sanity\n  - log expected vs actual results and store artifacts under `tests/artifacts/http_streamable/<timestamp>/`\n\n## Acceptance Criteria\n- Tests are driven by fixtures/spec from `br-1bm.4.1` where possible.\n- E2E script captures:\n  - full HTTP transcript (request + response)\n  - server logs\n  - a summary JSON with pass/fail + diffs\n- Streaming test asserts incremental delivery (multiple chunks observed).\n- Tests run reliably on dev machine with clear diagnostics on failure.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:40:16.185638720Z","created_by":"ubuntu","updated_at":"2026-02-05T06:31:34.994170229Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.4.6","depends_on_id":"br-1bm.4","type":"parent-child","created_at":"2026-02-05T05:40:16.185638720Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.6","depends_on_id":"br-1bm.4.2","type":"blocks","created_at":"2026-02-05T05:40:43.603009717Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.6","depends_on_id":"br-1bm.4.3","type":"blocks","created_at":"2026-02-05T05:40:47.563411188Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.6","depends_on_id":"br-1bm.4.4","type":"blocks","created_at":"2026-02-05T05:40:51.243017744Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.6","depends_on_id":"br-1bm.4.5","type":"blocks","created_at":"2026-02-05T05:40:56.025356571Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.6","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:56.145694434Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.5","title":"Mail SSR UI Parity (/mail/*)","description":"Objective:\nImplement the legacy Python SSR Mail UI endpoints under `/mail/*` with identical behavior and output expectations. This includes templates, markdown rendering, sanitization, and static assets. Must be safe and stable for human overseer usage.\n\nLegacy Reference Behavior:\n- `/mail` and `/mail/*` routes render HTML using Jinja templates\n- Markdown rendering via markdown2; sanitization via bleach + optional CSS sanitizer\n- Supports inbox list, thread view, compose, human overseer actions\n- Static assets served from legacy web/ and templates/ directories\n\nImplementation Considerations:\n- Preserve HTML structure and CSS class names to keep UI stable.\n- Sanitization allowlist must match legacy (or be stricter only if it doesn’t break expected markup).\n- Cache headers should match legacy defaults for static assets.\n\nTests and E2E (with detailed logging):\n- Inventory/spec: `br-1bm.5.1`\n- Implementation: `br-1bm.5.2`..`br-1bm.5.4`\n- Tests: `br-1bm.5.5` (uses shared harness `br-2ei.9.1`)\n\n## Acceptance Criteria\n- `/mail` routes and rendered HTML structure match legacy for representative fixtures.\n- Sanitization prevents XSS while preserving expected formatting.\n- Static assets are served with correct content-type + caching headers.\n- `br-1bm.5.5` unit+integration+E2E suite passes with high-signal artifacts on failure.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:33:28.128698742Z","created_by":"ubuntu","updated_at":"2026-02-05T06:39:53.193330679Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.5","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.5.1","title":"Mail UI Parity: inventory routes/templates/assets","description":"Purpose:\nInventory all legacy /mail UI routes, templates, and static assets to define the exact UI surface for the Rust port.\n\nLegacy Route Map (from http.py):\n- GET  /mail/api/locks (JSON)\n- GET  /mail (HTML)\n- GET  /mail/api/unified-inbox (JSON)\n- GET  /mail/projects (HTML)\n- GET  /mail/{project} (HTML)\n- POST /mail/api/projects/{project_id}/siblings/{other_id} (JSON)\n- GET  /mail/unified-inbox (HTML)\n- GET  /mail/{project}/inbox/{agent} (HTML)\n- GET  /mail/{project}/message/{mid} (HTML)\n- POST /mail/{project}/inbox/{agent}/mark-read (form)\n- POST /mail/{project}/inbox/{agent}/mark-all-read (form)\n- GET  /mail/{project}/thread/{thread_id} (HTML)\n- GET  /mail/{project}/search (HTML)\n- GET  /mail/{project}/file_reservations (HTML)\n- GET  /mail/{project}/attachments (HTML)\n- GET  /mail/{project}/overseer/compose (HTML)\n- POST /mail/{project}/overseer/send (form)\n- GET  /mail/archive/guide (HTML)\n- GET  /mail/archive/activity (HTML)\n- GET  /mail/archive/commit/{sha} (HTML)\n- GET  /mail/archive/timeline (HTML)\n- GET  /mail/archive/browser (HTML)\n- GET  /mail/archive/browser/{project}/file (HTML)\n- GET  /mail/archive/network (HTML)\n- GET  /mail/api/projects/{project}/agents (JSON)\n- GET  /mail/archive/time-travel (HTML)\n- GET  /mail/archive/time-travel/snapshot (HTML)\n\nTemplates & Assets:\n- templates root: mcp_agent_mail/templates (Jinja2)\n- sanitizer: bleach + optional CSSSanitizer (allowed tags/attrs list in http.py)\n- static SPA: /web directory (if exists) mounted at \"/\" via StaticFiles\n- CSS/JS asset paths referenced in templates (must be preserved)\n\nAdditional Notes:\n- UI is optional: failure to load templates should not crash server\n- /web SPA fallback uses index.html for non-API 404s\n\nDeliverable:\n- Template list (filenames)\n- Asset manifest (CSS/JS/images) with paths\n- Route-to-template mapping","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:41:11.443448819Z","created_by":"ubuntu","updated_at":"2026-02-05T07:39:20.258580675Z","closed_at":"2026-02-05T07:39:20.258519770Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.5.1","depends_on_id":"br-1bm.5","type":"parent-child","created_at":"2026-02-05T05:41:11.443448819Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.5.2","title":"Mail UI Parity: markdown rendering + sanitization","description":"Implement markdown rendering + HTML sanitization for Mail UI to match legacy behavior.\n\nLegacy reference:\n- Markdown renderer (legacy: markdown2)\n- Sanitizer (legacy: bleach + optional CSS sanitizer)\n\nWork:\n- Define the exact allowlist of tags/attrs/styles and URL protocols.\n- Ensure unsafe HTML/script/style injection is stripped.\n- Preserve expected formatting for common message bodies (lists, code blocks, links, tables if supported).\n\n## Acceptance Criteria\n- Parity:\n  - Allowlist and sanitization behavior matches the legacy spec (from `br-1bm.5.1` inventory and legacy code).\n  - Rendering output is stable and matches golden HTML snapshots for representative fixtures.\n- Security:\n  - Unit tests include explicit XSS payload fixtures and prove they are neutralized.\n- Tests:\n  - Unit tests cover markdown edge cases (unicode, nested lists, code fences, autolinks).\n  - Snapshot tests assert sanitized HTML output for a set of golden inputs.\n- Performance:\n  - Rendering is fast enough for inbox/thread pages (no N² behavior on large bodies).","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:41:15.456034900Z","created_by":"ubuntu","updated_at":"2026-02-05T06:30:27.022164279Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.5.2","depends_on_id":"br-1bm.5","type":"parent-child","created_at":"2026-02-05T05:41:15.456034900Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.5.2","depends_on_id":"br-1bm.5.1","type":"blocks","created_at":"2026-02-05T05:41:34.643924817Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.5.3","title":"Mail UI Parity: template rendering + data binding","description":"Port legacy Mail UI templates and implement data binding.\n\nScope (minimum pages):\n- inbox list\n- thread view\n- compose/new message\n- human overseer actions (ack, etc) where present in legacy\n\nRequirements:\n- Preserve structure/class names to maintain UI parity and keep existing CSS/JS working.\n- Data binding must match legacy keys and conditional rendering.\n\n## Acceptance Criteria\n- Templates:\n  - All templates enumerated in `br-1bm.5.1` are present in Rust with equivalent blocks/partials.\n- Data binding:\n  - Rendering succeeds for representative fixtures (empty inbox, inbox with many messages, long thread).\n  - Missing/invalid inputs produce legacy-equivalent error pages/status.\n- Snapshot tests:\n  - Integration tests render pages and compare against golden snapshots (normalized for timestamps/ids if needed).\n- No “creative improvements”:\n  - Output HTML structure remains compatible with legacy assets.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:41:19.188774583Z","created_by":"ubuntu","updated_at":"2026-02-05T06:30:34.081793879Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.5.3","depends_on_id":"br-1bm.5","type":"parent-child","created_at":"2026-02-05T05:41:19.188774583Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.5.3","depends_on_id":"br-1bm.5.1","type":"blocks","created_at":"2026-02-05T05:41:37.975640120Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.5.4","title":"Mail UI Parity: static assets + caching","description":"Serve static Mail UI assets under `/mail` with legacy-correct paths and caching.\n\nWork:\n- Serve CSS/JS/assets under the exact legacy URLs (paths + filenames).\n- Set correct `Content-Type` headers.\n- Set `Cache-Control`/ETag behavior to match legacy expectations.\n- Ensure assets are bundled with the crate (embedded resources) if required for distribution.\n\n## Acceptance Criteria\n- Asset parity:\n  - Asset list exactly matches the manifest from `br-1bm.5.1`.\n  - Fetching each asset returns expected bytes and headers.\n- Caching:\n  - Cache headers are correct for long-lived assets (or match legacy if conservative).\n  - Changing the asset content changes ETag/Last-Modified as expected.\n- Tests:\n  - Integration test enumerates asset URLs and asserts status=200, content-type, and cache headers.\n  - E2E suite (`br-1bm.5.5`) can load the UI with assets served correctly.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:41:24.807396589Z","created_by":"ubuntu","updated_at":"2026-02-05T06:30:40.459942264Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.5.4","depends_on_id":"br-1bm.5","type":"parent-child","created_at":"2026-02-05T05:41:24.807396589Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.5.4","depends_on_id":"br-1bm.5.1","type":"blocks","created_at":"2026-02-05T05:41:42.251144821Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.5.5","title":"Mail UI Parity: unit + integration + E2E tests","description":"Comprehensive tests for Mail UI parity, with detailed logging + artifacts.\n\nTest layers:\n- Unit tests:\n  - markdown rendering + sanitization (golden inputs)\n- Integration tests:\n  - template rendering snapshot tests (normalized where required)\n  - static asset fetch tests (content-type + caching headers)\n- E2E script:\n  - launch HTTP server\n  - fetch `/mail` routes\n  - validate DOM markers / key strings for each page\n  - capture HTML responses + server logs\n  - store artifacts under `tests/artifacts/mail_ui/<timestamp>/`\n\n## Acceptance Criteria\n- Snapshot tests cover at least: inbox empty, inbox with messages, thread view, compose page.\n- Sanitization tests include explicit malicious payload fixtures and assert neutralization.\n- E2E script:\n  - logs expected vs actual for each route\n  - writes a summary JSON (pass/fail + diffs)\n  - exits non-zero on mismatch\n- Running tests does not require external services (except optional DB fixtures); all fixtures are local.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:41:30.070251234Z","created_by":"ubuntu","updated_at":"2026-02-05T06:30:49.792017510Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.5.5","depends_on_id":"br-1bm.5","type":"parent-child","created_at":"2026-02-05T05:41:30.070251234Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.5.5","depends_on_id":"br-1bm.5.2","type":"blocks","created_at":"2026-02-05T05:41:47.673854697Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.5.5","depends_on_id":"br-1bm.5.3","type":"blocks","created_at":"2026-02-05T05:41:50.835253684Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.5.5","depends_on_id":"br-1bm.5.4","type":"blocks","created_at":"2026-02-05T05:41:55.016360728Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.5.5","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:56.231317288Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.6","title":"HTTP Request Logging + OTEL Parity","description":"Objective:\nImplement HTTP request logging exactly as legacy Python. OTEL settings exist in config but legacy does not instrument HTTP; parity is a no-op for OTEL flags.\n\nLegacy Reference Behavior:\n- When HTTP_REQUEST_LOG_ENABLED, emit structlog + rich panel output (fallback to plain text if rich unavailable).\n- Logging must not interfere with responses or error handling.\n- OTEL flags are parsed but do not initialize instrumentation in legacy.\n\nImplementation Considerations:\n- Use frankentui for rich output while matching legacy formatting/colors.\n- Ensure log output is disabled when not configured (no noise).\n- Do not change stdout/stderr behavior expected by MCP clients.\n\nTests and E2E (with detailed logging):\n- Spec extraction: br-1bm.6.1\n- Implementation: br-1bm.6.2 + br-1bm.6.3\n- Tests: br-1bm.6.4 (uses shared harness br-2ei.9.1)\n\n## Acceptance Criteria\n- Logging output matches spec extracted in br-1bm.6.1 (fields + ordering).\n- OTEL flags remain a no-op (no crash, no spans).\n- br-1bm.6.4 unit+integration+E2E suite passes with high-signal artifacts on failure.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:42:07.451798461Z","created_by":"ubuntu","updated_at":"2026-02-05T07:52:18.423928437Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.6","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:42:07.451798461Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.6.1","title":"HTTP Logging Parity: extract legacy behavior","description":"Extracted legacy HTTP logging behavior (mcp_agent_mail/src/mcp_agent_mail/http.py + config.py + tests):\n\nLegacy sources:\n- http.py: _configure_logging(), ExpectedErrorFilter, RequestLoggingMiddleware\n- config.py: LOG_JSON_ENABLED, LOG_RICH_ENABLED, LOG_LEVEL, LOG_INCLUDE_TRACE defaults\n- tests: test_expected_error_filter.py, test_logging_and_redis_fallback.py::test_log_json_enabled_path,\n  test_server.py::test_rich_logger_does_not_throw\n\nExact behavior to port:\n\n1) _configure_logging(settings) (idempotent, global _LOGGING_CONFIGURED)\n- structlog processors in order:\n  - structlog.contextvars.merge_contextvars\n  - structlog.processors.TimeStamper(fmt=\"iso\")\n  - structlog.processors.add_log_level\n  - then:\n    - if settings.log_json_enabled: structlog.processors.JSONRenderer()\n    - else: structlog.processors.KeyValueRenderer(key_order=[\"event\",\"path\",\"status\"])\n- structlog.configure wrapper_class: make_filtering_bound_logger(level=settings.log_level.upper() else INFO)\n- logging.basicConfig(level=settings.log_level.upper() else INFO)\n- Suppress noisy loggers:\n  - mcp.server.streamable_http -> WARNING\n  - mcp.server.lowlevel.server -> WARNING\n  - aiosqlite -> INFO\n  - git.util -> INFO\n  - git.cmd -> INFO\n  - filelock -> INFO\n  - sse_starlette.sse -> INFO\n\n2) ExpectedErrorFilter (applied ONLY to logger \"fastmcp.tools.tool_manager\")\n- Filters only when record.exc_info is present.\n- Patterns (case-insensitive substring):\n  - \"not found in project\"\n  - \"index.lock\"\n  - \"git_index_lock\"\n  - \"resource_busy\"\n  - \"temporarily locked\"\n  - \"recoverable=true\"\n  - \"use register_agent\"\n  - \"available agents:\"\n- Also treats exceptions with attribute recoverable=True as expected.\n- Also inspects __cause__ chain for patterns or recoverable=True.\n- If expected:\n  - record.exc_info = None; record.exc_text = None (traceback suppressed)\n  - if level >= ERROR: downgrade to INFO + levelname=\"INFO\"\n\n3) RequestLoggingMiddleware (enabled only when HTTP_REQUEST_LOG_ENABLED true)\n- Measures latency with time.time(); duration_ms = int((time.time()-start)*1000)\n- Fields:\n  - method = request.method\n  - path = request.url.path\n  - status = response.status_code\n  - client_ip = request.client.host if request.client else \"-\"\n- Structlog emission:\n  - structlog.get_logger(\"http\").info(\"request\", method=..., path=..., status=..., duration_ms=..., client_ip=...)\n- Rich output attempt (unconditional, not gated by LOG_RICH_ENABLED):\n  - Console(width=100)\n  - title = Text.assemble(\n      (method, \"bold blue\"), \"  \", (path, \"bold white\"), \"  \",\n      (status_code, \"bold green\" if 200<=status<400 else \"bold red\"), \"  \",\n      (f\"{dur_ms}ms\", \"bold yellow\"),\n    )\n  - body = Text.assemble((\"client: \", \"cyan\"), (client, \"white\"))\n  - Panel(body, title=title, border_style=\"dim\")\n- Fallback on any exception:\n  - print(\"http method={method} path={path} status={status} ms={dur_ms} client={client}\")\n\n4) LOG_RICH_ENABLED / LOG_INCLUDE_TRACE\n- LOG_RICH_ENABLED is used in llm.py cost logging (rich panel vs structlog); not consulted by HTTP request logging.\n- LOG_INCLUDE_TRACE exists in settings and tests (test_rich_logger_does_not_throw) but has no behavioral effect in HTTP logging.\n\n5) LOG_JSON_ENABLED\n- Only selects structlog JSONRenderer vs KeyValueRenderer; request logging emits via structlog and inherits renderer.\n- Legacy test only asserts LOG_JSON_ENABLED path does not crash on app build.\n\nDeliverables for implementers/tests:\n- Golden log examples (sanitized):\n  - 2xx / 4xx / 5xx requests (structlog + rich panel + fallback string)\n  - ExpectedErrorFilter case (traceback suppressed + level downgraded to INFO)\n- Explicit note: request logging uses request.client.host (not X-Forwarded-For), and duration is int ms.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:42:18.137231805Z","created_by":"ubuntu","updated_at":"2026-02-05T07:52:58.789104620Z","closed_at":"2026-02-05T07:52:58.789086847Z","close_reason":"Legacy HTTP logging behavior extracted and documented in bead description","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.6.1","depends_on_id":"br-1bm.6","type":"parent-child","created_at":"2026-02-05T05:42:18.137231805Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.6.2","title":"HTTP Logging Parity: request logging middleware","description":"Implement HTTP logging + ExpectedErrorFilter in Rust to match legacy behavior documented in br-1bm.6.1.\n\nKey parity requirements (from legacy):\n- Request logging is enabled ONLY by HTTP_REQUEST_LOG_ENABLED.\n- LOG_JSON_ENABLED selects structlog JSONRenderer vs KeyValueRenderer; request logs inherit this renderer.\n- LOG_RICH_ENABLED does NOT gate HTTP request logging (legacy always attempts rich output).\n- LOG_INCLUDE_TRACE has no effect on HTTP logging (exists only in config/tests).\n\nImplementation notes:\n- Mirror _configure_logging() idempotent setup and logger suppression.\n- ExpectedErrorFilter must behave exactly (pattern list + recoverable flag + cause chain); apply only to logger \"fastmcp.tools.tool_manager\".\n- Request logging uses request.client.host (no forwarded-header trust) and duration_ms = int(ms).\n- Rich output should mirror legacy layout; if rich not available, emit the exact fallback string.\n- Prefer frankentui for the rich/TTY rendering, but keep formatting/ordering/color semantics identical to legacy.\n\n## Acceptance Criteria\n- Output parity:\n  - Snapshot tests for structlog JSONRenderer branch and KeyValueRenderer branch.\n  - Rich panel layout matches legacy (method/path/status/duration/client, colors, width=100).\n  - Plain-text fallback line matches legacy format exactly.\n- Correctness:\n  - Logged fields are derived exactly (method, path, status, duration_ms, client_ip).\n  - ExpectedErrorFilter suppresses tracebacks and downgrades to INFO for expected/recoverable errors.\n- Performance:\n  - Near-zero overhead when HTTP_REQUEST_LOG_ENABLED is false.\n- Tests:\n  - Unit tests for ExpectedErrorFilter classifier and formatter.\n  - Integration tests validate logs emitted/absent without changing HTTP responses.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:42:22.022319697Z","created_by":"ubuntu","updated_at":"2026-02-05T07:47:30.488330616Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.6.2","depends_on_id":"br-1bm.6","type":"parent-child","created_at":"2026-02-05T05:42:22.022319697Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.6.2","depends_on_id":"br-1bm.6.1","type":"blocks","created_at":"2026-02-05T05:42:34.829012504Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.6.3","title":"HTTP Logging Parity: OTEL config no-op","description":"Legacy OTEL state is effectively a no-op: config fields exist, but http.py never initializes OpenTelemetry instrumentation. For parity, Rust should mirror this behavior unless legacy changes.\n\nConfig inputs (parsed only):\n- HTTP_OTEL_ENABLED\n- OTEL_SERVICE_NAME\n- OTEL_EXPORTER_OTLP_ENDPOINT\n\nRequirements (parity):\n- Do NOT emit spans/metrics in HTTP server based solely on these flags (legacy does nothing).\n- Enabling OTEL must not change request behavior or outputs.\n- If we later add real OTEL, it must be gated behind a separate explicit flag to avoid legacy drift.\n\n## Acceptance Criteria\n- When HTTP_OTEL_ENABLED is true:\n  - No OTEL provider/exporter is initialized (unless legacy adds it).\n  - Server continues to serve requests exactly as before.\n- Tests:\n  - Unit test confirms OTEL flags are parsed and stored.\n  - Integration test asserts enabling OTEL does not change logs/outputs or crash.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T05:42:26.087167604Z","created_by":"ubuntu","updated_at":"2026-02-05T07:47:45.022048630Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.6.3","depends_on_id":"br-1bm.6","type":"parent-child","created_at":"2026-02-05T05:42:26.087167604Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.6.3","depends_on_id":"br-1bm.6.1","type":"blocks","created_at":"2026-02-05T05:42:39.672384539Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.6.4","title":"HTTP Logging Parity: unit + integration + E2E tests","description":"Comprehensive tests for HTTP logging parity (request logs + structlog renderers + ExpectedErrorFilter), with detailed artifacts.\n\nTest layers:\n- Unit tests:\n  - formatting normalization (TTY vs non-TTY)\n  - conditional enablement: HTTP_REQUEST_LOG_ENABLED only\n  - LOG_JSON_ENABLED toggles JSONRenderer vs KeyValueRenderer (key_order=[event,path,status])\n  - field derivation (client_ip from request.client.host, latency int ms)\n  - ExpectedErrorFilter classifier:\n    - expected patterns detected and downgraded\n    - tracebacks suppressed for expected errors\n    - cause-chain inspection behavior\n- Integration tests:\n  - server with logging enabled emits logs\n  - server with logging disabled emits none\n  - LOG_JSON_ENABLED branch executed on app build (no crash)\n  - OTEL flags enabled: no-op parity (no spans, no behavior change)\n- E2E (part of scripts/e2e_http.sh, br-2ei.9.6):\n  - launch server with logging on\n  - issue representative requests (2xx/4xx/5xx)\n  - capture server stderr/stdout logs + HTTP transcripts\n  - store artifacts under tests/artifacts/http/<timestamp>/\n\nLegacy test references:\n- test_logging_and_redis_fallback.py::test_log_json_enabled_path\n- test_server.py::test_rich_logger_does_not_throw\n- test_expected_error_filter.py\n\n## Acceptance Criteria\n- Unit + integration tests cover the enable/disable matrix and TTY/non-TTY output.\n- Snapshot/golden log assertions are driven by the spec outputs from br-1bm.6.1.\n- ExpectedErrorFilter behavior matches legacy tests and pattern list.\n- E2E artifacts include clear expected-vs-actual field diffs and captured logs.\n- Tests run deterministically (fixed timestamps/latency fakes where required).","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:42:30.521330089Z","created_by":"ubuntu","updated_at":"2026-02-05T07:47:58.051121116Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.6.4","depends_on_id":"br-1bm.6","type":"parent-child","created_at":"2026-02-05T05:42:30.521330089Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.6.4","depends_on_id":"br-1bm.6.2","type":"blocks","created_at":"2026-02-05T05:42:43.034853482Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.6.4","depends_on_id":"br-1bm.6.3","type":"blocks","created_at":"2026-02-05T05:42:46.092367952Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.6.4","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:56.319100804Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.7","title":"CORS Parity Validation","description":"Objective:\nValidate and complete CORS behavior parity with legacy Python: origins, allow_methods, allow_headers, allow_credentials, and OPTIONS responses. Ensure behavior matches when lists are empty or \"*\".\n\nLegacy Reference Behavior:\n- If CORS enabled, allow_origins defaults to [\"*\"] when empty\n- allow_methods default [\"*\"]\n- allow_headers default [\"*\"]\n- Credentials flag respected\n\nImplementation Plan:\n- Ensure CORS config parsing matches legacy defaults.\n- Verify OPTIONS responses include appropriate headers.\n- Ensure origin matching allows all when list is empty.\n\nTests and E2E (with detailed logging):\n- Unit tests for allowlist matching and default behavior.\n- Integration tests for OPTIONS + GET/POST with Origin set.\n- E2E coverage via `br-2ei.9.6` (HTTP parity suite) with header transcripts.\n\n## Acceptance Criteria\n- CORS headers match legacy defaults and behavior across:\n  - empty lists\n  - explicit \"*\"\n  - allow_credentials on/off\n- Preflight (OPTIONS) behavior matches legacy (status + headers).\n- E2E artifacts include explicit header diffs on mismatch.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:43:03.472355999Z","created_by":"ubuntu","updated_at":"2026-02-05T08:23:06.874227229Z","closed_at":"2026-02-05T08:23:06.874209255Z","close_reason":"CORS parity: env defaults + wildcard handling + header override + tests","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.7","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:43:03.472355999Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.7","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:56.401992322Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.8","title":"Bearer Auth Parity","description":"Objective:\nEnsure Bearer token auth middleware behavior matches legacy Python, including localhost bypass logic and forwarded-header safeguards.\n\nLegacy Reference Behavior:\n- If bearer token configured, require Authorization: Bearer <token>\n- If allow_localhost_unauthenticated and client is localhost (no forwarded headers), bypass Authorization\n- OPTIONS and /health/* always allowed\n- Constant-time comparison for token equality\n\nImplementation Plan:\n- Verify Rust middleware path covers OPTIONS + /health/* bypass.\n- Enforce constant-time token compare.\n- Use peer_addr + forwarded headers for localhost detection (`br-1bm.3`).\n\nTests and E2E (with detailed logging):\n- Unit tests for token comparison + bypass conditions.\n- Integration tests for /health endpoints, OPTIONS, and standard POSTs.\n- E2E coverage via `br-2ei.9.6` (HTTP parity suite) including forwarded-header negative cases.\n\n## Acceptance Criteria\n- Responses and bypass behavior match legacy exactly (status + JSON body).\n- Constant-time compare is used (no early-return string compare).\n- E2E artifacts include explicit allow/deny traces and header diffs on mismatch.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:43:12.124733018Z","created_by":"ubuntu","updated_at":"2026-02-05T06:40:29.656247547Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.8","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:43:12.124733018Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.8","depends_on_id":"br-1bm.3","type":"blocks","created_at":"2026-02-05T05:43:23.276913856Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.8","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:56.484645140Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.9","title":"Health + Well-Known Endpoints Parity Tests","description":"Objective:\nVerify health and well-known endpoints match legacy behavior and remain stable. Ensure status codes and JSON payloads are identical.\n\nEndpoints:\n- GET /health/liveness -> {\"status\":\"alive\"}\n- GET /health/readiness -> {\"status\":\"ready\"} OR 503 {\"detail\":\"...\"}\n- GET /.well-known/oauth-authorization-server -> {\"mcp_oauth\": false}\n- GET /.well-known/oauth-authorization-server/mcp -> {\"mcp_oauth\": false}\n\nTests and E2E (with detailed logging):\n- Unit tests for readiness error formatting.\n- Integration tests for each endpoint and method mismatch (405).\n- E2E coverage via `br-2ei.9.6` (HTTP parity suite): hit each endpoint, log status/body, fail on mismatch.\n\n## Acceptance Criteria\n- JSON payloads and status codes identical to legacy for all endpoints.\n- Method mismatch behavior matches legacy (e.g., 405).\n- E2E artifacts include per-endpoint transcript and diffs on mismatch.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T05:43:18.747115290Z","created_by":"ubuntu","updated_at":"2026-02-05T06:40:36.900420537Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.9","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:43:18.747115290Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.9","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:56.567818709Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei","title":"MCP Agent Mail Rust: 100% feature parity + conformance + benchmarks","description":"Goal: complete the Rust port of legacy_python_mcp_agent_mail_code with 100% behavior/feature coverage, proven by fixture-based conformance tests + benchmarks (same bar as rich_rust/beads_rust).\n\nNon-negotiables:\n- Prefer local crates over upstream ecosystem where applicable:\n  - MCP: /dp/fastmcp_rust\n  - SQLite: /dp/sqlmodel_rust\n  - IO/concurrency: /dp/asupersync (avoid tokio unless unavoidable)\n  - Console UI: /dp/frankentui\n  - Beads: /dp/beads_rust\n  - Agent detection: /dp/coding_agent_session_search\n- No destructive commands or file deletions without explicit permission.\n\n## Success Criteria\n1. `cargo fmt --check` passes.\n2. `cargo clippy --all-targets -- -D warnings` passes.\n3. `cargo test` passes.\n4. Conformance harness covers ALL MCP tools + resources, including negative/error cases and documented normalization of nondeterminism.\n5. Archive artifact conformance proves git-side effects match legacy (messages/inbox/outbox/reservations/attachments).\n6. E2E suite passes with detailed artifacts/logs (`scripts/e2e_test.sh`).\n7. Benchmarks exist for hot paths and enforce regression budgets (tool latency, archive throughput, share/export throughput).\n8. HTTP server parity (br-1bm) is proven by unit/integration tests + a single E2E parity suite.\n9. Tool filtering profiles parity (br-2ei.10) is implemented and covered by conformance + E2E.\n10. Instrumentation parity (query tracking + slow query logging) (br-2ei.11) is implemented and covered by tests + E2E log capture.\n11. Notifications parity (signal files) (br-2ei.12) is implemented and covered by tests + E2E.\n12. LLM parity for summarize_thread llm_mode (br-2ei.13) is implemented and covered by deterministic tests (and conformance if feasible).\n13. Toon output format parity (tools + resources) (br-2ei.14) is implemented and covered by tests + E2E.\n14. HTTP background workers parity (ACK TTL + escalation + metrics emit + cleanup) (br-1bm.10) is implemented and covered by tests + E2E smoke.\n15. Port fully leverages local crates (fastmcp/sqlmodel/asupersync/frankentui/beads/coding_agent_session_search) and avoids redundant upstream runtime deps.","status":"open","priority":0,"issue_type":"epic","created_at":"2026-02-05T05:05:51.223489285Z","created_by":"ubuntu","updated_at":"2026-02-05T07:37:15.429809970Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"br-2ei.1","title":"Conformance Harness: cover all tools/resources + artifact parity","description":"Expand conformance tests so they prove real feature parity, not just API-shape parity.\n\nScope:\n- Ensure python_reference.json includes cases for every MCP tool registered by Rust server (currently missing: force_release_file_reservation, install_precommit_guard, uninstall_precommit_guard).\n- Add negative/error cases per tool where legacy behavior is defined (invalid params, CONTACT_BLOCKED flows, etc).\n- Add resource query-param variants where legacy supports them.\n- Add artifact-level assertions once storage/archive layer exists (message markdown files, inbox/outbox copies, file_reservation JSON artifacts, attachment manifests).\n\nKey files:\n- crates/mcp-agent-mail-conformance/tests/conformance/python_reference/generate_fixtures.py\n- crates/mcp-agent-mail-conformance/tests/conformance/fixtures/python_reference.json\n- crates/mcp-agent-mail-conformance/tests/conformance.rs\n\n## Success Criteria\n1. `cargo test -p mcp-agent-mail-conformance` fails on any behavioral drift.\n2. Fixtures are deterministic: normalize only true nondeterminism (timestamps, random IDs, commit SHAs) and document every normalization rule.\n3. All tools/resources present in the Rust server are covered by fixtures (positive + negative cases).\n4. Artifact conformance asserts archive side effects match legacy (paths + frontmatter + attachment manifests) in a platform-safe way.","status":"open","priority":1,"issue_type":"epic","created_at":"2026-02-05T05:06:15.213350684Z","created_by":"ubuntu","updated_at":"2026-02-05T06:57:56.032136497Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.1","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.1","depends_on_id":"br-2ei.10.3","type":"blocks","created_at":"2026-02-05T06:57:56.032096692Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.1.1","title":"Fixtures: missing tool coverage (guard install/uninstall + force_release)","description":"Track conformance fixture coverage for the last missing MCP tools (as reported by python_reference.json). This is a meta-epic; each tool gets its own child task with concrete fixture scenarios, normalization rules, and Rust runner integration.\n\nMissing tools to cover:\n- install_precommit_guard\n- uninstall_precommit_guard\n- force_release_file_reservation\n\nNon-negotiables:\n- Add BOTH positive and negative/error-path cases.\n- Record expected shapes from legacy Python and keep fixtures deterministic (normalize only true nondeterminism like timestamps/paths).\n- Include detailed logs in the fixture generator so failures are diagnosable.\n\nChild tasks under this epic should each include:\n- Legacy behavior matrix (inputs -> expected outputs)\n- Fixture generator changes\n- Rust conformance runner changes\n- Any required normalization rules documented inline\n\n## Success Criteria\n1. python_reference fixtures include deterministic cases for all missing tools.\n2. Rust conformance runner executes those cases and compares exact outputs after normalization.\n3. Failures are actionable: fixture generator logs show per-case setup + expected vs actual.","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-02-05T05:10:18.916319777Z","created_by":"ubuntu","updated_at":"2026-02-05T06:34:21.285026898Z","closed_at":"2026-02-05T06:34:21.284931268Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.1.1","depends_on_id":"br-2ei.1","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.1.1.1","title":"Fixtures: precommit guard install/uninstall tool cases","description":"Add conformance fixture coverage for:\n- install_precommit_guard(project_key, code_repo_path)\n- uninstall_precommit_guard(code_repo_path)\n\nFixture scenarios (must be stable + diagnostic):\n- Install into a fresh git repo (no existing hooks): succeeds; chain-runner + plugin present.\n- Install idempotency: second install is a no-op (or same result) and does not clobber preserved hook state.\n- Install when repo already has a pre-commit hook: legacy-preserve behavior matches (e.g., .orig + chain-runner semantics).\n- Uninstall: removes only agent-mail components and restores preserved hook when applicable.\n- Uninstall idempotency: running twice is safe.\n- Error paths: non-existent path, not-a-git-repo dir, permission denied / read-only hooks dir.\n\nNormalization rules:\n- Paths must be stored as relative or redacted (never machine-absolute).\n- Timestamps should be normalized if present.\n\nImplementation:\n- Extend python_reference fixture generator to create a temp repo and exercise the tools.\n- Update Rust conformance runner to execute these cases and compare to fixtures.\n- Log each subcase with: repo layout summary, expected vs actual tool result, and any created hook paths.\n\n## Acceptance Criteria\n1. python_reference.json contains deterministic cases for install_precommit_guard/uninstall_precommit_guard (positive + error cases).\n2. Rust conformance runner executes these cases and matches legacy outputs after documented normalization.\n3. Fixture generator logs include per-case repo layout + created hook paths + expected vs actual result.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:52:01.241854819Z","created_by":"ubuntu","updated_at":"2026-02-05T06:34:21.126079048Z","closed_at":"2026-02-05T06:34:21.126008285Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.1.1.1","depends_on_id":"br-2ei.1.1","type":"parent-child","created_at":"2026-02-05T05:52:01.241854819Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.1.1.1","depends_on_id":"br-2ei.3.4","type":"blocks","created_at":"2026-02-05T05:52:01.241854819Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.1.1.2","title":"Fixtures: force_release_file_reservation tool cases","description":"Add conformance fixture coverage for:\n- force_release_file_reservation(project_key, agent_name, file_reservation_id, notify_previous, note)\n\nFixture scenarios (must be deterministic):\n- DENY: reservation is not abandoned (recent agent activity / recent mail / recent archive activity).\n- ALLOW: reservation appears abandoned per legacy heuristics; reservation is released and archive artifacts updated.\n- ALLOW + notify_previous=true: a notification message is sent to the previous holder including the provided note + heuristic summary.\n- Edge cases:\n  - reservation already released -> no-op vs error (match legacy)\n  - reservation expired -> expected behavior (match legacy)\n  - invalid reservation id -> error shape parity\n\nDeterminism strategy:\n- In the fixture generator, explicitly set timestamps/last_active markers to known fixed values.\n- Normalize nondeterministic fields (timestamps, commit SHAs) only if the legacy fixture includes them.\n\nImplementation:\n- Extend python_reference fixture generator to set up agents + reservations + activity signals, then call the tool.\n- Update Rust conformance runner to execute these cases and compare.\n- Log each subcase with the measured heuristic signals and final allow/deny.\n\n## Acceptance Criteria\n1. python_reference.json contains deterministic force_release cases covering allow/deny + notify + edge cases.\n2. Rust conformance runner matches legacy outputs after documented normalization.\n3. Fixture generator logs print the heuristic signals used for the decision and the final allow/deny.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:52:13.014200455Z","created_by":"ubuntu","updated_at":"2026-02-05T06:34:21.204000576Z","closed_at":"2026-02-05T06:34:21.203927558Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.1.1.2","depends_on_id":"br-2ei.1.1","type":"parent-child","created_at":"2026-02-05T05:52:13.014200455Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.1.1.2","depends_on_id":"br-2ei.2.7","type":"blocks","created_at":"2026-02-05T05:52:13.014200455Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.1.2","title":"Fixtures: add negative/error cases (invalid params, contact enforcement, policy coercions)","description":"Add high-signal error cases to conformance so we lock in edge behavior.\n\nCandidates:\n- ensure_project: relative path -> error\n- register_agent: invalid name under strict enforcement -> error or coercion depending on config\n- send_message: CONTACT_BLOCKED / CONTACT_REQUIRED flows\n- file_reservation_paths: conflicts returned shape; TTL min enforcement\n- renew_file_reservations: invalid ids/paths\n- search_messages: FTS syntax vs LIKE fallback edge cases\n- resources: missing required query params -> error\n\nApproach:\n- Add cases to python fixture generator where legacy behavior is clear.\n- Normalize only nondeterministic fields.\n\nAcceptance:\n- Tests fail on any drift.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:10:53.695321528Z","created_by":"ubuntu","updated_at":"2026-02-05T05:38:33.464730817Z","closed_at":"2026-02-05T05:38:33.464713414Z","close_reason":"Added negative/error conformance cases and updated fixtures/generator","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.1.2","depends_on_id":"br-2ei.1","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.1.3","title":"Conformance: assert git archive artifacts (messages/inbox/outbox/reservations/attachments) match legacy","description":"Extend conformance beyond JSON tool outputs to verify archive side effects.\n\nArtifacts to assert after running a fixture script:\n- messages/YYYY/MM/*.md canonical exists; parses frontmatter JSON; body matches expected.\n- agents/<Agent>/inbox + outbox copies exist and match canonical.\n- file_reservations/*.json artifacts exist for created reservations.\n- attachments manifests + WebP/originals as expected.\n\nStrategy:\n- Fixture generator records expected relative paths and key frontmatter fields (never machine-absolute paths).\n- Use hashing for large binaries; compare sha256.\n- Allow nondeterministic timestamps but assert ordering and presence.\n\n## Acceptance Criteria\n1. `cargo test -p mcp-agent-mail-conformance` includes artifact assertions and fails on any drift.\n2. Fixtures record expected relative paths + key fields in a deterministic, cross-platform way.\n3. On failure, test output includes a clear diff/hint (which file mismatched, expected vs actual, hashes).","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-05T05:11:01.868813386Z","created_by":"ubuntu","updated_at":"2026-02-05T06:14:02.089293152Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.1.3","depends_on_id":"br-2ei.1","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.1.3","depends_on_id":"br-2ei.2.3","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.1.3","depends_on_id":"br-2ei.2.4","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.1.3","depends_on_id":"br-2ei.2.5","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.10","title":"Tool Filtering Profiles Parity (full/core/minimal/messaging/custom)","description":"Add full parity for legacy Python tool filtering (context reduction).\n\nLegacy feature:\n- Env-driven config:\n  - `TOOLS_FILTER_ENABLED`\n  - `TOOLS_FILTER_PROFILE` in {full, core, minimal, messaging, custom} (invalid -> full)\n  - `TOOLS_FILTER_MODE` in {include, exclude} (invalid -> include)\n  - `TOOLS_FILTER_CLUSTERS` CSV\n  - `TOOLS_FILTER_TOOLS` CSV\n- Predefined profiles map to cluster/tool allowlists (and special-case semantics when cluster list is empty).\n- Custom profile supports include/exclude semantics.\n- Filtering must affect:\n  - tools exposed via MCP `tools/list`\n  - tool directory resource (`resource://tooling/directory`) and related metadata\n  - any “cluster map”/tool metadata registries used for UX\n- Behavior must be deterministic and debuggable (log filtered tool count + exposed tool count).\n\nNon-goals:\n- No per-request dynamic filtering; filtering is applied at server startup exactly like legacy.\n\n## Success Criteria\n1. Tool filtering profiles match legacy Python behavior 1:1 (including custom include/exclude semantics).\n2. Conformance coverage exists for tool filtering (fixtures + Rust parity tests).\n3. HTTP E2E suite (`br-2ei.9.6`) includes a tool filtering smoke check (tools/list + tooling directory outputs).\n4. Filtering does not break default behavior when disabled (full tool set remains exposed).","status":"open","priority":1,"issue_type":"epic","created_at":"2026-02-05T06:54:46.298194912Z","created_by":"ubuntu","updated_at":"2026-02-05T06:54:46.298194912Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.10","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T06:54:46.298194912Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.10.1","title":"Tool Filter Spec: extract legacy profiles + custom mode semantics + vectors","description":"Extract the exact legacy Python tool filtering behavior into a self-contained spec + test vectors.\n\nLegacy sources:\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/config.py` (env parsing)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/app.py` (TOOL_FILTER_PROFILES + _should_expose_tool + _apply_tool_filter)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_tool_filter_and_notifications.py` (ground-truth behavioral tests)\n  - NOTE: this file also covers Notifications; notifications parity is tracked separately in `br-2ei.12`.\n\nMust capture verbatim:\n- The predefined profile definitions (`full`, `core`, `minimal`, `messaging`) including:\n  - clusters list\n  - tools list\n  - special-case semantics when profile clusters list is empty\n- Custom mode semantics:\n  - include vs exclude\n  - behavior when both clusters/tools lists are empty\n- Unknown/invalid profile and mode fallback rules.\n- Logging/debug behavior:\n  - what is logged at startup (removed count, exposed count)\n\nDeliverables:\n- Add a “Tool Filtering Profiles” section to `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md` including:\n  - the exact profile tables\n  - exact decision logic (pseudocode is OK but must be unambiguous)\n  - exact env var parsing + defaults\n- Add machine-usable vectors under `crates/mcp-agent-mail-conformance/tests/conformance/fixtures/tool_filter/`:\n  - expected tool list and tooling-directory outputs for at least:\n    - filtering disabled\n    - minimal profile\n    - core profile\n    - custom include (clusters + tools)\n    - custom exclude (clusters)\n\n## Acceptance Criteria\n- Spec is complete enough to implement without re-reading Python.\n- Vectors include exact expected tool names and cluster assignments.\n- Vectors include stable ordering expectations (how lists are sorted).\n- Regeneration instructions are included (command + expected output path).","status":"in_progress","priority":1,"issue_type":"task","created_at":"2026-02-05T06:55:00.999918625Z","created_by":"ubuntu","updated_at":"2026-02-05T08:46:09.571544652Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.10.1","depends_on_id":"br-2ei.10","type":"parent-child","created_at":"2026-02-05T06:55:00.999918625Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.10.2","title":"Tool Filter Impl: apply filtering to FastMCP tool registry + tooling resources","description":"Implement tool filtering profiles in the Rust server exactly as legacy Python.\n\nWork:\n- Config:\n  - Parse `TOOLS_FILTER_*` env vars into `mcp-agent-mail-core` config.\n  - Ensure invalid values fall back exactly like legacy (profile->full, mode->include).\n- Decision logic:\n  - Implement `_should_expose_tool` equivalent using cluster mapping + tool name.\n  - Implement predefined profiles (`full`, `core`, `minimal`, `messaging`) exactly as extracted in `br-2ei.10.1`.\n  - Implement custom include/exclude semantics exactly as extracted.\n- Registry filtering:\n  - Apply filtering at server startup (post-registration) like legacy `_apply_tool_filter`.\n  - Ensure filtered tools are removed from:\n    - FastMCP tool registry (so they do not appear in `tools/list`)\n    - tool cluster directory metadata (`resource://tooling/directory`)\n    - any tool metadata registries used for schemas/capabilities\n- Observability:\n  - Log a single high-signal line at startup when filtering is enabled:\n    - profile\n    - removed tool count\n    - exposed tool count\n  - Keep a stable internal list of filtered tools for debugging.\n\n## Acceptance Criteria\n- When filtering is disabled (default), the exposed tool list is identical to current behavior.\n- For each profile/custom mode, exposed tools match the vectors from `br-2ei.10.1`.\n- Filtering affects both:\n  - MCP `tools/list`\n  - `resource://tooling/directory` (clusters + tool lists)\n- Tests:\n  - Unit tests replicate legacy `test_tool_filter_and_notifications.py` tool-filter cases.\n  - Integration test exercises server start with filtering enabled and asserts the tool list is filtered.\n- No tokio runtime is introduced.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T06:55:31.347678353Z","created_by":"ubuntu","updated_at":"2026-02-05T06:55:36.213805782Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.10.2","depends_on_id":"br-2ei.10","type":"parent-child","created_at":"2026-02-05T06:55:31.347678353Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.10.2","depends_on_id":"br-2ei.10.1","type":"blocks","created_at":"2026-02-05T06:55:36.213759154Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.10.3","title":"Tool Filter Tests: conformance fixtures + unit/integration + E2E smoke","description":"Add comprehensive parity tests for tool filtering.\n\nWork:\n- Conformance fixtures:\n  - Extend Python fixture generator to produce tool-filter fixtures under `crates/mcp-agent-mail-conformance/tests/conformance/fixtures/tool_filter/`.\n  - Capture at least:\n    - `tools/list` output\n    - `resource://tooling/directory` output\n    - `resource://tooling/schemas` output (if legacy changes it under filtering)\n  - Run with env matrices:\n    - filtering disabled\n    - minimal\n    - core\n    - messaging\n    - custom include\n    - custom exclude\n- Rust conformance tests:\n  - Load tool-filter fixtures and assert Rust outputs match exactly.\n  - On mismatch, print a minimal diff (missing/extra tool names, cluster deltas).\n- Unit/integration tests:\n  - Mirror the legacy unit tests for `_should_expose_tool` and env parsing behavior.\n  - Integration test: start server with profile=custom include/exclude and validate `tools/list`.\n\nE2E:\n- Add a tool filtering smoke check to `scripts/e2e_http.sh` as part of `br-2ei.9.6`:\n  - run `tools/list` with filtering disabled and enabled (minimal)\n  - assert counts + presence/absence of key tools\n\n## Acceptance Criteria\n- `cargo test -p mcp-agent-mail-conformance` includes tool-filter fixtures and passes.\n- Fixture regeneration docs exist (command + expected output paths).\n- Unit tests cover the legacy matrix (profiles + custom include/exclude).\n- E2E HTTP suite includes at least one tool-filter-enabled run and emits clear diffs on failure.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T06:55:56.026244045Z","created_by":"ubuntu","updated_at":"2026-02-05T06:56:02.926211296Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.10.3","depends_on_id":"br-2ei.10","type":"parent-child","created_at":"2026-02-05T06:55:56.026244045Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.10.3","depends_on_id":"br-2ei.10.2","type":"blocks","created_at":"2026-02-05T06:56:02.926170119Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.11","title":"Instrumentation Parity: query tracking + slow query logging","description":"Port legacy Python query-tracking instrumentation (per-tool query stats + slow query reporting) to Rust.\n\nLegacy feature:\n- Env-driven config:\n  - `INSTRUMENTATION_ENABLED` (default false)\n  - `INSTRUMENTATION_SLOW_QUERY_MS` (default 250)\n- When enabled, each tool call captures:\n  - total query count\n  - total query time (ms)\n  - per-table query counts (best-effort table extraction from SQL)\n  - slow query counts (capped list)\n- Tool wrapper logs `tool_query_stats` with structured fields.\n- Instrumentation must be near-zero overhead when disabled.\n\nNon-goals:\n- Do not change tool outputs or HTTP responses.\n\n## Success Criteria\n1. Rust matches legacy instrumentation behavior when enabled (stats shape + logging semantics).\n2. Unit + integration tests cover tracker correctness and log emission.\n3. HTTP E2E suite (`br-2ei.9.6`) includes an instrumentation-enabled smoke check and captures logs.","status":"open","priority":2,"issue_type":"epic","created_at":"2026-02-05T06:56:13.877654086Z","created_by":"ubuntu","updated_at":"2026-02-05T06:56:13.877654086Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.11","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T06:56:13.877654086Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.11.1","title":"Instrumentation Spec: extract legacy QueryTracker + log fields + thresholds","description":"Extract the exact legacy Python instrumentation behavior into a self-contained spec.\n\nLegacy sources:\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/config.py` (env parsing)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/db.py` (QueryTracker)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/app.py` (tool wrapper: start/stop tracking + log `tool_query_stats`)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/rich_logger.py` (slow query presentation)\n\nMust capture:\n- Exact env defaults and parsing behavior.\n- Exact stats shape:\n  - total queries\n  - total_time_ms rounding\n  - per_table sorting rules\n  - slow_query_ms field\n  - slow query capture limit + what is recorded per slow query\n- Exact SQL table extraction heuristics (regexes) and cleaning behavior.\n- Exact log emission semantics:\n  - log event name (`tool_query_stats`)\n  - which fields are emitted (tool/project/agent/queries/query_time_ms/per_table/slow_query_ms)\n  - when logging happens (only when instrumentation enabled and tracker active)\n\nDeliverables:\n- Add an “Instrumentation / Query Tracking” section to `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md`.\n- Provide test vectors for table-name extraction and tracker aggregation under `crates/mcp-agent-mail-db/tests/fixtures/instrumentation/`.\n\n## Acceptance Criteria\n- Spec is detailed enough to implement without re-reading Python.\n- Vectors include:\n  - SELECT/INSERT/UPDATE statements with quoted identifiers and schema-qualified names\n  - edge cases where table name cannot be extracted\n  - slow query threshold boundary cases","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T06:56:26.966466761Z","created_by":"ubuntu","updated_at":"2026-02-05T06:56:26.966466761Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.11.1","depends_on_id":"br-2ei.11","type":"parent-child","created_at":"2026-02-05T06:56:26.966466761Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.11.2","title":"Instrumentation Impl: query tracker in db layer + per-tool logging (tokio-free)","description":"Implement query tracking + slow query instrumentation in Rust to match legacy.\n\nWork:\n- Config:\n  - Parse `INSTRUMENTATION_ENABLED` and `INSTRUMENTATION_SLOW_QUERY_MS` into core config.\n- Tracker core (in `mcp-agent-mail-db`):\n  - Implement a `QueryTracker` equivalent with:\n    - totals, total_time_ms\n    - per_table counts (sorted deterministically)\n    - slow query capture (capped list)\n  - Implement SQL table extraction heuristics matching legacy (regexes + cleaning).\n- Wiring:\n  - When instrumentation is enabled, start tracking at the beginning of each tool call and stop at end.\n  - Record query timings at the DB execution boundary (best-effort):\n    - count every SQL execution\n    - accumulate duration_ms\n    - record per-table counts\n    - record slow queries above threshold\n  - Emit a structured log event `tool_query_stats` with the legacy field set.\n\nConstraints:\n- Must not change tool/HTTP outputs.\n- Must be near-zero overhead when disabled.\n\n## Acceptance Criteria\n- Tracker behavior matches the spec from `br-2ei.11.1` (shape + rounding + sorting + limits).\n- Unit tests cover:\n  - table extraction heuristics\n  - record/aggregate behavior\n  - slow query threshold boundaries\n- Integration test executes a tool that performs known queries and asserts that a `tool_query_stats` log line is emitted with expected fields.\n- No tokio runtime introduced.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T06:56:37.195912390Z","created_by":"ubuntu","updated_at":"2026-02-05T06:56:45.899523108Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.11.2","depends_on_id":"br-2ei.11","type":"parent-child","created_at":"2026-02-05T06:56:37.195912390Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.11.2","depends_on_id":"br-2ei.11.1","type":"blocks","created_at":"2026-02-05T06:56:45.899487821Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.11.3","title":"Instrumentation Tests: unit + integration + E2E log capture","description":"Add comprehensive tests for instrumentation behavior.\n\nWork:\n- Unit tests (db crate):\n  - table name extraction vectors (quoted/schema-qualified/edge cases)\n  - aggregation + sorting determinism\n  - slow query capture limit and threshold boundaries\n- Integration tests:\n  - run a representative tool call with instrumentation enabled\n  - capture logs and assert:\n    - `tool_query_stats` event is emitted\n    - required fields exist and have plausible values\n    - slow_query_ms matches config\n- E2E:\n  - Add an instrumentation-enabled smoke check to `scripts/e2e_http.sh` (`br-2ei.9.6`):\n    - enable instrumentation\n    - trigger at least one DB-backed tool call\n    - assert log transcript includes a `tool_query_stats` entry\n    - store full server logs under `tests/artifacts/http/<timestamp>/`\n\n## Acceptance Criteria\n- Unit tests prove deterministic aggregation/sorting and correct SQL table extraction.\n- Integration test captures and asserts `tool_query_stats` log emission.\n- E2E HTTP suite includes instrumentation-enabled run and provides clear failure diagnostics.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T06:56:56.813594907Z","created_by":"ubuntu","updated_at":"2026-02-05T06:57:04.824257307Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.11.3","depends_on_id":"br-2ei.11","type":"parent-child","created_at":"2026-02-05T06:56:56.813594907Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.11.3","depends_on_id":"br-2ei.11.2","type":"blocks","created_at":"2026-02-05T06:57:04.824216159Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.12","title":"Notifications Parity: push-signal files (emit/clear/list + debounce + integration)","description":"Port legacy Python push-notifications (signal files on disk) with full behavior parity.\n\nLegacy feature (Python):\n- Env-driven config:\n  - NOTIFICATIONS_ENABLED (default false)\n  - NOTIFICATIONS_SIGNALS_DIR (default ~/.mcp_agent_mail/signals)\n  - NOTIFICATIONS_INCLUDE_METADATA (default true)\n  - NOTIFICATIONS_DEBOUNCE_MS (default 100)\n- Storage functions (legacy `storage.py`):\n  - emit_notification_signal(settings, project_slug, agent_name, message_meta) -> bool\n  - clear_notification_signal(settings, project_slug, agent_name) -> bool\n  - list_pending_signals(settings, project_slug?) -> list[dict]\n- On send_message:\n  - emits signals for `to` + `cc` recipients only (NOT bcc)\n  - writes JSON file at: {signals_dir}/projects/{project_slug}/agents/{agent}.signal\n  - JSON includes project, agent, timestamp, and message metadata (id/from/subject/importance) when include_metadata true\n- On fetch_inbox:\n  - clears that agent's signal file when notifications enabled\n- Debounce:\n  - prevent repeated signals for same (project, agent) within debounce window\n  - still allows different agent\n\nRust constraints:\n- No tokio runtime; use asupersync + std/fs as needed.\n- Keep overhead near-zero when disabled.\n\n## Success Criteria\n1. Rust matches legacy semantics for file path, JSON shape, include_metadata flag, and debounce rules.\n2. send_message and fetch_inbox integrate notification emit/clear exactly like legacy (including bcc exclusion).\n3. Unit + integration tests replicate `test_tool_filter_and_notifications.py::TestNotifications` exactly.\n4. E2E archive suite (`br-2ei.9.2`) validates signals behavior with clear artifacts/logs.","status":"open","priority":1,"issue_type":"epic","created_at":"2026-02-05T07:28:00.374857564Z","created_by":"ubuntu","updated_at":"2026-02-05T07:28:26.652534288Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.12","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T07:28:00.374857564Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.12.1","title":"Notifications Spec: extract legacy signal-file semantics + vectors","description":"Extract exact legacy Python notifications behavior into a self-contained spec + vectors.\n\nLegacy sources:\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/config.py` (notifications settings parsing)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/storage.py` (emit/clear/list implementations + debounce state)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/app.py` (integration points: send_message emits, fetch_inbox clears)\n- Tests: `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_tool_filter_and_notifications.py::TestNotifications`\n\nMust capture verbatim:\n- File path layout:\n  - `{signals_dir}/projects/{project_slug}/agents/{agent_name}.signal`\n- JSON payload shape:\n  - required keys (project, agent, timestamp)\n  - optional message metadata fields and when included (NOTIFICATIONS_INCLUDE_METADATA)\n- Debounce semantics:\n  - keying (project+agent)\n  - time source and window comparisons\n  - what state is stored (in-memory map), and reset behavior in tests\n- Error handling:\n  - what functions return on failure (bool / empty list)\n  - directory creation behavior\n- Integration semantics:\n  - send_message: to+cc only, not bcc\n  - fetch_inbox: clears signal best-effort when enabled\n\nDeliverables:\n- Add a “Notifications (Signals)” section to `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md`.\n- Add vectors/fixtures for JSON payloads (metadata on/off) under `crates/mcp-agent-mail-storage/tests/fixtures/notifications/`.\n\n## Acceptance Criteria\n- Spec is complete enough to implement without re-reading Python.\n- Vectors cover:\n  - enabled + include_metadata=true\n  - enabled + include_metadata=false\n  - debounce=0 (always emit)\n  - debounce>0 (skip repeated)\n  - list_pending_signals filtering by project_slug\n- Regeneration notes exist (command + path).","status":"in_progress","priority":1,"issue_type":"task","created_at":"2026-02-05T07:28:46.226613997Z","created_by":"ubuntu","updated_at":"2026-02-05T08:59:34.344122949Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.12.1","depends_on_id":"br-2ei.12","type":"parent-child","created_at":"2026-02-05T07:28:46.226613997Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.12.2","title":"Notifications Impl: signals config + storage helpers + tool integration","description":"Implement notifications (signal files) in Rust to match legacy Python.\n\nWork:\n- Config (core): parse and store:\n  - NOTIFICATIONS_ENABLED\n  - NOTIFICATIONS_SIGNALS_DIR (tilde expansion)\n  - NOTIFICATIONS_INCLUDE_METADATA\n  - NOTIFICATIONS_DEBOUNCE_MS\n- Storage helpers (tokio-free):\n  - emit_notification_signal(config, project_slug, agent_name, message_meta) -> bool\n  - clear_notification_signal(config, project_slug, agent_name) -> bool\n  - list_pending_signals(config, project_slug?) -> Vec<serde_json::Value / struct>\n- File semantics:\n  - create parent dirs if missing\n  - atomic-ish write (write temp then rename) to avoid partial JSON\n  - JSON payload matches spec from `br-2ei.12.1`\n- Debounce:\n  - in-memory map keyed by (project_slug, agent_name)\n  - duration window uses monotonic or wall clock in a way that matches Python tests\n  - allow distinct agents even within window\n- Tool integration:\n  - `send_message`: after archive write succeeds, emit signals for `to` + `cc` recipients only\n  - `fetch_inbox`: when enabled, clear signal file for that agent best-effort\n\nConstraints:\n- Keep overhead near-zero when disabled.\n- No tokio runtime.\n\n## Acceptance Criteria\n1. Behavior matches spec/vectors from `br-2ei.12.1`.\n2. send_message emits signals for to+cc only; bcc never emits.\n3. fetch_inbox clears signals best-effort when enabled.\n4. No changes to tool outputs aside from any legacy-consistent side effects.\n5. No tokio runtime introduced.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T07:28:57.609595222Z","created_by":"ubuntu","updated_at":"2026-02-05T07:30:09.368407911Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.12.2","depends_on_id":"br-2ei.12","type":"parent-child","created_at":"2026-02-05T07:28:57.609595222Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.12.2","depends_on_id":"br-2ei.12.1","type":"blocks","created_at":"2026-02-05T07:30:09.368367845Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.12.3","title":"Notifications Tests: unit + integration (deterministic + high-signal diffs)","description":"Add comprehensive unit + integration tests for notifications parity.\n\nWork:\n- Unit tests (storage): mirror legacy `TestNotifications`:\n  - disabled -> emit returns false\n  - enabled -> creates JSON file at exact path\n  - clear removes file\n  - list_pending_signals returns all and can filter by project\n  - debounce behavior with deterministic clock/time (test helper)\n- Integration tests:\n  - start server/router with notifications enabled\n  - send_message to self and another agent:\n    - verify signal file(s) exist for to+cc agents\n    - verify bcc agent has no signal\n  - fetch_inbox clears the agent signal\n- E2E:\n  - coordinate with `br-2ei.9.8` to validate filesystem side effects + debounce in a full run\n\n## Acceptance Criteria\n- `cargo test` includes notifications unit + integration cases and passes.\n- Tests are deterministic (no flaky sleeps; debounce window controlled).\n- Failure output is high-signal (expected vs actual JSON/file paths).\n- E2E artifacts stored under tests/artifacts/notifications/ with explicit diffs.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T07:29:06.075726731Z","created_by":"ubuntu","updated_at":"2026-02-05T08:16:24.064572407Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.12.3","depends_on_id":"br-2ei.12","type":"parent-child","created_at":"2026-02-05T07:29:06.075726731Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.12.3","depends_on_id":"br-2ei.12.2","type":"blocks","created_at":"2026-02-05T07:30:09.451503945Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.13","title":"LLM Parity: env bridge + completion helper + summarize_thread llm_mode","description":"Port legacy Python LLM integration (LiteLLM wrapper) to Rust with parity in behavior, config, and tests.\n\nLegacy feature surface:\n- Env/config:\n  - LLM_ENABLED (default true in legacy spec; verify exact default)\n  - LLM_DEFAULT_MODEL / LLM_TEMPERATURE / LLM_MAX_TOKENS\n  - LLM_CACHE_ENABLED (+ backend=memory|redis, redis url)\n  - LLM_COST_LOGGING_ENABLED\n  - Provider env bridge (synonyms): GEMINI_API_KEY -> GOOGLE_API_KEY, GROK_API_KEY -> XAI_API_KEY, etc.\n- Core helper:\n  - `complete_system_user(system, user, {model?, temperature?, max_tokens?}) -> {content, model, provider, estimated_cost_usd?}`\n  - Model alias resolution + “best available model” selection based on installed API keys\n  - Fallback to alternative provider-backed model on failure\n  - Cache enablement is best-effort (redis unavailable -> local)\n  - Cost logging must never break normal flow\n- Tool usage:\n  - `summarize_thread` supports `llm_mode=true` and optionally `llm_model` to refine/replace the computed summary.\n  - Multi-thread mode (`thread_id` comma-separated) uses LLM to refine the aggregate payload when enabled.\n\nConstraints:\n- No tokio runtime; use asupersync for outbound HTTP.\n- Must be testable without network (injectable stub client).\n\n## Success Criteria\n1. Rust matches legacy config parsing + provider env bridging semantics.\n2. `complete_system_user` works with a stub client and returns normalized output fields.\n3. `summarize_thread` with `llm_mode=true` matches legacy semantics and is covered by unit/integration tests.\n4. Conformance harness can cover llm_mode deterministically (stubbed response path) OR has an explicit, tested exclusion with rationale.","status":"open","priority":1,"issue_type":"epic","created_at":"2026-02-05T07:31:21.491871639Z","created_by":"ubuntu","updated_at":"2026-02-05T07:31:21.491871639Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.13","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T07:31:21.491871639Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.13.1","title":"LLM Spec: extract legacy llm.py behaviors + config + vectors","description":"Extract the exact legacy Python LLM behavior into a self-contained spec + vectors.\n\nLegacy sources:\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/llm.py` (env bridge, cache, cost logging, model selection, completion helper)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/config.py` (LLM settings parsing + defaults)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/app.py` (summarize_thread llm refinement integration)\n- Tests:\n  - `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_llm_and_utils.py`\n  - `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_entrypoints_and_llm.py`\n  - `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_entry_and_llm_errors.py`\n  - `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_summarize_threads_llm_on.py`\n  - `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_summarize_threads_llm_off.py`\n\nMust capture verbatim:\n- Provider env bridge mapping table (canonical env var -> aliases) and lookup order:\n  - os.environ first, then `.env` via decouple; only set canonical if missing.\n- Model alias resolution and “choose best available model” logic (provider key precedence).\n- Cache behavior:\n  - memory vs redis backend selection\n  - redis DNS sanity check + fallback-to-local behavior\n  - log line emitted on redis fallback\n- Cost logging behavior:\n  - callback registration via litellm.success_callback\n  - log only when response_cost > 0\n  - rich panel if log_rich_enabled; otherwise structlog\n  - never crash on logging errors\n- Completion call behavior:\n  - request shape (system/user messages)\n  - fallback-to-alt-model-on-error logic\n  - output normalization rules (extract content/model/provider)\n- Summarize_thread LLM refinement:\n  - llm_mode gating (requires LLM_ENABLED)\n  - single-thread prompt + expected JSON schema\n  - merge behavior for key_points (TODO/ACTION/FIXME/NEXT/BLOCKED heuristics)\n  - multi-thread prompt + expected JSON schema\n  - summarize_thread_product follows same LLM refinement path (if WORKTREES_ENABLED)\n  - JSON parsing uses `_parse_json_safely` (raw JSON, fenced block, brace-slice)\n  - error handling/logs: thread_summary.llm_skipped + summarize_thread.llm_skipped\n\nDeliverables:\n- Add/extend an “LLM” section in `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md` with the above rules.\n- Add deterministic vectors under `crates/mcp-agent-mail-tools/tests/fixtures/llm/`:\n  - env-bridge mapping cases\n  - summarize_thread refinement response JSON samples\n\n## Acceptance Criteria\n- Spec is complete enough to implement without re-reading Python.\n- Vectors cover success + failure:\n  - missing provider keys\n  - fallback-to-alt-model path\n  - invalid JSON in refinement response\n- Spec includes guidance on how Rust should keep tests offline (stub client) while matching semantics.","status":"in_progress","priority":1,"issue_type":"task","created_at":"2026-02-05T07:31:36.104473377Z","created_by":"ubuntu","updated_at":"2026-02-05T08:56:25.345901074Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.13.1","depends_on_id":"br-2ei.13","type":"parent-child","created_at":"2026-02-05T07:31:36.104473377Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.13.2","title":"LLM Impl: tokio-free completion client (asupersync) + summarize_thread refinement","description":"Implement legacy LLM behavior in Rust.\n\nWork:\n- Config (core): parse missing LLM env vars to match spec `br-2ei.13.1`:\n  - LLM_COST_LOGGING_ENABLED\n  - LLM_CACHE_BACKEND / LLM_CACHE_REDIS_URL\n- Provider env bridge:\n  - apply mapping table (e.g., GEMINI_API_KEY -> GOOGLE_API_KEY) at startup / before first call\n  - do not crash if .env missing\n- LLM client abstraction:\n  - introduce a small trait/interface so tests can inject a stub (no network)\n  - implement real client(s) using asupersync HTTP:\n    - at minimum: OpenAI-compatible chat completions + Google Gemini + Anthropic (as in legacy “best available” selection)\n    - implement fallback-to-alt-model selection logic\n  - normalize output into a stable struct `{content, model, provider, estimated_cost_usd?}`\n- Cache (best-effort):\n  - memory cache when enabled\n  - optional redis cache if configured and reachable; if unreachable, fall back to memory/local\n- Cost logging:\n  - when enabled, emit a single structured log event per completion with model/provider/cost when known\n  - never let logging break normal flow\n- Tool integration:\n  - `summarize_thread` supports llm_mode=true and llm_model override\n  - implement refinement step exactly like spec (parse JSON response, validate shape, merge)\n  - keep llm_mode path fully deterministic under stub client\n\nConstraints:\n- No tokio runtime.\n- No network access required for unit tests.\n\n## Acceptance Criteria\n1. `complete_system_user` works end-to-end with stub client and returns normalized output.\n2. Real client implementation uses asupersync (no reqwest/tokio).\n3. `summarize_thread` llm_mode semantics match spec and remain safe on invalid JSON (fallback behavior is spec-accurate).\n4. All new config/env behavior is covered by unit tests.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T07:31:48.149361512Z","created_by":"ubuntu","updated_at":"2026-02-05T07:32:18.795056997Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.13.2","depends_on_id":"br-2ei.13","type":"parent-child","created_at":"2026-02-05T07:31:48.149361512Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.13.2","depends_on_id":"br-2ei.13.1","type":"blocks","created_at":"2026-02-05T07:32:18.795007885Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.13.3","title":"LLM Tests: env bridge + completion normalization + summarize_thread llm_mode","description":"Add comprehensive tests for LLM parity.\n\nWork:\n- Unit tests (LLM module): mirror legacy tests:\n  - provider env bridge mapping (GEMINI_API_KEY -> GOOGLE_API_KEY, etc)\n  - completion helper returns normalized fields even when provider/router is missing/unavailable\n  - cost-logging enabled path does not panic\n  - cache enabled path does not panic; redis unavailable falls back\n- Tool-level tests:\n  - `summarize_thread` multi-thread mode with llm_mode=true uses stubbed completion response JSON and returns refined aggregate keys\n  - invalid JSON refinement response triggers spec-accurate fallback (no crash)\n- Integration tests:\n  - start server with LLM enabled + stub client injected\n  - exercise `summarize_thread` and `macro_prepare_thread` llm_mode paths\n- E2E:\n  - coordinate with `br-2ei.9.7` to run a stubbed llm_mode smoke, capture tool payloads + diffs\n\n## Acceptance Criteria\n- `cargo test` includes LLM unit + tool + integration tests and passes.\n- Tests are offline/deterministic (no network, no real API keys required).\n- Failure output includes minimal diffs on JSON mismatches.\n- E2E smoke validates llm_mode flows with artifact logs under tests/artifacts/llm/.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T07:31:57.009703582Z","created_by":"ubuntu","updated_at":"2026-02-05T08:15:36.103982253Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.13.3","depends_on_id":"br-2ei.13","type":"parent-child","created_at":"2026-02-05T07:31:57.009703582Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.13.3","depends_on_id":"br-2ei.13.2","type":"blocks","created_at":"2026-02-05T07:32:18.882197533Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.13.4","title":"LLM Conformance: deterministic llm_mode fixtures (stubbed)","description":"Extend conformance harness to cover `llm_mode=true` deterministically.\n\nApproach:\n- Update Python fixture generator to:\n  - enable LLM (LLM_ENABLED=true)\n  - stub the LLM completion helper to return a deterministic JSON refinement payload (like legacy test `test_summarize_threads_llm_on.py`)\n  - capture `summarize_thread` outputs for llm_mode=false and llm_mode=true in multi-thread mode\n- Update Rust conformance tests to:\n  - run in a deterministic stub-LLM mode (env flag or injected stub) so llm_mode outputs match fixtures\n  - assert exact payload equality with minimal diff output\n\nIf deterministic conformance is infeasible, explicitly document and test the exclusion:\n- Conformance excludes llm_mode=true because it depends on external providers.\n- Unit/integration tests must still prove llm_mode behavior using stubs.\n\n## Acceptance Criteria\n- Either:\n  1) conformance fixtures exist and pass for llm_mode=true (stubbed), OR\n  2) llm_mode=true conformance is explicitly excluded with rationale and has strong unit/integration coverage.\n- Fixture regen docs exist (command + paths).","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T07:32:06.642906159Z","created_by":"ubuntu","updated_at":"2026-02-05T07:32:19.053865720Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.13.4","depends_on_id":"br-2ei.1","type":"blocks","created_at":"2026-02-05T07:32:19.053806428Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.13.4","depends_on_id":"br-2ei.13","type":"parent-child","created_at":"2026-02-05T07:32:06.642906159Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.13.4","depends_on_id":"br-2ei.13.2","type":"blocks","created_at":"2026-02-05T07:32:18.966229530Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.14","title":"TOON Output Format Parity: tools + resources (format=toon envelope)","description":"Port legacy Python TOON output formatting.\n\nLegacy feature:\n- Tools accept optional `format` argument (\"json\" | \"toon\").\n- Resources accept `?format=...` query param.\n- When format=toon, the server:\n  - serializes the JSON payload\n  - runs external Rust encoder (`tru --encode` / toon encoder) if present\n  - wraps response in a stable envelope: {format:\"toon\", data:\"<TOON>\", meta:{...}}\n  - optionally includes token stats (TOON_STATS=true parses encoder stderr)\n  - on encoder error/non-zero exit, falls back to JSON envelope with meta.toon_error\n\nConstraints:\n- Must be deterministic/testable without requiring a real encoder binary (use stub in tests).\n- Must not break normal JSON output.\n\n## Success Criteria\n1. Tool and resource toon envelopes match legacy behavior and tests.\n2. Encoder detection + fallback semantics match legacy (including stats + error meta).\n3. Unit/integration tests mirror legacy `test_toon_formatting.py` + e2e toon flow.\n4. E2E suite includes a toon-format smoke run with artifacts.","status":"open","priority":1,"issue_type":"epic","created_at":"2026-02-05T07:35:38.532820388Z","created_by":"ubuntu","updated_at":"2026-02-05T07:35:38.532820388Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.14","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T07:35:38.532820388Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.14.1","title":"TOON Spec: extract encoder detection + envelope schema + stats + fallback","description":"Extract exact legacy Python toon-format behavior into a self-contained spec + vectors.\n\nLegacy sources:\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/app.py`:\n  - format handling for tools (format arg)\n  - encoder detection (`_looks_like_toon_rust_encoder`)\n  - encoder invocation (`_run_toon_encode`) and stderr parsing for stats\n  - fallback behavior on encoder error\n- Resources: where query param `format=toon` is handled and how it wraps blocks\n- Config env vars:\n  - TOON_DEFAULT_FORMAT\n  - TOON_STATS\n  - TOON_TRU_BIN / TOON_BIN\n- Tests:\n  - `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_toon_formatting.py`\n  - `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/e2e/test_toon_format_e2e.py`\n\nMust capture verbatim:\n- Envelope JSON shape for tools and resources:\n  - required keys: format, data, meta\n  - meta fields (encoder name, toon_stats fields, toon_error on fallback)\n- Encoder selection precedence:\n  - which env vars are consulted and in what order\n  - how “encoder looks valid” is determined\n- Stats parsing:\n  - how json_tokens/toon_tokens are extracted from stderr\n- Fallback:\n  - non-zero exit, empty stdout, missing encoder -> fall back to JSON envelope\n\nDeliverables:\n- Add a “Toon Output Format” section to `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md`.\n- Add vectors under `crates/mcp-agent-mail-tools/tests/fixtures/toon/`:\n  - sample JSON payloads and expected envelopes\n  - sample stderr lines and expected parsed stats\n\n## Acceptance Criteria\n- Spec is complete enough to implement without re-reading Python.\n- Vectors cover:\n  - successful encode\n  - encoder missing/invalid\n  - encoder returns non-zero\n  - TOON_STATS on/off\n- Spec explicitly states how resources apply toon formatting (query param).","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T07:35:51.901356626Z","created_by":"ubuntu","updated_at":"2026-02-05T07:35:51.901356626Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.14.1","depends_on_id":"br-2ei.14","type":"parent-child","created_at":"2026-02-05T07:35:51.901356626Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.14.2","title":"TOON Impl: format=toon wrappers for tools + resources (stub-friendly)","description":"Implement toon formatting in Rust per spec `br-2ei.14.1`.\n\nWork:\n- Config parsing (core): add missing TOON_* env vars and defaults.\n- Encoder selection + validation:\n  - resolve encoder binary path from TOON_TRU_BIN / TOON_BIN (and any legacy defaults)\n  - implement a validity check equivalent to legacy `_looks_like_toon_rust_encoder`\n- Encoder invocation:\n  - spawn encoder process with payload via stdin or args (match legacy)\n  - capture stdout/stderr + exit code\n  - parse stderr for token stats when TOON_STATS enabled\n- Envelope:\n  - wrap successful encode in {format:\"toon\", data:\"<TOON>\", meta:{...}}\n  - on failure, return JSON envelope with meta.toon_error (spec-accurate)\n- Tool integration:\n  - support `format` argument across tools (at least those in legacy tests/e2e)\n  - ideally implement as a single response-wrapper layer so all tools inherit it\n- Resource integration:\n  - support `?format=toon` query param on resources and wrap returned blocks accordingly\n\nConstraints:\n- No tokio runtime.\n- Must be testable with a stub encoder binary (no real tru required).\n\n## Acceptance Criteria\n1. Tool calls with format=toon match legacy envelopes and pass unit/integration tests.\n2. Resource reads with format=toon match legacy envelopes and pass tests.\n3. Fallback behavior on encoder failure matches spec.\n4. No impact to default JSON behavior.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T07:36:01.395611114Z","created_by":"ubuntu","updated_at":"2026-02-05T07:36:28.263296025Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.14.2","depends_on_id":"br-2ei.14","type":"parent-child","created_at":"2026-02-05T07:36:01.395611114Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.14.2","depends_on_id":"br-2ei.14.1","type":"blocks","created_at":"2026-02-05T07:36:28.263232165Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.14.3","title":"TOON Tests: unit + integration + offline stub encoder","description":"Add comprehensive tests for toon formatting parity.\n\nWork:\n- Unit tests:\n  - encoder path resolution + validity check\n  - stderr stats parsing (TOON_STATS)\n  - fallback behavior on non-zero exit / missing encoder\n- Integration tests (mirror legacy `test_toon_formatting.py`):\n  - tool output envelope for format=toon (health_check)\n  - resource output envelope for format=toon (resource://projects, resource://config/environment)\n  - resource query param format=toon is honored\n  - fallback on encoder error returns JSON envelope with meta.toon_error\n- E2E-ish test (mirror legacy `test_toon_format_e2e.py` but offline):\n  - call a small sequence of tools + one resource with format=toon\n  - write a structured log artifact for debugging failures\n\nImplementation detail:\n- Provide a deterministic stub encoder for tests (script or tiny Rust test helper) that:\n  - reads JSON payload and outputs fixed toon text\n  - optionally emits token stats to stderr\n\n## Acceptance Criteria\n- `cargo test` covers toon formatting paths and passes.\n- Tests are deterministic/offline and do not require tru/toon installed.\n- Failure output includes the envelope diff and captured stub stderr.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T07:36:11.883852255Z","created_by":"ubuntu","updated_at":"2026-02-05T07:36:28.351760878Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.14.3","depends_on_id":"br-2ei.14","type":"parent-child","created_at":"2026-02-05T07:36:11.883852255Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.14.3","depends_on_id":"br-2ei.14.2","type":"blocks","created_at":"2026-02-05T07:36:28.351699752Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.14.4","title":"TOON E2E: add scripts/e2e_toon.sh suite (artifacts + diffs)","description":"Add a dedicated toon-format E2E suite to prove the end-to-end behavior stays correct.\n\nScript:\n- scripts/e2e_toon.sh (wired into scripts/e2e_test.sh)\n\nFlow:\n- Start server/router in a temp workspace.\n- Run a representative set of tool calls with format=toon:\n  - health_check\n  - ensure_project\n  - register_agent\n- Read at least one resource with format=toon query param:\n  - resource://inbox/{agent}?project=...&format=toon\n- Validate:\n  - envelope shape\n  - format=\"toon\" on success\n  - fallback behavior when encoder is intentionally broken (meta.toon_error)\n\nArtifacts:\n- tests/artifacts/toon/<timestamp>/\n- Capture requests + responses and encoder stdout/stderr.\n\n## Acceptance Criteria\n- scripts/e2e_toon.sh runs via scripts/e2e_test.sh toon.\n- Script is deterministic and emits clear diffs on mismatch.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T07:36:19.307490353Z","created_by":"ubuntu","updated_at":"2026-02-05T07:36:28.528803996Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.14.4","depends_on_id":"br-2ei.14","type":"parent-child","created_at":"2026-02-05T07:36:19.307490353Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.14.4","depends_on_id":"br-2ei.14.2","type":"blocks","created_at":"2026-02-05T07:36:28.442541944Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.14.4","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T07:36:28.528752779Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2","title":"Storage: Git archive write/read pipeline + attachments","description":"Implement the git-backed mailbox archive described in EXISTING_MCP_AGENT_MAIL_STRUCTURE.md.\n\nLegacy Python writes messages + file reservations + attachments into a per-project git repo and uses it as an auditable artifact store.\n\nScope (must match legacy behavior):\n- Archive root creation + .gitattributes\n- Per-project advisory locks (.archive.lock + owner metadata)\n- Commit batching queue (max 10, max wait 50ms)\n- Message write pipeline:\n  - canonical messages/YYYY/MM/*.md\n  - agents/<Agent>/inbox + outbox copies\n  - thread digest files (messages/threads/<thread_id>.md) if present in legacy\n  - git commit message format\n- File reservation artifacts (file_reservations/<sha1(pattern)>.json + id-<id>.json)\n- Attachment pipeline:\n  - compute content hashes\n  - convert images to WebP when enabled\n  - inline small attachments (< 64KiB) into markdown\n  - keep originals when configured\n  - write manifests + audit logs\n- Read helpers for resources that include commit metadata.\n\nConstraints:\n- Prefer git2 library; avoid shelling out when possible.\n- Prefer asupersync for IO/concurrency.\n\n## Success Criteria\n1. Artifact conformance (br-2ei.1.3) can assert archive artifacts match legacy (layout + frontmatter + body + attachment manifests).\n2. E2E archive suite (br-2ei.9.2) passes and produces rich artifacts/logs.\n3. Benchmarks include archive write throughput and lock/commit batching overhead budgets.\n4. No cross-process corruption: advisory locks are cross-platform and stale-lock recovery is safe.","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-02-05T05:06:24.771240880Z","created_by":"ubuntu","updated_at":"2026-02-05T06:32:27.969412199Z","closed_at":"2026-02-05T06:32:27.969352095Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2.1","title":"Archive: initialize archive root + per-project git repos + .gitattributes","description":"Implement archive initialization in mcp-agent-mail-storage.\n\nRequirements:\n- Determine archive root from Config.storage_root (default ~/.mcp_agent_mail_git_mailbox_repo).\n- Ensure root exists.\n- For each project slug, ensure a git repo exists at <root>/<slug>/.\n- Ensure expected top-level dirs exist: agents/, messages/, attachments/, file_reservations/.\n- Write .gitattributes (at least: enforce LF for *.md and binary for images).\n- Ensure git author identity set from config (name/email) for commits.\n\nImplementation:\n- Use git2 to init and commit initial scaffolding if repo newly created.\n\nAcceptance:\n- Idempotent: calling multiple times does not change repo.\n- Unit test with temp dir.\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:09:03.245769103Z","created_by":"ubuntu","updated_at":"2026-02-05T05:54:58.115198238Z","closed_at":"2026-02-05T05:51:33.438544202Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2.1","depends_on_id":"br-2ei.2","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.1","depends_on_id":"br-2ei.2.8","type":"blocks","created_at":"2026-02-05T05:54:58.115151750Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2.2","title":"Archive: per-project advisory locks + commit batching queue","description":"Implement concurrency control for archive writes.\n\nSpec:\n- Per-project advisory lock file: <project>/.archive.lock (+ optional owner metadata JSON).\n- Commit queue batching: max 10 commits or max wait 50ms.\n- Stale lock cleanup on startup.\n\nImplementation notes:\n- Use filesystem lock (cross-platform) + busy-timeout retry. Prefer asupersync primitives if available.\n- Keep API simple for callers: `with_project_lock(project_slug, || ...)`.\n- Batching should preserve ordering for operations within a single process.\n\nAcceptance:\n- Unit tests simulate concurrent lock acquisition.\n- Bench: lock acquisition overhead is low.\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:09:10.275499179Z","created_by":"ubuntu","updated_at":"2026-02-05T05:59:10.781991766Z","closed_at":"2026-02-05T05:59:10.781924088Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2.2","depends_on_id":"br-2ei.2","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.2","depends_on_id":"br-2ei.2.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.2","depends_on_id":"br-2ei.2.8","type":"blocks","created_at":"2026-02-05T05:54:58.195154847Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2.3","title":"Archive: message write pipeline (canonical + inbox/outbox + commit) + frontmatter format","description":"Implement message archival writes that mirror legacy Python.\n\nSpec (EXISTING_MCP_AGENT_MAIL_STRUCTURE.md):\n- Canonical: messages/YYYY/MM/<timestamp>__<subject_slug>__<id>.md\n- Outbox: agents/<sender>/outbox/YYYY/MM/... (same rel path)\n- Inboxes: agents/<recipient>/inbox/YYYY/MM/...\n- Frontmatter: JSON preceded by ---json header line, then Markdown body.\n- Git commit summary: \"message <id> from <sender> to <recipients>\".\n\nInputs:\n- Message record + recipients + markdown body + attachments metadata.\n\nOutputs:\n- Files written atomically.\n- Git commit performed (or batched) and commit info stored/returned where needed.\n\nAcceptance:\n- Deterministic path + slug generation.\n- Conformance can assert files exist and parse.\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:09:23.321591344Z","created_by":"ubuntu","updated_at":"2026-02-05T05:59:12.811257421Z","closed_at":"2026-02-05T05:59:12.811191858Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2.3","depends_on_id":"br-2ei.2","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.3","depends_on_id":"br-2ei.2.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.3","depends_on_id":"br-2ei.2.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.3","depends_on_id":"br-2ei.2.8","type":"blocks","created_at":"2026-02-05T05:54:58.279552433Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2.4","title":"Archive: file reservation artifacts (sha1(pattern).json + id-<id>.json)","description":"Implement archive writes for file reservations.\n\nSpec:\n- file_reservations/<sha1(path_pattern)>.json\n- file_reservations/id-<id>.json\n\nRequirements:\n- JSON includes {id, agent, path_pattern, exclusive, reason, created_ts, expires_ts, released_ts} at minimum.\n- Writes are atomic.\n- Archive writes happen on reservation create/update/release and are committed (or batched).\n\nAcceptance:\n- Resource `resource://file_reservations/{slug}` can be backed by archive artifacts (optional) and/or DB.\n- Conformance can assert artifact existence.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:09:35.083785229Z","created_by":"ubuntu","updated_at":"2026-02-05T05:59:15.036374259Z","closed_at":"2026-02-05T05:59:15.036307894Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2.4","depends_on_id":"br-2ei.2","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.4","depends_on_id":"br-2ei.2.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.4","depends_on_id":"br-2ei.2.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.4","depends_on_id":"br-2ei.2.8","type":"blocks","created_at":"2026-02-05T05:54:58.363912498Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2.5","title":"Archive: attachment pipeline (hashing, WebP conversion, manifests, inline small)","description":"Implement attachment handling for both tool message sending and share/export.\n\nSpec:\n- attachments/<sha1[:2]>/<sha1>.webp\n- attachments/originals/<sha1[:2]>/<sha1>.<ext>\n- attachments/_manifests/<sha1>.json\n- attachments/_audit/<sha1>.log\n\nBehavior:\n- Convert images to WebP when enabled; disable when stderr not tty? (mirror legacy policy).\n- Inline attachments <= 64KiB into markdown; store larger attachments as files and reference via manifest.\n- Optionally keep originals.\n- Ensure deterministic hashing + stable paths.\n\nAcceptance:\n- Conformance can assert archive artifacts and message frontmatter attachment refs.\n- Works cross-platform.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:09:49.770615401Z","created_by":"ubuntu","updated_at":"2026-02-05T06:05:10.101840243Z","closed_at":"2026-02-05T06:05:10.101777995Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2.5","depends_on_id":"br-2ei.2","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.5","depends_on_id":"br-2ei.2.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.5","depends_on_id":"br-2ei.2.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.5","depends_on_id":"br-2ei.2.3","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.5","depends_on_id":"br-2ei.2.8","type":"blocks","created_at":"2026-02-05T05:54:58.445702962Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2.6","title":"Archive: read helpers + commit metadata (mailbox-with-commits/outbox/inbox views)","description":"Implement archive reads used by resources that include commit context.\n\nScope:\n- Given a canonical message path, map to git commit that introduced it.\n- Provide lightweight commit metadata (sha, summary, authored_ts) for mailbox/outbox views.\n- Support `whois(include_recent_commits=true)` by reading recent archive commits filtered by author.\n\nImplementation:\n- Prefer git2 for log traversal.\n- Cache where sensible to avoid O(N) per request.\n\nAcceptance:\n- Resource outputs match legacy Python shapes for mailbox-with-commits and whois.\n- Benchmarks cover common read paths.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:10:02.774438616Z","created_by":"ubuntu","updated_at":"2026-02-05T06:08:17.925340091Z","closed_at":"2026-02-05T06:08:17.925279166Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2.6","depends_on_id":"br-2ei.2","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.6","depends_on_id":"br-2ei.2.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.6","depends_on_id":"br-2ei.2.3","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2.7","title":"Reservations: implement force_release_file_reservation (inactivity heuristics + optional notify)","description":"Implement force-release stale file reservations (MCP tool).\n\nSpec:\n- Validate reservation appears abandoned:\n  - agent inactive beyond threshold\n  - no recent mail activity\n  - no recent filesystem/git activity (archive)\n- When released, optionally notify previous holder with a human-readable note.\n\nImplementation plan:\n- Define which activity signals we can reliably measure in Rust:\n  - `agent.last_active_ts` in DB\n  - last message activity timestamps (inbox/outbox/canonical)\n  - archive activity timestamps (last commit touching agent/mail artifacts)\n- Implement heuristics with conservative defaults and an explicit “why” explanation string.\n- Write release to DB + archive artifacts (so humans can audit forced releases).\n- If `notify_previous=true`: send a threaded message to the previous holder explaining the forced release and including the heuristics snapshot.\n\n## Acceptance Criteria\n- Safety / correctness:\n  - Force-release is denied unless heuristics strongly indicate abandonment (tests cover deny path).\n  - When allowed, release updates both DB state and archive artifacts (tests assert both).\n  - No-op behavior when reservation already released/expired is well-defined.\n- Observability:\n  - Tool output includes a machine-parseable explanation (what signals were checked + thresholds + timestamps used).\n  - Optional notify message includes the explanation and the operator’s note.\n- Conformance:\n  - Fixture-based conformance tests cover at least: allow path, deny path, and allow-with-notify path.\n- Tests:\n  - Unit tests cover heuristic evaluation boundary conditions (just-below/just-above thresholds).\n  - Integration test runs through the full tool pipeline and validates resulting archive messages + reservation state.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:10:29.903046515Z","created_by":"ubuntu","updated_at":"2026-02-05T06:30:28.285447850Z","closed_at":"2026-02-05T06:30:28.285367769Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2.7","depends_on_id":"br-2ei.2","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.7","depends_on_id":"br-2ei.2.4","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.7","depends_on_id":"br-2ei.2.6","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2.8","title":"Archive spec: exact paths/frontmatter/commit + .gitattributes + attachment policy","description":"Extract the exact legacy git-archive behavior into a self-contained spec + test vectors.\n\nMust extract verbatim from legacy Python:\n- Archive root path rules (defaults + env/CLI overrides)\n- Repo initialization behavior:\n  - exact directory layout\n  - exact .gitattributes content (line endings + binary rules)\n  - initial commit behavior + message (if any)\n- Message path format rules:\n  - timestamp formatting\n  - subject slug rules (unicode, punctuation, truncation)\n  - ID formatting\n- Frontmatter format:\n  - exact header line(s)\n  - JSON formatting rules (pretty vs compact, key ordering if any)\n  - trailing newlines\n- Outbox/inbox copy rules\n- Commit batching semantics (what gets grouped into a commit, commit message format)\n- Reservation artifact JSON schema and naming (sha1 inputs, casing)\n- Attachment policy:\n  - hashing algorithm(s)\n  - WebP conversion policy triggers\n  - inline thresholds and exact markdown embedding format\n  - manifest/audit log formats\n\nDeliverables:\n- Explicit spec section in EXISTING_MCP_AGENT_MAIL_STRUCTURE.md (or equivalent) with concrete examples.\n- Test vectors for slug/frontmatter and a golden file tree for 1-2 representative messages.\n\nAcceptance:\n- Implementers can build br-2ei.2.* without consulting Python again.\n- Unit tests can assert byte-for-byte markdown + JSON artifact equality.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:54:29.422073298Z","created_by":"ubuntu","updated_at":"2026-02-05T05:59:38.804611487Z","closed_at":"2026-02-05T05:59:38.804548929Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2.8","depends_on_id":"br-2ei.2","type":"parent-child","created_at":"2026-02-05T05:54:29.422073298Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.3","title":"Guard: pre-commit/pre-push enforcement + install/uninstall tooling","description":"Implement the Agent Mail guard system (pre-commit / pre-push hooks) that prevents edits when exclusive file reservations conflict.\n\nSpec source:\n- EXISTING_MCP_AGENT_MAIL_STRUCTURE.md section \"Guard Behavior (Pre-Commit / Pre-Push)\"\n\nScope:\n- `mcp-agent-mail-guard` crate:\n  - install_guard(project, repo): resolves hooks dir (core.hooksPath or default), writes chain-runner hooks, writes plugin scripts under hooks.d/<hook>.\n  - uninstall_guard(repo): removes our plugins; removes chain-runner only if safe (no other plugins) and restores .orig if applicable.\n  - guard_status(repo): reports resolved hooks path + presence of pre-commit/pre-push + mode.\n  - guard_check(repo, paths, advisory): checks active file reservations and returns conflicts (pattern, holder, expires_ts).\n- MCP tools:\n  - install_precommit_guard(project_key, code_repo_path)\n  - uninstall_precommit_guard(code_repo_path)\n- CLI wiring:\n  - `am guard install|uninstall|status|check` delegates to the guard crate.\n\nImplementation notes:\n- Use git2 to discover repo + read config.\n- Path matching: prefer pathspec (gitignore syntax) with symmetric fnmatch fallback.\n- Must respect env vars: AGENT_MAIL_GUARD_MODE, AGENT_MAIL_BYPASS, AGENT_NAME.\n\n## Success Criteria\n1. Guard tool outputs match legacy fixtures (install/uninstall/status/check).\n2. Unit + integration tests cover: hooksPath/worktrees, idempotent install/uninstall, path matching, rename handling, conflict detection.\n3. E2E guard suite (br-2ei.9.3) blocks commits on conflicts and allows after release, with clear stderr and rich artifacts.","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-02-05T05:06:34.458664027Z","created_by":"ubuntu","updated_at":"2026-02-05T06:32:18.466527207Z","closed_at":"2026-02-05T06:32:18.466466844Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.3","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.3.1","title":"Guard: resolve repo + hooks dir (core.hooksPath, worktrees) via git2","description":"Implement robust hooks directory resolution.\n\nRequirements:\n- Input: repo working tree path (code_repo_path).\n- Discover git repo (supports worktrees).\n- Determine hooks dir:\n  - If core.hooksPath is set: resolve relative to repo root per git semantics.\n  - Else: use default hooks dir for the repository common dir.\n- Return resolved hooks_dir as a real filesystem path.\n\nMust handle:\n- .git is a file containing gitdir: ...\n- worktrees where hooks live in common dir\n- bare repo (if encountered) -> treat as invalid for hook install\n\nDeliverable:\n- `mcp_agent_mail_guard::resolve_hooks_dir(repo: &Path) -> GuardResult<PathBuf>` (or equivalent internal helper) with unit tests.\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:07:47.277296976Z","created_by":"ubuntu","updated_at":"2026-02-05T05:18:05.735479435Z","closed_at":"2026-02-05T05:18:05.735461692Z","close_reason":"Implemented resolve_hooks_dir via git2 + commondir parsing; added unit tests incl. worktree case.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.3.1","depends_on_id":"br-2ei.3","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.3.2","title":"Guard: install/uninstall chain-runner hooks + agent-mail plugin scripts","description":"Implement install/uninstall mechanics (pre-commit and optionally pre-push).\n\nInstall behavior (match legacy):\n- Ensure hooks.d/<hook>/ directory exists.\n- Write/overwrite top-level hook script (chain-runner) that executes hooks.d/<hook>/* in lexical order.\n- Preserve existing non-chain hook as <hook>.orig.\n- Install our plugin under hooks.d/<hook>/50-agent-mail (or equivalent) that executes the actual guard check.\n- Create Windows shims (.cmd/.ps1) if needed to invoke the chain-runner.\n\nUninstall behavior:\n- Remove our plugins (hooks.d/<hook>/50-agent-mail.*).\n- Only remove chain-runner if it is ours AND there are no other plugins remaining AND no .orig restoration is needed.\n- If .orig exists and chain-runner is removed, restore it.\n\nDeliverables:\n- `install_guard(project_key, repo)` writes files and chmods +x on unix.\n- `uninstall_guard(repo)` removes/restores safely.\n- Unit tests use temp git repos.\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:08:05.382529734Z","created_by":"ubuntu","updated_at":"2026-02-05T05:25:45.469594914Z","closed_at":"2026-02-05T05:25:45.469578243Z","close_reason":"Implemented install_guard/uninstall_guard: resolves hooks dir, installs python chain-runner + Windows shims, installs plugin stub, preserves/restores existing hook via .orig; added unit test for preserve/restore.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.3.2","depends_on_id":"br-2ei.3","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.3.2","depends_on_id":"br-2ei.3.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.3.3","title":"Guard: implement conflict detection (reservations + path matching + rename handling)","description":"Implement the actual guard decision logic.\n\nInputs:\n- repo path\n- list of paths to check (from staged diff for pre-commit, from commit range for pre-push)\n- AGENT_NAME env var identifies current agent\n- mode: block vs warn (AGENT_MAIL_GUARD_MODE)\n- bypass env: AGENT_MAIL_BYPASS=1\n\nLogic:\n- If guard disabled (WORKTREES_ENABLED or GIT_IDENTITY_ENABLED false): allow.\n- Load active file reservations for the project identity associated with repo (project_identity_mode logic).\n- If any exclusive reservation matches any path (symmetric matching) and reservation holder != AGENT_NAME and unexpired: conflict.\n- For renames: treat both old and new paths as touched.\n\nDeliverables:\n- Pure function that returns conflicts (pattern, holder, expires_ts) for a given path list.\n- Helper to obtain staged paths from git: `git diff --cached --name-only -z --diff-filter=ACMRDTU` and rename pairs from `--name-status -M -z`.\n- Helper to obtain pre-push paths from stdin refs (`git rev-list`) with fallback to `git diff --name-status -M -z <remote>..<local>`.\n\nTests:\n- Synthetic reservations + path lists.\n- Temp repo with staged rename.\n\n## Acceptance Criteria\n1. Guard conflict detection matches legacy behavior for:\n   - exclusive vs shared reservations\n   - holder == AGENT_NAME bypass\n   - expired/released reservations\n   - rename pairs (old + new paths considered touched)\n2. Unit tests cover synthetic and real-repo staged rename scenarios.\n3. Hook output is clear enough that the E2E guard suite can assert expected failure messaging.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:08:19.800578519Z","created_by":"ubuntu","updated_at":"2026-02-05T06:16:39.864330762Z","closed_at":"2026-02-05T06:16:39.864261040Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.3.3","depends_on_id":"br-2ei.3","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.3.3","depends_on_id":"br-2ei.3.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.3.4","title":"Guard Tools: install_precommit_guard/uninstall_precommit_guard wiring","description":"Wire MCP tools to the Rust guard crate (fixture generation + conformance assertions live under br-2ei.1.*; keep this issue implementation-only).\n\nTools:\n- install_precommit_guard(project_key, code_repo_path)\n- uninstall_precommit_guard(code_repo_path)\n\nRequirements:\n- Call into mcp-agent-mail-guard for repo discovery + hooks dir resolution.\n- Idempotent + safe:\n  - Install preserves existing hooks and writes chain-runner + agent-mail plugin(s).\n  - Uninstall removes only agent-mail components; restores preserved hooks when applicable.\n- Error parity:\n  - Invalid repo paths, non-repo dirs, permission errors map to the same error semantics as legacy.\n- Output parity:\n  - JSON-RPC result shape must match legacy fixtures exactly.\n\nTests:\n- Unit tests: parameter validation + error mapping.\n- Integration test: temp git repo, run tool handler install then uninstall, assert expected hook files created/removed.\n\n## Acceptance Criteria\n1. Tool handlers call mcp-agent-mail-guard and are idempotent and safe (no clobber of existing hooks).\n2. Errors for invalid paths/non-repos/permission issues match legacy (status + message shape).\n3. Unit + integration tests cover install/uninstall success, preserve/restore behavior, and error mapping.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:08:32.548948635Z","created_by":"ubuntu","updated_at":"2026-02-05T06:25:07.728723226Z","closed_at":"2026-02-05T06:25:07.728662662Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.3.4","depends_on_id":"br-2ei.3","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.3.4","depends_on_id":"br-2ei.3.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.3.5","title":"Guard: add unit + integration tests (git repos, worktrees, hooksPath, conflicts)","description":"Add focused tests to ensure guard behavior remains correct.\n\nTests should cover:\n- hooks dir resolution: default vs core.hooksPath vs worktree common dir.\n- install/uninstall idempotency and preservation of existing hooks.\n- path matching: pathspec (if enabled) vs fnmatch fallback.\n- conflict detection: exclusive reservations by other agent blocks; shared reservations do not.\n- rename pairs considered touched.\n\n## Acceptance Criteria\n1. `cargo test -p mcp-agent-mail-guard` includes unit + integration coverage for the above behaviors.\n2. Tests include detailed assertions/messages so failures show exact mismatch (paths, patterns, holder, env mode).\n3. Tests run in temp dirs and are hermetic (no reliance on developer machine state).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:08:46.185640629Z","created_by":"ubuntu","updated_at":"2026-02-05T06:17:15.030854934Z","closed_at":"2026-02-05T06:17:15.030779843Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.3.5","depends_on_id":"br-2ei.3","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.3.5","depends_on_id":"br-2ei.3.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.3.5","depends_on_id":"br-2ei.3.3","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4","title":"Share/Export: static bundle pipeline (SQLite snapshot + scrub + attachments + signing/encryption)","description":"Port legacy share/export pipeline to Rust (mcp-agent-mail-share + CLI).\n\nSpec source:\n- EXISTING_MCP_AGENT_MAIL_STRUCTURE.md section \"Share / Export Pipeline (Static Bundle)\"\n\nScope:\n- Snapshot SQLite safely (WAL checkpoint + sqlite backup) into export DB.\n- Apply project scoping (delete rows from other projects).\n- Scrub presets: standard/strict/archive.\n- Build FTS + materialized views; add indexes.\n- Finalize DB for export (journal_mode=DELETE, page_size=1024, VACUUM, ANALYZE).\n- Bundle attachments:\n  - Inline <= 64KiB\n  - Detach >= 25MiB\n  - Copy others into attachments/<sha256[:2]>/<sha256>.<ext>\n  - Rewrite messages.attachments JSON to bundle paths / data URIs\n- Chunk DB if >= 20MiB.\n- Bundle scaffolding: manifest.json, README, deploy hints, _headers.\n- Optional: sign manifest (Ed25519), encrypt bundle (age), package zip.\n\nConstraints:\n- Prefer sqlmodel_rust for SQLite operations.\n- Prefer asupersync for IO.\n\n## Success Criteria\n1. CLI share commands work end-to-end and match legacy behavior where specified.\n2. Bundle output is deterministic for identical inputs (stable ordering + hashing).\n3. E2E share suite (br-2ei.9.4) passes and produces a verifiable bundle tree + hashes.\n4. Benchmarks exist for share/export throughput and enforce regression budgets.","status":"open","priority":1,"issue_type":"epic","created_at":"2026-02-05T05:06:43.381856509Z","created_by":"ubuntu","updated_at":"2026-02-05T06:10:45.734324771Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.1","title":"Share: SQLite snapshot + project scoping (WAL checkpoint + backup)","description":"Implement share/export phase 1: snapshot + project scoping.\n\nThis task consumes the extracted spec from `br-2ei.4.7`.\n\nWork (in `crates/mcp-agent-mail-share/`):\n- Open the live SQLite DB via `sqlmodel_rust` with appropriate busy-timeout.\n- Perform legacy-equivalent WAL checkpoint behavior before snapshot.\n- Use the SQLite backup API to create an export DB file (no mutation of live DB).\n- Apply project scoping rules to the export DB:\n  - delete rows for non-selected projects per spec\n  - preserve referential integrity (foreign keys / cascade behavior per spec)\n- Run any required integrity checks on the export DB (per spec).\n\n## Acceptance Criteria\n- Export DB creation is read-only w.r.t. the live DB (unit test asserts live DB unchanged).\n- Export DB passes `PRAGMA integrity_check` (and any other required PRAGMAs from spec).\n- Scoping correctness:\n  - Given a fixture DB with multiple projects + cross-table references, the scoped export contains only the selected project(s) and no dangling references.\n  - Exact table list + deletion semantics match the spec from `br-2ei.4.7`.\n- Determinism:\n  - Snapshot+scope on the same fixture produces a stable sha256 for the resulting DB file (after any required normalize/finalize steps for this phase).\n- Tests:\n  - Unit tests cover: busy/locked DB behavior, multi-project scoping, and integrity checks.\n  - Conformance fixture comparison is wired (Rust output vs Python fixture) for at least one scoped DB.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:12:07.493892557Z","created_by":"ubuntu","updated_at":"2026-02-05T08:09:50.930750975Z","closed_at":"2026-02-05T08:09:50.930719165Z","close_reason":"Implemented create_sqlite_snapshot (VACUUM INTO) + apply_project_scope with 8 tests (3 snapshot + 4 scope + 1 conformance against Python fixture). All passing.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.1","depends_on_id":"br-2ei.4","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.1","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T05:55:07.893842107Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.2","title":"Share: scrub presets (standard/strict/archive)","description":"Implement scrub logic on the scoped export DB.\n\nThis task must follow the extracted scrub rules from `br-2ei.4.7` exactly.\n\nPresets:\n- `standard`: remove obvious secrets, keep most content\n- `strict`: more aggressive scrubbing/redaction\n- `archive`: minimal/none (match legacy precisely)\n\nDeliverable (in `crates/mcp-agent-mail-share/`):\n- Deterministic scrub transformations for each preset.\n- A single entrypoint that takes (export_db_path, preset, scrub_seed/config) and produces a scrubbed DB (in-place or copy per spec).\n\n## Acceptance Criteria\n- Parity:\n  - For every preset, the scrub operations match the per-table/per-column rules extracted in `br-2ei.4.7`.\n  - “Delete vs redact” decisions match legacy.\n- Determinism:\n  - Running scrub twice on the same input DB yields byte-identical scrubbed DB output (or stable sha256 if finalization steps change file layout).\n  - Any ordering/normalization rules required for determinism are implemented and documented.\n- Tests:\n  - Unit tests cover each preset against conformance fixture DBs (from `br-2ei.4.7`) and assert expected hashes.\n  - Edge-case tests cover: NULLs, empty strings, unicode text, large blobs, missing optional tables/columns (if legacy tolerates).\n- Safety:\n  - Scrub does not panic on unexpected rows; it either scrubs conservatively or fails with a clear error that is surfaced to caller.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:12:12.920255187Z","created_by":"ubuntu","updated_at":"2026-02-05T08:15:01.040933972Z","closed_at":"2026-02-05T08:15:01.040873117Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.2","depends_on_id":"br-2ei.4","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.2","depends_on_id":"br-2ei.4.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.2","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T05:55:07.981100993Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.3","title":"Share: build FTS/views + export-finalize DB (indexes, journal_mode=DELETE, VACUUM, ANALYZE)","description":"Implement export DB finalization (FTS, views, indexes, and compacting).\n\nThis task consumes:\n- The scoped+scrubbed export DB produced by `br-2ei.4.1` + `br-2ei.4.2`.\n- The DDL/PRAGMA ordering spec extracted in `br-2ei.4.7`.\n\nWork (in `crates/mcp-agent-mail-share/`):\n- Build any required FTS index(es) and materialized views used by the static viewer.\n- Add export-only indexes (e.g., `subject_lower`, `sender_lower`) exactly as specified.\n- Apply export-finalize pragmas (e.g., `journal_mode=DELETE`, `page_size=1024`, and any `synchronous` choice per spec).\n- Run `VACUUM` + `ANALYZE` in the correct order.\n\n## Acceptance Criteria\n- Functional:\n  - Viewer-critical queries work against the finalized DB (unit test executes a representative set of queries and asserts expected row counts).\n  - FTS searches return expected results on a fixture DB.\n- Integrity + portability:\n  - Finalized DB passes `PRAGMA integrity_check`.\n  - Finalized DB opens in `sqlite3` CLI (sanity) and is not tied to WAL side files.\n- Determinism:\n  - Finalization produces stable output for the same input fixture (stable sha256 for resulting DB file).\n- Performance:\n  - Finalization time for a small fixture stays under an explicit budget (tracked in benchmark task `br-2ei.7.3`).\n- Tests:\n  - Unit tests cover: FTS DDL application, index creation, and VACUUM/ANALYZE ordering.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:12:24.355619779Z","created_by":"ubuntu","updated_at":"2026-02-05T08:19:23.533636149Z","closed_at":"2026-02-05T08:19:23.533568121Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.3","depends_on_id":"br-2ei.4","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.3","depends_on_id":"br-2ei.4.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.3","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T05:55:08.066003069Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.4","title":"Share: bundle attachments + rewrite messages.attachments JSON","description":"Implement attachment bundling + `messages.attachments` rewrite for share/export.\n\nThis epic splits the work so multiple agents can implement in parallel without stepping on each other.\n\nChild tasks:\n- `br-2ei.4.4.1`: attachment bundling pipeline (hashing, inline/detach decision, path layout, copying/dedupe).\n- `br-2ei.4.4.2`: rewrite `messages.attachments` JSON in the export DB to bundle references (schema + ordering) and validate references.\n\nNotes:\n- Thresholds/semantics MUST come from the legacy spec in `br-2ei.4.7` (do not guess).\n- Output must be deterministic (stable ordering, stable paths).\n\n## Success Criteria\n1. All child tasks are complete.\n2. Unit tests cover threshold boundaries, stable path layout, duplicate reuse, and stable JSON rewrite ordering.\n3. Share/export E2E (`br-2ei.9.4`) proves:\n   - bundle contains all referenced attachment paths\n   - detached attachments are represented exactly as legacy expects\n   - determinism holds across two exports from identical inputs","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-05T05:12:37.955382434Z","created_by":"ubuntu","updated_at":"2026-02-05T14:05:14.902960589Z","closed_at":"2026-02-05T14:05:14.902899625Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.4","depends_on_id":"br-2ei.2.5","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.4","depends_on_id":"br-2ei.4","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.4","depends_on_id":"br-2ei.4.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.4","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T05:55:08.149056843Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.4.1","title":"Share Attachments: bundling pipeline (hashing + copy/dedupe + inline/detach)","description":"Implement the attachment bundling pipeline for share/export.\n\nWork:\n- Decide representation for each attachment (per spec `br-2ei.4.7`):\n  - inline as `data:` URI when <= threshold\n  - detached marker when >= threshold\n  - otherwise copy into deterministic content-addressed path layout\n- Copy files into the bundle (deterministic naming) and dedupe identical content.\n- Produce a machine-usable bundling index (hash -> bundle path / inline / detached marker) for downstream rewrite step.\n\n## Acceptance Criteria\n- Threshold boundaries match the legacy spec exactly (no hard-coded guessing).\n- Paths are deterministic and content-addressed.\n- Duplicate attachments are not recopied.\n- Missing files are handled per spec (clear error or “missing marker” if legacy tolerates).\n- Unit tests cover:\n  - inline boundary\n  - detach boundary\n  - dedupe behavior\n  - extension inference rules (if any)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:03:30.718092122Z","created_by":"ubuntu","updated_at":"2026-02-05T08:26:49.552943955Z","closed_at":"2026-02-05T08:26:49.552857672Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.4.1","depends_on_id":"br-2ei.4.2","type":"blocks","created_at":"2026-02-05T07:03:38.917255798Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.4.1","depends_on_id":"br-2ei.4.4","type":"parent-child","created_at":"2026-02-05T07:03:30.718092122Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.4.1","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T07:03:39.002849166Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.4.2","title":"Share Attachments: rewrite messages.attachments JSON in export DB","description":"Rewrite `messages.attachments` JSON in the export DB to reference bundled attachment representations.\n\nWork:\n- Parse legacy attachment JSON schema from the export DB rows.\n- Rewrite per attachment to:\n  - bundle-relative path\n  - inline `data:` URI\n  - detached marker/metadata\n- Preserve legacy schema + ordering rules exactly.\n- Validate that rewritten references resolve against the bundle output produced by `br-2ei.4.4.1`.\n\n## Acceptance Criteria\n- JSON rewrite output matches the legacy schema and ordering rules (spec `br-2ei.4.7`).\n- No broken references: every non-detached reference resolves to a file present in the bundle.\n- Invalid/unknown JSON is handled per spec (fail-fast vs best-effort).\n- Unit tests cover:\n  - ordering determinism\n  - mixed inline/file/detached cases\n  - malformed JSON handling\n- Integration test runs against a fixture DB with attachments and asserts expected rewritten JSON + hashes.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:03:52.101600759Z","created_by":"ubuntu","updated_at":"2026-02-05T14:04:44.034479958Z","closed_at":"2026-02-05T14:04:44.034420727Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.4.2","depends_on_id":"br-2ei.4.4","type":"parent-child","created_at":"2026-02-05T07:03:52.101600759Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.4.2","depends_on_id":"br-2ei.4.4.1","type":"blocks","created_at":"2026-02-05T07:03:58.881861480Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.5","title":"Share: chunking + manifest/scaffolding + viewer assets","description":"Finish share/export bundle packaging after export DB + bundled attachments are ready.\n\nThis epic is split to enable parallel implementation:\n- `br-2ei.4.5.1`: chunking engine + chunk config writer (large DB path)\n- `br-2ei.4.5.2`: viewer assets integration + static hosting headers\n- `br-2ei.4.5.3`: manifest + scaffolding (README/_headers) + determinism glue\n\nNotes:\n- Thresholds and manifest schema MUST come from the extracted spec in `br-2ei.4.7`.\n- Determinism is mandatory: stable file ordering + stable manifest ordering.\n\n## Success Criteria\n1. All child tasks are complete.\n2. Bundle directory is self-contained and previewable.\n3. `manifest.json` conforms to the legacy schema and is deterministically serialized.\n4. Chunking works for the threshold boundary cases and is reflected in the manifest.\n5. Share/export E2E (`br-2ei.9.4`) passes and produces stable hashes across two identical runs.","status":"open","priority":2,"issue_type":"epic","created_at":"2026-02-05T05:12:55.110282213Z","created_by":"ubuntu","updated_at":"2026-02-05T07:04:09.327115294Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.5","depends_on_id":"br-2ei.4","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5","depends_on_id":"br-2ei.4.3","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5","depends_on_id":"br-2ei.4.4","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T05:55:08.236817675Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.5.1","title":"Share Bundle: DB chunking engine + chunk config writer","description":"Implement the “large DB” chunking path for share/export.\n\nWork:\n- If DB size exceeds the legacy threshold (spec `br-2ei.4.7`), split DB into `chunks/`.\n- Emit any required chunk config file (e.g., `mailbox.sqlite3.config.json`) with deterministic ordering.\n- Ensure chunk naming and boundaries are deterministic.\n\n## Acceptance Criteria\n- Threshold and output layout match the legacy spec exactly.\n- Below threshold: no chunking outputs emitted (unless legacy does).\n- Above threshold: bundle contains deterministic `chunks/` layout + required config.\n- Unit tests cover threshold boundary cases and deterministic naming.\n- Integration test verifies chunked bundle can still be queried/used by the viewer (basic sanity query).","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T07:04:20.724767495Z","created_by":"ubuntu","updated_at":"2026-02-05T14:08:33.267369554Z","closed_at":"2026-02-05T14:08:33.267305123Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.5.1","depends_on_id":"br-2ei.4.3","type":"blocks","created_at":"2026-02-05T07:04:33.635936135Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5.1","depends_on_id":"br-2ei.4.5","type":"parent-child","created_at":"2026-02-05T07:04:20.724767495Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5.1","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T07:04:33.722371550Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.5.2","title":"Share Bundle: viewer assets integration + static hosting headers","description":"Integrate the static viewer assets into the share/export bundle.\n\nWork:\n- Copy/embed viewer HTML/CSS/JS assets into the bundle with legacy-correct paths.\n- Emit any static-hosting metadata required by legacy (e.g., `_headers`).\n- Ensure assets are deterministic (stable file ordering, stable content).\n\n## Acceptance Criteria\n- Asset set + paths match the legacy spec in `br-2ei.4.7`.\n- Fetching the viewer entry page resolves all referenced assets within the bundle.\n- Headers metadata is emitted exactly as expected (cache-control/content-type rules).\n- Unit/integration tests validate:\n  - required files present\n  - expected content-type mapping or header rules","status":"in_progress","priority":2,"issue_type":"task","created_at":"2026-02-05T07:04:49.375227530Z","created_by":"ubuntu","updated_at":"2026-02-05T14:08:34.008331368Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.5.2","depends_on_id":"br-2ei.4.5","type":"parent-child","created_at":"2026-02-05T07:04:49.375227530Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5.2","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T07:04:54.689274505Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.5.3","title":"Share Bundle: manifest.json + scaffolding (README/_headers) + determinism glue","description":"Write the final bundle scaffold and `manifest.json` for share/export.\n\nWork:\n- Write `manifest.json` per legacy schema (spec `br-2ei.4.7`), including:\n  - export_config\n  - project_scope\n  - scrub preset + version\n  - DB metadata (sizes/hashes; chunks metadata when chunked)\n  - attachment metadata/hashes\n  - viewer/runtime flags\n  - hosting hints (detected targets + signals) when present\n- Ensure deterministic serialization:\n  - stable key ordering\n  - stable array ordering\n- Write bundle README / HOW_TO_DEPLOY with “how to preview/deploy”, including legacy hosting hints:\n  - Cloudflare Pages / Netlify / AWS S3 signals and the corresponding deploy steps\n- Ensure `_headers`/static-hosting metadata and viewer assets are referenced correctly (and are written exactly like legacy when applicable).\n\n## Acceptance Criteria\n- `manifest.json` conforms to the legacy schema and is deterministically serialized.\n- Manifest includes hashes for DB (and chunks when present) and bundled attachments per spec.\n- README/HOW_TO_DEPLOY + headers scaffolding exists and is correct per legacy spec (including hosting hints/signals).\n- Unit tests cover:\n  - manifest determinism (serialize twice -> identical)\n  - chunked vs non-chunked manifest variants\n  - required fields presence\n- E2E `br-2ei.9.4` can validate determinism across two exports from identical inputs.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T07:05:07.782474918Z","created_by":"ubuntu","updated_at":"2026-02-05T07:37:42.552192062Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.5.3","depends_on_id":"br-2ei.4.3","type":"blocks","created_at":"2026-02-05T07:05:16.810266743Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5.3","depends_on_id":"br-2ei.4.4.2","type":"blocks","created_at":"2026-02-05T07:05:16.895398721Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5.3","depends_on_id":"br-2ei.4.5","type":"parent-child","created_at":"2026-02-05T07:05:07.782474918Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5.3","depends_on_id":"br-2ei.4.5.1","type":"blocks","created_at":"2026-02-05T07:05:16.980221638Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5.3","depends_on_id":"br-2ei.4.5.2","type":"blocks","created_at":"2026-02-05T07:05:17.064353973Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5.3","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T07:05:17.145302228Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.6","title":"Share: optional signing (Ed25519) + encryption (age) + zip packaging","description":"Implement optional bundle hardening features (signing, encryption, zip packaging).\n\nThis task extends the plain directory bundle from `br-2ei.4.5`.\n\nWork (in `crates/mcp-agent-mail-share/`):\n- Signing (Ed25519):\n  - Generate signing key if requested (or load provided key).\n  - Write public key into bundle.\n  - Sign `manifest.json` and include signature + metadata (algorithm, key id) per spec.\n  - Provide verify flow (`--verify` or library fn) that validates signature before use.\n- Encryption (age):\n  - Encrypt the bundle for one or more recipients.\n  - Emit `.age` output plus any required metadata.\n  - Provide decrypt flow for tests.\n- Zip packaging:\n  - Package bundle into zip (or tar) with stable ordering + timestamps as required for determinism.\n\n## Acceptance Criteria\n- Roundtrip works:\n  - Signing verify succeeds for a signed bundle.\n  - Verification fails with a clear error for a tampered manifest.\n  - Encryption decrypt yields byte-identical bundle output (or stable content hash if metadata differs) in test mode.\n- Determinism:\n  - Packaging output is deterministic given identical inputs (stable hash for the archive file).\n  - File ordering inside archive is stable.\n- UX:\n  - CLI flags and errors are explicit (what failed, what to do).\n  - Feature is optional and does not change default share behavior when disabled.\n- Tests:\n  - Unit tests cover sign/verify and encrypt/decrypt flows using deterministic test keys.\n  - E2E `br-2ei.9.4` covers at least one signed bundle and one encrypted bundle path (can be separate runs).","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-05T05:13:06.191406916Z","created_by":"ubuntu","updated_at":"2026-02-05T06:28:38.177966257Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.6","depends_on_id":"br-2ei.4","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.6","depends_on_id":"br-2ei.4.5","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.6","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T05:55:08.321718960Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.7","title":"Share spec: extract scrub rules + SQL/DDL + manifest schema + vectors","description":"Extract the exact legacy share/export behavior into a self-contained spec + test vectors.\n\nThis is *spec extraction*, not implementation. The result must be detailed enough that implementers can complete `br-2ei.4.1`..`br-2ei.4.6` without re-reading Python.\n\nMust extract verbatim (copy exact SQL/DDL, constants, and ordering rules) from legacy Python:\n- SQLite snapshot procedure:\n  - WAL checkpoint details\n  - backup API usage (incl. flags / sequencing)\n  - any timeouts / retries / busy handling\n- Project scoping:\n  - tables affected\n  - exact WHERE clauses / join conditions\n  - any “include/exclude” semantics\n- Scrub presets (standard/strict/archive):\n  - exact transformations per table/column\n  - deletion vs redaction rules\n  - normalization rules (timestamps, ids, null handling, ordering)\n- FTS + views/materialization DDL\n- Export-finalize pragmas + maintenance ordering:\n  - journal_mode/page_size/synchronous\n  - VACUUM/ANALYZE ordering\n  - any integrity checks\n- Attachment bundling rules:\n  - how files are copied\n  - rewrite semantics for `messages.attachments` JSON\n- Chunking thresholds + output naming rules\n- Static hosting + deploy scaffolding:\n  - hosting-hints detection signals (Cloudflare Pages / Netlify / AWS S3) and how they’re presented\n  - `_headers` / other hosting metadata files (exact contents + when written)\n  - README/HOW_TO_DEPLOY guidance text and any env-signal heuristics\n- `manifest.json` schema:\n  - required fields\n  - stable ordering requirements (key order, array order)\n  - versioning / compatibility expectations (even if “none”)\n\nDeliverables:\n- Add/extend a dedicated “Share/Export Spec” section in `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md` with the above as an explicit checklist.\n- Add conformance fixtures for share/export (DB + expected outputs) under `crates/mcp-agent-mail-conformance/tests/conformance/fixtures/share/`.\n  - Include *expected hashes* (sha256) for each preset run.\n\n## Acceptance Criteria\n- The spec includes verbatim SQL/DDL and lists every table/column scrub rule for each preset.\n- Spec includes the exact hosting-hints detection signals and scaffolding file contents.\n- Fixtures cover at least:\n  - minimal DB (smallest useful)\n  - DB with attachments\n  - DB requiring scrub/redaction\n- For each preset, the fixture includes deterministic expected outputs (hashes + any required normalized JSON/manifest snapshots).\n- A brief “How to regenerate fixtures from legacy Python” note is included (command + expected output paths).\n- Implementers can complete `br-2ei.4.*` using only the spec + fixtures (no Python code consultation).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:54:17.642425426Z","created_by":"ubuntu","updated_at":"2026-02-05T07:54:58.212246444Z","closed_at":"2026-02-05T07:54:58.212223401Z","close_reason":"Added missing share/export fixture DDL files (expected_fts_ddl.sql, expected_views_ddl.sql); spec already present in EXISTING_MCP_AGENT_MAIL_STRUCTURE.md","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.7","depends_on_id":"br-2ei.4","type":"parent-child","created_at":"2026-02-05T05:54:17.642425426Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.8","title":"Share Tests: unit + integration + determinism + failure modes","description":"Add comprehensive unit + integration tests for the share/export pipeline (beyond E2E), with high-signal diffs and artifact logging.\n\nScope:\n- Unit tests for each pipeline stage: snapshot/scoping, scrub rules, FTS/index build, attachment rewrite, chunking, manifest/scaffolding, signing/encryption (optional).\n- Integration tests that run the full export pipeline against a small seeded DB + attachment set.\n- Determinism tests: identical inputs => identical output bundle hashes (manifest + DB + attachment layout).\n- Failure-mode tests: corrupt attachment, missing project, read-only output dir, invalid scrub preset.\n\nLogging/artifacts standard:\n- Each test emits a structured diff on mismatch (expected vs actual paths, JSON keys, hashes).\n- Store artifacts under tests/artifacts/share/<timestamp>/ for integration tests.\n\nDependencies:\n- These tests should depend on the relevant share implementation tasks (br-2ei.4.1–4.6, br-2ei.4.4.*, br-2ei.4.5.*) and spec extraction (br-2ei.4.7).\n\n## Success Criteria\n1. All child tasks (br-2ei.4.8.1–4.8.4) are complete and passing in CI.\n2. Unit, integration, determinism, and failure-mode tests run deterministically and without external services.\n3. Artifact logging standards are met (structured diffs + artifact trees under `tests/artifacts/share/<timestamp>/`).\n4. Determinism tests prove identical outputs for identical inputs (hash-based or byte-for-byte where specified).\n5. Failure-mode tests prove clean error handling with no confusing partial bundles.","status":"open","priority":1,"issue_type":"epic","created_at":"2026-02-05T07:48:34.503442481Z","created_by":"ubuntu","updated_at":"2026-02-05T08:45:36.080530937Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.8","depends_on_id":"br-2ei.4","type":"parent-child","created_at":"2026-02-05T07:48:34.503442481Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.8.1","title":"Share Tests: unit coverage for pipeline stages","description":"Unit tests for share pipeline stages (stage-level parity, deterministic outputs).\n\nCoverage:\n- Snapshot + scoping: correct WAL checkpoint + backup semantics; only requested project rows remain.\n- Scrub presets: standard/strict/archive rules match spec; verify SQL deletes + JSON redactions.\n- FTS/index build: expected tables/views and indexes created; query results stable.\n- Attachment rewrite: data-URI for <=64KiB, detach >=25MiB, copy/dedupe for middle range.\n- Messages.attachments JSON rewrite matches legacy schema and ordering.\n\nLogging/artifacts:\n- For each stage, emit a structured diff (expected vs actual SQL objects, JSON keys, attachment paths).\n- Snapshot tests should log the canonical manifest rows + attachment rewrite mapping.\n\nDependencies:\n- br-2ei.4.1, br-2ei.4.2, br-2ei.4.3, br-2ei.4.4.1, br-2ei.4.4.2, br-2ei.4.7\n\n## Acceptance Criteria\n1. Each pipeline stage has dedicated unit tests with deterministic fixtures and asserts parity with the extracted spec.\n2. Snapshot/scoping tests validate WAL checkpoint + backup semantics and that non-target project rows are removed.\n3. Scrub preset tests validate SQL deletes + JSON redactions and produce structured diffs on mismatch.\n4. Attachment rewrite tests cover size thresholds and schema ordering for messages.attachments.\n5. Logging includes structured diffs and manifest/attachment mappings to aid debugging.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T07:48:54.682178929Z","created_by":"ubuntu","updated_at":"2026-02-05T08:45:29.528493361Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.8.1","depends_on_id":"br-2ei.4.1","type":"blocks","created_at":"2026-02-05T07:49:04.852299738Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.1","depends_on_id":"br-2ei.4.2","type":"blocks","created_at":"2026-02-05T07:49:04.945429675Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.1","depends_on_id":"br-2ei.4.3","type":"blocks","created_at":"2026-02-05T07:49:05.038929328Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.1","depends_on_id":"br-2ei.4.4.1","type":"blocks","created_at":"2026-02-05T07:49:05.134356218Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.1","depends_on_id":"br-2ei.4.4.2","type":"blocks","created_at":"2026-02-05T07:49:05.228917179Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.1","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T07:49:05.322494558Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.1","depends_on_id":"br-2ei.4.8","type":"parent-child","created_at":"2026-02-05T07:48:54.682178929Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.8.2","title":"Share Tests: integration pipeline + bundle verification","description":"Integration tests for full share/export pipeline (seeded DB + attachments -> bundle tree).\n\nCoverage:\n- Full pipeline run with a small seeded project DB and attachments.\n- Validate manifest.json content, DB snapshot integrity (PRAGMA integrity_check), attachment layout, and rewritten messages.attachments JSON.\n- Verify chunking behavior at size thresholds and manifest references.\n- If signing/encryption enabled, validate signature/age output with deterministic fixtures (where possible).\n\nLogging/artifacts:\n- Store bundle tree under tests/artifacts/share/full/<timestamp>/.\n- Emit diff summaries for manifest/attachments/DB schema on mismatch.\n- Capture and log size breakdowns (DB, attachments, manifest).\n\nDependencies:\n- br-2ei.4.1, br-2ei.4.2, br-2ei.4.3, br-2ei.4.4.*, br-2ei.4.5.*, br-2ei.4.6, br-2ei.4.7\n\n## Acceptance Criteria\n1. Integration test runs the full share pipeline in a temp workspace and produces a bundle tree under `tests/artifacts/share/full/<timestamp>/`.\n2. `manifest.json`, DB integrity, and attachment layout are validated against expected fixtures (including messages.attachments rewrite).\n3. Chunking threshold behavior is exercised and verified in the manifest.\n4. If signing/encryption is enabled, verify signature and decrypt in test mode with deterministic keys/fixtures.\n5. Failures print clear diffs for manifest/attachments/DB schema and include size breakdown logs.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T07:49:14.509596907Z","created_by":"ubuntu","updated_at":"2026-02-05T08:45:21.135934955Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.1","type":"blocks","created_at":"2026-02-05T07:49:21.201560088Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.2","type":"blocks","created_at":"2026-02-05T07:49:21.294378799Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.3","type":"blocks","created_at":"2026-02-05T07:49:21.385449961Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.4.1","type":"blocks","created_at":"2026-02-05T07:49:21.477730629Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.4.2","type":"blocks","created_at":"2026-02-05T07:49:21.569989206Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.5.1","type":"blocks","created_at":"2026-02-05T07:49:21.660690982Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.5.2","type":"blocks","created_at":"2026-02-05T07:49:21.749106445Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.5.3","type":"blocks","created_at":"2026-02-05T07:49:21.840338169Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.6","type":"blocks","created_at":"2026-02-05T07:49:21.931913820Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T07:49:22.032750784Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.8","type":"parent-child","created_at":"2026-02-05T07:49:14.509596907Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.8.3","title":"Share Tests: determinism + reproducibility","description":"Determinism + reproducibility tests for share/export output.\n\nCoverage:\n- Run share pipeline twice with identical inputs -> identical:\n  - manifest.json (byte-for-byte)\n  - DB snapshot hashes\n  - attachment file paths + hashes\n  - bundle directory tree ordering\n- Verify stable ordering in manifest (projects, attachments, chunks).\n- Verify stable hash function inputs (no timestamp/hostname nondeterminism).\n\nLogging/artifacts:\n- Emit per-file hash lists and diff on mismatch.\n- Store hash inventories under tests/artifacts/share/determinism/<timestamp>/.\n\nDependencies:\n- br-2ei.4.5.* (manifest + chunking), br-2ei.4.4.*, br-2ei.4.7\n\n## Acceptance Criteria\n1. Two identical runs produce byte-for-byte identical `manifest.json` and identical hash inventories for DB + attachments.\n2. Manifest ordering (projects/attachments/chunks) is stable and asserted.\n3. Tests enforce that timestamps/hostnames do not leak into hash inputs.\n4. On mismatch, per-file hash diffs are printed and inventories are stored under `tests/artifacts/share/determinism/<timestamp>/`.\n5. Tests are deterministic across machines (normalize temp paths where necessary).","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T07:49:31.525185255Z","created_by":"ubuntu","updated_at":"2026-02-05T08:45:14.873946213Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.8.3","depends_on_id":"br-2ei.4.4.1","type":"blocks","created_at":"2026-02-05T07:49:36.101704160Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.3","depends_on_id":"br-2ei.4.4.2","type":"blocks","created_at":"2026-02-05T07:49:36.191870458Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.3","depends_on_id":"br-2ei.4.5.1","type":"blocks","created_at":"2026-02-05T07:49:36.296206809Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.3","depends_on_id":"br-2ei.4.5.2","type":"blocks","created_at":"2026-02-05T07:49:36.386410167Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.3","depends_on_id":"br-2ei.4.5.3","type":"blocks","created_at":"2026-02-05T07:49:36.473247380Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.3","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T07:49:36.558886727Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.3","depends_on_id":"br-2ei.4.8","type":"parent-child","created_at":"2026-02-05T07:49:31.525185255Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.8.4","title":"Share Tests: failure modes + recovery","description":"Failure-mode and recovery tests for share/export pipeline.\n\nCoverage:\n- Missing project -> clear error + exit code, no partial bundle output.\n- Invalid scrub preset -> error with list of valid presets.\n- Corrupt/missing attachment -> error or skip per legacy spec (document exact behavior), with logged path.\n- Read-only output dir -> error and no partial artifacts.\n- Partial bundle cleanup on failure (best-effort) to avoid confusing users.\n\nLogging/artifacts:\n- Capture stderr/stdout and include exact error strings + remediation hints.\n- Store partial output tree (if any) for debugging under tests/artifacts/share/failures/<timestamp>/.\n\nDependencies:\n- br-2ei.4.1, br-2ei.4.2, br-2ei.4.4.*, br-2ei.4.7\n\n## Acceptance Criteria\n1. Each failure mode is covered by a dedicated test case with expected exit code and error message assertions.\n2. Tests verify no partial bundle artifacts are left behind (or that cleanup happens per spec).\n3. Corrupt/missing attachments follow legacy behavior exactly (error vs skip) and log the affected path.\n4. Artifacts (stdout/stderr + partial trees) are stored under `tests/artifacts/share/failures/<timestamp>/`.\n5. Tests are deterministic and do not rely on external services.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T07:49:46.368523653Z","created_by":"ubuntu","updated_at":"2026-02-05T08:45:08.872004169Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.8.4","depends_on_id":"br-2ei.4.1","type":"blocks","created_at":"2026-02-05T07:49:50.476879883Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.4","depends_on_id":"br-2ei.4.2","type":"blocks","created_at":"2026-02-05T07:49:50.568506731Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.4","depends_on_id":"br-2ei.4.4.1","type":"blocks","created_at":"2026-02-05T07:49:50.680999494Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.4","depends_on_id":"br-2ei.4.4.2","type":"blocks","created_at":"2026-02-05T07:49:50.786244505Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.4","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T07:49:50.883581511Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.4","depends_on_id":"br-2ei.4.8","type":"parent-child","created_at":"2026-02-05T07:49:46.368523653Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5","title":"CLI Parity: implement Typer-equivalent commands + frankentui output","description":"Complete the Rust CLI (crates/mcp-agent-mail-cli) to match legacy Python Typer commands.\n\nScope:\n- Serve commands: serve-http, serve-stdio.\n- share subcommands (delegates to mcp-agent-mail-share).\n- guard subcommands (delegates to mcp-agent-mail-guard).\n- doctor commands (diagnostics + repair scaffolding).\n- projects/products/mail helper commands.\n- acks/file_reservations views.\n\nOutput constraints:\n- Use frankentui for all console rendering (tables, colors, progress).\n- Keep JSON modes stable for automation.\n\n## Success Criteria\n1. Command surface matches legacy (names, flags, defaults, exit codes) unless an intentional improvement is documented.\n2. CLI has a parity spec artifact (br-2ei.5.6) that tests consume (no silent drift).\n3. E2E CLI suite (br-2ei.9.5) passes: help/exit codes/JSON mode stability + no rendering panics.","status":"open","priority":1,"issue_type":"epic","created_at":"2026-02-05T05:06:50.526774224Z","created_by":"ubuntu","updated_at":"2026-02-05T06:10:57.989224627Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.1","title":"CLI: serve-http/serve-stdio parity (flags, defaults, exit codes)","description":"Ensure `am serve-http` and `am serve-stdio` behave like legacy CLI.\n\nRequirements:\n- Flags: --host/--port/--path override env defaults.\n- serve-http starts HTTP listener with configured base path.\n- serve-stdio runs fastmcp stdio transport.\n- Exit codes: non-zero on bind failures.\n\nAcceptance:\n- Manual smoke tests with curl and stdio.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:11:18.491790676Z","created_by":"ubuntu","updated_at":"2026-02-05T05:38:36.353215725Z","closed_at":"2026-02-05T05:38:36.353198122Z","close_reason":"Added serve-http config override helper and tests","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.1","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.2","title":"CLI: implement guard subcommands (install/uninstall/status/check)","description":"Wire `am guard ...` commands to mcp-agent-mail-guard.\n\nCommands:\n- am guard install [--repo PATH] [--prepush]\n- am guard uninstall [--repo PATH]\n- am guard status [--repo PATH]\n- am guard check [--repo PATH] [--advisory] (used by hook plugin)\n\nMust match legacy defaults and env vars.\n\n## Acceptance Criteria\n1. CLI surface (commands/flags/defaults/exit codes) matches the CLI parity inventory (br-2ei.5.6).\n2. Commands delegate to mcp-agent-mail-guard and preserve idempotency semantics.\n3. Unit tests cover argument parsing + error cases (non-repo paths, missing repo).\n4. E2E guard suite (br-2ei.9.3) uses these commands successfully.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:11:24.884001192Z","created_by":"ubuntu","updated_at":"2026-02-05T06:31:56.949414368Z","closed_at":"2026-02-05T06:31:56.949353513Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.2","depends_on_id":"br-2ei.3.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.2","depends_on_id":"br-2ei.3.3","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.2","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.2","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T05:55:17.665850195Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.3","title":"CLI: implement share subcommands (export/update/preview/verify/decrypt/wizard)","description":"Wire `am share ...` commands to mcp-agent-mail-share with full legacy parity.\n\nCommands (legacy):\n- export / update / preview / verify / decrypt / wizard (interactive)\n\nMust match legacy Typer surface:\n- flags + defaults\n- interactive wizard flow for share export\n- hosting hints detection output (Cloudflare Pages / Netlify / AWS S3 signals)\n- stable/deterministic outputs when inputs are identical\n\nImplementation notes:\n- CLI should delegate core work to `mcp-agent-mail-share` and render human output via frankentui.\n- Machine mode (`--json`) must produce schema-stable output.\n\n## Acceptance Criteria\n1. CLI surface (commands/flags/defaults/exit codes) matches the CLI parity inventory (br-2ei.5.6).\n2. share commands delegate to `mcp-agent-mail-share` and produce deterministic outputs when inputs are identical.\n3. Hosting hints detection output is present and matches legacy semantics/signals (from spec `br-2ei.4.7`).\n4. Unit tests cover argument parsing and obvious error paths (missing DB, invalid scrub preset, invalid output dir, missing recipients).\n5. E2E share suite (br-2ei.9.4) uses these commands successfully.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:11:39.240636392Z","created_by":"ubuntu","updated_at":"2026-02-05T07:37:51.039302276Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.3","depends_on_id":"br-2ei.4","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.3","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.3","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T05:55:17.761658357Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.4","title":"CLI: implement doctor commands (check/repair/backups/restore)","description":"Port legacy doctor commands for diagnostics and repair workflows.\n\nScope:\n- check: environment, DB connectivity, archive repo health, locks.\n- repair: safe non-destructive repairs (unlock stale locks, recreate dirs, etc).\n- backups/restore: archive/db snapshot helpers.\n\nConstraints:\n- Must not run destructive git/fs commands; prefer safe copies and explicit confirmations.\n\n## Acceptance Criteria\n1. Doctor commands produce actionable, user-friendly diagnostics (what failed, why, how to fix).\n2. Repair actions are safe and explicitly scoped (no hidden destructive operations).\n3. Unit tests cover at least: missing DB path, locked DB, missing archive dirs, stale lock detection.\n4. E2E CLI suite (br-2ei.9.5) covers at least one doctor check and validates exit code + output contains required markers.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T05:11:51.799905939Z","created_by":"ubuntu","updated_at":"2026-02-05T06:16:22.297208490Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.4","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.4","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T05:55:17.847248690Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.5","title":"CLI UX: frankentui rendering for tables/progress + JSON output modes","description":"Replace placeholder println output with frankentui-based rendering for all CLI commands.\n\nRequirements:\n- Human mode: colorful tables, aligned columns, progress for long ops.\n- Machine mode: stable JSON schemas for automation.\n- TTY detection: disable colors when not a TTY.\n\n## Acceptance Criteria\n1. All CLI commands render via frankentui in human mode (no ad-hoc println formatting).\n2. Non-TTY output disables color and remains readable.\n3. JSON mode outputs are schema-stable and parseable.\n4. E2E CLI suite (br-2ei.9.5) runs with/without TTY and does not panic.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T05:11:59.633674324Z","created_by":"ubuntu","updated_at":"2026-02-05T06:16:38.831223467Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.5","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.5","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T05:55:17.922891984Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.6","title":"CLI parity spec: inventory legacy Typer commands/flags + golden help","description":"Extract and lock down the legacy Python Typer CLI surface so the Rust CLI cannot silently drift.\n\nDeliverables:\n- Command inventory: every command + subcommand, with flags, env var mappings, defaults, and exit codes.\n- Help output capture strategy:\n  - Either golden snapshots of `am --help` and key subcommands, OR a structured JSON inventory checked by unit tests.\n- Document any intentional improvements/deltas explicitly (and add tests for new behavior).\n\nSources:\n- legacy_python_mcp_agent_mail_code/* Typer app\n- Existing docs: EXISTING_MCP_AGENT_MAIL_STRUCTURE.md + README parity sections\n\nTests:\n- Unit test that asserts the Rust CLI exposes the full command inventory (names + flags).\n- E2E harness (br-2ei.9.5) consumes this inventory for verification.\n\n## Acceptance Criteria\n1. A deterministic CLI inventory artifact exists (golden help snapshots and/or structured inventory).\n2. Unit tests assert the Rust CLI matches the inventory (commands + flags + defaults).\n3. Any intentional deltas are explicitly listed and tested (no accidental drift).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:54:05.866507590Z","created_by":"ubuntu","updated_at":"2026-02-05T08:05:09.490318553Z","closed_at":"2026-02-05T08:05:09.490297684Z","close_reason":"Added structured CLI inventory artifact (legacy_cli_inventory.json) and updated CLI command table reference","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.6","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T05:54:05.866507590Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.7","title":"CLI Tests: unit + integration + golden help + JSON stability","description":"Add comprehensive CLI tests beyond E2E, including golden help snapshots and JSON output stability.\n\nScope:\n- Unit tests for clap/arg parsing defaults (flags, env overrides, exit codes).\n- Integration tests that run the CLI binary in temp dirs and assert outputs.\n- Golden help output snapshots for top-level and key subcommands.\n- JSON output stability tests (machine-readable outputs unchanged across runs).\n\nLogging/artifacts:\n- Each test emits expected vs actual diffs on failure.\n- Integration tests store stdout/stderr artifacts under tests/artifacts/cli/<timestamp>/.\n\nDependencies:\n- br-2ei.5.1–5.5 and br-2ei.5.6 (spec) should exist before tests lock behavior.\n\n## Success Criteria\n1. All child tasks (br-2ei.5.7.1–5.7.4) are complete and passing in CI.\n2. CLI test suite runs deterministically on a clean machine and does not require network access.\n3. Golden help and JSON fixtures are stored under `tests/fixtures/` and validated in CI.\n4. Failures produce high-signal diffs and artifacts under `tests/artifacts/cli/<timestamp>/`.\n5. Coverage includes both TTY and non-TTY output paths without changing behavior.","status":"open","priority":1,"issue_type":"epic","created_at":"2026-02-05T07:50:04.178085704Z","created_by":"ubuntu","updated_at":"2026-02-05T08:45:02.802596062Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.7","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T07:50:04.178085704Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.7.1","title":"CLI Tests: unit parsing + defaults","description":"Unit tests for CLI parsing and defaults.\n\nCoverage:\n- clap arg parsing for serve, share, guard, doctor, mail/acks/reservations commands.\n- default values (ports, paths, output format) match legacy spec (br-2ei.5.6).\n- env var overrides (where legacy supported).\n- exit code semantics for invalid args.\n\nLogging:\n- When failures occur, print full parsed-args diff and environment snapshot.\n\nDependencies:\n- br-2ei.5.1, br-2ei.5.2, br-2ei.5.3, br-2ei.5.4, br-2ei.5.5, br-2ei.5.6\n\n## Acceptance Criteria\n1. Unit tests cover parsing for all major subcommands and validate defaults against the legacy spec.\n2. Env var overrides are tested with explicit fixtures for supported variables.\n3. Invalid arg combinations return the expected exit code and error message.\n4. Failures print a parsed-args diff and environment snapshot to aid debugging.\n5. Tests are deterministic and do not require network or external binaries.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T07:50:15.690264115Z","created_by":"ubuntu","updated_at":"2026-02-05T08:44:57.064056325Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.1","type":"blocks","created_at":"2026-02-05T07:50:20.373617293Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.2","type":"blocks","created_at":"2026-02-05T07:50:20.468649871Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.3","type":"blocks","created_at":"2026-02-05T07:50:20.559362277Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.4","type":"blocks","created_at":"2026-02-05T07:50:20.648289664Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.5","type":"blocks","created_at":"2026-02-05T07:50:20.739664527Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T07:50:20.830895600Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.7","type":"parent-child","created_at":"2026-02-05T07:50:15.690264115Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.7.2","title":"CLI Tests: integration runs + exit codes","description":"Integration tests that run the CLI binary end-to-end in temp dirs.\n\nCoverage:\n- serve-stdio and serve-http startup/shutdown (dry-run where possible).\n- guard install/status/uninstall in a temp git repo.\n- share export/update/verify with seeded project data.\n- doctor check/repair stubs (no destructive actions).\n\nLogging/artifacts:\n- Store stdout/stderr for each command under tests/artifacts/cli/integration/<timestamp>/.\n- Print expected vs actual exit codes and key output lines.\n\nDependencies:\n- br-2ei.5.1–5.5, br-2ei.5.6\n\n## Acceptance Criteria\n1. Integration tests execute the CLI binary in isolated temp dirs and clean up all processes they start.\n2. Commands listed in coverage are exercised and assert expected exit codes plus required output markers.\n3. All stdout/stderr is captured and written under `tests/artifacts/cli/integration/<timestamp>/` with per-case headers.\n4. Tests do not use destructive git/fs commands; guard install/uninstall uses a temp repo only.\n5. Failures print clear diagnostics (command line, exit code, key output lines).","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T07:50:30.939428162Z","created_by":"ubuntu","updated_at":"2026-02-05T08:44:51.947436011Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.1","type":"blocks","created_at":"2026-02-05T07:50:37.625955500Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.2","type":"blocks","created_at":"2026-02-05T07:50:37.721192313Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.3","type":"blocks","created_at":"2026-02-05T07:50:37.815858081Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.4","type":"blocks","created_at":"2026-02-05T07:50:37.911140008Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.5","type":"blocks","created_at":"2026-02-05T07:50:38.010689399Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T07:50:38.102457903Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.7","type":"parent-child","created_at":"2026-02-05T07:50:30.939428162Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.7.3","title":"CLI Tests: golden help snapshots","description":"Golden help output snapshots for CLI parity.\n\nCoverage:\n- Top-level help output.\n- Key subcommands: serve, share, guard, doctor, tools/resources helpers.\n- Ensure help text, flag ordering, defaults, and examples match legacy spec (br-2ei.5.6).\n\nLogging/artifacts:\n- Store golden outputs under tests/fixtures/cli_help/.\n- On mismatch, print unified diffs and save actual outputs under tests/artifacts/cli/help/<timestamp>/.\n\nDependencies:\n- br-2ei.5.1–5.6\n\n## Acceptance Criteria\n1. Golden help snapshots exist for top-level and listed subcommands and are checked in under `tests/fixtures/cli_help/`.\n2. Tests compare help output exactly (including flag ordering and defaults), with normalization limited to documented nondeterminism.\n3. Non-TTY execution produces colorless output and is part of the snapshot set.\n4. On mismatch, a unified diff is printed and actual outputs are stored under `tests/artifacts/cli/help/<timestamp>/`.\n5. Tests are deterministic and run in CI without needing network or external tools.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T07:50:47.384522408Z","created_by":"ubuntu","updated_at":"2026-02-05T08:44:46.749669076Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.1","type":"blocks","created_at":"2026-02-05T07:50:52.154619572Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.2","type":"blocks","created_at":"2026-02-05T07:50:52.245573523Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.3","type":"blocks","created_at":"2026-02-05T07:50:52.336195479Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.4","type":"blocks","created_at":"2026-02-05T07:50:52.426020015Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.5","type":"blocks","created_at":"2026-02-05T07:50:52.515717862Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T07:50:52.601998356Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.7","type":"parent-child","created_at":"2026-02-05T07:50:47.384522408Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.7.4","title":"CLI Tests: JSON output stability","description":"JSON output stability tests for CLI commands that expose machine-readable data.\n\nCoverage:\n- Ensure JSON output schemas match legacy (field names, nesting, nullability).\n- Verify stable ordering where legacy is stable (or document normalization).\n- Commands: guard status/check, share verify/preview, doctor check, tool/resource listings.\n\nLogging/artifacts:\n- Store expected JSON fixtures under tests/fixtures/cli_json/.\n- On mismatch, emit JSON diff and save actual outputs under tests/artifacts/cli/json/<timestamp>/.\n\nDependencies:\n- br-2ei.5.1–5.6\n\n## Acceptance Criteria\n1. Tests run under `cargo test -p mcp-agent-mail-cli` (or workspace equivalent) and cover all listed JSON-producing commands.\n2. JSON schemas match legacy fixtures (field names/types/nullability); any normalization rules are documented in the fixtures.\n3. Ordering is stable where required (or normalized before comparison) and asserted in tests.\n4. On mismatch, tests print a JSON diff and store actual outputs under `tests/artifacts/cli/json/<timestamp>/`.\n5. Tests are deterministic and pass on a clean temp env (no reliance on machine-specific paths).","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T07:51:01.253361843Z","created_by":"ubuntu","updated_at":"2026-02-05T08:44:41.304781136Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.1","type":"blocks","created_at":"2026-02-05T07:51:06.732190931Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.2","type":"blocks","created_at":"2026-02-05T07:51:06.825343050Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.3","type":"blocks","created_at":"2026-02-05T07:51:06.919542630Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.4","type":"blocks","created_at":"2026-02-05T07:51:07.010359283Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.5","type":"blocks","created_at":"2026-02-05T07:51:07.101986571Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T07:51:07.193432639Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.7","type":"parent-child","created_at":"2026-02-05T07:51:01.253361843Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.6","title":"Integration: enforce local-crate usage (asupersync/sqlmodel/fastmcp/frankentui) + agent detection","description":"Ensure the port fully leverages the local /dp crates and avoids redundant upstream deps.\n\nScope:\n- Audit for tokio usage; replace with asupersync where feasible.\n- Ensure SQLite access flows through sqlmodel_rust (no rusqlite, no raw sqlite3 shellouts).\n- Ensure server uses fastmcp_rust transports.\n- Ensure all CLI UI uses frankentui.\n- Integrate /dp/coding_agent_session_search for detecting installed coding agents (or port its logic to a tokio-free module if needed).\n- Track and land any required upstream changes in /dp crates (e.g., asupersync peer_addr).\n\n## Success Criteria\n1. `cargo tree` shows no unintended tokio runtime deps in core crates.\n2. SQLite access in this repo goes through sqlmodel_rust (no rusqlite).\n3. CLI rendering is frankentui-only and degrades correctly when not a TTY.\n4. Agent detection works on the dev machine without requiring tokio.\n5. Upstream dependency tasks (e.g., br-2ei.6.3) are resolved and consumed by this repo.\n6. Guardrail tests fail CI if forbidden deps are pulled into default features (with clear, logged diffs).\n7. Integration tests validate agent detection output deterministically and capture detailed logs/artifacts.","status":"open","priority":2,"issue_type":"epic","created_at":"2026-02-05T05:06:57.327442629Z","created_by":"ubuntu","updated_at":"2026-02-05T08:49:34.978049569Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.6","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.6.1","title":"Audit: eliminate tokio and upstream duplicates (use asupersync/sqlmodel)","description":"Audit the workspace for accidental dependencies/usage and enforce the “local crates first” rule.\n\nChecklist:\n- Remove tokio runtime usage where possible; prefer `asupersync` for async/concurrency.\n- Ensure SQLite access goes through `sqlmodel_rust` (no direct `rusqlite` usage).\n- Ensure networking / IO uses `asupersync` and MCP surfaces use `fastmcp_rust`.\n\n## Acceptance Criteria\n- Dependency hygiene:\n  - `cargo tree` (workspace) shows no unintended tokio runtime dependencies (unless explicitly justified and isolated behind a non-default feature).\n  - No direct `rusqlite` usage in workspace crates.\n  - No duplicate “HTTP client / redis / io runtime” crates when equivalents exist in `/dp/asupersync`.\n- Guardrail:\n  - Add an automated check (CI step or test) that fails if forbidden crates (`tokio`, `rusqlite`, `reqwest` if not via asupersync, etc.) are pulled into default features.\n- Documentation:\n  - `README.md` or `PROPOSED_ARCHITECTURE.md` documents the sanctioned crates and the enforcement mechanism.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T05:13:17.777775741Z","created_by":"ubuntu","updated_at":"2026-02-05T06:28:58.436614251Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.6.1","depends_on_id":"br-2ei.6","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.6.2","title":"Integrate coding_agent_session_search for installed-agent detection (tokio-free surface)","description":"Port/integrate installed-agent detection so Agent Mail can identify installed/running coding agents.\n\nSource reference:\n- `/dp/coding_agent_session_search`\n\nWork:\n- Determine minimal API needed for Agent Mail UX (examples):\n  - list detected agent CLIs (claude-code/codex/gemini/etc)\n  - detect running sessions (tmux, processes, sockets) where possible\n  - return a structured report used by CLI `am doctor` and/or MCP resource\n- Ensure this integration is tokio-free for the default build:\n  - Prefer direct reuse of upstream code if it already uses `asupersync`.\n  - Otherwise, either:\n    - isolate tokio behind a non-default feature, OR\n    - re-port the needed logic to `asupersync` (preferred).\n- Expose results in a stable JSON shape for conformance + automation.\n\n## Acceptance Criteria\n- Core server remains tokio-free (no tokio runtime in default features; enforced by `br-2ei.6.1` guardrail).\n- `am doctor` (or equivalent) prints a clear human report and can emit JSON (`--json`) containing:\n  - detected agents\n  - version/path info (where available)\n  - running session hints (where available)\n- Tests:\n  - Unit tests cover PATH scanning + edge cases (missing binaries, permission denied, weird filenames).\n  - Integration test runs `am doctor --json` in a hermetic env (temp PATH with fake shims) and asserts deterministic output.\n- Docs:\n  - Document what is detected and what is “best effort” vs guaranteed.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T05:13:25.051447400Z","created_by":"ubuntu","updated_at":"2026-02-05T06:29:07.790072645Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.6.2","depends_on_id":"br-2ei.6","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.6.3","title":"Upstream dependency: asupersync Http1Request.peer_addr","description":"This repo needs accurate client peer address (SocketAddr) on each HTTP request to match legacy Python behavior for:\n- localhost bypass (allow_localhost_unauthenticated)\n- bearer token injection for base-path passthrough\n- rate limit identity derivation (host when JWT sub missing)\n\nUpstream work lives in /dp/asupersync.\n\nRequired API surface (asupersync):\n1. Expose the remote peer address on Http1Request (or equivalent request context):\n   - Prefer: `Http1Request.peer_addr: Option<SocketAddr>` (or accessor)\n   - Must be present even when no forwarded headers are set\n2. Ensure forwarded headers do NOT overwrite peer_addr (legacy uses actual client host for localhost checks).\n3. Maintain tokio-free surface (asupersync conventions).\n\nDownstream work (this repo):\n- Update mcp-agent-mail-server to read peer_addr and derive client_host string, including IPv4-mapped IPv6 handling.\n- Wire into localhost detection helper + rate limit identity.\n\nExternal references:\n- asupersync beads created by another agent: bd-32eba (and children) (prefix may be corrected later).\n\n## Acceptance Criteria\n1. /dp/asupersync exposes peer_addr in the HTTP request type used by mcp-agent-mail-server.\n2. This repo can compile against the updated asupersync without tokio.\n3. br-1bm.3.1 can be implemented using this API with no hacks.","status":"closed","priority":0,"issue_type":"task","assignee":"ubuntu","created_at":"2026-02-05T06:08:02.941793644Z","created_by":"ubuntu","updated_at":"2026-02-05T08:31:31.290546761Z","closed_at":"2026-02-05T08:31:31.290526042Z","close_reason":"Added Http1Request.peer_addr and wired through Http1Server/Listener (asupersync)","external_ref":"/dp/asupersync:bd-32eba","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.6.3","depends_on_id":"br-2ei.6","type":"parent-child","created_at":"2026-02-05T06:08:02.941793644Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.7","title":"Benchmarks: tool latency + archive throughput + share/export budgets","description":"Expand Criterion benches to cover realistic hot paths.\n\nExisting:\n- crates/mcp-agent-mail/benches/benchmarks.rs seeds DB using conformance fixtures and measures representative tool calls.\n\nAdd:\n- Archive write throughput benchmarks (message write + commit batching + attachments).\n- Guard check performance on large path lists.\n- Share/export pipeline benchmarks (snapshot + scrub + bundle) with size/throughput budgets.\n\nMethod:\n- Follow extreme-software-optimization loop: baseline (hyperfine), profile (cargo flamegraph), prove behavior unchanged via golden outputs.\n\n## Success Criteria\n1. Bench suite runs deterministically (seeded fixtures, stable inputs).\n2. Budgets are documented (p50/p95) and regressions are detectable.\n3. Hot paths are profiled before optimization; changes include behavior proof artifacts.","status":"open","priority":2,"issue_type":"epic","created_at":"2026-02-05T05:07:03.312826328Z","created_by":"ubuntu","updated_at":"2026-02-05T06:11:43.821652085Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.7","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.7.1","title":"Bench: establish baseline budgets + golden outputs for hot tool paths","description":"Capture baseline performance numbers and lock them in (profile-first per extreme optimization workflow).\n\nWork:\n- Baseline runs:\n  - Use `hyperfine --warmup 3 --runs 10` for representative commands.\n  - Record p50/p95/p99, throughput, and allocations where possible.\n- Profiling:\n  - Capture flamegraphs for top 3 hot paths (tool handler, archive write, share export).\n  - Identify hotspot functions and record in the budget doc.\n- Golden outputs:\n  - Capture golden outputs for stable surfaces (JSON, help text, share manifest ordering, archive artifacts).\n  - Record sha256 checksums to prove behavior unchanged in later optimizations.\n- Opportunity matrix:\n  - For each hotspot, score Impact×Confidence/Effort; only pursue Score ≥ 2.0.\n- Isomorphism proof template:\n  - Document ordering/tie-breaking/RNG/float invariants for each optimization.\n\n## Acceptance Criteria\n- Budget doc exists (e.g., benches/BUDGETS.md or docs/perf-budgets.md) with:\n  - target p50/p95/p99 for most-called tools\n  - max allocations for archive writes and share/export\n  - documented baseline commands + hardware notes\n  - flamegraph links/paths\n- Golden outputs are validated via `sha256sum -c` (or equivalent) in CI.\n- Optimization workflow (“profile → change → prove”) is documented and enforced.\n- Bench harness emits machine-readable JSON summaries and stores detailed logs/artifacts per run.\n- A bench smoke step (CI or `scripts/e2e_test.sh` optional path) validates budgets + golden outputs without network access.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T05:13:31.777132727Z","created_by":"ubuntu","updated_at":"2026-02-05T08:49:29.347189363Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.7.1","depends_on_id":"br-2ei.7","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.7.2","title":"Bench: archive write throughput (message + attachments + commit batching)","description":"Add benchmarks for archive write throughput (messages + attachments + commit batching) following the extreme-optimization workflow.\n\nWork:\n- Seed realistic message payloads:\n  - reuse conformance fixtures where possible\n  - include attachment mix (small inline, medium copied, large detached marker)\n- Measure end-to-end:\n  - write canonical message\n  - write per-recipient inbox copies + sender outbox\n  - write attachment artifacts\n  - git commit batching behavior\n- Capture:\n  - throughput (msgs/sec)\n  - p95/p99 latency per send_message\n  - disk bytes written per message (approx)\n- Use hyperfine for CLI-level measurement and Criterion for internal bench.\n- Capture flamegraph for archive hot path; record top 5 functions.\n- Preserve golden outputs for the benchmark fixture to assert behavior unchanged.\n\n## Acceptance Criteria\n- Criterion bench exists (or equivalent) and runs in CI (at least smoke).\n- Bench emits metrics and a machine-readable JSON summary for regression tracking.\n- Determinism: fixed RNG seed, fixed fixture data.\n- Perf budgets link to br-2ei.7.1 doc with pass/fail thresholds.\n- Flamegraph evidence captured (no optimization yet).\n- Isomorphism proof template applied if any change is made during benchmarking.\n\nDependencies:\n- br-2ei.2.2, br-2ei.2.5, br-2ei.7.1, br-2ei.7","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T05:13:37.368254570Z","created_by":"ubuntu","updated_at":"2026-02-05T07:51:41.553509172Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.7.2","depends_on_id":"br-2ei.2.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.7.2","depends_on_id":"br-2ei.2.5","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.7.2","depends_on_id":"br-2ei.7","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.7.2","depends_on_id":"br-2ei.7.1","type":"blocks","created_at":"2026-02-05T06:58:02.715728602Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.7.3","title":"Bench: share/export pipeline (snapshot+scrub+bundle) budgets","description":"Add benchmarks for the share/export pipeline (snapshot + scrub + bundle) using the extreme-optimization workflow.\n\nWork:\n- Measure end-to-end share/export for representative DB sizes:\n  - tiny fixture (fast path)\n  - medium fixture (includes attachments)\n  - optional large synthetic fixture (chunking path)\n- Track:\n  - runtime p50/p95/p99\n  - output bundle size\n  - chunking overhead vs non-chunked\n- Use hyperfine for CLI-level measurement and Criterion for internal pipeline timing.\n- Capture flamegraph and hotspot list before any optimization.\n- Assert bundle determinism via stable hashes (manifest + DB + attachments).\n\nLogging/artifacts:\n- Store benchmark outputs, flamegraphs, and JSON summaries under tests/artifacts/bench/share/<timestamp>/.\n- On budget regression, emit a structured diff of expected vs actual p50/p95/p99 and output sizes.\n\n## Acceptance Criteria\n- Bench harness exists and runs locally with a single command.\n- Deterministic fixtures/generators and machine-readable summary JSON.\n- Output bundle determinism enforced with hash checks.\n- Budgets recorded in br-2ei.7.1 doc; pass/fail thresholds enforced.\n- Hotspot evidence recorded (top 5 functions by time).\n- Isomorphism proof template used if any optimization is proposed.\n- Bench artifacts (logs/JSON/flamegraphs) are captured in `tests/artifacts/bench/share/<timestamp>/`.\n\nDependencies:\n- br-2ei.7.1, br-2ei.4.5, br-2ei.7","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-05T05:13:51.914580151Z","created_by":"ubuntu","updated_at":"2026-02-05T08:53:33.589013393Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.7.3","depends_on_id":"br-2ei.4.5","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.7.3","depends_on_id":"br-2ei.7","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.7.3","depends_on_id":"br-2ei.7.1","type":"blocks","created_at":"2026-02-05T06:58:02.797620961Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.8","title":"Docs: add Rust-port README + dev workflow (fmt/clippy/test/conformance/bench)","description":"Add a top-level README.md for this Rust port.\n\nMust include:\n- What the project is (Rust port of mcp_agent_mail)\n- How to run MCP server: stdio and HTTP\n- How to run conformance tests\n- How to regenerate fixtures (legacy venv python command)\n- How to run benches\n- Notes on per-agent CARGO_TARGET_DIR to avoid multi-agent target lock contention\n\nAcceptance:\n- README is accurate and matches current code + scripts.\n","status":"closed","priority":3,"issue_type":"task","created_at":"2026-02-05T05:07:09.183372429Z","created_by":"ubuntu","updated_at":"2026-02-05T05:38:39.476350794Z","closed_at":"2026-02-05T05:38:39.476334223Z","close_reason":"Added top-level README with run/test/conformance/bench instructions","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.8","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9","title":"E2E Test Suite: harness + scripts + artifacts","description":"Add a first-class end-to-end (E2E) harness for MCP Agent Mail Rust, focused on user-visible correctness and diagnosability.\n\nGoals:\n- Exercise the system the way real agents/users do: CLI -> server -> DB -> git archive -> share export -> guard hooks -> notifications -> LLM llm_mode.\n- Produce extremely detailed logs and artifacts so failures are obvious (expected vs actual, file diffs/hashes, HTTP transcripts).\n- Keep runs deterministic and CI-friendly.\n\nStandards:\n- Scripts live under scripts/ (bash, cross-platform aware where feasible).\n- Artifacts live under tests/artifacts/<suite>/<timestamp>/.\n- Every script must:\n  - Print a clear case header per check\n  - Log expected vs actual\n  - Exit non-zero on first mismatch\n  - Support AM_E2E_KEEP_TMP=1 to retain temp dirs\n  - Respect per-agent CARGO_TARGET_DIR to avoid multi-agent contention\n- No destructive git/fs commands; only operate on temp dirs.\n\n## Success Criteria\n1. scripts/e2e_test.sh can run all suites and a single suite by name.\n2. Each suite produces rich artifacts and exits non-zero on mismatch.\n3. E2E covers: archive, guard, share/export, CLI stability, HTTP parity, toon-format output, notifications signals, and LLM llm_mode stub.\n4. E2E is deterministic enough for CI (stable vectors, recorded ports, clear logs).\n\nDependencies:\n- br-2ei (parent-child)","status":"open","priority":1,"issue_type":"epic","created_at":"2026-02-05T05:52:30.044860332Z","created_by":"ubuntu","updated_at":"2026-02-05T08:16:37.387500963Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:52:30.044860332Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9.1","title":"E2E: harness scaffolding (runner + log helpers + artifacts)","description":"Create the shared E2E harness used by all other E2E scripts.\n\nDeliverables:\n- scripts/e2e_test.sh: top-level runner (can run all suites or a named suite).\n- scripts/e2e_lib.sh: helpers for:\n  - mktemp workspace + cleanup (AM_E2E_KEEP_TMP=1)\n  - artifact dir selection (tests/artifacts/<suite>/<timestamp>/)\n  - logging (case banners, expected vs actual)\n  - stable hashing + file tree dumps\n  - retry helpers for flaky ports/binds\n\nRequirements:\n- Detailed logging by default; include env dump (redacting secrets).\n- All scripts must be safe (no destructive git/fs commands).\n- The runner must set CARGO_TARGET_DIR if not already set (recommended per-agent directory).\n\n## Acceptance Criteria\n1. scripts/e2e_test.sh exists and can run at least one suite.\n2. scripts/e2e_lib.sh provides logging + artifact helpers used by all suites.\n3. All suites write artifacts under tests/artifacts/<suite>/<timestamp>/.\n4. All suites exit non-zero on mismatch and print expected vs actual.\n5. AM_E2E_KEEP_TMP=1 retains temp dirs.\n6. Runner respects/sets CARGO_TARGET_DIR (no multi-agent target contention).\n7. Harness uses only temp dirs and does not run destructive git/fs commands.","acceptance_criteria":"1. scripts/e2e_test.sh exists and can run at least one suite\n2. scripts/e2e_lib.sh provides logging + artifact helpers\n3. All scripts write artifacts under tests/artifacts/<suite>/<timestamp>/\n4. All scripts exit non-zero on mismatch and print expected vs actual\n5. AM_E2E_KEEP_TMP=1 retains temp dirs\n6. Runner respects/sets CARGO_TARGET_DIR (no multi-agent target contention)\n7. No destructive git/fs commands used (temp dirs only)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:52:47.452322784Z","created_by":"ubuntu","updated_at":"2026-02-05T06:20:14.780147870Z","closed_at":"2026-02-05T06:20:14.780077948Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9.1","depends_on_id":"br-2ei.9","type":"parent-child","created_at":"2026-02-05T05:52:47.452322784Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9.2","title":"E2E: archive write/read side effects (messages + reservations + attachments)","description":"End-to-end verification of git archive side effects (messages + reservations + attachments) *and* notification signals.\n\nScript:\n- scripts/e2e_archive.sh (invoked by scripts/e2e_test.sh)\n\nFlow (high-signal, deterministic):\n1. Use a temp storage_root + temp DB path.\n2. Launch server/router (stdio or in-process harness) and execute:\n   - ensure_project\n   - register_agent(s)\n   - send_message (with 0, 1, and multiple recipients)\n   - file_reservation_paths (exclusive + shared)\n   - renew/release reservation\n   - send_message with a small inline attachment and a file-backed attachment\n3. Verify git archive:\n   - expected directories exist\n   - canonical messages path format and frontmatter JSON parse\n   - inbox/outbox copies exist and match canonical\n   - file_reservations artifacts exist (sha1(pattern).json + id-<id>.json)\n   - attachments manifests exist; content hashes match references\n   - git log contains expected commit summaries\n4. Notifications (signals) parity:\n   - enable notifications (NOTIFICATIONS_ENABLED + NOTIFICATIONS_SIGNALS_DIR in temp)\n   - after send_message, assert signal files exist for `to` + `cc` recipients only (NOT bcc)\n   - after fetch_inbox, assert the signal file for that agent is cleared\n\nLogging/artifacts:\n- Dump file tree + sizes, and sha256 hashes for large artifacts.\n- On failure, print unified diffs for markdown/frontmatter mismatches.\n- For notifications, capture signal JSON payloads (expected vs actual) on mismatch.\n- Write all outputs to tests/artifacts/archive/<timestamp>/.\n\nNotes:\n- Avoid external deps; use git CLI only for inspecting commits.\n- Never use destructive git/fs commands.\n\n## Acceptance Criteria\n1. scripts/e2e_archive.sh runs via scripts/e2e_test.sh archive.\n2. Script produces tests/artifacts/archive/<timestamp>/ with:\n   - archive file tree + sizes\n   - sha256 hashes for large artifacts\n   - per-case expected vs actual logs\n3. Script exits non-zero on first mismatch and prints a clear failing case header.\n4. Archive invariants are asserted: canonical/inbox/outbox match, reservation artifacts present, attachment manifests/hashes match.\n5. Notifications invariants are asserted when enabled: signals emitted for to+cc only and cleared on fetch_inbox.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-05T05:53:07.432876569Z","created_by":"ubuntu","updated_at":"2026-02-05T14:07:31.002006411Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9.2","depends_on_id":"br-2ei.12.2","type":"blocks","created_at":"2026-02-05T07:34:52.461587201Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.2","depends_on_id":"br-2ei.2.2","type":"blocks","created_at":"2026-02-05T05:53:07.432876569Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.2","depends_on_id":"br-2ei.2.3","type":"blocks","created_at":"2026-02-05T05:53:07.432876569Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.2","depends_on_id":"br-2ei.2.4","type":"blocks","created_at":"2026-02-05T05:53:07.432876569Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.2","depends_on_id":"br-2ei.2.5","type":"blocks","created_at":"2026-02-05T05:53:07.432876569Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.2","depends_on_id":"br-2ei.9","type":"parent-child","created_at":"2026-02-05T05:53:07.432876569Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.2","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T14:07:31.001964142Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9.3","title":"E2E: guard enforcement in temp git repo (pre-commit + renames)","description":"End-to-end verification of the guard system in a real temp git repo.\n\nScript:\n- scripts/e2e_guard.sh\n\nFlow:\n1. Create a temp git repo with a tracked file.\n2. Install the agent-mail guard (via CLI `am guard install` or MCP tool).\n3. Create an exclusive file reservation held by another agent for the file (or a matching pattern).\n4. Modify + stage the file, attempt `git commit`:\n   - Expected: blocked (non-zero), stderr contains clear conflict info.\n5. Release the reservation and retry commit:\n   - Expected: allowed.\n6. Rename scenario:\n   - Create reservation matching old/new path; stage rename; ensure guard checks both sides.\n\nLogging/artifacts:\n- Capture hook output, git status/diff summaries, and reservation records.\n- Store under tests/artifacts/guard/<timestamp>/.\n\nSafety:\n- Operate only within temp dirs.\n- Never run destructive git/fs commands.\n\n## Acceptance Criteria\n1. scripts/e2e_guard.sh runs via scripts/e2e_test.sh guard.\n2. Script demonstrates a blocked commit when an exclusive reservation conflicts, including clear stderr output.\n3. Script demonstrates an allowed commit after reservation release.\n4. Rename case asserts both old and new paths are checked.\n5. Artifacts under tests/artifacts/guard/<timestamp>/ include hook output + git summaries + reservation JSON.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:53:18.903635568Z","created_by":"ubuntu","updated_at":"2026-02-05T14:07:27.982040430Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9.3","depends_on_id":"br-2ei.3.1","type":"blocks","created_at":"2026-02-05T14:07:27.894140772Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.3","depends_on_id":"br-2ei.3.2","type":"blocks","created_at":"2026-02-05T14:07:27.982001326Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.3","depends_on_id":"br-2ei.3.3","type":"blocks","created_at":"2026-02-05T05:53:18.903635568Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.3","depends_on_id":"br-2ei.5.2","type":"blocks","created_at":"2026-02-05T05:53:18.903635568Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.3","depends_on_id":"br-2ei.9","type":"parent-child","created_at":"2026-02-05T05:53:18.903635568Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.3","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T14:07:27.803790200Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9.4","title":"E2E: share/export bundle (manifest + DB + attachments + determinism)","description":"End-to-end verification of share/export bundle creation.\n\nScript:\n- scripts/e2e_share.sh\n\nFlow:\n1. Seed a realistic mailbox DB + attachments (via conformance seeding or direct tool calls).\n2. Run `am share export` (or equivalent) to produce a bundle directory.\n3. Verify bundle correctness:\n   - manifest.json exists and validates expected fields\n   - export DB exists, passes PRAGMA integrity_check\n   - FTS/views exist and basic queries succeed\n   - attachments directory contains all referenced paths\n   - chunking behavior triggers appropriately when DB size threshold exceeded (can simulate with padding)\n4. Determinism check:\n   - Run export twice from same inputs; compare stable hashes of key outputs (manifest + DB + attachment manifests).\n5. Signing/encryption (when enabled):\n   - Run signed export and verify signature.\n   - Run encrypted export and verify decrypt roundtrip.\n\nLogging/artifacts:\n- Dump bundle tree + sizes, log PRAGMA results, and hashes.\n- Store under tests/artifacts/share/<timestamp>/.\n\nExit criteria:\n- Any mismatch -> non-zero.\n\n## Acceptance Criteria\n1. scripts/e2e_share.sh runs via scripts/e2e_test.sh share.\n2. Script produces tests/artifacts/share/<timestamp>/ including bundle tree, PRAGMA results, and hashes.\n3. Script asserts manifest/db/attachments consistency and fails on missing referenced paths.\n4. Script asserts deterministic output across two runs from identical inputs (documented hash set).\n5. When signing/encryption are enabled, E2E validates signature and decrypt roundtrip using deterministic fixtures.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:53:34.886696183Z","created_by":"ubuntu","updated_at":"2026-02-05T14:06:54.361956903Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.4.1","type":"blocks","created_at":"2026-02-05T14:06:53.918099605Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.4.2","type":"blocks","created_at":"2026-02-05T14:06:54.006077170Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.4.3","type":"blocks","created_at":"2026-02-05T14:06:54.092389831Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.4.4.1","type":"blocks","created_at":"2026-02-05T14:06:54.182943385Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.4.4.2","type":"blocks","created_at":"2026-02-05T14:06:54.271276309Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.4.5","type":"blocks","created_at":"2026-02-05T05:53:34.886696183Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.4.6","type":"blocks","created_at":"2026-02-05T08:50:00.556279549Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T14:06:54.361917468Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.5.3","type":"blocks","created_at":"2026-02-05T05:53:34.886696183Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.9","type":"parent-child","created_at":"2026-02-05T05:53:34.886696183Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T14:06:53.826537062Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9.5","title":"E2E: CLI stability (help text, exit codes, JSON mode)","description":"End-to-end verification that the CLI is stable for humans and automation.\n\nScript:\n- scripts/e2e_cli.sh\n\nChecks:\n- `am --help` and key subcommand `--help` outputs are stable (golden snapshots) OR at minimum contain required commands/flags.\n- Exit codes match expectations for common failure modes (bad args, missing config, bind failure).\n- Machine JSON mode:\n  - `--json` produces schema-stable output for commands that support it.\n- Human mode:\n  - frankentui tables render without panic when TTY and degrade gracefully when not.\n\nLogging/artifacts:\n- Save captured help/output snapshots under tests/artifacts/cli/<timestamp>/.\n\nExit criteria:\n- Any mismatch -> non-zero.\n\n## Acceptance Criteria\n1. scripts/e2e_cli.sh runs via scripts/e2e_test.sh cli.\n2. Script captures help outputs and/or validates against the CLI parity inventory (br-2ei.5.6).\n3. Script validates exit codes for representative failure modes.\n4. Script validates JSON output mode is parseable and schema-stable for covered commands.\n5. Artifacts saved under tests/artifacts/cli/<timestamp>/.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T05:53:45.764307877Z","created_by":"ubuntu","updated_at":"2026-02-05T14:07:11.132491800Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.1","type":"blocks","created_at":"2026-02-05T14:07:11.048069628Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.2","type":"blocks","created_at":"2026-02-05T05:53:45.764307877Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.3","type":"blocks","created_at":"2026-02-05T05:53:45.764307877Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.4","type":"blocks","created_at":"2026-02-05T05:53:45.764307877Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.5","type":"blocks","created_at":"2026-02-05T05:53:45.764307877Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T14:07:11.132445303Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.9","type":"parent-child","created_at":"2026-02-05T05:53:45.764307877Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T14:07:10.958601487Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9.6","title":"E2E: HTTP server parity suite (auth/rate-limit/streamable/mail/CORS/logging)","description":"Add a single HTTP-focused E2E script that exercises the *user-visible* HTTP server surface end-to-end, using the shared harness (br-2ei.9.1).\n\nScript:\n- scripts/e2e_http.sh\n\nCoverage (must be parity-oriented, not \"best-effort\"):\n1. Health + well-known endpoints: /health/* and /.well-known/* payloads + status codes.\n2. Bearer auth:\n   - Authorization required when configured\n   - OPTIONS + /health bypass\n   - constant-time compare (behavioral checks)\n3. JWT auth:\n   - HS256 and JWKS modes (use deterministic test vectors)\n   - aud/iss validation\n   - role claim parsing\n   - failure semantics always 401 {\"detail\":\"Unauthorized\"}\n4. Rate limiting:\n   - Redis backend allow/deny sequences\n   - Redis failure -> memory fallback\n   - identity derivation (sub vs host)\n5. Peer addr + localhost bypass:\n   - localhost allowed only when NO forwarded headers\n   - IPv4/IPv6/IPv4-mapped IPv6 cases\n6. Streamable HTTP MCP:\n   - Accept/Content-Type normalization\n   - base path /api and /api/ semantics\n   - passthrough behavior\n   - localhost Authorization injection when configured\n7. /mail SSR UI:\n   - fetch key pages and assert DOM markers\n   - sanitize XSS payloads\n8. CORS:\n   - OPTIONS preflight headers\n   - default allow-* semantics\n9. Request logging + OTEL:\n   - logs emitted only when enabled\n   - OTEL misconfig doesn't crash\n10. Tool filtering profiles (context reduction):\n   - With filtering disabled: tool list matches full baseline.\n   - With filtering enabled (minimal + one custom include/exclude case):\n     - `tools/list` is filtered\n     - `resource://tooling/directory` reflects filtered tools/clusters\n11. Instrumentation (query tracking):\n   - With instrumentation enabled, at least one DB-backed tool call emits a `tool_query_stats` log entry.\n12. ACK TTL background worker (+ optional escalation):\n   - With ACK_TTL enabled (ttl=0), create an ack_required message and assert logs contain `ack_overdue`.\n   - With escalation mode file_reservation, assert a reservation is created (resource read or DB query) without crashing.\n\nArtifacts/logging:\n- tests/artifacts/http/<timestamp>/\n- For each case: record request (curl args), response status, headers, body, and expected-vs-actual.\n- When applicable, include server stdout/stderr logs and config env snapshot (redacting secrets).\n\n## Acceptance Criteria\n1. scripts/e2e_http.sh exists and can be run via scripts/e2e_test.sh http.\n2. Script exits non-zero on first mismatch and prints expected vs actual.\n3. Artifacts include per-case HTTP transcripts + server logs.\n4. Script is deterministic (no random ports without recording, stable vectors).\n5. Tool filtering checks cover at least: disabled baseline + minimal profile + one custom include/exclude case.\n6. Instrumentation check asserts presence of `tool_query_stats` in captured server logs.\n7. ACK TTL check asserts presence of `ack_overdue` (and file_reservation escalation when enabled).","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T06:08:22.826465268Z","created_by":"ubuntu","updated_at":"2026-02-05T07:34:16.695627610Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.1.5","type":"blocks","created_at":"2026-02-05T06:08:39.251281411Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.10.6","type":"blocks","created_at":"2026-02-05T07:34:16.695583357Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.2.5","type":"blocks","created_at":"2026-02-05T06:08:39.333666265Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.3.4","type":"blocks","created_at":"2026-02-05T06:08:39.420350399Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.4.6","type":"blocks","created_at":"2026-02-05T06:08:39.503300748Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.5.5","type":"blocks","created_at":"2026-02-05T06:08:39.587091700Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.6.4","type":"blocks","created_at":"2026-02-05T06:08:39.675539136Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.7","type":"blocks","created_at":"2026-02-05T06:08:39.758756769Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.8","type":"blocks","created_at":"2026-02-05T06:08:39.841729059Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.9","type":"blocks","created_at":"2026-02-05T06:08:39.924846663Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-2ei.10.3","type":"blocks","created_at":"2026-02-05T06:57:36.927404078Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-2ei.11.3","type":"blocks","created_at":"2026-02-05T06:57:37.009782894Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-2ei.9","type":"parent-child","created_at":"2026-02-05T06:08:22.826465268Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:39.169446083Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9.7","title":"E2E: LLM llm_mode smoke (stubbed)","description":"E2E: LLM llm_mode smoke (stubbed, offline).\n\nScope:\n- Start server with LLM enabled and stubbed completion client.\n- Exercise `summarize_thread` with llm_mode=true and `macro_prepare_thread` llm_mode path.\n- Validate refined summary fields and error fallback when stub returns invalid JSON.\n\nLogging/artifacts:\n- Capture HTTP transcripts + tool payloads.\n- Store artifacts under tests/artifacts/llm/<timestamp>/.\n- Emit expected vs actual JSON diffs on mismatch.\n\nDependencies:\n- br-2ei.9.1 (E2E harness)\n- br-2ei.13.2 (LLM impl)\n- br-2ei.13.3 (LLM tests/spec)\n\n## Acceptance Criteria\n1. E2E test uses a deterministic stubbed LLM client and runs via `scripts/e2e_test.sh` (llm path).\n2. `summarize_thread` with llm_mode=true returns refined fields that match expected JSON fixtures.\n3. `macro_prepare_thread` with llm_mode=true exercises the LLM path and returns refined summaries.\n4. Invalid JSON from the stub triggers the legacy fallback behavior (non-LLM summary + logged error) and is asserted.\n5. Artifacts (requests/responses + diffs) are written to `tests/artifacts/llm/<timestamp>/`.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T08:15:12.039153780Z","created_by":"ubuntu","updated_at":"2026-02-05T08:44:35.501652521Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9.7","depends_on_id":"br-2ei.13.2","type":"blocks","created_at":"2026-02-05T08:15:20.655784860Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.7","depends_on_id":"br-2ei.13.3","type":"blocks","created_at":"2026-02-05T08:15:25.092127090Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.7","depends_on_id":"br-2ei.9","type":"parent-child","created_at":"2026-02-05T08:15:12.039153780Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.7","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T08:15:17.568158415Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9.8","title":"E2E: Notifications signal files","description":"E2E: Notifications (signal files) parity.\n\nScope:\n- Start server with notifications enabled.\n- send_message to multiple recipients (to/cc/bcc) and assert signal files for to+cc only.\n- fetch_inbox clears signal for that agent; verify pending list updates.\n- debounce behavior: repeated sends within window do not spam signals (per legacy spec).\n\nLogging/artifacts:\n- Capture filesystem snapshots of signals dir before/after.\n- Store artifacts under tests/artifacts/notifications/<timestamp>/.\n- Emit expected vs actual file lists + JSON diffs on mismatch.\n\nDependencies:\n- br-2ei.9.1 (E2E harness)\n- br-2ei.12.2 (Notifications impl)\n- br-2ei.12.3 (Notifications tests/spec)\n\n## Acceptance Criteria\n1. E2E test runs via `scripts/e2e_test.sh` notifications path and uses temp dirs (no destructive commands).\n2. After send_message, signals are emitted for `to` + `cc` recipients only; `bcc` produces none.\n3. fetch_inbox clears the signal for that agent and the pending list is updated accordingly.\n4. Debounce behavior is verified: repeated sends within the debounce window do not create duplicate signal entries (assert via file list + timestamps or sequence numbers).\n5. Failures emit clear diffs and artifacts are written to `tests/artifacts/notifications/<timestamp>/`.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T08:15:49.568178405Z","created_by":"ubuntu","updated_at":"2026-02-05T08:44:27.750662371Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9.8","depends_on_id":"br-2ei.12.2","type":"blocks","created_at":"2026-02-05T08:16:04.913015385Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.8","depends_on_id":"br-2ei.12.3","type":"blocks","created_at":"2026-02-05T08:16:08.094559926Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.8","depends_on_id":"br-2ei.9","type":"parent-child","created_at":"2026-02-05T08:15:49.568178405Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.8","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T08:15:59.389033120Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-3ie","title":"MCP Agent Mail Rust: 100% feature parity + conformance + benchmarks","description":"Goal: complete the Rust port of legacy_python_mcp_agent_mail_code with 100% behavior/feature coverage, proven by fixture-based conformance tests + benchmarks (similar standard as rich_rust/beads_rust).\n\nNon-negotiables:\n- Prefer local crates over upstream ecosystem where applicable:\n  - MCP: /dp/fastmcp_rust\n  - SQLite: /dp/sqlmodel_rust\n  - IO/concurrency: /dp/asupersync (avoid tokio unless unavoidable)\n  - Console UI: /dp/frankentui\n  - Beads: /dp/beads_rust\n  - Agent detection: /dp/coding_agent_session_search\n- No destructive commands or file deletions without explicit permission.\n\nAcceptance criteria:\n-  passes\n-  passes\n- \nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 2 tests\ntest load_and_validate_fixture_schema ... ok\ntest run_fixtures_against_rust_server_router ... ok\n\ntest result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.08s\n\n\nrunning 7 tests\ntest config::tests::test_default_config ... ok\ntest error::tests::test_error_types ... ok\ntest config::tests::test_from_env ... ok\ntest error::tests::test_recoverable ... ok\ntest models::tests::test_invalid_agent_names ... ok\ntest models::tests::test_generate_agent_name ... ok\ntest models::tests::test_valid_agent_names ... ok\n\ntest result: ok. 7 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 8 tests\ntest pool::tests::test_sqlite_path_parsing ... ok\ntest timestamps::tests::test_iso_to_micros ... ok\ntest timestamps::tests::test_epoch_boundary ... ok\ntest timestamps::tests::test_negative_timestamps ... ok\ntest timestamps::tests::test_now_micros ... ok\ntest timestamps::tests::test_round_trip ... ok\ntest timestamps::tests::test_micros_to_iso ... ok\ntest pool::tests::test_schema_init_in_memory ... ok\n\ntest result: ok. 8 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 1 test\ntest crates/mcp-agent-mail-core/src/models.rs - models::is_valid_agent_name (line 318) ... ok\n\ntest result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\nall doctests ran in 0.18s; merged doctests compilation took 0.17s\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s passes\n- Conformance harness covers *all* MCP tools and resources, including error cases + nondeterministic field normalization.\n- Benchmarks include DB/tool hot paths + archive write throughput once storage layer is implemented.\n","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-02-05T05:04:26.956492167Z","created_by":"ubuntu","updated_at":"2026-02-05T05:05:57.078349046Z","closed_at":"2026-02-05T05:05:57.078301787Z","close_reason":"Superseded by br-2ei (correct prefix + clean description)","external_ref":"bd-179","source_repo":".","compaction_level":0,"original_size":0}
