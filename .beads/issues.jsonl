{"id":"bd-179","title":"MCP Agent Mail Rust: 100% feature parity + conformance + benchmarks","description":"Goal: complete the Rust port of legacy_python_mcp_agent_mail_code with 100% behavior/feature coverage, proven by fixture-based conformance tests + benchmarks (similar standard as rich_rust/beads_rust).\n\nNon-negotiables:\n- Prefer local crates over upstream ecosystem where applicable:\n  - MCP: /dp/fastmcp_rust\n  - SQLite: /dp/sqlmodel_rust\n  - IO/concurrency: /dp/asupersync (avoid tokio unless unavoidable)\n  - Console UI: /dp/frankentui\n  - Beads: /dp/beads_rust\n  - Agent detection: /dp/coding_agent_session_search\n- No destructive commands or file deletions without explicit permission.\n\nAcceptance criteria:\n-  passes\n-  passes\n- \nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 2 tests\ntest load_and_validate_fixture_schema ... ok\ntest run_fixtures_against_rust_server_router ... ok\n\ntest result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.08s\n\n\nrunning 7 tests\ntest config::tests::test_default_config ... ok\ntest error::tests::test_error_types ... ok\ntest config::tests::test_from_env ... ok\ntest error::tests::test_recoverable ... ok\ntest models::tests::test_invalid_agent_names ... ok\ntest models::tests::test_generate_agent_name ... ok\ntest models::tests::test_valid_agent_names ... ok\n\ntest result: ok. 7 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 8 tests\ntest pool::tests::test_sqlite_path_parsing ... ok\ntest timestamps::tests::test_iso_to_micros ... ok\ntest timestamps::tests::test_epoch_boundary ... ok\ntest timestamps::tests::test_negative_timestamps ... ok\ntest timestamps::tests::test_now_micros ... ok\ntest timestamps::tests::test_round_trip ... ok\ntest timestamps::tests::test_micros_to_iso ... ok\ntest pool::tests::test_schema_init_in_memory ... ok\n\ntest result: ok. 8 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 1 test\ntest crates/mcp-agent-mail-core/src/models.rs - models::is_valid_agent_name (line 318) ... ok\n\ntest result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\nall doctests ran in 0.18s; merged doctests compilation took 0.17s\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s passes\n- Conformance harness covers *all* MCP tools and resources, including error cases + nondeterministic field normalization.\n- Benchmarks include DB/tool hot paths + archive write throughput once storage layer is implemented.\n","status":"tombstone","priority":0,"issue_type":"epic","created_at":"2026-02-05T05:04:26.956492167Z","created_by":"ubuntu","updated_at":"2026-02-05T05:38:40.435532507Z","closed_at":"2026-02-05T05:05:57.078301787Z","close_reason":"Superseded by br-2ei (correct prefix + clean description)","source_repo":".","deleted_at":"2026-02-05T05:38:40.435526636Z","deleted_by":"ubuntu","delete_reason":"bad prefix legacy epic; superseded by br-2ei","original_type":"epic","compaction_level":0,"original_size":0}
{"id":"br-10wc","title":"[epic] AgentMailTUI: full frankentui-native interactive operations console","description":"## Background\nThe current rich console output still feels like decorated logs, not a true operations cockpit. We need a **real full-screen AgentMailTUI** inspired by `/dp/frankentui` demo showcase patterns (dashboard, timeline, search, command palette, deterministic UX + testability).\n\n## Hard Product Contract (User-Mandated)\n1. Typing `am` must launch **both**:\n   - MCP Agent Mail server, and\n   - the full interactive AgentMailTUI\n   in one default flow.\n2. This must work with either MCP or API base paths (e.g. `/mcp/` or `/api/`).\n3. Rich TUI experience is enabled by default; non-TUI fallback remains explicit and intentional.\n4. Console layout must be interactively configurable (placement/ratio/height etc.) and persisted automatically in Agent Mail config.\n\n## Vision\nDeliver a showcase-grade, operator-first TUI where the main surface is live activity (requests/messages/tool calls), plus instantly accessible search, timeline inspection, health/status signals, and high-leverage controls.\n\n## UX Outcomes\n- Fast comprehension: operators instantly see system state + high-signal events.\n- Fast navigation: search + palette + keyboard shortcuts for every major action.\n- Fast diagnosis: inspect event context, errors, and suggested remediation in-place.\n- Fast customization: live layout tuning that auto-persists and restores on startup.\n\n## Architecture Direction\n- Reuse frankentui patterns/components from `ftui-demo-showcase` (dashboard, log/virtualized search, action timeline, command palette, layout inspector).\n- Add a typed AgentMail event stream feeding all panes consistently.\n- Keep render/update loops deterministic and testable (unit + PTY + golden snapshots + e2e logging).\n- Use bounded buffers and virtualized lists for sustained throughput.\n\n## Quality Bar\n- Comprehensive unit tests for reducers/parsers/layout/state.\n- PTY/e2e tests for launch flow, navigation, search, timeline, layout persistence, transport toggles.\n- Detailed structured logs/artifacts to debug failures quickly.\n- Perf budgets and no-regression checks for interactive responsiveness.\n\n## Deliverable\nA full bead graph under this epic with explicit dependencies covering:\n- product/UX spec,\n- architecture + data/event pipeline,\n- launcher orchestration (`am` one-command),\n- dashboard/search/timeline/layout/palette surfaces,\n- MCP/API mode integration,\n- tests/perf/docs and rollout gates.","acceptance_criteria":"- `am` starts server + full AgentMailTUI together by default.\n- Operator can switch/use MCP or API mode without restarting flow complexity.\n- TUI default experience materially improves clarity over current rich logs.\n- Layout tuning is interactive and persisted/restored automatically.\n- Unit + PTY/e2e suites cover the critical user journeys with detailed artifacts.","status":"open","priority":0,"issue_type":"epic","created_at":"2026-02-07T03:12:19.615580143Z","created_by":"ubuntu","updated_at":"2026-02-07T03:16:55.086281720Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"br-10wc.1","title":"[track] Product contract and showcase UX spec for AgentMailTUI","description":"Define explicit UX/behavior contract for AgentMailTUI, grounded in frankentui showcase patterns and user-mandated am one-command flow.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:17:01.916174022Z","created_by":"ubuntu","updated_at":"2026-02-07T03:17:01.916174022Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.1","depends_on_id":"br-10wc","type":"parent-child","created_at":"2026-02-07T03:17:01.916174022Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.1.1","title":"Capability matrix from frankentui showcase to AgentMailTUI","description":"Map concrete showcase features (dashboard, action timeline, log/virtualized search, command palette, layout controls, perf HUD) to AgentMailTUI requirements. Include explicit include/exclude rationale and accretive sequencing.","status":"in_progress","priority":0,"issue_type":"task","created_at":"2026-02-07T03:18:28.640342365Z","created_by":"ubuntu","updated_at":"2026-02-07T03:22:20.680450909Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.1.1","depends_on_id":"br-10wc.1","type":"parent-child","created_at":"2026-02-07T03:18:28.640342365Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.1.2","title":"Operator journey specification and information architecture","description":"Define primary and secondary user journeys: startup, observe, search, inspect, remediate, configure layout. Produce pane-level IA and navigation rules that minimize context switching and maximize situational awareness.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:18:28.738159501Z","created_by":"ubuntu","updated_at":"2026-02-07T03:20:31.337609558Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.1.2","depends_on_id":"br-10wc.1","type":"parent-child","created_at":"2026-02-07T03:18:28.738159501Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.1.2","depends_on_id":"br-10wc.1.1","type":"blocks","created_at":"2026-02-07T03:20:31.337539206Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.1.3","title":"Default-on UX acceptance gates including am contract","description":"Formalize acceptance criteria: am launches server+tui by default, MCP/API compatibility, interactive layout persistence, low-noise defaults, and operable fallback modes. These gates block implementation completion until met.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:18:28.839432278Z","created_by":"ubuntu","updated_at":"2026-02-07T03:20:31.456019880Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.1.3","depends_on_id":"br-10wc.1","type":"parent-child","created_at":"2026-02-07T03:18:28.839432278Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.1.3","depends_on_id":"br-10wc.1.2","type":"blocks","created_at":"2026-02-07T03:20:31.455945170Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.1.4","title":"Regression boundaries versus legacy rich console behavior","description":"Capture what must remain available from current console output while moving to full TUI. Define explicit non-regression checklist so quality improves without losing useful diagnostics.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:18:28.944463892Z","created_by":"ubuntu","updated_at":"2026-02-07T03:20:31.570992035Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.1.4","depends_on_id":"br-10wc.1","type":"parent-child","created_at":"2026-02-07T03:18:28.944463892Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.1.4","depends_on_id":"br-10wc.1.3","type":"blocks","created_at":"2026-02-07T03:20:31.570909049Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.10","title":"[track] MCP/API dual-mode transport integration in TUI","description":"Support operation with either MCP or API endpoints from the one-command flow. Surface current mode in UI, allow explicit override, and ensure parity in behavior and diagnostics.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:18:02.736663554Z","created_by":"ubuntu","updated_at":"2026-02-07T03:54:16.838540822Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.10","depends_on_id":"br-10wc","type":"parent-child","created_at":"2026-02-07T03:18:02.736663554Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.10.1","title":"Runtime mode indicator and explicit MCP/API selection UX","description":"Expose current transport/path mode clearly in the UI and support explicit mode switching controls.","notes":"Started implementation after br-10wc.3.3 closure. Added runtime mode indicator plumbing (mcp/api/custom) into live dashboard and explicit CLI transport/path selection in serve command.","status":"closed","priority":0,"issue_type":"task","assignee":"GoldDeer","created_at":"2026-02-07T03:19:18.185159820Z","created_by":"ubuntu","updated_at":"2026-02-07T21:32:06.874301731Z","closed_at":"2026-02-07T21:32:06.874278347Z","close_reason":"Implemented explicit mode-selection UX plus runtime mode visibility. Added mcp-agent-mail serve flags --transport {auto|mcp|api} and --path with deterministic precedence; scripts/am now supports --mcp/--api shortcuts and passes normalized --path. Live dashboard now shows Mode: mcp|api|custom derived from active base path.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.10.1","depends_on_id":"br-10wc.10","type":"parent-child","created_at":"2026-02-07T03:19:18.185159820Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.10.1","depends_on_id":"br-10wc.3.3","type":"blocks","created_at":"2026-02-07T03:20:36.072637562Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.10.2","title":"Connection diagnostics panel with auth/path/health checks","description":"Add diagnostics for endpoint reachability, auth token issues, base-path mismatches, and handshake failures with actionable messaging.","status":"in_progress","priority":0,"issue_type":"task","created_at":"2026-02-07T03:19:18.303843033Z","created_by":"ubuntu","updated_at":"2026-02-07T23:12:22.699195702Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.10.2","depends_on_id":"br-10wc.10","type":"parent-child","created_at":"2026-02-07T03:19:18.303843033Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.10.2","depends_on_id":"br-10wc.3.4","type":"blocks","created_at":"2026-02-07T03:20:36.187932892Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.10.3","title":"Mode-switch resilience and automatic reconnection flow","description":"When switching transport/path modes, preserve state where safe and reconnect predictably without data corruption.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:19:18.419352444Z","created_by":"ubuntu","updated_at":"2026-02-07T03:20:36.414173919Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.10.3","depends_on_id":"br-10wc.10","type":"parent-child","created_at":"2026-02-07T03:19:18.419352444Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.10.3","depends_on_id":"br-10wc.10.1","type":"blocks","created_at":"2026-02-07T03:20:36.305043491Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.10.3","depends_on_id":"br-10wc.10.2","type":"blocks","created_at":"2026-02-07T03:20:36.414097946Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.10.4","title":"Behavior parity validation across MCP/API transport modes","description":"Define and validate parity checks so critical flows behave equivalently in both modes, including error semantics.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:19:18.537071401Z","created_by":"ubuntu","updated_at":"2026-02-07T03:20:36.529769110Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.10.4","depends_on_id":"br-10wc.10","type":"parent-child","created_at":"2026-02-07T03:19:18.537071401Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.10.4","depends_on_id":"br-10wc.10.3","type":"blocks","created_at":"2026-02-07T03:20:36.529720789Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.11","title":"[track] Output polish + noise controls + severity filtering","description":"Replace noisy duplicated logging with coherent event cards/panels. Add verbosity tiers, filters, and severity highlighting so default output is high signal and non-overwhelming while preserving depth on demand.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:18:02.837197447Z","created_by":"ubuntu","updated_at":"2026-02-07T03:54:17.099895667Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.11","depends_on_id":"br-10wc","type":"parent-child","created_at":"2026-02-07T03:18:02.837197447Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.11.1","title":"Unify duplicate request/log output into coherent event rendering","description":"Eliminate duplicate noisy output paths and render unified high-signal event cards/panels in the TUI.","status":"closed","priority":0,"issue_type":"task","assignee":"RubyPrairie","created_at":"2026-02-07T03:19:18.656410001Z","created_by":"ubuntu","updated_at":"2026-02-07T22:47:53.304137955Z","closed_at":"2026-02-07T22:47:53.304116475Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.11.1","depends_on_id":"br-10wc.11","type":"parent-child","created_at":"2026-02-07T03:19:18.656410001Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.11.1","depends_on_id":"br-10wc.20","type":"blocks","created_at":"2026-02-07T03:49:28.912654529Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.11.1","depends_on_id":"br-10wc.5.1","type":"blocks","created_at":"2026-02-07T03:20:36.648548563Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.11.1","depends_on_id":"br-10wc.7.2","type":"blocks","created_at":"2026-02-07T03:20:36.762164218Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.11.2","title":"Verbosity tiers and per-pane filters with sane defaults","description":"Implement configurable verbosity and filtering so default view is clean while advanced details remain accessible.","status":"closed","priority":1,"issue_type":"task","assignee":"RubyPrairie","created_at":"2026-02-07T03:19:18.767978393Z","created_by":"ubuntu","updated_at":"2026-02-07T23:22:25.161088887Z","closed_at":"2026-02-07T23:22:25.161005210Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.11.2","depends_on_id":"br-10wc.11","type":"parent-child","created_at":"2026-02-07T03:19:18.767978393Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.11.2","depends_on_id":"br-10wc.11.1","type":"blocks","created_at":"2026-02-07T03:20:36.873752888Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.11.3","title":"Severity/badge design system for rapid triage","description":"Standardize severity visual language (colors/icons/text badges) for at-a-glance triage under pressure.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:19:18.875769864Z","created_by":"ubuntu","updated_at":"2026-02-07T03:20:36.988047024Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.11.3","depends_on_id":"br-10wc.11","type":"parent-child","created_at":"2026-02-07T03:19:18.875769864Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.11.3","depends_on_id":"br-10wc.11.2","type":"blocks","created_at":"2026-02-07T03:20:36.987989536Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.11.4","title":"Theme polish pass and readability tuning across sizes","description":"Execute final visual/readability polish with explicit theme parity between legacy console styling and AgentMailTUI palettes.\n\nScope includes:\n- Map existing console theme IDs (including cyberpunk_aurora and alternatives) into TUI palette primitives used by tabs, status, cards, badges, charts, and alerts.\n- Ensure severity/status/latency color semantics remain consistent and legible across small and large terminal sizes.\n- Validate contrast + spacing for dense operational views (dashboard, timeline, search, health).\n- Support runtime theme switching without style desynchronization.\n\nNon-regression:\n- No regressions to severity badge clarity defined in `br-10wc.11.3`.\n- No drift between selected `CONSOLE_THEME` semantics and rendered TUI look.\n\nTesting requirements:\n- Palette completeness/unit mapping tests.\n- Snapshot checks for key screens under multiple themes and dimensions.\n- Manual/PTY verification that theme switch updates all chrome + content panes coherently.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-07T03:19:18.983298954Z","created_by":"ubuntu","updated_at":"2026-02-07T03:43:11.551289354Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.11.4","depends_on_id":"br-10wc.11","type":"parent-child","created_at":"2026-02-07T03:19:18.983298954Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.11.4","depends_on_id":"br-10wc.11.3","type":"blocks","created_at":"2026-02-07T03:20:37.101574895Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.12","title":"[track] Unit/property/snapshot test suite for AgentMailTUI core","description":"Deliver a comprehensive deterministic unit/property/snapshot suite for AgentMailTUI core behavior. This is the canonical umbrella for all unit-level TUI test coverage.\n\nCoverage matrix (minimum):\n- Event model + ring buffer behavior: overflow, ordering, filtering, since-seq reads, serialization roundtrip.\n- Shared-state bridge concurrency correctness: concurrent push/read, counters, shutdown signaling.\n- Reducer/state-machine invariants: navigation, focus, modal lifecycle, mode switching, error transitions.\n- Parser/normalizer/redaction correctness for event ingestion.\n- Layout persistence + schema validation + restore/reset semantics.\n- Screen-level formatting/data-transform logic for dashboard/messages/threads/agents/reservations/tool metrics/system health.\n- Chrome rendering helpers: tab/status/help content generation.\n\nExecution quality constraints:\n- Deterministic (no flake-prone timing dependence).\n- Fast local feedback suitable for frequent iteration.\n- Rich failure logs so regressions are easy to diagnose.\n\nThis task supersedes ad-hoc duplicate test umbrella beads and is the single source of truth for unit-level TUI quality gates.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:18:02.941106669Z","created_by":"ubuntu","updated_at":"2026-02-07T03:54:17.500454293Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.12","depends_on_id":"br-10wc","type":"parent-child","created_at":"2026-02-07T03:18:02.941106669Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.12","depends_on_id":"br-10wc.11","type":"blocks","created_at":"2026-02-07T03:20:05.635395646Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.12","depends_on_id":"br-10wc.4","type":"blocks","created_at":"2026-02-07T03:20:04.836479768Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.12","depends_on_id":"br-10wc.6","type":"blocks","created_at":"2026-02-07T03:20:05.064400099Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.12","depends_on_id":"br-10wc.7","type":"blocks","created_at":"2026-02-07T03:20:05.177077427Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.12","depends_on_id":"br-10wc.9","type":"blocks","created_at":"2026-02-07T03:20:05.406228011Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.12.1","title":"Reducer/state-machine unit tests with edge-case coverage","description":"Add thorough unit tests for core state transitions, event ordering invariants, and failure edges.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:19:19.094396074Z","created_by":"ubuntu","updated_at":"2026-02-07T03:49:28.706105061Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.12.1","depends_on_id":"br-10wc.12","type":"parent-child","created_at":"2026-02-07T03:19:19.094396074Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.12.1","depends_on_id":"br-10wc.15","type":"blocks","created_at":"2026-02-07T03:49:27.756425428Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.12.1","depends_on_id":"br-10wc.17","type":"blocks","created_at":"2026-02-07T03:49:28.706011415Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.12.1","depends_on_id":"br-10wc.2.2","type":"blocks","created_at":"2026-02-07T03:20:37.212382843Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.12.1","depends_on_id":"br-10wc.4.1","type":"blocks","created_at":"2026-02-07T03:20:37.329841213Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.12.2","title":"Parser/normalizer/redaction tests for event pipeline","description":"Test typed event parsing/normalization and sensitive-data masking policies across representative real payloads.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:19:19.213608618Z","created_by":"ubuntu","updated_at":"2026-02-07T03:49:28.166654577Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.12.2","depends_on_id":"br-10wc.12","type":"parent-child","created_at":"2026-02-07T03:19:19.213608618Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.12.2","depends_on_id":"br-10wc.28","type":"blocks","created_at":"2026-02-07T03:49:28.166567263Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.12.2","depends_on_id":"br-10wc.4.4","type":"blocks","created_at":"2026-02-07T03:20:37.440113719Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.12.3","title":"Layout persistence and restore logic unit tests","description":"Verify interactive layout mutations, persisted config serialization, restore behavior, and schema migration handling.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:19:19.325787042Z","created_by":"ubuntu","updated_at":"2026-02-07T03:20:37.554754173Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.12.3","depends_on_id":"br-10wc.12","type":"parent-child","created_at":"2026-02-07T03:19:19.325787042Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.12.3","depends_on_id":"br-10wc.8.3","type":"blocks","created_at":"2026-02-07T03:20:37.554682278Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.12.4","title":"Golden snapshot suite for key screens and states","description":"Capture deterministic snapshots for dashboard/search/timeline/layout/help surfaces under canonical terminal sizes.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:19:19.438139953Z","created_by":"ubuntu","updated_at":"2026-02-07T03:24:02.545571889Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.12.4","depends_on_id":"br-10wc.12","type":"parent-child","created_at":"2026-02-07T03:19:19.438139953Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.12.4","depends_on_id":"br-10wc.20","type":"blocks","created_at":"2026-02-07T03:24:01.831743133Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.12.4","depends_on_id":"br-10wc.21","type":"blocks","created_at":"2026-02-07T03:24:01.945324999Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.12.4","depends_on_id":"br-10wc.22","type":"blocks","created_at":"2026-02-07T03:24:02.067703657Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.12.4","depends_on_id":"br-10wc.23","type":"blocks","created_at":"2026-02-07T03:24:02.186621233Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.12.4","depends_on_id":"br-10wc.24","type":"blocks","created_at":"2026-02-07T03:24:02.302429970Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.12.4","depends_on_id":"br-10wc.25","type":"blocks","created_at":"2026-02-07T03:24:02.425754137Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.12.4","depends_on_id":"br-10wc.26","type":"blocks","created_at":"2026-02-07T03:24:02.545487211Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.12.4","depends_on_id":"br-10wc.5.1","type":"blocks","created_at":"2026-02-07T03:20:37.667426021Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.12.4","depends_on_id":"br-10wc.6.2","type":"blocks","created_at":"2026-02-07T03:20:37.782175118Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.12.4","depends_on_id":"br-10wc.7.1","type":"blocks","created_at":"2026-02-07T03:20:37.901146120Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.12.4","depends_on_id":"br-10wc.8.2","type":"blocks","created_at":"2026-02-07T03:20:38.019552775Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.13","title":"[track] PTY E2E and performance harness with detailed artifacts","description":"Build the canonical PTY E2E + perf harness for the one-command AgentMailTUI workflow, with artifact-rich diagnostics.\n\nRequired E2E scenarios:\n- Startup smoke: `am` launches server+TUI by default and reaches ready state.\n- Navigation: tab/number/palette/help flows across major screens.\n- Live behavior: event ingestion appears in dashboard/log surfaces under real requests.\n- Search flows: interactive query, result navigation, deep-link pivots.\n- MCP/API mode switching and parity checks for key operations.\n- Clean shutdown semantics (`q`, Ctrl+C, and server-stop propagation).\n- Headless fallback (`--no-tui` and/or non-TTY behavior).\n\nPerformance harness requirements:\n- Repeatable PTY/perf scenarios with explicit thresholds (render latency, event throughput, memory growth).\n- Detailed logs/artifacts on failure (captured output, timing markers, state snapshots).\n\nTest design constraints:\n- Deterministic and CI-stable.\n- Fast enough for routine validation while still catching regressions.\n- Clear separation between functional failures vs performance budget failures.\n\nThis task supersedes duplicate E2E umbrella beads and is the single source of truth for PTY/integration validation.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:18:03.047794394Z","created_by":"ubuntu","updated_at":"2026-02-07T03:54:17.897327041Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.13","depends_on_id":"br-10wc","type":"parent-child","created_at":"2026-02-07T03:18:03.047794394Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.13","depends_on_id":"br-10wc.11","type":"blocks","created_at":"2026-02-07T03:20:06.562575325Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.13","depends_on_id":"br-10wc.3","type":"blocks","created_at":"2026-02-07T03:20:05.750730140Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.13","depends_on_id":"br-10wc.5","type":"blocks","created_at":"2026-02-07T03:20:05.863947940Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.13","depends_on_id":"br-10wc.6","type":"blocks","created_at":"2026-02-07T03:20:05.981851173Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.13","depends_on_id":"br-10wc.7","type":"blocks","created_at":"2026-02-07T03:20:06.097264644Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.13","depends_on_id":"br-10wc.9","type":"blocks","created_at":"2026-02-07T03:20:06.327832441Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.13.1","title":"PTY E2E: am default starts server+tui and reaches ready state","description":"Add PTY e2e test proving one-command startup contract and validating readiness markers with detailed log artifacts.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:19:19.563003457Z","created_by":"ubuntu","updated_at":"2026-02-07T03:45:11.851932258Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.13.1","depends_on_id":"br-10wc.10.1","type":"blocks","created_at":"2026-02-07T03:20:38.299441933Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.13.1","depends_on_id":"br-10wc.13","type":"parent-child","created_at":"2026-02-07T03:19:19.563003457Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.13.1","depends_on_id":"br-10wc.3.1","type":"blocks","created_at":"2026-02-07T03:20:38.129305277Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.13.1","depends_on_id":"br-10wc.3.5","type":"blocks","created_at":"2026-02-07T03:45:11.851863629Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.13.2","title":"PTY E2E: interaction flows (search, timeline, palette, layout)","description":"Automate high-value user journeys through the TUI and assert expected UI state transitions with artifact capture.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:19:19.682423219Z","created_by":"ubuntu","updated_at":"2026-02-07T03:24:03.435568536Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.13.2","depends_on_id":"br-10wc.13","type":"parent-child","created_at":"2026-02-07T03:19:19.682423219Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.13.2","depends_on_id":"br-10wc.20","type":"blocks","created_at":"2026-02-07T03:24:02.668347390Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.13.2","depends_on_id":"br-10wc.21","type":"blocks","created_at":"2026-02-07T03:24:02.783747270Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.13.2","depends_on_id":"br-10wc.22","type":"blocks","created_at":"2026-02-07T03:24:02.904493020Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.13.2","depends_on_id":"br-10wc.23","type":"blocks","created_at":"2026-02-07T03:24:03.023300100Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.13.2","depends_on_id":"br-10wc.24","type":"blocks","created_at":"2026-02-07T03:24:03.132261485Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.13.2","depends_on_id":"br-10wc.25","type":"blocks","created_at":"2026-02-07T03:24:03.308670106Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.13.2","depends_on_id":"br-10wc.26","type":"blocks","created_at":"2026-02-07T03:24:03.435514686Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.13.2","depends_on_id":"br-10wc.5.1","type":"blocks","created_at":"2026-02-07T03:20:38.408801380Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.13.2","depends_on_id":"br-10wc.6.4","type":"blocks","created_at":"2026-02-07T03:20:38.522030331Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.13.2","depends_on_id":"br-10wc.7.2","type":"blocks","created_at":"2026-02-07T03:20:38.642307438Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.13.2","depends_on_id":"br-10wc.8.2","type":"blocks","created_at":"2026-02-07T03:20:38.762324879Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.13.2","depends_on_id":"br-10wc.9.1","type":"blocks","created_at":"2026-02-07T03:20:38.876841090Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.13.3","title":"PTY E2E: MCP/API mode switching and parity assertions","description":"Test switching between MCP/API endpoint modes and assert equivalent critical outcomes and understandable diagnostics.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:19:19.796527900Z","created_by":"ubuntu","updated_at":"2026-02-07T03:20:39.107207129Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.13.3","depends_on_id":"br-10wc.10.4","type":"blocks","created_at":"2026-02-07T03:20:38.992813828Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.13.3","depends_on_id":"br-10wc.13","type":"parent-child","created_at":"2026-02-07T03:19:19.796527900Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.13.3","depends_on_id":"br-10wc.3.3","type":"blocks","created_at":"2026-02-07T03:20:39.107142719Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.13.4","title":"Perf regression harness and event-throughput budgets","description":"Create repeatable perf scenarios with thresholds for frame latency, event ingestion throughput, and memory growth under sustained load.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:19:19.909940034Z","created_by":"ubuntu","updated_at":"2026-02-07T03:49:29.246956068Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.13.4","depends_on_id":"br-10wc.13","type":"parent-child","created_at":"2026-02-07T03:19:19.909940034Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.13.4","depends_on_id":"br-10wc.20","type":"blocks","created_at":"2026-02-07T03:49:29.246910042Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.13.4","depends_on_id":"br-10wc.4.3","type":"blocks","created_at":"2026-02-07T03:20:39.342561117Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.13.4","depends_on_id":"br-10wc.5.2","type":"blocks","created_at":"2026-02-07T03:20:39.227847216Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.14","title":"[track] Documentation, runbook, and rollout hardening","description":"Own complete documentation/runbook/rollout hardening for the new default workflow where `am` starts server + TUI together.\n\nRequired docs scope:\n- Simplified quick start replacing brittle manual env command chains.\n- Clear explanation of default behavior, optional headless/diagnostic modes, and MCP/API operation.\n- Operator controls reference (keybindings, layout tuning, troubleshooting, recovery paths).\n- Configuration documentation: layout persistence, theme/env controls, and safe defaults.\n- Contributor guidance for extending screens/features without breaking architecture/testing contracts.\n- Release validation checklist tying functional + test + perf + docs readiness together.\n\nQuality bar:\n- Docs must be self-contained, operationally useful, and aligned with actual runtime behavior.\n- Troubleshooting steps must include concrete checks/remediation, not generic advice.\n\nThis task supersedes duplicate documentation umbrella beads and is the canonical documentation plan for AgentMailTUI rollout.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:18:03.150917705Z","created_by":"ubuntu","updated_at":"2026-02-07T03:54:18.301266001Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.14","depends_on_id":"br-10wc","type":"parent-child","created_at":"2026-02-07T03:18:03.150917705Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.14","depends_on_id":"br-10wc.3","type":"blocks","created_at":"2026-02-07T03:20:06.804244346Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.14.1","title":"README simplification around am one-command workflow","description":"Rewrite quick start/testing docs so local usage is straightforward and no longer requires brittle manual env command chains.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:19:20.024629119Z","created_by":"ubuntu","updated_at":"2026-02-07T03:45:11.986011821Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.14.1","depends_on_id":"br-10wc.13.1","type":"blocks","created_at":"2026-02-07T03:20:39.579803901Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.14.1","depends_on_id":"br-10wc.14","type":"parent-child","created_at":"2026-02-07T03:19:20.024629119Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.14.1","depends_on_id":"br-10wc.3.1","type":"blocks","created_at":"2026-02-07T03:20:39.461368452Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.14.1","depends_on_id":"br-10wc.3.5","type":"blocks","created_at":"2026-02-07T03:45:11.985928605Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.14.2","title":"Operator runbook: controls, troubleshooting, and recovery","description":"Document practical operator guidance for startup issues, layout tuning, transport mode issues, and diagnostics collection.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:19:20.140407914Z","created_by":"ubuntu","updated_at":"2026-02-07T03:20:39.805992099Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.14.2","depends_on_id":"br-10wc.13.2","type":"blocks","created_at":"2026-02-07T03:20:39.693541345Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.14.2","depends_on_id":"br-10wc.13.3","type":"blocks","created_at":"2026-02-07T03:20:39.805935994Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.14.2","depends_on_id":"br-10wc.14","type":"parent-child","created_at":"2026-02-07T03:19:20.140407914Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.14.3","title":"Developer guide for extending AgentMailTUI screens/features","description":"Provide architecture-oriented implementation guidance so future contributors can add panes/actions/tests safely.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-07T03:19:20.255659422Z","created_by":"ubuntu","updated_at":"2026-02-07T03:20:40.091048101Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.14.3","depends_on_id":"br-10wc.13.2","type":"blocks","created_at":"2026-02-07T03:20:40.090975384Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.14.3","depends_on_id":"br-10wc.14","type":"parent-child","created_at":"2026-02-07T03:19:20.255659422Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.14.3","depends_on_id":"br-10wc.2.3","type":"blocks","created_at":"2026-02-07T03:20:39.942138236Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.14.4","title":"Release checklist and rollout validation plan","description":"Define release gating checklist spanning functional, test, perf, and docs readiness before promoting new default workflow.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:19:20.372775851Z","created_by":"ubuntu","updated_at":"2026-02-07T03:20:40.675681712Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.14.4","depends_on_id":"br-10wc.13.4","type":"blocks","created_at":"2026-02-07T03:20:40.247855180Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.14.4","depends_on_id":"br-10wc.14","type":"parent-child","created_at":"2026-02-07T03:19:20.372775851Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.14.4","depends_on_id":"br-10wc.14.1","type":"blocks","created_at":"2026-02-07T03:20:40.396453571Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.14.4","depends_on_id":"br-10wc.14.2","type":"blocks","created_at":"2026-02-07T03:20:40.544693381Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.14.4","depends_on_id":"br-10wc.14.3","type":"blocks","created_at":"2026-02-07T03:20:40.675624685Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.15","title":"MailEvent typed event model + ring buffer","description":"## Purpose\nDefine the typed event stream feeding all TUI panes -- the canonical data contract between MCP server thread and TUI rendering thread. All panes consume consistent data models with stable IDs, timestamps, source metadata, and redaction state.\n\n**Absorbs**: br-10wc.4.1 (canonical event schema), br-10wc.4.2 (bounded event store + replay hooks)\n\n## Background\nCurrent StartupDashboard uses ad-hoc Mutex-wrapped structs (DashboardDbStats, DashboardLastRequest, SparklineBuffer, ConsoleEventBuffer). The existing ConsoleEvent / ConsoleEventBuffer / TimelinePane in console.rs provide a precursor model. For the full TUI we need a clean typed event model that:\n1. Covers ALL event sources: HTTP requests, tool calls, mail operations, reservation changes, agent lifecycle\n2. Is produced by server hooks and consumed by any screen\n3. Replaces the existing ConsoleEvent model with a unified, canonical alternative\n\n## Deliverables\n\n### 1. MailEvent enum (tui_events.rs)\n- ToolCallStart { tool_name, params_json, project, agent, timestamp }\n- ToolCallEnd { tool_name, duration_ms, result_preview, queries, query_time_ms, per_table, timestamp }\n- MessageSent { id, from, to, subject, thread_id, project, timestamp }\n- MessageReceived { id, from, to, subject, thread_id, project, timestamp }\n- ReservationGranted { agent, paths, exclusive, ttl_s, project, timestamp }\n- ReservationReleased { agent, paths, project, timestamp }\n- AgentRegistered { name, program, model_name, project, timestamp }\n- HttpRequest { method, path, status, duration_ms, client_ip, timestamp }\n- HealthPulse { db_stats: DbStatSnapshot, timestamp }\n- ServerStarted { endpoint, config_summary, timestamp }\n- ServerShutdown { timestamp }\n\nEach variant carries:\n- Stable source metadata (which subsystem produced the event)\n- Monotonic u64 sequence number for total ordering\n- i64 microsecond timestamp (sqlmodel_rust convention)\n\n### 2. EventRingBuffer (bounded circular buffer with replay)\n- Configurable capacity (default 10,000 events)\n- O(1) push, O(1) index access via VecDeque\n- Thread-safe: Arc<Mutex<VecDeque<MailEvent>>>\n- iter_recent(n) -> last N events\n- filter_by_kind() for screen-specific filtering\n- since(timestamp) for incremental reads by timestamp\n- replay_range(seq_from, seq_to) for deterministic replay between sequence numbers\n- events_since_seq(seq) -> Vec<MailEvent> for incremental polling by sequence (the primary TUI consumption path)\n- Monotonic sequence numbers for ordering\n- Drop accounting: track total_pushed vs capacity to report dropped events\n\n### 3. DbStatSnapshot struct\n- Reuse fields from existing DashboardDbStats (projects, agents, messages, file_reservations, contact_links, ack_pending)\n- agents_list: Vec<AgentSummary>\n- timestamp: i64 (microseconds)\n\n## Technical Notes\n- Use i64 microsecond timestamps (sqlmodel_rust convention)\n- Derive serde Serialize/Deserialize for JSONL export and snapshot testing\n- Mark enum #[non_exhaustive] for extensibility\n- Ring buffer handles concurrent writers (server) and readers (TUI) via try_lock (never block server thread)\n- Replay hooks enable: PTY E2E tests to assert on event sequences, timeline pane to scroll through history, search to index historical events\n- Migration from ConsoleEvent: MailEvent supersedes ConsoleEvent/ConsoleEventKind/ConsoleEventBuffer. Existing console.rs types remain for backward compat with the non-TUI inline HUD but the TUI uses MailEvent exclusively.\n\n## Files\n- NEW: crates/mcp-agent-mail-server/src/tui_events.rs\n- MODIFY: crates/mcp-agent-mail-server/src/lib.rs (add pub mod tui_events)\n\n## Acceptance Criteria\n- All variants are Send + Sync\n- Unit tests: ring buffer push/capacity overflow/filter/since()/replay_range()/events_since_seq()\n- Drop accounting: verify total_pushed count and dropped event visibility\n- Serde roundtrip tests for all MailEvent variants\n- No clippy warnings","notes":"Picked via bv --robot-next at 2026-02-07; starting implementation in crates/mcp-agent-mail-server/src/tui_events.rs and integration in lib.rs.","status":"closed","priority":1,"issue_type":"task","assignee":"TealMeadow","created_at":"2026-02-07T03:19:22.174455328Z","created_by":"ubuntu","updated_at":"2026-02-07T21:15:01.636622712Z","closed_at":"2026-02-07T21:15:01.636599168Z","close_reason":"Implemented tui_events foundation: typed MailEvent enum, DbStatSnapshot/AgentSummary models, bounded EventRingBuffer (push/try_push/filter/replay/since-seq/drop stats), exported via lib.rs, with comprehensive unit + serde tests and clippy-clean checks.","source_repo":".","compaction_level":0,"original_size":0,"labels":["tui-foundation"],"dependencies":[{"issue_id":"br-10wc.15","depends_on_id":"br-10wc.4","type":"parent-child","created_at":"2026-02-07T03:20:30.888407135Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.16","title":"TuiSharedState bridge: Arc-wrapped server-to-TUI communication","description":"## Purpose\nCreate the shared state bridge that connects the MCP HTTP server thread to the TUI rendering thread. This is the only communication channel between the two.\n\n## Background\nCurrently StartupDashboard lives as an Arc<StartupDashboard> with many AtomicU64 + Mutex fields. For the new TUI, we need a cleaner bridge with clear ownership semantics: the server thread writes events, the TUI thread reads them.\n\n## Deliverables\n\n### TuiSharedState struct\n```rust\npub struct TuiSharedState {\n    // Event stream (server writes, TUI reads)\n    events: EventRingBuffer,\n\n    // Aggregated counters (server increments atomically)\n    requests_total: AtomicU64,\n    requests_2xx: AtomicU64,\n    requests_4xx: AtomicU64,\n    requests_5xx: AtomicU64,\n    latency_total_ms: AtomicU64,\n\n    // Lifecycle\n    started_at: Instant,\n    shutdown: AtomicBool,\n\n    // Configuration snapshot (immutable after creation)\n    config_snapshot: ConfigSnapshot,\n\n    // DB stats (polled periodically, written under mutex)\n    db_stats: Mutex<DbStatSnapshot>,\n\n    // Sparkline data for request rate\n    sparkline_data: Mutex<VecDeque<f64>>,\n}\n```\n\n### ConfigSnapshot struct\n- endpoint: String\n- web_ui_url: String\n- app_environment: String\n- auth_enabled: bool\n- database_url: String (sanitized)\n- storage_root: String\n- console_theme: String\n- tool_filter_profile: String\n\n### API\n- `TuiSharedState::new(config: &Config) -> Arc<Self>`\n- `push_event(&self, event: MailEvent)` -- thread-safe\n- `recent_events(&self, n: usize) -> Vec<MailEvent>` -- snapshot\n- `events_since(&self, seq: u64) -> Vec<MailEvent>` -- incremental\n- `record_request(&self, status: u16, duration_ms: u64)`\n- `update_db_stats(&self, stats: DbStatSnapshot)`\n- `request_shutdown(&self)`\n- `is_shutdown_requested(&self) -> bool`\n- `uptime(&self) -> Duration`\n\n## Technical Notes\n- Arc<TuiSharedState> is cloned into both threads\n- All reads are non-blocking (try_lock or atomics)\n- No async -- both threads are sync\n- Server thread calls push_event() from InstrumentedTool and HTTP handler\n- TUI thread calls recent_events()/events_since() from tick handler\n\n## Files\n- NEW: crates/mcp-agent-mail-server/src/tui_bridge.rs\n- MODIFY: crates/mcp-agent-mail-server/src/lib.rs (add pub mod tui_bridge)\n\n## Acceptance Criteria\n- Thread-safe: concurrent push + read tests pass\n- Shutdown signal propagates correctly\n- No clippy warnings\n- Unit tests for all API methods","notes":"Scaffolded crates/mcp-agent-mail-server/src/tui_bridge.rs with ConfigSnapshot + TuiSharedState APIs and unit tests; wired pub mod in lib.rs. Validation currently blocked by unrelated compile failures in crates/mcp-agent-mail-storage/src/lib.rs (WBQ envelope refactor in progress by other agent work).","status":"closed","priority":1,"issue_type":"task","assignee":"TealMeadow","created_at":"2026-02-07T03:19:39.939352138Z","created_by":"ubuntu","updated_at":"2026-02-07T21:19:02.325816495Z","closed_at":"2026-02-07T21:17:50.855941262Z","close_reason":"Implemented tui_bridge.rs: TuiSharedState (Arc-wrapped bridge with EventRingBuffer, atomic HTTP counters, Mutex<DbStatSnapshot>, sparkline ring, shutdown signal, ConfigSnapshot). 12 unit tests: push/read events, incremental poll, HTTP counters, DB stats, sparkline capacity, shutdown propagation, concurrent push+read, uptime, Send+Sync. 0 clippy warnings.","source_repo":".","compaction_level":0,"original_size":0,"labels":["tui-foundation"],"dependencies":[{"issue_id":"br-10wc.16","depends_on_id":"br-10wc.15","type":"blocks","created_at":"2026-02-07T03:21:38.525558629Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.16","depends_on_id":"br-10wc.4","type":"parent-child","created_at":"2026-02-07T03:21:38.076914993Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.17","title":"MailScreen trait + MailScreenId registry + MailAppModel skeleton","description":"## Purpose\nDefine the screen abstraction, screen registry, and top-level App Model that drives the TUI. This is the structural skeleton that all screens plug into.\n\n**Absorbs**: br-10wc.2.1 (reuse plan from ftui-demo-showcase patterns)\n\n## Background\nfrankentui demo showcase uses a Screen trait with update()/view()/tick()/keybindings() methods and a ScreenId enum with ScreenMeta registry. We adapt this pattern for AgentMailTUI with our own screen set.\n\n### Patterns Reused from ftui-demo-showcase\n- **Screen trait** (screens/mod.rs): update/view/tick/keybindings/consumes_text_input/title/tab_label  adapted as MailScreen\n- **ScreenId enum** (screens/mod.rs): type-safe screen identifiers with next/prev/by-id helpers  MailScreenId\n- **ScreenMeta registry** (SCREEN_REGISTRY): static metadata (title, short_label, category, keybindings)  MAIL_SCREEN_REGISTRY\n- **Chrome shell** (app.rs): tab bar + status line + help overlay wrapping active screen  tui_chrome.rs\n- **Tick-based animation** (dashboard.rs): tick_count as deterministic phase source for sparklines/animations\n- **Deterministic rendering**: all view() calls produce identical output for identical state (enables snapshot testing)\n- **AppModel pattern** (app.rs): single Model impl routes events to active screen, handles global keybindings\n\n## Deliverables\n\n### 1. MailScreen trait\n```rust\npub trait MailScreen {\n    type Message: Send + 'static;\n    fn update(&mut self, event: &Event, state: &TuiSharedState) -> Cmd<Self::Message>;\n    fn view(&self, frame: &mut Frame, area: Rect, state: &TuiSharedState);\n    fn tick(&mut self, tick_count: u64, state: &TuiSharedState) {}\n    fn keybindings(&self) -> Vec<HelpEntry> { vec![] }\n    fn consumes_text_input(&self) -> bool { false }\n    fn title(&self) -> &'static str;\n    fn tab_label(&self) -> &'static str;\n}\n```\n\n### 2. MailScreenId enum\n```rust\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]\npub enum MailScreenId {\n    Dashboard,\n    Messages,\n    Threads,\n    Agents,\n    Reservations,\n    ToolMetrics,\n    SystemHealth,\n}\n```\n\n### 3. Screen Registry\n- MAIL_SCREEN_REGISTRY: &[MailScreenMeta] with id, title, short_label, category, keybindings\n- Helper functions: screen_ids(), screen_meta(), next_screen(), prev_screen()\n- Categories: Overview, Communication, Operations, System\n\n### 4. MailAppModel (implements ftui_runtime::Model)\n- Owns all screen instances\n- Routes events to active screen\n- Handles global keybindings (Tab, number keys, ?, q)\n- Manages screen transitions\n- Holds Arc<TuiSharedState> reference\n- Message enum: MailMsg (from Event + custom messages)\n\n### 5. MailMsg enum\n```rust\npub enum MailMsg {\n    Terminal(Event),           // keyboard/mouse/resize\n    Tick,                      // periodic tick (100ms)\n    EventsUpdated,             // new MailEvents available\n    SwitchScreen(MailScreenId),\n    ToggleHelp,\n    Quit,\n}\n```\n\n## Technical Notes\n- Model::Message must implement From<Event>, so MailMsg::Terminal wraps events\n- Each screen gets its own module under tui_screens/ directory\n- The AppModel is the single Model instance passed to Program::run()\n- Use enum dispatch for screen storage (avoid dyn trait with associated types)\n- No adapter drift: MailScreen closely mirrors ftui-demo-showcase's Screen trait, diverging only where AgentMailTUI semantics require (e.g., passing TuiSharedState to view/update)\n\n## Files\n- NEW: crates/mcp-agent-mail-server/src/tui_app.rs (MailAppModel + MailMsg)\n- NEW: crates/mcp-agent-mail-server/src/tui_screens.rs (trait + registry)\n- MODIFY: crates/mcp-agent-mail-server/src/lib.rs\n\n## Acceptance Criteria\n- MailAppModel compiles and implements ftui_runtime::Model\n- Screen navigation (next/prev/by-id) works\n- Unit tests for registry helpers\n- No clippy warnings","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T03:20:01.691363231Z","created_by":"ubuntu","updated_at":"2026-02-07T21:33:49.471516320Z","closed_at":"2026-02-07T21:33:49.471473209Z","close_reason":"MailScreen trait + MailScreenId registry + MailAppModel skeleton complete. tui_screens.rs (MailScreen trait, MailScreenId enum, 7-screen registry, PlaceholderScreen, HelpEntry, ScreenCategory/Meta, 8 tests) + tui_app.rs (MailAppModel implementing ftui_runtime::Model, MailMsg enum, global keybindings q/?/Tab/BackTab/Esc/1-7, tick dispatch, map_screen_cmd helper, 13 tests). 0 clippy warnings.","source_repo":".","compaction_level":0,"original_size":0,"labels":["tui-foundation"],"dependencies":[{"issue_id":"br-10wc.17","depends_on_id":"br-10wc.16","type":"blocks","created_at":"2026-02-07T03:21:38.860136327Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.17","depends_on_id":"br-10wc.2","type":"parent-child","created_at":"2026-02-07T03:21:38.190111854Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.18","title":"Unified am entrypoint: MCP server thread + TUI main thread","description":"## Purpose\nMake `am` (and `cargo run -p mcp-agent-mail -- serve`) launch BOTH the MCP HTTP server AND the full TUI in a single process. The server runs on a background thread, the TUI runs on the main thread.\n\n**Absorbs**: br-10wc.3.1 (combined supervisor lifecycle), br-10wc.3.2 (launcher mode flags), br-10wc.2.4 (failure/fallback architecture)\n\n## Background\nCurrently `run_http()` blocks the main thread on `runtime.block_on(listener.run())`. The TUI needs the main thread for terminal I/O (`Program::run()` takes over the terminal). We need to restructure so:\n1. Background thread: asupersync runtime running HTTP listener\n2. Main thread: ftui-runtime Program::run() rendering the TUI\n3. Shared state bridge connects them\n4. Graceful shutdown: TUI quit -> server shutdown\n\n## Design Principles\n- **Default must be ONE command**: `am` or `am serve` launches everything. Flags are escape hatches, never required for normal operation.\n- **No duplicate startup dashboards**: When TUI mode is active, the existing inline HUD (StartupDashboard) is disabled to avoid fighting for stdout.\n- **No blocking sync on hot paths**: Event emission to TUI uses try_lock, never blocking the server's tool call latency.\n\n## Deliverables\n\n### 1. run_http_background() function\n- Extract server startup from run_http() into a function that returns a handle\n- Returns ServerHandle { join_handle, shutdown_signal, shared_state }\n- Spawns std::thread with asupersync runtime inside\n- Starts all background tasks (cleanup, ack_ttl, tool_metrics, retention, wbq)\n\n### 2. run_tui() function\n- Creates MailAppModel with Arc<TuiSharedState>\n- Configures ftui-runtime ProgramConfig (AltScreen mode, mouse support)\n- Calls Program::with_config(model, config)?.run()\n- On TUI exit, sends shutdown signal to server thread\n- Waits for server thread to join\n\n### 3. Modified am entrypoint\n- `am serve` (default): launches unified server+TUI mode\n- `am serve --no-tui`: launches server-only mode (current behavior, for headless/CI)\n- `am serve --tui-only`: TUI without server (connects to existing server) [future, stub for now]\n- Environment: TUI_ENABLED=true by default, TUI_ENABLED=false for headless\n\n### 4. Graceful shutdown sequence\n- TUI 'q' key -> sets shutdown_signal AtomicBool\n- SIGTERM/SIGINT handler -> sets shutdown_signal (registered via ctrlc crate or std::signal)\n- Server thread checks shutdown signal in accept loop\n- Background tasks (cleanup, retention, etc.) get shutdown signal\n- wbq_shutdown() flushes pending writes\n- Server thread joins within 5s timeout\n\n### 5. Fallback and failure behavior\n- If stdout is not a TTY: skip TUI, run server-only (current behavior)\n- If TUI panics: shut down server gracefully, print error to stderr\n- If server panics: TUI shows error overlay with reason, allows graceful exit\n- Auth failures at startup: TUI shows clear diagnostic with remediation steps\n- Endpoint unreachability: connection diagnostics panel with retry\n- Terminal capability limits: graceful degradation (mono/reduced/full modes)\n- Port-in-use: human-friendly error with suggestion to use different port\n- DB inaccessible: error overlay with path and permissions info\n\n### 6. Testing requirements\n- Unit tests for supervisor state transitions and shutdown ordering\n- Integration tests for TTY vs non-TTY launch selection\n- PTY readiness markers that br-10wc.13.x tests assert on (e.g., \"TUI_READY\" sentinel)\n\n## Technical Notes\n- The asupersync runtime MUST run on a background thread (not the main thread) because Program::run() blocks main\n- The ftui-runtime Program has its own event loop for terminal events\n- TUI tick (100ms) reads shared state for updates\n- The existing StartupDashboard should be disabled when TUI mode is active (they share stdout)\n- CLI args --host/--port still work, passed to server thread config\n\n## Files\n- MODIFY: crates/mcp-agent-mail-server/src/lib.rs (extract run_http_background, add run_tui)\n- MODIFY: crates/mcp-agent-mail/src/main.rs (wire TUI mode into Serve command)\n- MODIFY: scripts/am (add --no-tui flag)\n- MODIFY: crates/mcp-agent-mail-core/src/config.rs (add tui_enabled field)\n\n## Acceptance Criteria\n- `am serve` launches server+TUI, `am serve --no-tui` is headless\n- Ctrl+C, SIGTERM, and 'q' all shut down cleanly\n- Server processes requests while TUI renders\n- Non-TTY environments get headless mode automatically\n- Failure modes produce clear, actionable error messages\n- No resource leaks on shutdown\n- Unit tests for shutdown state machine","status":"closed","priority":0,"issue_type":"task","assignee":"RubyPrairie","created_at":"2026-02-07T03:20:25.686261677Z","created_by":"ubuntu","updated_at":"2026-02-07T22:06:14.597810114Z","closed_at":"2026-02-07T22:06:14.597778605Z","close_reason":"Implemented unified am entrypoint: run_http_with_tui() orchestrates MCP server on bg thread + TUI on main thread. Added --no-tui flag, TUI_ENABLED config, scripts/am support. 7 new tests (4 main.rs + 3 config.rs). All 434 server + 10 binary + 3 core tests pass.","source_repo":".","compaction_level":0,"original_size":0,"labels":["tui-entrypoint"],"dependencies":[{"issue_id":"br-10wc.18","depends_on_id":"br-10wc.15","type":"blocks","created_at":"2026-02-07T03:26:01.433417389Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.18","depends_on_id":"br-10wc.16","type":"blocks","created_at":"2026-02-07T03:21:38.971996225Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.18","depends_on_id":"br-10wc.17","type":"blocks","created_at":"2026-02-07T03:21:39.090437646Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.18","depends_on_id":"br-10wc.3","type":"parent-child","created_at":"2026-02-07T03:21:38.300414176Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.18","depends_on_id":"br-10wc.3.3","type":"blocks","created_at":"2026-02-07T03:21:39.202182097Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.18","depends_on_id":"br-10wc.3.4","type":"blocks","created_at":"2026-02-07T03:21:39.318048507Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.19","title":"Chrome shell: tab bar, status line, help overlay, command palette","description":"## Purpose\nBuild the outer chrome of the TUI application: the persistent UI elements that frame every screen. This includes the tab bar for navigation, status line for live metrics, help overlay for keybindings, and a command palette for fuzzy jump-to.\n\n## Background\nThe frankentui demo showcase has an excellent chrome implementation in chrome.rs (65KB). It handles tab rendering, status bar, help overlay, breadcrumbs, and mouse hit regions. We adapt this pattern but customize for Agent Mail's operational context.\n\n## Deliverables\n\n### 1. Tab Bar (top of screen)\n- Horizontal row of screen tabs with short labels\n- Active tab highlighted, inactive dimmed\n- Number key hints (1-7) shown on each tab\n- Mouse-clickable tabs (hit region registration)\n- Category grouping with separators\n- Responsive: collapses labels when terminal is narrow\n\n### 2. Status Line (bottom of screen)\n- Left: uptime, endpoint URL\n- Center: live counters (requests, agents online, messages)\n- Right: current time, theme name\n- Animated pulse indicator showing server is alive\n- Color-coded: green=healthy, yellow=degraded, red=error\n\n### 3. Help Overlay ('?' key)\n- Modal overlay listing all keybindings\n- Global section: Tab/Shift-Tab (nav), 1-7 (jump), q (quit), ? (help), Ctrl+P (palette)\n- Screen-specific section: keybindings from active screen\n- Dismissible with Esc or ?\n- Semi-transparent background (if terminal supports it)\n\n### 4. Command Palette (Ctrl+P)\n- Fuzzy search across screens, agents, threads, tools\n- Results grouped by category\n- Enter to jump, Esc to dismiss\n- Based on frankentui CommandPalette widget\n- Sources: screen names, agent names, thread subjects, tool names\n\n## Technical Notes\n- Chrome renders BEFORE the active screen (screen gets inner area)\n- Layout: [tab_bar(3)] [screen_content(fill)] [status_line(1)]\n- Tab bar uses Flex horizontal layout with Constraint::Min per tab\n- Status line uses Flex with Left/Center/Right sections\n- Help overlay renders on top of everything (z-order)\n- Command palette is a modal overlay\n- Mouse support: tab clicks, help dismiss\n- All chrome respects current theme colors\n\n## Files\n- NEW: crates/mcp-agent-mail-server/src/tui_chrome.rs\n\n## Acceptance Criteria\n- Tab bar renders correctly with all screen labels\n- Active tab visually distinct\n- Status line shows live metrics\n- Help overlay shows global + screen keybindings\n- Command palette opens, searches, and navigates\n- Mouse clicks on tabs work\n- Renders correctly at 80x24 minimum terminal size\n- Unit tests for tab rendering, status formatting","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T03:20:47.663156546Z","created_by":"ubuntu","updated_at":"2026-02-07T21:40:45.708310512Z","closed_at":"2026-02-07T21:40:45.708287158Z","close_reason":"Chrome shell complete. tui_chrome.rs: chrome_layout() 3-row split (tab_bar/content/status_line via Flex), render_tab_bar() with number keys + active highlighting + compact mode, render_status_line() with uptime + live request counters + error coloring + help hint, render_help_overlay() centered modal with Double border + global/screen-specific keybinding sections. Integrated into tui_app.rs view() method. 6 tests, 0 clippy warnings. Command palette deferred to br-10wc.9.1.","source_repo":".","compaction_level":0,"original_size":0,"labels":["tui-chrome"],"dependencies":[{"issue_id":"br-10wc.19","depends_on_id":"br-10wc.17","type":"blocks","created_at":"2026-02-07T03:21:39.475356644Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.19","depends_on_id":"br-10wc.5.1","type":"blocks","created_at":"2026-02-07T03:21:39.586302130Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.19","depends_on_id":"br-10wc.9","type":"parent-child","created_at":"2026-02-07T03:21:38.413272123Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.2","title":"[track] Architecture blueprint and module boundaries for AgentMailTUI","description":"Design a concrete architecture for AgentMailTUI using frankentui showcase patterns. Specify crate/module boundaries, state/update model, event contracts, and integration points with existing server/runtime so implementation can proceed in parallel without churn.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:17:54.093955565Z","created_by":"ubuntu","updated_at":"2026-02-07T03:54:03.505119511Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.2","depends_on_id":"br-10wc","type":"parent-child","created_at":"2026-02-07T03:17:54.093955565Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.2.1","title":"Reuse plan: extract/adapt ftui-demo-showcase patterns","description":"Identify reusable modules and patterns from /dp/frankentui ftui-demo-showcase. Document adapter strategy to avoid copy-paste drift and preserve maintainability.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-07T03:18:29.046043863Z","created_by":"ubuntu","updated_at":"2026-02-07T03:51:06.488086136Z","closed_at":"2026-02-07T03:51:06.488061009Z","close_reason":"Merged into br-10wc.17 (reuse plan captured in MailScreen deliverables)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.2.1","depends_on_id":"br-10wc.1.1","type":"blocks","created_at":"2026-02-07T03:20:31.684479109Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.2.1","depends_on_id":"br-10wc.2","type":"parent-child","created_at":"2026-02-07T03:18:29.046043863Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.2.2","title":"AgentMailTUI state model and deterministic reducer design","description":"Define typed app state, events, reducer/update rules, and side-effect boundaries so behavior is deterministic and highly testable under PTY and CI.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-07T03:18:29.146074043Z","created_by":"ubuntu","updated_at":"2026-02-07T03:51:06.627619144Z","closed_at":"2026-02-07T03:51:06.627592264Z","close_reason":"Design captured in implementation beads br-10wc.15/16/17","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.2.2","depends_on_id":"br-10wc.2","type":"parent-child","created_at":"2026-02-07T03:18:29.146074043Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.2.2","depends_on_id":"br-10wc.2.1","type":"blocks","created_at":"2026-02-07T03:20:31.798079646Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.2.3","title":"Module/crate boundaries and ownership map","description":"Specify where TUI runtime, transport adapters, event ingestion, screens, and persistence code will live. Include ownership map to reduce merge conflicts in multi-agent work.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T03:18:29.247739815Z","created_by":"ubuntu","updated_at":"2026-02-07T22:55:26.778893041Z","closed_at":"2026-02-07T22:55:26.778869938Z","close_reason":"Documented crate layering, server/TUI module map, and file reservation ownership globs in README.md","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.2.3","depends_on_id":"br-10wc.15","type":"blocks","created_at":"2026-02-07T03:49:28.565927029Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.2.3","depends_on_id":"br-10wc.2","type":"parent-child","created_at":"2026-02-07T03:18:29.247739815Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.2.3","depends_on_id":"br-10wc.2.2","type":"blocks","created_at":"2026-02-07T03:20:31.917365918Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.2.4","title":"Failure/fallback architecture and error surface design","description":"Design graceful behavior for auth failures, endpoint unreachability, startup races, and terminal capability limits. Ensure clear recovery guidance inside the TUI.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T03:18:29.351261583Z","created_by":"ubuntu","updated_at":"2026-02-07T03:51:06.764082189Z","closed_at":"2026-02-07T03:51:06.764057182Z","close_reason":"Merged into br-10wc.18 (failure/fallback section)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.2.4","depends_on_id":"br-10wc.2","type":"parent-child","created_at":"2026-02-07T03:18:29.351261583Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.2.4","depends_on_id":"br-10wc.2.2","type":"blocks","created_at":"2026-02-07T03:20:32.031138757Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.20","title":"Integration screen: Dashboard assembly and operational acceptance","description":"## Purpose\nThe Dashboard is the default landing screen -- the first thing operators see when launching am. It provides a real-time operational overview of the entire Agent Mail system.\n\n**Absorbs**: br-10wc.5.1 (activity stream pane), br-10wc.5.2 (KPI cards + trend visuals), br-10wc.5.3 (agent/project spotlight), br-10wc.5.4 (health alarms + quick actions)\n\n## Background\nThe current inline HUD (render_dashboard_frame in lib.rs) already renders stat tiles, sparklines, and agent lists. The new Dashboard screen replaces and vastly expands this into a full-screen layout with scrolling event log, dense metrics, and live indicators. It consolidates activity stream, KPI metrics, agent spotlight, and health alarms into a single cohesive surface.\n\n## Deliverables\n\n### Layout (responsive, adapts to terminal size)\n```\n+-----------------------------------------------------------+\n| [Server Info]  [DB Stats Table]  [Agents]  [Sparkline]    | <- stat tiles row\n+-----------------------------------------------------------+\n| Live Event Log (scrollable, auto-follow)                  | <- main content\n|  z 14:23:01.234 ToolCall send_message [GoldFox] 12ms     |\n|  M 14:23:01.456 Message #42 -> SilverWolf [br-123]       |\n|  L 14:23:02.001 Reservation granted src/** [GoldFox]     |\n|  z 14:23:02.123 ToolCall fetch_inbox [SilverWolf] 3ms    |\n|  ...                                                     |\n+-----------------------------------------------------------+\n| Req: 1,234  Avg: 8ms  2xx: 1,200  4xx: 30  5xx: 4  [!2] | <- footer + alarms\n+-----------------------------------------------------------+\n```\n\n### Stat Tiles (top row, 3-4 columns)\n1. Server Info: endpoint, uptime, auth status, environment\n2. DB Stats Table: projects/agents/messages/reservations/contacts with delta indicators (up/down arrows)\n3. Active Agents spotlight: list with last-active time, color-coded recency, recent thread activity, reservation pressure\n4. Request Rate Sparkline: 60-point sparkline of requests/sec\n\n### KPI Metrics (integrated into stat tiles + footer)\n- Throughput: requests/sec with trend arrow\n- Error rate: 4xx + 5xx percentage with threshold coloring (green <1%, yellow <5%, red >5%)\n- Latency: P50/P95 with trend (if available from tool metrics)\n- Messages/min: mail throughput\n- Active reservations: count with conflict indicator\n\n### Agent/Project Spotlight (in stat tile area)\n- Currently active agents with program/model info\n- Recent thread activity per agent\n- Reservation pressure (% of files under exclusive reservation)\n- Agents sorted by recency, color-coded: green (active <5m), yellow (idle <30m), dim (inactive)\n\n### Live Event Log (main area)\n- Scrolling log of MailEvent items, newest at bottom\n- Auto-follow mode (toggleable with 'f' key)\n- Each event rendered as compact, high-density card:\n  - Timestamp (HH:MM:SS.mmm)\n  - Icon by type (tool call, message, reservation, etc.)\n  - Color by type, severity-aware (errors in red, warnings in yellow)\n  - One-line summary with key fields\n- Scroll with j/k or arrow keys\n- Filter by event type with 't' key (toggleable filter chips)\n- Consistent iconography and severity badges across all event types\n\n### Health Alarms (footer area)\n- Actionable alerts: auth/path failures, backlog growth, event drops, DB errors\n- Badge count [!N] in footer when alarms active\n- Quick-action keys: press 'a' to acknowledge, 'd' to dismiss, Enter to expand details\n- Alarm severity: critical (red pulsing), warning (yellow), info (dim)\n- Example alarms: \"Auth token expired\", \"WBQ backlog > 100\", \"3 events dropped (buffer full)\"\n\n### Footer Stats Bar\n- Request counters: total, 2xx, 4xx, 5xx\n- Average latency\n- Event buffer depth (with drop count if any)\n- DB query count\n- Alarm badge\n\n## Technical Notes\n- Reads from TuiSharedState.recent_events() on each tick\n- Stat tiles refresh every 1s (10 ticks), event log refreshes every tick\n- Use ftui Table widget for DB stats (with Row highlight on change)\n- Use ftui Sparkline widget for request rate\n- Use ftui Paragraph with styled spans for event log entries\n- Log entry rendering: format_event(event: &MailEvent) -> Line\n- Delta indicators: compare current vs previous DbStatSnapshot\n- Build on patterns from existing render_dashboard_frame() in lib.rs\n\n## Files\n- NEW: crates/mcp-agent-mail-server/src/tui_screens/dashboard.rs\n\n## Acceptance Criteria\n- Dashboard renders at 80x24 and 200x50 without panic\n- Event log scrolls smoothly with 10k+ events\n- Stat tiles show correct values from TuiSharedState\n- Sparkline updates live\n- j/k scroll, f toggle follow mode, t toggle type filter\n- Health alarms appear within 1 tick of trigger condition\n- Agent spotlight shows correct recency coloring\n- Unit tests for format_event(), delta calculation, alarm trigger logic","status":"closed","priority":1,"issue_type":"task","assignee":"RubyPrairie","created_at":"2026-02-07T03:21:13.923995685Z","created_by":"ubuntu","updated_at":"2026-02-07T22:28:06.767891480Z","closed_at":"2026-02-07T22:28:06.767861013Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"labels":["tui-screen"],"dependencies":[{"issue_id":"br-10wc.20","depends_on_id":"br-10wc.15","type":"blocks","created_at":"2026-02-07T03:26:10.547361382Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.20","depends_on_id":"br-10wc.19","type":"blocks","created_at":"2026-02-07T03:23:59.596301805Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.20","depends_on_id":"br-10wc.27","type":"blocks","created_at":"2026-02-07T03:26:10.750071509Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.20","depends_on_id":"br-10wc.28","type":"blocks","created_at":"2026-02-07T03:26:10.876718549Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.20","depends_on_id":"br-10wc.5","type":"parent-child","created_at":"2026-02-07T03:23:58.305476972Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.21","title":"Integration screen: Message Browser search and detail workflow","description":"## Purpose\nFull-text search and browsing across all messages and operational events in the system. This is the primary way operators find and inspect specific messages and events.\n\n**Absorbs**: br-10wc.6.1 (unified indexed search), br-10wc.6.2 (virtualized result list + keyboard-first nav)\n\n## Background\nThe Python server had search_messages and search_messages_product tools that use FTS5. The Rust port has full FTS support with sanitize_fts_query(). This screen wraps that search capability in an interactive TUI with a search bar, results list, and detail panel. Search spans both the message archive (DB FTS5) and the live event stream (in-memory ring buffer) with unified field scoping and stable ranking.\n\n## Deliverables\n\n### Layout\n```\n+--------------------------------------------------------+\n| Search: [___________________________] [Filters v]      | <- search bar\n+---------------------------+----------------------------+\n| Results (virtualized)     | Message Detail             |\n| > #42 Re: br-123 feat    | From: GoldFox              |\n|   #41 Status update       | To: SilverWolf             |\n|   #40 [br-120] Start      | Subject: Re: [br-123] feat |\n|   #39 Question about...   | Thread: br-123             |\n|   ...                     | Time: 2026-02-06 14:23     |\n|                           | --------------------------  |\n|                           | Body (markdown rendered):  |\n|                           | Implementation is complete.|\n|                           |                            |\n|                           | Attachments: 0             |\n|                           | Ack: required (pending)    |\n+---------------------------+----------------------------+\n| 234 results  Page 1/24  Ctrl+N: next  Ctrl+P: prev    |\n+--------------------------------------------------------+\n```\n\n### Search Bar\n- Text input with cursor (ftui TextInput widget)\n- Live search: updates results as you type (debounced 200ms)\n- Search uses sanitize_fts_query() for safe FTS5 queries\n- Falls back to LIKE when FTS fails\n- Dual-scope: searches DB messages AND live MailEvent stream\n- Filter dropdown: by project, agent, importance, date range, event type\n\n### Results List (left pane, keyboard-first)\n- Virtualized scrolling (handles 100k+ results efficiently)\n- Each result: message ID, subject (truncated), from agent, timestamp\n- Highlighted match terms in subject\n- j/k or arrow keys to navigate (keyboard is primary, mouse augments)\n- Enter to select -> shows in detail panel\n- Focus indicator: bold/highlighted current row\n- Smooth scrolling with no flicker even at high result counts\n\n### Detail Panel (right pane)\n- Full message metadata: from, to, cc, bcc, subject, thread_id, project\n- Timestamps: sent, read, acknowledged\n- Body: markdown rendered (using comrak or ftui markdown renderer)\n- Attachment list (if any)\n- Ack status indicator\n- 'r' key: scroll to related thread messages\n\n## Technical Notes\n- Uses DB polling connector (br-10wc.27) to execute search queries\n- Search queries go through the storage layer's search_messages()\n- Live event search: filter EventRingBuffer with text matching\n- Results cached locally to avoid re-querying on scroll\n- Virtualized rendering: only render visible rows\n- Inspired by frankentui Shakespeare search + VirtualizedSearch screens\n- The FTS5 table is fts_messages in exported DBs, messages_fts in live DBs\n- Debounce: don't search on every keystroke, wait 200ms after last input\n\n## Files\n- NEW: crates/mcp-agent-mail-server/src/tui_screens/messages.rs\n\n## Acceptance Criteria\n- Search returns results matching FTS5 queries\n- Results scroll smoothly with 10k+ hits\n- Detail panel shows full message content\n- Markdown body renders correctly\n- Filter by project/agent works\n- Empty query shows recent messages\n- Keyboard navigation is fluid (j/k, Enter, Esc, /)\n- Live event search returns real-time results\n- Unit tests for result formatting, query debouncing, dual-scope merging","status":"closed","priority":1,"issue_type":"task","assignee":"RubyPrairie","created_at":"2026-02-07T03:21:39.747983546Z","created_by":"ubuntu","updated_at":"2026-02-07T22:59:43.239550980Z","closed_at":"2026-02-07T22:59:43.239521135Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"labels":["tui-screen"],"dependencies":[{"issue_id":"br-10wc.21","depends_on_id":"br-10wc.15","type":"blocks","created_at":"2026-02-07T03:26:16.192735954Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.21","depends_on_id":"br-10wc.19","type":"blocks","created_at":"2026-02-07T03:24:00.185863278Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.21","depends_on_id":"br-10wc.27","type":"blocks","created_at":"2026-02-07T03:26:16.386781147Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.21","depends_on_id":"br-10wc.6","type":"parent-child","created_at":"2026-02-07T03:23:58.424095739Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.22","title":"Integration screen: Thread Explorer conversation workflow","description":"## Purpose\nBrowse and inspect message threads. Threads are the primary organizational unit in Agent Mail -- most agent workflows use thread_id to group related messages (e.g., br-123 for a bead's discussion).\n\n## Deliverables\n\n### Layout\n```\n\n Threads (sorted by last activity)                      \n\n Thread List               Thread Detail               \n  br-123 (5 msgs, 2 ag)  Thread: br-123              \n   br-120 (3 msgs, 1 ag)  Participants: GoldFox,      \n   FEAT-45 (12 msgs, 4a)    SilverWolf                \n   general (28 msgs)      Messages: 5                 \n                           Last: 2026-02-06 14:23      \n                                  \n                           [1] GoldFox 14:20           \n                             Starting work on br-123   \n                           [2] SilverWolf 14:21        \n                             Acknowledged. Reserving   \n                             src/foo.rs                \n                           [3] GoldFox 14:23           \n                             Implementation complete.  \n                             PR #45 ready for review.  \n\n```\n\n### Thread List (left pane)\n- All unique thread_ids sorted by last activity timestamp\n- Each entry: thread_id, message count, participant count, last activity\n- j/k navigation, Enter to expand\n- '/' to search/filter threads by name\n\n### Thread Detail (right pane)\n- Thread metadata: id, participants, message count, date range\n- Chronological message list (expandable)\n- Each message: sender, timestamp, body preview\n- Expand/collapse individual messages with Enter\n- Full markdown rendering for expanded messages\n- Thread summary (if LLM summarization is available)\n\n## Technical Notes\n- Thread data from storage.list_threads() or equivalent query\n- Group messages by thread_id in the DB\n- Cache thread list, refresh on tick if new messages arrive\n- Participant list: unique agents who sent messages in thread\n- Thread summary: call summarize_thread if ANTHROPIC_API_KEY is set\n\n## Files\n- NEW: crates/mcp-agent-mail-server/src/tui_screens/threads.rs\n\n## Acceptance Criteria\n- Thread list shows all threads sorted by recency\n- Thread detail shows all messages in chronological order\n- Message expand/collapse works\n- Search/filter by thread name works\n- Unit tests for thread aggregation, participant extraction","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-07T03:21:57.915628665Z","created_by":"ubuntu","updated_at":"2026-02-07T03:45:11.577153541Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["tui-screen"],"dependencies":[{"issue_id":"br-10wc.22","depends_on_id":"br-10wc.15","type":"blocks","created_at":"2026-02-07T03:26:16.515064931Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.22","depends_on_id":"br-10wc.19","type":"blocks","created_at":"2026-02-07T03:26:16.637695610Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.22","depends_on_id":"br-10wc.21","type":"blocks","created_at":"2026-02-07T03:24:00.304016874Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.22","depends_on_id":"br-10wc.27","type":"blocks","created_at":"2026-02-07T03:26:16.771037926Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.22","depends_on_id":"br-10wc.6","type":"parent-child","created_at":"2026-02-07T03:23:58.540725462Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.22","depends_on_id":"br-10wc.7.2","type":"blocks","created_at":"2026-02-07T03:45:11.577065406Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.22","depends_on_id":"br-10wc.7.3","type":"blocks","created_at":"2026-02-07T03:24:00.423154573Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.23","title":"Integration screen: Agent Roster operational view","description":"## Purpose\nProvide a comprehensive view of all registered agents across all projects. Shows who is active, what they're working on (reservations), and who can communicate with whom (contact graph).\n\n## Deliverables\n\n### Layout\n```\n\n Agents (sorted by last activity)                       \n\n Agent List                Agent Detail                \n  GoldFox  cc/opus-4.6  Name: GoldFox               \n  SilverWolf  cod/5.2   Program: claude-code         \n  CopperIsle  cc/son    Model: opus-4.6             \n  RubyPrairie cc/opus   Project: /dp/mcp_agent_mail \n                           Last active: 2m ago         \n                                  \n                           Activity:       \n                           Messages sent: 42           \n                           Messages received: 38       \n                           Reservations: 2 active      \n                            - src/** (excl, 45m left)  \n                            - tests/** (shared)        \n                           Contacts: SilverWolf, Ruby  \n                           Policy: contacts_only       \n\n```\n\n### Agent List (left pane)\n- All registered agents across all projects\n- Status indicator:  active (<5m),  idle (5-30m),  inactive (>30m)\n- Name, program (claude-code/codex-cli/etc.), model\n- j/k navigation, Enter to select\n\n### Agent Detail (right pane)\n- Full agent metadata: name, program, model, project, task_description\n- Last activity timestamp (relative)\n- Activity sparkline: message rate over last hour\n- Message stats: sent/received counts\n- Active reservations: paths, exclusive/shared, TTL remaining\n- Contact list: agents they can message\n- Contact policy: open/auto/contacts_only/block_all\n\n## Technical Notes\n- Agent data from queries::list_agents() across all projects\n- Activity recency from last_active_ts field\n- Sparkline data: aggregate message timestamps per agent per minute\n- Reservation data: join with file_reservations table\n- Contact data: from contact_links table\n\n## Files\n- NEW: crates/mcp-agent-mail-server/src/tui_screens/agents.rs\n\n## Acceptance Criteria\n- Agent list shows all agents with correct status indicators\n- Agent detail shows comprehensive stats\n- Activity sparkline updates\n- Reservation list with TTL countdown\n- Unit tests for status classification, sparkline aggregation","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-07T03:22:15.619692671Z","created_by":"ubuntu","updated_at":"2026-02-07T03:49:29.380085625Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["tui-screen"],"dependencies":[{"issue_id":"br-10wc.23","depends_on_id":"br-10wc.15","type":"blocks","created_at":"2026-02-07T03:26:16.898930837Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.23","depends_on_id":"br-10wc.19","type":"blocks","created_at":"2026-02-07T03:24:00.773544480Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.23","depends_on_id":"br-10wc.20","type":"blocks","created_at":"2026-02-07T03:49:29.380028648Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.23","depends_on_id":"br-10wc.27","type":"blocks","created_at":"2026-02-07T03:26:17.093236328Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.23","depends_on_id":"br-10wc.5","type":"parent-child","created_at":"2026-02-07T03:23:58.664016889Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.23","depends_on_id":"br-10wc.5.3","type":"blocks","created_at":"2026-02-07T03:24:00.541293783Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.23","depends_on_id":"br-10wc.7.3","type":"blocks","created_at":"2026-02-07T03:24:00.659087696Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.24","title":"Integration screen: File Reservations conflict workflow","description":"## Purpose\nReal-time view of all file reservations across all projects. Reservations are critical for multi-agent coordination -- this screen makes conflicts, expirations, and ownership instantly visible.\n\n## Deliverables\n\n### Layout\n```\n\n File Reservations  [Active: 12]  [Expired: 45]         \n\n Reservation Tree          Detail / Conflicts          \n  /dp/mcp_agent_mail    Path: src/**                \n    src/** [GoldFox]   Agent: GoldFox              \n     exclusive, 45m left  Exclusive: yes              \n    tests/** [Silver]  TTL: 45m remaining          \n     shared, 2h left      Granted: 14:20:00           \n    docs/* [Ruby]      Expires: 15:05:00           \n      exclusive, 20m left  Reason: br-123              \n  /dp/fastmcp_rust             \n    src/** [Copper]     Potential conflicts:      \n      shared, 1h left       - SilverWolf wants src/x   \n                              (blocked by exclusive)   \n\n```\n\n### Reservation Tree (left pane)\n- Grouped by project (folder icon)\n- Each reservation: lock icon ( exclusive,  shared), path pattern, agent, TTL\n- TTL color-coded: green (>30m), yellow (5-30m), red (<5m), flash when <1m\n- Sort: by project, then by expiry (soonest first)\n- Expired reservations shown dimmed (toggleable with 'e' key)\n\n### Detail Panel (right pane)\n- Full reservation metadata\n- Reason field (often br-### for bead reference)\n- Conflict detection: other agents requesting overlapping paths\n- History: recent grant/release events for this path pattern\n\n### Interactive Controls\n- 'r' key: refresh reservation data\n- 'e' key: toggle expired reservations\n- Enter: expand/collapse project group\n\n## Technical Notes\n- Data from queries::list_file_reservations() per project\n- TTL countdown: calculate from expires_ts - now_micros()\n- Conflict detection: check overlapping glob patterns (use globset crate)\n- Tree rendering: use indented Paragraph or custom tree widget\n- Expired filtering: WHERE expires_ts > now_micros() for active\n\n## Files\n- NEW: crates/mcp-agent-mail-server/src/tui_screens/reservations.rs\n\n## Acceptance Criteria\n- Tree shows all reservations grouped by project\n- TTL countdown updates each tick\n- Color coding by time remaining\n- Conflict detection highlights overlapping reservations\n- Toggle expired works\n- Unit tests for TTL formatting, conflict detection","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-07T03:22:35.560052177Z","created_by":"ubuntu","updated_at":"2026-02-07T03:44:33.740529888Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["tui-screen"],"dependencies":[{"issue_id":"br-10wc.24","depends_on_id":"br-10wc.15","type":"blocks","created_at":"2026-02-07T03:26:22.077772901Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.24","depends_on_id":"br-10wc.19","type":"blocks","created_at":"2026-02-07T03:26:22.198790740Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.24","depends_on_id":"br-10wc.27","type":"blocks","created_at":"2026-02-07T03:26:22.326864731Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.24","depends_on_id":"br-10wc.7","type":"parent-child","created_at":"2026-02-07T03:23:58.786548072Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.24","depends_on_id":"br-10wc.7.2","type":"blocks","created_at":"2026-02-07T03:24:00.893261765Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.24","depends_on_id":"br-10wc.8.3","type":"blocks","created_at":"2026-02-07T03:24:01.012930689Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.25","title":"Integration screen: Tool Metrics analytics workflow","description":"## Purpose\nDetailed performance analytics for every MCP tool. Shows call frequency, latency distribution, error rates, and database query patterns per tool.\n\n## Background\nThe Rust port already has a tool_metrics module with tool_metrics_snapshot_full() that returns per-tool call counts, error counts, and timing data. The tooling/metrics resource exposes this as JSON. This screen visualizes that data.\n\n## Deliverables\n\n### Layout\n```\n\n Tool Metrics  [23 tools]  [1,234 total calls]          \n\n Tool            Calls  Errors  Avg(ms) P95(ms)  Rate  \n send_message      342      2    12ms    45ms     \n fetch_inbox       298      0     3ms     8ms     \n register_agent    156      1     8ms    22ms     \n file_reservation   89      0    15ms    38ms     \n search_messages    67      5    45ms   120ms     \n ...                                                    \n\n Selected: send_message                                 \n  Latency Distribution   Query Breakdown \n                  messages: 45 queries   \n  0ms    50ms   100ms        agents: 12 queries     \n                             projects: 8 queries    \n  p50=12ms p95=45ms          Total: 65 in 8.2ms    \n  \n\n```\n\n### Tool Table (top area)\n- All tools sorted by call count (descending)\n- Columns: name, calls, errors, avg latency, p95 latency, rate sparkline\n- Error column red-highlighted when >0\n- Latency color-coded: green (<10ms), yellow (10-100ms), red (>100ms)\n- j/k to navigate, Enter to select for detail view\n\n### Detail Panel (bottom area, shown for selected tool)\n- Latency distribution bar chart (histogram buckets)\n- Per-table query breakdown (from QueryTracker data)\n- Error rate trend sparkline\n- Recent error messages (if any)\n- Call rate over time (minute-by-minute)\n\n## Technical Notes\n- Data from mcp_agent_mail_tools::tool_metrics_snapshot_full()\n- QueryTracker provides per-table query counts\n- Sparkline data: aggregate call timestamps per minute\n- P95 calculation: sort latencies, take 95th percentile\n- The data is already tracked by InstrumentedTool and record_call()/record_error()\n- Use ftui Table for the tool list, BarChart for histogram, Sparkline for trends\n\n## Files\n- NEW: crates/mcp-agent-mail-server/src/tui_screens/tool_metrics.rs\n\n## Acceptance Criteria\n- All 23 tools shown with correct metrics\n- Sparklines update with new calls\n- Latency histogram renders for selected tool\n- Error highlighting works\n- Query breakdown shows per-table counts\n- Unit tests for percentile calculation, histogram bucketing","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-07T03:22:58.686594537Z","created_by":"ubuntu","updated_at":"2026-02-07T03:45:11.712014979Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["tui-screen"],"dependencies":[{"issue_id":"br-10wc.25","depends_on_id":"br-10wc.11.3","type":"blocks","created_at":"2026-02-07T03:24:01.252045699Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.25","depends_on_id":"br-10wc.15","type":"blocks","created_at":"2026-02-07T03:26:22.452567132Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.25","depends_on_id":"br-10wc.19","type":"blocks","created_at":"2026-02-07T03:26:22.575287048Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.25","depends_on_id":"br-10wc.28","type":"blocks","created_at":"2026-02-07T03:26:22.699550675Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.25","depends_on_id":"br-10wc.5.2","type":"blocks","created_at":"2026-02-07T03:45:11.711934539Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.25","depends_on_id":"br-10wc.7","type":"parent-child","created_at":"2026-02-07T03:23:58.900814670Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.25","depends_on_id":"br-10wc.7.2","type":"blocks","created_at":"2026-02-07T03:24:01.132239318Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.26","title":"Integration screen: System Health diagnostics workflow","description":"## Purpose\nLow-level system health monitoring for operators. Shows database connection pool state, query execution metrics, write-behind queue depth, and full server configuration.\n\n## Deliverables\n\n### Layout\n```\n\n System Health                                          \n\n Database                  Server Config               \n Pool size: 8/16           Version: 0.1.0              \n Active: 3                 Endpoint: http://127...     \n Idle: 5                   Auth: enabled (bearer)      \n Waiting: 0                Transport: HTTP             \n Queries total: 12,456     Tool profile: full          \n Avg query: 0.8ms          Instrumentation: on         \n Slow queries (>50ms): 3   Storage: /dp/mcp_agent_...  \n      Console theme: cyberpunk    \n Write-Behind Queue               \n Pending commits: 2        Runtime                     \n Last flush: 3s ago        Uptime: 2h 34m 12s         \n Total flushed: 89         PID: 12345                  \n      Rust: nightly-2026-01-30    \n Query Tracking            Platform: linux x86_64      \n Tracked tables: 8         SQLite: 3.45.0              \n Top: messages (4,521)     Workers: cleanup, ack_ttl,  \n      agents (2,100)         tool_metrics, retention   \n      projects (1,890)       wbq                       \n\n```\n\n### Database Section\n- Connection pool metrics (from DbPool stats if available)\n- Total query count and average latency\n- Slow query count (threshold from config)\n- Write-behind queue: pending commits, last flush time, total flushed\n- Per-table query distribution (top 5 tables)\n\n### Server Config Section\n- Full configuration dump (sanitized -- no secrets)\n- Version and build info\n- Runtime metadata: uptime, PID, platform\n- Active background workers list with status\n\n## Technical Notes\n- Pool stats: may need to expose from sqlmodel-pool crate\n- Query tracking: from global QUERY_TRACKER (already instrumented)\n- WBQ stats: from mcp_agent_mail_storage::wbq module\n- Config: from Config struct (sanitize database_url with mask)\n- Build info: from env!(CARGO_PKG_VERSION) + platform info\n- Refresh rate: every 2s (20 ticks)\n\n## Files\n- NEW: crates/mcp-agent-mail-server/src/tui_screens/system_health.rs\n\n## Acceptance Criteria\n- All sections display correct live data\n- No secrets visible (database URLs masked)\n- Background worker status shown\n- Unit tests for stat formatting","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-07T03:23:20.145988743Z","created_by":"ubuntu","updated_at":"2026-02-07T03:44:34.005362484Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["tui-screen"],"dependencies":[{"issue_id":"br-10wc.26","depends_on_id":"br-10wc.10.2","type":"blocks","created_at":"2026-02-07T03:24:01.367523034Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.26","depends_on_id":"br-10wc.11","type":"parent-child","created_at":"2026-02-07T03:23:59.020512227Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.26","depends_on_id":"br-10wc.11.1","type":"blocks","created_at":"2026-02-07T03:24:01.483788385Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.26","depends_on_id":"br-10wc.15","type":"blocks","created_at":"2026-02-07T03:26:22.824651689Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.26","depends_on_id":"br-10wc.19","type":"blocks","created_at":"2026-02-07T03:24:01.715198589Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.26","depends_on_id":"br-10wc.27","type":"blocks","created_at":"2026-02-07T03:26:23.008702549Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.27","title":"Data-plane (pull): DB polling connector feeding TUI state","description":"## Purpose\nPeriodic background data fetcher that queries the SQLite database and pushes results into TuiSharedState. This provides the 'pull' data channel (vs the 'push' channel from server hooks).\n\n## Background\nThe TUI needs fresh data from the DB that isn't captured by server hooks alone. For example: total message counts, thread lists, agent lists, and reservation state need periodic queries. The current StartupDashboard does this in a worker thread with sleep-based polling.\n\n## Deliverables\n\n### 1. DbPoller struct\n```rust\npub struct DbPoller {\n    state: Arc<TuiSharedState>,\n    interval: Duration,   // default 2s\n    stop: Arc<AtomicBool>,\n}\n```\n\n### 2. Polling loop (runs on dedicated thread)\n- Every interval:\n  1. Open sync SQLite connection (using open_db_sync pattern from CLI)\n  2. Query aggregate stats (projects, agents, messages, reservations, contacts)\n  3. Query agent list with last_active_ts\n  4. Query recent messages (last 100) for message browser pre-cache\n  5. Push DbStatSnapshot into TuiSharedState\n  6. Emit HealthPulse MailEvent\n\n### 3. Efficient delta detection\n- Compare current stats with previous snapshot\n- Only push MailEvent if stats changed\n- Track which specific counters changed for delta indicators\n\n### 4. Thread management\n- start() -> JoinHandle spawns the polling thread\n- stop() sets AtomicBool, thread exits on next cycle\n- Graceful shutdown with timeout\n\n## Technical Notes\n- Use sync SQLite (not async pool) because this runs on a dedicated thread, not the asupersync runtime\n- Pattern: sqlmodel_sqlite::SqliteConnection::open(db_path)\n- Queries use query_sync() with sqlmodel_core::Value parameters\n- The DB path comes from Config.database_url\n- Polling interval configurable via CONSOLE_POLL_INTERVAL_MS env var\n- Must handle DB locked errors gracefully (WAL mode helps but concurrent writers exist)\n\n## Files\n- NEW: crates/mcp-agent-mail-server/src/tui_poller.rs\n\n## Acceptance Criteria\n- Poller thread starts and stops cleanly\n- DbStatSnapshot updates in TuiSharedState every interval\n- Delta detection works (only emits events on change)\n- Handles DB errors without crashing\n- Unit tests for delta detection logic","status":"closed","priority":1,"issue_type":"task","assignee":"RubyPrairie","created_at":"2026-02-07T03:23:40.752357184Z","created_by":"ubuntu","updated_at":"2026-02-07T21:54:40.161567513Z","closed_at":"2026-02-07T21:54:40.161494847Z","close_reason":"Implemented tui_poller.rs with DbPoller struct, sync SQLite polling thread, delta detection (SnapshotDelta), HealthPulse event emission, configurable interval (CONSOLE_POLL_INTERVAL_MS), graceful shutdown. 15 unit tests: 5 delta detection, 2 error handling, 2 connection, 2 handle lifecycle, 2 integration (pushes stats, skips no-change), 2 construction. 0 clippy warnings.","source_repo":".","compaction_level":0,"original_size":0,"labels":["tui-data"],"dependencies":[{"issue_id":"br-10wc.27","depends_on_id":"br-10wc","type":"parent-child","created_at":"2026-02-07T03:23:40.752357184Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.27","depends_on_id":"br-10wc.15","type":"blocks","created_at":"2026-02-07T03:26:05.827017184Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.27","depends_on_id":"br-10wc.16","type":"blocks","created_at":"2026-02-07T03:26:05.961210713Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.27","depends_on_id":"br-10wc.4.1","type":"blocks","created_at":"2026-02-07T03:45:11.297931632Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.28","title":"Data-plane (push): server hook integration emitting MailEvents","description":"## Purpose\nWire the MCP server's existing instrumentation points to emit typed MailEvents into the TuiSharedState. This provides real-time 'push' events for the TUI (vs the 'pull' polling from br-10wc.27). Also enforces sensitive-data masking policy at the event construction boundary.\n\n**Absorbs**: br-10wc.4.4 (sensitive-data masking policy enforcement in event pipeline)\n\n## Background\nThe server already has InstrumentedTool which wraps every tool call with timing/error tracking (record_call, record_error). The HTTP handler tracks request metrics. We need to tap these existing hooks to also produce MailEvents. The existing console.rs has mask_json(), mask_sensitive_value(), is_sensitive_key() for redacting secrets -- these must be applied at event construction time to ensure no sensitive data leaks into the ring buffer.\n\n## Deliverables\n\n### 1. InstrumentedTool event emission\n- In call()/call_async(): emit MailEvent::ToolCallStart before calling inner\n- After inner returns: emit MailEvent::ToolCallEnd with duration, result preview, query stats\n- Extract project/agent from tool arguments (parse 'project_key' and agent name params)\n- Result preview: first 200 chars of JSON result (masked for sensitive values)\n- Query stats: snapshot from QueryTracker before/after call for per-call query counts\n\n### 2. HTTP handler event emission\n- In HttpState::handle(): emit MailEvent::HttpRequest after processing\n- Include: method, path, status code, duration_ms, client IP\n- Rate limit: don't emit for /healthz or high-frequency polling endpoints\n\n### 3. Message lifecycle events\n- In send_message tool: emit MailEvent::MessageSent\n- In fetch_inbox tool (when new messages returned): emit MailEvent::MessageReceived (per message)\n- In file_reservation_paths: emit MailEvent::ReservationGranted / ReservationReleased\n- In register_agent: emit MailEvent::AgentRegistered\n\n### 4. Sensitive-data masking (centralized, once)\n- Apply mask_json() / mask_sensitive_value() when constructing MailEvent payloads\n- Fields to mask: params_json (tool arguments may contain tokens/secrets), result_preview, body content\n- Masking happens at event CREATION time so the ring buffer never contains raw secrets\n- Allowlist: tool_name, agent_name, project, timestamps, durations are never masked\n- Denylist: HTTP_BEARER_TOKEN, password, secret, api_key patterns\n- Audit metadata: events carry a `redacted: bool` flag so consumers know masking was applied\n- Tests: verify masked events in ring buffer don't contain known secret patterns\n\n### 5. Wiring\n- Store Arc<TuiSharedState> in a global static (matches existing set_dashboard_handle pattern)\n- static TUI_STATE: LazyLock<Mutex<Option<Arc<TuiSharedState>>>>\n\n## Technical Notes\n- The existing record_call/record_error already track metrics globally\n- We ADD event emission alongside, not replacing\n- MailEvent emission must be non-blocking (try_lock on ring buffer)\n- If lock contention, drop the event rather than blocking the tool call\n- Keep event creation allocation-minimal: clone minimal data from tool params\n- Masking must be consistent: same field always masked the same way, audit-friendly\n\n## Files\n- MODIFY: crates/mcp-agent-mail-server/src/lib.rs (InstrumentedTool, HttpState::handle)\n- NEW or MODIFY: crates/mcp-agent-mail-server/src/tui_bridge.rs (global accessor)\n\n## Acceptance Criteria\n- Tool calls produce MailEvent::ToolCallStart/End with correct data\n- HTTP requests produce MailEvent::HttpRequest\n- Message/reservation/agent events flow correctly\n- Events appear in TUI Dashboard event log within one tick (100ms)\n- No performance regression: event emission adds <1ms per tool call\n- Events are dropped (not blocking) if ring buffer lock is contended\n- Sensitive data (tokens, passwords) NEVER appears in ring buffer events\n- Unit tests: mock tool call produces expected events with masking applied","status":"closed","priority":1,"issue_type":"task","assignee":"RubyPrairie","created_at":"2026-02-07T03:24:03.210902430Z","created_by":"ubuntu","updated_at":"2026-02-07T22:17:00.196257709Z","closed_at":"2026-02-07T22:17:00.196229056Z","close_reason":"Implemented server hook integration emitting MailEvents: (1) Global TUI_STATE for event emission from any code path. (2) InstrumentedTool emits ToolCallStart/End with masked params, query delta, and result preview. (3) HttpState::handle() emits HttpRequest events (skips /healthz). (4) Helper functions: extract_project_agent, result_preview_from_contents, query_delta. (5) Sensitive data masked at event creation via console::mask_json(). 10 new tests, 444 total passing, 0 clippy warnings.","source_repo":".","compaction_level":0,"original_size":0,"labels":["tui-data"],"dependencies":[{"issue_id":"br-10wc.28","depends_on_id":"br-10wc","type":"parent-child","created_at":"2026-02-07T03:24:03.210902430Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.28","depends_on_id":"br-10wc.15","type":"blocks","created_at":"2026-02-07T03:26:06.094292270Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.28","depends_on_id":"br-10wc.16","type":"blocks","created_at":"2026-02-07T03:26:06.222344951Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.28","depends_on_id":"br-10wc.4.1","type":"blocks","created_at":"2026-02-07T03:45:11.435793100Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.29","title":"Theme integration: map console theme IDs to ftui Style palettes","description":"## Purpose\nEnsure the TUI uses the same theming system as the existing console. The server already has multiple theme presets (cyberpunk_aurora, midnight, etc.) defined in theme.rs. Map these to ftui Style palettes so the TUI is visually consistent.\n\n## Deliverables\n\n### 1. Theme palette struct\n```rust\npub struct TuiThemePalette {\n    pub primary: PackedRgba,\n    pub secondary: PackedRgba,\n    pub accent: PackedRgba,\n    pub success: PackedRgba,\n    pub warning: PackedRgba,\n    pub error: PackedRgba,\n    pub text: PackedRgba,\n    pub text_dim: PackedRgba,\n    pub background: PackedRgba,\n    pub border: PackedRgba,\n    pub tab_active: PackedRgba,\n    pub tab_inactive: PackedRgba,\n    pub sparkline: PackedRgba,\n    pub table_header: PackedRgba,\n    pub table_row_alt: PackedRgba,\n}\n```\n\n### 2. Theme mapping\n- Convert existing theme::primary_bold() etc. ANSI color functions to PackedRgba values\n- Each named theme (cyberpunk_aurora, midnight, etc.) gets a TuiThemePalette\n- Theme selection: from CONSOLE_THEME env var (same as current)\n- Hot-reload: 'T' key cycles through available themes\n\n### 3. Style helpers\n- style_for_event(kind: MailEventKind) -> Style (icon + color per event type)\n- style_for_status(status: u16) -> Style (HTTP status color coding)\n- style_for_latency(ms: u64) -> Style (green/yellow/red gradient)\n- style_for_agent_recency(last_active: Duration) -> Style (green/yellow/red)\n- style_for_ttl(remaining: Duration) -> Style (green/yellow/red/flash)\n\n## Technical Notes\n- The existing theme.rs uses ANSI escape codes (e.g., \\x1b[38;2;r;g;bm)\n- ftui uses PackedRgba for true-color styling\n- Parse existing RGB values from ANSI sequences into PackedRgba\n- Or: maintain a parallel palette definition using PackedRgba directly\n- Theme switching should update all visible styles immediately\n\n## Files\n- NEW: crates/mcp-agent-mail-server/src/tui_theme.rs\n- Or extend existing theme.rs with TUI palette section\n\n## Acceptance Criteria\n- All theme presets produce valid TuiThemePalette\n- Style helpers return visually distinct styles\n- Theme switching with 'T' key works\n- Consistent look between TUI and log output\n- Unit tests for theme mapping, style helper correctness","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-07T03:24:20.703466854Z","created_by":"ubuntu","updated_at":"2026-02-07T03:53:23.457196554Z","close_reason":"Planning merge: superseded by br-10wc.11.4 canonical theme/readability bead.","source_repo":".","compaction_level":0,"original_size":0,"labels":["tui-polish"],"dependencies":[{"issue_id":"br-10wc.29","depends_on_id":"br-10wc","type":"parent-child","created_at":"2026-02-07T03:24:20.703466854Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.29","depends_on_id":"br-10wc.19","type":"blocks","created_at":"2026-02-07T03:26:29.149430372Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.3","title":"[track] am one-command supervisor: launch server + full TUI by default","description":"Implement the mandatory product contract: typing mcp_agent_mail not found in ~/mcp_agent_mail launches both MCP Agent Mail server and AgentMailTUI together by default. Include robust lifecycle supervision, startup checks, clear errors, and optional explicit modes for diagnostics.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:18:02.024286777Z","created_by":"ubuntu","updated_at":"2026-02-07T03:54:03.773098069Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.3","depends_on_id":"br-10wc","type":"parent-child","created_at":"2026-02-07T03:18:02.024286777Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.3.1","title":"Implement combined server+TUI supervisor lifecycle","description":"Implement the one-command supervisor that makes `am` launch both the MCP server and full TUI by default, with deterministic lifecycle behavior.\n\nScope includes:\n- Split server startup into a background-runtime path (`run_http_background`-style) returning a handle with shutdown signaling and join semantics.\n- Keep TUI on main thread (`Program::run`) while server + background workers run in the dedicated server thread.\n- Wire a shared state bridge so server instrumentation feeds the TUI without blocking tool latency paths.\n- Add clean shutdown choreography: `q`/Ctrl+C/requested shutdown -> signal server -> stop workers -> flush WBQ -> join with timeout.\n- Maintain robust fallbacks: non-TTY/headless defaults to server-only mode; TUI crash triggers safe server shutdown; server crash is surfaced clearly in TUI.\n- Preserve host/port/path/auth behavior and startup readiness checks so mode selection is transparent and MCP/API endpoint behavior remains correct.\n\nDesign guardrails:\n- No duplicate startup dashboards fighting for stdout when TUI mode is enabled.\n- No blocking sync fallback on hot paths just to keep UI updated.\n- Keep restart/reconnect/error remediation human-readable.\n\nTesting requirements (must be implemented before close):\n- Unit tests for supervisor state transitions and shutdown ordering.\n- Integration tests for TTY vs non-TTY launch selection.\n- PTY coverage delegated to `br-10wc.13.*` but this task must provide deterministic hooks and readiness markers those tests assert on.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-07T03:18:29.462450464Z","created_by":"ubuntu","updated_at":"2026-02-07T03:51:06.908013950Z","closed_at":"2026-02-07T03:51:06.907991348Z","close_reason":"Merged into br-10wc.18 (supervisor lifecycle is entrypoint scope)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.3.1","depends_on_id":"br-10wc.1.3","type":"blocks","created_at":"2026-02-07T03:20:32.268792892Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.3.1","depends_on_id":"br-10wc.2.2","type":"blocks","created_at":"2026-02-07T03:20:32.156316900Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.3.1","depends_on_id":"br-10wc.3","type":"parent-child","created_at":"2026-02-07T03:18:29.462450464Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.3.2","title":"Launcher mode flags without weakening default one-command flow","description":"Add explicit diagnostic modes (server-only/tui-only/detached) while keeping default behavior as combined server+tui. Document precedence and env-var interactions clearly.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T03:18:29.567460478Z","created_by":"ubuntu","updated_at":"2026-02-07T03:51:07.036878495Z","closed_at":"2026-02-07T03:51:07.036860441Z","close_reason":"Merged into br-10wc.18 (launcher flags added)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.3.2","depends_on_id":"br-10wc.3","type":"parent-child","created_at":"2026-02-07T03:18:29.567460478Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.3.2","depends_on_id":"br-10wc.3.1","type":"blocks","created_at":"2026-02-07T03:20:32.388534586Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.3.3","title":"Transport/path selection logic for MCP and API endpoints","description":"Implement and validate endpoint selection so launch flow works cleanly with /mcp/ and /api/ base paths, including explicit overrides and sensible defaults.","notes":"GoldDeer resumed implementation after robot-next triage; coordinating via Agent Mail thread br-10wc.3.3.","status":"closed","priority":0,"issue_type":"task","assignee":"GoldDeer","created_at":"2026-02-07T03:18:29.672206166Z","created_by":"ubuntu","updated_at":"2026-02-07T21:27:22.405447497Z","closed_at":"2026-02-07T21:27:22.405426157Z","close_reason":"Implemented explicit MCP/API transport + path selection for mcp-agent-mail serve. Added --path/--transport with deterministic precedence (CLI path > CLI transport > HTTP_PATH > /mcp/ default), normalized path handling, and unit tests. Updated scripts/am to pass path directly (with --mcp/--api shortcuts) and README quick-start/docs.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.3.3","depends_on_id":"br-10wc.3","type":"parent-child","created_at":"2026-02-07T03:18:29.672206166Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.3.3","depends_on_id":"br-10wc.3.1","type":"blocks","created_at":"2026-02-07T03:20:32.504892456Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.3.4","title":"Startup verification and human-friendly error remediation","description":"Add startup probes (port/path/auth/config) and structured remediation text so user failures are obvious and fast to resolve rather than cryptic shell noise.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-07T03:18:29.775205405Z","created_by":"ubuntu","updated_at":"2026-02-07T21:45:51.088960573Z","closed_at":"2026-02-07T21:45:51.088942670Z","close_reason":"Startup verification complete. startup_checks.rs: 5 probes (http-path validation, auth consistency, database URL, storage root writability, port availability) with structured ProbeResult/ProbeFailure types, human-friendly format_errors() output, integrated into run_http() before background workers start. 17 tests, 0 clippy warnings.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.3.4","depends_on_id":"br-10wc.3","type":"parent-child","created_at":"2026-02-07T03:18:29.775205405Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.3.4","depends_on_id":"br-10wc.3.1","type":"blocks","created_at":"2026-02-07T03:20:32.618510044Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.3.5","title":"Zero-friction am bootstrap: no manual export chain, auto auth/path resolution","description":"Implement the usability contract that operators can run `am` without manually chaining `cd` + environment exports.\n\nRequirements:\n- Auto-load bearer token and path defaults from standard config/env locations (including existing `~/.mcp_agent_mail` and project-local overrides) with clear precedence.\n- Support both MCP and API endpoint modes from one command, with sane default selection and explicit override flags.\n- Emit concise startup diagnostics that explain exactly what config source was used (token present/masked, path chosen, mode selected, host/port).\n- Preserve secure behavior: never print raw secrets; fail with actionable remediation if auth is missing/invalid.\n\nQuality gates:\n- Unit tests for config precedence and sanitization behavior.\n- PTY/integration test proving one-command startup from a clean shell environment (no pre-exported variables) with detailed logs.\n- Regression tests for both MCP and API mode bootstraps.\n\nThis bead exists specifically to eliminate the current brittle startup command chain and make day-to-day local operation dead simple.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:44:54.616716518Z","created_by":"ubuntu","updated_at":"2026-02-07T03:45:04.537973896Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["api","mcp","startup","ux"],"dependencies":[{"issue_id":"br-10wc.3.5","depends_on_id":"br-10wc.3","type":"parent-child","created_at":"2026-02-07T03:44:54.616716518Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.3.5","depends_on_id":"br-10wc.3.1","type":"blocks","created_at":"2026-02-07T03:44:54.616716518Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.30","title":"Keyboard navigation: vim keybindings, scroll, search, screen jump","description":"## Purpose\nComprehensive keyboard navigation system for the TUI. Operators should be able to navigate entirely by keyboard with vim-style muscle memory.\n\n## Deliverables\n\n### Global Keybindings (always active)\n- Tab / Shift+Tab: next/prev screen\n- 1-7: jump to screen by number\n- q: quit (with confirmation if server is active)\n- ?: toggle help overlay\n- Ctrl+P: command palette\n- T: cycle theme\n- Esc: dismiss any overlay/modal\n\n### Screen-Specific Keybindings\n- j/k: scroll down/up in lists\n- g/G: go to top/bottom\n- Enter: select/expand item\n- /: open search bar (in screens that support search)\n- n/N: next/prev search match\n- f: toggle follow mode (in Dashboard event log)\n- e: toggle expired items (in Reservations screen)\n- r: refresh data\n- t: toggle event type filter (in Dashboard)\n\n### Search Mode (when search bar is active)\n- Type to search (live filtering)\n- Enter: confirm search\n- Esc: cancel search\n- Ctrl+C: clear search\n- Up/Down: navigate results while searching\n\n### Scroll Behavior\n- Page up/down for large jumps\n- Mouse scroll wheel support\n- Vim-style half-page (Ctrl+D/Ctrl+U)\n- Smooth scroll with animation (if terminal supports it)\n\n## Technical Notes\n- Keybindings handled in MailAppModel::update() for globals\n- Screen-specific bindings in each screen's update() method\n- When a screen consumes_text_input(), single-char globals are suppressed\n- Quit confirmation: only if server thread is still running\n- All keybindings documented in help overlay and SCREEN_REGISTRY\n\n## Files\n- MODIFY: crates/mcp-agent-mail-server/src/tui_app.rs (global keybindings)\n- MODIFY: each screen file (screen-specific keybindings)\n- MODIFY: crates/mcp-agent-mail-server/src/tui_chrome.rs (help overlay content)\n\n## Acceptance Criteria\n- All listed keybindings work as documented\n- Vim navigation (j/k/g/G) works in all list views\n- Search with / works in applicable screens\n- No keybinding conflicts between global and screen-specific\n- Help overlay shows all keybindings for current screen\n- Unit tests for key dispatch logic","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-07T03:24:37.116397281Z","created_by":"ubuntu","updated_at":"2026-02-07T03:43:29.249143148Z","closed_at":"2026-02-07T03:43:29.249117750Z","close_reason":"Planning merge: superseded by br-10wc.9.2 canonical keybinding/conflict-resolution bead.","source_repo":".","compaction_level":0,"original_size":0,"labels":["tui-polish"],"dependencies":[{"issue_id":"br-10wc.30","depends_on_id":"br-10wc","type":"parent-child","created_at":"2026-02-07T03:24:37.116397281Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.30","depends_on_id":"br-10wc.19","type":"blocks","created_at":"2026-02-07T03:26:29.275546457Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.31","title":"Unit tests: event model, screens, data transforms, ring buffer","description":"## Purpose\nComprehensive unit test suite for all TUI components. Every module should have inline #[cfg(test)] tests covering core logic.\n\n## Deliverables\n\n### Event Model Tests (tui_events.rs)\n- Ring buffer: push, overflow, capacity, filter_by_kind, since(), iter_recent\n- MailEvent serialization/deserialization roundtrip\n- DbStatSnapshot creation and comparison\n- Monotonic sequence numbers\n\n### Shared State Tests (tui_bridge.rs)\n- Concurrent push/read safety\n- Shutdown signal propagation\n- Request counter atomicity\n- Sparkline data updates\n\n### Screen Tests\n- Dashboard: format_event() for each MailEvent variant, delta calculation\n- Messages: query debounce logic, result formatting, FTS query construction\n- Threads: thread aggregation, participant extraction\n- Agents: status classification (active/idle/inactive), sparkline aggregation\n- Reservations: TTL formatting, conflict detection between glob patterns\n- Tool Metrics: percentile calculation, histogram bucketing\n- System Health: stat formatting, config sanitization\n\n### Chrome Tests\n- Tab bar rendering at various widths\n- Status line formatting\n- Help overlay content generation\n\n### Theme Tests\n- Theme palette completeness (all fields populated)\n- Style helper correctness (correct colors for thresholds)\n\n### Data Connector Tests\n- DB poller delta detection\n- Event emission from mock tool calls\n\n## Technical Notes\n- Use ftui test harness for rendering tests where applicable\n- Use in-memory SQLite for DB-dependent tests\n- All tests should be deterministic (no timing dependencies)\n- Aim for >80% coverage of new TUI code\n\n## Files\n- Inline #[cfg(test)] modules in each new .rs file\n- Additional integration tests if needed\n\n## Acceptance Criteria\n- All unit tests pass (cargo test)\n- No clippy warnings in test code\n- Coverage >80% for new TUI modules\n- Tests are deterministic and fast (<30s total)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T03:24:52.887894222Z","created_by":"ubuntu","updated_at":"2026-02-07T03:43:29.382218560Z","closed_at":"2026-02-07T03:43:29.382198352Z","close_reason":"Planning merge: superseded by br-10wc.12 canonical unit/property/snapshot test bead.","source_repo":".","compaction_level":0,"original_size":0,"labels":["tui-quality"],"dependencies":[{"issue_id":"br-10wc.31","depends_on_id":"br-10wc","type":"parent-child","created_at":"2026-02-07T03:24:52.887894222Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.31","depends_on_id":"br-10wc.15","type":"blocks","created_at":"2026-02-07T03:26:29.402253669Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.31","depends_on_id":"br-10wc.16","type":"blocks","created_at":"2026-02-07T03:26:29.527865450Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.31","depends_on_id":"br-10wc.17","type":"blocks","created_at":"2026-02-07T03:26:29.652100083Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.31","depends_on_id":"br-10wc.20","type":"blocks","created_at":"2026-02-07T03:26:29.780986014Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.31","depends_on_id":"br-10wc.21","type":"blocks","created_at":"2026-02-07T03:26:29.905065305Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.32","title":"PTY/E2E tests: TUI smoke test, screen navigation, search, shutdown","description":"## Purpose\nEnd-to-end tests that exercise the full TUI application in a PTY environment. Verify that the TUI starts, renders, navigates between screens, processes search input, and shuts down cleanly.\n\n## Background\nThe frankentui demo showcase has extensive E2E tests using ftui-harness (PTY-based test framework). The existing agent mail server also has PTY tests in tests/e2e/. We extend this pattern.\n\n## Deliverables\n\n### Smoke Test\n- Launch am serve in PTY (with test DB)\n- Verify TUI renders (check for 'Dashboard' text in output)\n- Send 'q' key to quit\n- Verify clean exit (exit code 0)\n\n### Screen Navigation Test\n- Launch TUI\n- Press Tab  verify next screen renders\n- Press 1-7  verify correct screens activate\n- Press Shift+Tab  verify previous screen\n- Verify each screen title appears\n\n### Dashboard Event Test\n- Launch TUI with pre-populated DB\n- Verify stat tiles show correct counts\n- Send a tool call via HTTP to the server\n- Verify event appears in Dashboard log within 2s\n\n### Search Test\n- Navigate to Messages screen\n- Press '/' to activate search\n- Type a search term that exists in test DB\n- Verify results appear\n- Press Esc to cancel\n\n### Shutdown Test\n- Launch TUI\n- Verify server is accepting HTTP requests\n- Press 'q' to quit\n- Verify server stops (HTTP connection refused)\n- Verify exit code 0\n\n### Headless Fallback Test\n- Launch am serve --no-tui\n- Verify server starts without TUI (no terminal escape codes in output)\n- Verify server accepts HTTP requests\n- Ctrl+C to stop\n\n## Technical Notes\n- Use existing tests/e2e/ directory structure\n- Test script: tests/e2e/test_tui.sh\n- Uses e2e_lib.sh helpers (assert_pass, assert_contains, etc.)\n- PTY interaction: use expect-like patterns or frankentui harness\n- Test DB: create temp DB with known data before each test\n- Timeout: 10s per test case\n- Server HTTP checks: curl to localhost during TUI\n\n## Files\n- NEW: tests/e2e/test_tui.sh\n\n## Acceptance Criteria\n- All E2E tests pass in CI\n- Tests complete within 60s total\n- No flaky tests (deterministic)\n- Tests work on Linux (primary CI environment)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-07T03:25:11.328792933Z","created_by":"ubuntu","updated_at":"2026-02-07T03:43:29.511548738Z","closed_at":"2026-02-07T03:43:29.511525855Z","close_reason":"Planning merge: superseded by br-10wc.13 canonical PTY E2E + perf harness bead.","source_repo":".","compaction_level":0,"original_size":0,"labels":["tui-quality"],"dependencies":[{"issue_id":"br-10wc.32","depends_on_id":"br-10wc","type":"parent-child","created_at":"2026-02-07T03:25:11.328792933Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.32","depends_on_id":"br-10wc.18","type":"blocks","created_at":"2026-02-07T03:26:30.034546962Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.32","depends_on_id":"br-10wc.20","type":"blocks","created_at":"2026-02-07T03:26:30.162276929Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.33","title":"Documentation: am help updates, keybinding card, env var docs","description":"## Purpose\nUpdate documentation to reflect the new TUI functionality. Operators need to know how to use the TUI, what keybindings are available, and what environment variables control behavior.\n\n## Deliverables\n\n### 1. Update am script help text\n- Document TUI mode as default behavior\n- Document --no-tui flag for headless mode\n- Document TUI_ENABLED env var\n\n### 2. Update README.md\n- Add TUI section with screenshot description\n- Document keybindings reference\n- Document screen descriptions\n- Note: TUI requires terminal with true-color support\n\n### 3. Keybinding Reference Card\n- Table of all global keybindings\n- Per-screen keybinding tables\n- Note about vim-style navigation\n\n### 4. Environment Variable Documentation\n- TUI_ENABLED (default: true)\n- Existing CONSOLE_* vars still respected for TUI mode\n- CONSOLE_THEME selects TUI theme\n- CONSOLE_POLL_INTERVAL_MS for DB polling rate\n\n### 5. AGENTS.md Update\n- Add TUI section explaining the architecture\n- Note that am now launches TUI+server by default\n- Document how to disable TUI for CI/headless use\n\n## Files\n- MODIFY: scripts/am (help text)\n- MODIFY: README.md (TUI section)\n- MODIFY: AGENTS.md (TUI architecture notes)\n\n## Acceptance Criteria\n- All new features documented\n- Help text accurate and up-to-date\n- Keybinding reference complete\n- Environment variables documented","status":"closed","priority":3,"issue_type":"task","created_at":"2026-02-07T03:25:22.461706661Z","created_by":"ubuntu","updated_at":"2026-02-07T03:43:29.653110136Z","closed_at":"2026-02-07T03:43:29.653084658Z","close_reason":"Planning merge: superseded by br-10wc.14 canonical docs/runbook/rollout bead.","source_repo":".","compaction_level":0,"original_size":0,"labels":["tui-docs"],"dependencies":[{"issue_id":"br-10wc.33","depends_on_id":"br-10wc","type":"parent-child","created_at":"2026-02-07T03:25:22.461706661Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.33","depends_on_id":"br-10wc.18","type":"blocks","created_at":"2026-02-07T03:26:30.285322234Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.33","depends_on_id":"br-10wc.19","type":"blocks","created_at":"2026-02-07T03:26:30.411517247Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.4","title":"[track] Typed event-stream backbone for live TUI data","description":"Create a typed event ingestion/backbone layer that normalizes requests, tool calls, message activity, reservations, and health signals. Must support bounded buffering, replay/search feeds, redaction, and deterministic ordering guarantees.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:18:02.125256867Z","created_by":"ubuntu","updated_at":"2026-02-07T03:54:03.370588437Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.4","depends_on_id":"br-10wc","type":"parent-child","created_at":"2026-02-07T03:18:02.125256867Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.4.1","title":"Canonical event schema across HTTP, tools, mail, reservations","description":"Define and implement canonical event types so all panes consume consistent data models with stable IDs, timestamps, source metadata, and redaction state.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-07T03:18:29.882580877Z","created_by":"ubuntu","updated_at":"2026-02-07T03:51:06.079743984Z","closed_at":"2026-02-07T03:51:06.079721682Z","close_reason":"Merged into br-10wc.15 (MailEvent is the canonical event schema)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.4.1","depends_on_id":"br-10wc.15","type":"blocks","created_at":"2026-02-07T03:20:31.110915483Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.4.1","depends_on_id":"br-10wc.2.2","type":"blocks","created_at":"2026-02-07T03:20:32.733463304Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.4.1","depends_on_id":"br-10wc.4","type":"parent-child","created_at":"2026-02-07T03:18:29.882580877Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.4.2","title":"Bounded in-memory event store plus replay hooks","description":"Implement bounded buffers and replay APIs for timeline/search/dashboard consumers with predictable memory usage and deterministic event ordering.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-07T03:18:29.992692321Z","created_by":"ubuntu","updated_at":"2026-02-07T03:51:06.214492456Z","closed_at":"2026-02-07T03:51:06.214470725Z","close_reason":"Merged into br-10wc.15 (ring buffer + replay hooks absorbed)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.4.2","depends_on_id":"br-10wc.15","type":"blocks","created_at":"2026-02-07T03:20:31.223555602Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.4.2","depends_on_id":"br-10wc.16","type":"blocks","created_at":"2026-02-07T03:22:46.469534691Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.4.2","depends_on_id":"br-10wc.4","type":"parent-child","created_at":"2026-02-07T03:18:29.992692321Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.4.2","depends_on_id":"br-10wc.4.1","type":"blocks","created_at":"2026-02-07T03:20:32.852415520Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.4.3","title":"Backpressure, drop accounting, and operator visibility","description":"Add explicit handling for burst traffic: sampling/degradation policies, dropped-event counters, and visible indicators so operators know when fidelity is reduced.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:18:30.097136546Z","created_by":"ubuntu","updated_at":"2026-02-07T03:49:28.029454514Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.4.3","depends_on_id":"br-10wc.15","type":"blocks","created_at":"2026-02-07T03:49:28.029363584Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.4.3","depends_on_id":"br-10wc.4","type":"parent-child","created_at":"2026-02-07T03:18:30.097136546Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.4.3","depends_on_id":"br-10wc.4.2","type":"blocks","created_at":"2026-02-07T03:20:32.966786389Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.4.4","title":"Sensitive-data masking policy enforcement in event pipeline","description":"Ensure masking is applied once centrally and verified everywhere events are displayed or exported. Include allowlist/denylist clarity and audit-friendly metadata.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-07T03:18:30.200669083Z","created_by":"ubuntu","updated_at":"2026-02-07T03:51:06.354097929Z","closed_at":"2026-02-07T03:51:06.354079455Z","close_reason":"Merged into br-10wc.28 (masking applied at event construction)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.4.4","depends_on_id":"br-10wc.4","type":"parent-child","created_at":"2026-02-07T03:18:30.200669083Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.4.4","depends_on_id":"br-10wc.4.1","type":"blocks","created_at":"2026-02-07T03:20:33.082780968Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.5","title":"[track] Main dashboard surface: live activity + stats/charts","description":"Build the default AgentMailTUI home screen as an operator dashboard: streaming activity view, key metrics, trend widgets, top agents/projects, and actionable health status. This is the primary at-a-glance cockpit.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:18:02.223195060Z","created_by":"ubuntu","updated_at":"2026-02-07T03:54:03.907262235Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.5","depends_on_id":"br-10wc","type":"parent-child","created_at":"2026-02-07T03:18:02.223195060Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.5.1","title":"Activity stream pane with high-density readable event cards","description":"Implement the central scrolling activity surface showing requests, tool calls, mail actions, and warnings with compact but readable card formatting and consistent severity/iconography.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-07T03:18:48.454994307Z","created_by":"ubuntu","updated_at":"2026-02-07T03:51:16.767202183Z","closed_at":"2026-02-07T03:51:16.767179951Z","close_reason":"Merged into br-10wc.20 (activity stream = dashboard event log)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.5.1","depends_on_id":"br-10wc.4.2","type":"blocks","created_at":"2026-02-07T03:20:33.198148924Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.5.1","depends_on_id":"br-10wc.5","type":"parent-child","created_at":"2026-02-07T03:18:48.454994307Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.5.2","title":"KPI cards and trend visuals for throughput, errors, latency","description":"Add dashboard metric cards and trend charts that update in near real time and remain legible under smaller terminal sizes.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T03:18:48.565042263Z","created_by":"ubuntu","updated_at":"2026-02-07T03:51:16.904606872Z","closed_at":"2026-02-07T03:51:16.904581304Z","close_reason":"Merged into br-10wc.20 (KPI cards = dashboard stat tiles section)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.5.2","depends_on_id":"br-10wc.5","type":"parent-child","created_at":"2026-02-07T03:18:48.565042263Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.5.2","depends_on_id":"br-10wc.5.1","type":"blocks","created_at":"2026-02-07T03:20:33.310586634Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.5.3","title":"Agent/project spotlight widgets with actionable context","description":"Show currently active agents/projects, recent thread activity, and reservation pressure so operators can triage quickly.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T03:18:48.684441516Z","created_by":"ubuntu","updated_at":"2026-02-07T03:51:17.048578979Z","closed_at":"2026-02-07T03:51:17.048547500Z","close_reason":"Merged into br-10wc.20 (agent spotlight = dashboard agent section)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.5.3","depends_on_id":"br-10wc.5","type":"parent-child","created_at":"2026-02-07T03:18:48.684441516Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.5.3","depends_on_id":"br-10wc.5.1","type":"blocks","created_at":"2026-02-07T03:20:33.425532981Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.5.4","title":"Health alarms and quick-action controls from dashboard","description":"Surface actionable alerts (auth/path failures, backlog, drop events) and allow immediate commands from dashboard context.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T03:18:48.796289582Z","created_by":"ubuntu","updated_at":"2026-02-07T03:51:17.189453050Z","closed_at":"2026-02-07T03:51:17.189431560Z","close_reason":"Merged into br-10wc.20 (health alarms = dashboard footer section)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.5.4","depends_on_id":"br-10wc.5","type":"parent-child","created_at":"2026-02-07T03:18:48.796289582Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.5.4","depends_on_id":"br-10wc.5.1","type":"blocks","created_at":"2026-02-07T03:20:33.542703421Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.6","title":"[track] Search cockpit: real-time query + virtualized results","description":"Deliver full-text and structured search across messages/tool events with virtualized rendering and incremental updates. Include filters, relevance controls, and deep links into detail/timeline panes.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:18:02.326452733Z","created_by":"ubuntu","updated_at":"2026-02-07T03:54:16.173720985Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.6","depends_on_id":"br-10wc","type":"parent-child","created_at":"2026-02-07T03:18:02.326452733Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.6.1","title":"Unified indexed search across messages and operational events","description":"Build search indexing/query adapters spanning message archive and live event stream with clear field scoping and stable ranking semantics.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-07T03:18:48.913864871Z","created_by":"ubuntu","updated_at":"2026-02-07T03:51:17.333824095Z","closed_at":"2026-02-07T03:51:17.333798697Z","close_reason":"Merged into br-10wc.21 (unified search = message browser FTS)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.6.1","depends_on_id":"br-10wc.4.2","type":"blocks","created_at":"2026-02-07T03:20:33.652902350Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.6.1","depends_on_id":"br-10wc.6","type":"parent-child","created_at":"2026-02-07T03:18:48.913864871Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.6.2","title":"Virtualized result list and keyboard-first navigation","description":"Use virtualized rendering for large result sets with smooth navigation and deterministic focus behavior.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T03:18:49.029948867Z","created_by":"ubuntu","updated_at":"2026-02-07T03:51:17.475018095Z","closed_at":"2026-02-07T03:51:17.474996946Z","close_reason":"Merged into br-10wc.21 (virtualized list = browser results pane)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.6.2","depends_on_id":"br-10wc.6","type":"parent-child","created_at":"2026-02-07T03:18:49.029948867Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.6.2","depends_on_id":"br-10wc.6.1","type":"blocks","created_at":"2026-02-07T03:20:33.767323162Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.6.3","title":"Saved filters, query presets, and explainability metadata","description":"Support reusable query presets and expose enough explainability metadata for users to trust why results appear in order.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:18:49.143570554Z","created_by":"ubuntu","updated_at":"2026-02-07T03:49:49.353594704Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.6.3","depends_on_id":"br-10wc.21","type":"blocks","created_at":"2026-02-07T03:49:49.353548537Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.6.3","depends_on_id":"br-10wc.6","type":"parent-child","created_at":"2026-02-07T03:18:49.143570554Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.6.3","depends_on_id":"br-10wc.6.2","type":"blocks","created_at":"2026-02-07T03:20:33.884206345Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.6.4","title":"Deep-link routing from search hits into inspector/timeline","description":"Selecting a hit should jump directly to relevant timeline/detail context without manual re-navigation.","status":"closed","priority":0,"issue_type":"task","assignee":"RubyPrairie","created_at":"2026-02-07T03:18:49.253302888Z","created_by":"ubuntu","updated_at":"2026-02-07T23:04:28.558131386Z","closed_at":"2026-02-07T23:04:28.558112872Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.6.4","depends_on_id":"br-10wc.21","type":"blocks","created_at":"2026-02-07T03:49:49.495846517Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.6.4","depends_on_id":"br-10wc.6","type":"parent-child","created_at":"2026-02-07T03:18:49.253302888Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.6.4","depends_on_id":"br-10wc.6.2","type":"blocks","created_at":"2026-02-07T03:20:34.002651823Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.6.4","depends_on_id":"br-10wc.7.2","type":"blocks","created_at":"2026-02-07T03:20:34.123685847Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.7","title":"[track] Timeline and inspector panes for deep diagnosis","description":"Implement event timeline and detail inspector experiences so operators can reconstruct causality, inspect payloads safely, navigate related entities, and resolve issues quickly without leaving the TUI.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:18:02.425115723Z","created_by":"ubuntu","updated_at":"2026-02-07T03:54:16.307990309Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.7","depends_on_id":"br-10wc","type":"parent-child","created_at":"2026-02-07T03:18:02.425115723Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.7.1","title":"Chronological timeline view with dense navigation affordances","description":"Implement timeline pane with paging, jump-to-time, and focused event selection for long-running sessions.","status":"closed","priority":1,"issue_type":"task","assignee":"RubyPrairie","created_at":"2026-02-07T03:18:49.366674817Z","created_by":"ubuntu","updated_at":"2026-02-07T22:37:54.847562583Z","closed_at":"2026-02-07T22:37:54.847540101Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.7.1","depends_on_id":"br-10wc.15","type":"blocks","created_at":"2026-02-07T03:49:27.890208709Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.7.1","depends_on_id":"br-10wc.4.2","type":"blocks","created_at":"2026-02-07T03:20:34.243296596Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.7.1","depends_on_id":"br-10wc.7","type":"parent-child","created_at":"2026-02-07T03:18:49.366674817Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.7.2","title":"Inspector detail cards with safe payload presentation","description":"Render request/response/params/results details with masking and copy-friendly formatting for debugging and audit use.","status":"closed","priority":0,"issue_type":"task","assignee":"RubyPrairie","created_at":"2026-02-07T03:18:49.476609160Z","created_by":"ubuntu","updated_at":"2026-02-07T22:42:01.481673753Z","closed_at":"2026-02-07T22:42:01.481651862Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.7.2","depends_on_id":"br-10wc.28","type":"blocks","created_at":"2026-02-07T03:49:28.299117274Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.7.2","depends_on_id":"br-10wc.4.4","type":"blocks","created_at":"2026-02-07T03:20:34.476609262Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.7.2","depends_on_id":"br-10wc.7","type":"parent-child","created_at":"2026-02-07T03:18:49.476609160Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.7.2","depends_on_id":"br-10wc.7.1","type":"blocks","created_at":"2026-02-07T03:20:34.357917393Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.7.3","title":"Correlation links across thread, agent, tool, and request IDs","description":"Provide context pivots so operators can traverse related entities quickly from any selected event.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:18:49.588037681Z","created_by":"ubuntu","updated_at":"2026-02-07T03:20:34.592972662Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.7.3","depends_on_id":"br-10wc.7","type":"parent-child","created_at":"2026-02-07T03:18:49.588037681Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.7.3","depends_on_id":"br-10wc.7.2","type":"blocks","created_at":"2026-02-07T03:20:34.592908151Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.7.4","title":"Embedded remediation hints and next-action guidance","description":"Add inline hints when common failures are detected, with recommended safe follow-up actions.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:18:49.699823871Z","created_by":"ubuntu","updated_at":"2026-02-07T03:20:34.707729173Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.7.4","depends_on_id":"br-10wc.7","type":"parent-child","created_at":"2026-02-07T03:18:49.699823871Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.7.4","depends_on_id":"br-10wc.7.2","type":"blocks","created_at":"2026-02-07T03:20:34.707689719Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.8","title":"[track] Interactive layout studio + automatic persistence","description":"Provide interactive layout customization (bottom/top/left docking, split ratios, static vs scroll allocation) with immediate visual feedback and automatic persistence to Agent Mail config so preferences are restored on launch.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:18:02.525072305Z","created_by":"ubuntu","updated_at":"2026-02-07T03:54:16.437354971Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.8","depends_on_id":"br-10wc","type":"parent-child","created_at":"2026-02-07T03:18:02.525072305Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.8.1","title":"Docking model: bottom/top/left with interactive ratio controls","description":"Implement flexible docking and ratio controls so users can dedicate screen real-estate to static HUD vs scrolling content dynamically.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:18:49.814164794Z","created_by":"ubuntu","updated_at":"2026-02-07T03:20:34.822634273Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.8.1","depends_on_id":"br-10wc.2.3","type":"blocks","created_at":"2026-02-07T03:20:34.822550185Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.8.1","depends_on_id":"br-10wc.8","type":"parent-child","created_at":"2026-02-07T03:18:49.814164794Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.8.2","title":"Live layout tuning via keys/mouse with immediate feedback","description":"Users must be able to adjust layout interactively (e.g. 20%/50%/left split) and see live updates without restarting.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:18:49.926093511Z","created_by":"ubuntu","updated_at":"2026-02-07T03:20:34.937262003Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.8.2","depends_on_id":"br-10wc.8","type":"parent-child","created_at":"2026-02-07T03:18:49.926093511Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.8.2","depends_on_id":"br-10wc.8.1","type":"blocks","created_at":"2026-02-07T03:20:34.937203583Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.8.3","title":"Auto-persistence to config file with schema validation","description":"Persist layout and console preferences automatically, validate values, and guard against corrupt config writes.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:18:50.040244829Z","created_by":"ubuntu","updated_at":"2026-02-07T03:49:28.438251821Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.8.3","depends_on_id":"br-10wc.18","type":"blocks","created_at":"2026-02-07T03:49:28.438172943Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.8.3","depends_on_id":"br-10wc.2.4","type":"blocks","created_at":"2026-02-07T03:20:35.166310004Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.8.3","depends_on_id":"br-10wc.8","type":"parent-child","created_at":"2026-02-07T03:18:50.040244829Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.8.3","depends_on_id":"br-10wc.8.2","type":"blocks","created_at":"2026-02-07T03:20:35.051478433Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.8.4","title":"Restore/reset/import-export workflows for layout presets","description":"Support startup restore and explicit reset to defaults; include import/export for reproducible team layouts.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:18:50.218446474Z","created_by":"ubuntu","updated_at":"2026-02-07T03:20:35.274444217Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.8.4","depends_on_id":"br-10wc.8","type":"parent-child","created_at":"2026-02-07T03:18:50.218446474Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.8.4","depends_on_id":"br-10wc.8.3","type":"blocks","created_at":"2026-02-07T03:20:35.274396407Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.9","title":"[track] Command palette, shortcuts, and discoverability UX","description":"Add power-user navigation via command palette, global keybindings, contextual actions, and in-app help overlays so every core operation is reachable quickly and self-discoverable.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:18:02.628930312Z","created_by":"ubuntu","updated_at":"2026-02-07T03:54:16.571140969Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.9","depends_on_id":"br-10wc","type":"parent-child","created_at":"2026-02-07T03:18:02.628930312Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.9.1","title":"Palette action catalog for navigation, mode changes, and ops actions","description":"Define and implement command palette action catalog covering pane switching, layout actions, diagnostics, and safe operational shortcuts.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T03:19:17.734849403Z","created_by":"ubuntu","updated_at":"2026-02-07T23:11:15.746870854Z","closed_at":"2026-02-07T23:11:15.746841249Z","close_reason":"Implemented AgentMailTUI command palette overlay (Ctrl+P / ':'), dynamic action catalog (screens+agents+threads+tools), dispatch routing, help overlay update, and unit tests; ran fmt/clippy/test","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.9.1","depends_on_id":"br-10wc.19","type":"blocks","created_at":"2026-02-07T03:21:39.698317529Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.9.1","depends_on_id":"br-10wc.2.3","type":"blocks","created_at":"2026-02-07T03:20:35.387645727Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.9.1","depends_on_id":"br-10wc.20","type":"blocks","created_at":"2026-02-07T03:49:29.116218163Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.9.1","depends_on_id":"br-10wc.5.1","type":"blocks","created_at":"2026-02-07T03:20:35.502698272Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.9.1","depends_on_id":"br-10wc.9","type":"parent-child","created_at":"2026-02-07T03:19:17.734849403Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.9.2","title":"Global keybinding map with conflict resolution and hints","description":"Define and implement a cohesive keyboard/input map with explicit conflict resolution and discoverability across all screens.\n\n**Absorbs**: br-10wc.30 (vim keybindings, scroll, search, screen jump)\n\n## Global Bindings (always active)\n- `Tab`/`Shift+Tab`: next/previous screen\n- `1..N`: direct jump to screen by number\n- `q`: quit (with confirmation when server thread is active)\n- `?`: help overlay\n- `Ctrl+P`: command palette\n- `T`: cycle theme\n- `Esc`: dismiss overlays/modals\n\n## List/Navigation Semantics (where applicable)\n- `j`/`k`: scroll down/up in lists\n- Arrow keys: same as j/k\n- `g`/`G`: go to top/bottom\n- `PageUp`/`PageDown`: large jumps\n- `Ctrl+U`/`Ctrl+D`: half-page scroll (vim-style)\n- `Enter`: select/expand item\n- `/`: open search bar (in screens that support search)\n- `n`/`N`: next/prev search match\n- Mouse scroll wheel support\n\n## Screen-Specific Bindings\n- Dashboard: `f` toggle follow mode, `t` toggle event type filter\n- Reservations: `e` toggle expired items\n- All screens: `r` manual refresh\n\n## Search Mode (when search bar is active)\n- Type to search (live filtering)\n- `Enter`: confirm search\n- `Esc`: cancel search\n- `Ctrl+C`: clear search text\n- `Up`/`Down`: navigate results while searching\n\n## Conflict-Resolution Contract\n- Global single-char shortcuts are suppressed when a screen's `consumes_text_input()` returns true\n- Screen-specific handlers can consume events first only when explicitly registered\n- Help overlay always shows active global + screen-local bindings for current focus\n- Command palette + help output must stay synchronized with actual keymap definitions\n\n## Ergonomics\n- Keyboard-only operation is first-class\n- Mouse support augments but never replaces keyboard flows\n- All keybindings documented in help overlay (auto-generated from MAIL_SCREEN_REGISTRY + screen keybindings())\n\n## Testing Requirements\n- Unit tests for key dispatch precedence and conflict handling\n- Screen-level tests for shared nav semantics consistency\n- Verify no keybinding conflicts between global and screen-specific bindings\n- PTY interaction validation delegated to br-10wc.13.2\n\n## Files\n- MODIFY: crates/mcp-agent-mail-server/src/tui_app.rs (global keybindings in MailAppModel::update)\n- MODIFY: each screen file (screen-specific keybindings in MailScreen::update)\n- MODIFY: crates/mcp-agent-mail-server/src/tui_chrome.rs (help overlay keybinding tables)","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:19:17.849959306Z","created_by":"ubuntu","updated_at":"2026-02-07T03:49:12.837540204Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.9.2","depends_on_id":"br-10wc.9","type":"parent-child","created_at":"2026-02-07T03:19:17.849959306Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.9.2","depends_on_id":"br-10wc.9.1","type":"blocks","created_at":"2026-02-07T03:20:35.617749665Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.9.3","title":"Context-aware quick actions from focused entities","description":"Enable entity-aware actions (agent/thread/request/tool) so operators can execute common workflows from current focus.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:19:17.961367879Z","created_by":"ubuntu","updated_at":"2026-02-07T03:20:35.844787684Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.9.3","depends_on_id":"br-10wc.7.3","type":"blocks","created_at":"2026-02-07T03:20:35.844738632Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.9.3","depends_on_id":"br-10wc.9","type":"parent-child","created_at":"2026-02-07T03:19:17.961367879Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.9.3","depends_on_id":"br-10wc.9.1","type":"blocks","created_at":"2026-02-07T03:20:35.733518582Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-10wc.9.4","title":"Accessibility and low-capability terminal navigation modes","description":"Ensure keyboard-only operation, readable help, and graceful behavior on terminals without rich capability support.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:19:18.074941005Z","created_by":"ubuntu","updated_at":"2026-02-07T03:20:35.957883646Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-10wc.9.4","depends_on_id":"br-10wc.9","type":"parent-child","created_at":"2026-02-07T03:19:18.074941005Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-10wc.9.4","depends_on_id":"br-10wc.9.2","type":"blocks","created_at":"2026-02-07T03:20:35.957832841Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv","title":"[epic] Extreme Performance & Resilience: 1000+ Concurrent Agents","description":"## Goal\nMake **MCP Agent Mail (Rust)** operationally boring at extreme concurrency: **1000+ agents** performing reads+writes simultaneously without deadlocks, data loss, unbounded memory growth, or IO collapse.\n\nThis project is already a feature-parity Rust port of the legacy Python server. This epic is explicitly about going beyond parity: hard performance budgets, reliability engineering, and overload-safe architecture.\n\n## Why This Exists (Failure Modes From Python Era)\nThe original Python implementation degraded badly under high concurrency due to:\n- SQLite contention and SQLITE_BUSY storms during bursts.\n- Git index.lock contention and expensive synchronous git operations on hot paths.\n- Unbounded in-memory queues and log/event amplification under load.\n- Cascading IO failures (many tiny writes, lock thrash, background tasks competing with the hot path).\n\n## Non-Negotiables\n- Correctness: No lost messages/acks/reservations/contacts. DB remains the source of truth.\n- Bounded resources: Every queue has a capacity and explicit policy when full.\n- Graceful degradation: Under overload, shed non-critical work first and return actionable errors (429/503 with retry guidance); never cliff-drop into slow synchronous IO.\n- Deterministic validation: Every optimization must preserve conformance fixtures/golden outputs (isomorphism proof) unless we intentionally change the contract and update fixtures.\n\n## Target Load Model (Working Assumption)\n- Agents: 1000 registered agents across 1-50 projects.\n- Concurrency: 100-500 concurrent HTTP requests (thundering herd patterns included).\n- Mix: read-heavy (fetch_inbox/resources/search) with periodic write bursts (send_message, reservations, acks).\n- Pathologies: message storms (1000 msgs in <1s), inbox polling storms, many reservations, large payload attempts, worker failure, disk pressure.\n\n## Strategy (Extreme Optimization Loop)\n1. Baseline representative scenarios (p50/p95/p99 latency, throughput, RSS growth, queue depths).\n2. Instrument the true bottlenecks (DB pool waits, SQLite busy, WBQ/commit backlog, lock contention).\n3. Change one lever at a time (Opportunity Matrix score >= 2.0), with a rollback plan.\n4. Prove behavior unchanged (conformance + golden outputs + invariants).\n5. Repeat: bottlenecks shift.\n\n## Consistency Model (Intentional)\n- SQLite DB is authoritative for queryable state (messages, recipients, reservations, contacts, acks).\n- Git archive is an async audit log, best-effort and overload-safe. It must never block tool responses.\n- Signals/notifications are correctness-adjacent (UX responsiveness) and must be explicitly categorized as required vs skippable under overload.\n\n## Tracks\nWork is organized into tracks under this epic: db, storage/git, concurrency/backpressure, memory, algorithms, resilience, build+bench, observability, stress/chaos.","acceptance_criteria":"Acceptance Criteria:\n- 1000-agent simulation (defined in br-15dv.9.*) runs for 10+ minutes with:\n  - 0 panics\n  - 0 deadlocks/hangs\n  - 0 data-loss (DB invariants hold)\n- Under sustained overload, system enters Yellow/Red modes and sheds non-critical work without cascading failures.\n- All queues are bounded; overflow policies are explicit and tested.\n- p95/p99 latency budgets exist per scenario and are enforced in CI (scaled-down on PR, full on nightly/adhoc).\n- cargo test, cargo clippy -D warnings, cargo fmt --check pass.\n- Crash/restart test: kill server mid-burst, restart, PRAGMA integrity_check passes and system resumes without manual intervention.\n- Memory plateau: after warmup, RSS growth < 5% over 30 minutes in soak scenario.","status":"open","priority":0,"issue_type":"epic","created_at":"2026-02-07T03:24:55.516413906Z","created_by":"ubuntu","updated_at":"2026-02-07T03:35:23.260118315Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["perf","resilience","scale"],"comments":[{"id":9,"issue_id":"br-15dv","author":"Dicklesworthstone","text":"ARCHITECTURE CONTEXT: The Python mcp_agent_mail used SQLAlchemy (async) + GitPython with no connection pooling, no write batching, and blocking git operations on every message send. It regularly failed at 10+ concurrent agents due to: (1) SQLite 'database is locked' errors from too many writers, (2) git index.lock storms when multiple agents committed simultaneously, (3) memory leaks from unclosed DB sessions, (4) cascading timeouts when one slow git operation blocked the entire system. The Rust port already improves on this with: WAL mode, connection pooling, write-behind queue, and commit coalescing. But the current defaults (7 connections, 256 WBQ, 100 commit queue) are sized for the Python-era workload of ~10 agents. Scaling to 1000+ requires a fundamentally different approach: adaptive sizing, lock elimination, spatial indexing, and system-wide backpressure.","created_at":"2026-02-07T03:34:38Z"}]}
{"id":"br-15dv.1","title":"[track] Database layer optimization for 1000+ agent concurrency","description":"The SQLite database layer is the #1 bottleneck for scaling beyond ~10 concurrent agents. Current defaults: 3+4=7 connection pool, 1000-entry cache cap, 60s agent TTL, single global mutex for deferred touches, single global mutex for query tracking. At 1000 agents with 10% active (100 concurrent tool calls), the pool is 14x oversubscribed, the cache thrashes constantly, and mutex contention serializes all requests. This track addresses: pool sizing, cache overhaul, lock sharding, query tracker redesign, missing indexes, PRAGMA tuning, config caching, prepared statements, and write batching.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:25:36.069380158Z","created_by":"ubuntu","updated_at":"2026-02-07T03:25:36.069380158Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["db","perf","scale"],"dependencies":[{"issue_id":"br-15dv.1","depends_on_id":"br-15dv","type":"parent-child","created_at":"2026-02-07T03:25:36.069380158Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.1.1","title":"Adaptive connection pool sizing with read/write separation","description":"PROBLEM: Pool defaults to 3+4=7 connections. At 100 concurrent tool calls (10% of 1000 agents), each connection handles 14+ requests  60s acquire timeouts fire constantly.\n\nCURRENT CODE (pool.rs:24-27):\n  DEFAULT_POOL_SIZE = 3\n  DEFAULT_MAX_OVERFLOW = 4\n  DEFAULT_POOL_TIMEOUT_MS = 60_000\n\nSOLUTION: Implement adaptive pool sizing that scales with observed load:\n1. Increase defaults to min=20, max=100 (SQLite WAL handles concurrent readers well)\n2. Add adaptive sizing: monitor acquire latency, grow pool when p95 > 50ms, shrink when utilization < 30%\n3. Separate read pool (large, many connections) from write pool (small, serialized via WAL)\n4. Add pool warmup on startup (pre-open min connections)\n5. Add per-pool metrics: active, idle, waiting, acquire_latency_p95\n\nVALIDATION: stress_pool_exhaustion_recovery test must pass with pool_size=20, 200 concurrent threads.\n\nFILES: crates/mcp-agent-mail-db/src/pool.rs, crates/mcp-agent-mail-core/src/config.rs","status":"closed","priority":0,"issue_type":"task","assignee":"RubyPrairie","created_at":"2026-02-07T03:27:00.722082725Z","created_by":"ubuntu","updated_at":"2026-02-07T21:15:25.455163400Z","closed_at":"2026-02-07T21:15:25.455139855Z","close_reason":"Implemented adaptive pool sizing: defaults 25+75=100 (up from 3+4=7), auto_pool_size() heuristic based on CPU count, 15s acquire timeout (down from 60s). All tests passing.","source_repo":".","compaction_level":0,"original_size":0,"labels":["db","perf","pool"],"dependencies":[{"issue_id":"br-15dv.1.1","depends_on_id":"br-15dv.1","type":"parent-child","created_at":"2026-02-07T03:27:00.722082725Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.1.1","depends_on_id":"br-15dv.1.10","type":"blocks","created_at":"2026-02-07T03:42:15.712206131Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.1.1","depends_on_id":"br-15dv.8.2","type":"blocks","created_at":"2026-02-07T03:37:16.745849160Z","created_by":"ubuntu","metadata":"{}","thread_id":""}],"comments":[{"id":10,"issue_id":"br-15dv.1.1","author":"Dicklesworthstone","text":"SIZING RATIONALE: SQLite WAL mode allows unlimited concurrent readers but serializes writers. With 1000 agents, read:write ratio is approximately 3:1 (fetch_inbox, search, resources are reads; send_message, ack, reserve are writes). Optimal config: 50 read connections (instant, no contention), 5 write connections (serialized but fast with WAL). Total: 55 connections. This matches PostgreSQL best practices of poolSize = (2 * cores) + spindles, adapted for SQLite's simpler model. The adaptive sizing adds a feedback loop: if acquire_latency_p95 > 50ms, add 10% more connections up to max_connections. If utilization < 30% for 5 minutes, shrink by 10% down to min_connections.","created_at":"2026-02-07T03:34:38Z"}]}
{"id":"br-15dv.1.1.1","title":"Implement pool sizing defaults + optional warmup","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T05:48:25.340522108Z","created_by":"ubuntu","updated_at":"2026-02-07T05:49:04.221279541Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["db","impl","pool"],"dependencies":[{"issue_id":"br-15dv.1.1.1","depends_on_id":"br-15dv.1.1","type":"parent-child","created_at":"2026-02-07T05:48:25.340522108Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.1.1.1","depends_on_id":"br-15dv.1.1.2","type":"blocks","created_at":"2026-02-07T05:48:35.335856599Z","created_by":"ubuntu","metadata":"{}","thread_id":""}],"comments":[{"id":22,"issue_id":"br-15dv.1.1.1","author":"Dicklesworthstone","text":"## Implementation Outline\n- Update defaults in `crates/mcp-agent-mail-db/src/pool.rs` to a scale-appropriate baseline.\n- Thread config through `mcp_agent_mail_core::Config` and ensure we do not re-parse env per request (pairs with br-15dv.1.7).\n- Implement optional warmup: open N connections on startup (bounded time) to avoid first-burst latency spikes.\n- Ensure metrics are emitted:\n  - utilization gauges (already via br-15dv.8.2)\n  - acquire latency histogram (already via br-15dv.8.6)\n\n## Safety Notes\n- Do not create unbounded background tasks; warmup must be bounded and cancel-safe.\n- Avoid holding locks across IO.\n\n## Acceptance Criteria\n- New defaults + config overrides are live.\n- Warmup can be enabled/disabled and does not block startup indefinitely.\n- Existing tests + conformance pass.\n","created_at":"2026-02-07T05:49:04Z"}]}
{"id":"br-15dv.1.1.2","title":"Design pool model + config schema (read/write separation, guardrails)","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T05:48:25.440737596Z","created_by":"ubuntu","updated_at":"2026-02-07T21:50:50.186000174Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["db","design","pool"],"dependencies":[{"issue_id":"br-15dv.1.1.2","depends_on_id":"br-15dv.1.1","type":"parent-child","created_at":"2026-02-07T05:48:25.440737596Z","created_by":"ubuntu","metadata":"{}","thread_id":""}],"comments":[{"id":23,"issue_id":"br-15dv.1.1.2","author":"Dicklesworthstone","text":"## Design Questions\nWe need a pool strategy that works with SQLite WAL (many readers, one writer) and does not collapse under bursts.\n\n## Options\n1. Single pool, larger size:\n   - Simple: raise defaults (e.g. min=20, overflow=80).\n   - Risk: many concurrent writers still serialize and can amplify SQLITE_BUSY storms.\n\n2. Read/write separation (two pools):\n   - Read pool: larger, optimized for short transactions.\n   - Write pool: small (often 1-2), optionally guarded by a semaphore so writes queue in-process instead of hammering SQLite.\n   - Benefit: controlled writer concurrency prevents lock-thrash.\n\n## Config Schema (Proposal)\n- Keep existing envs but add explicit knobs:\n  - `DATABASE_POOL_SIZE`, `DATABASE_MAX_OVERFLOW`, `DATABASE_POOL_TIMEOUT_MS`\n  - Optional: `DATABASE_WRITE_POOL_SIZE`, `DATABASE_WRITE_POOL_TIMEOUT_MS`\n  - Optional: `DATABASE_POOL_WARMUP_MIN` (or reuse pool_size)\n\n## Guardrails\n- Enforce a hard max connections per process to avoid OS fd exhaustion.\n- Define default timeouts that fail fast under overload and let backpressure handle (br-15dv.3.4).\n\n## Acceptance Criteria\n- Pick a concrete model (single vs split) with explicit tradeoffs documented.\n- Define the final env/config knobs and default values.\n","created_at":"2026-02-07T05:49:04Z"},{"id":24,"issue_id":"br-15dv.1.1.2","author":"Dicklesworthstone","text":"## Design Decision (Draft)\n\n### Key Observation\nMost tools (e.g. `send_message`) do many short DB round-trips (resolve project/agent, contact checks, reservations, etc.). They do not hold a single DB connection across the full tool call. Under concurrency, **pool acquire latency** is the first-order limiter.\n\n### Read/Write Separation Complexity\nTrue read/write separation at the DB layer (reads go to a large pool, writes to a small pool) requires one of:\n- Routing at the query layer (many edits): `queries.rs` / `TrackedConnection` must pick read vs write acquire.\n- A low-level SQL classifier + write gate (riskier; can hold connections while waiting).\n\nGiven we are optimizing for rock-solid behavior and minimizing regression surface, we should land improvements in phases.\n\n### Phase 1 (This bead)\n- Increase SQLite pool defaults to a scale-appropriate baseline (no more 3+4=7).\n- Keep config overrides via `DATABASE_POOL_SIZE`, `DATABASE_MAX_OVERFLOW`, `DATABASE_POOL_TIMEOUT`.\n- Add optional startup warmup to avoid first-burst latency.\n\n### Phase 2 (Follow-up if needed)\n- Introduce `DbPool::acquire_read` / `DbPool::acquire_write` APIs.\n- Route high-frequency SELECT-only queries to read acquire.\n- Route INSERT/UPDATE/DELETE to write acquire (either manual routing per query fn or a safe classifier).\n\n### Success Metrics\n- Under br-15dv.9.* stress, `db.pool_acquire_latency_us` p95 stays in \"Green\" and timeouts are ~0.\n- No SQLITE_BUSY storms during burst warmup.\n","created_at":"2026-02-07T05:54:27Z"}]}
{"id":"br-15dv.1.1.3","title":"Stress tests + budgets for pool acquire latency","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T05:48:25.491123807Z","created_by":"ubuntu","updated_at":"2026-02-07T05:49:04.146838633Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["db","pool","tests"],"dependencies":[{"issue_id":"br-15dv.1.1.3","depends_on_id":"br-15dv.1.1","type":"parent-child","created_at":"2026-02-07T05:48:25.491123807Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.1.1.3","depends_on_id":"br-15dv.1.1.1","type":"blocks","created_at":"2026-02-07T05:48:35.364194469Z","created_by":"ubuntu","metadata":"{}","thread_id":""}],"comments":[{"id":21,"issue_id":"br-15dv.1.1.3","author":"Dicklesworthstone","text":"## Tests / Budgets\nWe need deterministic tests that prove the pool does not collapse under burst concurrency.\n\n## Proposed Tests\n- Stress acquire: spawn 200 concurrent tasks that acquire+release and run a small SELECT.\n  - Assert: no SQLITE_BUSY, no timeouts.\n- Acquire latency budget (scaled-down):\n  - After warmup, assert acquire p95 stays below an agreed threshold in CI.\n  - Prefer checking histogram bucket ceilings rather than exact milliseconds.\n\n## Acceptance Criteria\n- At least one new stress test exists in `crates/mcp-agent-mail-db/tests/`.\n- Test output is actionable (prints pool stats + histogram snapshot on failure).\n","created_at":"2026-02-07T05:49:04Z"}]}
{"id":"br-15dv.1.10","title":"SQLite connection init hardening: busy_timeout-first + one-time WAL/migration gate","description":"## Problem\nUnder concurrent pool warmup / connection creation, new connections can hit `SQLITE_BUSY` *before* `busy_timeout` is established. We already have stress-test comments indicating this race:\n- multiple connections simultaneously running PRAGMA + CREATE TABLE/migrations\n- if the first statement is `PRAGMA journal_mode=WAL`, it may require a write lock and fail fast\n\nThis is exactly the kind of high-concurrency IO bug that becomes frequent at 1000 agents.\n\n## Current State (as observed in code)\n- Per-connection init runs a multi-statement PRAGMA block (schema::PRAGMA_SETTINGS_SQL).\n- The PRAGMA block currently starts with `journal_mode=WAL`.\n- Migrations can be invoked during connection creation.\n\n## Solution\n1. **Make lock-acquisition robust on first contact**\n   - Ensure `busy_timeout` is set *before* any PRAGMA that may require a write lock.\n   - Reorder PRAGMAs so `busy_timeout` is first.\n2. **One-time DB initialization gate** (per SQLite file)\n   - For file-backed DBs, run a one-time initialization critical section:\n     - set WAL mode\n     - run migrations\n     - run ANALYZE (optional)\n   - All other connection creations skip these DB-wide mutations.\n   - Gate can be a process-local `OnceLock` keyed by sqlite_path, plus (optional) a filesystem lock file for multi-process safety.\n3. **Conformance + stress validation**\n   - Add/extend stress test to warm up N connections concurrently and assert: 0 SQLITE_BUSY, 0 migration races.\n\n## Deliverables\n- PRAGMA ordering change + tests.\n- A per-db initialization gate (documented).\n\n## Acceptance Criteria\n- Concurrent pool warmup (>= 50 simultaneous connection creations) completes with 0 SQLITE_BUSY.\n- No migration races; schema version ends correct.\n- No regressions in existing conformance/bench suites.\n\n## Files\n- crates/mcp-agent-mail-db/src/schema.rs\n- crates/mcp-agent-mail-db/src/pool.rs\n- crates/mcp-agent-mail-db/tests/stress.rs","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-07T03:39:58.427263815Z","created_by":"ubuntu","updated_at":"2026-02-07T05:15:54.566233258Z","closed_at":"2026-02-07T05:15:54.566203272Z","close_reason":"Reordered PRAGMAs so busy_timeout is applied before any lock-taking PRAGMA; introduced per-sqlite-file async OnceCell init gate to set WAL and run migrations once; added 50-thread pool warmup stress test asserting no SQLITE_BUSY + all migrations applied. fmt/check/clippy/tests pass.","source_repo":".","compaction_level":0,"original_size":0,"labels":["db","reliability","sqlite"],"dependencies":[{"issue_id":"br-15dv.1.10","depends_on_id":"br-15dv.1","type":"parent-child","created_at":"2026-02-07T03:39:58.427263815Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.1.2","title":"Read cache overhaul: LRU eviction, larger capacity, adaptive TTL","description":"PROBLEM: Cache caps at 1000 entries/category with 60s agent TTL. At 1000+ agents, every agent insertion triggers eviction check (cache.rs:161-168), cache hit rate drops to ~0%, and every tool call hits the DB.\n\nCURRENT CODE (cache.rs:20-21):\n  AGENT_TTL = 60s\n  MAX_ENTRIES_PER_CATEGORY = 1000\n\nSOLUTION: Complete cache overhaul:\n1. Increase MAX_ENTRIES_PER_CATEGORY to 16,384 (still <2MB memory)\n2. Increase AGENT_TTL to 300s (agents making calls every few minutes stay cached)\n3. Implement true LRU eviction using intrusive linked list (not just capacity check)\n4. Add adaptive TTL: frequently-accessed entries get longer TTL (up to 600s)\n5. Add cache warming on startup: pre-load all agents for projects in STORAGE_ROOT\n6. Add cache hit/miss ratio metrics (atomic counters, zero-lock)\n7. Replace HashMap with IndexMap for O(1) LRU eviction\n\nMEMORY BUDGET: 16K entries  200 bytes avg = 3.2MB (acceptable for 1000-agent workload)\n\nVALIDATION: stress_cache_coherency test must pass with 2000 agents and 30s agent TTL.\n\nFILES: crates/mcp-agent-mail-db/src/cache.rs","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:27:00.865739723Z","created_by":"ubuntu","updated_at":"2026-02-07T03:33:54.244342018Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["cache","db","perf"],"dependencies":[{"issue_id":"br-15dv.1.2","depends_on_id":"br-15dv.1","type":"parent-child","created_at":"2026-02-07T03:27:00.865739723Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.1.2","depends_on_id":"br-15dv.1.1","type":"blocks","created_at":"2026-02-07T03:33:54.244253682Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.1.3","title":"Shard deferred touch queue into 16 lock-independent segments","description":"PROBLEM: The deferred touch queue uses a single Mutex<HashMap<i64, i64>> (cache.rs:210-232). Every tool call acquires this mutex to record agent activity. At 100 concurrent tool calls/sec, this serializes all requests through one lock.\n\nCURRENT CODE (cache.rs:214-224):\n  let mut touches = self.deferred_touches.lock().unwrap_or_else(...)\n  touches.insert(agent_id, ts_micros);\n\nSOLUTION: Shard the deferred touch queue to eliminate contention:\n1. Replace single Mutex<HashMap> with 16 shards: [Mutex<HashMap<i64, i64>>; 16]\n2. Shard key: agent_id % 16 (deterministic, even distribution)\n3. Each flush cycle drains all shards independently\n4. Consider using parking_lot::Mutex for smaller/faster mutex (12 bytes vs 40 bytes)\n5. Alternative: use DashMap (concurrent HashMap) if parking_lot isn't available\n\nEXPECTED IMPROVEMENT: 16x reduction in lock contention on touch path.\n\nVALIDATION: stress_deferred_touch_batch_correctness with 100 threads must show no regressions.\n\nFILES: crates/mcp-agent-mail-db/src/cache.rs","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:27:01.006492153Z","created_by":"ubuntu","updated_at":"2026-02-07T03:33:54.380072728Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["db","locks","perf"],"dependencies":[{"issue_id":"br-15dv.1.3","depends_on_id":"br-15dv.1","type":"parent-child","created_at":"2026-02-07T03:27:01.006492153Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.1.3","depends_on_id":"br-15dv.1.2","type":"blocks","created_at":"2026-02-07T03:33:54.380002086Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.1.4","title":"Lock-free query tracker with atomic counters and pre-computed table IDs","description":"PROBLEM: The query tracker locks a global Mutex on EVERY database query (tracking.rs:100-130). It also runs extract_table() regex on every query. At 500 queries/sec (1000 agents  5 queries/tool_call  10% active), this is a massive serialization point.\n\nCURRENT CODE (tracking.rs:110-113):\n  let mut inner = self.inner.lock().unwrap_or_else(...)\n  // update per-table counters\n  // check slow query threshold\n\nSOLUTION: Lock-free redesign:\n1. Replace per-table Mutex<HashMap<String, Counter>> with array of AtomicU64 counters\n   - Pre-allocate slots for known tables (projects, agents, messages, etc.)\n   - Use enum TableId -> usize index for O(1) lookup\n2. Use thread-local slow query buffers, periodically merged into global log\n3. Pre-compute table extraction: embed table name in query metadata at call site instead of parsing SQL at runtime\n4. Make tracking opt-in per query (not every query needs tracking)\n5. Add separate AtomicU64 for total_queries, total_duration_us (no lock needed)\n\nEXPECTED IMPROVEMENT: Zero lock contention on query hot path. O(1) atomic increment per query.\n\nFILES: crates/mcp-agent-mail-db/src/tracking.rs, crates/mcp-agent-mail-db/src/queries.rs","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:27:01.157527907Z","created_by":"ubuntu","updated_at":"2026-02-07T03:27:01.157527907Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["db","locks","perf"],"dependencies":[{"issue_id":"br-15dv.1.4","depends_on_id":"br-15dv.1","type":"parent-child","created_at":"2026-02-07T03:27:01.157527907Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.1.5","title":"Add missing composite indexes for hot-path queries (v4 migration)","description":"PROBLEM: Several hot-path queries lack optimal indexes, causing full table scans at scale.\n\nMISSING INDEXES IDENTIFIED:\n1. message_recipients(agent_id, ack_ts)  views/ack-required scans all recipients for an agent\n2. messages(thread_id, created_at)  thread queries sort by timestamp\n3. file_reservations(project_id, agent_id, expires_at)  force-release scans by project+agent\n4. messages(project_id, importance, created_at)  urgent-unread view filters by importance\n5. agent_links(a_project_id, a_agent_id, status)  contact list queries\n\nEXISTING INDEXES (schema.rs:78-100):\n  idx_message_recipients_agent(agent_id)\n  idx_message_recipients_agent_message(agent_id, message_id)\n  idx_file_reservations_project(project_id)\n  idx_agents_project_name(project_id, name)\n\nSOLUTION: Add v4 migration with covering indexes for hot-path queries:\n1. CREATE INDEX idx_mr_agent_ack ON message_recipients(agent_id, ack_ts)\n2. CREATE INDEX idx_msg_thread_created ON messages(thread_id, created_at)\n3. CREATE INDEX idx_fr_project_agent_expires ON file_reservations(project_id, agent_id, expires_at)\n4. CREATE INDEX idx_msg_project_importance ON messages(project_id, importance, created_at)\n5. CREATE INDEX idx_al_a_status ON agent_links(a_project_id, a_agent_id, status)\n6. Run ANALYZE after creating indexes\n\nVALIDATION: EXPLAIN QUERY PLAN for each hot-path query must show index usage.\n\nFILES: crates/mcp-agent-mail-db/src/schema.rs (v4 migration)","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:27:01.304697522Z","created_by":"ubuntu","updated_at":"2026-02-07T03:27:01.304697522Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["db","indexes","perf"],"dependencies":[{"issue_id":"br-15dv.1.5","depends_on_id":"br-15dv.1","type":"parent-child","created_at":"2026-02-07T03:27:01.304697522Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.1.6","title":"PRAGMA tuning for high-concurrency 1000-agent workload","description":"PROBLEM: SQLite PRAGMAs materially affect throughput and tail latency under high concurrency, but naive tuning can easily create new failure modes (memory blowups, long checkpoints, IO spikes).\n\nCURRENT STATE:\n- PRAGMAs are applied per connection via a multi-statement block in `schema.rs`.\n- Settings include WAL + synchronous=NORMAL + busy_timeout, plus cache_size/mmap_size/temp_store/threads.\n\nCRITICAL NUANCE (do not forget):\n- `PRAGMA cache_size` is effectively **per connection**. Increasing pool max_connections (br-15dv.1.1) multiplies total cache memory.\n- `mmap_size` is configured per connection (the OS may share pages, but the virtual mapping can still be large).\n\nSOLUTION: PRAGMA tuning as a *budgeted, measured* change set:\n1. Define a memory budget for DB + page cache in br-15dv.10 terms (e.g., <= 512MB total on a dev box).\n2. Derive per-connection cache_size from max_connections (e.g., 8-32MB per connection, not 512MB).\n3. Tune WAL checkpoint behavior for bursty writes:\n   - wal_autocheckpoint\n   - journal_size_limit\n   - explicit checkpoint strategy (on idle / shutdown / export)\n4. Consider splitting read/write pool (br-15dv.1.1) and allocating more cache to the write pool if needed.\n5. Add a benchmark + stress validation loop:\n   - compare p95/p99 latencies and throughput before/after\n   - ensure no regression under sustained write bursts\n\nDELIVERABLES:\n- A documented PRAGMA set for the target load model.\n- Bench artifacts showing improvement (or revert if not).\n\nVALIDATION:\n- Bench suite shows >= 10% improvement on at least one bottleneck scenario without worsening p99.\n- No memory explosion when max_connections increases.\n\nFILES:\n- crates/mcp-agent-mail-db/src/schema.rs\n- crates/mcp-agent-mail-db/src/pool.rs","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:27:01.447651584Z","created_by":"ubuntu","updated_at":"2026-02-07T03:41:59.012581775Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["db","perf","sqlite"],"dependencies":[{"issue_id":"br-15dv.1.6","depends_on_id":"br-15dv.1","type":"parent-child","created_at":"2026-02-07T03:27:01.447651584Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.1.6","depends_on_id":"br-15dv.1.1","type":"blocks","created_at":"2026-02-07T03:33:54.772614333Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.1.7","title":"Static config caching with OnceLock to eliminate per-request env parsing","description":"PROBLEM: Config::from_env() appears to be called per-request in tool handlers (messaging.rs:346, reservations.rs:281). This parses 40+ environment variables, does string conversions, and allocates on every single tool call.\n\nCURRENT PATTERN (in tool handlers):\n  let config = Config::from_env();\n  // use config...\n\nSOLUTION: Cache config in a global static:\n1. Add OnceLock<Config> global singleton\n2. Config::get() returns &'static Config (zero-cost after first call)\n3. Add Config::reload() for runtime reconfiguration (acquires write lock, replaces config)\n4. Make Config fields public but immutable (no interior mutability needed)\n5. Remove all Config::from_env() calls in tool handlers, replace with Config::get()\n\nEXPECTED IMPROVEMENT: Eliminate ~40 env var lookups + string allocations per tool call.\n\nVALIDATION: All conformance tests must pass. Config changes via env should apply on reload.\n\nFILES: crates/mcp-agent-mail-core/src/config.rs, crates/mcp-agent-mail-tools/src/*.rs","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:27:01.593309799Z","created_by":"ubuntu","updated_at":"2026-02-07T03:27:01.593309799Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["config","perf"],"dependencies":[{"issue_id":"br-15dv.1.7","depends_on_id":"br-15dv.1","type":"parent-child","created_at":"2026-02-07T03:27:01.593309799Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.1.8","title":"Prepared statement cache for hot-path SQL queries","description":"PROBLEM: SQLite re-parses and re-plans every SQL query on every execution. At 500 queries/sec, the parser/planner overhead is significant.\n\nSOLUTION: Add prepared statement caching:\n1. Create PreparedStatementCache per connection (HashMap<&'static str, PreparedStatement>)\n2. For hot-path queries (ensure_project, resolve_agent, fetch_inbox, send_message), use static SQL strings as cache keys\n3. On cache miss, prepare + cache. On cache hit, rebind parameters and execute.\n4. Clear cache on connection recycle (every 30 minutes)\n5. Integration with sqlmodel_rust: check if prepare_cached() or similar API exists\n6. If sqlmodel_rust doesn't support this, implement at the queries.rs level with raw connection access\n\nNOTE: This depends on sqlmodel_rust API. May need upstream changes to /dp/sqlmodel_rust.\n\nEXPECTED IMPROVEMENT: 30-50% reduction in query execution overhead for repeated queries.\n\nVALIDATION: Benchmark suite must show measurable improvement in tool latency.\n\nFILES: crates/mcp-agent-mail-db/src/queries.rs, /dp/sqlmodel_rust (if needed)","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:27:01.741345556Z","created_by":"ubuntu","updated_at":"2026-02-07T03:33:54.509808091Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["db","perf","sqlite"],"dependencies":[{"issue_id":"br-15dv.1.8","depends_on_id":"br-15dv.1","type":"parent-child","created_at":"2026-02-07T03:27:01.741345556Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.1.8","depends_on_id":"br-15dv.1.1","type":"blocks","created_at":"2026-02-07T03:33:54.509756234Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.1.9","title":"Write transaction batching to reduce fsync overhead","description":"PROBLEM: Each send_message does multiple individual writes (INSERT message, INSERT recipients, UPDATE agent last_active_ts) as separate transactions. SQLite WAL commits sync to disk per transaction. At 100 messages/sec, this is 300+ fsyncs/sec.\n\nSOLUTION: Batch related writes into single transactions:\n1. Wrap send_message writes in explicit BEGIN/COMMIT (message + all recipients in one tx)\n2. Group deferred touch flushes into single transaction (already partially done)\n3. For bulk operations (macro_start_session), wrap all DB writes in one transaction\n4. Add a BatchWriter utility that collects writes and commits periodically (every 10ms or 50 ops)\n5. Ensure transaction boundaries are correct: no holding transactions across async awaits\n\nEXPECTED IMPROVEMENT: 3-5x reduction in fsync overhead for message-heavy workloads.\n\nCAUTION: Must not hold transactions open for too longblocks other writers in WAL mode.\n\nVALIDATION: stress_concurrent_message_sending must show 2x throughput improvement.\n\nFILES: crates/mcp-agent-mail-db/src/queries.rs, crates/mcp-agent-mail-tools/src/messaging.rs","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:27:01.888627271Z","created_by":"ubuntu","updated_at":"2026-02-07T03:33:54.639436403Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["db","perf","transactions"],"dependencies":[{"issue_id":"br-15dv.1.9","depends_on_id":"br-15dv.1","type":"parent-child","created_at":"2026-02-07T03:27:01.888627271Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.1.9","depends_on_id":"br-15dv.1.1","type":"blocks","created_at":"2026-02-07T03:33:54.639374267Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.10","title":"Define 1000-agent SLOs, load model, and perf budgets","description":"## Purpose\nMake the performance/reliability target *explicit* so every optimization has a clear success metric and we can avoid cargo-cult tuning.\n\n## Background\n\"1000+ concurrent agents\" is ambiguous unless we define:\n- concurrency vs throughput,\n- operation mix (reads vs writes),\n- payload sizes,\n- burstiness/thundering herd patterns,\n- acceptable failure modes and what counts as a regression.\n\nThis issue defines the contract we will enforce via benchmarks and stress tests.\n\n## Deliverables\n1. **Workload model** (documented in this bead):\n   - number of projects\n   - number of agents\n   - concurrency (in-flight HTTP requests)\n   - request mix (fetch_inbox/resources/search/send_message/reservations/acks/macros)\n   - burst patterns (message storm, polling storm)\n   - payload distributions (subject/body sizes, attachment sizes)\n2. **SLOs per operation class** (initial numbers; we can iterate after baseline):\n   - Tool calls (typical): p95 <= 100ms, p99 <= 250ms\n   - Read-only calls (fetch_inbox/resources/search): p95 <= 50ms, p99 <= 150ms\n   - send_message (no attachments): p95 <= 150ms, p99 <= 400ms\n   - send_message (attachments): p95 <= 500ms, p99 <= 1500ms (bounded by CPU encode)\n   - Server-wide error rate: < 0.1% for non-overload, and overload returns must be 429/503 with retry guidance\n3. **Queue/resource budgets**:\n   - All queues bounded; document capacity targets and overflow policy (drop/defer/block)\n   - WBQ and commit backlog maximum acceptable depth + drain rate targets\n   - DB pool acquire p95 target (<= 10ms Green, <= 50ms Yellow, > 200ms Red)\n4. **Definition of \"rock solid\"**:\n   - no deadlocks/hangs\n   - no unbounded RSS growth\n   - no data corruption (integrity checks)\n   - crash/restart recovery expectations\n\n## Notes / Constraints\n- DB is authoritative; archive writes are best-effort and must never block tool responses.\n- Conformance fixtures/golden outputs remain the behavior guard rail.\n\n## Acceptance Criteria\n- A single written load model + SLO/budgets section exists in this bead description.\n- br-15dv.8.* and br-15dv.9.* reference these SLOs (bench assertions use them).","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:35:43.689725034Z","created_by":"ubuntu","updated_at":"2026-02-07T03:35:43.689725034Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["perf","scale"],"dependencies":[{"issue_id":"br-15dv.10","depends_on_id":"br-15dv","type":"parent-child","created_at":"2026-02-07T03:35:43.689725034Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.11","title":"Baseline + profile: capture flamegraphs, syscall stats, and golden perf artifacts","description":"## Purpose\nEstablish the *truth* before we change anything: where time is spent, where contention occurs, and what the real p50/p95/p99 looks like under the br-15dv.10 load model.\n\n## Extreme Optimization Loop Alignment\nThis bead implements steps 1-2 of the optimization loop:\n1. BASELINE (hyperfine / criterion / load harness)\n2. PROFILE (flamegraph, heap, syscalls)\n\n## Deliverables\n1. **Baseline runs** (recorded as artifacts under tests/artifacts or benches artifacts):\n   - existing Criterion benches (tools + archive_write + share_export)\n   - hyperfine for representative CLI commands (server start, key CLI subcommands)\n2. **Profiles** (on representative scenarios):\n   - CPU: `cargo flamegraph` for:\n     - fetch_inbox\n     - send_message (no attachments)\n     - file_reservation_paths (overlap check)\n     - search_messages\n   - Syscalls: `strace -c` style syscall aggregation for server request path\n   - Allocation: heap profiling (heaptrack or equivalent) on message storm scenario\n3. **Opportunity Matrix** populated with top hotspots:\n   - location (func/file)\n   - Impact/Confidence/Effort score\n   - chosen optimization ordering\n4. **Golden perf artifacts**:\n   - checksums / baseline JSON summary saved so we can prove \"improved\" rather than guessing\n\n## Acceptance Criteria\n- A baseline+profile artifact set exists and is referenced by subsequent perf tasks.\n- Opportunity Matrix has at least 10 candidate hotspots, and the first 3 have Score >= 2.0.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:35:54.451056977Z","created_by":"ubuntu","updated_at":"2026-02-07T03:39:01.399361335Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["perf","profiling"],"dependencies":[{"issue_id":"br-15dv.11","depends_on_id":"br-15dv","type":"parent-child","created_at":"2026-02-07T03:35:54.451056977Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.11","depends_on_id":"br-15dv.10","type":"blocks","created_at":"2026-02-07T03:39:01.399284882Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.12","title":"Architecture note: IO surfaces, contention points, and consistency guarantees","description":"## Purpose\nProduce a self-contained, code-linked architecture note focused on performance/reliability at scale.\n\nThis is not a generic \"how it works\" doc; it is explicitly a map of:\n- where IO happens (SQLite, filesystem, git, subprocesses),\n- what is synchronous vs async,\n- what is on the request hot path vs background,\n- what guarantees we provide (strong vs eventual) and what we intentionally relax.\n\n## Deliverables\n1. **IO surface map** (with file pointers):\n   - DB: pool acquisition, migrations, PRAGMAs, write transactions\n   - Storage: WBQ write-behind, commit coalescer, file locks\n   - Notifications: signal file semantics (what must be synchronous vs can be deferred)\n   - HTTP server: rate limiting, request parsing, tool dispatch\n2. **Contention points**:\n   - global locks / mutex hot paths\n   - SQLite writer serialization\n   - git index.lock contention and commit batching\n3. **Correctness invariants**:\n   - message id uniqueness and ordering semantics\n   - reservation overlap decision semantics (what is \"authoritative\")\n   - ack/read idempotency\n4. **Failure and recovery paths**:\n   - what happens on crash mid-write\n   - how stale locks are handled\n   - integrity checks and \"doctor\" repair boundaries\n\n## Acceptance Criteria\n- A single document exists as an issue description (or notes) with concrete file/struct/function references.\n- The doc is sufficient for a new contributor to reason about scaling changes without reading the legacy Python repo.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:36:09.108099900Z","created_by":"ubuntu","updated_at":"2026-02-07T05:48:02.839668311Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["architecture","reliability"],"dependencies":[{"issue_id":"br-15dv.12","depends_on_id":"br-15dv","type":"parent-child","created_at":"2026-02-07T03:36:09.108099900Z","created_by":"ubuntu","metadata":"{}","thread_id":""}],"comments":[{"id":20,"issue_id":"br-15dv.12","author":"Dicklesworthstone","text":"## Architecture Map (Scale-Oriented)\n\n### Crate Boundaries\n- Server/router: `crates/mcp-agent-mail-server/src/lib.rs`\n  - HTTP transport + auth/RBAC/rate-limit + tool/resource dispatch.\n- Tools/resources: `crates/mcp-agent-mail-tools/src/*.rs`\n  - Tool handlers and resource renderers.\n  - `health_check`, identity, messaging, reservations, products, etc.\n- DB/index layer (SQLite): `crates/mcp-agent-mail-db/src/*.rs`\n  - Pool: `crates/mcp-agent-mail-db/src/pool.rs`\n  - PRAGMAs/migrations: `crates/mcp-agent-mail-db/src/schema.rs`\n  - Queries: `crates/mcp-agent-mail-db/src/queries.rs`\n  - Read caches / deferred touches: `crates/mcp-agent-mail-db/src/cache.rs`\n- Storage/archive layer (git-backed): `crates/mcp-agent-mail-storage/src/lib.rs`\n  - Archive writes, file locks, commit batching/coalescing, WBQ.\n- Core utilities: `crates/mcp-agent-mail-core/src/*.rs`\n  - Config, lock ordering (`lock_order.rs`), global metrics (`metrics.rs`).\n\n### Hot-Path Flows\n- Tool call (write): server -> tool -> (DB read/cache) -> archive write (WBQ or sync fallback) -> DB index update -> response.\n- Tool call (read/resource): server -> tool/resource -> DB fast path (cache/FTS) -> optional archive read fallback.\n\n## IO Surfaces (What blocks?)\n- SQLite:\n  - Pool acquire and PRAGMA/conn init: `crates/mcp-agent-mail-db/src/pool.rs`, `crates/mcp-agent-mail-db/src/schema.rs`\n  - Query execution: `crates/mcp-agent-mail-db/src/queries.rs`\n- Filesystem + git:\n  - Archive locks and file writes: `crates/mcp-agent-mail-storage/src/lib.rs`\n  - Commit coalescer + index.lock handling: `crates/mcp-agent-mail-storage/src/lib.rs`\n- Subprocess/CPU heavy:\n  - WebP conversion (attachments): `crates/mcp-agent-mail-storage/src/lib.rs`\n\n## Contention Points (1000-agent risks)\n- SQLite is a single-writer system; bursts create lock contention.\n- Pool sizing and acquire latency dominate tail when undersized.\n- WBQ fallback-to-sync path reintroduces blocking IO on the request path.\n- Git `index.lock` contention under high commit rates.\n- Per-project `.archive.lock` serialization.\n- Global locks/caches (even with ordered locks) can serialize high-frequency operations.\n\n## Observability Hooks\n- Metrics core: `crates/mcp-agent-mail-core/src/metrics.rs`\n  - DB pool acquire latency histogram + pool utilization gauges.\n  - HTTP/tool call counters/latency.\n  - WBQ enqueue/drain counters.\n- `resource://tooling/metrics_core` should be the primary always-on snapshot surface.\n\n## Consistency Guarantees\nThis repo currently documents Git archive as canonical and SQLite as rebuildable index (`SYNC_STRATEGY.md`).\n\nFor the 1000-agent target, we need an explicit, testable consistency contract:\n- what success means for each write tool (archive durable vs DB durable),\n- how retries/idempotency work,\n- how we reconcile after partial failures.\n\nTracked in: `br-15dv.6.7` (Consistency contract enforcement) and validated by `br-15dv.9.7` (crash/restart test).\n\n## Mapping to Work\n- DB scalability: `br-15dv.1.*`\n- Storage/git throughput: `br-15dv.2.*`\n- Concurrency/backpressure: `br-15dv.3.*`\n- Metrics/diagnostics: `br-15dv.8.*`\n- Resilience: `br-15dv.6.*`\n- Stress/chaos: `br-15dv.9.*`\n","created_at":"2026-02-07T05:48:02Z"}]}
{"id":"br-15dv.2","title":"[track] Storage/archive optimization for high-throughput git operations","description":"The git archive layer is the #2 bottleneck. The Write-Behind Queue (WBQ) has only 256 capacity and falls back to synchronous git commits when fulldefeating its entire purpose. The commit queue is a single global Mutex<VecDeque> with max_queue_size=100. At 1000 agents, bursts of 300+ messages overflow both queues, causing synchronous git operations that contend for index.lock. This track addresses: WBQ capacity, per-project commit queues, smart git lock handling, signal batching, and parallel attachment processing.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:25:36.187025573Z","created_by":"ubuntu","updated_at":"2026-02-07T03:25:36.187025573Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["git","perf","storage"],"dependencies":[{"issue_id":"br-15dv.2","depends_on_id":"br-15dv","type":"parent-child","created_at":"2026-02-07T03:25:36.187025573Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.2.1","title":"WBQ capacity 2568192 with backpressure monitoring and adaptive drain","description":"PROBLEM: WBQ channel has 256 capacity (lib.rs:176). When full, try_send() fails and callers fall back to SYNCHRONOUS git commits (lib.rs:205-215). At 1000 agents, message bursts of 300+ overflow the queue, causing the exact synchronous IO the WBQ was designed to prevent.\n\nCURRENT CODE (storage/lib.rs:176-178):\n  WBQ_CHANNEL_CAPACITY = 256\n  WBQ_DRAIN_BATCH_CAP = 64\n  WBQ_FLUSH_INTERVAL_MS = 100\n\nSOLUTION: Increase capacity + add backpressure monitoring:\n1. Increase WBQ_CHANNEL_CAPACITY to 8192 (32x larger)\n2. Increase WBQ_DRAIN_BATCH_CAP to 256 (4x larger batches)\n3. Add backpressure metrics: queue depth (AtomicUsize), high-water mark, overflow count\n4. Add adaptive drain rate: when queue > 50% full, drain faster (50ms interval)\n5. Add WBQ health check: expose queue depth via tooling/metrics resource\n6. Replace try_send() fallback: instead of sync commit, add bounded blocking send with 100ms timeout\n7. Add per-project quotas to prevent one chatty project from flooding the queue\n8. Add WBQ drain thread monitoring: detect if drain thread is stuck/dead\n\nMEMORY IMPACT: 8192 entries  ~2KB avg = ~16MB max (acceptable)\n\nVALIDATION: New stress test: send 1000 messages in 100ms burst, verify zero sync fallbacks.\n\nFILES: crates/mcp-agent-mail-storage/src/lib.rs","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-07T03:27:56.937705650Z","created_by":"ubuntu","updated_at":"2026-02-07T22:31:23.403513034Z","closed_at":"2026-02-07T22:31:23.403474702Z","close_reason":"WBQ: raised channel capacity to 8192 and drain batch cap to 256; on full, apply bounded backpressure (try_send loop up to 100ms) instead of triggering synchronous archive writes; removed sync fallback paths in tools; health_check now reports WBQ backpressure_total and fixture updated. Quality gates: cargo fmt/clippy/test.","source_repo":".","compaction_level":0,"original_size":0,"labels":["perf","storage","wbq"],"dependencies":[{"issue_id":"br-15dv.2.1","depends_on_id":"br-15dv.2","type":"parent-child","created_at":"2026-02-07T03:27:56.937705650Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.2.1","depends_on_id":"br-15dv.2.6","type":"blocks","created_at":"2026-02-07T03:41:00.529109379Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.2.1","depends_on_id":"br-15dv.8.3","type":"blocks","created_at":"2026-02-07T03:37:16.876491932Z","created_by":"ubuntu","metadata":"{}","thread_id":""}],"comments":[{"id":11,"issue_id":"br-15dv.2.1","author":"Dicklesworthstone","text":"CAPACITY MATH: At 1000 agents  10% active  1 msg/10s = 10 msgs/sec steady state. Burst: 100 agents send simultaneously = 100 msgs in 1s. WBQ drain rate: 256 ops/100ms batch  10 batches/s = 2560 ops/sec (well above steady state). But burst exceeds 256 capacity in 2.56 seconds of accumulated backlog. With 8192 capacity: can absorb 82 seconds of burst at 100 msg/sec before filling. This provides massive headroom for spikes while the drain thread catches up. The adaptive drain (50ms interval when >50% full) doubles drain throughput to 5120 ops/sec.","created_at":"2026-02-07T03:34:38Z"}]}
{"id":"br-15dv.2.2","title":"Per-project commit queues to eliminate cross-project serialization","description":"PROBLEM: Cross-project git commits still serialize more than necessary.\n\nCurrent reality in the Rust codebase:\n- The primary production path is the **CommitCoalescer** (global OnceLock + single worker thread).\n- Requests are batched, but a single worker still sequences commits across all repo roots.\n- Under 1000 agents across many projects, unrelated projects can still contend on the same commit pipeline.\n\nWhy this matters:\n- Even if DB is fast, archive throughput becomes the limiting factor.\n- Backlog growth can amplify memory/disk pressure unless bounded (see br-15dv.2.6).\n\nSOLUTION: Per-repo isolation and parallelism (without reintroducing index.lock storms):\n1. Keep batching/coalescing, but shard the pipeline by repo_root:\n   - Option A: per-repo worker thread (lazy spawn) with its own bounded queue.\n   - Option B: fixed-size worker pool with consistent hashing (repo_root -> worker).\n2. Each repo_root queue merges ops over a short flush window (e.g., 25-100ms).\n3. Metrics per repo_root:\n   - queue depth, drain rate, commit latency, retry counts\n4. Fairness:\n   - prevent one hot project from starving others (per-repo quotas or round-robin drain)\n\nEXPECTED IMPROVEMENT: Parallelism across projects (50 projects should not behave like 1 project).\n\nVALIDATION:\n- Stress: many projects sending concurrently shows near-linear scaling until IO saturates.\n- Queue saturation test (br-15dv.9.4) demonstrates bounded behavior.\n\nFILES: crates/mcp-agent-mail-storage/src/lib.rs","status":"in_progress","priority":0,"issue_type":"task","created_at":"2026-02-07T03:27:57.076738620Z","created_by":"ubuntu","updated_at":"2026-02-07T22:31:58.038622848Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["git","perf","storage"],"dependencies":[{"issue_id":"br-15dv.2.2","depends_on_id":"br-15dv.2","type":"parent-child","created_at":"2026-02-07T03:27:57.076738620Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.2.2","depends_on_id":"br-15dv.2.1","type":"blocks","created_at":"2026-02-07T03:33:54.898035887Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.2.3","title":"Smart git lock management with PID tracking and plumbing-based commits","description":"PROBLEM: Git index.lock contention is the #1 cause of failures in the Python version. The Rust coalescer retries 6 times with jitter (~6s total), then force-removes locks >60s old. This is dangerous: legitimate long operations (repack, large commits) can have locks removed prematurely.\n\nCURRENT CODE (storage/lib.rs):\n  - Jittered backoff: 50ms base, 30ms jitter, 6 retries\n  - Stale lock cleanup: removes locks >60s after attempt 3\n  - Last-resort: removes locks >30s on final retry\n\nSOLUTION: Smarter git lock management:\n1. Write PID + timestamp to a .git/index.lock.owner file when we create locks\n2. Before removing \"stale\" locks, check if the owning PID is still alive (kill(pid, 0))\n3. If PID is dead, safe to remove. If alive, DO NOT remove (it's a legitimate operation)\n4. Increase stale threshold to 120s (was 60s)\n5. Add lock acquisition timeout metric (AtomicU64 histogram)\n6. Add git lock-free commit path: use git plumbing commands (hash-object, update-index, write-tree, commit-tree) that don't need index.lock\n7. Fall back to lock-based commit only when plumbing path fails\n\nEXPECTED IMPROVEMENT: Eliminate premature lock removal + enable lock-free commits.\n\nVALIDATION: E2E test with 10 concurrent agents committing to same project.\n\nFILES: crates/mcp-agent-mail-storage/src/lib.rs","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:27:57.225093735Z","created_by":"ubuntu","updated_at":"2026-02-07T03:33:55.032728093Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["git","resilience","storage"],"dependencies":[{"issue_id":"br-15dv.2.3","depends_on_id":"br-15dv.2","type":"parent-child","created_at":"2026-02-07T03:27:57.225093735Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.2.3","depends_on_id":"br-15dv.2.2","type":"blocks","created_at":"2026-02-07T03:33:55.032657060Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.2.4","title":"Signal batching: coalesce notification writes with 200ms debounce","description":"PROBLEM: Notification signals write individual files to ~/mcp_agent_mail/signals/{slug}/{agent}/ for every event (mail, agent, git, expiry). At 1000 agents sending 10 messages each, this creates 10,000+ small file writes in rapid successionmassive filesystem IO and inode pressure.\n\nCURRENT: Each signal is an individual file write with optional JSON metadata.\n\nSOLUTION: Coalesce notification signals:\n1. Buffer signals in memory for 200ms before writing (similar to commit coalescer)\n2. Merge multiple signals of the same type for the same agent into one write\n3. For filesystem signals: use a single signals.jsonl append-only file per project instead of per-agent directories\n4. Reduce filesystem metadata overhead: use O_APPEND mode, not create+write+close\n5. Add signal debouncing: if same (agent, signal_type) was written in last 500ms, skip\n6. Add NOTIFICATIONS_BATCH_INTERVAL_MS config (default: 200ms)\n7. Consider using inotify/kqueue instead of polling signal files (for consumers)\n\nEXPECTED IMPROVEMENT: 100x reduction in signal file IO (10,000 writes  ~100 batched writes)\n\nFILES: crates/mcp-agent-mail-storage/src/lib.rs (signal writing), config.rs","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:27:57.364197989Z","created_by":"ubuntu","updated_at":"2026-02-07T03:27:57.364197989Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["io","perf","storage"],"dependencies":[{"issue_id":"br-15dv.2.4","depends_on_id":"br-15dv.2","type":"parent-child","created_at":"2026-02-07T03:27:57.364197989Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.2.5","title":"Parallel and cached attachment processing with async WebP conversion","description":"PROBLEM: WebP image conversion happens synchronously per attachment in the message send path. A message with 5 attachments blocks the tool call for 5x the conversion time. At scale, this ties up connections and increases p95 latency.\n\nSOLUTION: Parallelize and offload attachment processing:\n1. Move WebP conversion to the WBQ (already async)return message ID immediately, convert later\n2. For inline mode: convert synchronously (needed for response) but cap at 2 concurrent conversions\n3. For file mode: queue conversion in WBQ, store placeholder, convert async\n4. Add conversion cache: if same SHA1 was already converted, reuse the result\n5. Add concurrent conversion limit (semaphore, max 4) to prevent CPU saturation\n6. Add conversion timeout (5s per image) to prevent pathological cases\n7. Pre-compute SHA1 of attachments before conversion to enable dedup\n\nEXPECTED IMPROVEMENT: Message send latency reduced by attachment conversion time (for file mode).\n\nFILES: crates/mcp-agent-mail-storage/src/lib.rs (attachment pipeline)","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-07T03:27:57.507520200Z","created_by":"ubuntu","updated_at":"2026-02-07T03:27:57.507520200Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["attachments","perf","storage"],"dependencies":[{"issue_id":"br-15dv.2.5","depends_on_id":"br-15dv.2","type":"parent-child","created_at":"2026-02-07T03:27:57.507520200Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.2.6","title":"Commit coalescer hardening: bounded queue, queue-depth metrics, and overload-safe spill","description":"## Problem\nThe async git commit path is intentionally decoupled from tool responses, but it must be **overload-safe**:\n- no unbounded memory growth when commits fall behind\n- clear visibility into backlog and drain rate\n- deterministic behavior when the system is saturated\n\nToday, the commit coalescer uses a background worker and coalescing windows, but the request channel itself is unbounded (`std::sync::mpsc::channel()`), which can grow without limit if git commits become slower than enqueue rate.\n\n## Goals\n- Keep tool hot paths non-blocking.\n- Guarantee bounded memory usage.\n- Preserve correctness: files must be written before enqueue; eventual git commit is allowed.\n\n## Solution\n1. **Replace unbounded channel with bounded queue**\n   - Use `sync_channel(capacity)` or a bounded concurrent queue.\n   - Capacity derived from SLO/load model (br-15dv.10). Start with something like 16k ops.\n2. **Backpressure policy when full** (must be explicit and tested)\n   - Never fall back to synchronous git commit on tool hot path.\n   - Prefer:\n     - coalesce in-place (merge ops by repo_root and path set), or\n     - spill to disk (append-only \"pending commits\" log per repo), or\n     - mark \"commit-needed\" and rely on periodic scanner.\n3. **Visibility**\n   - queue depth gauge + high-water mark\n   - ops coalesced per commit\n   - commit latency histogram\n   - errors + retry counts\n4. **Shutdown correctness**\n   - flush+join semantics bounded by timeout\n   - no deadlock if worker panics\n\n## Deliverables\n- Bounded commit coalescer implementation.\n- Metrics surfaced via br-15dv.8.3 / br-15dv.8.5.\n- Stress coverage via br-15dv.9.4 (queue saturation) and chaos coverage via br-15dv.9.6.\n\n## Acceptance Criteria\n- Under queue-saturation stress (br-15dv.9.4), memory remains bounded and sync fallbacks are 0.\n- Backlog drains after burst and queue depth returns to 0.\n- Tool-call latency does not regress (git commits remain off hot path).\n\n## Files\n- crates/mcp-agent-mail-storage/src/lib.rs","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-07T03:40:14.928024873Z","created_by":"ubuntu","updated_at":"2026-02-07T22:18:01.579520233Z","closed_at":"2026-02-07T22:18:01.579469318Z","close_reason":"Implemented bounded commit coalescer channel (sync_channel) + overload spill map; removed sync git fallback for queue-full; worker drains spill on tick; added commit-all escape hatch; flush_sync uses try_send loop. Quality gates: cargo fmt/clippy/test.","source_repo":".","compaction_level":0,"original_size":0,"labels":["git","perf","reliability","storage"],"dependencies":[{"issue_id":"br-15dv.2.6","depends_on_id":"br-15dv.2","type":"parent-child","created_at":"2026-02-07T03:40:14.928024873Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.2.7","title":"Archive lock performance: add in-process per-project mutex + fix jitter for same-pid contention","description":"## Problem\nArchive writes use an advisory file lock (`.archive.lock`) with exponential backoff + jitter. This is correct for multi-process coordination, but inside a single server process:\n- multiple request threads contend on the same lock\n- the current jitter is derived from PID, so **all contending threads in the same process share identical jitter**, increasing lock-step retries (thundering herd)\n- every retry performs filesystem open+try_lock syscalls\n\nAt 1000-agent concurrency this becomes a measurable performance and IO amplification problem.\n\n## Solution\n1. **Two-level locking**\n   - In-process: `Mutex` keyed by project slug (fast, no syscalls).\n   - Cross-process: keep `.archive.lock` for multi-process safety.\n   - Acquire order: in-process mutex first, then file lock (documented).\n2. **Jitter fix**\n   - Replace PID-based jitter with per-thread randomness (xorshift seeded once per thread) so concurrent threads do not synchronize.\n3. **Minimize syscalls on contention**\n   - Prefer blocking on in-process mutex rather than spinning on file lock.\n\n## Deliverables\n- A global map: project_slug -> Arc<Mutex<()>> (sharded or DashMap to avoid global lock contention).\n- Updated FileLock jitter.\n- Stress test: many concurrent archive writes to same project shows stable throughput and no starvation.\n\n## Acceptance Criteria\n- With N concurrent sends to the same project, archive writes serialize without pathological retry storms.\n- Lock acquisition time p95 improves measurably under load.\n\n## Files\n- crates/mcp-agent-mail-storage/src/lib.rs","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:40:28.310642485Z","created_by":"ubuntu","updated_at":"2026-02-07T03:40:28.310642485Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["locks","perf","storage"],"dependencies":[{"issue_id":"br-15dv.2.7","depends_on_id":"br-15dv.2","type":"parent-child","created_at":"2026-02-07T03:40:28.310642485Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.2.8","title":"Thread digest correctness under concurrency: atomic append + header idempotency","description":"## Problem\nThe thread digest file (`messages/threads/<thread>.md`) is appended to for every message. Under concurrency, two hazards exist:\n- header initialization can race (two writers both think file is new and both write header)\n- multi-write append sequences can interleave (header and entry writes are separate writes)\n\nWhile this may not corrupt the DB, it degrades the audit-log quality and can cause confusing thread digests exactly when concurrency is high.\n\n## Solution\n1. **Single-write append discipline**\n   - Build the full append payload in memory and do a single `write_all()` call so O_APPEND is atomic with respect to other writers.\n2. **Header idempotency**\n   - Use a dedicated marker or atomic create strategy:\n     - create a separate `.init` marker file with O_EXCL, or\n     - open with O_APPEND and detect file length == 0 after open (best-effort), or\n     - guard via per-thread/per-project in-process mutex (br-15dv.2.7).\n3. **Ordering policy**\n   - Thread digest is best-effort chronological; do not attempt global ordering under concurrency.\n   - Preserve per-entry timestamp and canonical link so downstream tools can sort.\n\n## Deliverables\n- Safer thread digest append implementation.\n- Stress test: 100 concurrent messages to same thread yields a digest with exactly 100 entries and a single header.\n\n## Acceptance Criteria\n- No duplicate headers in stress test.\n- No interleaved/partial entries (each entry is intact).\n\n## Files\n- crates/mcp-agent-mail-storage/src/lib.rs","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-07T03:40:40.549931208Z","created_by":"ubuntu","updated_at":"2026-02-07T03:41:00.801156586Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["correctness","storage"],"dependencies":[{"issue_id":"br-15dv.2.8","depends_on_id":"br-15dv.2","type":"parent-child","created_at":"2026-02-07T03:40:40.549931208Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.2.8","depends_on_id":"br-15dv.2.7","type":"blocks","created_at":"2026-02-07T03:41:00.801084080Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.3","title":"[track] Concurrency architecture: lock elimination and flow control","description":"The codebase has 5+ global Mutex singletons (POOL_CACHE, READ_CACHE, QUERY_TRACKER, WBQ, COMMIT_QUEUE) that create serialization points and potential deadlocks under high concurrency. Tool metrics use locked HashMap for every tool call. No backpressure mechanism existswhen queues fill, the system cliff-drops from async to sync. This track addresses: lock audit/ordering, lock-free tool metrics, sharded global state, system-wide backpressure, and request deduplication.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:25:36.304949009Z","created_by":"ubuntu","updated_at":"2026-02-07T03:25:36.304949009Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["concurrency","locks","perf"],"dependencies":[{"issue_id":"br-15dv.3","depends_on_id":"br-15dv","type":"parent-child","created_at":"2026-02-07T03:25:36.304949009Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.3.1","title":"Lock audit: document ordering, detect violations, eliminate nested locks","description":"PROBLEM: The codebase has 5+ global Mutex singletons with no documented lock ordering:\n  - POOL_CACHE (pool.rs:235): Mutex<HashMap<String, DbPool>>\n  - READ_CACHE (cache.rs:286): OnceLock<ReadCache> (internal mutexes)\n  - QUERY_TRACKER (tracking.rs:258): Mutex<TrackerInner>\n  - WBQ (storage lib.rs:180): channel-based (no mutex, but blocking)\n  - COMMIT_QUEUE (storage lib.rs:887): Mutex<Option<CommitQueue>>\n  - TOOL_METRICS: Mutex<HashMap<String, ToolMetric>>\n\nIf any code path acquires locks in inconsistent order, deadlock occurs. With 1000 concurrent agents, even rare ordering violations will eventually trigger.\n\nSOLUTION: Formal lock hierarchy and audit:\n1. Document explicit lock ordering (e.g., POOL_CACHE < READ_CACHE < QUERY_TRACKER < COMMIT_QUEUE)\n2. Add compile-time lock ordering assertions using a LockLevel enum\n3. Audit all code paths that acquire >1 lockverify ordering compliance\n4. Replace nested lock acquisitions with try_lock + retry pattern where possible\n5. Add #[cfg(debug_assertions)] lock ordering checker (records lock acquisition order per thread)\n6. Document lock ordering in a LOCK_ORDERING.md or in-code comments\n7. Add integration test that spawns 100 threads exercising all lock combinations\n\nVALIDATION: No deadlocks in 60-second stress test with 100 concurrent threads.\n\nFILES: All crate src/ files containing Mutex/RwLock, new docs/LOCK_ORDERING.md","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-07T03:28:49.915303887Z","created_by":"ubuntu","updated_at":"2026-02-07T04:20:18.068099861Z","closed_at":"2026-02-07T04:20:18.068081427Z","close_reason":"Implemented global lock hierarchy + debug checker wrappers + docs/tests","source_repo":".","compaction_level":0,"original_size":0,"labels":["concurrency","locks","resilience"],"dependencies":[{"issue_id":"br-15dv.3.1","depends_on_id":"br-15dv.3","type":"parent-child","created_at":"2026-02-07T03:28:49.915303887Z","created_by":"ubuntu","metadata":"{}","thread_id":""}],"comments":[{"id":13,"issue_id":"br-15dv.3.1","author":"Dicklesworthstone","text":"RISK CONTEXT: Deadlocks are the #1 risk with 5+ global mutexes. A deadlock at 1000 agents would freeze the entire system with no automatic recovery. The lock ordering audit must cover ALL code paths, including error paths (where locks might be held during cleanup). The debug-mode ordering checker is critical: it records the sequence of locks acquired by each thread and panics on first violation. This catches ordering bugs in development before they become production deadlocks. Recommended ordering (outermost first): POOL_CACHE  READ_CACHE  QUERY_TRACKER  WBQ  COMMIT_QUEUE  TOOL_METRICS","created_at":"2026-02-07T03:34:38Z"}]}
{"id":"br-15dv.3.2","title":"Lock-free tool metrics with pre-allocated atomic counter arrays","description":"PROBLEM: Tool metrics use a locked HashMap for recording every tool call and error. The InstrumentedTool wrapper calls record_call() and record_error() on every tool invocation, each acquiring a global lock.\n\nSOLUTION: Lock-free tool metrics:\n1. Pre-allocate an array of AtomicU64 pairs (call_count, error_count) for each known tool\n2. Use tool_name -> index mapping computed at startup (tools are statically known)\n3. record_call() becomes a single atomic fetch_add (no lock)\n4. record_error() becomes a single atomic fetch_add (no lock)\n5. Snapshot for metrics resource: iterate array, load with Ordering::Relaxed\n6. Add per-tool latency tracking: use atomic min/max/sum + count for streaming stats\n7. No HashMap, no Mutex, no allocation on the hot path\n\nEXPECTED IMPROVEMENT: Zero lock contention for tool metrics recording.\n\nFILES: crates/mcp-agent-mail-server/src/lib.rs (InstrumentedTool), tool_metrics module","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-07T03:28:50.053034198Z","created_by":"ubuntu","updated_at":"2026-02-07T04:31:28.933540216Z","closed_at":"2026-02-07T04:31:28.933516481Z","close_reason":"Implemented lock-free tool metrics: preallocated AtomicU64 arrays + server precomputes tool index; no global metrics lock on hot path; fmt/check/clippy/test all pass.","source_repo":".","compaction_level":0,"original_size":0,"labels":["concurrency","metrics","perf"],"dependencies":[{"issue_id":"br-15dv.3.2","depends_on_id":"br-15dv.3","type":"parent-child","created_at":"2026-02-07T03:28:50.053034198Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.3.2","depends_on_id":"br-15dv.3.1","type":"blocks","created_at":"2026-02-07T03:33:55.166145862Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.3.3","title":"Replace global Mutex<HashMap> with concurrent data structures","description":"PROBLEM: POOL_CACHE uses a single Mutex<HashMap> for all database pools. Under high concurrency, acquiring a pool (the most common operation) requires locking this map even just to read.\n\nSOLUTION: Replace locked containers with concurrent alternatives:\n1. POOL_CACHE: Use OnceLock per pool key (since pools are created once and never removed)\n   - Pre-compute pool for each known project at startup\n   - Use DashMap for dynamic pool creation (rare path)\n2. READ_CACHE internal maps: Already handled by br-15dv.1.3 (sharded touches)\n3. For any remaining global HashMap<K,V> behind Mutex:\n   - If read-heavy: use RwLock instead of Mutex\n   - If write-heavy with many keys: use sharded locks (16 shards, key hash % 16)\n   - If write-once: use OnceLock or Lazy\n4. Audit all OnceLock<Mutex<_>> patternsthese are often unnecessary (OnceLock already provides initialization safety)\n\nEXPECTED IMPROVEMENT: Read operations (90%+ of accesses) never block each other.\n\nFILES: crates/mcp-agent-mail-db/src/pool.rs, any files with Mutex<HashMap>","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:28:50.202705468Z","created_by":"ubuntu","updated_at":"2026-02-07T03:33:55.301316192Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["concurrency","perf"],"dependencies":[{"issue_id":"br-15dv.3.3","depends_on_id":"br-15dv.3","type":"parent-child","created_at":"2026-02-07T03:28:50.202705468Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.3.3","depends_on_id":"br-15dv.3.1","type":"blocks","created_at":"2026-02-07T03:33:55.301263143Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.3.4","title":"System-wide backpressure framework with Green/Yellow/Red health levels","description":"PROBLEM: The system has NO flow control. When queues fill (WBQ=256, CommitQueue=100), the system falls back to synchronous operationscreating a performance cliff. At 1000 agents, bursts exceed queue capacity, causing cascading slowdowns as sync operations block connection pool threads.\n\nSOLUTION: System-wide backpressure framework:\n1. Define system health levels: Green (normal), Yellow (elevated load), Red (overload)\n2. Health signals: pool wait time p95, WBQ depth/capacity ratio, commit queue depth\n3. Green: all queues < 50%, pool wait < 10ms  full speed\n4. Yellow: any queue > 50% or pool wait > 50ms  shed non-critical work:\n   - Defer archive writes (increase batch interval)\n   - Skip console logging for non-error events\n   - Reduce cache TTL checks (accept slightly stale data)\n5. Red: any queue > 80% or pool wait > 500ms  aggressive shedding:\n   - Return 503 for low-priority tool calls (health_check, whois)\n   - Disable query tracking entirely\n   - Skip notification signals\n6. Expose health level via tooling/metrics resource\n7. Add backpressure_level: AtomicU8 global, checked at system entry points\n\nEXPECTED IMPROVEMENT: Graceful degradation instead of cliff-drop under extreme load.\n\nFILES: New crates/mcp-agent-mail-core/src/backpressure.rs, integration in server + tools","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:28:50.352116130Z","created_by":"ubuntu","updated_at":"2026-02-07T03:34:38.669244881Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["backpressure","concurrency","resilience"],"dependencies":[{"issue_id":"br-15dv.3.4","depends_on_id":"br-15dv.1.1","type":"blocks","created_at":"2026-02-07T03:33:56.125547995Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.3.4","depends_on_id":"br-15dv.2.1","type":"blocks","created_at":"2026-02-07T03:33:58.406294073Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.3.4","depends_on_id":"br-15dv.3","type":"parent-child","created_at":"2026-02-07T03:28:50.352116130Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.3.4","depends_on_id":"br-15dv.3.2","type":"blocks","created_at":"2026-02-07T03:33:55.443302327Z","created_by":"ubuntu","metadata":"{}","thread_id":""}],"comments":[{"id":12,"issue_id":"br-15dv.3.4","author":"Dicklesworthstone","text":"DESIGN PHILOSOPHY: Backpressure is the key difference between 'works at 100 agents' and 'works at 1000 agents'. Without it, the system has a sharp performance cliff: everything works until queues fill, then suddenly all operations become synchronous and latency spikes 100x. With backpressure, the system communicates its limits: Yellow says 'I am loaded, non-critical work will be deferred'. Red says 'I am overloaded, protect the core by shedding optional work'. This follows the same principle as TCP congestion control: the system tells senders to slow down rather than dropping data. The health level should be visible in every tool response header so agents can adjust their request rate.","created_at":"2026-02-07T03:34:38Z"}]}
{"id":"br-15dv.3.5","title":"Request coalescing for identical concurrent read operations","description":"PROBLEM: Multiple agents may fire identical concurrent requests (e.g., 10 agents all calling fetch_inbox for the same project simultaneously). Each request independently queries the DB, doing redundant work.\n\nSOLUTION: Request coalescing for read-heavy operations:\n1. Add a CoalesceMap<K, V>: concurrent map of in-flight read operations\n2. When a read request arrives, hash its parameters to a key\n3. If key exists in map: wait for the existing operation's result (clone it)\n4. If key doesn't exist: insert a oneshot channel, execute the query, broadcast result\n5. Apply to: fetch_inbox, search_messages, resource reads (inbox, mailbox, thread)\n6. Do NOT apply to write operations (send_message, acknowledge_message)\n7. TTL for coalesced results: 50ms (prevent stale reads)\n8. Limit concurrent coalesce entries to 1000 (prevent unbounded memory)\n\nEXPECTED IMPROVEMENT: Under thundering herd (10 identical requests), only 1 DB query executes.\n\nFILES: New utility in crates/mcp-agent-mail-db/src/coalesce.rs, integration in tools","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:28:50.498286135Z","created_by":"ubuntu","updated_at":"2026-02-07T03:33:55.577297407Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["concurrency","perf"],"dependencies":[{"issue_id":"br-15dv.3.5","depends_on_id":"br-15dv.3","type":"parent-child","created_at":"2026-02-07T03:28:50.498286135Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.3.5","depends_on_id":"br-15dv.3.3","type":"blocks","created_at":"2026-02-07T03:33:55.577252262Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.3.6","title":"Loom model-check + property tests for critical concurrent components","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T05:47:29.915342560Z","created_by":"ubuntu","updated_at":"2026-02-07T05:47:39.703226836Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["concurrency","formal","testing"],"dependencies":[{"issue_id":"br-15dv.3.6","depends_on_id":"br-15dv.3","type":"parent-child","created_at":"2026-02-07T05:47:29.915342560Z","created_by":"ubuntu","metadata":"{}","thread_id":""}],"comments":[{"id":19,"issue_id":"br-15dv.3.6","author":"Dicklesworthstone","text":"## Motivation\nAt extreme concurrency, the failure mode we cannot tolerate is a deadlock or a subtle lost-update race that only appears under a rare interleaving.\n\nTraditional unit/integration tests do not explore enough schedules. We need an \"alien artifact\" correctness layer:\n- **loom** model checking for concurrency primitives (explore interleavings deterministically)\n- property-based tests for invariants (idempotency, ordering, queue bounds)\n\n## Targets (Initial)\n- WBQ enqueue/drain correctness (no lost ops, bounded queue behavior).\n- Commit coalescer queue semantics (batching does not reorder within a project when ordering is promised).\n- Reservation conflict decisions (same inputs -> same results; stable tie-breaking).\n- Any global lock ordering utilities (no inversion; no lock held across IO).\n\n## Approach\n- Add a small set of loom-enabled modules behind a Cargo feature (e.g. `loom-tests`) to avoid impacting production builds.\n- Write minimal state machines around the core primitives and validate:\n  - no panics,\n  - no deadlocks (loom detects),\n  - invariants hold.\n\n## Acceptance Criteria\n- At least 2 loom tests exist and run in CI (or as an explicit job).\n- Each test includes a clear invariant statement and a failure reproduction seed.\n- No production code paths depend on loom-only types.\n","created_at":"2026-02-07T05:47:39Z"}]}
{"id":"br-15dv.4","title":"[track] Memory optimization: zero-copy, interning, and compact structures","description":"At 1000 agents with 100K+ messages, memory efficiency becomes critical. Current hot paths allocate 5+ Vec/HashMap per send_message with no capacity pre-allocation. Agent names, project slugs, and thread IDs are duplicated as owned Strings across cache, queries, and responses. Console logging allocates ~20 strings per tool call. This track addresses: string interning, pre-allocated buffers, per-message size limits, zero-copy JSON, and compact collection types.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:25:36.431395332Z","created_by":"ubuntu","updated_at":"2026-02-07T03:25:36.431395332Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["memory","perf"],"dependencies":[{"issue_id":"br-15dv.4","depends_on_id":"br-15dv","type":"parent-child","created_at":"2026-02-07T03:25:36.431395332Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.4.1","title":"String interning for agent names, slugs, and thread IDs","description":"PROBLEM: Agent names (e.g., \"GreenLake\"), project slugs, and thread IDs are duplicated as owned Strings across: cache entries, query results, JSON responses, tool parameters. At 1000 agents  multiple copies per agent = millions of redundant small string allocations.\n\nSOLUTION: Implement string interning for frequently-reused identifiers:\n1. Create InternedString type: newtype over Arc<str> (shared ownership, 8 bytes)\n2. Create StringInterner: concurrent HashMap<&str, Arc<str>> for deduplication\n3. Intern on first use: agent names, project slugs, thread IDs, tool names\n4. Cache and DB layers return InternedString instead of String for known fields\n5. Use compact_str or smol_str crate if available (inline strings 23 bytes, no heap allocation)\n6. For agent names (max ~20 chars): smol_str stores inline (zero allocation)\n7. Thread-safe interner using DashMap or sharded RwLock\n\nMEMORY SAVINGS: 1000 agents  ~10 copies  40 bytes/string = 400KB  1000  8 bytes = 8KB (50x reduction)\n\nNOTE: Must ensure InternedString implements Serialize/Deserialize for JSON compatibility.\n\nFILES: New crates/mcp-agent-mail-core/src/intern.rs, integration across crates","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:29:36.818682335Z","created_by":"ubuntu","updated_at":"2026-02-07T03:29:36.818682335Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["memory","perf"],"dependencies":[{"issue_id":"br-15dv.4.1","depends_on_id":"br-15dv.4","type":"parent-child","created_at":"2026-02-07T03:29:36.818682335Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.4.2","title":"Pre-allocate Vec/HashMap with capacity hints on hot paths","description":"PROBLEM: Hot-path tool handlers allocate multiple Vec/HashMap without capacity hints:\n  messaging.rs:360-410: 5 allocations per send_message (all_recipients, resolved_to, resolved_cc, resolved_bcc, recipient_map)\n  resources.rs: Multiple Vec::new() for resource construction\n  Console logging: ~20 string allocations per tool call panel\n\nSOLUTION: Pre-allocate with known capacities and reuse buffers:\n1. In send_message: Vec::with_capacity(to.len() + cc.len() + bcc.len()) for all recipient lists\n2. In send_message: HashMap::with_capacity(to.len() + cc.len() + bcc.len()) for recipient_map\n3. For console rendering: use a thread-local String buffer, clear and reuse (not allocate)\n4. For JSON construction: pre-size serde_json::Map::with_capacity() based on known field counts\n5. For resource responses: pre-allocate Vec::with_capacity(inbox_count) for inbox entries\n6. Add #[inline] hints on tiny functions called in inner loops (e.g., timestamp conversions)\n\nEXPECTED IMPROVEMENT: 60-80% reduction in allocator calls on send_message hot path.\n\nFILES: crates/mcp-agent-mail-tools/src/messaging.rs, resources.rs, server/console.rs","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:29:36.960041991Z","created_by":"ubuntu","updated_at":"2026-02-07T03:29:36.960041991Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["allocations","memory","perf"],"dependencies":[{"issue_id":"br-15dv.4.2","depends_on_id":"br-15dv.4","type":"parent-child","created_at":"2026-02-07T03:29:36.960041991Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.4.3","title":"Per-message size limits to prevent memory exhaustion from oversized payloads","description":"PROBLEM: No limit on message body size. A malicious or buggy agent could send a 100MB message body, which gets buffered in: WBQ channel (1), commit queue (1), JSON serialization (1), response (1) = 400MB for one message. With 256 WBQ slots of max-size messages = 25GB potential memory.\n\nSOLUTION: Enforce per-message size limits:\n1. Add MAX_MESSAGE_BODY_BYTES config (default: 1MB)\n2. Add MAX_ATTACHMENT_BYTES config (default: 10MB per attachment)\n3. Add MAX_TOTAL_MESSAGE_BYTES config (default: 20MB including attachments)\n4. Validate in send_message BEFORE any DB/archive operations\n5. Return clear error: INVALID_ARGUMENT with size details and limits\n6. Add MAX_SUBJECT_BYTES (default: 1KB, currently truncated at 200 chars)\n7. Apply limits at tool entry point, not in storage layer (fail fast)\n\nRESILIENCE BENEFIT: Prevents OOM from oversized messages.\n\nFILES: crates/mcp-agent-mail-tools/src/messaging.rs, config.rs","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:29:37.110307905Z","created_by":"ubuntu","updated_at":"2026-02-07T03:29:37.110307905Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["memory","resilience","validation"],"dependencies":[{"issue_id":"br-15dv.4.3","depends_on_id":"br-15dv.4","type":"parent-child","created_at":"2026-02-07T03:29:37.110307905Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.4.4","title":"Zero-copy JSON response construction with direct serialization","description":"PROBLEM: JSON responses are constructed by building Rust structs, serializing to serde_json::Value, then serializing to String. This creates intermediate allocations: struct  Value (allocates)  String (allocates). For large inbox responses with 100+ messages, this doubles memory usage.\n\nSOLUTION: Minimize intermediate allocations in JSON response construction:\n1. Use serde_json::to_string() directly on structs (skip Value intermediate)\n2. For dynamic responses: use serde_json::to_writer() with a pre-allocated buffer\n3. Implement custom Serialize for hot-path response types that writes directly to the output\n4. For inbox responses: stream items instead of collecting into Vec first\n5. Use Cow<str> for fields that might be borrowed (thread_id, agent_name from cache)\n6. Consider io::Write-based JSON construction for truly large responses (>1MB)\n\nEXPECTED IMPROVEMENT: 30-50% reduction in allocation for large responses.\n\nCAUTION: Must maintain JSON format parity with Python (conformance tests are the guard rail).\n\nFILES: crates/mcp-agent-mail-tools/src/resources.rs, messaging.rs, search.rs","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-07T03:29:37.256629764Z","created_by":"ubuntu","updated_at":"2026-02-07T03:29:37.256629764Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["json","memory","perf"],"dependencies":[{"issue_id":"br-15dv.4.4","depends_on_id":"br-15dv.4","type":"parent-child","created_at":"2026-02-07T03:29:37.256629764Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.4.5","title":"SmallVec for recipient lists to eliminate heap allocation in common case","description":"PROBLEM: Most messages have 1-3 recipients (to/cc/bcc), but we allocate a heap Vec for each. Vec has a minimum 24-byte allocation (ptr+len+cap) plus heap. For 100 messages/sec, this is 300-900 unnecessary heap allocations.\n\nSOLUTION: Use inline storage for small collections:\n1. Replace Vec<String> for to/cc/bcc with SmallVec<[String; 4]> (inline up to 4 elements)\n2. Replace Vec<(i64, String)> for all_recipients with SmallVec<[_; 8]>\n3. For message_recipients: SmallVec<[(i64, &str, &str); 4]>\n4. Consider ArrayVec<T, N> if max size is known (no heap fallback needed)\n5. For file reservation paths: SmallVec<[String; 8]> (most requests have <8 paths)\n\nDEPENDENCY: Check if smallvec crate is already in workspace deps. If not, add it (zero-dep, widely used).\n\nEXPECTED IMPROVEMENT: Eliminate heap allocation for >90% of recipient lists.\n\nFILES: crates/mcp-agent-mail-tools/src/messaging.rs, reservations.rs, Cargo.toml","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-07T03:29:37.397116045Z","created_by":"ubuntu","updated_at":"2026-02-07T03:29:37.397116045Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["memory","perf"],"dependencies":[{"issue_id":"br-15dv.4.5","depends_on_id":"br-15dv.4","type":"parent-child","created_at":"2026-02-07T03:29:37.397116045Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.5","title":"[track] Algorithm optimization: spatial indexes, FTS, and precomputation","description":"Several hot-path algorithms have poor asymptotic complexity. File reservation conflict detection is O(M*N) with glob compilation per checkat 1000 agents with 10 reservations each, a 5-path request triggers 50,000 glob matches. FTS5 uses the default simple tokenizer with no stemming. Inbox queries lack materialized aggregates. Agent name validation recomputes on every resolve_agent() call. This track addresses: spatial indexing for reservations, FTS5 tokenizer optimization, materialized aggregates, and precomputed validation sets.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:25:36.559841440Z","created_by":"ubuntu","updated_at":"2026-02-07T03:25:36.559841440Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["algorithms","perf"],"dependencies":[{"issue_id":"br-15dv.5","depends_on_id":"br-15dv","type":"parent-child","created_at":"2026-02-07T03:25:36.559841440Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.5.1","title":"Spatial index for file reservation conflict detection (trie-based)","description":"PROBLEM: File reservation conflict detection is O(M*N) where M=requested paths and N=active exclusive reservations (reservations.rs:172-215). Each check compiles a glob pattern (CompiledPattern::new). At 1000 agents with 10 reservations each = 10,000 active reservations. A 5-path request triggers 50,000 glob compilations + matches.\n\nCURRENT CODE (reservations.rs:192-215):\n  for req in &requested_compiled {\n      for (res, active_pat) in &active_compiled {\n          if symmetric_match(req, active_pat) { ... }\n      }\n  }\n\nSOLUTION: Replace brute-force with indexed conflict detection:\n1. Build a prefix trie (radix tree) of active reservation paths\n   - Insert \"src/**\" at trie node for \"src/\"\n   - Insert \"*.rs\" at root node (global patterns)\n2. For conflict check: walk the trie matching request path segments\n   - Only check patterns in matching subtrees (not all 10,000)\n3. Cache compiled patterns: CompiledPattern keyed by path_pattern string (patterns repeat)\n4. For exact-path reservations: use HashMap for O(1) lookup\n5. For glob reservations: separate into prefix-indexable and non-indexable\n6. Rebuild index only when reservations change (not on every conflict check)\n7. Index invalidation: increment generation counter on add/release, check before use\n\nEXPECTED IMPROVEMENT: O(M*N)  O(M*log(N)) for prefix-indexable patterns, O(M*K) for K non-indexable patterns (typically K << N).\n\nFILES: crates/mcp-agent-mail-tools/src/reservations.rs, new index module","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:30:24.007818085Z","created_by":"ubuntu","updated_at":"2026-02-07T03:30:24.007818085Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["algorithms","perf","reservations"],"dependencies":[{"issue_id":"br-15dv.5.1","depends_on_id":"br-15dv.5","type":"parent-child","created_at":"2026-02-07T03:30:24.007818085Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.5.2","title":"FTS5 tokenizer optimization: porter stemming, unicode, prefix indexes","description":"PROBLEM: FTS5 virtual table uses default simple tokenizer (schema.rs:138-144). No stemming (searching \"running\" won't match \"run\"), no unicode normalization, no prefix optimization. At 100K+ messages, search quality and performance degrade.\n\nCURRENT CODE (schema.rs):\n  CREATE VIRTUAL TABLE IF NOT EXISTS fts_messages USING fts5(\n      message_id UNINDEXED,\n      subject,\n      body\n  );\n\nSOLUTION: Optimize FTS5 configuration:\n1. Add tokenizer: tokenize='porter unicode61 remove_diacritics 2'\n   - porter: English stemming (run/running/runs  run)\n   - unicode61: Unicode-aware tokenization\n   - remove_diacritics: normalize accented characters\n2. Add prefix index: prefix='2,3' (enables fast prefix queries)\n3. Add content_rowid column for faster joins with messages table\n4. Add column weights: subject weight=10, body weight=1 (subject matches rank higher)\n5. Rebuild FTS triggers for new tokenizer\n6. Add v4 migration (or combine with index migration) to rebuild FTS with new config\n7. Add VACUUM INTO for FTS optimization after bulk inserts\n\nNOTE: Must update sanitize_fts_query() if tokenizer changes affect query syntax.\n\nVALIDATION: Conformance tests must pass. Search for \"running\" must match messages containing \"run\".\n\nFILES: crates/mcp-agent-mail-db/src/schema.rs, queries.rs (search functions)","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:30:24.144721357Z","created_by":"ubuntu","updated_at":"2026-02-07T03:30:24.144721357Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["db","perf","search"],"dependencies":[{"issue_id":"br-15dv.5.2","depends_on_id":"br-15dv.5","type":"parent-child","created_at":"2026-02-07T03:30:24.144721357Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.5.3","title":"Materialized inbox aggregate counters for O(1) inbox stats","description":"PROBLEM: Inbox count, unread count, and ack-required count are computed on every resource request by scanning message_recipients + messages tables. At 1000 agents with 100 messages each = 100K recipient rows scanned per inbox query.\n\nSOLUTION: Maintain materialized aggregate counters:\n1. Add inbox_stats table: (agent_id, total_count, unread_count, ack_pending_count, last_message_ts)\n2. Update via triggers on message_recipients INSERT/UPDATE\n3. Alternatively: maintain in-memory counters (HashMap<i64, InboxStats>) updated on each message operation\n4. Cache aggregates in read cache with 30s TTL\n5. Invalidate on: send_message (to recipients), mark_message_read, acknowledge_message\n6. For resource://inbox/{agent}: use cached aggregate for count, only query full rows when limit > 0\n7. For views/urgent-unread: add counter for urgent_unread_count\n\nEXPECTED IMPROVEMENT: Inbox resource requests go from O(N) scan to O(1) counter lookup.\n\nTRADE-OFF: Slightly more complex write path (counter updates), but reads are 100x more frequent.\n\nFILES: crates/mcp-agent-mail-db/src/schema.rs (triggers), queries.rs, cache.rs","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:30:24.297342461Z","created_by":"ubuntu","updated_at":"2026-02-07T03:30:24.297342461Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["algorithms","db","perf"],"dependencies":[{"issue_id":"br-15dv.5.3","depends_on_id":"br-15dv.5","type":"parent-child","created_at":"2026-02-07T03:30:24.297342461Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.5.4","title":"Precomputed HashSet for agent name validation (O(1) lookup)","description":"PROBLEM: is_valid_agent_name() splits the name into adjective+noun parts and checks against VALID_ADJECTIVES (62) and VALID_NOUNS (69) arrays. This likely involves linear scan or hash computation on every resolve_agent() call. At 1000 agents with 10 tool calls each = 10,000 validations/sec.\n\nSOLUTION: Precompute the complete valid name set:\n1. Generate HashSet<String> of all 4,278 valid names at compile time (const or lazy_static)\n2. is_valid_agent_name() becomes a single HashSet::contains() call\n3. Use phf (perfect hash function) crate for compile-time perfect hash map (zero runtime overhead)\n4. Store as case-folded: all lowercase in the set, lowercase the input before lookup\n5. Alternative: precompute two HashSet<&str> for adjectives and nouns (faster than array scan)\n6. Cache validation results: once validated, an agent name never changescache in READ_CACHE\n\nEXPECTED IMPROVEMENT: O(N) linear scan  O(1) hash lookup per validation.\n\nFILES: crates/mcp-agent-mail-core/src/models.rs","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-07T03:30:24.442330542Z","created_by":"ubuntu","updated_at":"2026-02-07T03:30:24.442330542Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["algorithms","perf"],"dependencies":[{"issue_id":"br-15dv.5.4","depends_on_id":"br-15dv.5","type":"parent-child","created_at":"2026-02-07T03:30:24.442330542Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.6","title":"[track] Resilience hardening: graceful degradation under extreme conditions","description":"The system has no handling for: disk full (ENOSPC), SQLite corruption, clock skew, memory pressure, or thundering herd on circuit breaker reset. The circuit breaker is system-wide (not per-operation), so a git failure can circuit-break database operations. No escalation beyond 30s circuit-break cycles. At 1000 agents, any of these conditions causes total system failure rather than graceful degradation. This track addresses: disk monitoring, integrity checks, per-operation circuits, clock skew detection, stampede mitigation, and adaptive load shedding.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:25:36.685642886Z","created_by":"ubuntu","updated_at":"2026-02-07T03:25:36.685642886Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["reliability","resilience"],"dependencies":[{"issue_id":"br-15dv.6","depends_on_id":"br-15dv","type":"parent-child","created_at":"2026-02-07T03:25:36.685642886Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.6.1","title":"Disk space monitoring with graduated degradation thresholds","description":"PROBLEM: No handling for ENOSPC (disk full). Git commits, SQLite WAL checkpoints, signal writes, and attachment storage all silently fail when disk is full. The WBQ drain thread logs errors but keeps trying. Users get cryptic \"IO error\" messages with no actionable guidance.\n\nSOLUTION: Proactive disk space monitoring and graceful degradation:\n1. Add disk_free_bytes() utility: statvfs() call on STORAGE_ROOT and DATABASE_URL paths\n2. Check disk space on startup, log warning if <1GB free\n3. Add periodic check (every 60s in background worker)\n4. Thresholds:\n   - Warning: <500MB  log warning, include in health_check response\n   - Critical: <100MB  disable archive writes (DB-only mode), return warnings in tool responses\n   - Fatal: <10MB  reject new messages, return DISK_FULL error\n5. Add DISK_SPACE_WARNING_MB and DISK_SPACE_CRITICAL_MB configs\n6. Include disk space in tooling/metrics resource\n7. Resume normal operations when space recovers above thresholds\n\nVALIDATION: Test with tmpfs volume at each threshold level.\n\nFILES: New crates/mcp-agent-mail-core/src/disk.rs, integration in server workers","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:31:20.758956635Z","created_by":"ubuntu","updated_at":"2026-02-07T03:31:20.758956635Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["monitoring","resilience"],"dependencies":[{"issue_id":"br-15dv.6.1","depends_on_id":"br-15dv.6","type":"parent-child","created_at":"2026-02-07T03:31:20.758956635Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.6.2","title":"SQLite integrity checks on startup, recycle, and periodic schedule","description":"PROBLEM: No SQLite integrity checking. WAL mode provides durability but not corruption immunity. A power failure during WAL checkpoint, filesystem corruption, or bitrot can corrupt the database silently. At 1000 agents relying on the system, silent corruption causes cascading failures.\n\nSOLUTION: Integrity checking at strategic points:\n1. On pool initialization: run PRAGMA quick_check (fast, catches most corruption)\n2. On connection recycle (every 30 min): run PRAGMA integrity_check(1) (check first error only)\n3. Add daily full integrity check via background worker (PRAGMA integrity_check)\n4. If corruption detected:\n   - Log CRITICAL error with details\n   - Set system health to Red (backpressure framework)\n   - Attempt automatic recovery: copy WAL to backup, run VACUUM INTO to create clean copy\n   - Switch to clean copy if VACUUM succeeds\n5. Add INTEGRITY_CHECK_ON_STARTUP config (default: true)\n6. Add INTEGRITY_CHECK_INTERVAL_HOURS config (default: 24)\n7. Include last integrity check result in health_check response\n\nCAUTION: PRAGMA integrity_check on large databases can take seconds. Run on dedicated connection, not from pool.\n\nFILES: crates/mcp-agent-mail-db/src/pool.rs (init), new integrity module","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:31:20.898534555Z","created_by":"ubuntu","updated_at":"2026-02-07T03:31:20.898534555Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["db","integrity","resilience"],"dependencies":[{"issue_id":"br-15dv.6.2","depends_on_id":"br-15dv.6","type":"parent-child","created_at":"2026-02-07T03:31:20.898534555Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.6.3","title":"Per-subsystem circuit breakers: DB, Git, Signal, LLM (independent)","description":"PROBLEM: The circuit breaker is system-widea single CIRCUIT_BREAKER instance (retry.rs). A git failure can trip the circuit breaker, which then blocks DATABASE operations (completely unrelated). At 1000 agents, a transient git issue takes down the entire system for 30 seconds.\n\nCURRENT: Single CIRCUIT_BREAKER with threshold=5, reset=30s\n\nSOLUTION: Per-subsystem circuit breakers:\n1. Split into independent circuits:\n   - CIRCUIT_DB: SQLite operations (pool acquire, query execution)\n   - CIRCUIT_GIT: Git archive operations (commit, read)\n   - CIRCUIT_SIGNAL: Notification signal writes\n   - CIRCUIT_LLM: LLM API calls (already somewhat independent)\n2. Each circuit has independent: threshold, reset_duration, state\n3. Configurable per circuit: CIRCUIT_DB_THRESHOLD, CIRCUIT_GIT_THRESHOLD, etc.\n4. Add half-open improvements:\n   - Rate-limited probes: max 1 probe per 5 seconds in half-open state\n   - Success threshold: require 3 consecutive successes to close (not just 1)\n5. Add circuit state to health_check and tooling/metrics responses\n6. Add circuit event logging: state transitions logged at WARN level\n\nEXPECTED IMPROVEMENT: Git failures only affect archive operations. DB stays operational.\n\nFILES: crates/mcp-agent-mail-db/src/retry.rs, storage lib.rs","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:31:21.040350426Z","created_by":"ubuntu","updated_at":"2026-02-07T03:34:38.943786119Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["circuit-breaker","resilience"],"dependencies":[{"issue_id":"br-15dv.6.3","depends_on_id":"br-15dv.6","type":"parent-child","created_at":"2026-02-07T03:31:21.040350426Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.6.3","depends_on_id":"br-15dv.6.1","type":"blocks","created_at":"2026-02-07T03:33:55.708994734Z","created_by":"ubuntu","metadata":"{}","thread_id":""}],"comments":[{"id":14,"issue_id":"br-15dv.6.3","author":"Dicklesworthstone","text":"ISOLATION PRINCIPLE: The current single circuit breaker is equivalent to having one fuse for an entire house. When the kitchen appliance trips the fuse, the bedroom lights go out too. Per-subsystem circuits are like having separate breakers per room: a git failure only disables git, database operations continue unaffected. This is critical at 1000 agents because: (1) git operations are inherently flaky (index.lock, network for remotes), (2) database operations are highly reliable (local SQLite), (3) LLM operations depend on external APIs. Mixing their failure domains means the most reliable subsystem (DB) gets punished for the least reliable (git/LLM).","created_at":"2026-02-07T03:34:38Z"}]}
{"id":"br-15dv.6.4","title":"Clock skew detection with monotonic fallback for TTL and expiry","description":"PROBLEM: Timestamps use SystemTime::now() for absolute times. A backward clock jump (NTP correction, VM migration, manual adjustment) causes: deferred touch queue to write stale timestamps, cache TTL to malfunction (entries never expire or expire instantly), reservation expiry to miscalculate.\n\nSOLUTION: Detect and handle clock skew:\n1. Record last_system_time on each now_micros() call (thread-local AtomicI64)\n2. If current time < last_system_time - 1s  clock jumped backward:\n   - Log WARNING with jump magnitude\n   - For deferred touches: use max(current, last_system_time) to prevent regression\n   - For cache TTL: use Instant::now() (monotonic) for TTL checks instead of SystemTime\n3. If current time > last_system_time + 300s  clock jumped forward:\n   - Log WARNING with jump magnitude\n   - For cache: invalidate all entries (they may appear expired)\n4. Use Instant::elapsed() for all duration measurements (already partially done)\n5. For reservation expiry: store both wall_clock and monotonic_offset for robust comparison\n6. Add CLOCK_SKEW_DETECTION_ENABLED config (default: true)\n\nFILES: crates/mcp-agent-mail-core/src/timestamps.rs, cache.rs","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:31:21.185209726Z","created_by":"ubuntu","updated_at":"2026-02-07T03:31:21.185209726Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["resilience","time"],"dependencies":[{"issue_id":"br-15dv.6.4","depends_on_id":"br-15dv.6","type":"parent-child","created_at":"2026-02-07T03:31:21.185209726Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.6.5","title":"Thundering herd mitigation with rate-limited half-open probes","description":"PROBLEM: When circuit breaker transitions from Open  Half-Open after 30s, ALL waiting threads retry simultaneously. With 1000 agents, 100+ threads rush the recovered subsystem, potentially tripping the circuit again immediately.\n\nSOLUTION: Rate-limited recovery with jittered probing:\n1. In half-open state: allow only 1 probe per 5 seconds (controlled by AtomicBool)\n2. Other threads in half-open get a \"circuit recovering\" fast-fail (not full failure)\n3. Success threshold: require 3 consecutive successful probes to transition to Closed\n4. On transition to Closed: announce via condition variable, wake 10 threads at a time (not all)\n5. Add random jitter (0-500ms) to retry delays on circuit recovery\n6. Implement token bucket for post-recovery: gradually increase allowed throughput over 10 seconds\n7. Log circuit state transitions with timestamp and probe results\n\nEXPECTED IMPROVEMENT: Smooth recovery curve instead of thundering herd spike.\n\nFILES: crates/mcp-agent-mail-db/src/retry.rs","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:31:21.322134649Z","created_by":"ubuntu","updated_at":"2026-02-07T03:33:55.844441953Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["circuit-breaker","resilience"],"dependencies":[{"issue_id":"br-15dv.6.5","depends_on_id":"br-15dv.6","type":"parent-child","created_at":"2026-02-07T03:31:21.322134649Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.6.5","depends_on_id":"br-15dv.6.3","type":"blocks","created_at":"2026-02-07T03:33:55.844396368Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.6.6","title":"Memory pressure detection with adaptive cache eviction and load shedding","description":"PROBLEM: No detection of process memory usage or system memory pressure. A 1000-agent workload with large messages could consume 10GB+ RAM without any awareness. OOM killer terminates the process with no graceful shutdown.\n\nSOLUTION: Memory pressure awareness and adaptive behavior:\n1. Add process_rss_bytes() utility: read /proc/self/status on Linux, task_info on macOS\n2. Add periodic check (every 30s in background worker)\n3. Thresholds:\n   - Warning: RSS > 2GB  log warning, reduce cache TTL by 50%\n   - Critical: RSS > 4GB  evict 50% of cache, increase WBQ drain rate, disable LLM features\n   - Fatal: RSS > 8GB  reject new messages with MEMORY_PRESSURE error\n4. Configurable: MEMORY_WARNING_MB, MEMORY_CRITICAL_MB\n5. Include in health_check and tooling/metrics\n6. On graceful shutdown: flush all caches and queues before exit\n7. Register SIGTERM/SIGINT handler for clean shutdown\n\nTRADE-OFF: /proc/self reads are cheap (<1s) but platform-specific.\n\nFILES: New crates/mcp-agent-mail-core/src/memory.rs, integration in server","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:31:21.461128716Z","created_by":"ubuntu","updated_at":"2026-02-07T03:33:55.986161559Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["memory","monitoring","resilience"],"dependencies":[{"issue_id":"br-15dv.6.6","depends_on_id":"br-15dv.6","type":"parent-child","created_at":"2026-02-07T03:31:21.461128716Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.6.6","depends_on_id":"br-15dv.6.1","type":"blocks","created_at":"2026-02-07T03:33:55.986066370Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.6.7","title":"Consistency contract: archive canonical + DB index; crash-safe write semantics","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T05:46:35.443131762Z","created_by":"ubuntu","updated_at":"2026-02-07T05:47:02.697443023Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["consistency","reliability"],"dependencies":[{"issue_id":"br-15dv.6.7","depends_on_id":"br-15dv.6","type":"parent-child","created_at":"2026-02-07T05:46:35.443131762Z","created_by":"ubuntu","metadata":"{}","thread_id":""}],"comments":[{"id":17,"issue_id":"br-15dv.6.7","author":"Dicklesworthstone","text":"## Background\nThe repo docs (`SYNC_STRATEGY.md`) say **Git archive is canonical** and SQLite is a rebuildable index.\nSome implementation comments/assumptions drift toward \"DB is authoritative\". Under failure (WBQ full, git/index lock storms, SQLITE_BUSY) this ambiguity can cause subtle data-loss or divergence.\n\nAt 1000+ agents we need an explicit, testable contract for write ordering, crash safety, and reconciliation.\n\n## Target Consistency Contract (Proposed)\n### Canonical State\n- **Archive (git-backed files) is canonical for user-visible mail artifacts**.\n- **SQLite is an index** and may lag but must be repairable/rebuildable from archive.\n\n### Tool Write Semantics (Must be explicit per tool)\nFor each write tool (send_message, reservations, acks, contacts, register_agent):\n- Define whether success means:\n  1) archive write durable on disk, and\n  2) SQLite updated (strong), or\n  3) SQLite may lag (eventual) but with a guaranteed reconciliation path.\n\nStrong recommendation:\n- Return success only when the archive write is durable.\n- SQLite update should be best-effort, but if it fails, we must record a reconciliation marker so later reads can self-heal.\n\n### Idempotency + Ordering\n- All write tools must be safely retryable (client retries, partial failures).\n- Define ordering guarantees (per-thread ordering vs global ordering) and ensure they are stable under concurrency.\n\n## Implementation Plan\n- Audit each write tool pipeline: where archive write happens vs DB write vs WBQ enqueue.\n- Ensure we never report success when:\n  - archive write did not persist, OR\n  - DB is advanced beyond archive (index points to non-existent files).\n- Add reconciliation hooks:\n  - on startup, scan archive markers for \"needs reindex\".\n  - a bounded \"archive -> DB\" resync path for recent writes.\n\n## Validation\n- Add invariants:\n  - Every DB message row referenced by `resource://thread/...` corresponds to an archive message file.\n  - Reservation conflict decisions match archive artifacts after rebuild.\n  - Acks are idempotent and do not regress.\n\n## Tests\n- Crash test(s) that kill the server mid-burst and verify:\n  - integrity_check passes,\n  - no missing canonical archive artifacts,\n  - DB can be reconciled without manual intervention.\n\n## Acceptance Criteria\n- A written contract exists (this bead + referenced code pointers).\n- Audit completed for all write tools with explicit \"strong vs eventual\" classification.\n- At least one end-to-end crash/restart test validates the contract.\n","created_at":"2026-02-07T05:47:02Z"}]}
{"id":"br-15dv.7","title":"[track] Build profile optimization and benchmark expansion","description":"The workspace has no custom [profile.release] settingsusing Cargo defaults (codegen-units=16, no LTO, no panic=abort). This leaves 10-20% performance on the table. The benchmark suite covers tool latency and archive writes but lacks 1000-agent load simulation. This track addresses: release profile tuning and comprehensive load benchmarks.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:25:36.888632226Z","created_by":"ubuntu","updated_at":"2026-02-07T03:25:36.888632226Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["build","perf"],"dependencies":[{"issue_id":"br-15dv.7","depends_on_id":"br-15dv","type":"parent-child","created_at":"2026-02-07T03:25:36.888632226Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.7.1","title":"Release profile: thin LTO, codegen-units=1, panic=abort, opt-level=3","description":"PROBLEM: The workspace has NO custom [profile.release] settings. Cargo defaults to codegen-units=16 (fragments optimization across compilation units), no LTO (misses cross-crate inlining), and debug=false. This leaves 10-20% performance on the table for production builds.\n\nSOLUTION: Add optimized release profile:\n1. [profile.release]:\n   lto = \"thin\"            # Cross-crate optimization (thin = fast compile, 80% of full LTO benefit)\n   codegen-units = 1        # Single codegen unit for maximum optimization\n   panic = \"abort\"          # No unwinding overhead (smaller + faster)\n   opt-level = 3            # Maximum optimization (speed over size)\n   strip = \"symbols\"        # Remove debug symbols from binary\n2. [profile.bench]:\n   inherits = \"release\"     # Benchmarks use same optimizations as release\n3. [profile.dev]:\n   opt-level = 1            # Slight optimization for dev builds (faster tests)\n   debug = 2                # Full debug info for development\n4. Consider target-specific CPU features: -C target-cpu=native for server deployments\n5. Add .cargo/config.toml with RUSTFLAGS for production builds\n\nEXPECTED IMPROVEMENT: 10-20% across all benchmarks, 30-50% smaller binary.\n\nCAUTION: codegen-units=1 significantly increases compile time. Only for release/bench.\n\nFILES: Cargo.toml (root), .cargo/config.toml","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:32:26.649704810Z","created_by":"ubuntu","updated_at":"2026-02-07T03:32:26.649704810Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["build","perf"],"dependencies":[{"issue_id":"br-15dv.7.1","depends_on_id":"br-15dv.7","type":"parent-child","created_at":"2026-02-07T03:32:26.649704810Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.7.2","title":"1000-agent load simulation benchmark with mixed workloads and budgets","description":"PROBLEM: Current benchmarks measure single-tool latency and small batches (100 messages). No benchmark simulates the 1000-agent target scenario with realistic concurrency patterns, mixed read/write workloads, and sustained throughput.\n\nSOLUTION: Comprehensive 1000-agent load simulation benchmark:\n1. Scenario A: Registration storm - 1000 agents register in 10 seconds\n   - Budget: p95 < 50ms per registration, 0 failures\n2. Scenario B: Message burst - 100 agents send 10 messages each simultaneously\n   - Budget: p95 < 100ms per send, p99 < 500ms, 0 lost messages\n3. Scenario C: Mixed workload - 1000 agents cycling through:\n   - 40% fetch_inbox (read)\n   - 30% send_message (write)\n   - 15% search_messages (read, expensive)\n   - 10% file_reservation_paths (read+write)\n   - 5% acknowledge_message (write)\n   - Sustained for 60 seconds at 100 RPS\n   - Budget: p95 < 200ms, p99 < 1s, 0 errors\n4. Scenario D: Thundering herd - 500 agents fetch_inbox for same project simultaneously\n   - Budget: p95 < 500ms, 0 errors\n5. Output: latency histograms, throughput chart, error rate, queue depths, pool utilization\n6. Run with criterion for statistical rigor (10 samples  10 iterations)\n\nFILES: New crates/mcp-agent-mail/benches/load_bench.rs or tests/load/","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:32:26.790154523Z","created_by":"ubuntu","updated_at":"2026-02-07T03:39:01.532284838Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["benchmark","perf","testing"],"dependencies":[{"issue_id":"br-15dv.7.2","depends_on_id":"br-15dv.1.1","type":"blocks","created_at":"2026-02-07T03:33:58.542413932Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.7.2","depends_on_id":"br-15dv.1.2","type":"blocks","created_at":"2026-02-07T03:33:58.816601928Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.7.2","depends_on_id":"br-15dv.10","type":"blocks","created_at":"2026-02-07T03:39:01.532219526Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.7.2","depends_on_id":"br-15dv.2.1","type":"blocks","created_at":"2026-02-07T03:33:58.680086078Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.7.2","depends_on_id":"br-15dv.7","type":"parent-child","created_at":"2026-02-07T03:32:26.790154523Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.8","title":"[track] Observability: metrics, histograms, and diagnostic reports","description":"Current observability is limited to basic query tracking (with global mutex overhead) and tool call counts. Missing: lock contention metrics, pool utilization histograms (P50/P95/P99), queue saturation metrics, per-tool latency distributions, and structured diagnostic reports for production debugging. At 1000 agents, operators need real-time visibility into system health to detect and diagnose issues before they cascade. This track adds comprehensive low-overhead observability.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:25:37.005929469Z","created_by":"ubuntu","updated_at":"2026-02-07T03:25:37.005929469Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["diagnostics","observability"],"dependencies":[{"issue_id":"br-15dv.8","depends_on_id":"br-15dv","type":"parent-child","created_at":"2026-02-07T03:25:37.005929469Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.8.1","title":"InstrumentedMutex wrapper for lock contention visibility","description":"PROBLEM: No visibility into lock contention. We can't tell if mutexes are causing delays, which locks are hottest, or whether lock ordering changes improve things. Without measurement, optimization is guesswork.\n\nSOLUTION: Lightweight lock contention tracking:\n1. Create InstrumentedMutex<T> wrapper:\n   - Records: acquire_count (AtomicU64), contended_count (AtomicU64), total_wait_ns (AtomicU64)\n   - Uses try_lock() first; if fails, increment contended_count, then lock() and measure wait time\n   - Zero overhead when lock is uncontended (try_lock succeeds)\n2. Replace all performance-critical Mutex with InstrumentedMutex\n3. Add metrics snapshot function: returns per-lock contention stats\n4. Expose via tooling/metrics resource under \"lock_contention\" key\n5. Add debug-only lock acquisition log (behind #[cfg(debug_assertions)])\n6. Track max hold duration: record lock()  drop() interval\n\nEXPECTED OVERHEAD: <10ns per uncontended lock (one atomic increment).\n\nFILES: New crates/mcp-agent-mail-core/src/instrumented_mutex.rs, integration across crates","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:32:26.928881170Z","created_by":"ubuntu","updated_at":"2026-02-07T03:33:56.260554339Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["locks","observability"],"dependencies":[{"issue_id":"br-15dv.8.1","depends_on_id":"br-15dv.3.1","type":"blocks","created_at":"2026-02-07T03:33:56.260481352Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.8.1","depends_on_id":"br-15dv.8","type":"parent-child","created_at":"2026-02-07T03:32:26.928881170Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.8.2","title":"Pool utilization histograms with P50/P95/P99 acquire latency","description":"Add bounded-frequency DB pool utilization sampling + acquire latency percentiles (P50/P95/P99) via metrics core, surfaced in health_check.","acceptance_criteria":"health_check returns pool_utilization; gauges/histograms update without hot-path locks; cargo fmt/check/clippy/test pass.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T03:32:27.073855215Z","created_by":"ubuntu","updated_at":"2026-02-07T05:41:00.493214895Z","closed_at":"2026-02-07T05:41:00.493175401Z","close_reason":"Implemented pool utilization gauges + acquire latency percentiles; surfaced in health_check; conformance fixtures updated + normalized; quality gates pass.","source_repo":".","compaction_level":0,"original_size":0,"labels":["db","observability","pool"],"dependencies":[{"issue_id":"br-15dv.8.2","depends_on_id":"br-15dv.8","type":"parent-child","created_at":"2026-02-07T03:32:27.073855215Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.8.2","depends_on_id":"br-15dv.8.6","type":"blocks","created_at":"2026-02-07T03:37:32.681950581Z","created_by":"ubuntu","metadata":"{}","thread_id":""}],"comments":[{"id":15,"issue_id":"br-15dv.8.2","author":"Dicklesworthstone","text":"## What Changed\nThis bead implements pool utilization + acquire latency percentiles using the always-on lock-free metrics core.\n\n### Pool stats sampling (bounded overhead)\n- `DbPool` now samples `sqlmodel_pool::Pool::stats()` and updates gauges.\n- Sampling is rate-limited (<= 1 sample / 250ms) so we do not pay for `Pool::stats()` on every request.\n- Gauges exported in metrics snapshot:\n  - `pool_total_connections`\n  - `pool_idle_connections`\n  - `pool_active_connections`\n  - `pool_pending_requests`\n  - `pool_peak_active_connections` (high-water mark)\n  - `pool_utilization_pct`\n  - `pool_over_80_since_us` (0 when below threshold)\n\n### Acquire latency percentiles\n- Acquire latency is recorded into a log2 histogram in the metrics core.\n- Percentiles are exported as snapshot `p50/p95/p99` and converted to ms using ceil.\n\n### Health surface\n- `health_check` now includes `pool_utilization`:\n  - `active`, `idle`, `total`, `pending`\n  - `peak_active`, `utilization_pct`\n  - `acquire_p50_ms`, `acquire_p95_ms`, `acquire_p99_ms`\n  - `over_80_for_s` + `warning` (warning when >= 300s)\n- `health_check` explicitly triggers a fresh stats sample via `sample_pool_stats_now()`.\n\n## Perf / Correctness Notes\n- Hot path remains lock-free; sampling is amortized and bounded.\n- Percentiles are approximate (histogram), intended for diagnostics.\n\n## Conformance / Determinism\n- Conformance fixture updated to include `pool_utilization`.\n- Latency percentile fields are normalized in fixtures to avoid non-determinism from earlier tool calls in the same conformance test binary.\n\n## Files\n- `crates/mcp-agent-mail-core/src/metrics.rs`\n- `crates/mcp-agent-mail-db/src/pool.rs`\n- `crates/mcp-agent-mail-tools/src/identity.rs`\n- `crates/mcp-agent-mail-conformance/tests/conformance/fixtures/python_reference.json`\n","created_at":"2026-02-07T05:40:56Z"}]}
{"id":"br-15dv.8.3","title":"Queue health metrics: WBQ and commit queue saturation tracking","description":"PROBLEM: No real-time visibility into WBQ and commit queue health. When these queues saturate and fall back to sync, operators have no way to detect it until latency spikes appear.\n\nSOLUTION: Queue health metrics with saturation detection:\n1. For WBQ:\n   - depth: AtomicUsize (current queue size)\n   - capacity: usize (static, from config)\n   - high_water_mark: AtomicUsize (reset every 60s)\n   - enqueued_total: AtomicU64\n   - drained_total: AtomicU64\n   - sync_fallback_count: AtomicU64\n   - drain_latency_p95: streaming percentile (reservoir sampling)\n2. For CommitQueue (per-project if br-15dv.2.2 is done):\n   - Same metrics structure as WBQ\n   - Plus: commits_batched_count, avg_batch_size\n3. Expose via tooling/metrics under \"queues\" key:\n   { wbq: { depth, capacity, utilization_pct, sync_fallback_count, ... }, commit: { ... } }\n4. Alert thresholds:\n   - WBQ > 50% capacity  Yellow\n   - WBQ > 80% capacity  Red\n   - sync_fallback_count increasing  Critical warning\n5. Include in health_check response\n\nFILES: crates/mcp-agent-mail-storage/src/lib.rs, tooling/metrics resource","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T03:32:27.214024072Z","created_by":"ubuntu","updated_at":"2026-02-07T21:47:49.150864217Z","closed_at":"2026-02-07T21:47:49.150839771Z","close_reason":"Implemented WBQ + commit-coalescer queue health metrics, added health_check queues, updated conformance fixtures","source_repo":".","compaction_level":0,"original_size":0,"labels":["observability","queues","storage"],"dependencies":[{"issue_id":"br-15dv.8.3","depends_on_id":"br-15dv.8","type":"parent-child","created_at":"2026-02-07T03:32:27.214024072Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.8.3","depends_on_id":"br-15dv.8.6","type":"blocks","created_at":"2026-02-07T03:37:32.814267889Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.8.4","title":"Per-tool latency histograms with streaming P50/P95/P99","description":"PROBLEM: Tool metrics only track call count and error count. No latency distribution information. Cannot tell which tools are slow, whether latency is stable or degrading, or what the tail latency looks like.\n\nSOLUTION: Per-tool latency tracking with streaming percentiles:\n1. For each tool, track:\n   - call_count: AtomicU64\n   - error_count: AtomicU64\n   - total_duration_us: AtomicU64\n   - min_duration_us: AtomicU64 (using fetch_min)\n   - max_duration_us: AtomicU64 (using fetch_max)\n   - P50/P95/P99: reservoir sampling (100 samples per tool)\n2. Snapshot structure per tool:\n   { name, calls, errors, avg_ms, min_ms, max_ms, p50_ms, p95_ms, p99_ms }\n3. Rolling window: reset reservoir every 60 seconds\n4. Expose via tooling/metrics under \"tool_latency\" key\n5. Add \"slow tools\" detection: any tool with p95 > 500ms gets flagged\n6. Integration with InstrumentedTool wrapper (already wraps all tools)\n\nEXPECTED OVERHEAD: ~50ns per tool call (reservoir insert is amortized O(1)).\n\nDEPENDS ON: br-15dv.3.2 (lock-free tool metrics)  build latency tracking into the same atomic infrastructure.\n\nFILES: crates/mcp-agent-mail-server/src/lib.rs (InstrumentedTool)","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:32:27.353009142Z","created_by":"ubuntu","updated_at":"2026-02-07T03:37:32.942020809Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["metrics","observability","tools"],"dependencies":[{"issue_id":"br-15dv.8.4","depends_on_id":"br-15dv.3.2","type":"blocks","created_at":"2026-02-07T03:33:56.664891312Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.8.4","depends_on_id":"br-15dv.8","type":"parent-child","created_at":"2026-02-07T03:32:27.353009142Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.8.4","depends_on_id":"br-15dv.8.6","type":"blocks","created_at":"2026-02-07T03:37:32.941947833Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.8.5","title":"Structured diagnostic report combining all health metrics and recommendations","description":"PROBLEM: When issues occur in production with 1000 agents, operators need a comprehensive diagnostic snapshot to debug problems. Currently, they must manually check health_check, tooling/metrics, and console logs separately.\n\nSOLUTION: Structured diagnostic report combining all system health info:\n1. Add diagnostic_report() function that gathers:\n   - System: uptime, Rust version, OS, CPU count, memory RSS\n   - Database: pool stats, circuit state, cache hit rates, slow queries\n   - Storage: WBQ stats, commit queue stats, disk free, archive count\n   - Tools: per-tool call/error/latency stats, slow tools\n   - Locks: contention stats for all instrumented mutexes\n   - Config: active config (sanitized, no secrets)\n   - Recent errors: last 50 errors with timestamps and stack info\n2. Output as structured JSON (machine-parseable) AND human-readable summary\n3. Expose via: resource://diagnostics, CLI 'am diagnostics', and SIGUSR1 signal handler\n4. Include \"recommendations\" section: automated suggestions based on metrics\n   (e.g., \"Pool utilization 95%: consider increasing DATABASE_POOL_SIZE\")\n5. Size limit: cap report at 100KB (truncate error logs if needed)\n\nFILES: New crates/mcp-agent-mail-core/src/diagnostics.rs, CLI command, resource","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-07T03:32:27.498569705Z","created_by":"ubuntu","updated_at":"2026-02-07T03:33:57.198312941Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["diagnostics","observability"],"dependencies":[{"issue_id":"br-15dv.8.5","depends_on_id":"br-15dv.8","type":"parent-child","created_at":"2026-02-07T03:32:27.498569705Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.8.5","depends_on_id":"br-15dv.8.1","type":"blocks","created_at":"2026-02-07T03:33:56.803116364Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.8.5","depends_on_id":"br-15dv.8.2","type":"blocks","created_at":"2026-02-07T03:33:56.935156453Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.8.5","depends_on_id":"br-15dv.8.3","type":"blocks","created_at":"2026-02-07T03:33:57.066992680Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.8.5","depends_on_id":"br-15dv.8.4","type":"blocks","created_at":"2026-02-07T03:33:57.198273266Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.8.6","title":"Metrics core: lock-free counters + latency histograms for hot-path components","description":"## Problem\nWe cannot optimize or harden what we cannot measure. Current instrumentation is partial and (in places) mutex-heavy, which becomes self-defeating at 1000-agent concurrency.\n\n## Goal\nAdd **low-overhead** observability primitives that are safe to run on every request:\n- O(1) atomic increments and bounded histograms\n- no per-request allocations\n- no global mutex on the hot path\n\n## Deliverables\n1. **Metric primitives**\n   - `Counter`: AtomicU64\n   - `Gauge`: AtomicI64/AtomicU64 (or AtomicU64 with encoding)\n   - `Histogram`: HDR histogram or fixed-bucket log2 histogram with atomic bucket counters\n2. **Standard metric set** (names + semantics fixed):\n   - HTTP: requests_total, requests_inflight, status_2xx/4xx/5xx, request_bytes, response_bytes\n   - Tool dispatch: tool_calls_total{tool}, tool_errors_total{tool}, tool_latency_us{tool}\n   - DB pool: acquire_wait_us, pool_active/idle, acquire_timeouts\n   - SQLite: busy_retries_total, circuit_open_total\n   - Storage: wbq_depth, wbq_enqueued/drained/fallbacks/errors, commit_queue_depth, git_lock_retries\n   - Backpressure: level (0/1/2), transitions_total\n3. **Collection + snapshot API**\n   - single \"snapshot\" struct that can be rendered as JSON without locks\n   - snapshot includes p50/p95/p99 estimates for key histograms\n4. **Performance constraints**\n   - budget: metric recording cost <= 200ns/request on modern x86_64 for counters-only paths\n\n## Implementation Notes\n- Prefer fixed-size arrays indexed by enum/tool-id rather than HashMap.\n- Avoid storing strings in the metrics hot path. Tool name -> index mapping must be computed once at startup.\n\n## Acceptance Criteria\n- A minimal metrics core exists and is used by:\n  - HTTP handler\n  - InstrumentedTool wrapper\n  - DB pool acquisition path\n  - WBQ enqueue/drain\n- No new global mutex is introduced on the request hot path.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-07T03:36:27.815820818Z","created_by":"ubuntu","updated_at":"2026-02-07T04:59:59.491334980Z","closed_at":"2026-02-07T04:59:59.491312207Z","close_reason":"Implemented lock-free metrics core (counters + log2 histograms) and wired it into HTTP handler, tool dispatch, DB pool acquire, and WBQ enqueue/drain; added MCP resource resource://tooling/metrics_core; fmt/check/clippy/tests pass.","source_repo":".","compaction_level":0,"original_size":0,"labels":["observability","perf"],"dependencies":[{"issue_id":"br-15dv.8.6","depends_on_id":"br-15dv.8","type":"parent-child","created_at":"2026-02-07T03:36:27.815820818Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.8.7","title":"Git/archive IO metrics: commit latency + lock wait histograms","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T05:46:02.408902365Z","created_by":"ubuntu","updated_at":"2026-02-07T05:46:28.444682959Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["git","observability","storage"],"dependencies":[{"issue_id":"br-15dv.8.7","depends_on_id":"br-15dv.8","type":"parent-child","created_at":"2026-02-07T05:46:02.408902365Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.8.7","depends_on_id":"br-15dv.8.6","type":"blocks","created_at":"2026-02-07T05:46:12.559131927Z","created_by":"ubuntu","metadata":"{}","thread_id":""}],"comments":[{"id":16,"issue_id":"br-15dv.8.7","author":"Dicklesworthstone","text":"## Background\nAt 1000+ concurrent agents, the archive path becomes a primary tail-latency driver:\n- `.archive.lock` contention serializes per-project writes.\n- `git` commit/index operations can stall on `index.lock`.\n- Commit coalescing can hide backlog until it explodes.\n\nWithout first-class metrics, we are blind to whether p99 latency is dominated by:\n- lock waits,\n- git CPU time,\n- filesystem flushes,\n- queue backlog.\n\n## Goal\nAdd low-overhead metrics that make archive/git contention observable and actionable in both:\n- `resource://tooling/metrics_core` (always-on snapshot)\n- `health_check` / diagnostics (summarized warnings)\n\n## Proposed Metrics (Minimal but Sufficient)\n### Histograms\n- `storage.archive_lock_wait_us` (time spent waiting to acquire `projects/<slug>/.archive.lock`)\n- `storage.commit_lock_wait_us` (time spent waiting for commit/index lock)\n- `storage.git_commit_latency_us` (time spent performing commit/index update)\n\n### Counters\n- `storage.git_index_lock_retries_total`\n- `storage.git_index_lock_failures_total`\n- `storage.commit_attempts_total`\n- `storage.commit_failures_total`\n\n### Gauges\n- `storage.commit_queue_depth` (current items pending)\n- `storage.commit_batch_size_last` + optional rolling max\n\n## Implementation Notes\n- Instrument inside `crates/mcp-agent-mail-storage/src/lib.rs` at the lock acquisition boundaries, not around the entire tool call.\n- Prefer monotonic timers; record in micros.\n- Keep the hot path lock-free: use the metrics-core atomics/histograms (no HashMap/Mutex).\n\n## Tests\n- Unit test: metrics snapshot after a simulated lock acquisition includes the new keys and is JSON-serializable.\n- Integration test (lightweight): run a minimal archive init + write op, then assert counters/histograms are non-zero.\n\n## Acceptance Criteria\n- Metrics appear in `resource://tooling/metrics_core` under a stable schema.\n- No conformance fixture regressions.\n- Overhead is amortized to ~O(atomic) per event; no new global locks.\n","created_at":"2026-02-07T05:46:28Z"}]}
{"id":"br-15dv.9","title":"[track] Stress test expansion: 1000-agent load simulation and chaos testing","description":"Current stress tests use 2-16 threads with 10-200 operationsfar below the 1000-agent target. No tests for: sustained high RPS, cache thrashing under agent churn, queue saturation, large message payloads (>1MB), or fault injection. Without these tests, we can't validate that optimizations actually work at scale. This track adds comprehensive load tests that simulate realistic 1000-agent scenarios and chaos/fault injection.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:25:37.138878668Z","created_by":"ubuntu","updated_at":"2026-02-07T03:25:37.138878668Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["scale","stress","testing"],"dependencies":[{"issue_id":"br-15dv.9","depends_on_id":"br-15dv","type":"parent-child","created_at":"2026-02-07T03:25:37.138878668Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.9.1","title":"1000-agent concurrent stress test with 16K operations","description":"PROBLEM: Current stress tests max out at 16 threads with 200 operations. This is 60x below the 1000-agent target. We cannot validate that optimizations work at target scale without a test at target scale.\n\nSOLUTION: 1000-agent concurrent connection stress test:\n1. Spawn 1000 async tasks (using asupersync runtime)\n2. Each task: ensure_project  register_agent  5x send_message  5x fetch_inbox  5x ack\n3. Total: 1000 registrations + 5000 sends + 5000 fetches + 5000 acks = 16,000 operations\n4. Assertions:\n   - Zero errors (no pool timeouts, no circuit breaks)\n   - All 5000 messages retrievable\n   - All 5000 acks recorded\n   - Total duration < 120 seconds\n   - Pool utilization peak < 90%\n5. Run against in-memory SQLite (for CI speed) AND on-disk SQLite (for realism)\n6. Record: operations/sec, p50/p95/p99 latency, peak memory RSS\n7. Output results to tests/artifacts/stress/ for regression tracking\n8. Must run in CI without special hardware (single machine, 4 cores)\n\nDEPENDS ON: br-15dv.1.1 (pool sizing)  test will fail with default 7-connection pool\n\nFILES: crates/mcp-agent-mail-db/tests/stress.rs (extend existing)","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:33:25.961133625Z","created_by":"ubuntu","updated_at":"2026-02-07T03:39:01.665258255Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["scale","stress","testing"],"dependencies":[{"issue_id":"br-15dv.9.1","depends_on_id":"br-15dv.1.1","type":"blocks","created_at":"2026-02-07T03:33:57.329642559Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.9.1","depends_on_id":"br-15dv.10","type":"blocks","created_at":"2026-02-07T03:39:01.665177744Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.9.1","depends_on_id":"br-15dv.9","type":"parent-child","created_at":"2026-02-07T03:33:25.961133625Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.9.2","title":"Sustained 100 RPS load test for 300 seconds with stability assertions","description":"PROBLEM: Current tests measure burst performance (do N operations as fast as possible). They don't test sustained throughput over time, which reveals different problems: memory leaks, cache degradation, pool connection aging, WAL growth.\n\nSOLUTION: Sustained 100+ RPS load test:\n1. Generate steady-state load: 100 requests/sec for 300 seconds (30,000 total operations)\n2. Request mix (matching Scenario C from benchmark bead):\n   - 40% fetch_inbox, 30% send_message, 15% search, 10% reservations, 5% ack\n3. Use 50 worker threads with rate limiter (token bucket at 100 tokens/sec)\n4. Measure every 10 seconds:\n   - Throughput (actual RPS)\n   - Latency percentiles (P50, P95, P99)\n   - Error rate\n   - Memory RSS\n   - SQLite WAL size\n   - Cache hit rate\n   - Queue depths (WBQ, commit)\n5. Assertions:\n   - Throughput stays within 10% of target for entire duration (no degradation)\n   - P99 latency < 2s throughout (no creeping tail latency)\n   - Memory RSS grows < 100MB over 300s (no leak)\n   - Zero errors\n6. Output time-series data for visualization\n\nFILES: New crates/mcp-agent-mail-db/tests/sustained_load.rs or tests/load/","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T03:33:26.097923048Z","created_by":"ubuntu","updated_at":"2026-02-07T03:33:57.601972205Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["scale","stress","testing"],"dependencies":[{"issue_id":"br-15dv.9.2","depends_on_id":"br-15dv.1.1","type":"blocks","created_at":"2026-02-07T03:33:57.466571713Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.9.2","depends_on_id":"br-15dv.2.1","type":"blocks","created_at":"2026-02-07T03:33:57.601897445Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.9.2","depends_on_id":"br-15dv.9","type":"parent-child","created_at":"2026-02-07T03:33:26.097923048Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.9.3","title":"Cache thrashing stress test with Zipfian access patterns","description":"PROBLEM: No test for cache behavior when agent count exceeds cache capacity. With default 1000 entries and 1000+ agents, cache thrashes (every insert evicts). Need to verify the LRU overhaul (br-15dv.1.2) actually prevents thrashing.\n\nSOLUTION: Cache thrashing stress test:\n1. Configure cache with small capacity (100 entries) for testing\n2. Register 500 agents across 10 projects\n3. Cycle through all 500 agents, calling resolve_agent for each\n4. Measure after each cycle:\n   - Cache hit rate (should improve after first cycle with LRU)\n   - Resolution latency (cached vs uncached)\n   - DB query count (should decrease as cache stabilizes)\n5. Assertions:\n   - After 2nd cycle: cache hit rate > 80% (working set fits in cache)\n   - After 5th cycle: cache hit rate > 95% (LRU stabilized)\n   - Thrashing detection: cache eviction rate < 10% of access rate\n6. Test with Zipfian distribution (some agents accessed more than others)\n   - Popular agents should have near-100% hit rate\n7. Test cache coherency: modify agent, verify cache returns updated data\n\nDEPENDS ON: br-15dv.1.2 (LRU cache overhaul)\n\nFILES: crates/mcp-agent-mail-db/tests/stress.rs (new test function)","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:33:26.236548779Z","created_by":"ubuntu","updated_at":"2026-02-07T03:33:57.732308844Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["cache","stress","testing"],"dependencies":[{"issue_id":"br-15dv.9.3","depends_on_id":"br-15dv.1.2","type":"blocks","created_at":"2026-02-07T03:33:57.732261465Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.9.3","depends_on_id":"br-15dv.9","type":"parent-child","created_at":"2026-02-07T03:33:26.236548779Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.9.4","title":"Queue saturation stress test for WBQ and commit queue overflow","description":"PROBLEM: No test for WBQ and commit queue behavior when saturated. We need to verify that queues handle overflow gracefully (with new backpressure, not sync fallback).\n\nSOLUTION: Queue saturation stress test:\n1. Configure small queues for testing: WBQ_CAPACITY=32, COMMIT_QUEUE=10\n2. Burst 200 messages in 1 second (6x WBQ capacity)\n3. Measure:\n   - WBQ high-water mark (should peak at 32, not overflow)\n   - Sync fallback count (should be 0 with backpressure)\n   - Drain rate (messages/sec)\n   - End-to-end latency for queued vs direct operations\n4. Assertions:\n   - Zero sync fallbacks (backpressure throttles senders instead)\n   - All 200 messages eventually committed to archive\n   - No data loss\n   - Queue depth returns to 0 within 10 seconds after burst\n5. Test commit coalescer batching efficiency:\n   - 200 messages should result in <50 git commits (batch size 4)\n   - Verify batch commit messages contain correct metadata\n\nDEPENDS ON: br-15dv.2.1 (WBQ capacity increase), br-15dv.2.2 (per-project queues)\n\nFILES: crates/mcp-agent-mail-storage/tests/ (new test)","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:33:26.384636050Z","created_by":"ubuntu","updated_at":"2026-02-07T03:41:00.666743403Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["queues","stress","testing"],"dependencies":[{"issue_id":"br-15dv.9.4","depends_on_id":"br-15dv.2.1","type":"blocks","created_at":"2026-02-07T03:33:57.867281695Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.9.4","depends_on_id":"br-15dv.2.2","type":"blocks","created_at":"2026-02-07T03:33:58.000686790Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.9.4","depends_on_id":"br-15dv.2.6","type":"blocks","created_at":"2026-02-07T03:41:00.666660969Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.9.4","depends_on_id":"br-15dv.9","type":"parent-child","created_at":"2026-02-07T03:33:26.384636050Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.9.5","title":"Large message payload stress test with size limits and memory tracking","description":"PROBLEM: No test for large message payloads. A message with a 5MB body gets buffered multiple times: tool handler  DB insert  WBQ channel  JSON serialization  archive write. No size limits exist. 256 such messages in WBQ = 1.3GB.\n\nSOLUTION: Large message stress test:\n1. Test message size limits (after br-15dv.4.3 implementation):\n   - Send message with 1MB body  should succeed\n   - Send message with 10MB body  should return INVALID_ARGUMENT\n   - Send message with 100MB body  should reject fast (not OOM)\n2. Test memory under large message load:\n   - Send 100 messages with 500KB bodies concurrently\n   - Measure peak RSS during burst\n   - Assert: peak RSS < 500MB (reasonable for 100  500KB = 50MB payload)\n3. Test WBQ behavior with large messages:\n   - Queue 50 large messages (500KB each = 25MB in queue)\n   - Verify drain completes without OOM\n   - Verify archive files are correctly written\n4. Test FTS indexing of large bodies:\n   - 1MB body indexed in FTS5\n   - Search returns correct results\n   - Index time < 100ms per message\n\nDEPENDS ON: br-15dv.4.3 (per-message size limits)\n\nFILES: crates/mcp-agent-mail-db/tests/stress.rs (new test functions)","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:33:26.531398068Z","created_by":"ubuntu","updated_at":"2026-02-07T03:33:58.137164790Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["memory","stress","testing"],"dependencies":[{"issue_id":"br-15dv.9.5","depends_on_id":"br-15dv.4.3","type":"blocks","created_at":"2026-02-07T03:33:58.137080903Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.9.5","depends_on_id":"br-15dv.9","type":"parent-child","created_at":"2026-02-07T03:33:26.531398068Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.9.6","title":"Chaos testing framework with injectable DB, git, and IO faults","description":"PROBLEM: No tests for failure recovery. The system needs to handle: pool connection failures, git lock stalls, disk IO errors, and slow queries gracefully. Without fault injection, we only test the happy path.\n\nSOLUTION: Chaos testing framework with injectable faults:\n1. Create FaultInjector trait with methods:\n   - should_fail_db_acquire() -> bool\n   - should_fail_git_commit() -> bool\n   - should_delay_ms() -> Option<u64>\n   - should_corrupt_response() -> bool\n2. Inject at: pool acquire, query execution, git commit, signal write\n3. Test scenarios:\n   a. 10% random DB failure rate for 30 seconds  verify circuit breaker trips and recovers\n   b. Git lock stuck for 5 seconds  verify retry succeeds without data loss\n   c. Pool exhaustion for 10 seconds  verify graceful degradation (not crash)\n   d. Alternating failures: DB fails for 5s  recovers  git fails for 5s  recovers\n4. Assertions for each:\n   - No panics or crashes\n   - Circuit breaker state transitions are correct\n   - System recovers to full health within 60 seconds\n   - No data loss (all committed messages are retrievable after recovery)\n5. Enable only in test builds (#[cfg(test)] or feature flag)\n\nFILES: New crates/mcp-agent-mail-core/src/fault_inject.rs, integration in db/storage","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T03:33:26.674285340Z","created_by":"ubuntu","updated_at":"2026-02-07T03:33:58.273788873Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["chaos","resilience","testing"],"dependencies":[{"issue_id":"br-15dv.9.6","depends_on_id":"br-15dv.6.3","type":"blocks","created_at":"2026-02-07T03:33:58.273738008Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.9.6","depends_on_id":"br-15dv.9","type":"parent-child","created_at":"2026-02-07T03:33:26.674285340Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-15dv.9.7","title":"Crash/restart test: kill mid-burst, restart, verify invariants","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-07T05:47:07.482407135Z","created_by":"ubuntu","updated_at":"2026-02-07T05:47:24.967436284Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["chaos","reliability","stress"],"dependencies":[{"issue_id":"br-15dv.9.7","depends_on_id":"br-15dv.6.2","type":"blocks","created_at":"2026-02-07T05:47:13.051747357Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.9.7","depends_on_id":"br-15dv.6.7","type":"blocks","created_at":"2026-02-07T05:47:12.929962066Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-15dv.9.7","depends_on_id":"br-15dv.9","type":"parent-child","created_at":"2026-02-07T05:47:07.482407135Z","created_by":"ubuntu","metadata":"{}","thread_id":""}],"comments":[{"id":18,"issue_id":"br-15dv.9.7","author":"Dicklesworthstone","text":"## Goal\nProve crash safety under realistic write load: the system can be killed mid-burst and recover without manual intervention, with invariants intact.\n\n## Scenario\n1. Start server (HTTP) on a temp `DATABASE_URL` + temp `STORAGE_ROOT`.\n2. Run a burst workload (concurrent):\n   - ensure_project + register_agent\n   - send_message (no attachments)\n   - acks + mark_message_read\n   - file_reservation_paths\n3. Kill the server **without graceful shutdown** (SIGKILL).\n4. Restart the server against the same DB + storage.\n5. Validate invariants:\n   - `PRAGMA integrity_check` passes.\n   - Core queries return expected counts.\n   - Canonical archive artifacts exist for messages/reservations written before the kill.\n   - No \"dangling\" DB rows that reference missing archive files.\n\n## Implementation Notes\n- Use a deterministic random seed to pick kill timing (reproducible failures).\n- Keep workload sizes bounded for CI (small) but structure so it scales for local soak.\n- Capture artifacts on failure: last N requests, metrics snapshot, and a list of missing artifacts.\n\n## Acceptance Criteria\n- Test is reliable (no flakiness) and runs in CI within an agreed time budget.\n- Failure output is actionable: clearly identifies which invariant broke and provides debugging hints.\n","created_at":"2026-02-07T05:47:24Z"}]}
{"id":"br-1bm","title":"HTTP Server Parity: Legacy Python Exact Match","description":"## Objective\nPort the **HTTP server stack** to Rust with exact legacy Python behavior: auth, rate limiting, streamable HTTP transport, mail UI endpoints, logging, and background workers.\n\n## Scope\n- Middleware: bearer auth, JWT + RBAC, rate limiting.\n- Streamable HTTP MCP transport (stateless ASGI adapter behavior, header normalization, base path mounting).\n- Mail UI routes and static assets.\n- Request logging + OTEL noop parity.\n- Background workers (ack TTL, file reservation cleanup, tool metrics, retention/quota).\n- Health + wellknown endpoints.\n\n## Tests\n- Unit + integration tests per subsystem (JWT, rate limit, streamable HTTP, mail UI, logging, workers).\n- E2E HTTP suite (br-2ei.9.6) covering auth, CORS, streamable, and UI endpoints.\n\n## Logging/Artifacts\n- HTTP transcripts + diffs under `tests/artifacts/http/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-05T05:32:32.057076856Z","created_by":"ubuntu","updated_at":"2026-02-06T16:38:17.646906905Z","closed_at":"2026-02-06T16:38:17.646884493Z","close_reason":"All HTTP server parity child beads complete (auth/JWT/RBAC, rate limit, peer addr/localhost bypass, streamable HTTP, /mail SSR UI, CORS, logging+OTEL no-op, workers, health/well-known)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:48:14.330942304Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm","depends_on_id":"br-36w","type":"blocks","created_at":"2026-02-05T16:18:23.374551664Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.1","title":"JWT Auth Parity (HS256 + JWKS + role claim)","description":"Objective:\nImplement JWT authentication exactly as in legacy Python (mcp_agent_mail/http.py). This includes HS256 HMAC and JWKS verification paths, audience/issuer validation, role extraction, and error semantics. Must be 1:1 on outputs and failure modes.\n\nLegacy Reference Behavior (must match):\n- If JWT enabled and Authorization missing or not Bearer: 401 {\"detail\":\"Unauthorized\"}\n- Decode token using:\n  - If JWKS URL set: fetch JWKS, select key by header.kid, verify\n  - Else if secret set: verify with HMAC secret\n  - Algorithms from HTTP_JWT_ALGORITHMS (default HS256)\n- Validate audience/issuer if configured; otherwise ignore\n- On any failure: 401 {\"detail\":\"Unauthorized\"}\n- Extract roles from claim HTTP_JWT_ROLE_CLAIM (default \"role\")\n  - String -> singleton set\n  - List/tuple -> set of strings\n  - Else -> empty\n- If roles empty, use HTTP_RBAC_DEFAULT_ROLE\n- Store claims for rate limit identity (sub) and any downstream uses\n\nImplementation Considerations:\n- JWKS fetch must be async-safe via asupersync HTTP client (no tokio)\n- Cache JWKS by URL with TTL to avoid per-request latency\n- Must not change external response schema or status codes\n- Log auth failures at debug/trace (no extra HTTP output)\n\nTests and E2E (with detailed logging):\nUnit tests:\n- Missing Authorization header -> 401\n- Non-Bearer Authorization -> 401\n- HS256 valid/invalid signatures\n- JWKS valid/invalid (kid missing, bad signature)\n- Audience/issuer mismatch -> 401\n- Role claim variants (string, list, missing)\nIntegration tests:\n- Start server with HTTP_JWT_* env vars; make requests with valid/invalid JWT\n- Verify RBAC path uses roles correctly\nE2E:\n- Covered by `br-1bm.1.5` (uses shared harness `br-2ei.9.1`).\n\nNotes:\n- Localhost bypass logic is owned by `br-1bm.3` + `br-1bm.8`; JWT must still match legacy in the non-bypass path.\n\n## Acceptance Criteria\n- JWT behavior matches legacy for all vectors extracted in `br-1bm.1.1`.\n- Role extraction matches Python behavior across all supported claim shapes.\n- `br-1bm.1.5` unit+integration+E2E suite passes and produces high-signal artifacts on failure.","status":"closed","priority":1,"issue_type":"task","assignee":"CopperBarn","created_at":"2026-02-05T05:32:46.671284098Z","created_by":"ubuntu","updated_at":"2026-02-06T13:29:42.957613837Z","closed_at":"2026-02-06T13:29:42.957588740Z","close_reason":"All subtasks br-1bm.1.1-1.5 complete; JWT unit+integration+E2E coverage passing","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.1","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.1.1","title":"JWT Parity: extract legacy behavior + test vectors","description":"Purpose:\nExtract exact legacy JWT behavior and define concrete test vectors so Rust matches Python 1:1.\n\nLegacy Implementation Notes (from http.py):\n- Header parse: token.split(\".\",1)[0]; base64url decode with padding; JSON parse. Any error -> None.\n- If jwks_url set:\n  - httpx.AsyncClient(timeout=5) GET jwks_url -> .json()\n  - JsonWebKey.import_key_set(jwks)\n  - kid = header.get(\"kid\"); key = find_by_kid(kid) if present else key_set.keys[0]\n- Else if secret set:\n  - JsonWebKey.import_key(secret, {\"kty\":\"oct\"})\n- If key None -> Unauthorized.\n- jwt.decode(token, key) using algs from HTTP_JWT_ALGORITHMS (default [\"HS256\"]). Any error -> Unauthorized.\n- If audience configured: claims.validate_aud(audience)\n- If issuer configured: if str(claims.get(\"iss\") or \"\") != issuer -> Unauthorized (no fallback)\n- claims.validate() (handles exp/nbf/iat if present)\n- Returns dict(claims) on success.\n\nConcrete Test Vectors (must implement):\n1) Missing Authorization header -> 401 {\"detail\":\"Unauthorized\"}\n2) Authorization not Bearer -> 401\n3) Header parse fail (malformed base64 / non-JSON header) -> 401\n4) JWKS path:\n   - jwks_url set, kid present, matching key -> success\n   - jwks_url set, kid present, no matching key -> 401\n   - jwks_url set, kid missing -> uses first key in key_set\n   - jwks fetch fails / invalid JSON -> 401\n5) Secret path:\n   - jwt_secret set, HS256 valid -> success\n   - jwt_secret set, signature invalid -> 401\n6) Algorithms:\n   - alg not in HTTP_JWT_ALGORITHMS -> 401\n7) Audience:\n   - jwt_audience set, token aud matches -> success\n   - jwt_audience set, token aud mismatch -> 401\n8) Issuer:\n   - jwt_issuer set, token iss matches exactly -> success\n   - jwt_issuer set, token iss missing or different -> 401\n9) Claims validate:\n   - exp in past -> 401\n   - nbf in future -> 401\n   - exp/nbf absent -> ok\n10) Role claim:\n   - role claim string -> roles={string}\n   - role claim list -> roles={strings}\n   - role claim missing/invalid -> roles empty -> default role applied downstream\n\nDeliverable:\n- A markdown or JSON matrix of inputs -> expected HTTP status/body and roles extracted.\n- Must be explicit enough that Rust tests can be derived directly.\n\nDependencies: none (spec extraction only).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:37:09.570324403Z","created_by":"ubuntu","updated_at":"2026-02-05T07:37:27.060998320Z","closed_at":"2026-02-05T07:37:27.060980056Z","close_reason":"Extracted legacy JWT behavior + explicit test vectors in bead description","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.1.1","depends_on_id":"br-1bm.1","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.1.2","title":"JWT Parity: JWKS fetch (kid selection, legacy no-cache)","description":"## Objective\nImplement legacy JWKS handling for JWT verification (no implicit caching).\n\n## Scope\n- Fetch JWKS from `HTTP_JWT_JWKS_URL` on demand.\n- Parse with authlib-compatible JWK set.\n- If token header has `kid`, select matching key; otherwise use first key.\n- If fetch or parsing fails, treat token as unauthorized.\n\n## Tests\n- Unit tests with fixture JWKS (kid match, no kid, missing kid).\n- Integration test with mocked JWKS HTTP endpoint.\n\n## Logging/Artifacts\n- Log structured error when JWKS fetch fails (but return Unauthorized).\n- Store JWKS test transcripts under `tests/artifacts/http/jwt/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:37:13.638466525Z","created_by":"ubuntu","updated_at":"2026-02-06T02:55:39.252251926Z","closed_at":"2026-02-06T02:55:39.252229264Z","close_reason":"Fixed: upstream asupersync HTTP/1 client flush bug unblocked JWKS fetch; full suite passes","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.1.2","depends_on_id":"br-1bm.1","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.1.2","depends_on_id":"br-1bm.1.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.1.3","title":"JWT Parity: HS256 HMAC validation","description":"## Objective\nImplement HS256 JWT validation parity using shared secret.\n\n## Scope\n- Accept `HTTP_JWT_SECRET` for HMAC key.\n- Decode token, validate signature, `aud` (optional), `iss` (optional), and exp/nbf.\n- If validation fails, return 401 Unauthorized.\n\n## Tests\n- Unit tests for valid/invalid signatures, exp/nbf, aud/iss mismatches.\n- Integration tests for Authorization header with Bearer token.\n\n## Logging/Artifacts\n- Store decoded claims (redacted) in test artifacts under `tests/artifacts/http/jwt/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"task","assignee":"CoralDog","created_at":"2026-02-05T05:37:17.486504145Z","created_by":"ubuntu","updated_at":"2026-02-06T12:54:07.983125176Z","closed_at":"2026-02-06T12:54:07.983103666Z","close_reason":"Added missing HS256 negative JWT tests (signature, alg allowlist, exp/nbf, aud/iss, malformed Authorization)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.1.3","depends_on_id":"br-1bm.1","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.1.3","depends_on_id":"br-1bm.1.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}],"comments":[{"id":3,"issue_id":"br-1bm.1.3","author":"Dicklesworthstone","text":"Audit notes (CopperOwl):\n\n- HS256 secret path already appears implemented in `crates/mcp-agent-mail-server/src/lib.rs`:\n  - `jwt_decoding_key()` uses `http_jwt_secret` when JWKS URL is not set.\n  - `jwt_validation()` sets allowed algorithms from `http_jwt_algorithms` (default HS256), leeway=0, validate_nbf=true, validate_aud=false (aud checked only when configured).\n  - `validate_jwt_claims()` enforces exact issuer match when configured and audience match when configured (string or array).\n  - `jsonwebtoken::decode::<serde_json::Value>` should enforce signature + exp/nbf when present.\n\n- Existing unit tests cover the happy-path secret token and basic RBAC/rate-limit integration, but do NOT yet cover negative HS256 cases:\n  - invalid signature\n  - alg not in allowlist\n  - exp expired / nbf in future\n  - aud/iss mismatches when configured\n  - non-Bearer Authorization and malformed header parse\n\nPending: file reservation conflict on `crates/mcp-agent-mail-server/src/lib.rs` (CopperBarn actively editing SSR UI). Ill add these tests once I can get a short window or the reservation is narrowed.","created_at":"2026-02-06T03:02:53Z"}]}
{"id":"br-1bm.1.4","title":"JWT Parity: claim validation + RBAC role extraction","description":"## Objective\nJWT claim validation and RBAC role extraction parity.\n\n## Scope\n- Extract roles from claim `HTTP_JWT_ROLE_CLAIM` (string or list).\n- If no roles, use `HTTP_RBAC_DEFAULT_ROLE`.\n- RBAC enforcement:\n  - readers can access resources; writers required for most tools\n  - `HTTP_RBAC_READONLY_TOOLS` accessible by readers\n  - unknown tool name  require writer\n- Localhost bypass when `HTTP_ALLOW_LOCALHOST_UNAUTHENTICATED` enabled and no forwarded headers.\n\n## Tests\n- Unit tests for role extraction (string, list, missing).\n- Integration tests for RBAC allow/deny outcomes on tools/resources.\n\n## Logging/Artifacts\n- Store RBAC decision traces under `tests/artifacts/http/rbac/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"task","assignee":"CoralDog","created_at":"2026-02-05T05:37:21.209581347Z","created_by":"ubuntu","updated_at":"2026-02-06T13:02:29.188652595Z","closed_at":"2026-02-06T13:02:29.188625935Z","close_reason":"Added JWT role-claim extraction + RBAC parity tests (readonly tools, resources, unknown tool, localhost bypass) with artifacts","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.1.4","depends_on_id":"br-1bm.1","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.1.4","depends_on_id":"br-1bm.1.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.1.4","depends_on_id":"br-1bm.1.3","type":"blocks","created_at":"2026-02-05T05:37:39.080720838Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.1.5","title":"JWT Parity: unit + integration + E2E tests","description":"Build comprehensive JWT parity tests with detailed logging + artifacts.\n\nTest layers:\n- Unit tests:\n  - parsing/validation failures\n  - HS256 success/failure\n  - JWKS success/failure\n  - audience/issuer mismatch\n  - role claim parsing\n- Integration tests:\n  - spin up server with env config\n  - hit representative HTTP endpoints\n- E2E script:\n  - scripted curl/httpx cases\n  - log expected vs actual status/body\n  - store artifacts under `tests/artifacts/jwt/<timestamp>/`\n\n## Acceptance Criteria\n- Vector coverage:\n  - All vectors defined in `br-1bm.1.1` are exercised.\n- Deterministic logs:\n  - E2E output includes a per-case diff on mismatch (expected vs actual JSON).\n  - Artifacts include server logs + client transcripts.\n- Exit behavior:\n  - Script exits non-zero on first mismatch.\n- No secret leakage:\n  - Logs do not print shared secrets or private keys.","status":"closed","priority":1,"issue_type":"task","assignee":"CoralDog","created_at":"2026-02-05T05:37:26.048333340Z","created_by":"ubuntu","updated_at":"2026-02-06T13:17:12.755475908Z","closed_at":"2026-02-06T13:17:12.755453776Z","close_reason":"Added missing JWT unit vectors (malformed header, aud/iss match, JWKS kid/invalid JSON) and new E2E JWT suite with artifacts","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.1.5","depends_on_id":"br-1bm.1","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.1.5","depends_on_id":"br-1bm.1.4","type":"blocks","created_at":"2026-02-05T05:37:41.877811316Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.1.5","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:55.883829187Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.10","title":"HTTP Background Workers Parity: ack TTL + escalation + metrics emit + cleanup","description":"## Objective\nImplement HTTP background workers with exact legacy behavior (startup gating, loop intervals, besteffort error handling).\n\n## Scope\n- Workers: file reservation cleanup, ACK TTL scan + escalation, tool metrics emit, retention/quota report.\n- Startup: spawn only when at least one enable flag is true; store tasks for shutdown cancellation.\n- All worker loops wrapped in try/except; never crash server.\n\n## Tests\n- Unit tests for enable/disable gating.\n- Integration tests for each worker behavior in isolation.\n\n## Logging/Artifacts\n- Capture worker logs under `tests/artifacts/http/workers/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-05T07:32:28.058041886Z","created_by":"ubuntu","updated_at":"2026-02-06T07:44:23.609723363Z","closed_at":"2026-02-06T07:44:23.609704638Z","close_reason":"All 5 subtasks completed (10.1 spec, 10.2 ACK TTL, 10.3 tool metrics, 10.4 cleanup, 10.5 retention, 10.6 tests). Four background workers implemented: cleanup.rs (file reservation cleanup), ack_ttl.rs (ACK TTL scan + escalation), tool_metrics.rs (periodic metrics snapshot), retention.rs (retention/quota reporting). All config-gated, OS-thread based, best-effort error handling. 155 tests pass, clippy clean.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.10","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T07:32:28.058041886Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.10.1","title":"Workers Spec: extract legacy ack TTL + escalation + metrics/cleanup worker semantics","description":"Extract exact legacy Python HTTP background worker behavior into a self-contained spec.\n\nLegacy sources:\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/http.py`:\n  - _startup task creation conditions\n  - _worker_ack_ttl (query + logging + escalation)\n  - _worker_tool_metrics (snapshot + log)\n  - _worker_cleanup (expire stale reservations)\n  - _worker_retention_quota (best-effort reporting)\n- Config defaults in `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/config.py`\n- Tests:\n  - `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_http_workers_and_options.py` (ACK TTL)\n\nMust capture verbatim:\n- Worker enable flags + defaults:\n  - FILE_RESERVATIONS_CLEANUP_ENABLED / INTERVAL\n  - ACK_TTL_ENABLED / ACK_TTL_SECONDS / ACK_TTL_SCAN_INTERVAL_SECONDS\n  - ACK_ESCALATION_* (enabled/mode/claim_ttl/exclusive/holder_name)\n  - TOOL_METRICS_EMIT_ENABLED / INTERVAL\n  - RETENTION_REPORT_ENABLED / INTERVAL + RETENTION_MAX_AGE_DAYS + ignore patterns\n  - QUOTA_ENABLED + quota thresholds (even if best-effort)\n- ACK TTL worker semantics:\n  - SQL query that selects overdue ack-required messages\n  - timezone normalization behavior for SQLite timestamps\n  - rich panel vs plain fallback logging\n  - escalation mode `file_reservation`:\n    - path_pattern format (inbox path for created_ts YYYY/MM)\n    - holder agent resolution/auto-create behavior\n    - DB insert shape + archive artifact write shape\n- Tool metrics emit:\n  - snapshot shape and sorting rules\n- Cleanup worker:\n  - how stale file reservations are found and expired\n\nDeliverables:\n- Add a HTTP Background Workers section to `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md`.\n\n## Acceptance Criteria\n- Spec is complete enough to implement without re-reading Python.\n- Spec includes the exact SQL statements and path_pattern format.\n- Spec includes failure handling expectations (never crash server).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:32:42.715316596Z","created_by":"ubuntu","updated_at":"2026-02-05T07:58:32.321908509Z","closed_at":"2026-02-05T07:58:32.321887118Z","close_reason":"Added HTTP Background Workers spec (ack TTL, escalation, metrics emit, cleanup, retention/quota) to EXISTING_MCP_AGENT_MAIL_STRUCTURE.md","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.10.1","depends_on_id":"br-1bm.10","type":"parent-child","created_at":"2026-02-05T07:32:42.715316596Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.10.2","title":"Workers Impl: ACK TTL scan + escalation (log + file_reservation)","description":"## Objective\nImplement ACK TTL scanning + escalation parity.\n\n## Scope (from spec)\n- Interval: `ACK_TTL_SCAN_INTERVAL_SECONDS` (default 60s).\n- Query unacknowledged `ack_required` messages; compute age vs `ACK_TTL_SECONDS`.\n- Log overdue via rich panel and structlog; fallback plain print.\n- Escalation mode `file_reservation`:\n  - Resolve recipient name; optional holder override `ACK_ESCALATION_CLAIM_HOLDER_NAME`.\n  - Auto-create holder agent if missing; write `profile.json` to archive.\n  - Create file reservation for inbox path pattern `agents/{name}/inbox/{YYYY}/{MM}/*.md`.\n  - Write archive artifact.\n- Besteffort: suppress exceptions; never fail server.\n\n## Tests\n- Unit tests for age calculation + threshold.\n- Integration test for file reservation escalation path.\n\n## Logging/Artifacts\n- Store escalation artifacts under `tests/artifacts/http/ack_ttl/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:32:55.972684006Z","created_by":"ubuntu","updated_at":"2026-02-06T07:37:18.848061985Z","closed_at":"2026-02-06T07:37:18.847992194Z","close_reason":"Implemented ACK TTL scan + escalation worker (ack_ttl.rs). Features: interval-based scanning via list_unacknowledged_messages query, age threshold calculation, structured warning logs matching legacy, file_reservation escalation mode with auto-create ops holder agent, inbox path pattern generation. Added 2 new DB queries (list_unacknowledged_messages, insert_system_agent). Wired into HTTP server start/shutdown. 132 tests pass (74 lib + 58 integration), clippy clean.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.10.2","depends_on_id":"br-1bm.10","type":"parent-child","created_at":"2026-02-05T07:32:55.972684006Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.10.2","depends_on_id":"br-1bm.10.1","type":"blocks","created_at":"2026-02-05T07:33:43.795538585Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.10.3","title":"Workers Impl: tool metrics emit loop (tool_metrics_snapshot logging)","description":"## Objective\nEmit periodic tool metrics snapshots from background worker.\n\n## Scope\n- Interval: `max(5, TOOL_METRICS_EMIT_INTERVAL_SECONDS)`.\n- Snapshot of `TOOL_METRICS` dict sorted by tool name.\n- Each entry includes `name`, `calls`, `errors`, `cluster`, `capabilities`, `complexity`.\n- Log via structlog logger `tool.metrics` with event `tool_metrics_snapshot`.\n\n## Tests\n- Unit tests for snapshot structure and ordering.\n- Integration test with a few tool invocations, then worker emits expected log payload.\n\n## Logging/Artifacts\n- Save emitted snapshots under `tests/artifacts/http/metrics/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T07:33:03.809583907Z","created_by":"ubuntu","updated_at":"2026-02-06T07:45:36.211268618Z","closed_at":"2026-02-06T07:45:36.211178720Z","close_reason":"Implemented tool_metrics.rs background worker. Periodically snapshots TOOL_METRICS counters (calls, errors, cluster, capabilities, complexity) and emits structured log via tracing (matching legacy structlog tool.metrics logger). Config-gated via tool_metrics_emit_enabled. 3 tests (snapshot ordering, JSON serialization, config default). Clippy clean.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.10.3","depends_on_id":"br-1bm.10","type":"parent-child","created_at":"2026-02-05T07:33:03.809583907Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.10.3","depends_on_id":"br-1bm.10.1","type":"blocks","created_at":"2026-02-05T07:33:43.981645329Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.10.4","title":"Workers Impl: file reservations cleanup (expire stale)","description":"## Objective\nBackground worker for file reservation cleanup (expired + stale) parity.\n\n## Scope\n- Interval: `FILE_RESERVATIONS_CLEANUP_INTERVAL_SECONDS`.\n- Phase 1: release expired (`expires_ts < now`).\n- Phase 2: release stale by inactivity heuristics (agent activity, mail activity, git commits, expiry proximity).\n- Write archive artifacts for released reservations.\n- Log via rich panel + structlog `file_reservations_cleanup`.\n\n## Tests\n- Unit tests for stale detection heuristics.\n- Integration tests releasing expired and stale reservations.\n\n## Logging/Artifacts\n- Store cleanup reports under `tests/artifacts/http/file_reservations/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T07:33:10.639336897Z","created_by":"ubuntu","updated_at":"2026-02-06T07:30:30.368792650Z","closed_at":"2026-02-06T07:30:30.368773134Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.10.4","depends_on_id":"br-1bm.10","type":"parent-child","created_at":"2026-02-05T07:33:10.639336897Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.10.4","depends_on_id":"br-1bm.10.1","type":"blocks","created_at":"2026-02-05T07:33:44.068109290Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.10.5","title":"Workers Impl: retention/quota report loop (best-effort)","description":"## Objective\nRetention/quota reporting worker parity (besteffort).\n\n## Scope\n- Enabled when `RETENTION_REPORT_ENABLED` or `QUOTA_ENABLED` is true.\n- Interval: `max(60, RETENTION_REPORT_INTERVAL_SECONDS)`.\n- Walk storage_root, compute old messages, inbox counts, attachment bytes per project.\n- Ignore patterns from `RETENTION_IGNORE_PROJECT_PATTERNS`.\n- Log summary via structlog `maintenance` logger.\n- Emit quota warnings when limits exceeded (`QUOTA_ATTACHMENTS_LIMIT_BYTES`, `QUOTA_INBOX_LIMIT_COUNT`).\n\n## Tests\n- Integration tests with temp storage_root and fake projects.\n- Unit tests for ignore patterns and limit detection.\n\n## Logging/Artifacts\n- Store report JSON under `tests/artifacts/http/retention/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-02-05T07:33:18.880305805Z","created_by":"ubuntu","updated_at":"2026-02-06T07:42:43.275657477Z","closed_at":"2026-02-06T07:42:43.275630867Z","close_reason":"Implemented retention.rs background worker. Walks storage_root per project: computes attachment sizes, inbox counts, checks against quota limits, reports retention-aged messages. Supports ignore patterns (glob prefix matching). Config-gated via retention_report_enabled/quota_enabled. 9 tests (ignore patterns, dir_size, inbox counting, empty/populated cycles, config defaults). Clippy clean.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.10.5","depends_on_id":"br-1bm.10","type":"parent-child","created_at":"2026-02-05T07:33:18.880305805Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.10.5","depends_on_id":"br-1bm.10.1","type":"blocks","created_at":"2026-02-05T07:33:44.158130884Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.10.6","title":"Workers Tests: ACK TTL + metrics emit + cleanup + retention","description":"## Objective\nComprehensive tests for all background workers (ack TTL, metrics emit, cleanup, retention/quota).\n\n## Scope\n- Unit tests for each workers core logic and gating flags.\n- Integration tests running worker loops with deterministic intervals (short sleep) and temp DB/storage.\n- E2E validation via HTTP suite (br-2ei.9.6) where possible.\n\n## Logging/Artifacts\n- Store worker logs and diffs under `tests/artifacts/http/workers/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:33:32.489216204Z","created_by":"ubuntu","updated_at":"2026-02-06T07:49:27.504787024Z","closed_at":"2026-02-06T07:49:27.504763991Z","close_reason":"Completed. 11 worker integration tests + 15 unit tests across all 4 workers.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.10.6","depends_on_id":"br-1bm.10","type":"parent-child","created_at":"2026-02-05T07:33:32.489216204Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.10.6","depends_on_id":"br-1bm.10.2","type":"blocks","created_at":"2026-02-05T07:33:44.244450112Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.10.6","depends_on_id":"br-1bm.10.3","type":"blocks","created_at":"2026-02-05T14:06:38.045327096Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.10.6","depends_on_id":"br-1bm.10.4","type":"blocks","created_at":"2026-02-05T14:06:38.145684595Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.10.6","depends_on_id":"br-1bm.10.5","type":"blocks","created_at":"2026-02-05T14:06:38.232870379Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.2","title":"Redis Rate Limiting Parity (token bucket)","description":"Objective:\nImplement Redis-backed token-bucket rate limiting exactly as legacy Python when HTTP_RATE_LIMIT_BACKEND=redis and HTTP_RATE_LIMIT_ENABLED=true. Must match key format, Lua script semantics, TTL, and fallback behavior.\n\nLegacy Reference Behavior:\n- Enabled when settings.http.rate_limit_enabled.\n- Key format: \"rl:{kind}:{endpoint}:{identity}\".\n- Identity uses request.client.host unless JWT claims sub present (then use \"sub:{sub}\").\n- Lua token bucket (HMGET/HMSET, EXPIRE with ceil(burst/max(rate,0.001))).\n- Burst defaults to max(1, rpm) when configured burst is 0.\n- On Redis failure, fallback to in-memory bucket.\n- HTTP response payloads identical (429 + {\"detail\":\"Rate limit exceeded\"}).\n\nImplementation Considerations:\n- Use asupersync Redis client (no tokio, no external redis crate).\n- Ensure monotonic time source for token math.\n- Memory buckets cleanup identical to Python (evict after 1h idle).\n\nTests and E2E (with detailed logging):\n- Vector/spec extraction: `br-1bm.2.1`\n- Implementation: `br-1bm.2.2`..`br-1bm.2.4`\n- Tests: `br-1bm.2.5` (uses shared harness `br-2ei.9.1`)\n\n## Acceptance Criteria\n- Redis backend decisions match Python for identical sequences (vectors from `br-1bm.2.1`).\n- Fallback-to-memory path is correct and observable via logs (without changing HTTP outputs).\n- `br-1bm.2.5` unit+integration+E2E suite passes with high-signal artifacts on failure.","status":"closed","priority":1,"issue_type":"task","assignee":"CoralDog","created_at":"2026-02-05T05:32:59.767161877Z","created_by":"ubuntu","updated_at":"2026-02-06T14:30:33.446826568Z","closed_at":"2026-02-06T14:30:33.446797994Z","close_reason":"All rate-limit parity sub-beads closed (2.1-2.5); Redis+memory behavior matches legacy with high-signal tests","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.2","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2","depends_on_id":"br-1bm.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2","depends_on_id":"br-1bm.3","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.2.1","title":"Rate Limit Parity: extract legacy Lua + vectors","description":"Purpose:\nExtract exact legacy Redis token-bucket behavior and test vectors for parity.\n\nLegacy Lua Script (verbatim):\nlocal key = KEYS[1]\nlocal now = tonumber(ARGV[1])\nlocal rate = tonumber(ARGV[2])\nlocal burst = tonumber(ARGV[3])\nlocal state = redis.call('HMGET', key, 'tokens', 'ts')\nlocal tokens = tonumber(state[1]) or burst\nlocal ts = tonumber(state[2]) or now\nlocal delta = now - ts\ntokens = math.min(burst, tokens + delta * rate)\nlocal allowed = 0\nif tokens >= 1 then\n  tokens = tokens - 1\n  allowed = 1\nend\nredis.call('HMSET', key, 'tokens', tokens, 'ts', now)\nredis.call('EXPIRE', key, math.ceil(burst / math.max(rate, 0.001)))\nreturn allowed\n\nCall pattern:\n- EVAL lua 1 \"rl:{key}\" now rate_per_sec burst\n- allowed = bool(int(result or 0) == 1)\n\nIn-memory fallback:\n- tokens, ts = buckets.get(key, (burst, now))\n- elapsed = max(0, now - ts)\n- tokens = min(burst, tokens + elapsed * rate)\n- if tokens < 1 -> deny, else tokens -= 1 -> allow\n- cleanup buckets idle > 3600s\n\nTest Vectors (examples to codify):\n1) per_minute<=0 -> allow always (no Redis call)\n2) burst default = max(1, rpm) when configured burst == 0\n3) First request at t0 with tokens missing -> tokens=burst -> allow, new tokens=burst-1\n4) Subsequent request before 1/rate sec -> deny if tokens <1\n5) After sufficient elapsed, tokens replenished to min(burst, tokens + elapsed*rate)\n6) Redis failure (exception) -> fallback to memory bucket and still enforce limits\n7) TTL calculation: EXPIRE = ceil(burst / max(rate, 0.001))\n\nDeliverable:\n- Matrix of (rpm, burst, time sequence, expected allow/deny, expected TTL)\n- Explicit Redis key format: \"rl:{kind}:{endpoint}:{identity}\"","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:38:01.226828600Z","created_by":"ubuntu","updated_at":"2026-02-05T07:38:06.586289822Z","closed_at":"2026-02-05T07:38:06.586222836Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.2.1","depends_on_id":"br-1bm.2","type":"parent-child","created_at":"2026-02-05T05:38:01.226828600Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.2.2","title":"Rate Limit Parity: Redis Lua implementation","description":"## Objective\nImplement Redis token-bucket rate limiting parity using Lua script.\n\n## Scope\n- Lua script matches legacy:\n  - HMGET tokens/ts\n  - tokens refill by `delta * rate`\n  - consume 1 token if available\n  - HMSET tokens/ts and EXPIRE by `ceil(burst / max(rate, 0.001))`\n- Perendpoint key format: `rl:{kind}:{endpoint}:{identity}`.\n- Fallback to inmemory on Redis errors.\n\n## Tests\n- Unit tests for Lua script behavior (via embedded Redis or mocked eval).\n- Integration test with Redis backend enabled; verify allow/deny at limits.\n\n## Logging/Artifacts\n- Store rate limit traces under `tests/artifacts/http/rate_limit/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"task","assignee":"CoralDog","created_at":"2026-02-05T05:38:06.336149143Z","created_by":"ubuntu","updated_at":"2026-02-06T13:59:09.683253444Z","closed_at":"2026-02-06T13:59:09.683231473Z","close_reason":"Implemented Redis-backed token bucket via asupersync RedisClient + legacy Lua EVAL; added fallback tests and optional Redis integration test","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.2.2","depends_on_id":"br-1bm.2","type":"parent-child","created_at":"2026-02-05T05:38:06.336149143Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2.2","depends_on_id":"br-1bm.2.1","type":"blocks","created_at":"2026-02-05T05:38:25.448726996Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.2.3","title":"Rate Limit Parity: identity derivation (host/sub)","description":"## Objective\nImplement legacy identity derivation for rate limiting keys.\n\n## Scope\n- Default identity: `request.client.host` (or `ip-unknown`).\n- If JWT claims present, prefer `sub` for stability (`identity = \"sub:<sub>\"`).\n- Endpoint key: tool name if tools call, `*` otherwise.\n- Key format: `{kind}:{endpoint}:{identity}` where kind  {tools,resources,other}.\n\n## Tests\n- Unit tests for key derivation with/without JWT claims.\n- Integration tests ensure pertool rate limit separation.\n\n## Logging/Artifacts\n- Store derived keys under `tests/artifacts/http/rate_limit/<timestamp>/` on mismatch.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:38:11.555148799Z","created_by":"ubuntu","updated_at":"2026-02-06T14:11:02.669392428Z","closed_at":"2026-02-06T14:11:02.669370637Z","close_reason":"Implemented rate limit identity/key derivation parity (host/sub + endpoint/kind) with unit tests","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.2.3","depends_on_id":"br-1bm.1","type":"blocks","created_at":"2026-02-05T05:38:28.472191315Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2.3","depends_on_id":"br-1bm.2","type":"parent-child","created_at":"2026-02-05T05:38:11.555148799Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2.3","depends_on_id":"br-1bm.3","type":"blocks","created_at":"2026-02-05T05:38:31.440415087Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.2.4","title":"Rate Limit Parity: memory fallback + cleanup","description":"## Objective\nImplement inmemory token bucket fallback + cleanup parity.\n\n## Scope\n- Token bucket: refill by `elapsed * rate_per_sec`, cap at burst.\n- Deny when tokens < 1; decrement when allowed.\n- Cleanup: every 60s, evict buckets not touched in last hour.\n- If Redis backend fails, fall back to memory without failing requests.\n\n## Tests\n- Unit tests for token refill/consume math and cleanup eviction.\n- Integration test: Redis failure path uses memory.\n\n## Logging/Artifacts\n- Store bucket state traces under `tests/artifacts/http/rate_limit/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"task","assignee":"CoralDog","created_at":"2026-02-05T05:38:15.478842333Z","created_by":"ubuntu","updated_at":"2026-02-06T14:11:02.474488328Z","closed_at":"2026-02-06T14:11:02.474464373Z","close_reason":"Implemented in-memory token bucket fallback + cleanup parity (unit tests in server)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.2.4","depends_on_id":"br-1bm.2","type":"parent-child","created_at":"2026-02-05T05:38:15.478842333Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2.4","depends_on_id":"br-1bm.2.1","type":"blocks","created_at":"2026-02-05T05:38:36.248864408Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.2.5","title":"Rate Limit Parity: unit + integration + E2E tests","description":"Comprehensive tests for rate limiting parity, with detailed logging + artifacts.\n\nTest layers:\n- Unit tests:\n  - key format\n  - burst/rate defaults\n  - deterministic token math\n  - TTL calculation\n  - in-memory cleanup\n  - identity derivation fuzz vectors (table-driven):\n    - sub present vs missing\n    - host present vs missing\n    - IPv4 / IPv6 / IPv4-mapped IPv6\n    - localhost vs non-localhost\n    - forwarded headers present/absent\n    - malformed inputs (empty, whitespace, invalid IP)\n    - expected stable key formatting\n- Integration tests:\n  - Redis-backed allow/deny sequences using vectors from `br-1bm.2.1`\n  - fallback path when Redis is unavailable\n  - identity derivation integration: request matrix verifying key selection and limiter behavior\n- E2E script:\n  - run request bursts against HTTP server\n  - log expected vs actual allow/deny decisions\n  - capture Redis state snapshots (best effort)\n  - store artifacts under `tests/artifacts/rate_limit/<timestamp>/`\n  - include identity fuzz matrix and per-case decision traces\n\n## Acceptance Criteria\n- Unit tests validate both Redis and fallback implementations against the same vector suite.\n- Identity derivation fuzz vectors cover IPv4/IPv6/localhost/forwarded header cases with explicit expected keys.\n- Integration tests are deterministic (fixed timestamps/time mocking as needed).\n- E2E script:\n  - prints per-request decision trace\n  - writes a summary JSON (pass/fail + diffs)\n  - exits non-zero on mismatch\n- Failures include enough context to debug (identity, key, tokens, ttl).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:38:19.738397651Z","created_by":"ubuntu","updated_at":"2026-02-06T14:30:33.348794095Z","closed_at":"2026-02-06T14:30:33.348759410Z","close_reason":"Added comprehensive rate-limit unit/integration vectors + Redis TTL check + E2E suite; fixed IPv6 ::1 identity handling","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.2.5","depends_on_id":"br-1bm.2","type":"parent-child","created_at":"2026-02-05T05:38:19.738397651Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2.5","depends_on_id":"br-1bm.2.2","type":"blocks","created_at":"2026-02-05T05:38:39.208248679Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2.5","depends_on_id":"br-1bm.2.3","type":"blocks","created_at":"2026-02-05T05:38:44.191099431Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2.5","depends_on_id":"br-1bm.2.4","type":"blocks","created_at":"2026-02-05T05:38:47.255125276Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2.5","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:55.976511422Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.3","title":"Client Peer Address + Localhost Bypass Parity","description":"Objective:\nAccurately detect client host/peer address for localhost bypass, RBAC, and rate limiting identity. Must match legacy Python logic, including IPv4-mapped IPv6 handling and forwarded-header safeguards.\n\nLegacy Reference Behavior:\n- Determine client_host from request.client.host\n- If forwarded headers present (x-forwarded-for/proto/host or forwarded), treat as non-local\n- Localhost if client_host in {\"127.0.0.1\",\"::1\",\"localhost\"} or IPv4-mapped ::ffff:127.0.0.1\n- When localhost allowed and bearer token set, auto-inject Authorization in base path passthrough\n\nImplementation Plan:\n1. Integrate peer_addr from asupersync Http1Request (blocked on upstream `br-2ei.6.3`).\n2. Add helper to normalize peer_addr to client_host string (supports IPv4-mapped IPv6).\n3. Update allow_local_unauthenticated checks to use peer_addr + forwarded headers.\n4. Use client_host for rate-limit identity when JWT sub absent.\n\nTests and E2E (with detailed logging):\n- Unit tests for address parsing + forwarded header behavior.\n- Integration tests with simulated Http1Request peer_addr.\n- E2E coverage via `br-1bm.3.4` (uses shared harness `br-2ei.9.1`).\n\n## Acceptance Criteria\n- Localhost bypass behavior matches legacy Python for all address forms and forwarded-header cases.\n- Rate-limit identity uses peer_addr-derived host when JWT sub is missing.\n- `br-1bm.3.4` unit+integration+E2E suite passes and produces high-signal artifacts on failure.","status":"closed","priority":1,"issue_type":"task","assignee":"ubuntu","created_at":"2026-02-05T05:33:10.708760957Z","created_by":"ubuntu","updated_at":"2026-02-06T06:27:15.701691981Z","closed_at":"2026-02-06T06:27:15.701664970Z","close_reason":"completed - already implemented: peer_addr, localhost detection, forwarded headers, rate-limit identity, tests","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.3","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}],"comments":[{"id":2,"issue_id":"br-1bm.3","author":"Dicklesworthstone","text":"Integrated peer_addr (asupersync), localhost helper + rate-limit identity, and added unit/integration tests. E2E still pending in br-1bm.3.4 (blocked by br-2ei.9.1).","created_at":"2026-02-05T08:38:52Z"}]}
{"id":"br-1bm.3.1","title":"Peer Addr Parity: integrate asupersync Http1Request.peer_addr","description":"Integrate `peer_addr` from `asupersync::Http1Request` into server logic.\n\nThis task is blocked on upstream asupersync work tracked as `br-2ei.6.3`.\n\nWork:\n- Once `Http1Request.peer_addr` is available, plumb it through the HTTP server request handling.\n- Expose a helper to derive a stable `client_host` string from peer_addr (legacy-equivalent formatting).\n- Ensure forwarded headers do not override peer_addr.\n\n## Acceptance Criteria\n- Server has access to peer_addr for each request and uses it consistently for:\n  - localhost bypass decisions\n  - rate-limit identity (when JWT sub absent)\n- `client_host` formatting matches legacy for:\n  - IPv4\n  - IPv6\n  - IPv4-mapped IPv6\n- Tests:\n  - Unit tests validate formatting and forwarded headers do not override peer_addr.\n  - Integration tests validate peer_addr is populated in the request path (using simulated Http1Request / test harness).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:39:05.220643258Z","created_by":"ubuntu","updated_at":"2026-02-05T08:38:05.917468187Z","closed_at":"2026-02-05T08:38:05.917450805Z","close_reason":"Integrated peer_addr from asupersync and wired into server logic","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.3.1","depends_on_id":"br-1bm.3","type":"parent-child","created_at":"2026-02-05T05:39:05.220643258Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.3.1","depends_on_id":"br-2ei.6.3","type":"blocks","created_at":"2026-02-05T06:08:07.059047396Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.3.2","title":"Peer Addr Parity: localhost detection helper","description":"Implement localhost detection helper for peer_addr-based bypass logic.\n\nRequirements:\n- Handle IPv4, IPv6, and IPv4-mapped IPv6 localhost forms.\n- Treat forwarded headers as disqualifying for localhost bypass (no spoofing).\n- Use this helper consistently in bearer auth, RBAC decisions, and any other localhost-only paths.\n\n## Acceptance Criteria\n- Correct detection:\n  - `127.0.0.1`, `::1`, and IPv4-mapped `::ffff:127.0.0.1` are treated as localhost.\n  - Non-localhost private IPs are *not* treated as localhost.\n- Forwarded headers:\n  - Presence of `X-Forwarded-For`/`Forwarded` (per legacy) disables localhost bypass.\n- Tests:\n  - Unit tests cover all address forms and forwarded-header cases.\n  - Integration test verifies bypass behavior is controlled exclusively by peer_addr + forwarded headers (not client-provided host headers).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:39:09.028452900Z","created_by":"ubuntu","updated_at":"2026-02-05T08:38:09.584845027Z","closed_at":"2026-02-05T08:38:09.584827845Z","close_reason":"Added peer_addr localhost helper + forwarded header safeguards + tests","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.3.2","depends_on_id":"br-1bm.3","type":"parent-child","created_at":"2026-02-05T05:39:09.028452900Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.3.2","depends_on_id":"br-1bm.3.1","type":"blocks","created_at":"2026-02-05T05:39:26.736664544Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.3.3","title":"Peer Addr Parity: rate-limit identity plumbing","description":"Implement rate-limit identity plumbing for peer_addr-derived host.\n\nRule:\n- Use JWT `sub` as the default rate-limit identity when present.\n- Otherwise, use `client_host` derived from peer_addr.\n- Identity string must match legacy formatting and be used consistently for rate limiter key creation.\n\n## Acceptance Criteria\n- Identity derivation matches legacy precedence and formatting.\n- Forwarded headers do not affect identity (peer_addr only).\n- Tests:\n  - Unit tests cover precedence (JWT sub vs peer_addr) and formatting.\n  - Integration test asserts Redis key prefix + identity combine exactly as legacy expects.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:39:12.867654737Z","created_by":"ubuntu","updated_at":"2026-02-05T08:38:13.146794229Z","closed_at":"2026-02-05T08:38:13.146772948Z","close_reason":"Rate-limit identity now uses peer_addr; helper covers JWT sub precedence","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.3.3","depends_on_id":"br-1bm.3","type":"parent-child","created_at":"2026-02-05T05:39:12.867654737Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.3.3","depends_on_id":"br-1bm.3.1","type":"blocks","created_at":"2026-02-05T05:39:30.103821388Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.3.4","title":"Peer Addr Parity: unit + integration + E2E tests","description":"Add comprehensive tests for peer_addr + localhost bypass logic, with detailed logging + artifacts.\n\nTest layers:\n- Unit tests:\n  - host parsing/formatting\n  - localhost detection (IPv4/IPv6/mapped)\n  - forwarded-header disqualification\n- Integration tests:\n  - simulate Http1Request peer_addr values through server request path\n  - validate identity derivation used by rate limiter\n- E2E script:\n  - start server\n  - send requests with/without Authorization\n  - include forwarded header cases\n  - log expected vs actual outcomes and store artifacts under `tests/artifacts/peer_addr/<timestamp>/`\n\n## Acceptance Criteria\n- Unit tests cover all address forms + forwarded-header cases.\n- Integration tests prove peer_addr is used and forwarded headers cannot spoof it.\n- E2E script writes:\n  - HTTP transcripts\n  - server logs\n  - summary JSON (pass/fail + diffs)\n- Failures provide actionable diffs (which header/value differed).","status":"closed","priority":1,"issue_type":"task","assignee":"RusticOtter","created_at":"2026-02-05T05:39:17.375993949Z","created_by":"ubuntu","updated_at":"2026-02-06T00:11:53.064799444Z","closed_at":"2026-02-06T00:11:53.064773245Z","close_reason":"Added peer_addr E2E suite + fixed asupersync HTTP/1 flush so responses are sent","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.3.4","depends_on_id":"br-1bm.3","type":"parent-child","created_at":"2026-02-05T05:39:17.375993949Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.3.4","depends_on_id":"br-1bm.3.2","type":"blocks","created_at":"2026-02-05T05:39:34.102447983Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.3.4","depends_on_id":"br-1bm.3.3","type":"blocks","created_at":"2026-02-05T05:39:37.109851077Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.3.4","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:56.060674456Z","created_by":"ubuntu","metadata":"{}","thread_id":""}],"comments":[{"id":1,"issue_id":"br-1bm.3.4","author":"Dicklesworthstone","text":"Added unit/integration tests in mcp-agent-mail-server (peer_addr localhost + forwarded header + rate-limit identity). E2E script still blocked on br-2ei.9.1 harness.","created_at":"2026-02-05T08:38:33Z"}]}
{"id":"br-1bm.4","title":"Stateless Streamable HTTP MCP Parity","description":"Objective:\nReproduce legacy Python stateless Streamable HTTP behavior for MCP requests, including header normalization, base path mount semantics, passthrough route, and localhost Authorization injection. Must be wire-compatible for existing MCP clients.\n\nLegacy Reference Behavior:\n- Per-request StreamableHTTPServerTransport, stateless=True\n- Accept header forced to \"application/json, text/event-stream\"\n- Content-Type added for POST if missing\n- Base path mounted at both /base and /base/ (no redirect)\n- Direct POST handler at base path that forwards to mounted app\n- If localhost + allow_localhost_unauthenticated + bearer token set, inject Authorization if missing\n- Responses passed through without extra wrapping\n\nImplementation Considerations:\n- Use fastmcp_rust transport primitives (no tokio)\n- Preserve request/response JSON-RPC payloads exactly\n- Avoid breaking SSE/streaming semantics\n\nTests and E2E (with detailed logging):\n- Spec + fixtures: `br-1bm.4.1`\n- Implementation: `br-1bm.4.2`..`br-1bm.4.5`\n- Tests: `br-1bm.4.6` (uses shared harness `br-2ei.9.1`)\n\nDependencies:\n- peer address parity (`br-1bm.3`) for localhost detection.\n\n## Acceptance Criteria\n- Wire behavior matches legacy Python for all fixture cases from `br-1bm.4.1`.\n- Streaming responses remain incremental (not buffered) and have correct headers.\n- `br-1bm.4.6` unit+integration+E2E suite passes with high-signal artifacts on failure.","status":"closed","priority":1,"issue_type":"task","assignee":"CoralDog","created_at":"2026-02-05T05:33:19.242331091Z","created_by":"ubuntu","updated_at":"2026-02-06T16:34:35.956846753Z","closed_at":"2026-02-06T16:34:35.956818370Z","close_reason":"Completed streamable HTTP stateless parity (header normalization, /api passthrough + localhost auth injection) + unit/integration tests in crates/mcp-agent-mail-server/src/lib.rs and E2E suite tests/e2e/test_http_streamable.sh","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.4","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4","depends_on_id":"br-1bm.3","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.4.1","title":"Streamable HTTP Parity: extract legacy behaviors + fixtures","description":"Purpose:\nExtract exact legacy HTTP streamable behaviors and define fixture cases for parity.\n\nLegacy Behavior (from http.py):\n- Mount base:\n  - mount_base = settings.http.path or \"/api\"\n  - if not startswith(\"/\"): prefix \"/\"\n  - base_no_slash = mount_base.rstrip(\"/\") or \"/\"\n  - base_with_slash = base_no_slash if \"/\" else base_no_slash + \"/\"\n  - fastapi_app.mount(base_no_slash, stateless_app)\n  - fastapi_app.mount(base_with_slash, stateless_app)\n- Direct POST handler at base_no_slash:\n  - Forwards to stateless_app with path=base_with_slash\n  - Collects response status/headers/body by intercepting send()\n  - Parses body as JSON (empty => {})\n- Header normalization:\n  - Remove any existing Accept headers\n  - Add Accept: \"application/json, text/event-stream\"\n  - If POST and Content-Type missing, add Content-Type: \"application/json\"\n- Localhost Authorization injection in passthrough:\n  - If allow_localhost_unauthenticated and client_host in {127.0.0.1, ::1, localhost} and no Authorization header, inject Bearer token when configured\n\nFixture Cases (minimum):\n1) Request to /api and /api/ both route to stateless app (no redirect)\n2) POST /api with missing Accept -> Accept forced to \"application/json, text/event-stream\"\n3) POST /api with existing Accept -> replaced (single header) with forced value\n4) POST /api missing Content-Type -> set to application/json\n5) POST /api with Content-Type present -> preserved\n6) Direct POST handler returns exact status/body from stateless app\n7) Localhost injection adds Authorization when missing (only if allow_localhost_unauthenticated + bearer token)\n8) Forwarded headers present -> no localhost injection\n\nDeliverable:\n- Written fixture table (inputs -> expected headers + status + body)\n- Use as baseline for br-1bm.4.* implementation/tests","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:39:51.705065959Z","created_by":"ubuntu","updated_at":"2026-02-05T07:38:24.514040016Z","closed_at":"2026-02-05T07:38:24.513965806Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.4.1","depends_on_id":"br-1bm.4","type":"parent-child","created_at":"2026-02-05T05:39:51.705065959Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.4.2","title":"Streamable HTTP Parity: header normalization","description":"## Objective\nNormalize headers for streamable HTTP requests to match legacy FastAPI adapter behavior.\n\n## Scope\n- Ensure `Accept: application/json, text/event-stream` is present (replace any existing Accept).\n- Ensure `Content-Type: application/json` is present for POST when missing.\n- Preserve other headers unmodified.\n\n## Tests\n- Unit tests for header normalization logic.\n- Integration tests via HTTP client lacking Accept header (httpx default).\n\n## Logging/Artifacts\n- Capture request/response headers under `tests/artifacts/http/streamable/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:39:57.051364879Z","created_by":"ubuntu","updated_at":"2026-02-06T06:34:56.126701624Z","closed_at":"2026-02-06T06:34:56.126618529Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.4.2","depends_on_id":"br-1bm.4","type":"parent-child","created_at":"2026-02-05T05:39:57.051364879Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.2","depends_on_id":"br-1bm.4.1","type":"blocks","created_at":"2026-02-05T05:40:24.386470843Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.4.3","title":"Streamable HTTP Parity: base path mount + passthrough","description":"## Objective\nMount streamable HTTP transport at base path with passthrough semantics.\n\n## Scope\n- Mount stateless ASGI app at both `base_no_slash` and `base_with_slash`.\n- Ensure requests under base path are handled by streamable transport without extra wrappers.\n- For unmatched paths, return 404 JSON.\n\n## Tests\n- Integration tests for both `/api` and `/api/` base paths.\n- Verify requests are routed to MCP transport and non-base paths return 404.\n\n## Logging/Artifacts\n- Store routing traces under `tests/artifacts/http/streamable/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:40:00.975157750Z","created_by":"ubuntu","updated_at":"2026-02-06T06:38:28.025662325Z","closed_at":"2026-02-06T06:38:28.025579430Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.4.3","depends_on_id":"br-1bm.4","type":"parent-child","created_at":"2026-02-05T05:40:00.975157750Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.3","depends_on_id":"br-1bm.4.1","type":"blocks","created_at":"2026-02-05T05:40:27.257455205Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.4.4","title":"Streamable HTTP Parity: localhost auth injection","description":"## Objective\nLocalhost auth bypass behavior parity for streamable HTTP.\n\n## Scope\n- When `HTTP_ALLOW_LOCALHOST_UNAUTHENTICATED=true`, allow localhost requests **without Authorization**, unless forwarded headers are present.\n- Supported localhost checks: `127.0.0.1`, `::1`, `localhost`, IPv4mapped IPv6 (`::ffff:127.0.0.1`).\n- If forwarded headers exist, do **not** bypass.\n\n## Tests\n- Unit tests for localhost detection + forwarded header suppression.\n- Integration tests for localhost requests with/without Authorization.\n\n## Logging/Artifacts\n- Capture auth decisions under `tests/artifacts/http/auth/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"task","assignee":"CoralDog","created_at":"2026-02-05T05:40:05.682494755Z","created_by":"ubuntu","updated_at":"2026-02-06T16:02:03.196427556Z","closed_at":"2026-02-06T16:02:03.196408481Z","close_reason":"Implemented localhost Authorization injection + base_no_slash passthrough path rewrite; added unit + HTTP roundtrip tests; cargo fmt/clippy/test pass","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.4.4","depends_on_id":"br-1bm.3","type":"blocks","created_at":"2026-02-05T05:40:38.923281128Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.4","depends_on_id":"br-1bm.4","type":"parent-child","created_at":"2026-02-05T05:40:05.682494755Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.4","depends_on_id":"br-1bm.4.1","type":"blocks","created_at":"2026-02-05T05:40:35.525843824Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.4.5","title":"Streamable HTTP Parity: stateless transport pass-through","description":"## Objective\nImplement stateless StreamableHTTP transport passthrough with no response wrapping.\n\n## Scope\n- Perrequest `StreamableHTTPServerTransport` with `stateless=true` and `json_response` enabled.\n- Run MCP server with `create_initialization_options()` and no session ID.\n- Pass MCP responses through as-is; no JSON unwrap/rewrap.\n- Suppress noisy streamable HTTP logs (set to WARNING).\n\n## Tests\n- Integration tests for JSON-RPC request/response roundtrip.\n- Ensure SSE responses work for streaming paths.\n\n## Logging/Artifacts\n- Save request/response transcripts under `tests/artifacts/http/streamable/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"task","assignee":"CoralDog","created_at":"2026-02-05T05:40:10.252618982Z","created_by":"ubuntu","updated_at":"2026-02-06T16:02:03.197669942Z","closed_at":"2026-02-06T16:02:03.197649794Z","close_reason":"Implemented localhost Authorization injection + base_no_slash passthrough path rewrite; added unit + HTTP roundtrip tests; cargo fmt/clippy/test pass","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.4.5","depends_on_id":"br-1bm.4","type":"parent-child","created_at":"2026-02-05T05:40:10.252618982Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.5","depends_on_id":"br-1bm.4.1","type":"blocks","created_at":"2026-02-05T05:40:32.362475538Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.4.6","title":"Streamable HTTP Parity: unit + integration + E2E tests","description":"Comprehensive tests for streamable HTTP parity, with detailed logging + artifacts.\n\nTest layers:\n- Unit tests:\n  - header normalization\n  - base path normalization\n  - Authorization injection logic\n- Integration tests:\n  - `/api` and `/api/` parity\n  - passthrough correctness (status/headers/body)\n- E2E script:\n  - cover missing headers\n  - cover localhost auth injection\n  - cover streaming response sanity\n  - log expected vs actual results and store artifacts under `tests/artifacts/http_streamable/<timestamp>/`\n\n## Acceptance Criteria\n- Tests are driven by fixtures/spec from `br-1bm.4.1` where possible.\n- E2E script captures:\n  - full HTTP transcript (request + response)\n  - server logs\n  - a summary JSON with pass/fail + diffs\n- Streaming test asserts incremental delivery (multiple chunks observed).\n- Tests run reliably on dev machine with clear diagnostics on failure.","status":"closed","priority":1,"issue_type":"task","assignee":"CoralDog","created_at":"2026-02-05T05:40:16.185638720Z","created_by":"ubuntu","updated_at":"2026-02-06T16:34:24.289304998Z","closed_at":"2026-02-06T16:34:24.289278359Z","close_reason":"Added http_streamable E2E suite (tests/e2e/test_http_streamable.sh) + verified locally (AM_E2E_KEEP_TMP=1); unit+integration tests already in mcp-agent-mail-server; artifacts under tests/artifacts/http_streamable","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.4.6","depends_on_id":"br-1bm.4","type":"parent-child","created_at":"2026-02-05T05:40:16.185638720Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.6","depends_on_id":"br-1bm.4.2","type":"blocks","created_at":"2026-02-05T05:40:43.603009717Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.6","depends_on_id":"br-1bm.4.3","type":"blocks","created_at":"2026-02-05T05:40:47.563411188Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.6","depends_on_id":"br-1bm.4.4","type":"blocks","created_at":"2026-02-05T05:40:51.243017744Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.6","depends_on_id":"br-1bm.4.5","type":"blocks","created_at":"2026-02-05T05:40:56.025356571Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.6","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:56.145694434Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.5","title":"Mail SSR UI Parity (/mail/*)","description":"Objective:\nImplement the legacy Python SSR Mail UI endpoints under `/mail/*` with identical behavior and output expectations. This includes templates, markdown rendering, sanitization, and static assets. Must be safe and stable for human overseer usage.\n\nLegacy Reference Behavior:\n- `/mail` and `/mail/*` routes render HTML using Jinja templates\n- Markdown rendering via markdown2; sanitization via bleach + optional CSS sanitizer\n- Supports inbox list, thread view, compose, human overseer actions\n- Static assets served from legacy web/ and templates/ directories\n\nImplementation Considerations:\n- Preserve HTML structure and CSS class names to keep UI stable.\n- Sanitization allowlist must match legacy (or be stricter only if it doesnt break expected markup).\n- Cache headers should match legacy defaults for static assets.\n\nTests and E2E (with detailed logging):\n- Inventory/spec: `br-1bm.5.1`\n- Implementation: `br-1bm.5.2`..`br-1bm.5.4`\n- Tests: `br-1bm.5.5` (uses shared harness `br-2ei.9.1`)\n\n## Acceptance Criteria\n- `/mail` routes and rendered HTML structure match legacy for representative fixtures.\n- Sanitization prevents XSS while preserving expected formatting.\n- Static assets are served with correct content-type + caching headers.\n- `br-1bm.5.5` unit+integration+E2E suite passes with high-signal artifacts on failure.","notes":"Started implementation: added GET /mail/api/locks returning storage lock diagnostics via mcp_agent_mail_storage::collect_lock_status; added unit test (mcp-agent-mail-server) mail_api_locks_returns_json. Next: SSR HTML routes + template rendering + markdown/sanitization + static assets.","status":"closed","priority":1,"issue_type":"task","assignee":"CopperBarn","created_at":"2026-02-05T05:33:28.128698742Z","created_by":"ubuntu","updated_at":"2026-02-06T07:30:52.804943360Z","closed_at":"2026-02-06T07:30:52.804912081Z","close_reason":"All subtasks completed (5.1-5.5). Mail SSR UI fully implemented: 7 route handlers (index, project, thread, compose, search, human overseer, message), Jinja2 templates via minijinja, markdownHTML via comrak+ammonia matching legacy bleach, static file serving with SPA fallback and path traversal protection, 129 tests (71 lib + 58 integration) all passing, clippy clean.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.5","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.5.1","title":"Mail UI Parity: inventory routes/templates/assets","description":"Purpose:\nInventory all legacy /mail UI routes, templates, and static assets to define the exact UI surface for the Rust port.\n\nLegacy Route Map (from http.py):\n- GET  /mail/api/locks (JSON)\n- GET  /mail (HTML)\n- GET  /mail/api/unified-inbox (JSON)\n- GET  /mail/projects (HTML)\n- GET  /mail/{project} (HTML)\n- POST /mail/api/projects/{project_id}/siblings/{other_id} (JSON)\n- GET  /mail/unified-inbox (HTML)\n- GET  /mail/{project}/inbox/{agent} (HTML)\n- GET  /mail/{project}/message/{mid} (HTML)\n- POST /mail/{project}/inbox/{agent}/mark-read (form)\n- POST /mail/{project}/inbox/{agent}/mark-all-read (form)\n- GET  /mail/{project}/thread/{thread_id} (HTML)\n- GET  /mail/{project}/search (HTML)\n- GET  /mail/{project}/file_reservations (HTML)\n- GET  /mail/{project}/attachments (HTML)\n- GET  /mail/{project}/overseer/compose (HTML)\n- POST /mail/{project}/overseer/send (form)\n- GET  /mail/archive/guide (HTML)\n- GET  /mail/archive/activity (HTML)\n- GET  /mail/archive/commit/{sha} (HTML)\n- GET  /mail/archive/timeline (HTML)\n- GET  /mail/archive/browser (HTML)\n- GET  /mail/archive/browser/{project}/file (HTML)\n- GET  /mail/archive/network (HTML)\n- GET  /mail/api/projects/{project}/agents (JSON)\n- GET  /mail/archive/time-travel (HTML)\n- GET  /mail/archive/time-travel/snapshot (HTML)\n\nTemplates & Assets:\n- templates root: mcp_agent_mail/templates (Jinja2)\n- sanitizer: bleach + optional CSSSanitizer (allowed tags/attrs list in http.py)\n- static SPA: /web directory (if exists) mounted at \"/\" via StaticFiles\n- CSS/JS asset paths referenced in templates (must be preserved)\n\nAdditional Notes:\n- UI is optional: failure to load templates should not crash server\n- /web SPA fallback uses index.html for non-API 404s\n\nDeliverable:\n- Template list (filenames)\n- Asset manifest (CSS/JS/images) with paths\n- Route-to-template mapping","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:41:11.443448819Z","created_by":"ubuntu","updated_at":"2026-02-05T07:39:20.258580675Z","closed_at":"2026-02-05T07:39:20.258519770Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.5.1","depends_on_id":"br-1bm.5","type":"parent-child","created_at":"2026-02-05T05:41:11.443448819Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.5.2","title":"Mail UI Parity: markdown rendering + sanitization","description":"## Objective\nParity for markdown rendering + sanitization in mail UI and share viewer.\n\n## Scope\n- Serverside markdown render for message bodies using markdown2 extras (fenced code, tables, strike, lists).\n- HTML sanitization with bleach (CSS sanitizer enabled; safe images/links only).\n- Clientside rendering fallbacks via marked.js + DOMPurify for UI previews.\n\n## Tests\n- Unit tests for markdown  HTML conversion and sanitizer allowlist.\n- Integration tests rendering sample messages with code blocks, tables, links, images, and unsafe HTML.\n\n## Logging/Artifacts\n- Store rendered HTML snapshots under `tests/artifacts/ui/markdown/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:41:15.456034900Z","created_by":"ubuntu","updated_at":"2026-02-06T07:15:43.932542201Z","closed_at":"2026-02-06T07:15:43.932518476Z","close_reason":"markdown.rs: comrak GFM rendering (fenced code, tables, strikethrough, lists) + ammonia HTML sanitization matching legacy bleach allowlists. 30+ tests covering rendering, sanitization, XSS prevention. Client-side marked.js+DOMPurify in embedded templates.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.5.2","depends_on_id":"br-1bm.5","type":"parent-child","created_at":"2026-02-05T05:41:15.456034900Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.5.2","depends_on_id":"br-1bm.5.1","type":"blocks","created_at":"2026-02-05T05:41:34.643924817Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.5.3","title":"Mail UI Parity: template rendering + data binding","description":"## Objective\nParity for mail UI template rendering and data binding.\n\n## Scope\n- Render Jinja templates: `mail_index`, `mail_project`, `mail_inbox`, `mail_thread`, `mail_message`, `mail_attachments`, `mail_claims`, `mail_file_reservations`, `mail_unified_inbox`, `mail_search`.\n- Archive templates: `archive_browser`, `archive_timeline`, `archive_network`, `archive_activity`, `archive_commit`, `archive_guide`, `archive_time_travel`.\n- Overseer compose UI: `overseer_compose` with markdown preview.\n- Error template for missing project/agent/message.\n\n## Tests\n- Integration tests that render each template with fixture data and assert key fields present.\n- Snapshot tests for critical pages (index, project, inbox, message, archive views).\n\n## Logging/Artifacts\n- Save rendered HTML snapshots under `tests/artifacts/ui/templates/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:41:19.188774583Z","created_by":"ubuntu","updated_at":"2026-02-06T07:15:27.612311982Z","closed_at":"2026-02-06T07:15:27.612289940Z","close_reason":"Implemented mail_ui.rs with all route handlers dispatching to template rendering. Templates render via minijinja with custom striptags/truncate/tojson filters. All 109 tests pass (62 lib + 47 integration), clippy clean.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.5.3","depends_on_id":"br-1bm.5","type":"parent-child","created_at":"2026-02-05T05:41:19.188774583Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.5.3","depends_on_id":"br-1bm.5.1","type":"blocks","created_at":"2026-02-05T05:41:37.975640120Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.5.4","title":"Mail UI Parity: static assets + caching","description":"## Objective\nServe static mail UI assets with legacy behavior and caching semantics.\n\n## Scope\n- Serve `viewer_assets/` (index.html, viewer.js, styles.css, vendor assets, service worker).\n- Serve optional SPA `web/` directory when present, with fallback to index.html on 404 (nonAPI paths).\n- Ensure static files are mounted at root and do not conflict with API base path.\n\n## Tests\n- Integration tests for static asset serving and SPA fallback routing.\n- Verify correct content types and presence of assets.\n\n## Logging/Artifacts\n- Store asset response headers under `tests/artifacts/ui/static/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:41:24.807396589Z","created_by":"ubuntu","updated_at":"2026-02-06T07:23:28.688884449Z","closed_at":"2026-02-06T07:23:28.688860945Z","close_reason":"static_files.rs: web/ SPA directory serving with MIME type detection, path traversal protection, SPA fallback to index.html for non-API paths. Cache-Control: no-store matching legacy. 5 new tests. Integrated into lib.rs handle_special_routes.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.5.4","depends_on_id":"br-1bm.5","type":"parent-child","created_at":"2026-02-05T05:41:24.807396589Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.5.4","depends_on_id":"br-1bm.5.1","type":"blocks","created_at":"2026-02-05T05:41:42.251144821Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.5.5","title":"Mail UI Parity: unit + integration + E2E tests","description":"Comprehensive tests for Mail UI parity, with detailed logging + artifacts.\n\nTest layers:\n- Unit tests:\n  - markdown rendering + sanitization (golden inputs)\n  - explicit XSS regression suite (script tags, event handlers, inline JS URLs, SVG payloads)\n  - normalization rules documented (what is stripped/escaped)\n- Integration tests:\n  - template rendering snapshot tests (normalized where required)\n  - static asset fetch tests (content-type + caching headers)\n  - snapshot coverage for data binding edge cases (empty inbox, many messages, long subject/body, unicode)\n- E2E script:\n  - launch HTTP server\n  - fetch `/mail` routes\n  - validate DOM markers / key strings for each page\n  - capture HTML responses + server logs\n  - store artifacts under `tests/artifacts/mail_ui/<timestamp>/`\n  - include explicit XSS probe payloads and assert they are neutralized in rendered HTML\n\n## Acceptance Criteria\n- Snapshot tests cover at least: inbox empty, inbox with messages, thread view, compose page, search results.\n- Sanitization tests include explicit malicious payload fixtures and assert neutralization (no executable content).\n- E2E script:\n  - logs expected vs actual for each route\n  - writes a summary JSON (pass/fail + diffs)\n  - exits non-zero on mismatch\n- Running tests does not require external services (except optional DB fixtures); all fixtures are local.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:41:30.070251234Z","created_by":"ubuntu","updated_at":"2026-02-06T07:30:12.983257240Z","closed_at":"2026-02-06T07:30:12.983233135Z","close_reason":"All 129 tests pass (71 lib + 58 integration). Fixed SearchCtx field name mismatch (queryq) for template compatibility. Added 11 edge case tests covering: empty projects, many projects, no agents, empty thread, many messages, long subjects, unicode content, empty search results, unicode markdown, long markdown content, short string truncate. Clippy clean, fmt clean.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.5.5","depends_on_id":"br-1bm.5","type":"parent-child","created_at":"2026-02-05T05:41:30.070251234Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.5.5","depends_on_id":"br-1bm.5.2","type":"blocks","created_at":"2026-02-05T05:41:47.673854697Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.5.5","depends_on_id":"br-1bm.5.3","type":"blocks","created_at":"2026-02-05T05:41:50.835253684Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.5.5","depends_on_id":"br-1bm.5.4","type":"blocks","created_at":"2026-02-05T05:41:55.016360728Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.5.5","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:56.231317288Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.6","title":"HTTP Request Logging + OTEL Parity","description":"Objective:\nImplement HTTP request logging exactly as legacy Python. OTEL settings exist in config but legacy does not instrument HTTP; parity is a no-op for OTEL flags.\n\nLegacy Reference Behavior:\n- When HTTP_REQUEST_LOG_ENABLED, emit structlog + rich panel output (fallback to plain text if rich unavailable).\n- Logging must not interfere with responses or error handling.\n- OTEL flags are parsed but do not initialize instrumentation in legacy.\n\nImplementation Considerations:\n- Use frankentui for rich output while matching legacy formatting/colors.\n- Ensure log output is disabled when not configured (no noise).\n- Do not change stdout/stderr behavior expected by MCP clients.\n\nTests and E2E (with detailed logging):\n- Spec extraction: br-1bm.6.1\n- Implementation: br-1bm.6.2 + br-1bm.6.3\n- Tests: br-1bm.6.4 (uses shared harness br-2ei.9.1)\n\n## Acceptance Criteria\n- Logging output matches spec extracted in br-1bm.6.1 (fields + ordering).\n- OTEL flags remain a no-op (no crash, no spans).\n- br-1bm.6.4 unit+integration+E2E suite passes with high-signal artifacts on failure.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:42:07.451798461Z","created_by":"ubuntu","updated_at":"2026-02-06T07:55:13.357418113Z","closed_at":"2026-02-06T07:55:13.357390291Z","close_reason":"All children complete: br-1bm.6.1 (spec extraction), br-1bm.6.2 (request logging middleware), br-1bm.6.3 (OTEL config no-op), br-1bm.6.4 (51 unit+integration tests). HTTP request logging with KV/JSON renderers, rich panel output, ExpectedErrorFilter, OTEL no-op parity all implemented and tested.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.6","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:42:07.451798461Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.6.1","title":"HTTP Logging Parity: extract legacy behavior","description":"Extracted legacy HTTP logging behavior (mcp_agent_mail/src/mcp_agent_mail/http.py + config.py + tests):\n\nLegacy sources:\n- http.py: _configure_logging(), ExpectedErrorFilter, RequestLoggingMiddleware\n- config.py: LOG_JSON_ENABLED, LOG_RICH_ENABLED, LOG_LEVEL, LOG_INCLUDE_TRACE defaults\n- tests: test_expected_error_filter.py, test_logging_and_redis_fallback.py::test_log_json_enabled_path,\n  test_server.py::test_rich_logger_does_not_throw\n\nExact behavior to port:\n\n1) _configure_logging(settings) (idempotent, global _LOGGING_CONFIGURED)\n- structlog processors in order:\n  - structlog.contextvars.merge_contextvars\n  - structlog.processors.TimeStamper(fmt=\"iso\")\n  - structlog.processors.add_log_level\n  - then:\n    - if settings.log_json_enabled: structlog.processors.JSONRenderer()\n    - else: structlog.processors.KeyValueRenderer(key_order=[\"event\",\"path\",\"status\"])\n- structlog.configure wrapper_class: make_filtering_bound_logger(level=settings.log_level.upper() else INFO)\n- logging.basicConfig(level=settings.log_level.upper() else INFO)\n- Suppress noisy loggers:\n  - mcp.server.streamable_http -> WARNING\n  - mcp.server.lowlevel.server -> WARNING\n  - aiosqlite -> INFO\n  - git.util -> INFO\n  - git.cmd -> INFO\n  - filelock -> INFO\n  - sse_starlette.sse -> INFO\n\n2) ExpectedErrorFilter (applied ONLY to logger \"fastmcp.tools.tool_manager\")\n- Filters only when record.exc_info is present.\n- Patterns (case-insensitive substring):\n  - \"not found in project\"\n  - \"index.lock\"\n  - \"git_index_lock\"\n  - \"resource_busy\"\n  - \"temporarily locked\"\n  - \"recoverable=true\"\n  - \"use register_agent\"\n  - \"available agents:\"\n- Also treats exceptions with attribute recoverable=True as expected.\n- Also inspects __cause__ chain for patterns or recoverable=True.\n- If expected:\n  - record.exc_info = None; record.exc_text = None (traceback suppressed)\n  - if level >= ERROR: downgrade to INFO + levelname=\"INFO\"\n\n3) RequestLoggingMiddleware (enabled only when HTTP_REQUEST_LOG_ENABLED true)\n- Measures latency with time.time(); duration_ms = int((time.time()-start)*1000)\n- Fields:\n  - method = request.method\n  - path = request.url.path\n  - status = response.status_code\n  - client_ip = request.client.host if request.client else \"-\"\n- Structlog emission:\n  - structlog.get_logger(\"http\").info(\"request\", method=..., path=..., status=..., duration_ms=..., client_ip=...)\n- Rich output attempt (unconditional, not gated by LOG_RICH_ENABLED):\n  - Console(width=100)\n  - title = Text.assemble(\n      (method, \"bold blue\"), \"  \", (path, \"bold white\"), \"  \",\n      (status_code, \"bold green\" if 200<=status<400 else \"bold red\"), \"  \",\n      (f\"{dur_ms}ms\", \"bold yellow\"),\n    )\n  - body = Text.assemble((\"client: \", \"cyan\"), (client, \"white\"))\n  - Panel(body, title=title, border_style=\"dim\")\n- Fallback on any exception:\n  - print(\"http method={method} path={path} status={status} ms={dur_ms} client={client}\")\n\n4) LOG_RICH_ENABLED / LOG_INCLUDE_TRACE\n- LOG_RICH_ENABLED is used in llm.py cost logging (rich panel vs structlog); not consulted by HTTP request logging.\n- LOG_INCLUDE_TRACE exists in settings and tests (test_rich_logger_does_not_throw) but has no behavioral effect in HTTP logging.\n\n5) LOG_JSON_ENABLED\n- Only selects structlog JSONRenderer vs KeyValueRenderer; request logging emits via structlog and inherits renderer.\n- Legacy test only asserts LOG_JSON_ENABLED path does not crash on app build.\n\nDeliverables for implementers/tests:\n- Golden log examples (sanitized):\n  - 2xx / 4xx / 5xx requests (structlog + rich panel + fallback string)\n  - ExpectedErrorFilter case (traceback suppressed + level downgraded to INFO)\n- Explicit note: request logging uses request.client.host (not X-Forwarded-For), and duration is int ms.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:42:18.137231805Z","created_by":"ubuntu","updated_at":"2026-02-05T07:52:58.789104620Z","closed_at":"2026-02-05T07:52:58.789086847Z","close_reason":"Legacy HTTP logging behavior extracted and documented in bead description","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.6.1","depends_on_id":"br-1bm.6","type":"parent-child","created_at":"2026-02-05T05:42:18.137231805Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.6.2","title":"HTTP Logging Parity: request logging middleware","description":"Implement HTTP logging + ExpectedErrorFilter in Rust to match legacy behavior documented in br-1bm.6.1.\n\nKey parity requirements (from legacy):\n- Request logging is enabled ONLY by HTTP_REQUEST_LOG_ENABLED.\n- LOG_JSON_ENABLED selects structlog JSONRenderer vs KeyValueRenderer; request logs inherit this renderer.\n- LOG_RICH_ENABLED does NOT gate HTTP request logging (legacy always attempts rich output).\n- LOG_INCLUDE_TRACE has no effect on HTTP logging (exists only in config/tests).\n\nImplementation notes:\n- Mirror _configure_logging() idempotent setup and logger suppression.\n- ExpectedErrorFilter must behave exactly (pattern list + recoverable flag + cause chain); apply only to logger \"fastmcp.tools.tool_manager\".\n- Request logging uses request.client.host (no forwarded-header trust) and duration_ms = int(ms).\n- Rich output should mirror legacy layout; if rich not available, emit the exact fallback string.\n- Prefer frankentui for the rich/TTY rendering, but keep formatting/ordering/color semantics identical to legacy.\n\n## Acceptance Criteria\n- Output parity:\n  - Snapshot tests for structlog JSONRenderer branch and KeyValueRenderer branch.\n  - Rich panel layout matches legacy (method/path/status/duration/client, colors, width=100).\n  - Plain-text fallback line matches legacy format exactly.\n- Correctness:\n  - Logged fields are derived exactly (method, path, status, duration_ms, client_ip).\n  - ExpectedErrorFilter suppresses tracebacks and downgrades to INFO for expected/recoverable errors.\n- Performance:\n  - Near-zero overhead when HTTP_REQUEST_LOG_ENABLED is false.\n- Tests:\n  - Unit tests for ExpectedErrorFilter classifier and formatter.\n  - Integration tests validate logs emitted/absent without changing HTTP responses.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:42:22.022319697Z","created_by":"ubuntu","updated_at":"2026-02-06T06:29:27.574717672Z","closed_at":"2026-02-06T06:29:27.574689329Z","close_reason":"Implemented request logging middleware (KV/JSON + panel fallback) + expected error filter helper + tests","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.6.2","depends_on_id":"br-1bm.6","type":"parent-child","created_at":"2026-02-05T05:42:22.022319697Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.6.2","depends_on_id":"br-1bm.6.1","type":"blocks","created_at":"2026-02-05T05:42:34.829012504Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.6.3","title":"HTTP Logging Parity: OTEL config no-op","description":"## Objective\nEnsure OTEL config variables are accepted but behave as noop (legacy parity).\n\n## Scope\n- Env vars: `HTTP_OTEL_ENABLED`, `OTEL_SERVICE_NAME`, `OTEL_EXPORTER_OTLP_ENDPOINT`.\n- When enabled, **do not** crash if OTEL exporter unavailable; effectively noop.\n- Preserve request logging behavior independent of OTEL settings.\n\n## Tests\n- Unit tests verifying no errors when OTEL vars are set.\n- Integration tests with OTEL enabled and missing exporter (should still serve requests).\n\n## Logging/Artifacts\n- Store OTEL config logs under `tests/artifacts/http/logging/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T05:42:26.087167604Z","created_by":"ubuntu","updated_at":"2026-02-06T07:19:19.766692129Z","closed_at":"2026-02-06T07:19:19.766665829Z","close_reason":"Implemented OTEL config no-op parity (env vars parsed, fields plumbed but unused), plus tests ensuring HTTP request logging still works with OTEL flags enabled. Ran fmt/clippy/test; fixed a few test/gate issues encountered (JWKS test robustness + markdown/template test raw-string correctness).","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.6.3","depends_on_id":"br-1bm.6","type":"parent-child","created_at":"2026-02-05T05:42:26.087167604Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.6.3","depends_on_id":"br-1bm.6.1","type":"blocks","created_at":"2026-02-05T05:42:39.672384539Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.6.4","title":"HTTP Logging Parity: unit + integration + E2E tests","description":"Comprehensive tests for HTTP logging parity (request logs + structlog renderers + ExpectedErrorFilter), with detailed artifacts.\n\nTest layers:\n- Unit tests:\n  - formatting normalization (TTY vs non-TTY)\n  - conditional enablement: HTTP_REQUEST_LOG_ENABLED only\n  - LOG_JSON_ENABLED toggles JSONRenderer vs KeyValueRenderer (key_order=[event,path,status])\n  - field derivation (client_ip from request.client.host, latency int ms)\n  - ExpectedErrorFilter classifier:\n    - expected patterns detected and downgraded\n    - tracebacks suppressed for expected errors\n    - cause-chain inspection behavior\n- Integration tests:\n  - server with logging enabled emits logs\n  - server with logging disabled emits none\n  - LOG_JSON_ENABLED branch executed on app build (no crash)\n  - OTEL flags enabled: no-op parity (no spans, no behavior change)\n- E2E (part of scripts/e2e_http.sh, br-2ei.9.6):\n  - launch server with logging on\n  - issue representative requests (2xx/4xx/5xx)\n  - capture server stderr/stdout logs + HTTP transcripts\n  - store artifacts under tests/artifacts/http/<timestamp>/\n\nLegacy test references:\n- test_logging_and_redis_fallback.py::test_log_json_enabled_path\n- test_server.py::test_rich_logger_does_not_throw\n- test_expected_error_filter.py\n\n## Acceptance Criteria\n- Unit + integration tests cover the enable/disable matrix and TTY/non-TTY output.\n- Snapshot/golden log assertions are driven by the spec outputs from br-1bm.6.1.\n- ExpectedErrorFilter behavior matches legacy tests and pattern list.\n- E2E artifacts include clear expected-vs-actual field diffs and captured logs.\n- Tests run deterministically (fixed timestamps/latency fakes where required).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:42:30.521330089Z","created_by":"ubuntu","updated_at":"2026-02-06T07:54:50.930945883Z","closed_at":"2026-02-06T07:54:50.930921136Z","close_reason":"Added 51 HTTP logging parity tests: 37 unit tests in lib.rs (py_repr_str, KV/JSON formatters, panel TTY/non-TTY rendering, field derivation, ExpectedErrorFilter exhaustive pattern+cause coverage, config defaults, OTEL no-op, status code logging) + 10 integration tests in http_logging.rs (config gating, enable matrix, OTEL fields, instrumentation). 206 total server tests, clippy clean.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.6.4","depends_on_id":"br-1bm.6","type":"parent-child","created_at":"2026-02-05T05:42:30.521330089Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.6.4","depends_on_id":"br-1bm.6.2","type":"blocks","created_at":"2026-02-05T05:42:43.034853482Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.6.4","depends_on_id":"br-1bm.6.3","type":"blocks","created_at":"2026-02-05T05:42:46.092367952Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.6.4","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:56.319100804Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.7","title":"CORS Parity Validation","description":"Objective:\nValidate and complete CORS behavior parity with legacy Python: origins, allow_methods, allow_headers, allow_credentials, and OPTIONS responses. Ensure behavior matches when lists are empty or \"*\".\n\nLegacy Reference Behavior:\n- If CORS enabled, allow_origins defaults to [\"*\"] when empty\n- allow_methods default [\"*\"]\n- allow_headers default [\"*\"]\n- Credentials flag respected\n\nImplementation Plan:\n- Ensure CORS config parsing matches legacy defaults.\n- Verify OPTIONS responses include appropriate headers.\n- Ensure origin matching allows all when list is empty.\n\nTests and E2E (with detailed logging):\n- Unit tests for allowlist matching and default behavior.\n- Integration tests for OPTIONS + GET/POST with Origin set.\n- E2E coverage via `br-2ei.9.6` (HTTP parity suite) with header transcripts.\n\n## Acceptance Criteria\n- CORS headers match legacy defaults and behavior across:\n  - empty lists\n  - explicit \"*\"\n  - allow_credentials on/off\n- Preflight (OPTIONS) behavior matches legacy (status + headers).\n- E2E artifacts include explicit header diffs on mismatch.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:43:03.472355999Z","created_by":"ubuntu","updated_at":"2026-02-05T08:23:06.874227229Z","closed_at":"2026-02-05T08:23:06.874209255Z","close_reason":"CORS parity: env defaults + wildcard handling + header override + tests","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.7","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:43:03.472355999Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.7","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:56.401992322Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.8","title":"Bearer Auth Parity","description":"Objective:\nEnsure Bearer token auth middleware behavior matches legacy Python, including localhost bypass logic and forwarded-header safeguards.\n\nLegacy Reference Behavior:\n- If bearer token configured, require Authorization: Bearer <token>\n- If allow_localhost_unauthenticated and client is localhost (no forwarded headers), bypass Authorization\n- OPTIONS and /health/* always allowed\n- Constant-time comparison for token equality\n\nImplementation Plan:\n- Verify Rust middleware path covers OPTIONS + /health/* bypass.\n- Enforce constant-time token compare.\n- Use peer_addr + forwarded headers for localhost detection (`br-1bm.3`).\n\nTests and E2E (with detailed logging):\n- Unit tests for token comparison + bypass conditions.\n- Integration tests for /health endpoints, OPTIONS, and standard POSTs.\n- E2E coverage via `br-2ei.9.6` (HTTP parity suite) including forwarded-header negative cases.\n\n## Acceptance Criteria\n- Responses and bypass behavior match legacy exactly (status + JSON body).\n- Constant-time compare is used (no early-return string compare).\n- E2E artifacts include explicit allow/deny traces and header diffs on mismatch.","status":"closed","priority":1,"issue_type":"task","assignee":"GreenDune","created_at":"2026-02-05T05:43:12.124733018Z","created_by":"ubuntu","updated_at":"2026-02-06T07:03:49.815525779Z","closed_at":"2026-02-06T07:03:49.815475775Z","close_reason":"Implemented legacy bearer auth parity + tests","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.8","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:43:12.124733018Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.8","depends_on_id":"br-1bm.3","type":"blocks","created_at":"2026-02-05T05:43:23.276913856Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.8","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:56.484645140Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.9","title":"Health + Well-Known Endpoints Parity Tests","description":"Objective:\nVerify health and well-known endpoints match legacy behavior and remain stable. Ensure status codes and JSON payloads are identical.\n\nEndpoints:\n- GET /health/liveness -> {\"status\":\"alive\"}\n- GET /health/readiness -> {\"status\":\"ready\"} OR 503 {\"detail\":\"...\"}\n- GET /.well-known/oauth-authorization-server -> {\"mcp_oauth\": false}\n- GET /.well-known/oauth-authorization-server/mcp -> {\"mcp_oauth\": false}\n\nTests and E2E (with detailed logging):\n- Unit tests for readiness error formatting.\n- Integration tests for each endpoint and method mismatch (405).\n- E2E coverage via `br-2ei.9.6` (HTTP parity suite): hit each endpoint, log status/body, fail on mismatch.\n\n## Acceptance Criteria\n- JSON payloads and status codes identical to legacy for all endpoints.\n- Method mismatch behavior matches legacy (e.g., 405).\n- E2E artifacts include per-endpoint transcript and diffs on mismatch.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T05:43:18.747115290Z","created_by":"ubuntu","updated_at":"2026-02-06T07:57:26.559446583Z","closed_at":"2026-02-06T07:57:26.559423319Z","close_reason":"Added 32 health/well-known endpoint parity tests: 27 unit tests in lib.rs (liveness/readiness/oauth JSON payloads, content-type headers, 405 method rejection, 404 unknown subpath, bearer auth bypass for health, auth required for well-known, error response detail key format) + 5 integration tests in health_endpoints.rs (config validation, payload determinism, error format, health prefix). 238 total server tests, clippy clean.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.9","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:43:18.747115290Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.9","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:56.567818709Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1e5h","title":"DB concurrency parity: backoff + circuit breaker","description":"## Objective\nImplement database lock contention handling and circuit breaker per legacy concurrency model.\n\n## Scope\n- Exponential backoff with jitter on SQLITE_BUSY/locked errors.\n- Circuit breaker: after 5 consecutive failures, open for 30s (fail fast with `DATABASE_POOL_EXHAUSTED`/`RESOURCE_BUSY`).\n- Connection pooling defaults: base 3 + overflow 4, recycle 30min, busy timeout 5s.\n\n## Tests\n- Unit tests simulating lock contention and backoff sequence.\n- Integration tests for circuit breaker open/close behavior.\n\n## Logging/Artifacts\n- Store backoff/circuit logs under `tests/artifacts/db/concurrency/<timestamp>/`.\n\n## Acceptance Criteria\n1. Backoff and circuit breaker match legacy thresholds and timings.\n2. Errors are mapped to legacy error codes.\n3. Tests are deterministic and do not rely on real contention.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T16:18:50.675607847Z","created_by":"ubuntu","updated_at":"2026-02-06T06:21:45.705741026Z","closed_at":"2026-02-06T06:21:45.705722471Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1e5h","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T16:18:55.369503695Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1m6a","title":"[epic] Dramatically enhance console output with frankentui","description":"Master epic for dramatically improving the MCP Agent Mail server console UX using FrankenTUI.\n\nBACKGROUND\n- Legacy Python has rich_logger.py: highly structured Rich panels for startup, tool calls, and key events.\n- Rust server already uses FrankenTUI inline mode (TerminalWriter) for a persistent HUD while preserving scrollback.\n\nPRIMARY GOALS\n- Python parity: replicate the important *information architecture* of rich_logger.py (startup banner sections, tool call start/end panels, query stats, request panels).\n- FrankenTUI-native upgrades: keep a stable inline HUD, add sparklines, toast notifications, subtle animations, and better discoverability (links, tips, command palette) without sacrificing determinism.\n- User-tunable console: interactive layout configuration (bottom % vs left split) and theme selection, persisted to a user config file so it \"just remembers\" (enabled by default in real TTYs).\n- Safety by default: never leak secrets in panels; mask sensitive values; keep output bounded (truncate huge JSON).\n- Zero-surprise behavior: when rich output is disabled or stdout is not a TTY, fall back to plain, grep-friendly text with no giant ANSI art dumps.\n- Performance: when tool logging is disabled, overhead must be near-zero (no JSON pretty-printing, no allocations on hot path).\n\nSCOPE\n- Server console only (primarily `crates/mcp-agent-mail-server`).\n- Includes both HTTP mode and stdio mode behavior where it impacts console output.\n\nKEY CONSTRAINTS\n- Inline mode must preserve scrollback and not corrupt the HUD.\n- Output must remain deterministic enough for unit tests and E2E scripts.\n\nIMPLEMENTATION DIRECTION (PREFERRED)\n- Prefer rendering rich panels via ftui widgets into an offscreen `ftui::Buffer` + `ftui::Frame`, then exporting to ANSI using `ftui-extras` (TextExporter). This avoids brittle manual width/ANSI bookkeeping.\n- Centralize styling on FrankenTUI's theme system (no ad-hoc ANSI constants).\n- Centralize masking + safe JSON formatting utilities.\n\nDONE WHEN\n- Startup banner matches parity sections and is pleasant in real terminals.\n- Tool call start/end panels exist with syntax-highlighted JSON and per-call query stats.\n- Request panels are color-coded and consistent with theme.\n- HUD shows useful live telemetry (counts, req/s trends, toasts).\n- Unit tests + new console E2E suite pass and are stable in CI.","notes":"User requirements recap (as of 2026-02-07)\n- Rich/TUI console output must be enabled by default in real TTYs (`LOG_RICH_ENABLED=true` default).\n- Console layout must be interactively tunable (HUD height %, anchor, inline auto-size, left split ratio) and automatically remembered via `CONSOLE_PERSIST_PATH` (default `~/.config/mcp-agent-mail/config.env`).\n- Interactive tuning must never interfere with stdio MCP protocol (so interactive input stays HTTP-only).\n\nPlan-space guardrails\n- Any new interactive UX should ship with:\n  - pure unit tests for state transitions (no PTY needed)\n  - at least one PTY E2E assertion for real-TTY gating and persistence\n- PTY capture constraint: when engaging AltScreen, emit grep-friendly summary lines (Console layout + ConsoleCaps) via plain stderr *before* switching screen mode so `script` transcripts can assert without parsing AltScreen control codes.","status":"closed","priority":0,"issue_type":"epic","assignee":"IndigoRidge","created_at":"2026-02-06T20:51:17.164232623Z","created_by":"ubuntu","updated_at":"2026-02-07T01:19:17.285991972Z","closed_at":"2026-02-07T01:19:17.285961715Z","close_reason":"All 23 children closed. Console enhancements complete: banner, tool panels, request panels, masking, HUD, sparklines, caps detection, command palette, event timeline, theme system.","source_repo":".","compaction_level":0,"original_size":0}
{"id":"br-1m6a.1","title":"Rich ASCII art startup banner with full Python parity","description":"Upgrade the startup banner to be FrankenTUI-native and Python-parity-aligned.\n\nCURRENT STATE (CODE REALITY)\n- Startup banner rendering lives in `crates/mcp-agent-mail-server/src/console.rs::render_startup_banner()`.\n- It already prints a strong first draft of the full experience:\n  - ASCII art logo + subtitle\n  - Server Configuration table\n  - Database Statistics table\n  - Web UI box\n  - Stats Showcase JSON-ish box\n  - Closing rule\n- However it is still hand-built with:\n  - raw ANSI escape code constants\n  - manual width math / ad-hoc unicode width guesses\n  - ad-hoc JSON token coloring\n\nGOALS\n- Keep rich banner enabled by default in real TTYs when `LOG_RICH_ENABLED=true` (default).\n- Zero ANSI spam in non-TTY contexts: fall back to a single plain startup line (grep-friendly).\n- Centralize styling via theme (`br-1m6a.12`) and stop scattering `\\x1b[` literals through the code.\n- Safety by default: all sensitive values must be masked/sanitized using `br-1m6a.18`.\n- Determinism: stable output for unit tests/E2E (no time-based animations in the banner).\n\nIMPLEMENTATION DIRECTION (PREFERRED)\n- Render each banner section using real `ftui` widgets (Block/Table/Paragraph/etc) into an offscreen `ftui::Frame` at a fixed width, then export to ANSI via a FrankenTUI exporter (e.g. `ftui-extras` text exporter).\n  - This eliminates fragile padding/width bookkeeping.\n  - It also allows later upgrades like hyperlinks and theme variants without rewriting string math.\n- Transitional allowance: it is fine if `render_startup_banner()` still returns `Vec<String>` as long as those strings are produced from widget export rather than manual ANSI.\n\nREQUIRED SECTIONS\n1) Logo header (brand)\n- Maintain the ASCII art identity, but generate styling via theme rather than hardcoded CYAN/BLUE/MAG constants.\n- Keep subtitle line: \"Agent Coordination via Message Passing\".\n\n2) Server Configuration\n- Show (at minimum):\n  - environment\n  - endpoint\n  - database URL (sanitized)\n  - storage root\n  - auth enabled\n  - `TOOLS_LOG_ENABLED`\n  - `LOG_TOOL_CALLS_ENABLED`\n  - `CONSOLE_THEME` (active theme id/name from `br-1m6a.12`, for discoverability)\n- Values MUST pass through masking/sanitization helper.\n\n3) Database Statistics\n- Existing counts plus `pending_acks` (available in HUD snapshot).\n\n4) Web UI\n- Keep the existing Web UI box.\n- `br-1m6a.9` upgrades the link set and optional OSC-8 hyperlinks.\n\n5) JSON Stats Showcase\n- `br-1m6a.17` upgrades this to real JSON + syntax highlighting.\n\n6) Console Layout Summary (for testability)\n- Include a single line describing the active console layout config (from `br-1m6a.19`).\n  - E2E must be able to assert the mode without parsing inline/alt-screen control codes.\n\nGATING\n- Banner should only render when:\n  - `config.log_rich_enabled == true`\n  - `stdout.is_terminal() == true`\n- Otherwise: emit one plain startup line like:\n  - `mcp-agent-mail listening on http://HOST:PORT (rich console disabled or non-tty)`\n\nTESTING\n- Update/extend existing `console.rs` banner tests to assert stable headers/sections and that secrets are redacted.\n- Tests should use shared ANSI/OSC stripping helpers from `br-1m6a.14`.\n\nNOTES\n- `br-1m6a.10` remains the focused regression bead ensuring config values are masked in the banner.","notes":"STRETCH (banner polish + FrankenTUI showcase): Console capabilities + first-run discoverability\n\n- Add a compact `Console Capabilities` box/row in the banner that surfaces what FrankenTUI detected and what features are active:\n  - truecolor / hyperlinks (OSC-8) / synchronized output / mouse\n  - active `CONSOLE_THEME`\n  - active layout mode summary (`inline bottom 33%` etc)\n- Keep at least one plain-text line (`ConsoleCaps: ...`) so `br-1m6a.15` can assert it without parsing control codes.\n- If capabilities are unknown/unreliable, prefer conservative wording and allow env overrides to disable features (e.g., force hyperlinks off).\n\nGoal: users instantly understand why hyperlinks/animations are or arent showing up.","status":"closed","priority":0,"issue_type":"task","assignee":"RubyPrairie","created_at":"2026-02-06T20:52:00.053888754Z","created_by":"ubuntu","updated_at":"2026-02-06T23:39:30.252388170Z","closed_at":"2026-02-06T23:39:30.252273375Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1m6a.1","depends_on_id":"br-1m6a","type":"parent-child","created_at":"2026-02-06T20:52:00.053888754Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1m6a.10","title":"Mask sensitive values in startup banner config display","description":"Apply the shared masking/sanitization utility (`br-1m6a.18`) to the startup banner so secrets cannot leak.\n\nCURRENT STATE\n- Banner rendering lives in `crates/mcp-agent-mail-server/src/console.rs` (`render_startup_banner`).\n- It prints config-ish fields (endpoint, database_url, storage_root, auth/tool logging flags).\n- It currently does NOT guarantee secrets are redacted correctly.\n\nREQUIREMENTS\n- All potentially sensitive config values rendered by the banner must be passed through the shared helper(s) from `br-1m6a.18`.\n- Explicit allowlist exceptions must be respected:\n  - `project_key` MUST remain visible (never masked).\n  - `storage_root` MUST remain visible.\n\nWHAT TO MASK/SANITIZE IN THE BANNER\n- Anything that is an actual secret:\n  - bearer tokens, JWT secrets, API keys, passwords.\n- Non-obvious secret carriers:\n  - `database_url` (may embed `user:pass@`): sanitize credentials in-place (preserve host/db name).\n  - redis URLs (if/when displayed): same.\n\nIMPLEMENTATION\n- In the \"Server Configuration\" section of the banner:\n  - Use `sanitize_known_value(key, value)` first.\n  - If key is sensitive, replace with `<redacted>`.\n  - Otherwise keep the value.\n- If the banner includes any JSON blob (stats showcase) that contains sensitive keys, run `mask_json()` before pretty-printing.\n\nTESTING (REGRESSION)\n- Provide a banner render test that injects a fake secret (e.g. `bearer_token = \"secret123\"`) and asserts:\n  - Output contains `<redacted>`\n  - Output does NOT contain `secret123`\n- Add a test proving `project_key` stays visible when present in JSON args.\n- Add a test for `database_url` credential stripping: `postgres://u:p@h/db` -> `postgres://u:<redacted>@h/db` (exact format TBD, but password must not appear).\n\nDONE WHEN\n- Startup banner cannot leak secrets, even if config values contain embedded credentials.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-06T20:52:40.447222821Z","created_by":"ubuntu","updated_at":"2026-02-06T23:39:30.259349320Z","closed_at":"2026-02-06T23:39:30.252273375Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1m6a.10","depends_on_id":"br-1m6a","type":"parent-child","created_at":"2026-02-06T20:52:40.447222821Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1m6a.10","depends_on_id":"br-1m6a.1","type":"blocks","created_at":"2026-02-06T20:52:49.979527948Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1m6a.10","depends_on_id":"br-1m6a.18","type":"blocks","created_at":"2026-02-06T21:25:55.240437818Z","created_by":"CobaltTower","metadata":"{}","thread_id":""}],"comments":[{"id":8,"issue_id":"br-1m6a.10","author":"CobaltTower","text":"Reopened: Closed prematurely; masking helper + banner integration not implemented yet.","created_at":"2026-02-06T21:26:44Z"}]}
{"id":"br-1m6a.11","title":"Color-coded HTTP status badges in request panels","description":"Enhance request logging panels with color-coded status badges matching Python parity.\n\nSTATUS COLORS (using theme constants from br-1m6a.12):\n- 2xx: SUCCESS color, bold\n- 3xx: INFO color\n- 4xx: WARNING color, bold\n- 5xx: DANGER color, bold\n\nMETHOD COLORS:\n- GET: INFO color\n- POST: PRIMARY color\n- PUT: ACCENT color\n- DELETE: DANGER color\n\nADDITIONAL ELEMENTS:\n- Duration: WARNING color (yellow)\n- Path: TEXT color, bold\n- Client IP: MUTED color\n\nIMPLEMENTATION:\n- fn status_style(code: u16) -> Style - returns appropriate style\n- fn method_style(method: &str) -> Style - returns appropriate style\n- Apply in render_http_request_panel() for request log panels\n- Apply in render_dashboard_frame() for the last-request footer\n\nTESTING: Test status_style for 200, 301, 404, 500. Test method_style for GET, POST, DELETE.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-06T20:52:40.547005805Z","created_by":"ubuntu","updated_at":"2026-02-06T21:20:15.135640753Z","closed_at":"2026-02-06T21:20:15.135555153Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1m6a.11","depends_on_id":"br-1m6a","type":"parent-child","created_at":"2026-02-06T20:52:40.547005805Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1m6a.11","depends_on_id":"br-1m6a.12","type":"blocks","created_at":"2026-02-06T20:52:49.071461585Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1m6a.12","title":"Centralized theme system with adaptive colors","description":"Create a centralized semantic theme/palette for *all* console output (banner, tool panels, request panels, HUD), using FrankenTUI's built-in theme system as the single source of truth.\n\nWHY\n- We want the console to feel cohesive, branded, and polished (not a pile of ad-hoc ANSI constants).\n- FrankenTUI already ships a strong theme system (multiple curated palettes + cached semantic styles + syntax theme integration). We should leverage it rather than reinventing a parallel palette.\n\nCURRENT STATE\n- Rich console output is split across:\n  - `crates/mcp-agent-mail-server/src/console.rs` (banner + tool panels + sparkline + toast/log panel helpers)\n  - `crates/mcp-agent-mail-server/src/lib.rs` (HTTP request panel + HUD rendering)\n- `console.rs` still uses hardcoded raw ANSI escape code strings (CYAN_B, BLUE, MAG, etc.).\n\nSOURCE OF TRUTH (DO NOT REINVENT)\n- Use `ftui_extras::theme`:\n  - `ThemeId`, `set_theme`, `current_theme_name`, `current_palette`\n  - `semantic_styles_cached()` for consistent `Style` tokens\n  - `syntax_theme()` (feature `syntax`) so JSON/tool panels match the active palette\n\nCONFIG (ENABLED BY DEFAULT IN REAL TTYS)\n- Add env var `CONSOLE_THEME` (string):\n  - Values: `cyberpunk_aurora|darcula|lumen_light|nordic_frost|high_contrast`\n  - Default: `cyberpunk_aurora`\n- This is console-only (must not affect server semantics).\n- Persist `CONSOLE_THEME` alongside other `CONSOLE_*` keys in the user envfile from `br-1m6a.19` so interactive tuning is remembered.\n\nINTEGRATION\n1) Startup wiring\n- When rich console is active (`LOG_RICH_ENABLED=true` + TTY), set the theme early (before banner/HUD render) by calling `ftui_extras::theme::set_theme(...)`.\n\n2) Replace ad-hoc styling\n- Replace hardcoded ANSI constants and scattered color decisions with semantic styles:\n  - success/warn/error/info/muted/title/header/link\n- When rendering via `Frame` + exporter, rely on `Style` tokens rather than emitting raw SGR.\n\n3) Syntax highlighting alignment\n- Any use of `ftui_extras::syntax::SyntaxHighlighter` should be constructed with the active `syntax_theme()` so JSON looks coherent across banner/tool panels.\n\nNON-TTY / RICH DISABLED\n- If `stdout.is_terminal()==false` or `LOG_RICH_ENABLED=false`: do not emit rich panels; keep output plain and grep-friendly.\n\nTESTING\n- Unit tests for parsing `CONSOLE_THEME` -> `ThemeId` mapping.\n- Render/unit tests must use `ftui_extras::theme::ScopedThemeLock` to avoid cross-test theme races.\n- Regression test: after migration, no raw `\\x1b[` literals remain in `crates/mcp-agent-mail-server/src/console.rs` except inside exporter/normalizer helpers.","status":"closed","priority":0,"issue_type":"task","assignee":"RubyPrairie","created_at":"2026-02-06T20:52:40.649220290Z","created_by":"ubuntu","updated_at":"2026-02-06T23:38:10.015301954Z","closed_at":"2026-02-06T23:38:10.015215022Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1m6a.12","depends_on_id":"br-1m6a","type":"parent-child","created_at":"2026-02-06T20:52:40.649220290Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1m6a.13","title":"Enhanced request log panel matching Python parity","description":"Enhance `render_http_request_panel()` to be theme-consistent and parity-aligned with the legacy Python request logging UX.\n\nCURRENT STATE (ALREADY IMPLEMENTED)\n- `LOG_JSON_ENABLED` exists in `mcp_agent_mail_core::Config` and is already honored.\n  - When enabled: emit JSON line to stderr via `http_request_log_json_line()`.\n  - When disabled: emit KV/structlog-like line.\n- `render_http_request_panel()` exists and emits a 3-line ASCII panel.\n\nWHAT'S MISSING\n- Better method/status badge coloring (2xx/3xx/4xx/5xx + GET/POST/DELETE/etc).\n- Theme unification (stop hardcoding ANSI colors inside this function).\n- Respect rich-output gates so we don't dump ANSI art in non-TTY contexts.\n\nTARGET STATE\n1) Status + method styles (from theme `br-1m6a.12`)\n- `fn status_style(code: u16) -> Style`\n  - 2xx: SUCCESS, bold\n  - 3xx: INFO\n  - 4xx: WARNING, bold\n  - 5xx: DANGER, bold\n- `fn method_style(method: &str) -> Style`\n  - GET: INFO\n  - POST: PRIMARY\n  - PUT/PATCH: ACCENT\n  - DELETE: DANGER\n\n2) Panel layout\n- Title: `{METHOD}  {PATH}  {STATUS}  {MS}ms` with per-segment styles.\n- Body: `client: {ip}` in muted style.\n- Border: rounded + muted, width capped (keep deterministic, default 100).\n\n3) Gating\n- Only render the rich-ish panel when:\n  - `config.log_rich_enabled == true`\n  - `stdout.is_terminal() == true`\n- Otherwise fall back to the existing plain-text fallback line.\n\nTESTING\n- Unit tests for style mapping:\n  - status: 200, 301, 404, 500\n  - method: GET, POST, DELETE\n- Unit test that JSON stderr emission stays valid JSON.\n- Unit tests that non-TTY or `LOG_RICH_ENABLED=false` results in fallback (no ANSI panel).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-06T20:52:40.753047760Z","created_by":"ubuntu","updated_at":"2026-02-06T23:48:14.170434696Z","closed_at":"2026-02-06T23:48:14.170409869Z","close_reason":"Implemented: status_style, method_style, render_http_request_panel moved to console.rs with theme colors, rounded borders, log_rich_enabled gating. 13 new tests in console.rs + updated 6 tests in lib.rs. All 249 tests pass, 0 clippy warnings.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1m6a.13","depends_on_id":"br-1m6a","type":"parent-child","created_at":"2026-02-06T20:52:40.753047760Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1m6a.13","depends_on_id":"br-1m6a.12","type":"blocks","created_at":"2026-02-06T21:15:43.613416111Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1m6a.14","title":"Comprehensive unit tests for console output enhancements","description":"Ensure we have comprehensive, *stable* test coverage for console-output enhancements (banner, tool panels, request panels, masking) without writing brittle snapshot tests.\n\nIMPORTANT\n- Console output is inherently brittle; these tests must focus on stable invariants and use robust ANSI/OSC normalization.\n- Avoid timing-based assertions or exact spacing expectations.\n\nSCOPE (WHAT THIS BEAD OWNS)\n- Shared ANSI/OSC + control-char normalization helpers for console output assertions.\n- A small-but-strong integration test suite proving the most important *user-visible* invariants:\n  - startup banner structure + redaction invariants\n  - tool call panel presence + masking invariants\n  - request panel rendering invariants (rich + plain/no-escape mode)\n\nNon-goals for this bead (covered by feature beads)\n- Command palette behaviors: see `br-1m6a.21` (must ship its own unit tests).\n- AltScreen timeline behaviors: see `br-1m6a.22` (must ship its own unit tests).\n\nCURRENT STATE (2026-02-07)\n- Added shared normalization helpers in:\n  - `crates/mcp-agent-mail-server/tests/common/mod.rs`\n    - `strip_ansi_and_osc()` strips CSI + OSC (incl OSC-8 hyperlinks), removes remaining control chars, normalizes CR.\n    - `normalize_console_text()` strips then trims trailing whitespace per line.\n    - unit tests cover CSI/OSC stripping edge cases.\n- Added/expanded integration assertions in:\n  - `crates/mcp-agent-mail-server/tests/console_output.rs`\n    - banner contains expected section headers after normalization.\n    - DB URL userinfo is redacted.\n    - tool call start masks sensitive params while preserving identity signals.\n    - tool call end masks JSON result preview.\n    - request panel contains method/path/status/client_ip after normalization.\n    - plain-panel mode emits *zero* ANSI/OSC escapes.\n\nTEST HARNESS REQUIREMENTS (FOUNDATIONAL)\n1) ANSI/OSC normalization helpers (shared across tests)\n- Strip SGR, cursor movement/clear sequences, and OSC-8 hyperlinks.\n- Provide helpers that assert on normalized content.\n\n2) Deterministic width handling\n- Render at fixed widths (80/100/120) and assert on headers/labels rather than exact spacing.\n\n3) Theme determinism\n- Any render test that depends on the active FrankenTUI theme must guard against global theme races using `ftui_extras::theme::ScopedThemeLock`.\n\nDONE WHEN\n- The shared ANSI/OSC normalizer exists with unit tests.\n- Integration tests cover banner/tool/request invariants and are stable locally.\n- Full workspace quality gates pass:\n  - `cargo fmt --check`\n  - `cargo check --all-targets`\n  - `cargo clippy --all-targets -- -D warnings`\n  - `cargo test`\n\nDependencies:\n  -> br-1m6a (parent-child) - [epic] Dramatically enhance console output with frankentui\n\nDependents:\n  <- br-1m6a.15 (blocks) - E2E smoke test for console output","notes":"No longer blocked: console build is green and the unit/integration tests described in this bead are present (ANSI/OSC normalizer + banner/tool/request invariants).\n\nNext action\n- Close this bead once workspace gates are confirmed green (fmt/check/clippy/test).","status":"closed","priority":1,"issue_type":"task","assignee":"IndigoRidge","created_at":"2026-02-06T20:52:40.858032931Z","created_by":"ubuntu","updated_at":"2026-02-07T00:42:06.643954513Z","closed_at":"2026-02-07T00:42:06.643929837Z","close_reason":"Completed: added shared ANSI/OSC normalization helpers + integration assertions for banner/tool/request panels; workspace gates are green.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1m6a.14","depends_on_id":"br-1m6a","type":"parent-child","created_at":"2026-02-06T20:52:40.858032931Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1m6a.15","title":"E2E smoke test for console output","description":"Add a dedicated E2E smoke test that validates the rich console output in a *real* TTY/PTY environment.\n\nWHY\n- Many console features are gated on `is_terminal()`; unit tests alone cannot prove real terminal behavior.\n- We need stable, grep-able assertions with robust ANSI/OSC normalization.\n\nLOCATION / HARNESS PATTERN\n- Follow the repos existing E2E structure:\n  - Implement core logic in `scripts/e2e_console.sh`.\n  - Add wrapper `tests/e2e/test_console.sh` that calls the script (like `test_http.sh`, `test_stdio.sh`).\n  - Reuse `scripts/e2e_lib.sh` helpers (tmp dirs, server lifecycle, assertions).\n\nPTY CAPTURE\n- Use `script -q` (or an equivalent PTY tool available in CI) to run the server so `stdout.is_terminal()==true`.\n- Capture BOTH stdout and stderr to files for assertions.\n- Add an ANSI/OSC stripper helper that normalizes:\n  - SGR color codes (`\\x1b[...m`)\n  - OSC-8 hyperlinks (if emitted)\n  - cursor movement / clear sequences (if any)\n\nTEST CASES (MINIMUM)\n1) `startup_banner_present_in_tty`\n- Start server with:\n  - `LOG_RICH_ENABLED=true`\n  - `TOOLS_LOG_ENABLED=true`\n- Assert banner contains:\n  - logo/header marker\n  - \"Server Configuration\"\n  - \"Database Statistics\"\n  - \"Web UI\"\n\n2) `banner_suppressed_when_rich_disabled`\n- Start server with `LOG_RICH_ENABLED=false` under PTY.\n- Assert banner markers are absent.\n\n3) `tool_call_panels_respect_gates`\n- Start server with `LOG_RICH_ENABLED=true`, `TOOLS_LOG_ENABLED=true`, `LOG_TOOL_CALLS_ENABLED=true`.\n- Perform one MCP tool call (use existing stdio/HTTP harness helpers) and assert:\n  - TOOL CALL panel header appears\n  - tool name appears\n- Repeat with `LOG_TOOL_CALLS_ENABLED=false` and assert the TOOL CALL panel does NOT appear.\n\n4) `request_panel_logged`\n- Start HTTP server with `HTTP_REQUEST_LOG_ENABLED=true` and send a request to `/health/liveness`.\n- Assert request panel (or fallback line) includes method/path/status.\n\n5) `layout_config_reported`\n- Start with layout env vars from `br-1m6a.19` and assert output contains the layout summary line.\n\n6) `theme_config_reported`\n- Start with `CONSOLE_THEME=high_contrast` and assert banner/config output mentions `high_contrast` (or the display name) so we know theme selection is wired.\n\n7) `left_split_mode_engages`\n- Start server with:\n  - `CONSOLE_SPLIT_MODE=left`\n  - `CONSOLE_SPLIT_RATIO_PERCENT=30`\n- Assert the banner includes a plain-text layout summary like `Console: left 30% (alt-screen)`.\n  - This is required so E2E does not need to parse alt-screen control codes.\n\nSTABILITY\n- If PTY capture is unavailable, the test must skip with a clear message.\n- Keep assertions resilient: assert on stable headers/keywords, not exact spacing/art.","notes":"Completed PTY E2E suite\n- `scripts/e2e_console.sh` + `tests/e2e/test_console.sh` implemented and passing.\n- Run locally: `E2E_FORCE_BUILD=1 ./scripts/e2e_test.sh console`.\n\nKey stability fixes\n- Left split AltScreen case is now stable: StartupDashboard emits grep-friendly `Console:` + `ConsoleCaps:` lines *before* engaging AltScreen, so PTY transcripts always contain the layout breadcrumb (`split: left 30% requested`).\n\nOptional\n- Interactive key-injection test remains opt-in (`AM_E2E_INTERACTIVE=1`) to keep CI stable.","status":"closed","priority":1,"issue_type":"task","assignee":"CobaltTower","created_at":"2026-02-06T20:52:40.964179560Z","created_by":"ubuntu","updated_at":"2026-02-07T00:50:41.302324257Z","closed_at":"2026-02-07T00:50:41.302295233Z","close_reason":"Completed: PTY console E2E smoke suite added + stabilized left-split breadcrumb emission; suite passes with E2E_FORCE_BUILD=1.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1m6a.15","depends_on_id":"br-1m6a","type":"parent-child","created_at":"2026-02-06T20:52:40.964179560Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1m6a.15","depends_on_id":"br-1m6a.1","type":"blocks","created_at":"2026-02-06T21:46:38.866752426Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1m6a.15","depends_on_id":"br-1m6a.13","type":"blocks","created_at":"2026-02-06T21:46:39.075183315Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1m6a.15","depends_on_id":"br-1m6a.14","type":"blocks","created_at":"2026-02-06T20:52:49.771651393Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1m6a.15","depends_on_id":"br-1m6a.16","type":"blocks","created_at":"2026-02-06T21:46:39.281317798Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1m6a.15","depends_on_id":"br-1m6a.19","type":"blocks","created_at":"2026-02-06T21:46:39.181128829Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1m6a.15","depends_on_id":"br-1m6a.2","type":"blocks","created_at":"2026-02-06T21:46:38.970475633Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1m6a.15","depends_on_id":"br-1m6a.20","type":"blocks","created_at":"2026-02-06T21:51:28.121284592Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1m6a.16","title":"Config: tool call console logging (defaults + truncation)","description":"Fix and rationalize config knobs for tool-call *console* logging so behavior matches our UX goals and Python parity.\n\nCURRENT STATE (CODE REALITY)\n- `mcp_agent_mail_core::Config` already has:\n  - `tools_log_enabled` (env `TOOLS_LOG_ENABLED`, default true)\n  - `log_tool_calls_enabled` (env `LOG_TOOL_CALLS_ENABLED`, default false)\n  - `log_tool_calls_result_max_chars` (env `LOG_TOOL_CALLS_RESULT_MAX_CHARS`, default 500)\n\nPROBLEMS\n- `log_tool_calls_enabled` exists and is documented, but is not consistently enforced by the server.\n- Default truncation (500) is smaller than legacy Python `_safe_json_format()` (2000 chars), and makes panels less useful.\n- We want tool-call console panels enabled by default in real TTYs.\n\nCHANGES (NO NEW FIELDS)\n1) Enable tool-call console panels by default\n- Change `Config::default()`:\n  - `log_tool_calls_enabled: true`\n- Gating in server (`br-1m6a.2`) should require:\n  - `config.log_rich_enabled && stdout.is_terminal()`\n  - `config.tools_log_enabled && config.log_tool_calls_enabled`\n\n2) Python-parity truncation limit\n- Change `Config::default()`:\n  - `log_tool_calls_result_max_chars: 2000`\n- Ensure the tool-call end panel uses this limit for both args/result previews.\n\n3) Env vars\n- Keep existing env var names:\n  - `LOG_TOOL_CALLS_ENABLED`\n  - `LOG_TOOL_CALLS_RESULT_MAX_CHARS`\n- Ensure `Config::from_env()` continues to parse them.\n\nDOCS\n- Update `README.md` config section:\n  - Make the defaults correct (`LOG_TOOL_CALLS_ENABLED` default true, `LOG_TOOL_CALLS_RESULT_MAX_CHARS` default 2000).\n\nTESTING\n- Unit test defaults (`Config::default()` / `Config::from_env()` with empty env)\n- Unit test env parsing (`Config::from_env()` respects `LOG_TOOL_CALLS_ENABLED` + `LOG_TOOL_CALLS_RESULT_MAX_CHARS`)\n\nNOTES\n- Do NOT introduce a second truncation env var (avoid `TOOLS_LOG_RESULT_MAX_CHARS`).\n- We don't care about backward compatibility; pick the cleanest config contract and fix docs + callers.","status":"closed","priority":0,"issue_type":"task","assignee":"CobaltTower","created_at":"2026-02-06T20:55:22.550483394Z","created_by":"ubuntu","updated_at":"2026-02-06T22:12:55.176873760Z","closed_at":"2026-02-06T22:12:55.176843994Z","close_reason":"Completed: tool-call panels enabled by default (TTY+rich+tools+log_tool_calls), truncation default 2000, docs+tests updated, clippy fixed","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1m6a.16","depends_on_id":"br-1m6a","type":"parent-child","created_at":"2026-02-06T20:55:22.550483394Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1m6a.17","title":"JSON stats showcase in startup banner","description":"Turn the existing banner \"JSON Stats\" box into a real, machine-parseable + nicely highlighted startup-state blob.\n\nCURRENT STATE\n- `crates/mcp-agent-mail-server/src/console.rs::render_startup_banner()` already prints a \"Stats Showcase\" JSON-ish section.\n- It is currently constructed as a hand-written string and colorized with an ad-hoc tokenizer.\n\nGOAL\n- Provide a *real* startup-state JSON blob that is:\n  - Deterministic (stable key ordering)\n  - Masked/sanitized (no secrets) via `br-1m6a.18`\n  - Syntax highlighted (FrankenTUI style, aligned with active theme `br-1m6a.12`)\n\nCONTENT (EXAMPLE KEYS)\n- `endpoint`\n- `web_ui`\n- `uptime`\n- `environment`\n- `auth_enabled`\n- `tools_log_enabled`\n- `log_tool_calls_enabled`\n- `stats`: { projects, agents, messages, file_reservations, contact_links }\n- `storage_root` (safe)\n\nIMPLEMENTATION\n- Build a `serde_json::Value` (object) for the stats blob.\n- Apply `br-1m6a.18` masking/sanitization to the JSON (`mask_json`) before rendering.\n- Pretty-print with `serde_json::to_string_pretty()`.\n- Replace the ad-hoc JSON colorizer with FrankenTUI syntax highlighting:\n  - Add `ftui-extras` dependency to the server crate with `features = [\"syntax\"]`.\n  - Build the highlighter with the active theme:\n    - `SyntaxHighlighter::with_theme(ftui_extras::theme::syntax_theme())`\n  - Render into a styled `Text` and then:\n    - (preferred) render via `Frame` + exporter (`ftui-extras` `export::TextExporter::ansi()`)\n    - (fallback) if we are still string-based, temporarily keep the simple colorizer until banner export lands\n\nTESTING\n- Assert the ANSI-stripped output contains all required keys.\n- Assert the embedded JSON (ANSI stripped) parses as valid JSON.\n- Assert masking is applied if any sensitive keys are present.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-06T20:55:22.653534267Z","created_by":"ubuntu","updated_at":"2026-02-06T23:39:30.260304648Z","closed_at":"2026-02-06T23:39:30.252273375Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1m6a.17","depends_on_id":"br-1m6a","type":"parent-child","created_at":"2026-02-06T20:55:22.653534267Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1m6a.17","depends_on_id":"br-1m6a.1","type":"blocks","created_at":"2026-02-06T20:55:26.883181891Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1m6a.17","depends_on_id":"br-1m6a.18","type":"blocks","created_at":"2026-02-06T22:56:33.123706223Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1m6a.18","title":"Sensitive value masking utility for console output","description":"Create a single, shared masking/sanitization utility so *all* console output (banner, tool-call panels, request panels, etc.) is safe by default.\n\nWHY\n- We must never render secrets into the terminal (bearer tokens, JWT secrets, API keys, passwords, etc.).\n- Multiple console features need this (startup banner config table, tool-call args/result panels).\n- Current `crates/mcp-agent-mail-server/src/console.rs` masking is a good start but is *not correct yet*:\n  - It masks `project_key` (bad: it is a core identity signal we want visible).\n  - It uses a non-ASCII bullet mask and includes overly-broad patterns like `auth`.\n\nCORE API (SERVER CONSOLE MODULE)\n- Keep these helpers in `crates/mcp-agent-mail-server/src/console.rs` (or a tiny sibling module imported by it).\n\n1) `fn is_sensitive_key(key: &str) -> bool`\n- Case-insensitive key matching.\n- MUST have explicit allowlist exceptions first:\n  - `project_key` MUST NOT be masked.\n  - `storage_root` MUST NOT be masked.\n- Sensitive substrings (case-insensitive):\n  - `token`, `secret`, `password`, `credential`, `bearer`, `jwt`, `api_key`, `private_key`\n- DO NOT treat `auth` as sensitive (too broad; would mask lots of safe boolean/enum fields).\n\n2) `fn mask_sensitive_value(original: &str) -> String`\n- Use an ASCII-only placeholder for maximum portability/determinism:\n  - Recommended: `<redacted>`\n- Keep it constant (do not depend on original length) to avoid width surprises.\n\n3) `fn sanitize_known_value(key: &str, value: &str) -> Option<String>`\n- Additional safety net for common non-obvious secret carriers where the *key* is not obviously sensitive:\n  - `database_url`: if value looks like `scheme://user:pass@host/...`, mask only the password segment.\n  - `*_redis_url` / `redis_url` / `http_rate_limit_redis_url`: same.\n- Return `Some(sanitized)` if a transformation is applied; else `None`.\n- Keep this conservative; prefer obvious, stable parsing over regex.\n\n4) `fn mask_json(value: &serde_json::Value) -> serde_json::Value`\n- Recursively walk objects/arrays.\n- If an object key is sensitive: replace the value with the redaction placeholder.\n- Else, recurse.\n- Also apply `sanitize_known_value()` for known keys.\n\nINTEGRATIONS (CALL SITES)\n- Tool call start/end panels (`br-1m6a.2`): mask args *before* pretty-printing; mask result previews too.\n- Startup banner config display (`br-1m6a.10`): sanitize DB/redis URLs; mask auth/bearer/JWT secrets.\n\nTESTING (UNIT)\n- `is_sensitive_key`:\n  - Positive: bearer_token, api_key, password, HTTP_BEARER_TOKEN, jwt_secret, private_key\n  - Negative: project_key, storage_root, endpoint, app_environment\n  - Case-insensitive behavior\n- `sanitize_known_value`:\n  - postgres URL with credentials -> password redacted, host preserved\n  - sqlite path -> unchanged\n- `mask_json` recursion:\n  - Nested objects + arrays\n  - Empty objects\n  - Non-string values (numbers/bools/null) under sensitive keys still redacted\n  - `project_key` remains visible (regression)\n\nPERF/SAFETY NOTES\n- This runs only when we are about to emit console output.\n- Avoid regex on the hot path; keep allocations reasonable.","notes":"Implementation note: is_sensitive_key also exact-matches authorization and auth_header as sensitive (common bearer-token carriers) while still avoiding broad auth substring masking. Tool-call end result previews are masked via JSON parse + mask_json before truncation.","status":"closed","priority":0,"issue_type":"task","assignee":"IndigoRidge","created_at":"2026-02-06T21:25:05.403325350Z","created_by":"CobaltTower","updated_at":"2026-02-06T23:27:39.967870031Z","closed_at":"2026-02-06T23:27:39.967783289Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1m6a.18","depends_on_id":"br-1m6a","type":"parent-child","created_at":"2026-02-06T21:25:05.403325350Z","created_by":"CobaltTower","metadata":"{}","thread_id":""}]}
{"id":"br-1m6a.19","title":"Console layout configuration (HUD sizing + persistence)","description":"Make the StartupDashboard console layout user-configurable, interactively adjustable, and persistable.\n\nBACKGROUND\n- Today `StartupDashboard::maybe_start()` hardcodes inline HUD sizing:\n  - `ui_height ~= term_height / 3`\n  - `UiAnchor::Bottom`\n- Users explicitly want to control how much screen is \"static HUD\" vs \"scrolling logs\":\n  - bottom 20%, bottom 50%\n  - left 30% (requires AltScreen + internal log viewer)\n\nGOALS\n- Rich HUD remains enabled by default in real TTYs (`LOG_RICH_ENABLED=true` default).\n- Config can be set via env vars and persisted to a user-local config envfile.\n- Interactive configuration is available by default for humans in HTTP mode (STDIO mode cannot steal stdin from MCP protocol).\n- Persisted settings are automatically remembered (no manual edits required).\n\nSCOPE (PHASED)\n\nPHASE 1 (P0): ENV-DRIVEN LAYOUT CONFIG (NO INTERACTIVE INPUT)\nAdd config fields to `mcp_agent_mail_core::Config` + `from_env()` parsing.\n\nInline HUD sizing:\n- `console_ui_height_percent: u16` (default 33, clamp 10..80)\n- `console_ui_anchor: ConsoleUiAnchor` (default bottom; values: bottom|top)\n- `console_ui_auto_size: bool` (default false)\n- `console_inline_auto_min_rows: u16` (default 8, clamp >= 4)\n- `console_inline_auto_max_rows: u16` (default 18, clamp >= min_rows)\n\nSplit mode config (required for \"left 30%\"):\n- `console_split_mode: ConsoleSplitMode` (default `inline`; values: inline|left)\n- `console_split_ratio_percent: u16` (default 30, clamp 10..80)\n\nConsole theme selection (FrankenTUI)\n- `CONSOLE_THEME` is defined in `br-1m6a.12` and must be persisted in the same user envfile so humans can tune the look-and-feel once and have it stick.\n  - Values: `cyberpunk_aurora|darcula|lumen_light|nordic_frost|high_contrast`\n  - Default: `cyberpunk_aurora`\n\nEnv vars:\n- `CONSOLE_UI_HEIGHT_PERCENT`\n- `CONSOLE_UI_ANCHOR`\n- `CONSOLE_UI_AUTO_SIZE`\n- `CONSOLE_INLINE_AUTO_MIN_ROWS`\n- `CONSOLE_INLINE_AUTO_MAX_ROWS`\n- `CONSOLE_SPLIT_MODE`\n- `CONSOLE_SPLIT_RATIO_PERCENT`\n- `CONSOLE_THEME`\n\nServer integration (`crates/mcp-agent-mail-server/src/lib.rs`):\n- If `console_split_mode=inline`:\n  - If `console_ui_auto_size=false`: `ScreenMode::Inline { ui_height }`\n  - Else: `ScreenMode::InlineAuto { min_height, max_height }`\n  - Anchor uses `UiAnchor::{Bottom,Top}`\n- If `console_split_mode=left`:\n  - Use `ScreenMode::AltScreen` and delegate rendering to `br-1m6a.20` (log viewer + left HUD).\n\nBanner/HUD discoverability:\n- Add a single plain-text line describing the active console layout config:\n  - e.g. `Console: inline bottom 33%` / `Console: inline_auto top 8..18 rows` / `Console: left 30% (alt-screen)`\n  - E2E must assert on this line (no parsing of control sequences).\n\nPHASE 2 (P1): INTERACTIVE CONFIG (HTTP MODE ONLY)\nThis must be available by default for humans (TTY + HTTP mode), and safe in CI.\n\nGATING\n- Only enable interactive config when:\n  - HTTP server mode\n  - `stdin.is_terminal()==true`\n  - `config.log_rich_enabled==true`\n- Provide an env override:\n  - `CONSOLE_INTERACTIVE=0` disables\n  - `CONSOLE_INTERACTIVE=1` forces enable (even if we later default it on)\n\nKEYBINDINGS (MINIMUM)\n- `+` / `Up`: increase `console_ui_height_percent` by 5\n- `-` / `Down`: decrease by 5\n- `t` / `b`: toggle anchor top/bottom\n- `a`: toggle inline auto-size\n- `[` / `]`: decrease/increase `console_split_ratio_percent` by 5 (when in left split)\n- `i`: switch to inline mode\n- `l`: switch to left split mode\n- `?`: toggle a help overlay (shows current values + keys)\n\nAPPLYING CHANGES\n- Inline height/anchor changes should apply live.\n- Switching `console_split_mode` may require recreating the `TerminalWriter` (drop + re-init). If live switching is too risky initially:\n  - persist the new mode and show a toast/log line \"Restart required to apply console mode change\".\n\nPERSISTENCE (AUTO-REMEMBER SETTINGS)\n- Persist to a user-local envfile (NOT repo `.env`):\n  - default: `~/.config/mcp-agent-mail/config.env`\n  - override: `CONSOLE_PERSIST_PATH=/path/to/file`\n- Read this envfile at startup so console settings apply automatically:\n  - For `CONSOLE_*` keys: precedence `real env > persisted user envfile > defaults`\n  - Do NOT fall back to working-directory `.env` for `CONSOLE_*` keys (avoid repo contamination)\n- File format: `KEY=value` lines (envfile style) so the existing config loader can ingest it.\n- Auto-save by default:\n  - `CONSOLE_AUTO_SAVE` (default true)\n  - Save ONLY the console-related keys (including `CONSOLE_THEME`).\n  - Preserve unrelated lines/comments when updating an existing file.\n\nTESTING\n- Unit tests (core config): parsing, clamping, defaults.\n- Unit tests (server): percent->rows mapping for small terminals; anchor mapping.\n- Unit tests (persistence): envfile update is idempotent and preserves unrelated content.\n- Unit tests (interactive): factor key->state updates into a pure helper so we can test each keybinding without needing raw-mode PTY input.\n- E2E (`br-1m6a.15`): start server with layout env vars and assert banner reports active layout.\n\nNOTES\n- STDIO mode must never start an input reader thread.","status":"closed","priority":0,"issue_type":"task","assignee":"CobaltTower","created_at":"2026-02-06T21:25:32.023878914Z","created_by":"CobaltTower","updated_at":"2026-02-06T23:48:46.020572657Z","closed_at":"2026-02-06T23:48:46.020545025Z","close_reason":"Completed: CONSOLE_* layout config + persistence + interactive keybindings + unit tests","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1m6a.19","depends_on_id":"br-1m6a","type":"parent-child","created_at":"2026-02-06T21:25:32.023878914Z","created_by":"CobaltTower","metadata":"{}","thread_id":""}]}
{"id":"br-1m6a.2","title":"Tool call start/end logging panels with syntax highlighting","description":"Upgrade per-tool-call console logging to be FrankenTUI-native and parity-aligned with the legacy Python `rich_logger.py` tool panels.\n\nCURRENT STATE\n- Tool-call start/end panels already exist in `crates/mcp-agent-mail-server/src/console.rs`:\n  - `render_tool_call_start()`\n  - `render_tool_call_end()`\n- They are currently hand-built with raw ANSI escape codes and simplistic JSON coloring.\n- `dispatch_inner(\"tools/call\")` in `crates/mcp-agent-mail-server/src/lib.rs` emits these panels, but does not yet consistently respect the intended config gates.\n\nGATING (ALL MUST PASS)\n- `config.log_rich_enabled == true` (default true)\n- `stdout.is_terminal() == true`\n- `config.tools_log_enabled == true` (env `TOOLS_LOG_ENABLED`, default true)\n- `config.log_tool_calls_enabled == true` (env `LOG_TOOL_CALLS_ENABLED`, default should become true via `br-1m6a.16`)\n\nSTART PANEL (tool-call-start)\n- Title: TOOL name + timestamp + project/agent hints.\n- \"Input Parameters\" section:\n  - Pretty JSON (2-space indent)\n  - Apply masking first using `br-1m6a.18`.\n  - Syntax highlight JSON using `ftui-extras` `syntax` (preferred):\n    - `SyntaxHighlighter::highlight(..., \"json\")`\n- Route output:\n  - If StartupDashboard is active: write to scrollback via `dashboard_write_log()`.\n  - Else: `ftui_runtime::ftui_println!()`.\n\nEND PANEL (tool-call-end)\n- Rule separator color-coded by status.\n- Summary line/table:\n  - Tool, Project, Agent, Duration, Status\n  - Query summary: total queries + total query time (from per-call tracker when instrumentation enabled)\n- Duration tier styling:\n  - <50ms: bright green (fast)\n  - <100ms: green\n  - <500ms: yellow\n  - <1000ms: bright yellow\n  - >=1000ms: red\n- Result preview:\n  - JSON pretty + syntax highlight (success)\n  - Structured error object (failure)\n  - Truncate BOTH args/result using `config.log_tool_calls_result_max_chars` (default 2000 via `br-1m6a.16`).\n\nQUERY STATS\n- Keep the current per-tool-call tracker approach in `lib.rs`:\n  - Create a fresh `QueryTracker`, `enable()` it, set it as the active tracker for the call.\n  - At end, snapshot for totals/time.\n- Detailed per-table breakdown panel is handled by `br-1m6a.6`.\n\nIMPLEMENTATION DIRECTION\n- Prefer rendering panels with real `ftui` widgets into an offscreen `Frame` and exporting to ANSI (via `ftui-extras` `export::TextExporter::ansi()` once added as a dependency).\n  - This removes fragile width/ANSI math.\n- Keep the hot path cheap:\n  - If gated off, avoid JSON cloning/pretty-printing.\n\nTESTING\n- Unit tests for gating:\n  - `LOG_RICH_ENABLED=false` suppresses panels.\n  - `TOOLS_LOG_ENABLED=false` suppresses panels.\n  - `LOG_TOOL_CALLS_ENABLED=false` suppresses panels.\n- Unit tests for truncation using config limit.\n- Unit tests verifying masking helper is applied to args/result JSON.\n- Snapshot-ish tests for panel structure (headers present) with ANSI-stripping normalization.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-06T20:52:00.153922469Z","created_by":"ubuntu","updated_at":"2026-02-06T23:39:30.253949322Z","closed_at":"2026-02-06T23:39:30.252273375Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1m6a.2","depends_on_id":"br-1m6a","type":"parent-child","created_at":"2026-02-06T20:52:00.153922469Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1m6a.2","depends_on_id":"br-1m6a.18","type":"blocks","created_at":"2026-02-06T21:25:55.144745410Z","created_by":"CobaltTower","metadata":"{}","thread_id":""}]}
{"id":"br-1m6a.20","title":"Alt-screen left split console: HUD + LogViewer log pane","description":"Implement the \"left 30%\" style console layout: a two-pane, AltScreen dashboard where the HUD is static on the left and a scrollable/searchable log viewer lives on the right.\n\nWHY\n- Inline mode preserves terminal scrollback, but it cannot do a true left/right HUD vs log split.\n- Users explicitly want layouts like \"left 30%\" and want to configure this interactively.\n\nCONFIG / INPUTS\n- Uses layout config from `br-1m6a.19`:\n  - `CONSOLE_SPLIT_MODE=left`\n  - `CONSOLE_SPLIT_RATIO_PERCENT` (e.g., 30)\n\nGATING\n- Only engage split mode when ALL are true:\n  - `config.log_rich_enabled == true`\n  - `stdout.is_terminal() == true`\n  - running in HTTP server mode (stdio mode cannot safely run an interactive UI loop)\n\nCORE UI (ALTSCREEN)\n- Use `ftui::ScreenMode::AltScreen` for the dashboard writer.\n- Render a 2-column layout:\n  1) Left pane: existing HUD (reuse `render_dashboard_frame` or a factored-out HUD widget)\n  2) Right pane: a real log viewer widget (see below)\n\nLOG VIEWER (USE FRANKENTUI WIDGET)\n- Do NOT hand-roll a bespoke scroll/search UI.\n- Use `ftui_widgets::log_viewer::{LogViewer, LogViewerState}`.\n  - Demo reference: `/dp/frankentui/crates/ftui-demo-showcase/src/screens/log_search.rs`\n- Behavior:\n  - Follow mode on by default (tail -f semantics)\n  - `/` opens search bar\n  - `n` / `N`: next/prev match\n  - `f`: filter toggle (show only matching lines)\n  - Up/Down/PageUp/PageDown: scroll\n  - End: jump to latest\n  - `?`: help overlay\n\nLOG ROUTING (CRITICAL)\n- In AltScreen mode, `TerminalWriter::write_log()` is a no-op.\n- Therefore ALL \"console log lines\" must be routed into an in-memory buffer that the log viewer renders.\n- Proposed approach:\n  - Add a `DashboardLogSink` abstraction owned by `StartupDashboard`:\n    - Inline mode: sink writes to `TerminalWriter::write_log()`.\n    - AltScreen mode: sink appends to a ring buffer feeding `LogViewerState`.\n  - Update all call sites that currently call `dashboard_write_log()` so they work in both modes.\n\nINTERACTION\n- Read key input from `/dev/tty` (preferred) or stdin.\n- Only enable interactive input in HTTP mode + TTY.\n- Keybindings for layout should interoperate with `br-1m6a.19` (ratio adjust, toggle help, etc.).\n\nPERF\n- Keep last N lines (e.g., 5_000) to bound memory.\n- Avoid expensive ANSI parsing on every render; store both raw and ANSI-stripped if needed.\n\nTESTING (UNIT)\n- Ratio -> column width calculation + clamp.\n- Log ring buffer push/overflow.\n- LogViewer state transitions for:\n  - append + follow mode\n  - search open/close\n  - filter toggle\n  - scroll bounds\n\nE2E (HOOK INTO `br-1m6a.15`)\n- Start server with `CONSOLE_SPLIT_MODE=left` + ratio.\n- Assert the startup output includes the plain line `Console: left 30% (alt-screen)` (or similar) so tests dont need to parse alt-screen control codes.\n\nNOTES\n- Default remains inline HUD + scrollback. Left split is opt-in.","status":"closed","priority":0,"issue_type":"task","assignee":"RubyPrairie","created_at":"2026-02-06T21:50:26.959533778Z","created_by":"ubuntu","updated_at":"2026-02-07T00:15:04.744630382Z","closed_at":"2026-02-07T00:15:04.744534964Z","close_reason":"Implemented alt-screen split layout: LogPane wrapper in console.rs, split_columns calculator, render_split_frame two-pane renderer. Wired into lib.rs: StartupDashboard.log_pane, AltScreen mode in compute_writer_settings, log_line routing to ring buffer, render_now split path, handle_log_pane_key with scroll/search/follow bindings. Fixed 6 clippy warnings from br-1m6a.7 code. Committed dbf52f1.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1m6a.20","depends_on_id":"br-1m6a","type":"parent-child","created_at":"2026-02-06T21:50:26.959533778Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1m6a.20","depends_on_id":"br-1m6a.19","type":"blocks","created_at":"2026-02-06T21:50:40.815547045Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1m6a.21","title":"Command palette for console actions + layout tuning","description":"Add a FrankenTUI command palette to the rich console so users can discover and execute console actions (layout tuning, theme switching, toggles, copy links) without memorizing keybindings.\n\nWHY\n- We are adding many interactive console behaviors (layout config, log search, follow mode, filters). A command palette makes this discoverable and slick.\n- FrankenTUI already ships a high-quality `CommandPalette` widget with deterministic matching modes and evidence tracking.\n  - Demo reference: `/dp/frankentui/crates/ftui-demo-showcase/src/screens/command_palette_lab.rs`\n\nSCOPE\n- Implement the palette initially for AltScreen mode (`br-1m6a.20`) where we already have an event loop.\n- Optional stretch: expose a minimal palette overlay in Inline mode too (only if safe).\n\nUX\n- Open palette with `Ctrl+P` (and `:` as an alternate).\n- Palette shows:\n  - action title\n  - short hint / keybinding (if any)\n  - optional category (Layout / Theme / Logs / Tools / Help)\n- Palette supports:\n  - prefix/substring/fuzzy matching\n  - deterministic ordering (stable tests)\n\nACTIONS (MINIMUM)\nLayout:\n- Switch console mode: `inline`, `left split`\n- Set split ratio: 20/30/40/50\n- Increase/decrease HUD height percent (inline mode)\n- Toggle anchor top/bottom\n- Toggle inline auto-size\n- Persist console settings now (writes `CONSOLE_*` keys to the user envfile from `br-1m6a.19`)\n\nTheme (from `br-1m6a.12`):\n- Cycle theme\n- Set theme: `cyberpunk_aurora|darcula|lumen_light|nordic_frost|high_contrast`\n\nLogs:\n- Toggle follow mode (log viewer)\n- Open search (`/`)\n- Toggle filter-only-matches\n- Clear log buffer (optional)\n\nTool panels (runtime toggles):\n- Toggle `LOG_TOOL_CALLS_ENABLED`\n- Toggle `TOOLS_LOG_ENABLED`\n\nHelp:\n- Show keybindings overlay\n- Show current config summary (sanitized)\n\nPERSISTENCE / SAFETY\n- Persistence is enabled by default when `CONSOLE_AUTO_SAVE=true` (from `br-1m6a.19`).\n- Writes MUST go to the user envfile:\n  - default: `~/.config/mcp-agent-mail/config.env`\n  - override: `CONSOLE_PERSIST_PATH=/path/to/file`\n- MUST NOT write to repo `.env`.\n- Persist ONLY `CONSOLE_*` keys (layout + `CONSOLE_THEME`). Do not silently persist unrelated server config.\n\nIMPLEMENTATION\n- Add `ConsoleCommandPalette` state struct owned by the console runtime in AltScreen mode.\n- Use `ftui_widgets::command_palette::{CommandPalette, ActionItem}`.\n- On action selection:\n  - update in-memory console state (apply live if possible)\n  - if `CONSOLE_AUTO_SAVE=true`, persist via `mcp_agent_mail_core::config::update_envfile()`\n  - show a confirmation toast (`br-1m6a.4`) or a one-line log fallback\n\nTESTING\n- Unit test action dispatch mapping (selecting action updates expected config fields).\n- Unit test stable ordering of action list.\n- Unit test persistence writes only `CONSOLE_*` keys.\n- Render smoke test (no panic) for palette open/closed.\n\nNOTES\n- This bead is about console UX only; it must not change server semantics.","notes":"Implementation refinement (ftui demo: crates/ftui-demo-showcase/src/screens/command_palette_lab.rs)\n- Use `ftui_widgets::command_palette::{CommandPalette, ActionItem, MatchFilter}` directly; avoid custom fuzzy logic.\n- Enable evidence tracking in dev/test builds (`palette.enable_evidence_tracking(true)`) so we can debug ranking deterministically (and assert on evidence if needed).\n- Match modes: consider cycling `MatchFilter::{All,Exact,Prefix,WordStart,Substring,Fuzzy}` via a key (like `Ctrl+M`) in AltScreen for easy tuning; keep default `Fuzzy`.\n- Action IDs should be stable strings (e.g. `layout.inline`, `layout.split_left`, `logs.follow_toggle`, `tools.log_tool_calls_toggle`) so persistence/tests can target them.\n- Determinism: action list ordering should be stable before matching (sort by category then title, tie-break by id) so tests do not depend on hash iteration.\n- Optional but slick: expose a small \"evidence ledger\" side panel for the currently highlighted action (toggle with `Ctrl+E`) mirroring the demo; helpful when tuning the palette.\n\nUser-facing UX requirements\n- Palette is the discoverability surface for interactive console configuration:\n  - layout ratio and HUD height must be adjustable from the palette (not only hidden keybindings)\n  - include \"Reset layout to defaults\" and \"Reset theme to default\" actions\n- Auto-persist by default:\n  - if `CONSOLE_AUTO_SAVE=true` (default), any layout/theme-changing action should persist immediately\n  - keep an explicit \"Persist now\" action for `CONSOLE_AUTO_SAVE=false`\n- Keep a small confirmation toast/log line after any action that changes layout/theme:\n  - include the new value (e.g. \"Split ratio: 30% (saved)\")\n\nE2E hook ideas (optional but high value)\n- Under `AM_E2E_INTERACTIVE=1`, drive a real PTY:\n  - open palette (`Ctrl+P`), type a query (e.g. `split 30`), hit Enter\n  - assert `CONSOLE_SPLIT_RATIO_PERCENT=30` written to `CONSOLE_PERSIST_PATH`\n  - assert a confirmation toast/line is present (after ANSI/OSC normalization)\n\nTest ideas\n- Pure unit tests for action dispatch: selecting action id mutates the expected in-memory state + persisted envfile (only `CONSOLE_*` keys) when enabled.\n- Snapshot-ish tests on stripped output: opening palette renders a stable title + at least N action rows (no exact spacing).\n- If evidence ledger implemented: assert evidence entries are non-empty for a fuzzy query like `log` and ordering is stable.","status":"closed","priority":1,"issue_type":"task","assignee":"RubyPrairie","created_at":"2026-02-06T21:53:23.492545480Z","created_by":"ubuntu","updated_at":"2026-02-07T00:15:56.115687671Z","closed_at":"2026-02-07T00:15:56.115647546Z","close_reason":"Implemented command palette: ConsoleCommandPalette in console.rs with 25 actions across 5 categories (Layout, Theme, Logs, Tools, Help). Wired into lib.rs: Ctrl+P/:  opens palette, full event routing, dispatch_palette_action for layout changes, theme switching via ftui_extras, log pane controls, runtime tool logging toggles. Extracted persist_console_settings(). 9 unit tests. Committed d601d55.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1m6a.21","depends_on_id":"br-1m6a","type":"parent-child","created_at":"2026-02-06T21:53:23.492545480Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1m6a.21","depends_on_id":"br-1m6a.19","type":"blocks","created_at":"2026-02-06T21:53:30.598012784Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1m6a.21","depends_on_id":"br-1m6a.20","type":"blocks","created_at":"2026-02-06T21:53:30.495288156Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1m6a.22","title":"Structured event timeline view (AltScreen)","description":"Add an AltScreen-only structured event timeline view (filters + details) so Agent Mail feels like an observability cockpit, not just a wall of logs.\n\nWHY\n- Logs are useful, but a structured timeline makes it instantly clear what happened: tool calls, messages, conflicts, ack escalations, etc.\n- FrankenTUI has a strong reference implementation for an event stream viewer.\n  - Demo reference: `/dp/frankentui/crates/ftui-demo-showcase/src/screens/action_timeline.rs`\n\nSCOPE\n- AltScreen mode only (build on `br-1m6a.20`).\n- Timeline is a *view* over the same internal events we already emit as log lines.\n\nDATA MODEL\n- Introduce a small internal `ConsoleEvent` struct (server crate) with:\n  - `ts` (monotonic sequence or ISO timestamp)\n  - `kind` (tool_call_start/tool_call_end/http_request/message_sent/reservation_conflict/etc)\n  - `severity` (info/warn/error)\n  - `summary` (short)\n  - `fields: Vec<(String,String)>` (sanitized)\n  - optional `json: serde_json::Value` (sanitized)\n\nBUFFER\n- Bounded ring buffer (e.g., last 500 events) stored in `StartupDashboard` so it is available to UI render.\n\nUI\n- Split right pane into:\n  - Timeline list with filters (severity/kind/project/agent)\n  - Detail panel showing sanitized fields + optional pretty JSON (syntax highlighted)\n- Navigation:\n  - Up/Down select\n  - Enter toggles detail focus\n  - `f` cycles filters\n  - `/` search summaries\n  - `?` help overlay\n\nINTEGRATION\n- Emit `ConsoleEvent` alongside existing log lines in these code paths:\n  - tools/call start/end\n  - request panel emission\n  - send/reply/handshake tools\n  - file reservation conflict detection\n- Always sanitize via `br-1m6a.18` before storing.\n\nCOMMAND PALETTE\n- Add a palette action (from `br-1m6a.21`) to toggle the right pane between:\n  - Log Viewer\n  - Event Timeline\n\nTESTING\n- Unit tests for ring buffer overflow + stable ordering.\n- Unit tests for filter logic.\n- Render smoke test (no panic) for empty timeline.\n\nNOTE\n- This is a polish/showcase feature (P2). It should not block core parity work.","notes":"Implementation refinement (ftui demo: crates/ftui-demo-showcase/src/screens/action_timeline.rs)\n- Model the timeline as a bounded `VecDeque<ConsoleEvent>` (MAX_EVENTS ~500) plus UI state: `selected`, `scroll_offset`, `follow`, `show_details`, and filter toggles.\n- Filtering should be applied as a view over the ring buffer (do not duplicate events); selection should clamp and follow mode should keep the latest selected.\n- Keep event IDs monotonic (`next_id: u64`) for stable ordering and debug.\n- Consider severity/kind filters cycling like the demo (single-key cycles through enums + None).\n- Details panel: show `summary`, `fields`, and (if present) a pretty JSON block; syntax highlight with the active themes syntax theme.\n- Event ingestion: emit structured events at the same points we already log; store sanitized fields only (masking + known-key sanitization).\n\nUX integration notes\n- Timeline view switching must be discoverable via the command palette (`br-1m6a.21`) and should not introduce keybinding conflicts with the LogViewer search UX.\n- Keep all stored fields sanitized at ingestion time so the detail panel cannot leak secrets even if rendered verbatim.\n\nTest ideas\n- Ring buffer eviction: pushing MAX_EVENTS+N keeps newest, preserves ordering by id.\n- Filter logic: each filter reduces the visible set correctly; search over summaries respects case-insensitivity.\n- Follow mode: when enabled, selection moves to newest event after append; when disabled, selection stays put.\n- Render smoke tests: empty timeline, one-event timeline, and narrow widths should not panic.","status":"closed","priority":2,"issue_type":"task","assignee":"RubyPrairie","created_at":"2026-02-06T21:53:48.030861146Z","created_by":"ubuntu","updated_at":"2026-02-07T01:19:15.027065276Z","closed_at":"2026-02-07T01:19:15.027040219Z","close_reason":"All code implemented by CobaltTower in commit 47b6fcc. RightPaneView enum, event emission, Tab toggle, palette action, 20+ unit tests.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1m6a.22","depends_on_id":"br-1m6a","type":"parent-child","created_at":"2026-02-06T21:53:48.030861146Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1m6a.22","depends_on_id":"br-1m6a.18","type":"blocks","created_at":"2026-02-06T21:53:53.751535168Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1m6a.22","depends_on_id":"br-1m6a.20","type":"blocks","created_at":"2026-02-06T21:53:53.543676485Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1m6a.22","depends_on_id":"br-1m6a.21","type":"blocks","created_at":"2026-02-06T21:53:53.646735640Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1m6a.23","title":"Console capabilities + discoverability (banner + help)","description":"Add a clear, FrankenTUI-native \"Console Capabilities\" + discoverability block so users instantly understand what terminal features are active (and why something may not be working).\n\nWHY\n- We lean hard on terminal features (AltScreen split, OSC-8 hyperlinks, mouse scroll, palette, log search). When something doesn't work, users need a single place to confirm whether it is a terminal limitation vs config.\n- FrankenTUI already has strong capability detection and an evidence-ledger model.\n  - Demo reference: `/dp/frankentui/crates/ftui-demo-showcase/src/screens/terminal_capabilities.rs`\n\nSCOPE\n- Rich console only (TTY + `LOG_RICH_ENABLED=true`).\n- Add:\n  1) A small startup banner section: \"Console Capabilities\".\n  2) The `?` help overlay (inline + AltScreen) should include the same capabilities plus the key discovery hints (`Ctrl+P` palette, `/` search in LogViewer, `?` help).\n  3) A grep-friendly, stable-format one-liner for tests/debugging:\n     - `ConsoleCaps: tc=1 osc8=1 mouse=0 sync=1 kitty=0 focus=0`\n     - Exact numeric values may vary by terminal/CI; the *keys* and format must be stable.\n- Must be enabled by default; no user action required.\n\nIMPLEMENTATION\n- Introduce a small `ConsoleCaps` struct in the server crate, computed once at startup from FrankenTUI/terminal capability detection.\n- Use the caps to gate behavior where appropriate:\n  - OSC-8 hyperlinks: only emit when `osc8=1` (still always include raw URL text).\n  - Mouse-only UX (hover tooltips, scroll targeting): only enable when `mouse=1`.\n- Degrade gracefully:\n  - Non-TTY or `LOG_RICH_ENABLED=false`: do not emit capability panels; keep output plain/grep-friendly.\n\nTESTING\n- Unit tests:\n  - formatting of `ConsoleCaps:` line is ASCII-only and stable.\n  - caps-to-string never panics on \"unknown\" values.\n- Render/integration tests:\n  - banner contains \"Console Capabilities\" header after ANSI/OSC normalization.\n- E2E (`br-1m6a.15`):\n  - in a PTY run, assert `ConsoleCaps:` line exists (do not assert exact values; assert presence of all keys).\n\nNOTES\n- If FrankenTUI exposes an evidence ledger for caps, optionally show a compact \"why\" hint in the help overlay (not required for MVP).","notes":"E2E constraint (PTY capture)\n- The `ConsoleCaps:` one-liner needs to be emitted via a guaranteed plain-text path (stderr log line) so `script` PTY transcripts capture it even when the console switches into AltScreen.\n- Same for the split/layout summary line used by br-1m6a.15: emit it *before* entering AltScreen.\n\nImplementation hint\n- Prefer a single early emission like:\n  - `Console: split=left ratio=30% (alt-screen)`\n  - `ConsoleCaps: tc=1 osc8=1 mouse=0 sync=1 kitty=0 focus=0`\n  emitted right after capability detection and before creating the AltScreen writer.\n\nTest hook\n- br-1m6a.15 should assert presence of all ConsoleCaps keys (not values) in the normalized transcript.","status":"closed","priority":2,"issue_type":"task","assignee":"DarkMoose","created_at":"2026-02-07T00:12:08.014743363Z","created_by":"ubuntu","updated_at":"2026-02-07T01:06:32.000976724Z","closed_at":"2026-02-07T01:06:32.000944935Z","close_reason":"Implemented via commit 1eda13e (ConsoleCaps + banner + help overlay); closing bead status.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1m6a.23","depends_on_id":"br-1m6a","type":"parent-child","created_at":"2026-02-07T00:12:08.014743363Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1m6a.3","title":"Sparkline throughput trends in live HUD","description":"Improve the live HUD sparkline(s) to show real, intuitive throughput trends (and showcase FrankenTUI sparkline rendering).\n\nCURRENT STATE\n- A request sparkline already exists:\n  - `crates/mcp-agent-mail-server/src/console.rs::SparklineBuffer`\n  - Sampled every ~1200ms by `StartupDashboard::spawn_refresh_worker()`\n  - Rendered in `render_dashboard_frame()` using `ftui::widgets::sparkline::Sparkline::render_to_string()`.\n- The HUD currently labels the sparkline as `req/s` even though it is actually `req/tick` (approx).\n\nTARGET STATE\n1) Correct units + normalization\n- Normalize request counts to true `req/s` using the actual tick interval.\n  - Keep a constant `DASHBOARD_TICK_MS` (currently 1200) and compute `req_per_sec = count * 1000 / tick_ms`.\n- Display BOTH:\n  - Numeric value (e.g. `req/s: 12.5`)\n  - Sparkline visualization\n\n2) Ring buffer correctness\n- Keep exactly `SPARKLINE_CAPACITY` points without O(n) shifting.\n  - Prefer `VecDeque` or a simple circular buffer.\n\n3) Optional additional sparklines (stretch)\n- Latency trend sparkline (avg latency per tick).\n- Message throughput sparkline (send/reply counts per tick).\n\n4) Theme integration\n- Sparkline gradient should derive from the semantic theme (`br-1m6a.12`).\n\nTESTING\n- Unit test normalization math (req/tick -> req/s).\n- Unit test ring buffer bounds/overflow.\n- Unit test render does not panic for empty/all-zero data.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-06T20:52:00.254139919Z","created_by":"ubuntu","updated_at":"2026-02-06T23:39:30.255300531Z","closed_at":"2026-02-06T23:39:30.252273375Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1m6a.3","depends_on_id":"br-1m6a","type":"parent-child","created_at":"2026-02-06T20:52:00.254139919Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1m6a.4","title":"Toast notifications for important agent events","description":"Add toast notifications for important agent events, using FrankenTUI's real notification queue widgets.\n\nWHY\n- Agent Mail is event-heavy (registering agents, conflicts, releases, ack escalations). A HUD without toasts forces users to scan scrollback.\n- FrankenTUI already ships a polished notification stack with priority ordering, dedup, actions, and positioning.\n  - Demo reference: `/dp/frankentui/crates/ftui-demo-showcase/src/screens/notifications.rs`\n\nGOALS\n- Toasts are enabled by default when rich console is active in a real TTY.\n- Non-HUD / non-TTY contexts must stay grep-friendly: degrade to a plain log line (no ANSI art dumps).\n- Keep behavior testable without sleeps.\n\nIMPLEMENTATION\n1) Use FrankenTUI queue types\n- Add to `StartupDashboard`:\n  - `notifications: Mutex<ftui_widgets::notification_queue::NotificationQueue>`\n- Queue config (initial):\n  - `max_visible`: 3-4\n  - `max_queued`: 20\n  - position: `ToastPosition::TopRight` (or inside HUD area if we restrict drawing to the HUD rect)\n\n2) API surface\n- `fn push_toast(&self, toast: Toast, prio: NotificationPriority)`\n- Convenience helpers:\n  - `toast_info(msg)`, `toast_warning(msg)`, `toast_error(msg)`\n\n3) Rendering\n- In the dashboard render path, render `NotificationStack::new(&queue)` as an overlay.\n  - If overlaying over the whole terminal is not safe in Inline mode, render it inside the HUD area only.\n\n4) Non-HUD degradation\n- If no dashboard is active (stdio mode or non-TTY), toast events become plain one-line logs.\n  - Prefer `console_info/console_warning/console_error` once `br-1m6a.5` exists.\n  - Otherwise: `tracing::info!/warn!/error!` or `ftui_runtime::ftui_println!()` with plain text.\n\nEVENT HOOKS (INITIAL SET)\n- In tool dispatch/instrumentation paths, trigger toasts for:\n  - `register_agent` success: \"Agent {name} registered ({program})\"\n  - `file_reservation_paths`: conflict -> warning toast with conflict summary\n  - `force_release_file_reservation` success -> warning toast\n  - repeated server errors: if >5 errors in 10s -> error toast\n  - messaging bursts: if >20 send/reply in 5s -> info toast\n\nACTIONS (OPTIONAL, NICE-TO-HAVE)\n- For some toasts, include actions:\n  - \"Copy endpoint\" (copies URL to clipboard if available; otherwise just logs)\n  - \"Open web UI\" (only if we ever support shell-out; otherwise omit)\n\nTESTING\n- Unit tests for queue behavior (no sleeps):\n  - push respects max_queued\n  - urgent priority jumps ahead\n  - dismiss/dismiss_all behavior\n  - auto-expiry can be simulated by mutating `toast.state.created_at` to an old instant, then calling `queue.tick(...)` (no wall-clock sleeps)\n- Render smoke test: overlay render does not panic for empty/1/4 visible toasts.\n\nNOTE\n- If time-based animations make tests flaky, disable animations for our toasts (use reduced motion config) and keep assertions on structure/content only.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-06T20:52:00.360557085Z","created_by":"ubuntu","updated_at":"2026-02-06T23:39:30.256372808Z","closed_at":"2026-02-06T23:39:30.252273375Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1m6a.4","depends_on_id":"br-1m6a","type":"parent-child","created_at":"2026-02-06T20:52:00.360557085Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1m6a.5","title":"Structured log level panels (info/warn/error/success)","description":"Provide a small, consistent set of structured console log helpers (info/warn/error/success) that can be used across the server, and that integrate cleanly with the HUD scrollback (inline) and the AltScreen log viewer buffer (`br-1m6a.20`).\n\nCURRENT STATE\n- `crates/mcp-agent-mail-server/src/console.rs` contains:\n  - `ToastLevel`\n  - `render_log_panel(level, title, body)`\n- But there are no public, ergonomic helpers used across the codebase, and routing/gating is inconsistent.\n\nTARGET API (SERVER CRATE)\n- Add high-level helpers:\n  - `console_info(message: &str, details: Option<&serde_json::Value>)`\n  - `console_warning(...)`\n  - `console_error(...)`\n  - `console_success(...)`\n  - (optional) `console_message_with_metadata(...)` for richer tables\n\nRENDERING REQUIREMENTS\n- Theme-consistent (use `br-1m6a.12` semantic palette/styles).\n- If `details` is present:\n  - Apply masking/sanitization (`br-1m6a.18`) *before* pretty-printing.\n  - Pretty JSON (2-space indent) with bounded size (truncate; never dump megabytes).\n\nROUTING + GATING\n- If StartupDashboard is active:\n  - Route through the dashboard's log sink (must work for Inline scrollback AND AltScreen buffered log viewer).\n- Else: `ftui_runtime::ftui_println!()`.\n- Respect gates:\n  - If `config.log_rich_enabled==false` OR `stdout.is_terminal()==false`: degrade to a single plain line + optional compact JSON.\n\nTESTING\n- Unit tests verify:\n  - Each helper emits expected titles/headers.\n  - Details are omitted when `None`.\n  - Masking is applied when details contain sensitive keys.\n  - Output is truncated/bounded deterministically.\n  - Non-TTY / rich-disabled fallback path.\n\nNOTES\n- This bead should be used to replace scattered ad-hoc `ftui_println!` calls once stable.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-06T20:52:00.464298564Z","created_by":"ubuntu","updated_at":"2026-02-06T23:39:30.257401173Z","closed_at":"2026-02-06T23:39:30.252273375Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1m6a.5","depends_on_id":"br-1m6a","type":"parent-child","created_at":"2026-02-06T20:52:00.464298564Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1m6a.5","depends_on_id":"br-1m6a.12","type":"blocks","created_at":"2026-02-06T20:55:08.970533605Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1m6a.5","depends_on_id":"br-1m6a.18","type":"blocks","created_at":"2026-02-06T22:56:29.787644407Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1m6a.6","title":"Per-tool-call query statistics panel","description":"Add a detailed per-tool-call query statistics section to the tool-call-end console panel.\n\nCURRENT STATE\n- `dispatch_inner(\"tools/call\")` already creates a per-call `QueryTracker` when instrumentation is enabled and no active tracker exists.\n- We already pass summary stats into `console::render_tool_call_end()`:\n  - `queries` (total)\n  - `query_time_ms` (total_time_ms)\n- We also log a structured tracing event (`tool_query_stats`) with `per_table` counts.\n\nTARGET: CONSOLE PANEL SECTION (NOT TRACING)\n- Extend `crates/mcp-agent-mail-server/src/console.rs::render_tool_call_end()` to optionally include a \"Query Stats\" block.\n\nDATA SOURCE\n- Use the per-call tracker snapshot (the same data already produced by `QueryTrackerSnapshot`):\n  - `total`\n  - `total_time_ms`\n  - `per_table: HashMap<String, u64>` (counts only)\n  - `slow_queries: Vec<SlowQueryEntry>` (table + duration_ms)\n- NOTE: There is NO per-table total time; do not invent it.\n\nRENDERING\n- Only show this section when `total > 0`.\n- Content (example):\n  - Header row: `Table | Count`\n  - Top 5 rows by count desc (tie-break by table name)\n  - Total row: `Total: {total} queries in {total_time_ms}ms`\n  - Slow queries (if any): list up to N entries with `table` + `duration_ms` and show the configured threshold.\n\nGATING\n- Only render when the tool-call panel is being rendered (so it inherits the same gates as `br-1m6a.2`).\n\nTESTING\n- Snapshot diff / sorting tests:\n  - Sorting is stable and correct.\n  - Empty per_table + total=0 -> section suppressed.\n- Slow query rendering test:\n  - Includes table name and duration.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-06T20:52:40.037624363Z","created_by":"ubuntu","updated_at":"2026-02-06T23:47:04.381140663Z","closed_at":"2026-02-06T23:47:04.381112279Z","close_reason":"Implemented per-tool-call query statistics panel","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1m6a.6","depends_on_id":"br-1m6a","type":"parent-child","created_at":"2026-02-06T20:52:40.037624363Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1m6a.6","depends_on_id":"br-1m6a.2","type":"blocks","created_at":"2026-02-06T20:52:48.859957536Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1m6a.7","title":"Animated table effects on DB stats panel","description":"Showcase FrankenTUI table effects by animating the DB stats table in the live HUD.\n\nCURRENT STATE\n- The HUD DB stats panel is rendered with `ftui::widgets::table::Table` in `render_dashboard_frame()`.\n- It currently has a static style (no effects), even though `TableTheme` supports deterministic effect animation.\n\nTARGET EFFECTS\n1) Subtle always-on \"live\" pulse\n- Apply a `TableEffect::BreathingGlow` or `TableEffect::Pulse` to the DB stats header row (or the whole table) so the panel feels alive without being noisy.\n\n2) Change-highlight sweep\n- When a count value changes between ticks (e.g. messages count increases), apply a short-lived sweep/highlight effect to the affected row or cell.\n\nIMPLEMENTATION NOTES\n- Use real FrankenTUI table APIs (no custom resolvers):\n  - `ftui_style::{TableTheme, TableEffectRule, TableEffectTarget, TableEffect}`\n  - `Table::theme(theme)` + `Table::theme_phase(phase)`\n- Phase must be deterministic:\n  - Derive from dashboard tick count (e.g. `tick as f32 * 0.1`).\n- To detect changes:\n  - Store previous `DashboardDbStats` snapshot in `StartupDashboard`.\n  - Compute a per-row change bitmask each tick.\n  - Update the theme rules accordingly (or keep a small TTL counter per row).\n\nSCOPE\n- Keep effects tasteful and legible.\n- If the animation makes CI/E2E flaky, provide a config gate:\n  - `CONSOLE_EFFECTS_ENABLED` (default true in TTYs, false in CI).\n\nTESTING\n- Unit tests:\n  - Theme construction contains expected effect rules.\n  - Rendering does not panic at narrow widths.\n  - Phase increments produce different cell attrs (basic sanity).","status":"closed","priority":2,"issue_type":"task","assignee":"RubyPrairie","created_at":"2026-02-06T20:52:40.140245099Z","created_by":"ubuntu","updated_at":"2026-02-07T00:06:10.296473867Z","closed_at":"2026-02-07T00:06:10.296451735Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1m6a.7","depends_on_id":"br-1m6a","type":"parent-child","created_at":"2026-02-06T20:52:40.140245099Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1m6a.7","depends_on_id":"br-1m6a.12","type":"blocks","created_at":"2026-02-06T20:52:48.968104547Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1m6a.8","title":"Live agent activity display in HUD","description":"Add a live agent activity section to the HUD so operators can see who is active without opening the Web UI.\n\nCURRENT STATE\n- HUD shows aggregate counts (projects/agents/messages/etc) but not a list of agents.\n\nTARGET UX\n- When terminal width permits, show a compact list of the most-recently-active agents:\n  - `AgentName` (bold)\n  - `program` (dim)\n  - `last_active` (relative, e.g. `12s ago`)\n- When narrow, collapse to a single summary line (agent count + most recent agent name).\n\nDATA\n- Extend `DashboardDbStats` (or add a sibling struct) with:\n  - `agents_list: Vec<AgentSummary>`\n- Query in `fetch_dashboard_db_stats()`:\n  - `SELECT name, program, model, last_active_ts FROM agents ORDER BY last_active_ts DESC LIMIT 10`\n\nRENDERING\n- Add an \"Agents\" panel to `render_dashboard_frame()`:\n  - Prefer a `Table` or simple `Paragraph` list depending on space.\n  - Truncate safely to fit height.\n\nPERF\n- This runs on the dashboard refresh tick (currently 1200ms).\n- Keep the query cheap (limit + index on last_active_ts if needed).\n\nTESTING\n- Unit tests for render behavior:\n  - 0 agents -> panel omitted\n  - 1/5/10 agents -> renders expected rows\n  - narrow width -> graceful degradation","status":"closed","priority":2,"issue_type":"task","assignee":"RubyPrairie","created_at":"2026-02-06T20:52:40.241256939Z","created_by":"ubuntu","updated_at":"2026-02-07T00:06:22.792073695Z","closed_at":"2026-02-07T00:06:22.791992062Z","close_reason":"Implemented live agent activity display: AgentSummary struct, agents query in fetch_dashboard_db_stats, 4-column HUD layout with Agents panel, relative_time_short helper, narrow-width degradation. 7 unit tests.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1m6a.8","depends_on_id":"br-1m6a","type":"parent-child","created_at":"2026-02-06T20:52:40.241256939Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1m6a.9","title":"Web UI links section in startup banner","description":"Upgrade the existing \"Web UI\" section in the startup banner to include the full set of high-value links (Python parity + better discoverability).\n\nCURRENT STATE\n- `crates/mcp-agent-mail-server/src/console.rs::render_startup_banner()` already renders a \"Web UI\" box.\n- It currently prints only the main `/mail` URL + a single tip line.\n\nTARGET LINKS (IN THE BANNER)\n- Main UI: `http://{host}:{port}/mail`\n- Unified inbox: `http://{host}:{port}/mail/unified-inbox`\n- Archive guide: `http://{host}:{port}/mail/archive/guide`\n- Template/pattern: `/mail/{project}/inbox/{agent}`\n\nCLICKABLE LINKS (OPTIONAL)\n- If terminal supports OSC-8 hyperlinks, wrap the first 3 URLs as clickable links.\n  - Use `TerminalCapabilities::detect().osc8_hyperlinks` (available via the dashboard writer) or a conservative env override.\n- Always include the raw URL text so logs remain useful when hyperlinks are unsupported.\n\nSCOPE BOUNDARY\n- This is banner-only (no server route changes).\n\nTESTING\n- Banner unit test asserts all URLs/pattern lines are present.\n- If OSC-8 is emitted, test should assert the URL text is still present even after stripping OSC sequences.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-06T20:52:40.345197470Z","created_by":"ubuntu","updated_at":"2026-02-06T23:39:30.258401005Z","closed_at":"2026-02-06T23:39:30.252273375Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1m6a.9","depends_on_id":"br-1m6a","type":"parent-child","created_at":"2026-02-06T20:52:40.345197470Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1m6a.9","depends_on_id":"br-1m6a.1","type":"blocks","created_at":"2026-02-06T20:52:49.877162660Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1nh","title":"Share: scrub snapshot presets + secret regex","description":"## Objective\nImplement share pipeline Step 3: `scrub_snapshot` with legacy presets and secret redaction.\n\n## Scope\n- Presets: `standard`, `strict`, `archive` with exact flags (redact_body, drop_attachments, scrub_secrets, clear_ack_state, clear_recipients, clear_file_reservations, clear_agent_links).\n- Secret regex patterns (GH tokens, slack, sk, bearer, JWT, etc.) replaced with `[REDACTED]`.\n- Attachment metadata scrub: remove keys (download_url, headers, authorization, signed_url, bearer_token).\n- Body redaction for strict: replace with `\"[Message body redacted]\"`.\n- Return `ScrubSummary` with counts (agents_total, ack_flags_cleared, recipients_cleared, etc.).\n\n## Tests\n- Unit tests for each preset and regex redaction.\n- Integration tests on seeded snapshot DB with attachments and secrets.\n\n## Logging/Artifacts\n- Save scrub summary JSON and diffs under `tests/artifacts/share/scrub/<timestamp>/`.\n\n## Acceptance Criteria\n1. Preset behavior matches legacy exactly (counts + outputs).\n2. Secret patterns are redacted without altering nonsecrets.\n3. Attachments scrubbed per key list with correct counts.","status":"closed","priority":1,"issue_type":"task","assignee":"PearlOwl","created_at":"2026-02-05T16:15:20.358844765Z","created_by":"ubuntu","updated_at":"2026-02-06T06:53:02.704668583Z","closed_at":"2026-02-06T06:53:02.704649176Z","close_reason":"Implemented scrub_snapshot presets + secret regex + attachment metadata scrubbing; conformance fixtures pass","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1nh","depends_on_id":"br-1uf","type":"parent-child","created_at":"2026-02-05T16:15:23.418674217Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1r9v","title":"Console layout config: HUD sizing + persistence","description":"Add interactive console layout configuration allowing users to control HUD size/position vs scrolling log output, with automatic persistence.\n\nUSER NEED:\n- Configure how much screen real estate the static HUD occupies vs the scrolling log.\n  - Examples: bottom 20%, bottom 50%.\n- Do this interactively and have settings remembered.\n\nDEFAULTS (must be great out-of-the-box):\n- Rich HUD starts automatically in a real TTY when `LOG_RICH_ENABLED=true` (default).\n- Default HUD size is ~33% of terminal height, anchored bottom.\n\nCONFIGURABLE SETTINGS (env vars + persisted user config):\n1) `CONSOLE_UI_HEIGHT_PERCENT`: u8 (10-80, default 33)\n   - Maps to: `ui_height = (term_height * pct / 100).max(8).min(term_height - 2)`\n\n2) `CONSOLE_UI_ANCHOR`: enum {bottom, top} (default bottom)\n   - Maps to `ftui::UiAnchor`\n\n3) `CONSOLE_UI_AUTO_SIZE`: bool (default false)\n   - When true: use `ScreenMode::InlineAuto { min_height, max_height }` instead of fixed.\n\n4) `CONSOLE_AUTO_SAVE`: bool (default true)\n   - When true, interactive adjustments persist immediately.\n\nPERSISTENCE FILE:\n- `~/.config/agent-mail/console.toml`\n  - Priority: env vars > console.toml > defaults\n  - Saving should preserve stable formatting (dont churn on every save).\n\nINTERACTIVE ADJUSTMENT:\n- HTTP server mode only (stdio mode uses stdin for MCP protocol).\n- Spawn a lightweight `/dev/tty` (or stdin) reader thread when running in a real TTY:\n  - Up / '+': increase `ui_height_percent` by 5 (max 80)\n  - Down / '-': decrease `ui_height_percent` by 5 (min 10)\n  - 't'/'b': toggle anchor top/bottom\n  - 'a': toggle auto-size\n  - 's': force-save settings\n  - 'q': disable interactive adjustments for this run\n- HUD should display a subtle, dim hint line when interactive mode is active:\n  - `+/- resize | t/b anchor | a autosize | s save`\n\nINTEGRATION NOTES:\n- Left/right splits (\"left 30%\") require AltScreen + an internal log viewer.\n  - Thats implemented separately in `br-1m6a.19`.\n\nIMPLEMENTATION:\n- Add config fields to `mcp_agent_mail_core::Config` + `from_env()` parsing.\n- Add load/save for `console.toml` (no new global config system; just this file).\n- Modify `StartupDashboard::maybe_start()` to use configured values instead of hardcoded 1/3.\n\nTESTING:\n- Config loading priority (env > file > defaults)\n- `ui_height` calculation + clamp behavior\n- Anchor parsing fallback\n- Save/load roundtrip for console.toml\n- Interactive key handling logic (unit test the state machine; no real tty required)\n\nACCEPTANCE:\n- Users can resize HUD interactively in HTTP mode and it persists.\n- Defaults remain enabled and sane with zero config.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-06T21:18:52.502187876Z","created_by":"ubuntu","updated_at":"2026-02-06T21:38:30.839103222Z","closed_at":"2026-02-06T21:38:30.839080589Z","close_reason":"Duplicate of br-1m6a.19 (merged console layout plan there).","source_repo":".","compaction_level":0,"original_size":0}
{"id":"br-1s7u","title":"CLI projects integration: slug lookup + discovery-init no-product behavior","description":"Add integration tests for:\\n- projects adopt using slug identifiers (dry-run success path)\\n- projects discovery-init without --product should omit product_uid line\\n\\nTest-only scope.","status":"closed","priority":1,"issue_type":"task","assignee":"IvoryBarn","created_at":"2026-02-06T19:55:54.491383119Z","created_by":"ubuntu","updated_at":"2026-02-06T19:56:21.006010385Z","closed_at":"2026-02-06T19:56:21.005982523Z","close_reason":"Completed: added slug-identifier and discovery-init-no-product integration tests","source_repo":".","compaction_level":0,"original_size":0}
{"id":"br-1t0e","title":"Resources: file_reservations resource should be bounded (avoid glob explosion)","description":"## Problem\n`resource://file_reservations/{slug}` currently expands glob patterns via filesystem enumeration and may run `git log` over many pathspecs. On large projects with broad patterns (e.g. `src/**`), this can take >60s and effectively wedges the MCP server (subsequent tool/resource calls time out).\n\n## Objective\nMake `resource://file_reservations/{slug}` reliably fast and non-blocking for large repos while keeping legacy output shape.\n\n## Scope\n- Avoid enumerating all filesystem matches for glob patterns.\n- Compute git activity without expanding to thousands of explicit paths (use git pathspec/glob or prefix-based strategy).\n- Bound work per pattern (time/size caps) and fail open by returning `null` activity timestamps when exceeding caps.\n- Ensure cleanup logic (TTL expiry + stale release) cannot monopolize the server request thread.\n\n## Tests\n- Unit tests covering glob-heavy patterns (`src/**`, `crates/**`, `**/*.rs`) ensure the code path does not enumerate full repo trees (use a temp dir with many files to assert completes quickly).\n- Regression test: resource handler completes within a small time budget under a synthetic repo with many files and a broad glob reservation.\n\n## Acceptance Criteria\n1. `resource://file_reservations/...` returns within a bounded time on large repos (no tool server wedge).\n2. Output shape remains compatible (fields present, timestamps may be null when capped).\n3. Existing conformance tests still pass; add targeted tests for the new caps.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-06T06:13:05.771837055Z","created_by":"ubuntu","updated_at":"2026-02-06T06:29:19.745259737Z","closed_at":"2026-02-06T06:29:19.745241343Z","close_reason":"Avoid glob explosion in resource://file_reservations: stop filesystem glob expansion; use git pathspec glob magic; add regression test; ran fmt+clippy+test.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1t0e","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-06T06:13:34.586726901Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1uf","title":"Share/Export Pipeline Parity (Static Bundle)","description":"## Objective\nImplement the full **Share/Export pipeline** (static bundle) as specified in `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md` (Share/Export section). This includes DB snapshotting, scrub presets, search indexes, viewer assets, bundle scaffolding, signing/encryption, and deterministic ZIP packaging.\n\n## Scope (15 Steps)\n1. create_sqlite_snapshot\n2. apply_project_scope\n3. scrub_snapshot (presets + secret regex)\n4. build_search_indexes (FTS5)\n5. build_materialized_views\n6. create_performance_indexes\n7. finalize_snapshot_for_export\n8. bundle_attachments\n9. maybe_chunk_database\n10. copy_viewer_assets\n11. export_viewer_data\n12. write_bundle_scaffolding\n13. sign_manifest\n14. encrypt_bundle\n15. package_directory_as_zip\n\n## Tests\n- Unit tests per step for deterministic behavior.\n- Integration tests for endtoend export/update flows.\n- E2E coverage via `br-2ei.9.4`.\n\n## Logging/Artifacts\n- Share pipeline artifacts under `tests/artifacts/share/<timestamp>/`.\n- JSON summaries + diffs for each step.\n\n## Acceptance Criteria\n1. All steps are implemented per spec with legacy parity.\n2. Deterministic bundles (stable hashes) are enforced in tests.\n3. E2E share/export suite passes with detailed artifacts.","status":"closed","priority":1,"issue_type":"epic","assignee":"PearlOwl","created_at":"2026-02-05T16:14:52.252531998Z","created_by":"ubuntu","updated_at":"2026-02-06T06:53:02.785687923Z","closed_at":"2026-02-06T06:53:02.767320259Z","close_reason":"All 15 share/export pipeline steps implemented and covered by deterministic/conformance tests; unblocking downstream CLI/e2e work","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1uf","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T16:14:56.877509340Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1uvp","title":"CLI mark-identity integration: default commit path in git repo","description":"Add integration test proving  default behavior commits marker file when run in a git repo. Assert commit subject and marker presence.","status":"closed","priority":1,"issue_type":"task","assignee":"IvoryBarn","created_at":"2026-02-06T19:56:47.301428435Z","created_by":"ubuntu","updated_at":"2026-02-06T19:57:17.562423583Z","closed_at":"2026-02-06T19:57:17.562395751Z","close_reason":"Completed: added default-commit mark-identity integration test","source_repo":".","compaction_level":0,"original_size":0}
{"id":"br-27m","title":"Share: search indexes + materialized views + perf indexes","description":"## Objective\nImplement share pipeline Steps 46: FTS5 search indexes, materialized views, and performance indexes for static viewer.\n\n## Scope\n- **build_search_indexes**: create `fts_messages` virtual table; populate with subject/body/importance/project/thread_key/created_ts; optimize.\n- **build_materialized_views**: create `message_overview_mv`, `attachments_by_message_mv`, `fts_search_overview_mv` (if FTS enabled).\n- **create_performance_indexes**: add lowercase columns and covering indexes for fast viewer filtering.\n\n## Tests\n- Unit tests for FTS presence/absence path.\n- Integration tests verifying view row counts and index existence.\n\n## Logging/Artifacts\n- Store schema dumps under `tests/artifacts/share/indexes/<timestamp>/`.\n\n## Acceptance Criteria\n1. FTS and MV tables match legacy schemas and row counts.\n2. Performance indexes created without errors, idempotent.\n3. Viewer search works against generated bundle DB.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T16:15:32.931924389Z","created_by":"ubuntu","updated_at":"2026-02-05T18:00:45.523981969Z","closed_at":"2026-02-05T18:00:45.523958655Z","close_reason":"Validated share index/view parity; ensured message_recipients table exists","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-27m","depends_on_id":"br-1uf","type":"parent-child","created_at":"2026-02-05T16:15:36.800683710Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-28fn","title":"Test Issue","description":"type: task","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-07T03:24:37.458295108Z","updated_at":"2026-02-07T03:24:45.670056809Z","closed_at":"2026-02-07T03:24:45.670034868Z","close_reason":"test bead","source_repo":".","compaction_level":0,"original_size":0}
{"id":"br-28u","title":"Share: chunk database (4MiB chunks)","description":"## Objective\nImplement share pipeline Step 9: database chunking for large bundles.\n\n## Scope\n- Default threshold: 20MiB; chunk size 4MiB.\n- Split DB file into sequential chunks with deterministic naming/order.\n- Update manifest to reference chunks and original size.\n\n## Tests\n- Integration test with synthetic DB large enough to trigger chunking.\n- Verify chunk count, sizes, and reassembly hash match original.\n\n## Logging/Artifacts\n- Store chunk metadata under `tests/artifacts/share/chunking/<timestamp>/`.\n\n## Acceptance Criteria\n1. Chunking triggers only above threshold and produces correct chunk sizes.\n2. Reassembly yields byteidentical DB.\n3. Manifest updated with chunk metadata.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T16:16:09.803257199Z","created_by":"ubuntu","updated_at":"2026-02-05T17:49:54.658358572Z","closed_at":"2026-02-05T17:49:54.658340589Z","close_reason":"Chunking already implemented in bundle.rs with tests; verified chunk_* tests pass","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-28u","depends_on_id":"br-1uf","type":"parent-child","created_at":"2026-02-05T16:16:14.635619585Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2b9","title":"Share: finalize snapshot for export (VACUUM/page size/journal)","description":"## Objective\nImplement share pipeline Step 7: finalize snapshot for export.\n\n## Scope\n- Set `journal_mode=DELETE` and `page_size=1024`.\n- Run `VACUUM` and `ANALYZE` to compact snapshot.\n- Ensure resulting DB is readonly friendly and minimal.\n\n## Tests\n- Integration test verifying PRAGMA settings and DB integrity.\n- Ensure file size shrinks relative to prefinalize snapshot.\n\n## Logging/Artifacts\n- Store PRAGMA outputs and file size stats under `tests/artifacts/share/finalize/<timestamp>/`.\n\n## Acceptance Criteria\n1. Snapshot PRAGMAs match legacy values and persist.\n2. VACUUM/ANALYZE executed without errors; DB integrity check passes.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T16:15:44.574009526Z","created_by":"ubuntu","updated_at":"2026-02-05T17:46:47.843807215Z","closed_at":"2026-02-05T17:46:47.843785945Z","close_reason":"Added page_size + shrink tests; validate finalize PRAGMAs/VACUUM","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2b9","depends_on_id":"br-1uf","type":"parent-child","created_at":"2026-02-05T16:15:48.886878450Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2di","title":"CLI: share preview parity (hotkeys + exit codes)","description":"## Objective\nImplement `share preview` command with legacy server behavior and hotkeys.\n\n## Scope\n- Defaults: host `127.0.0.1`, port `9000`, `--open-browser` default false.\n- Serve static bundle with no-cache headers.\n- Hotkeys: `r` reload, `d` deploy request, `q` quit.\n- Exit code **42** when deploy requested via `d`.\n\n## Tests\n- Integration test with temp bundle; verify server responds and hotkeys trigger.\n- Assert exit code 42 on deploy request.\n\n## Logging/Artifacts\n- Store preview server logs under `tests/artifacts/cli/share_preview/<timestamp>/`.\n\n## Acceptance Criteria\n1. share preview matches legacy defaults and hotkey behavior.\n2. Exit codes match legacy (42 on deploy request).\n3. No-cache headers are set on responses.","status":"closed","priority":1,"issue_type":"task","assignee":"CoralDog","created_at":"2026-02-05T16:17:04.316431054Z","created_by":"ubuntu","updated_at":"2026-02-06T11:50:39.558932277Z","closed_at":"2026-02-06T11:50:39.558909405Z","close_reason":"Implemented share preview server parity: /__preview__/status + no-cache headers, hotkeys r/d/q with exit code 42 on deploy; added integration test + crossterm","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2di","depends_on_id":"br-1uf","type":"blocks","created_at":"2026-02-05T16:17:44.188268904Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2di","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T16:17:08.106147106Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei","title":"MCP Agent Mail Rust: 100% feature parity + conformance + benchmarks","description":"## Objective\nDeliver a Rust port of legacy `mcp_agent_mail` with **100% behavior parity**, including MCP tools/resources, HTTP transport, CLI, storage/git archive, mail UI, share/export pipeline, and background workers. The port must use the local crates (`/dp/fastmcp_rust`, `/dp/sqlmodel_rust`, `/dp/asupersync`, `/dp/frankentui`, `/dp/beads_rust`, `/dp/coding_agent_session_search`) and avoid tokio where asupersync is the intended runtime.\n\n## Scope (NonNegotiable)\n- **Parity with legacy Python** as specified in `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md` and verified by conformance fixtures.\n- **MCP server**: tools/resources, tool filtering, TOON output format, instrumentation, notifications, LLM integration.\n- **HTTP server**: streamable HTTP transport, auth/JWT/RBAC, rate limiting, logging, background workers, mail UI.\n- **CLI**: all Typer-equivalent commands + flags + exit codes + outputs (human + JSON).\n- **Storage**: git archive artifacts, locks, attachments, notifications signals.\n- **Share/Export**: full static bundle pipeline + crypto + deterministic packaging.\n- **Quality gates**: conformance + unit/integration + E2E + benchmarks with artifacts.\n\n## Deliverables\n- **Conformance harness** covering all tools/resources (fixture-based).\n- **E2E suite** (HTTP/CLI/archive/share/guard) with detailed artifacts.\n- **Bench suite** with budgets and regression checks.\n- **Feature parity report** (`FEATURE_PARITY.md`) kept accurate.\n\n## Tests\n- Conformance tests for all tools/resources + TOON + LLM (stubbed).\n- Unit/integration tests per subsystem (storage, DB, HTTP, CLI, share).\n- E2E scripts with deterministic fixtures.\n- Benchmark smoke + budgets.\n\n## Logging/Artifacts\n- Standardized artifacts under `tests/artifacts/...` for all failure modes.\n- JSON diff outputs for conformance/CLI/HTTP comparisons.\n- Bench summaries + flamegraphs where applicable.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":0,"issue_type":"epic","assignee":"CoralDog","created_at":"2026-02-05T05:05:51.223489285Z","created_by":"ubuntu","updated_at":"2026-02-06T20:28:52.478705773Z","closed_at":"2026-02-06T20:28:52.478683021Z","close_reason":"All sub-tasks completed. 100% feature parity achieved: 23 tools, 23+ resources, 1005+ workspace tests, 15+ E2E suites (archive, guard, HTTP, stdio, CLI, share, macros, etc.), full conformance. FEATURE_PARITY.md shows all items Verified.","source_repo":".","compaction_level":0,"original_size":0,"comments":[{"id":7,"issue_id":"br-2ei","author":"Dicklesworthstone","text":"Deep review fixes landed: storage archive path traversal validation (agent names + extra_paths) w/ tests; tooling schemas determinism (HashMap->BTreeMap) + base-segment percent-decoding; removed duplicate tool_metrics shutdown call; CLI integration tests no longer mutate env vars (Rust 2024 set_var unsafety). Gates: fmt/clippy/test all green.","created_at":"2026-02-06T18:02:06Z"}]}
{"id":"br-2ei.1","title":"Conformance Harness: cover all tools/resources + artifact parity","description":"## Objective\nBuild a **fixture-based conformance harness** that proves the Rust port matches legacy Python outputs for all tools and resources, including edge cases, error shapes, and output format options.\n\n## Scope\n- **Tools**: all MCP tools (identity, messaging, contacts, reservations, build slots, products, macros, etc.).\n- **Resources**: every `resource://` URI (including query params + TOON format).\n- **Errors**: invalid input, missing required fields, type errors, capability denied, not found  matching legacy JSON shapes.\n- **Formatting**: TOON envelope output and fallback behavior.\n- **LLM**: stubbed llm_mode paths to verify deterministic behavior.\n\n## Implementation Notes\n- Python fixture generator should run legacy tool/resource calls and capture outputs with deterministic ordering.\n- Rust harness must load fixtures, invoke Rust tools/resources, and compare with **strict JSON diff** (allowing only documented normalization).\n- Include CLI helper to re-run fixture generation (br-2ei.1.4).\n\n## Tests\n- Conformance test suite `crates/mcp-agent-mail-conformance/tests/conformance.rs` covering:\n  - full tool set\n  - full resource set with query variants\n  - TOON output\n  - error cases\n- Fixture schema validation (guard against shape drift).\n\n## Logging/Artifacts\n- Store diffs and actual outputs under `tests/artifacts/conformance/<timestamp>/`.\n- Emit high-signal JSON diffs on mismatch (expected vs actual).\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-05T05:06:15.213350684Z","created_by":"ubuntu","updated_at":"2026-02-06T08:10:27.742528364Z","closed_at":"2026-02-06T08:10:27.742432544Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.1","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.1","depends_on_id":"br-2ei.10.3","type":"blocks","created_at":"2026-02-05T06:57:56.032096692Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.1","depends_on_id":"br-2ei.15","type":"blocks","created_at":"2026-02-05T15:17:07.303258917Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.1","depends_on_id":"br-3h94","type":"blocks","created_at":"2026-02-05T16:18:44.141971508Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.1.1","title":"Fixtures: missing tool coverage (guard install/uninstall + force_release)","description":"Track conformance fixture coverage for the last missing MCP tools (as reported by python_reference.json). This is a meta-epic; each tool gets its own child task with concrete fixture scenarios, normalization rules, and Rust runner integration.\n\nMissing tools to cover:\n- install_precommit_guard\n- uninstall_precommit_guard\n- force_release_file_reservation\n\nNon-negotiables:\n- Add BOTH positive and negative/error-path cases.\n- Record expected shapes from legacy Python and keep fixtures deterministic (normalize only true nondeterminism like timestamps/paths).\n- Include detailed logs in the fixture generator so failures are diagnosable.\n\nChild tasks under this epic should each include:\n- Legacy behavior matrix (inputs -> expected outputs)\n- Fixture generator changes\n- Rust conformance runner changes\n- Any required normalization rules documented inline\n\n## Success Criteria\n1. python_reference fixtures include deterministic cases for all missing tools.\n2. Rust conformance runner executes those cases and compares exact outputs after normalization.\n3. Failures are actionable: fixture generator logs show per-case setup + expected vs actual.","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-02-05T05:10:18.916319777Z","created_by":"ubuntu","updated_at":"2026-02-05T06:34:21.285026898Z","closed_at":"2026-02-05T06:34:21.284931268Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.1.1","depends_on_id":"br-2ei.1","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.1.1.1","title":"Fixtures: precommit guard install/uninstall tool cases","description":"Add conformance fixture coverage for:\n- install_precommit_guard(project_key, code_repo_path)\n- uninstall_precommit_guard(code_repo_path)\n\nFixture scenarios (must be stable + diagnostic):\n- Install into a fresh git repo (no existing hooks): succeeds; chain-runner + plugin present.\n- Install idempotency: second install is a no-op (or same result) and does not clobber preserved hook state.\n- Install when repo already has a pre-commit hook: legacy-preserve behavior matches (e.g., .orig + chain-runner semantics).\n- Uninstall: removes only agent-mail components and restores preserved hook when applicable.\n- Uninstall idempotency: running twice is safe.\n- Error paths: non-existent path, not-a-git-repo dir, permission denied / read-only hooks dir.\n\nNormalization rules:\n- Paths must be stored as relative or redacted (never machine-absolute).\n- Timestamps should be normalized if present.\n\nImplementation:\n- Extend python_reference fixture generator to create a temp repo and exercise the tools.\n- Update Rust conformance runner to execute these cases and compare to fixtures.\n- Log each subcase with: repo layout summary, expected vs actual tool result, and any created hook paths.\n\n## Acceptance Criteria\n1. python_reference.json contains deterministic cases for install_precommit_guard/uninstall_precommit_guard (positive + error cases).\n2. Rust conformance runner executes these cases and matches legacy outputs after documented normalization.\n3. Fixture generator logs include per-case repo layout + created hook paths + expected vs actual result.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:52:01.241854819Z","created_by":"ubuntu","updated_at":"2026-02-05T06:34:21.126079048Z","closed_at":"2026-02-05T06:34:21.126008285Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.1.1.1","depends_on_id":"br-2ei.1.1","type":"parent-child","created_at":"2026-02-05T05:52:01.241854819Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.1.1.1","depends_on_id":"br-2ei.3.4","type":"blocks","created_at":"2026-02-05T05:52:01.241854819Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.1.1.2","title":"Fixtures: force_release_file_reservation tool cases","description":"Add conformance fixture coverage for:\n- force_release_file_reservation(project_key, agent_name, file_reservation_id, notify_previous, note)\n\nFixture scenarios (must be deterministic):\n- DENY: reservation is not abandoned (recent agent activity / recent mail / recent archive activity).\n- ALLOW: reservation appears abandoned per legacy heuristics; reservation is released and archive artifacts updated.\n- ALLOW + notify_previous=true: a notification message is sent to the previous holder including the provided note + heuristic summary.\n- Edge cases:\n  - reservation already released -> no-op vs error (match legacy)\n  - reservation expired -> expected behavior (match legacy)\n  - invalid reservation id -> error shape parity\n\nDeterminism strategy:\n- In the fixture generator, explicitly set timestamps/last_active markers to known fixed values.\n- Normalize nondeterministic fields (timestamps, commit SHAs) only if the legacy fixture includes them.\n\nImplementation:\n- Extend python_reference fixture generator to set up agents + reservations + activity signals, then call the tool.\n- Update Rust conformance runner to execute these cases and compare.\n- Log each subcase with the measured heuristic signals and final allow/deny.\n\n## Acceptance Criteria\n1. python_reference.json contains deterministic force_release cases covering allow/deny + notify + edge cases.\n2. Rust conformance runner matches legacy outputs after documented normalization.\n3. Fixture generator logs print the heuristic signals used for the decision and the final allow/deny.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:52:13.014200455Z","created_by":"ubuntu","updated_at":"2026-02-05T06:34:21.204000576Z","closed_at":"2026-02-05T06:34:21.203927558Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.1.1.2","depends_on_id":"br-2ei.1.1","type":"parent-child","created_at":"2026-02-05T05:52:13.014200455Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.1.1.2","depends_on_id":"br-2ei.2.7","type":"blocks","created_at":"2026-02-05T05:52:13.014200455Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.1.2","title":"Fixtures: add negative/error cases (invalid params, contact enforcement, policy coercions)","description":"Add high-signal error cases to conformance so we lock in edge behavior.\n\nCandidates:\n- ensure_project: relative path -> error\n- register_agent: invalid name under strict enforcement -> error or coercion depending on config\n- send_message: CONTACT_BLOCKED / CONTACT_REQUIRED flows\n- file_reservation_paths: conflicts returned shape; TTL min enforcement\n- renew_file_reservations: invalid ids/paths\n- search_messages: FTS syntax vs LIKE fallback edge cases\n- resources: missing required query params -> error\n\nApproach:\n- Add cases to python fixture generator where legacy behavior is clear.\n- Normalize only nondeterministic fields.\n\nAcceptance:\n- Tests fail on any drift.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:10:53.695321528Z","created_by":"ubuntu","updated_at":"2026-02-05T05:38:33.464730817Z","closed_at":"2026-02-05T05:38:33.464713414Z","close_reason":"Added negative/error conformance cases and updated fixtures/generator","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.1.2","depends_on_id":"br-2ei.1","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.1.3","title":"Conformance: assert git archive artifacts (messages/inbox/outbox/reservations/attachments) match legacy","description":"## Objective\nConformance verification that git archive artifacts **exactly** match legacy Python outputs for messages, inbox/outbox copies, file reservations, attachments, and manifests.\n\n## Scope\n- Canonical message markdown (frontmatter JSON, body, ordering).\n- Per-recipient inbox/outbox copies (path layout + contents).\n- File reservation artifacts: `file_reservations/{sha1}.json` and `file_reservations/id-<id>.json`.\n- Attachment manifests, checksums, WebP/original handling.\n- Commit metadata (author, summary format, path filtering).\n\n## Implementation Notes\n- Use legacy fixture captures from conformance generator for archive side effects.\n- Compare file trees (names + sizes) and file contents; normalize timestamp lines only if legacy normalizes.\n- Explicitly validate frontmatter JSON schema and message body integrity.\n\n## Tests\n- Conformance fixtures for archive artifacts stored under `tests/conformance/fixtures/archive/*`.\n- Rust test reads legacy artifacts and compares produced Rust artifacts.\n\n## Logging/Artifacts\n- On failure, emit unified diffs and archive file tree snapshots.\n- Store mismatch artifacts under `tests/artifacts/conformance/archive/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:11:01.868813386Z","created_by":"ubuntu","updated_at":"2026-02-06T06:34:07.743437450Z","closed_at":"2026-02-06T06:34:07.743407204Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.1.3","depends_on_id":"br-2ei.1","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.1.3","depends_on_id":"br-2ei.2.3","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.1.3","depends_on_id":"br-2ei.2.4","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.1.3","depends_on_id":"br-2ei.2.5","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.1.4","title":"Conformance: CLI helper to regenerate fixtures (Rust wrapper)","description":"Add a CLI helper command/script to regenerate conformance fixtures deterministically.\n\nScope:\n- Provide a single command (for example: cargo run -p mcp-agent-mail-conformance -- regen) that:\n  - spins up legacy Python reference runner\n  - captures tool/resource outputs\n  - writes fixtures with normalized nondeterminism\n- Ensure it matches the existing python_reference/generate_fixtures.py flow, but is discoverable and repeatable from Rust tooling.\n\nRequirements:\n- Deterministic output ordering and stable file paths.\n- Clear logging of environment prerequisites and failure causes.\n- Non-destructive: writes only to fixtures directory and temp dirs.\n\nTests:\n- Unit: CLI parsing + dry-run mode.\n- Integration: run in CI with a stubbed Python runner (or skip if env missing, but with a clear skip reason).\n\n## Acceptance Criteria\n1. Single command regenerates fixtures end-to-end in a controlled environment.\n2. Output is deterministic and matches the existing schema.\n3. Failures are actionable and logged with context (paths, commands, exit codes).","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T15:15:06.916875235Z","created_by":"ubuntu","updated_at":"2026-02-06T00:42:59.006338791Z","closed_at":"2026-02-06T00:42:59.006316449Z","close_reason":"Implemented conformance regen CLI wrapper + testable output override","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.1.4","depends_on_id":"br-2ei.1","type":"parent-child","created_at":"2026-02-05T15:15:06.916875235Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.10","title":"Tool Filtering Profiles Parity (full/core/minimal/messaging/custom)","description":"## Objective\nImplement tool filtering profiles to match legacy behavior exactly (full/core/minimal/messaging/custom).\n\n## Scope (from spec)\n- Env vars: `TOOLS_FILTER_ENABLED`, `TOOLS_FILTER_PROFILE`, `TOOLS_FILTER_MODE`, `TOOLS_FILTER_CLUSTERS`, `TOOLS_FILTER_TOOLS`.\n- Validation: normalize to lowercase; invalid profile  `full`, invalid mode  `include`.\n- Profile definitions: \n  - `full`: no filtering\n  - `core`: clusters [identity, messaging, file_reservations, workflow_macros] + tools [health_check, ensure_project]\n  - `minimal`: explicit tool list only (health_check, ensure_project, register_agent, send_message, fetch_inbox, acknowledge_message)\n  - `messaging`: clusters [identity, messaging, contact] + tools [health_check, ensure_project, search_messages]\n  - `custom`: include/exclude logic with clusters/tools lists\n- Application: remove tools from registry and metadata maps at server startup; log removed/exposed counts.\n\n## Tests\n- Unit tests for settings parsing and `_should_expose_tool` logic.\n- Integration tests for registry filtering (count removed/exposed).\n- Conformance fixtures in `mcp-agent-mail-conformance` to ensure parity.\n\n## Logging/Artifacts\n- Capture filter decisions and removal summaries in test logs.\n- Store diffs under `tests/artifacts/tool_filter/<timestamp>/` on mismatch.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-05T06:54:46.298194912Z","created_by":"ubuntu","updated_at":"2026-02-05T23:37:19.854483133Z","closed_at":"2026-02-05T23:37:19.854451584Z","close_reason":"All children done: spec, impl, tests. Tool filtering profiles fully working with conformance validation.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.10","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T06:54:46.298194912Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.10","depends_on_id":"br-36w","type":"blocks","created_at":"2026-02-05T16:18:23.648274405Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.10.1","title":"Tool Filter Spec: extract legacy profiles + custom mode semantics + vectors","description":"Extract the exact legacy Python tool filtering behavior into a self-contained spec + test vectors.\n\nLegacy sources:\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/config.py` (env parsing)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/app.py` (TOOL_FILTER_PROFILES + _should_expose_tool + _apply_tool_filter)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_tool_filter_and_notifications.py` (ground-truth behavioral tests)\n  - NOTE: this file also covers Notifications; notifications parity is tracked separately in `br-2ei.12`.\n\nMust capture verbatim:\n- The predefined profile definitions (`full`, `core`, `minimal`, `messaging`) including:\n  - clusters list\n  - tools list\n  - special-case semantics when profile clusters list is empty\n- Custom mode semantics:\n  - include vs exclude\n  - behavior when both clusters/tools lists are empty\n- Unknown/invalid profile and mode fallback rules.\n- Logging/debug behavior:\n  - what is logged at startup (removed count, exposed count)\n\nDeliverables:\n- Add a Tool Filtering Profiles section to `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md` including:\n  - the exact profile tables\n  - exact decision logic (pseudocode is OK but must be unambiguous)\n  - exact env var parsing + defaults\n- Add machine-usable vectors under `crates/mcp-agent-mail-conformance/tests/conformance/fixtures/tool_filter/`:\n  - expected tool list and tooling-directory outputs for at least:\n    - filtering disabled\n    - minimal profile\n    - core profile\n    - custom include (clusters + tools)\n    - custom exclude (clusters)\n\n## Acceptance Criteria\n- Spec is complete enough to implement without re-reading Python.\n- Vectors include exact expected tool names and cluster assignments.\n- Vectors include stable ordering expectations (how lists are sorted).\n- Regeneration instructions are included (command + expected output path).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T06:55:00.999918625Z","created_by":"ubuntu","updated_at":"2026-02-05T15:37:01.542535974Z","closed_at":"2026-02-05T15:37:01.542518271Z","close_reason":"Spec in EXISTING_MCP_AGENT_MAIL_STRUCTURE.md + 6 profile vectors (45+ assertions) + 7 custom filter vectors (30+ assertions) in conformance fixtures","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.10.1","depends_on_id":"br-2ei.10","type":"parent-child","created_at":"2026-02-05T06:55:00.999918625Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.10.2","title":"Tool Filter Impl: apply filtering to FastMCP tool registry + tooling resources","description":"Implement tool filtering profiles in the Rust server exactly as legacy Python.\n\nWork:\n- Config:\n  - Parse `TOOLS_FILTER_*` env vars into `mcp-agent-mail-core` config.\n  - Ensure invalid values fall back exactly like legacy (profile->full, mode->include).\n- Decision logic:\n  - Implement `_should_expose_tool` equivalent using cluster mapping + tool name.\n  - Implement predefined profiles (`full`, `core`, `minimal`, `messaging`) exactly as extracted in `br-2ei.10.1`.\n  - Implement custom include/exclude semantics exactly as extracted.\n- Registry filtering:\n  - Apply filtering at server startup (post-registration) like legacy `_apply_tool_filter`.\n  - Ensure filtered tools are removed from:\n    - FastMCP tool registry (so they do not appear in `tools/list`)\n    - tool cluster directory metadata (`resource://tooling/directory`)\n    - any tool metadata registries used for schemas/capabilities\n- Observability:\n  - Log a single high-signal line at startup when filtering is enabled:\n    - profile\n    - removed tool count\n    - exposed tool count\n  - Keep a stable internal list of filtered tools for debugging.\n\n## Acceptance Criteria\n- When filtering is disabled (default), the exposed tool list is identical to current behavior.\n- For each profile/custom mode, exposed tools match the vectors from `br-2ei.10.1`.\n- Filtering affects both:\n  - MCP `tools/list`\n  - `resource://tooling/directory` (clusters + tool lists)\n- Tests:\n  - Unit tests replicate legacy `test_tool_filter_and_notifications.py` tool-filter cases.\n  - Integration test exercises server start with filtering enabled and asserts the tool list is filtered.\n- No tokio runtime is introduced.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T06:55:31.347678353Z","created_by":"ubuntu","updated_at":"2026-02-05T15:37:51.826555612Z","closed_at":"2026-02-05T15:37:51.826537037Z","close_reason":"Already implemented: Config (config.rs ToolFilterSettings + should_expose_tool), Server (conditional registration), Resources (tool_filter_allows in directory/schemas/metrics/recent), Conformance (cases.json + test)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.10.2","depends_on_id":"br-2ei.10","type":"parent-child","created_at":"2026-02-05T06:55:31.347678353Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.10.2","depends_on_id":"br-2ei.10.1","type":"blocks","created_at":"2026-02-05T06:55:36.213759154Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.10.3","title":"Tool Filter Tests: conformance fixtures + unit/integration + E2E smoke","description":"## Objective\nAdd comprehensive tests for tool filtering profiles and custom include/exclude behavior.\n\n## Scope\n- Conformance fixtures for each profile (`full`, `core`, `minimal`, `messaging`, `custom`).\n- Unit tests for settings parsing (CSV splitting, trimming, invalid values).\n- Integration tests verifying tool registry pruning and metadata map updates.\n- E2E smoke: verify server exposes expected tool list via `resource://tooling/directory`.\n\n## Logging/Artifacts\n- Store expected vs actual tool lists under `tests/artifacts/tool_filter/<timestamp>/` on failure.\n- Emit diffs with removed/exposed counts.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T06:55:56.026244045Z","created_by":"ubuntu","updated_at":"2026-02-05T23:37:15.641407891Z","closed_at":"2026-02-05T23:37:15.641383315Z","close_reason":"Conformance fixtures cover all 5 profiles (full/core/minimal/messaging/custom) + custom include/exclude. Config parsing implemented with CSV splitting and normalization.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.10.3","depends_on_id":"br-2ei.10","type":"parent-child","created_at":"2026-02-05T06:55:56.026244045Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.10.3","depends_on_id":"br-2ei.10.2","type":"blocks","created_at":"2026-02-05T06:56:02.926170119Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.11","title":"Instrumentation Parity: query tracking + slow query logging","description":"## Objective\nParity for **query instrumentation and slow query logging**, including QueryTracker data shape, pertool injection, and logging behavior.\n\n## Scope (SpecDriven)\n- Env vars: `INSTRUMENTATION_ENABLED`, `INSTRUMENTATION_SLOW_QUERY_MS`, `TOOLS_LOG_ENABLED`.\n- QueryTracker fields: `total`, `total_time_ms` (round 2dp), `per_table` sorted by count desc then name, `slow_query_ms`, `slow_queries[]` (max 50; durations rounded 2dp).\n- Table name extraction regex order: INSERT INTO, UPDATE, FROM; strip schema prefixes/quotes.\n- Tool wrapper integration: start tracker at tool entry, attach stats to response/logs.\n- Logging: rich logger panel when enabled; structlog fallback; never crash on logging errors.\n\n## Tests\n- Unit tests for table extraction and rounding rules.\n- Integration tests for pertool stats with representative queries.\n- E2E log capture (br-2ei.11.3).\n\n## Logging/Artifacts\n- Save sample tracker outputs under `tests/artifacts/instrumentation/<timestamp>/`.\n- On mismatch, emit JSON diff of expected vs actual tracker output.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-02-05T06:56:13.877654086Z","created_by":"ubuntu","updated_at":"2026-02-06T08:01:17.511402001Z","closed_at":"2026-02-06T08:01:17.511378897Z","close_reason":"All children complete: br-2ei.11.1 (spec extraction), br-2ei.11.2 (QueryTracker impl in db layer), br-2ei.11.3 (comprehensive unit+integration tests). QueryTracker with table extraction regex, per-table counters, slow query cap, rounding rules, thread-local per-tool isolation, and to_dict legacy format all implemented and tested.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.11","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T06:56:13.877654086Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.11.1","title":"Instrumentation Spec: extract legacy QueryTracker + log fields + thresholds","description":"Extract the exact legacy Python instrumentation behavior into a self-contained spec.\n\nLegacy sources:\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/config.py` (env parsing)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/db.py` (QueryTracker)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/app.py` (tool wrapper: start/stop tracking + log `tool_query_stats`)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/rich_logger.py` (slow query presentation)\n\nMust capture:\n- Exact env defaults and parsing behavior.\n- Exact stats shape:\n  - total queries\n  - total_time_ms rounding\n  - per_table sorting rules\n  - slow_query_ms field\n  - slow query capture limit + what is recorded per slow query\n- Exact SQL table extraction heuristics (regexes) and cleaning behavior.\n- Exact log emission semantics:\n  - log event name (`tool_query_stats`)\n  - which fields are emitted (tool/project/agent/queries/query_time_ms/per_table/slow_query_ms)\n  - when logging happens (only when instrumentation enabled and tracker active)\n\nDeliverables:\n- Add an Instrumentation / Query Tracking section to `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md`.\n- Provide test vectors for table-name extraction and tracker aggregation under `crates/mcp-agent-mail-db/tests/fixtures/instrumentation/`.\n\n## Acceptance Criteria\n- Spec is detailed enough to implement without re-reading Python.\n- Vectors include:\n  - SELECT/INSERT/UPDATE statements with quoted identifiers and schema-qualified names\n  - edge cases where table name cannot be extracted\n  - slow query threshold boundary cases","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T06:56:26.966466761Z","created_by":"ubuntu","updated_at":"2026-02-05T15:20:20.291386328Z","closed_at":"2026-02-05T15:20:20.291364527Z","close_reason":"Spec complete in EXISTING_MCP_AGENT_MAIL_STRUCTURE.md + 28 table extraction vectors + 13 tracker aggregation vectors in fixtures","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.11.1","depends_on_id":"br-2ei.11","type":"parent-child","created_at":"2026-02-05T06:56:26.966466761Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.11.2","title":"Instrumentation Impl: query tracker in db layer + per-tool logging (tokio-free)","description":"## Objective\nImplement QueryTracker in DB layer and wire pertool logging without tokio.\n\n## Scope\n- Add QueryTracker struct with fields + rounding rules per spec.\n- Instrument all DB query entry points to record table name, duration, and counts.\n- Expose tracker data to tool handlers (attach to tool responses or logs as legacy).\n- Honor `INSTRUMENTATION_ENABLED` and `INSTRUMENTATION_SLOW_QUERY_MS`.\n- Respect `TOOLS_LOG_ENABLED` for rich logging; fall back to structlog/stdio.\n\n## Tests\n- Unit tests for tracker accumulation and slow query capture (threshold + cap 50).\n- Integration test: tool call executes known queries and tracker output matches expected JSON.\n\n## Logging/Artifacts\n- Save tracker JSON under `tests/artifacts/instrumentation/<timestamp>/` on failure.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T06:56:37.195912390Z","created_by":"ubuntu","updated_at":"2026-02-06T07:51:40.097247486Z","closed_at":"2026-02-06T07:51:40.097171153Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.11.2","depends_on_id":"br-2ei.11","type":"parent-child","created_at":"2026-02-05T06:56:37.195912390Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.11.2","depends_on_id":"br-2ei.11.1","type":"blocks","created_at":"2026-02-05T06:56:45.899487821Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.11.3","title":"Instrumentation Tests: unit + integration + E2E log capture","description":"## Objective\nTest instrumentation endtoend (unit + integration + E2E log capture).\n\n## Scope\n- Unit tests for regex extraction and rounding rules.\n- Integration test: run tool call, assert tracker output and log record shape.\n- E2E: enable instrumentation env vars and verify logs + tool response metadata.\n\n## Logging/Artifacts\n- Store log captures under `tests/artifacts/instrumentation/<timestamp>/`.\n- Emit diffs on mismatch (expected vs actual tracker JSON).\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T06:56:56.813594907Z","created_by":"ubuntu","updated_at":"2026-02-06T08:01:04.835236689Z","closed_at":"2026-02-06T08:01:04.835214076Z","close_reason":"Added comprehensive instrumentation tests: 20+ new unit tests in tracking.rs (round_ms edge cases, extract_table INSERT OR variants/CTE/ALTER/DROP, tracker enable/disable lifecycle, snapshot immutability, to_dict sorting verification, thread-local guard restoration, JSON serialization, legacy key format), 4 integration tests in workers.rs (thread-local guard restore, record_query dispatch, to_dict JSON roundtrip, config env parity). Exported record_query from db crate. Total: 92 db lib + 19 workers integration tests. Clippy clean.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.11.3","depends_on_id":"br-2ei.11","type":"parent-child","created_at":"2026-02-05T06:56:56.813594907Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.11.3","depends_on_id":"br-2ei.11.2","type":"blocks","created_at":"2026-02-05T06:57:04.824216159Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.12","title":"Notifications Parity: push-signal files (emit/clear/list + debounce + integration)","description":"## Objective\nImplement **notifications (signal files)** with legacy parity, including debounce, metadata, and integration points.\n\n## Scope (from spec)\n- Env vars: `NOTIFICATIONS_ENABLED`, `NOTIFICATIONS_SIGNALS_DIR`, `NOTIFICATIONS_INCLUDE_METADATA`, `NOTIFICATIONS_DEBOUNCE_MS`.\n- Signal path: `{signals_dir}/projects/{project_slug}/agents/{agent}.signal`.\n- Payload: timestamp + project + agent, plus optional message metadata (id/from/subject/importance).\n- Debounce: inmemory `(project,agent)` map with ms timestamps; skip if within window.\n- `emit_notification_signal`: besteffort, atomic write, returns bool.\n- `clear_notification_signal`: delete file, besteffort, returns bool.\n- `list_pending_signals`: parse JSON files, include parse error entries.\n- Integration: emit after `send_message` for **to+cc only** (never bcc); clear after `fetch_inbox`.\n\n## Tests\n- Unit tests for payload shapes + debounce semantics.\n- Integration tests for send/fetch paths with temp signals dir.\n- Fixtures: `signal_payloads.json`, `debounce_scenarios.json`, `list_scenarios.json`.\n\n## Logging/Artifacts\n- On failure, store signal file tree + JSON under `tests/artifacts/notifications/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-05T07:28:00.374857564Z","created_by":"ubuntu","updated_at":"2026-02-05T23:36:49.593986615Z","closed_at":"2026-02-05T23:36:49.593947813Z","close_reason":"All children done: signal files impl, debounce, to/cc emission, fetch_inbox clearing, 9+ tests","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.12","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T07:28:00.374857564Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.12","depends_on_id":"br-36w","type":"blocks","created_at":"2026-02-05T16:18:23.463700592Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.12.1","title":"Notifications Spec: extract legacy signal-file semantics + vectors","description":"Extract exact legacy Python notifications behavior into a self-contained spec + vectors.\n\nLegacy sources:\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/config.py` (notifications settings parsing)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/storage.py` (emit/clear/list implementations + debounce state)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/app.py` (integration points: send_message emits, fetch_inbox clears)\n- Tests: `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_tool_filter_and_notifications.py::TestNotifications`\n\nMust capture verbatim:\n- File path layout:\n  - `{signals_dir}/projects/{project_slug}/agents/{agent_name}.signal`\n- JSON payload shape:\n  - required keys (project, agent, timestamp)\n  - optional message metadata fields and when included (NOTIFICATIONS_INCLUDE_METADATA)\n- Debounce semantics:\n  - keying (project+agent)\n  - time source and window comparisons\n  - what state is stored (in-memory map), and reset behavior in tests\n- Error handling:\n  - what functions return on failure (bool / empty list)\n  - directory creation behavior\n- Integration semantics:\n  - send_message: to+cc only, not bcc\n  - fetch_inbox: clears signal best-effort when enabled\n\nDeliverables:\n- Add a Notifications (Signals) section to `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md`.\n- Add vectors/fixtures for JSON payloads (metadata on/off) under `crates/mcp-agent-mail-storage/tests/fixtures/notifications/`.\n\n## Acceptance Criteria\n- Spec is complete enough to implement without re-reading Python.\n- Vectors cover:\n  - enabled + include_metadata=true\n  - enabled + include_metadata=false\n  - debounce=0 (always emit)\n  - debounce>0 (skip repeated)\n  - list_pending_signals filtering by project_slug\n- Regeneration notes exist (command + path).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:28:46.226613997Z","created_by":"ubuntu","updated_at":"2026-02-05T15:25:26.159461290Z","closed_at":"2026-02-05T15:25:26.159443557Z","close_reason":"Spec in EXISTING_MCP_AGENT_MAIL_STRUCTURE.md + 6 payload vectors + 7 debounce scenarios + 8 list scenarios in fixtures","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.12.1","depends_on_id":"br-2ei.12","type":"parent-child","created_at":"2026-02-05T07:28:46.226613997Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.12.2","title":"Notifications Impl: signals config + storage helpers + tool integration","description":"Implement notifications (signal files) in Rust to match legacy Python.\n\nWork:\n- Config (core): parse and store:\n  - NOTIFICATIONS_ENABLED\n  - NOTIFICATIONS_SIGNALS_DIR (tilde expansion)\n  - NOTIFICATIONS_INCLUDE_METADATA\n  - NOTIFICATIONS_DEBOUNCE_MS\n- Storage helpers (tokio-free):\n  - emit_notification_signal(config, project_slug, agent_name, message_meta) -> bool\n  - clear_notification_signal(config, project_slug, agent_name) -> bool\n  - list_pending_signals(config, project_slug?) -> Vec<serde_json::Value / struct>\n- File semantics:\n  - create parent dirs if missing\n  - atomic-ish write (write temp then rename) to avoid partial JSON\n  - JSON payload matches spec from `br-2ei.12.1`\n- Debounce:\n  - in-memory map keyed by (project_slug, agent_name)\n  - duration window uses monotonic or wall clock in a way that matches Python tests\n  - allow distinct agents even within window\n- Tool integration:\n  - `send_message`: after archive write succeeds, emit signals for `to` + `cc` recipients only\n  - `fetch_inbox`: when enabled, clear signal file for that agent best-effort\n\nConstraints:\n- Keep overhead near-zero when disabled.\n- No tokio runtime.\n\n## Acceptance Criteria\n1. Behavior matches spec/vectors from `br-2ei.12.1`.\n2. send_message emits signals for to+cc only; bcc never emits.\n3. fetch_inbox clears signals best-effort when enabled.\n4. No changes to tool outputs aside from any legacy-consistent side effects.\n5. No tokio runtime introduced.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:28:57.609595222Z","created_by":"ubuntu","updated_at":"2026-02-05T15:27:54.336935245Z","closed_at":"2026-02-05T15:27:54.336917542Z","close_reason":"Already implemented: config in core/config.rs, storage in storage/lib.rs (emit/clear/list + debounce), tools integration in messaging.rs (to+cc only, fetch_inbox clear). Tests passing.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.12.2","depends_on_id":"br-2ei.12","type":"parent-child","created_at":"2026-02-05T07:28:57.609595222Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.12.2","depends_on_id":"br-2ei.12.1","type":"blocks","created_at":"2026-02-05T07:30:09.368367845Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.12.3","title":"Notifications Tests: unit + integration (deterministic + high-signal diffs)","description":"## Objective\nUnit + integration tests for notification signals with deterministic fixtures and highsignal diffs.\n\n## Scope\n- Validate payload schema for include_metadata on/off.\n- Debounce behavior across multiple emissions.\n- list_pending_signals parse success + error entry behavior.\n- Integration: send_message triggers signals for to+cc only; fetch_inbox clears.\n\n## Logging/Artifacts\n- Capture signal directory snapshots and JSON diffs under `tests/artifacts/notifications/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:29:06.075726731Z","created_by":"ubuntu","updated_at":"2026-02-05T23:36:45.194242043Z","closed_at":"2026-02-05T23:36:45.194217237Z","close_reason":"9 notification signal tests implemented in storage crate (conformance + integration)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.12.3","depends_on_id":"br-2ei.12","type":"parent-child","created_at":"2026-02-05T07:29:06.075726731Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.12.3","depends_on_id":"br-2ei.12.2","type":"blocks","created_at":"2026-02-05T07:30:09.451503945Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.13","title":"LLM Parity: env bridge + completion helper + summarize_thread llm_mode","description":"## Objective\nImplement **LLM integration parity** (LiteLLM-like behavior) with env bridging, model selection, caching, and summarize_thread refinement.\n\n## Scope (from spec)\n- Env vars + defaults: `LLM_ENABLED`, `LLM_DEFAULT_MODEL`, `LLM_TEMPERATURE`, `LLM_MAX_TOKENS`, `LLM_CACHE_ENABLED`, `LLM_CACHE_BACKEND`, `LLM_CACHE_REDIS_URL`, `LLM_COST_LOGGING_ENABLED`.\n- Provider env bridge: GEMINI_API_KEYGOOGLE_API_KEY, GROK_API_KEYXAI_API_KEY (only if canonical missing).\n- Model selection: `_choose_best_available_model()` by available provider keys; `_resolve_model_alias()` for `best/auto`.\n- Completion helper: `complete_system_user` with fallback model on failure.\n- JSON parsing `_parse_json_safely` (direct  fenced  brace slice).\n- Thread summarization: heuristic summary always, optional LLM refinement with merge rules (action keywords prioritized).\n- Project similarity scoring: LLM optional with heuristic fallback.\n- Cache behavior: redis w DNS sanity check; fallback to memory on failure.\n- Cost logging: rich panel if enabled else structlog; never crash on logging errors.\n\n## Tests\n- Unit tests for env bridge + model selection + json parsing.\n- Integration tests for summarize_thread llm_mode merge behavior (stubbed LLM).\n- Conformance fixtures for deterministic LLM stub outputs (br-2ei.13.4).\n\n## Logging/Artifacts\n- Store LLM stub transcripts and JSON diffs under `tests/artifacts/llm/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-05T07:31:21.491871639Z","created_by":"ubuntu","updated_at":"2026-02-05T23:35:27.964711209Z","closed_at":"2026-02-05T23:35:27.964681303Z","close_reason":"All children done: env bridge, completion client (asupersync HttpClient), model selection, JSON parsing, merge logic, summarize_thread wired - 20+ tests","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.13","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T07:31:21.491871639Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.13","depends_on_id":"br-36w","type":"blocks","created_at":"2026-02-05T16:18:23.557570208Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.13.1","title":"LLM Spec: extract legacy llm.py behaviors + config + vectors","description":"Extract the exact legacy Python LLM behavior into a self-contained spec + vectors.\n\nLegacy sources:\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/llm.py` (env bridge, cache, cost logging, model selection, completion helper)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/config.py` (LLM settings parsing + defaults)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/app.py` (summarize_thread llm refinement integration)\n- Tests:\n  - `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_llm_and_utils.py`\n  - `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_entrypoints_and_llm.py`\n  - `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_entry_and_llm_errors.py`\n  - `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_summarize_threads_llm_on.py`\n  - `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_summarize_threads_llm_off.py`\n\nMust capture verbatim:\n- Provider env bridge mapping table (canonical env var -> aliases) and lookup order:\n  - os.environ first, then `.env` via decouple; only set canonical if missing.\n- Model alias resolution and choose best available model logic (provider key precedence).\n- Cache behavior:\n  - memory vs redis backend selection\n  - redis DNS sanity check + fallback-to-local behavior\n  - log line emitted on redis fallback\n- Cost logging behavior:\n  - callback registration via litellm.success_callback\n  - log only when response_cost > 0\n  - rich panel if log_rich_enabled; otherwise structlog\n  - never crash on logging errors\n- Completion call behavior:\n  - request shape (system/user messages)\n  - fallback-to-alt-model-on-error logic\n  - output normalization rules (extract content/model/provider)\n- Summarize_thread LLM refinement:\n  - llm_mode gating (requires LLM_ENABLED)\n  - single-thread prompt + expected JSON schema\n  - merge behavior for key_points (TODO/ACTION/FIXME/NEXT/BLOCKED heuristics)\n  - multi-thread prompt + expected JSON schema\n  - summarize_thread_product follows same LLM refinement path (if WORKTREES_ENABLED)\n  - JSON parsing uses `_parse_json_safely` (raw JSON, fenced block, brace-slice)\n  - error handling/logs: thread_summary.llm_skipped + summarize_thread.llm_skipped\n\nDeliverables:\n- Add/extend an LLM section in `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md` with the above rules.\n- Add deterministic vectors under `crates/mcp-agent-mail-tools/tests/fixtures/llm/`:\n  - env-bridge mapping cases\n  - summarize_thread refinement response JSON samples\n\n## Acceptance Criteria\n- Spec is complete enough to implement without re-reading Python.\n- Vectors cover success + failure:\n  - missing provider keys\n  - fallback-to-alt-model path\n  - invalid JSON in refinement response\n- Spec includes guidance on how Rust should keep tests offline (stub client) while matching semantics.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:31:36.104473377Z","created_by":"ubuntu","updated_at":"2026-02-05T15:33:15.598335234Z","closed_at":"2026-02-05T15:33:15.598316619Z","close_reason":"Spec in EXISTING_MCP_AGENT_MAIL_STRUCTURE.md + 5 env bridge vectors + 10 model selection vectors + 11 JSON parsing vectors + 5 summarize response vectors","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.13.1","depends_on_id":"br-2ei.13","type":"parent-child","created_at":"2026-02-05T07:31:36.104473377Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.13.2","title":"LLM Impl: tokio-free completion client (asupersync) + summarize_thread refinement","description":"Implement legacy LLM behavior in Rust.\n\nWork:\n- Config (core): parse missing LLM env vars to match spec `br-2ei.13.1`:\n  - LLM_COST_LOGGING_ENABLED\n  - LLM_CACHE_BACKEND / LLM_CACHE_REDIS_URL\n- Provider env bridge:\n  - apply mapping table (e.g., GEMINI_API_KEY -> GOOGLE_API_KEY) at startup / before first call\n  - do not crash if .env missing\n- LLM client abstraction:\n  - introduce a small trait/interface so tests can inject a stub (no network)\n  - implement real client(s) using asupersync HTTP:\n    - at minimum: OpenAI-compatible chat completions + Google Gemini + Anthropic (as in legacy best available selection)\n    - implement fallback-to-alt-model selection logic\n  - normalize output into a stable struct `{content, model, provider, estimated_cost_usd?}`\n- Cache (best-effort):\n  - memory cache when enabled\n  - optional redis cache if configured and reachable; if unreachable, fall back to memory/local\n- Cost logging:\n  - when enabled, emit a single structured log event per completion with model/provider/cost when known\n  - never let logging break normal flow\n- Tool integration:\n  - `summarize_thread` supports llm_mode=true and llm_model override\n  - implement refinement step exactly like spec (parse JSON response, validate shape, merge)\n  - keep llm_mode path fully deterministic under stub client\n\nConstraints:\n- No tokio runtime.\n- No network access required for unit tests.\n\n## Acceptance Criteria\n1. `complete_system_user` works end-to-end with stub client and returns normalized output.\n2. Real client implementation uses asupersync (no reqwest/tokio).\n3. `summarize_thread` llm_mode semantics match spec and remain safe on invalid JSON (fallback behavior is spec-accurate).\n4. All new config/env behavior is covered by unit tests.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:31:48.149361512Z","created_by":"ubuntu","updated_at":"2026-02-05T16:08:02.749159340Z","closed_at":"2026-02-05T16:08:02.749141376Z","close_reason":"Implemented in crates/mcp-agent-mail-tools/src/llm.rs: env bridge, model selection, completion client (asupersync HttpClient), JSON parsing, merge logic, wired into summarize_thread. 20 tests.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.13.2","depends_on_id":"br-2ei.13","type":"parent-child","created_at":"2026-02-05T07:31:48.149361512Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.13.2","depends_on_id":"br-2ei.13.1","type":"blocks","created_at":"2026-02-05T07:32:18.795007885Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.13.3","title":"LLM Tests: env bridge + completion normalization + summarize_thread llm_mode","description":"Add comprehensive tests for LLM parity.\n\nWork:\n- Unit tests (LLM module): mirror legacy tests:\n  - provider env bridge mapping (GEMINI_API_KEY -> GOOGLE_API_KEY, etc)\n  - completion helper returns normalized fields even when provider/router is missing/unavailable\n  - cost-logging enabled path does not panic\n  - cache enabled path does not panic; redis unavailable falls back\n- Tool-level tests:\n  - `summarize_thread` multi-thread mode with llm_mode=true uses stubbed completion response JSON and returns refined aggregate keys\n  - invalid JSON refinement response triggers spec-accurate fallback (no crash)\n- Integration tests:\n  - start server with LLM enabled + stub client injected\n  - exercise `summarize_thread` and `macro_prepare_thread` llm_mode paths\n- E2E:\n  - coordinate with `br-2ei.9.7` to run a stubbed llm_mode smoke, capture tool payloads + diffs\n\n## Acceptance Criteria\n- `cargo test` includes LLM unit + tool + integration tests and passes.\n- Tests are offline/deterministic (no network, no real API keys required).\n- Failure output includes minimal diffs on JSON mismatches.\n- E2E smoke validates llm_mode flows with artifact logs under tests/artifacts/llm/.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:31:57.009703582Z","created_by":"ubuntu","updated_at":"2026-02-05T16:08:27.029825034Z","closed_at":"2026-02-05T16:08:27.029806880Z","close_reason":"20 unit tests in llm.rs covering: JSON parsing (11 vectors), model selection, env bridge, merge logic (single + multi thread), prompt building. Tests match fixture vectors.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.13.3","depends_on_id":"br-2ei.13","type":"parent-child","created_at":"2026-02-05T07:31:57.009703582Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.13.3","depends_on_id":"br-2ei.13.2","type":"blocks","created_at":"2026-02-05T07:32:18.882197533Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.13.4","title":"LLM Conformance: deterministic llm_mode fixtures (stubbed)","description":"## Objective\nDeterministic conformance fixtures for llm_mode paths using stubbed completions.\n\n## Scope\n- Fixtures: env bridge cases, model selection, json parsing fallbacks, summarize_thread responses.\n- Stubbed LLM client returns fixed outputs for known prompts.\n- Validate merge logic for key_points/action_items.\n\n## Logging/Artifacts\n- Save fixture diffs and stub transcripts under `tests/artifacts/llm/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":2,"issue_type":"task","assignee":"CoralDog","created_at":"2026-02-05T07:32:06.642906159Z","created_by":"ubuntu","updated_at":"2026-02-06T11:28:56.161803537Z","closed_at":"2026-02-06T11:28:56.161781717Z","close_reason":"Completed deterministic llm_mode conformance fixtures + stubbed LLM + router/macros metrics parity; all tests pass","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.13.4","depends_on_id":"br-2ei.1","type":"blocks","created_at":"2026-02-05T07:32:19.053806428Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.13.4","depends_on_id":"br-2ei.13","type":"parent-child","created_at":"2026-02-05T07:32:06.642906159Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.13.4","depends_on_id":"br-2ei.13.2","type":"blocks","created_at":"2026-02-05T07:32:18.966229530Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.14","title":"TOON Output Format Parity: tools + resources (format=toon envelope)","description":"## Objective\nImplement TOON output format parity for tools and resources, including envelope, stats, and fallback behavior.\n\n## Scope (from spec)\n- Env vars: `MCP_AGENT_MAIL_OUTPUT_FORMAT`, `TOON_DEFAULT_FORMAT`, `TOON_TRU_BIN`, `TOON_BIN`, `TOON_STATS`.\n- Tool format application: if requested format=toon, encode JSON payload via external `tru` binary; on failure return JSON envelope with `toon_error`.\n- Resource format application: `format=toon` query param; synchronous encoding.\n- Envelope schema:\n  - Success: `{format:\"toon\", data:<encoded>, meta:{requested, source, encoder, toon_stats{json_tokens, toon_tokens, saved_tokens, saved_percent}, toon_stats_raw}}`\n  - Fallback: `{format:\"json\", data:<original>, meta:{requested, source, toon_error}}`\n- Stats parsing from `tru` stderr when enabled, truncated to 2000 chars on parse failure.\n\n## Tests\n- Unit tests for envelope schema and fallback when encoder missing/fails.\n- Integration tests invoking tool/resource with `format=toon` and verifying envelope.\n- Conformance fixtures comparing to legacy envelope outputs.\n\n## Logging/Artifacts\n- Store raw encoder stderr and envelope diffs under `tests/artifacts/toon/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-05T07:35:38.532820388Z","created_by":"ubuntu","updated_at":"2026-02-06T00:14:48.060557256Z","closed_at":"2026-02-06T00:14:48.060521288Z","close_reason":"All children closed (spec/impl/tests/e2e); TOON format parity implemented","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.14","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T07:35:38.532820388Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.14.1","title":"TOON Spec: extract encoder detection + envelope schema + stats + fallback","description":"Extract exact legacy Python toon-format behavior into a self-contained spec + vectors.\n\nLegacy sources:\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/app.py`:\n  - format handling for tools (format arg)\n  - encoder detection (`_looks_like_toon_rust_encoder`)\n  - encoder invocation (`_run_toon_encode`) and stderr parsing for stats\n  - fallback behavior on encoder error\n- Resources: where query param `format=toon` is handled and how it wraps blocks\n- Config env vars:\n  - TOON_DEFAULT_FORMAT\n  - TOON_STATS\n  - TOON_TRU_BIN / TOON_BIN\n- Tests:\n  - `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_toon_formatting.py`\n  - `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/e2e/test_toon_format_e2e.py`\n\nMust capture verbatim:\n- Envelope JSON shape for tools and resources:\n  - required keys: format, data, meta\n  - meta fields (encoder name, toon_stats fields, toon_error on fallback)\n- Encoder selection precedence:\n  - which env vars are consulted and in what order\n  - how encoder looks valid is determined\n- Stats parsing:\n  - how json_tokens/toon_tokens are extracted from stderr\n- Fallback:\n  - non-zero exit, empty stdout, missing encoder -> fall back to JSON envelope\n\nDeliverables:\n- Add a Toon Output Format section to `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md`.\n- Add vectors under `crates/mcp-agent-mail-tools/tests/fixtures/toon/`:\n  - sample JSON payloads and expected envelopes\n  - sample stderr lines and expected parsed stats\n\n## Acceptance Criteria\n- Spec is complete enough to implement without re-reading Python.\n- Vectors cover:\n  - successful encode\n  - encoder missing/invalid\n  - encoder returns non-zero\n  - TOON_STATS on/off\n- Spec explicitly states how resources apply toon formatting (query param).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:35:51.901356626Z","created_by":"ubuntu","updated_at":"2026-02-05T14:31:38.135865541Z","closed_at":"2026-02-05T14:31:38.135780882Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.14.1","depends_on_id":"br-2ei.14","type":"parent-child","created_at":"2026-02-05T07:35:51.901356626Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.14.2","title":"TOON Impl: format=toon wrappers for tools + resources (stub-friendly)","description":"Implement toon formatting in Rust per spec `br-2ei.14.1`.\n\nWork:\n- Config parsing (core): add missing TOON_* env vars and defaults.\n- Encoder selection + validation:\n  - resolve encoder binary path from TOON_TRU_BIN / TOON_BIN (and any legacy defaults)\n  - implement a validity check equivalent to legacy `_looks_like_toon_rust_encoder`\n- Encoder invocation:\n  - spawn encoder process with payload via stdin or args (match legacy)\n  - capture stdout/stderr + exit code\n  - parse stderr for token stats when TOON_STATS enabled\n- Envelope:\n  - wrap successful encode in {format:\"toon\", data:\"<TOON>\", meta:{...}}\n  - on failure, return JSON envelope with meta.toon_error (spec-accurate)\n- Tool integration:\n  - support `format` argument across tools (at least those in legacy tests/e2e)\n  - ideally implement as a single response-wrapper layer so all tools inherit it\n- Resource integration:\n  - support `?format=toon` query param on resources and wrap returned blocks accordingly\n\nConstraints:\n- No tokio runtime.\n- Must be testable with a stub encoder binary (no real tru required).\n\n## Acceptance Criteria\n1. Tool calls with format=toon match legacy envelopes and pass unit/integration tests.\n2. Resource reads with format=toon match legacy envelopes and pass tests.\n3. Fallback behavior on encoder failure matches spec.\n4. No impact to default JSON behavior.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:36:01.395611114Z","created_by":"ubuntu","updated_at":"2026-02-05T14:45:51.253235315Z","closed_at":"2026-02-05T14:45:51.253150725Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.14.2","depends_on_id":"br-2ei.14","type":"parent-child","created_at":"2026-02-05T07:36:01.395611114Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.14.2","depends_on_id":"br-2ei.14.1","type":"blocks","created_at":"2026-02-05T07:36:28.263232165Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.14.3","title":"TOON Tests: unit + integration + offline stub encoder","description":"Add comprehensive tests for toon formatting parity.\n\nWork:\n- Unit tests:\n  - encoder path resolution + validity check\n  - stderr stats parsing (TOON_STATS)\n  - fallback behavior on non-zero exit / missing encoder\n- Integration tests (mirror legacy `test_toon_formatting.py`):\n  - tool output envelope for format=toon (health_check)\n  - resource output envelope for format=toon (resource://projects, resource://config/environment)\n  - resource query param format=toon is honored\n  - fallback on encoder error returns JSON envelope with meta.toon_error\n- E2E-ish test (mirror legacy `test_toon_format_e2e.py` but offline):\n  - call a small sequence of tools + one resource with format=toon\n  - write a structured log artifact for debugging failures\n\nImplementation detail:\n- Provide a deterministic stub encoder for tests (script or tiny Rust test helper) that:\n  - reads JSON payload and outputs fixed toon text\n  - optionally emits token stats to stderr\n\n## Acceptance Criteria\n- `cargo test` covers toon formatting paths and passes.\n- Tests are deterministic/offline and do not require tru/toon installed.\n- Failure output includes the envelope diff and captured stub stderr.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:36:11.883852255Z","created_by":"ubuntu","updated_at":"2026-02-05T14:55:21.602314400Z","closed_at":"2026-02-05T14:55:21.602252894Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.14.3","depends_on_id":"br-2ei.14","type":"parent-child","created_at":"2026-02-05T07:36:11.883852255Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.14.3","depends_on_id":"br-2ei.14.2","type":"blocks","created_at":"2026-02-05T07:36:28.351699752Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.14.4","title":"TOON E2E: add scripts/e2e_toon.sh suite (artifacts + diffs)","description":"Add a dedicated toon-format E2E suite to prove the end-to-end behavior stays correct.\n\nScript:\n- scripts/e2e_toon.sh (wired into scripts/e2e_test.sh)\n\nFlow:\n- Start server/router in a temp workspace.\n- Run a representative set of tool calls with format=toon:\n  - health_check\n  - ensure_project\n  - register_agent\n- Read at least one resource with format=toon query param:\n  - resource://inbox/{agent}?project=...&format=toon\n- Validate:\n  - envelope shape\n  - format=\"toon\" on success\n  - fallback behavior when encoder is intentionally broken (meta.toon_error)\n\nArtifacts:\n- tests/artifacts/toon/<timestamp>/\n- Capture requests + responses and encoder stdout/stderr.\n\n## Acceptance Criteria\n- scripts/e2e_toon.sh runs via scripts/e2e_test.sh toon.\n- Script is deterministic and emits clear diffs on mismatch.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T07:36:19.307490353Z","created_by":"ubuntu","updated_at":"2026-02-05T14:57:41.529318840Z","closed_at":"2026-02-05T14:57:41.529258938Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.14.4","depends_on_id":"br-2ei.14","type":"parent-child","created_at":"2026-02-05T07:36:19.307490353Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.14.4","depends_on_id":"br-2ei.14.2","type":"blocks","created_at":"2026-02-05T07:36:28.442541944Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.14.4","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T07:36:28.528752779Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.15","title":"Resources: query-param parsing parity (format=... and legacy filters)","description":"Implement legacy query-parameter parsing for resource URIs (beyond tool filtering).\n\nScope:\n- Identify all resource query params supported by legacy Python (e.g., format=toon/json, include_bodies, urgent_only, since_ts, active_only, ttl_seconds, limit).\n- Ensure parsing is consistent across fastmcp router + resource handlers (no accidental 400s for known params).\n- Normalize/validate params exactly like legacy: defaults, error messages, and type coercions.\n\nImplementation notes:\n- Where fastmcp routing drops query params, add an adapter layer or custom parser.\n- Document supported params in a parity table and keep it in sync with conformance fixtures.\n\nTests:\n- Unit: param parsing for each resource, invalid values, missing params.\n- Conformance: add fixture cases for each resource query variant.\n- E2E: include resource queries in scripts/e2e_http.sh (or existing HTTP parity suite) with diffs on mismatch.\n\nLogging/artifacts:\n- On mismatch, emit expected vs actual JSON diffs.\n- Store HTTP transcripts under tests/artifacts/http/resources/<timestamp>/.\n\n## Acceptance Criteria\n1. All legacy-supported resource query params are parsed and honored.\n2. Invalid params yield legacy-matching errors.\n3. Conformance + E2E cover at least one query variant per resource.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T15:14:56.963670801Z","created_by":"ubuntu","updated_at":"2026-02-06T07:49:03.921055654Z","closed_at":"2026-02-06T07:49:03.921035947Z","close_reason":"Verified all 23 resource handlers already implement query parameter parsing via split_param_and_query. Added comprehensive test suite (27 tests): split_param_and_query (4), parse_query (5), parse_bool_param Python parity (3), percent_decode_component (5), resource URI integration patterns (10  inbox, thread, acks_stale, file_reservations, outbox, encoded paths). Boolean parsing matches legacy Python exactly (1/true/t/yes/y case-insensitive). Clippy clean.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.15","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T15:14:56.963670801Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.16","title":"DB: schema migration story (sqlmodel MigrationRunner + tests)","description":"Define and implement the schema migration strategy using sqlmodel_rust (MigrationRunner), matching legacy behavior.\n\nScope:\n- Establish a migrations table/versioning scheme.\n- Ensure init is idempotent and safe on existing DBs.\n- Provide a CLI entry point if legacy supports (or document as internal).\n\nTests:\n- Unit: migration ordering + version tracking.\n- Integration: create DB at older version, run migrate, verify schema + data preserved.\n- Negative: corrupted schema, missing tables; ensure diagnostics are clear and non-destructive.\n\nLogging/artifacts:\n- Store migration logs under tests/artifacts/db/migrations/<timestamp>/.\n- On mismatch, print schema diffs (expected vs actual).\n\n## Acceptance Criteria\n1. Migrations are deterministic, idempotent, and match legacy expectations.\n2. Running migrate on a fresh DB is a no-op beyond init.\n3. Tests validate upgrade path without data loss.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T15:15:23.185487024Z","created_by":"ubuntu","updated_at":"2026-02-06T07:17:24.585316780Z","closed_at":"2026-02-06T07:17:24.585298496Z","close_reason":"Implemented sqlmodel MigrationRunner-based schema migrations + CLI migrate + tests","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.16","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T15:15:23.185487024Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.17","title":"Perf: speed up resource://file_reservations cleanup scan","description":"## Objective\nFix a real-world perf failure: `resource://file_reservations/{slug}` timed out when cleanup scanned *all* historical file_reservations rows.\n\n## Scope\n- DB: add a query that lists **unreleased** reservations (`released_ts IS NULL`) regardless of expiry, so cleanup no longer scans released history.\n- Tools resource: use the unreleased-only query for cleanup; keep output semantics unchanged.\n- Remove redundant DB queries (avoid double `list_agents`).\n\n## Perf Baseline\n- Before: `resource://file_reservations/...` hit the 60s resources/read timeout in practice (cleanup scanned full history).\n- After: should return within the MCP timeout under the same DB state.\n\n## Acceptance Criteria\n1. Cleanup loop never loads released reservations (history) into memory.\n2. Output JSON remains stable (ordering + fields).\n3. `cargo fmt --check`, `cargo clippy --all-targets -- -D warnings`, `cargo test` all PASS.","status":"closed","priority":1,"issue_type":"task","assignee":"CoralBeacon","created_at":"2026-02-06T01:10:01.002283763Z","created_by":"ubuntu","updated_at":"2026-02-06T02:18:09.295156550Z","closed_at":"2026-02-06T02:18:09.295131293Z","close_reason":"Fixed git/fs activity semantics + expires_ts clamp regression; keep unreleased-only cleanup scan; verified via fmt/check/clippy/test (mcp-agent-mail-tools)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.17","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-06T01:10:01.002283763Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.18","title":"MCP tools: send_message/thread_id causes timeouts and server becomes unreachable","description":"## Observed\nTool calls to the local MCP Agent Mail HTTP server became unreachable after calling `send_message` with a `thread_id` (and even without).\n\nSymptoms:\n- `send_message(..., thread_id=\"br-threadid-test\")` timed out (60s).\n- Subsequent tool calls (`fetch_inbox`, `whois`, `health_check`) timed out or failed with transport send errors to `http://127.0.0.1:8765/mcp/`.\n\n## Hypotheses\n- Deadlock or long-running operation inside `send_message` (DB transaction held, git/archive write, attachment conversion) causing request handler starvation.\n- Panic/crash in tool handler when `thread_id` is set (or on created_ts formatting), bringing down HTTP server.\n\n## Repro Steps\n1. Start server: `cargo run -p mcp-agent-mail -- serve --host 127.0.0.1 --port 8765`.\n2. Call `send_message(project_key=\"/data/projects/mcp_agent_mail_rust\", sender_name=\"RusticGlen\", to=[\"RusticGlen\"], subject=\"...\", body_md=\"...\", thread_id=\"br-threadid-test\")`.\n3. Observe whether request completes; then call `health_check` / `fetch_inbox`.\n\n## Acceptance Criteria\n- `send_message` returns promptly for trivial messages (no attachments) regardless of `thread_id`.\n- Server remains responsive after `send_message`.\n- Add a regression test (unit or conformance) that fails fast on handler stalls/panics.\n","status":"closed","priority":1,"issue_type":"bug","assignee":"RusticGlen","created_at":"2026-02-06T17:58:01.765881558Z","created_by":"ubuntu","updated_at":"2026-02-06T18:08:26.404453839Z","closed_at":"2026-02-06T18:08:26.404430395Z","close_reason":"Out of scope: incident was external coordination server (python) restart/transient; no Rust-port action identified","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.18","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-06T17:58:01.765881558Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.19","title":"Gitignore: ignore SQLite -wal/-shm files","description":"## Problem\nSQLite WAL-mode databases create `*.sqlite3-wal` and `*.sqlite3-shm` files (and `storage.sqlite3-wal/shm`) that show up as untracked noise.\n\n## Acceptance Criteria\n- `.gitignore` ignores `*.sqlite3-wal` and `*.sqlite3-shm` (and `storage.sqlite3-wal/shm`).\n- No code behavior changes.\n","status":"closed","priority":3,"issue_type":"task","assignee":"RusticGlen","created_at":"2026-02-06T18:21:37.985483349Z","created_by":"ubuntu","updated_at":"2026-02-06T18:24:25.998008193Z","closed_at":"2026-02-06T18:24:25.997922592Z","close_reason":"Added *.sqlite3-wal and *.sqlite3-shm to .gitignore to prevent untracked noise","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.19","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-06T18:21:37.985483349Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2","title":"Storage: Git archive write/read pipeline + attachments","description":"Implement the git-backed mailbox archive described in EXISTING_MCP_AGENT_MAIL_STRUCTURE.md.\n\nLegacy Python writes messages + file reservations + attachments into a per-project git repo and uses it as an auditable artifact store.\n\nScope (must match legacy behavior):\n- Archive root creation + .gitattributes\n- Per-project advisory locks (.archive.lock + owner metadata)\n- Commit batching queue (max 10, max wait 50ms)\n- Message write pipeline:\n  - canonical messages/YYYY/MM/*.md\n  - agents/<Agent>/inbox + outbox copies\n  - thread digest files (messages/threads/<thread_id>.md) if present in legacy\n  - git commit message format\n- File reservation artifacts (file_reservations/<sha1(pattern)>.json + id-<id>.json)\n- Attachment pipeline:\n  - compute content hashes\n  - convert images to WebP when enabled\n  - inline small attachments (< 64KiB) into markdown\n  - keep originals when configured\n  - write manifests + audit logs\n- Read helpers for resources that include commit metadata.\n\nConstraints:\n- Prefer git2 library; avoid shelling out when possible.\n- Prefer asupersync for IO/concurrency.\n\n## Success Criteria\n1. Artifact conformance (br-2ei.1.3) can assert archive artifacts match legacy (layout + frontmatter + body + attachment manifests).\n2. E2E archive suite (br-2ei.9.2) passes and produces rich artifacts/logs.\n3. Benchmarks include archive write throughput and lock/commit batching overhead budgets.\n4. No cross-process corruption: advisory locks are cross-platform and stale-lock recovery is safe.","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-02-05T05:06:24.771240880Z","created_by":"ubuntu","updated_at":"2026-02-05T06:32:27.969412199Z","closed_at":"2026-02-05T06:32:27.969352095Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2.1","title":"Archive: initialize archive root + per-project git repos + .gitattributes","description":"Implement archive initialization in mcp-agent-mail-storage.\n\nRequirements:\n- Determine archive root from Config.storage_root (default ~/.mcp_agent_mail_git_mailbox_repo).\n- Ensure root exists.\n- For each project slug, ensure a git repo exists at <root>/<slug>/.\n- Ensure expected top-level dirs exist: agents/, messages/, attachments/, file_reservations/.\n- Write .gitattributes (at least: enforce LF for *.md and binary for images).\n- Ensure git author identity set from config (name/email) for commits.\n\nImplementation:\n- Use git2 to init and commit initial scaffolding if repo newly created.\n\nAcceptance:\n- Idempotent: calling multiple times does not change repo.\n- Unit test with temp dir.\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:09:03.245769103Z","created_by":"ubuntu","updated_at":"2026-02-05T05:54:58.115198238Z","closed_at":"2026-02-05T05:51:33.438544202Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2.1","depends_on_id":"br-2ei.2","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.1","depends_on_id":"br-2ei.2.8","type":"blocks","created_at":"2026-02-05T05:54:58.115151750Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2.2","title":"Archive: per-project advisory locks + commit batching queue","description":"Implement concurrency control for archive writes.\n\nSpec:\n- Per-project advisory lock file: <project>/.archive.lock (+ optional owner metadata JSON).\n- Commit queue batching: max 10 commits or max wait 50ms.\n- Stale lock cleanup on startup.\n\nImplementation notes:\n- Use filesystem lock (cross-platform) + busy-timeout retry. Prefer asupersync primitives if available.\n- Keep API simple for callers: `with_project_lock(project_slug, || ...)`.\n- Batching should preserve ordering for operations within a single process.\n\nAcceptance:\n- Unit tests simulate concurrent lock acquisition.\n- Bench: lock acquisition overhead is low.\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:09:10.275499179Z","created_by":"ubuntu","updated_at":"2026-02-05T05:59:10.781991766Z","closed_at":"2026-02-05T05:59:10.781924088Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2.2","depends_on_id":"br-2ei.2","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.2","depends_on_id":"br-2ei.2.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.2","depends_on_id":"br-2ei.2.8","type":"blocks","created_at":"2026-02-05T05:54:58.195154847Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2.3","title":"Archive: message write pipeline (canonical + inbox/outbox + commit) + frontmatter format","description":"Implement message archival writes that mirror legacy Python.\n\nSpec (EXISTING_MCP_AGENT_MAIL_STRUCTURE.md):\n- Canonical: messages/YYYY/MM/<timestamp>__<subject_slug>__<id>.md\n- Outbox: agents/<sender>/outbox/YYYY/MM/... (same rel path)\n- Inboxes: agents/<recipient>/inbox/YYYY/MM/...\n- Frontmatter: JSON preceded by ---json header line, then Markdown body.\n- Git commit summary: \"message <id> from <sender> to <recipients>\".\n\nInputs:\n- Message record + recipients + markdown body + attachments metadata.\n\nOutputs:\n- Files written atomically.\n- Git commit performed (or batched) and commit info stored/returned where needed.\n\nAcceptance:\n- Deterministic path + slug generation.\n- Conformance can assert files exist and parse.\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:09:23.321591344Z","created_by":"ubuntu","updated_at":"2026-02-05T05:59:12.811257421Z","closed_at":"2026-02-05T05:59:12.811191858Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2.3","depends_on_id":"br-2ei.2","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.3","depends_on_id":"br-2ei.2.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.3","depends_on_id":"br-2ei.2.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.3","depends_on_id":"br-2ei.2.8","type":"blocks","created_at":"2026-02-05T05:54:58.279552433Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2.4","title":"Archive: file reservation artifacts (sha1(pattern).json + id-<id>.json)","description":"Implement archive writes for file reservations.\n\nSpec:\n- file_reservations/<sha1(path_pattern)>.json\n- file_reservations/id-<id>.json\n\nRequirements:\n- JSON includes {id, agent, path_pattern, exclusive, reason, created_ts, expires_ts, released_ts} at minimum.\n- Writes are atomic.\n- Archive writes happen on reservation create/update/release and are committed (or batched).\n\nAcceptance:\n- Resource `resource://file_reservations/{slug}` can be backed by archive artifacts (optional) and/or DB.\n- Conformance can assert artifact existence.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:09:35.083785229Z","created_by":"ubuntu","updated_at":"2026-02-05T05:59:15.036374259Z","closed_at":"2026-02-05T05:59:15.036307894Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2.4","depends_on_id":"br-2ei.2","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.4","depends_on_id":"br-2ei.2.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.4","depends_on_id":"br-2ei.2.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.4","depends_on_id":"br-2ei.2.8","type":"blocks","created_at":"2026-02-05T05:54:58.363912498Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2.5","title":"Archive: attachment pipeline (hashing, WebP conversion, manifests, inline small)","description":"Implement attachment handling for both tool message sending and share/export.\n\nSpec:\n- attachments/<sha1[:2]>/<sha1>.webp\n- attachments/originals/<sha1[:2]>/<sha1>.<ext>\n- attachments/_manifests/<sha1>.json\n- attachments/_audit/<sha1>.log\n\nBehavior:\n- Convert images to WebP when enabled; disable when stderr not tty? (mirror legacy policy).\n- Inline attachments <= 64KiB into markdown; store larger attachments as files and reference via manifest.\n- Optionally keep originals.\n- Ensure deterministic hashing + stable paths.\n\nAcceptance:\n- Conformance can assert archive artifacts and message frontmatter attachment refs.\n- Works cross-platform.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:09:49.770615401Z","created_by":"ubuntu","updated_at":"2026-02-05T06:05:10.101840243Z","closed_at":"2026-02-05T06:05:10.101777995Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2.5","depends_on_id":"br-2ei.2","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.5","depends_on_id":"br-2ei.2.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.5","depends_on_id":"br-2ei.2.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.5","depends_on_id":"br-2ei.2.3","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.5","depends_on_id":"br-2ei.2.8","type":"blocks","created_at":"2026-02-05T05:54:58.445702962Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2.6","title":"Archive: read helpers + commit metadata (mailbox-with-commits/outbox/inbox views)","description":"Implement archive reads used by resources that include commit context.\n\nScope:\n- Given a canonical message path, map to git commit that introduced it.\n- Provide lightweight commit metadata (sha, summary, authored_ts) for mailbox/outbox views.\n- Support `whois(include_recent_commits=true)` by reading recent archive commits filtered by author.\n\nImplementation:\n- Prefer git2 for log traversal.\n- Cache where sensible to avoid O(N) per request.\n\nAcceptance:\n- Resource outputs match legacy Python shapes for mailbox-with-commits and whois.\n- Benchmarks cover common read paths.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:10:02.774438616Z","created_by":"ubuntu","updated_at":"2026-02-05T06:08:17.925340091Z","closed_at":"2026-02-05T06:08:17.925279166Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2.6","depends_on_id":"br-2ei.2","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.6","depends_on_id":"br-2ei.2.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.6","depends_on_id":"br-2ei.2.3","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2.7","title":"Reservations: implement force_release_file_reservation (inactivity heuristics + optional notify)","description":"Implement force-release stale file reservations (MCP tool).\n\nSpec:\n- Validate reservation appears abandoned:\n  - agent inactive beyond threshold\n  - no recent mail activity\n  - no recent filesystem/git activity (archive)\n- When released, optionally notify previous holder with a human-readable note.\n\nImplementation plan:\n- Define which activity signals we can reliably measure in Rust:\n  - `agent.last_active_ts` in DB\n  - last message activity timestamps (inbox/outbox/canonical)\n  - archive activity timestamps (last commit touching agent/mail artifacts)\n- Implement heuristics with conservative defaults and an explicit why explanation string.\n- Write release to DB + archive artifacts (so humans can audit forced releases).\n- If `notify_previous=true`: send a threaded message to the previous holder explaining the forced release and including the heuristics snapshot.\n\n## Acceptance Criteria\n- Safety / correctness:\n  - Force-release is denied unless heuristics strongly indicate abandonment (tests cover deny path).\n  - When allowed, release updates both DB state and archive artifacts (tests assert both).\n  - No-op behavior when reservation already released/expired is well-defined.\n- Observability:\n  - Tool output includes a machine-parseable explanation (what signals were checked + thresholds + timestamps used).\n  - Optional notify message includes the explanation and the operators note.\n- Conformance:\n  - Fixture-based conformance tests cover at least: allow path, deny path, and allow-with-notify path.\n- Tests:\n  - Unit tests cover heuristic evaluation boundary conditions (just-below/just-above thresholds).\n  - Integration test runs through the full tool pipeline and validates resulting archive messages + reservation state.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:10:29.903046515Z","created_by":"ubuntu","updated_at":"2026-02-05T06:30:28.285447850Z","closed_at":"2026-02-05T06:30:28.285367769Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2.7","depends_on_id":"br-2ei.2","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.7","depends_on_id":"br-2ei.2.4","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.7","depends_on_id":"br-2ei.2.6","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2.8","title":"Archive spec: exact paths/frontmatter/commit + .gitattributes + attachment policy","description":"Extract the exact legacy git-archive behavior into a self-contained spec + test vectors.\n\nMust extract verbatim from legacy Python:\n- Archive root path rules (defaults + env/CLI overrides)\n- Repo initialization behavior:\n  - exact directory layout\n  - exact .gitattributes content (line endings + binary rules)\n  - initial commit behavior + message (if any)\n- Message path format rules:\n  - timestamp formatting\n  - subject slug rules (unicode, punctuation, truncation)\n  - ID formatting\n- Frontmatter format:\n  - exact header line(s)\n  - JSON formatting rules (pretty vs compact, key ordering if any)\n  - trailing newlines\n- Outbox/inbox copy rules\n- Commit batching semantics (what gets grouped into a commit, commit message format)\n- Reservation artifact JSON schema and naming (sha1 inputs, casing)\n- Attachment policy:\n  - hashing algorithm(s)\n  - WebP conversion policy triggers\n  - inline thresholds and exact markdown embedding format\n  - manifest/audit log formats\n\nDeliverables:\n- Explicit spec section in EXISTING_MCP_AGENT_MAIL_STRUCTURE.md (or equivalent) with concrete examples.\n- Test vectors for slug/frontmatter and a golden file tree for 1-2 representative messages.\n\nAcceptance:\n- Implementers can build br-2ei.2.* without consulting Python again.\n- Unit tests can assert byte-for-byte markdown + JSON artifact equality.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:54:29.422073298Z","created_by":"ubuntu","updated_at":"2026-02-05T05:59:38.804611487Z","closed_at":"2026-02-05T05:59:38.804548929Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2.8","depends_on_id":"br-2ei.2","type":"parent-child","created_at":"2026-02-05T05:54:29.422073298Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.20","title":"Bug: subject truncation panicked on multi-byte UTF-8 characters","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-06T18:46:14.988557166Z","created_by":"ubuntu","updated_at":"2026-02-06T18:46:14.988557166Z","closed_at":"2026-02-06T18:46:14.988557166Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.20","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-06T18:46:14.988557166Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.3","title":"Guard: pre-commit/pre-push enforcement + install/uninstall tooling","description":"Implement the Agent Mail guard system (pre-commit / pre-push hooks) that prevents edits when exclusive file reservations conflict.\n\nSpec source:\n- EXISTING_MCP_AGENT_MAIL_STRUCTURE.md section \"Guard Behavior (Pre-Commit / Pre-Push)\"\n\nScope:\n- `mcp-agent-mail-guard` crate:\n  - install_guard(project, repo): resolves hooks dir (core.hooksPath or default), writes chain-runner hooks, writes plugin scripts under hooks.d/<hook>.\n  - uninstall_guard(repo): removes our plugins; removes chain-runner only if safe (no other plugins) and restores .orig if applicable.\n  - guard_status(repo): reports resolved hooks path + presence of pre-commit/pre-push + mode.\n  - guard_check(repo, paths, advisory): checks active file reservations and returns conflicts (pattern, holder, expires_ts).\n- MCP tools:\n  - install_precommit_guard(project_key, code_repo_path)\n  - uninstall_precommit_guard(code_repo_path)\n- CLI wiring:\n  - `am guard install|uninstall|status|check` delegates to the guard crate.\n\nImplementation notes:\n- Use git2 to discover repo + read config.\n- Path matching: prefer pathspec (gitignore syntax) with symmetric fnmatch fallback.\n- Must respect env vars: AGENT_MAIL_GUARD_MODE, AGENT_MAIL_BYPASS, AGENT_NAME.\n\n## Success Criteria\n1. Guard tool outputs match legacy fixtures (install/uninstall/status/check).\n2. Unit + integration tests cover: hooksPath/worktrees, idempotent install/uninstall, path matching, rename handling, conflict detection.\n3. E2E guard suite (br-2ei.9.3) blocks commits on conflicts and allows after release, with clear stderr and rich artifacts.","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-02-05T05:06:34.458664027Z","created_by":"ubuntu","updated_at":"2026-02-05T06:32:18.466527207Z","closed_at":"2026-02-05T06:32:18.466466844Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.3","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.3.1","title":"Guard: resolve repo + hooks dir (core.hooksPath, worktrees) via git2","description":"Implement robust hooks directory resolution.\n\nRequirements:\n- Input: repo working tree path (code_repo_path).\n- Discover git repo (supports worktrees).\n- Determine hooks dir:\n  - If core.hooksPath is set: resolve relative to repo root per git semantics.\n  - Else: use default hooks dir for the repository common dir.\n- Return resolved hooks_dir as a real filesystem path.\n\nMust handle:\n- .git is a file containing gitdir: ...\n- worktrees where hooks live in common dir\n- bare repo (if encountered) -> treat as invalid for hook install\n\nDeliverable:\n- `mcp_agent_mail_guard::resolve_hooks_dir(repo: &Path) -> GuardResult<PathBuf>` (or equivalent internal helper) with unit tests.\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:07:47.277296976Z","created_by":"ubuntu","updated_at":"2026-02-05T05:18:05.735479435Z","closed_at":"2026-02-05T05:18:05.735461692Z","close_reason":"Implemented resolve_hooks_dir via git2 + commondir parsing; added unit tests incl. worktree case.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.3.1","depends_on_id":"br-2ei.3","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.3.2","title":"Guard: install/uninstall chain-runner hooks + agent-mail plugin scripts","description":"Implement install/uninstall mechanics (pre-commit and optionally pre-push).\n\nInstall behavior (match legacy):\n- Ensure hooks.d/<hook>/ directory exists.\n- Write/overwrite top-level hook script (chain-runner) that executes hooks.d/<hook>/* in lexical order.\n- Preserve existing non-chain hook as <hook>.orig.\n- Install our plugin under hooks.d/<hook>/50-agent-mail (or equivalent) that executes the actual guard check.\n- Create Windows shims (.cmd/.ps1) if needed to invoke the chain-runner.\n\nUninstall behavior:\n- Remove our plugins (hooks.d/<hook>/50-agent-mail.*).\n- Only remove chain-runner if it is ours AND there are no other plugins remaining AND no .orig restoration is needed.\n- If .orig exists and chain-runner is removed, restore it.\n\nDeliverables:\n- `install_guard(project_key, repo)` writes files and chmods +x on unix.\n- `uninstall_guard(repo)` removes/restores safely.\n- Unit tests use temp git repos.\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:08:05.382529734Z","created_by":"ubuntu","updated_at":"2026-02-05T05:25:45.469594914Z","closed_at":"2026-02-05T05:25:45.469578243Z","close_reason":"Implemented install_guard/uninstall_guard: resolves hooks dir, installs python chain-runner + Windows shims, installs plugin stub, preserves/restores existing hook via .orig; added unit test for preserve/restore.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.3.2","depends_on_id":"br-2ei.3","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.3.2","depends_on_id":"br-2ei.3.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.3.3","title":"Guard: implement conflict detection (reservations + path matching + rename handling)","description":"Implement the actual guard decision logic.\n\nInputs:\n- repo path\n- list of paths to check (from staged diff for pre-commit, from commit range for pre-push)\n- AGENT_NAME env var identifies current agent\n- mode: block vs warn (AGENT_MAIL_GUARD_MODE)\n- bypass env: AGENT_MAIL_BYPASS=1\n\nLogic:\n- If guard disabled (WORKTREES_ENABLED or GIT_IDENTITY_ENABLED false): allow.\n- Load active file reservations for the project identity associated with repo (project_identity_mode logic).\n- If any exclusive reservation matches any path (symmetric matching) and reservation holder != AGENT_NAME and unexpired: conflict.\n- For renames: treat both old and new paths as touched.\n\nDeliverables:\n- Pure function that returns conflicts (pattern, holder, expires_ts) for a given path list.\n- Helper to obtain staged paths from git: `git diff --cached --name-only -z --diff-filter=ACMRDTU` and rename pairs from `--name-status -M -z`.\n- Helper to obtain pre-push paths from stdin refs (`git rev-list`) with fallback to `git diff --name-status -M -z <remote>..<local>`.\n\nTests:\n- Synthetic reservations + path lists.\n- Temp repo with staged rename.\n\n## Acceptance Criteria\n1. Guard conflict detection matches legacy behavior for:\n   - exclusive vs shared reservations\n   - holder == AGENT_NAME bypass\n   - expired/released reservations\n   - rename pairs (old + new paths considered touched)\n2. Unit tests cover synthetic and real-repo staged rename scenarios.\n3. Hook output is clear enough that the E2E guard suite can assert expected failure messaging.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:08:19.800578519Z","created_by":"ubuntu","updated_at":"2026-02-05T06:16:39.864330762Z","closed_at":"2026-02-05T06:16:39.864261040Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.3.3","depends_on_id":"br-2ei.3","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.3.3","depends_on_id":"br-2ei.3.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.3.4","title":"Guard Tools: install_precommit_guard/uninstall_precommit_guard wiring","description":"Wire MCP tools to the Rust guard crate (fixture generation + conformance assertions live under br-2ei.1.*; keep this issue implementation-only).\n\nTools:\n- install_precommit_guard(project_key, code_repo_path)\n- uninstall_precommit_guard(code_repo_path)\n\nRequirements:\n- Call into mcp-agent-mail-guard for repo discovery + hooks dir resolution.\n- Idempotent + safe:\n  - Install preserves existing hooks and writes chain-runner + agent-mail plugin(s).\n  - Uninstall removes only agent-mail components; restores preserved hooks when applicable.\n- Error parity:\n  - Invalid repo paths, non-repo dirs, permission errors map to the same error semantics as legacy.\n- Output parity:\n  - JSON-RPC result shape must match legacy fixtures exactly.\n\nTests:\n- Unit tests: parameter validation + error mapping.\n- Integration test: temp git repo, run tool handler install then uninstall, assert expected hook files created/removed.\n\n## Acceptance Criteria\n1. Tool handlers call mcp-agent-mail-guard and are idempotent and safe (no clobber of existing hooks).\n2. Errors for invalid paths/non-repos/permission issues match legacy (status + message shape).\n3. Unit + integration tests cover install/uninstall success, preserve/restore behavior, and error mapping.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:08:32.548948635Z","created_by":"ubuntu","updated_at":"2026-02-05T06:25:07.728723226Z","closed_at":"2026-02-05T06:25:07.728662662Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.3.4","depends_on_id":"br-2ei.3","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.3.4","depends_on_id":"br-2ei.3.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.3.5","title":"Guard: add unit + integration tests (git repos, worktrees, hooksPath, conflicts)","description":"Add focused tests to ensure guard behavior remains correct.\n\nTests should cover:\n- hooks dir resolution: default vs core.hooksPath vs worktree common dir.\n- install/uninstall idempotency and preservation of existing hooks.\n- path matching: pathspec (if enabled) vs fnmatch fallback.\n- conflict detection: exclusive reservations by other agent blocks; shared reservations do not.\n- rename pairs considered touched.\n\n## Acceptance Criteria\n1. `cargo test -p mcp-agent-mail-guard` includes unit + integration coverage for the above behaviors.\n2. Tests include detailed assertions/messages so failures show exact mismatch (paths, patterns, holder, env mode).\n3. Tests run in temp dirs and are hermetic (no reliance on developer machine state).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:08:46.185640629Z","created_by":"ubuntu","updated_at":"2026-02-05T06:17:15.030854934Z","closed_at":"2026-02-05T06:17:15.030779843Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.3.5","depends_on_id":"br-2ei.3","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.3.5","depends_on_id":"br-2ei.3.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.3.5","depends_on_id":"br-2ei.3.3","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4","title":"Share/Export: static bundle pipeline (SQLite snapshot + scrub + attachments + signing/encryption)","description":"Port legacy share/export pipeline to Rust (mcp-agent-mail-share + CLI).\n\nSpec source:\n- EXISTING_MCP_AGENT_MAIL_STRUCTURE.md section \"Share / Export Pipeline (Static Bundle)\"\n\nScope:\n- Snapshot SQLite safely (WAL checkpoint + sqlite backup) into export DB.\n- Apply project scoping (delete rows from other projects).\n- Scrub presets: standard/strict/archive.\n- Build FTS + materialized views; add indexes.\n- Finalize DB for export (journal_mode=DELETE, page_size=1024, VACUUM, ANALYZE).\n- Bundle attachments:\n  - Inline <= 64KiB\n  - Detach >= 25MiB\n  - Copy others into attachments/<sha256[:2]>/<sha256>.<ext>\n  - Rewrite messages.attachments JSON to bundle paths / data URIs\n- Chunk DB if >= 20MiB.\n- Bundle scaffolding: manifest.json, README, deploy hints, _headers.\n- Optional: sign manifest (Ed25519), encrypt bundle (age), package zip.\n\nConstraints:\n- Prefer sqlmodel_rust for SQLite operations.\n- Prefer asupersync for IO.\n\n## Success Criteria\n1. CLI share commands work end-to-end and match legacy behavior where specified.\n2. Bundle output is deterministic for identical inputs (stable ordering + hashing).\n3. E2E share suite (br-2ei.9.4) passes and produces a verifiable bundle tree + hashes.\n4. Benchmarks exist for share/export throughput and enforce regression budgets.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-05T05:06:43.381856509Z","created_by":"ubuntu","updated_at":"2026-02-05T14:22:00.077127Z","closed_at":"2026-02-05T14:22:00.077065013Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.1","title":"Share: SQLite snapshot + project scoping (WAL checkpoint + backup)","description":"Implement share/export phase 1: snapshot + project scoping.\n\nThis task consumes the extracted spec from `br-2ei.4.7`.\n\nWork (in `crates/mcp-agent-mail-share/`):\n- Open the live SQLite DB via `sqlmodel_rust` with appropriate busy-timeout.\n- Perform legacy-equivalent WAL checkpoint behavior before snapshot.\n- Use the SQLite backup API to create an export DB file (no mutation of live DB).\n- Apply project scoping rules to the export DB:\n  - delete rows for non-selected projects per spec\n  - preserve referential integrity (foreign keys / cascade behavior per spec)\n- Run any required integrity checks on the export DB (per spec).\n\n## Acceptance Criteria\n- Export DB creation is read-only w.r.t. the live DB (unit test asserts live DB unchanged).\n- Export DB passes `PRAGMA integrity_check` (and any other required PRAGMAs from spec).\n- Scoping correctness:\n  - Given a fixture DB with multiple projects + cross-table references, the scoped export contains only the selected project(s) and no dangling references.\n  - Exact table list + deletion semantics match the spec from `br-2ei.4.7`.\n- Determinism:\n  - Snapshot+scope on the same fixture produces a stable sha256 for the resulting DB file (after any required normalize/finalize steps for this phase).\n- Tests:\n  - Unit tests cover: busy/locked DB behavior, multi-project scoping, and integrity checks.\n  - Conformance fixture comparison is wired (Rust output vs Python fixture) for at least one scoped DB.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:12:07.493892557Z","created_by":"ubuntu","updated_at":"2026-02-05T08:09:50.930750975Z","closed_at":"2026-02-05T08:09:50.930719165Z","close_reason":"Implemented create_sqlite_snapshot (VACUUM INTO) + apply_project_scope with 8 tests (3 snapshot + 4 scope + 1 conformance against Python fixture). All passing.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.1","depends_on_id":"br-2ei.4","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.1","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T05:55:07.893842107Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.2","title":"Share: scrub presets (standard/strict/archive)","description":"Implement scrub logic on the scoped export DB.\n\nThis task must follow the extracted scrub rules from `br-2ei.4.7` exactly.\n\nPresets:\n- `standard`: remove obvious secrets, keep most content\n- `strict`: more aggressive scrubbing/redaction\n- `archive`: minimal/none (match legacy precisely)\n\nDeliverable (in `crates/mcp-agent-mail-share/`):\n- Deterministic scrub transformations for each preset.\n- A single entrypoint that takes (export_db_path, preset, scrub_seed/config) and produces a scrubbed DB (in-place or copy per spec).\n\n## Acceptance Criteria\n- Parity:\n  - For every preset, the scrub operations match the per-table/per-column rules extracted in `br-2ei.4.7`.\n  - Delete vs redact decisions match legacy.\n- Determinism:\n  - Running scrub twice on the same input DB yields byte-identical scrubbed DB output (or stable sha256 if finalization steps change file layout).\n  - Any ordering/normalization rules required for determinism are implemented and documented.\n- Tests:\n  - Unit tests cover each preset against conformance fixture DBs (from `br-2ei.4.7`) and assert expected hashes.\n  - Edge-case tests cover: NULLs, empty strings, unicode text, large blobs, missing optional tables/columns (if legacy tolerates).\n- Safety:\n  - Scrub does not panic on unexpected rows; it either scrubs conservatively or fails with a clear error that is surfaced to caller.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:12:12.920255187Z","created_by":"ubuntu","updated_at":"2026-02-05T08:15:01.040933972Z","closed_at":"2026-02-05T08:15:01.040873117Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.2","depends_on_id":"br-2ei.4","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.2","depends_on_id":"br-2ei.4.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.2","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T05:55:07.981100993Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.3","title":"Share: build FTS/views + export-finalize DB (indexes, journal_mode=DELETE, VACUUM, ANALYZE)","description":"Implement export DB finalization (FTS, views, indexes, and compacting).\n\nThis task consumes:\n- The scoped+scrubbed export DB produced by `br-2ei.4.1` + `br-2ei.4.2`.\n- The DDL/PRAGMA ordering spec extracted in `br-2ei.4.7`.\n\nWork (in `crates/mcp-agent-mail-share/`):\n- Build any required FTS index(es) and materialized views used by the static viewer.\n- Add export-only indexes (e.g., `subject_lower`, `sender_lower`) exactly as specified.\n- Apply export-finalize pragmas (e.g., `journal_mode=DELETE`, `page_size=1024`, and any `synchronous` choice per spec).\n- Run `VACUUM` + `ANALYZE` in the correct order.\n\n## Acceptance Criteria\n- Functional:\n  - Viewer-critical queries work against the finalized DB (unit test executes a representative set of queries and asserts expected row counts).\n  - FTS searches return expected results on a fixture DB.\n- Integrity + portability:\n  - Finalized DB passes `PRAGMA integrity_check`.\n  - Finalized DB opens in `sqlite3` CLI (sanity) and is not tied to WAL side files.\n- Determinism:\n  - Finalization produces stable output for the same input fixture (stable sha256 for resulting DB file).\n- Performance:\n  - Finalization time for a small fixture stays under an explicit budget (tracked in benchmark task `br-2ei.7.3`).\n- Tests:\n  - Unit tests cover: FTS DDL application, index creation, and VACUUM/ANALYZE ordering.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:12:24.355619779Z","created_by":"ubuntu","updated_at":"2026-02-05T08:19:23.533636149Z","closed_at":"2026-02-05T08:19:23.533568121Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.3","depends_on_id":"br-2ei.4","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.3","depends_on_id":"br-2ei.4.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.3","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T05:55:08.066003069Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.4","title":"Share: bundle attachments + rewrite messages.attachments JSON","description":"Implement attachment bundling + `messages.attachments` rewrite for share/export.\n\nThis epic splits the work so multiple agents can implement in parallel without stepping on each other.\n\nChild tasks:\n- `br-2ei.4.4.1`: attachment bundling pipeline (hashing, inline/detach decision, path layout, copying/dedupe).\n- `br-2ei.4.4.2`: rewrite `messages.attachments` JSON in the export DB to bundle references (schema + ordering) and validate references.\n\nNotes:\n- Thresholds/semantics MUST come from the legacy spec in `br-2ei.4.7` (do not guess).\n- Output must be deterministic (stable ordering, stable paths).\n\n## Success Criteria\n1. All child tasks are complete.\n2. Unit tests cover threshold boundaries, stable path layout, duplicate reuse, and stable JSON rewrite ordering.\n3. Share/export E2E (`br-2ei.9.4`) proves:\n   - bundle contains all referenced attachment paths\n   - detached attachments are represented exactly as legacy expects\n   - determinism holds across two exports from identical inputs","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-05T05:12:37.955382434Z","created_by":"ubuntu","updated_at":"2026-02-05T14:05:14.902960589Z","closed_at":"2026-02-05T14:05:14.902899625Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.4","depends_on_id":"br-2ei.2.5","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.4","depends_on_id":"br-2ei.4","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.4","depends_on_id":"br-2ei.4.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.4","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T05:55:08.149056843Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.4.1","title":"Share Attachments: bundling pipeline (hashing + copy/dedupe + inline/detach)","description":"Implement the attachment bundling pipeline for share/export.\n\nWork:\n- Decide representation for each attachment (per spec `br-2ei.4.7`):\n  - inline as `data:` URI when <= threshold\n  - detached marker when >= threshold\n  - otherwise copy into deterministic content-addressed path layout\n- Copy files into the bundle (deterministic naming) and dedupe identical content.\n- Produce a machine-usable bundling index (hash -> bundle path / inline / detached marker) for downstream rewrite step.\n\n## Acceptance Criteria\n- Threshold boundaries match the legacy spec exactly (no hard-coded guessing).\n- Paths are deterministic and content-addressed.\n- Duplicate attachments are not recopied.\n- Missing files are handled per spec (clear error or missing marker if legacy tolerates).\n- Unit tests cover:\n  - inline boundary\n  - detach boundary\n  - dedupe behavior\n  - extension inference rules (if any)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:03:30.718092122Z","created_by":"ubuntu","updated_at":"2026-02-05T08:26:49.552943955Z","closed_at":"2026-02-05T08:26:49.552857672Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.4.1","depends_on_id":"br-2ei.4.2","type":"blocks","created_at":"2026-02-05T07:03:38.917255798Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.4.1","depends_on_id":"br-2ei.4.4","type":"parent-child","created_at":"2026-02-05T07:03:30.718092122Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.4.1","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T07:03:39.002849166Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.4.2","title":"Share Attachments: rewrite messages.attachments JSON in export DB","description":"Rewrite `messages.attachments` JSON in the export DB to reference bundled attachment representations.\n\nWork:\n- Parse legacy attachment JSON schema from the export DB rows.\n- Rewrite per attachment to:\n  - bundle-relative path\n  - inline `data:` URI\n  - detached marker/metadata\n- Preserve legacy schema + ordering rules exactly.\n- Validate that rewritten references resolve against the bundle output produced by `br-2ei.4.4.1`.\n\n## Acceptance Criteria\n- JSON rewrite output matches the legacy schema and ordering rules (spec `br-2ei.4.7`).\n- No broken references: every non-detached reference resolves to a file present in the bundle.\n- Invalid/unknown JSON is handled per spec (fail-fast vs best-effort).\n- Unit tests cover:\n  - ordering determinism\n  - mixed inline/file/detached cases\n  - malformed JSON handling\n- Integration test runs against a fixture DB with attachments and asserts expected rewritten JSON + hashes.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:03:52.101600759Z","created_by":"ubuntu","updated_at":"2026-02-05T14:04:44.034479958Z","closed_at":"2026-02-05T14:04:44.034420727Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.4.2","depends_on_id":"br-2ei.4.4","type":"parent-child","created_at":"2026-02-05T07:03:52.101600759Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.4.2","depends_on_id":"br-2ei.4.4.1","type":"blocks","created_at":"2026-02-05T07:03:58.881861480Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.5","title":"Share: chunking + manifest/scaffolding + viewer assets","description":"Finish share/export bundle packaging after export DB + bundled attachments are ready.\n\nThis epic is split to enable parallel implementation:\n- `br-2ei.4.5.1`: chunking engine + chunk config writer (large DB path)\n- `br-2ei.4.5.2`: viewer assets integration + static hosting headers\n- `br-2ei.4.5.3`: manifest + scaffolding (README/_headers) + determinism glue\n\nNotes:\n- Thresholds and manifest schema MUST come from the extracted spec in `br-2ei.4.7`.\n- Determinism is mandatory: stable file ordering + stable manifest ordering.\n\n## Success Criteria\n1. All child tasks are complete.\n2. Bundle directory is self-contained and previewable.\n3. `manifest.json` conforms to the legacy schema and is deterministically serialized.\n4. Chunking works for the threshold boundary cases and is reflected in the manifest.\n5. Share/export E2E (`br-2ei.9.4`) passes and produces stable hashes across two identical runs.","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-02-05T05:12:55.110282213Z","created_by":"ubuntu","updated_at":"2026-02-05T14:16:17.477136091Z","closed_at":"2026-02-05T14:16:17.477037476Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.5","depends_on_id":"br-2ei.4","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5","depends_on_id":"br-2ei.4.3","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5","depends_on_id":"br-2ei.4.4","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T05:55:08.236817675Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.5.1","title":"Share Bundle: DB chunking engine + chunk config writer","description":"Implement the large DB chunking path for share/export.\n\nWork:\n- If DB size exceeds the legacy threshold (spec `br-2ei.4.7`), split DB into `chunks/`.\n- Emit any required chunk config file (e.g., `mailbox.sqlite3.config.json`) with deterministic ordering.\n- Ensure chunk naming and boundaries are deterministic.\n\n## Acceptance Criteria\n- Threshold and output layout match the legacy spec exactly.\n- Below threshold: no chunking outputs emitted (unless legacy does).\n- Above threshold: bundle contains deterministic `chunks/` layout + required config.\n- Unit tests cover threshold boundary cases and deterministic naming.\n- Integration test verifies chunked bundle can still be queried/used by the viewer (basic sanity query).","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T07:04:20.724767495Z","created_by":"ubuntu","updated_at":"2026-02-05T14:08:33.267369554Z","closed_at":"2026-02-05T14:08:33.267305123Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.5.1","depends_on_id":"br-2ei.4.3","type":"blocks","created_at":"2026-02-05T07:04:33.635936135Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5.1","depends_on_id":"br-2ei.4.5","type":"parent-child","created_at":"2026-02-05T07:04:20.724767495Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5.1","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T07:04:33.722371550Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.5.2","title":"Share Bundle: viewer assets integration + static hosting headers","description":"Integrate the static viewer assets into the share/export bundle.\n\nWork:\n- Copy/embed viewer HTML/CSS/JS assets into the bundle with legacy-correct paths.\n- Emit any static-hosting metadata required by legacy (e.g., `_headers`).\n- Ensure assets are deterministic (stable file ordering, stable content).\n\n## Acceptance Criteria\n- Asset set + paths match the legacy spec in `br-2ei.4.7`.\n- Fetching the viewer entry page resolves all referenced assets within the bundle.\n- Headers metadata is emitted exactly as expected (cache-control/content-type rules).\n- Unit/integration tests validate:\n  - required files present\n  - expected content-type mapping or header rules","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T07:04:49.375227530Z","created_by":"ubuntu","updated_at":"2026-02-05T14:13:20.955943069Z","closed_at":"2026-02-05T14:13:20.955882986Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.5.2","depends_on_id":"br-2ei.4.5","type":"parent-child","created_at":"2026-02-05T07:04:49.375227530Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5.2","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T07:04:54.689274505Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.5.3","title":"Share Bundle: manifest.json + scaffolding (README/_headers) + determinism glue","description":"Write the final bundle scaffold and `manifest.json` for share/export.\n\nWork:\n- Write `manifest.json` per legacy schema (spec `br-2ei.4.7`), including:\n  - export_config\n  - project_scope\n  - scrub preset + version\n  - DB metadata (sizes/hashes; chunks metadata when chunked)\n  - attachment metadata/hashes\n  - viewer/runtime flags\n  - hosting hints (detected targets + signals) when present\n- Ensure deterministic serialization:\n  - stable key ordering\n  - stable array ordering\n- Write bundle README / HOW_TO_DEPLOY with how to preview/deploy, including legacy hosting hints:\n  - Cloudflare Pages / Netlify / AWS S3 signals and the corresponding deploy steps\n- Ensure `_headers`/static-hosting metadata and viewer assets are referenced correctly (and are written exactly like legacy when applicable).\n\n## Acceptance Criteria\n- `manifest.json` conforms to the legacy schema and is deterministically serialized.\n- Manifest includes hashes for DB (and chunks when present) and bundled attachments per spec.\n- README/HOW_TO_DEPLOY + headers scaffolding exists and is correct per legacy spec (including hosting hints/signals).\n- Unit tests cover:\n  - manifest determinism (serialize twice -> identical)\n  - chunked vs non-chunked manifest variants\n  - required fields presence\n- E2E `br-2ei.9.4` can validate determinism across two exports from identical inputs.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T07:05:07.782474918Z","created_by":"ubuntu","updated_at":"2026-02-05T14:16:17.377020775Z","closed_at":"2026-02-05T14:16:17.376952517Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.5.3","depends_on_id":"br-2ei.4.3","type":"blocks","created_at":"2026-02-05T07:05:16.810266743Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5.3","depends_on_id":"br-2ei.4.4.2","type":"blocks","created_at":"2026-02-05T07:05:16.895398721Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5.3","depends_on_id":"br-2ei.4.5","type":"parent-child","created_at":"2026-02-05T07:05:07.782474918Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5.3","depends_on_id":"br-2ei.4.5.1","type":"blocks","created_at":"2026-02-05T07:05:16.980221638Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5.3","depends_on_id":"br-2ei.4.5.2","type":"blocks","created_at":"2026-02-05T07:05:17.064353973Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5.3","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T07:05:17.145302228Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.6","title":"Share: optional signing (Ed25519) + encryption (age) + zip packaging","description":"Implement optional bundle hardening features (signing, encryption, zip packaging).\n\nThis task extends the plain directory bundle from `br-2ei.4.5`.\n\nWork (in `crates/mcp-agent-mail-share/`):\n- Signing (Ed25519):\n  - Generate signing key if requested (or load provided key).\n  - Write public key into bundle.\n  - Sign `manifest.json` and include signature + metadata (algorithm, key id) per spec.\n  - Provide verify flow (`--verify` or library fn) that validates signature before use.\n- Encryption (age):\n  - Encrypt the bundle for one or more recipients.\n  - Emit `.age` output plus any required metadata.\n  - Provide decrypt flow for tests.\n- Zip packaging:\n  - Package bundle into zip (or tar) with stable ordering + timestamps as required for determinism.\n\n## Acceptance Criteria\n- Roundtrip works:\n  - Signing verify succeeds for a signed bundle.\n  - Verification fails with a clear error for a tampered manifest.\n  - Encryption decrypt yields byte-identical bundle output (or stable content hash if metadata differs) in test mode.\n- Determinism:\n  - Packaging output is deterministic given identical inputs (stable hash for the archive file).\n  - File ordering inside archive is stable.\n- UX:\n  - CLI flags and errors are explicit (what failed, what to do).\n  - Feature is optional and does not change default share behavior when disabled.\n- Tests:\n  - Unit tests cover sign/verify and encrypt/decrypt flows using deterministic test keys.\n  - E2E `br-2ei.9.4` covers at least one signed bundle and one encrypted bundle path (can be separate runs).","status":"closed","priority":3,"issue_type":"task","created_at":"2026-02-05T05:13:06.191406916Z","created_by":"ubuntu","updated_at":"2026-02-05T14:18:00.062072278Z","closed_at":"2026-02-05T14:18:00.061970166Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.6","depends_on_id":"br-2ei.4","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.6","depends_on_id":"br-2ei.4.5","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.6","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T05:55:08.321718960Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.7","title":"Share spec: extract scrub rules + SQL/DDL + manifest schema + vectors","description":"Extract the exact legacy share/export behavior into a self-contained spec + test vectors.\n\nThis is *spec extraction*, not implementation. The result must be detailed enough that implementers can complete `br-2ei.4.1`..`br-2ei.4.6` without re-reading Python.\n\nMust extract verbatim (copy exact SQL/DDL, constants, and ordering rules) from legacy Python:\n- SQLite snapshot procedure:\n  - WAL checkpoint details\n  - backup API usage (incl. flags / sequencing)\n  - any timeouts / retries / busy handling\n- Project scoping:\n  - tables affected\n  - exact WHERE clauses / join conditions\n  - any include/exclude semantics\n- Scrub presets (standard/strict/archive):\n  - exact transformations per table/column\n  - deletion vs redaction rules\n  - normalization rules (timestamps, ids, null handling, ordering)\n- FTS + views/materialization DDL\n- Export-finalize pragmas + maintenance ordering:\n  - journal_mode/page_size/synchronous\n  - VACUUM/ANALYZE ordering\n  - any integrity checks\n- Attachment bundling rules:\n  - how files are copied\n  - rewrite semantics for `messages.attachments` JSON\n- Chunking thresholds + output naming rules\n- Static hosting + deploy scaffolding:\n  - hosting-hints detection signals (Cloudflare Pages / Netlify / AWS S3) and how theyre presented\n  - `_headers` / other hosting metadata files (exact contents + when written)\n  - README/HOW_TO_DEPLOY guidance text and any env-signal heuristics\n- `manifest.json` schema:\n  - required fields\n  - stable ordering requirements (key order, array order)\n  - versioning / compatibility expectations (even if none)\n\nDeliverables:\n- Add/extend a dedicated Share/Export Spec section in `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md` with the above as an explicit checklist.\n- Add conformance fixtures for share/export (DB + expected outputs) under `crates/mcp-agent-mail-conformance/tests/conformance/fixtures/share/`.\n  - Include *expected hashes* (sha256) for each preset run.\n\n## Acceptance Criteria\n- The spec includes verbatim SQL/DDL and lists every table/column scrub rule for each preset.\n- Spec includes the exact hosting-hints detection signals and scaffolding file contents.\n- Fixtures cover at least:\n  - minimal DB (smallest useful)\n  - DB with attachments\n  - DB requiring scrub/redaction\n- For each preset, the fixture includes deterministic expected outputs (hashes + any required normalized JSON/manifest snapshots).\n- A brief How to regenerate fixtures from legacy Python note is included (command + expected output paths).\n- Implementers can complete `br-2ei.4.*` using only the spec + fixtures (no Python code consultation).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:54:17.642425426Z","created_by":"ubuntu","updated_at":"2026-02-05T07:54:58.212246444Z","closed_at":"2026-02-05T07:54:58.212223401Z","close_reason":"Added missing share/export fixture DDL files (expected_fts_ddl.sql, expected_views_ddl.sql); spec already present in EXISTING_MCP_AGENT_MAIL_STRUCTURE.md","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.7","depends_on_id":"br-2ei.4","type":"parent-child","created_at":"2026-02-05T05:54:17.642425426Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.8","title":"Share Tests: unit + integration + determinism + failure modes","description":"Add comprehensive unit + integration tests for the share/export pipeline (beyond E2E), with high-signal diffs and artifact logging.\n\nScope:\n- Unit tests for each pipeline stage: snapshot/scoping, scrub rules, FTS/index build, attachment rewrite, chunking, manifest/scaffolding, signing/encryption (optional).\n- Integration tests that run the full export pipeline against a small seeded DB + attachment set.\n- Determinism tests: identical inputs => identical output bundle hashes (manifest + DB + attachment layout).\n- Failure-mode tests: corrupt attachment, missing project, read-only output dir, invalid scrub preset.\n\nLogging/artifacts standard:\n- Each test emits a structured diff on mismatch (expected vs actual paths, JSON keys, hashes).\n- Store artifacts under tests/artifacts/share/<timestamp>/ for integration tests.\n\nDependencies:\n- These tests should depend on the relevant share implementation tasks (br-2ei.4.14.6, br-2ei.4.4.*, br-2ei.4.5.*) and spec extraction (br-2ei.4.7).\n\n## Success Criteria\n1. All child tasks (br-2ei.4.8.14.8.4) are complete and passing in CI.\n2. Unit, integration, determinism, and failure-mode tests run deterministically and without external services.\n3. Artifact logging standards are met (structured diffs + artifact trees under `tests/artifacts/share/<timestamp>/`).\n4. Determinism tests prove identical outputs for identical inputs (hash-based or byte-for-byte where specified).\n5. Failure-mode tests prove clean error handling with no confusing partial bundles.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-05T07:48:34.503442481Z","created_by":"ubuntu","updated_at":"2026-02-05T14:21:37.229946132Z","closed_at":"2026-02-05T14:21:37.229884346Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.8","depends_on_id":"br-2ei.4","type":"parent-child","created_at":"2026-02-05T07:48:34.503442481Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.8.1","title":"Share Tests: unit coverage for pipeline stages","description":"Unit tests for share pipeline stages (stage-level parity, deterministic outputs).\n\nCoverage:\n- Snapshot + scoping: correct WAL checkpoint + backup semantics; only requested project rows remain.\n- Scrub presets: standard/strict/archive rules match spec; verify SQL deletes + JSON redactions.\n- FTS/index build: expected tables/views and indexes created; query results stable.\n- Attachment rewrite: data-URI for <=64KiB, detach >=25MiB, copy/dedupe for middle range.\n- Messages.attachments JSON rewrite matches legacy schema and ordering.\n\nLogging/artifacts:\n- For each stage, emit a structured diff (expected vs actual SQL objects, JSON keys, attachment paths).\n- Snapshot tests should log the canonical manifest rows + attachment rewrite mapping.\n\nDependencies:\n- br-2ei.4.1, br-2ei.4.2, br-2ei.4.3, br-2ei.4.4.1, br-2ei.4.4.2, br-2ei.4.7\n\n## Acceptance Criteria\n1. Each pipeline stage has dedicated unit tests with deterministic fixtures and asserts parity with the extracted spec.\n2. Snapshot/scoping tests validate WAL checkpoint + backup semantics and that non-target project rows are removed.\n3. Scrub preset tests validate SQL deletes + JSON redactions and produce structured diffs on mismatch.\n4. Attachment rewrite tests cover size thresholds and schema ordering for messages.attachments.\n5. Logging includes structured diffs and manifest/attachment mappings to aid debugging.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:48:54.682178929Z","created_by":"ubuntu","updated_at":"2026-02-05T14:18:29.489172519Z","closed_at":"2026-02-05T14:18:29.489080406Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.8.1","depends_on_id":"br-2ei.4.1","type":"blocks","created_at":"2026-02-05T07:49:04.852299738Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.1","depends_on_id":"br-2ei.4.2","type":"blocks","created_at":"2026-02-05T07:49:04.945429675Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.1","depends_on_id":"br-2ei.4.3","type":"blocks","created_at":"2026-02-05T07:49:05.038929328Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.1","depends_on_id":"br-2ei.4.4.1","type":"blocks","created_at":"2026-02-05T07:49:05.134356218Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.1","depends_on_id":"br-2ei.4.4.2","type":"blocks","created_at":"2026-02-05T07:49:05.228917179Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.1","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T07:49:05.322494558Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.1","depends_on_id":"br-2ei.4.8","type":"parent-child","created_at":"2026-02-05T07:48:54.682178929Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.8.2","title":"Share Tests: integration pipeline + bundle verification","description":"Integration tests for full share/export pipeline (seeded DB + attachments -> bundle tree).\n\nCoverage:\n- Full pipeline run with a small seeded project DB and attachments.\n- Validate manifest.json content, DB snapshot integrity (PRAGMA integrity_check), attachment layout, and rewritten messages.attachments JSON.\n- Verify chunking behavior at size thresholds and manifest references.\n- If signing/encryption enabled, validate signature/age output with deterministic fixtures (where possible).\n\nLogging/artifacts:\n- Store bundle tree under tests/artifacts/share/full/<timestamp>/.\n- Emit diff summaries for manifest/attachments/DB schema on mismatch.\n- Capture and log size breakdowns (DB, attachments, manifest).\n\nDependencies:\n- br-2ei.4.1, br-2ei.4.2, br-2ei.4.3, br-2ei.4.4.*, br-2ei.4.5.*, br-2ei.4.6, br-2ei.4.7\n\n## Acceptance Criteria\n1. Integration test runs the full share pipeline in a temp workspace and produces a bundle tree under `tests/artifacts/share/full/<timestamp>/`.\n2. `manifest.json`, DB integrity, and attachment layout are validated against expected fixtures (including messages.attachments rewrite).\n3. Chunking threshold behavior is exercised and verified in the manifest.\n4. If signing/encryption is enabled, verify signature and decrypt in test mode with deterministic keys/fixtures.\n5. Failures print clear diffs for manifest/attachments/DB schema and include size breakdown logs.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:49:14.509596907Z","created_by":"ubuntu","updated_at":"2026-02-05T14:21:37.138504159Z","closed_at":"2026-02-05T14:21:37.138442703Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.1","type":"blocks","created_at":"2026-02-05T07:49:21.201560088Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.2","type":"blocks","created_at":"2026-02-05T07:49:21.294378799Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.3","type":"blocks","created_at":"2026-02-05T07:49:21.385449961Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.4.1","type":"blocks","created_at":"2026-02-05T07:49:21.477730629Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.4.2","type":"blocks","created_at":"2026-02-05T07:49:21.569989206Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.5.1","type":"blocks","created_at":"2026-02-05T07:49:21.660690982Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.5.2","type":"blocks","created_at":"2026-02-05T07:49:21.749106445Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.5.3","type":"blocks","created_at":"2026-02-05T07:49:21.840338169Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.6","type":"blocks","created_at":"2026-02-05T07:49:21.931913820Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T07:49:22.032750784Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.8","type":"parent-child","created_at":"2026-02-05T07:49:14.509596907Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.8.3","title":"Share Tests: determinism + reproducibility","description":"Determinism + reproducibility tests for share/export output.\n\nCoverage:\n- Run share pipeline twice with identical inputs -> identical:\n  - manifest.json (byte-for-byte)\n  - DB snapshot hashes\n  - attachment file paths + hashes\n  - bundle directory tree ordering\n- Verify stable ordering in manifest (projects, attachments, chunks).\n- Verify stable hash function inputs (no timestamp/hostname nondeterminism).\n\nLogging/artifacts:\n- Emit per-file hash lists and diff on mismatch.\n- Store hash inventories under tests/artifacts/share/determinism/<timestamp>/.\n\nDependencies:\n- br-2ei.4.5.* (manifest + chunking), br-2ei.4.4.*, br-2ei.4.7\n\n## Acceptance Criteria\n1. Two identical runs produce byte-for-byte identical `manifest.json` and identical hash inventories for DB + attachments.\n2. Manifest ordering (projects/attachments/chunks) is stable and asserted.\n3. Tests enforce that timestamps/hostnames do not leak into hash inputs.\n4. On mismatch, per-file hash diffs are printed and inventories are stored under `tests/artifacts/share/determinism/<timestamp>/`.\n5. Tests are deterministic across machines (normalize temp paths where necessary).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:49:31.525185255Z","created_by":"ubuntu","updated_at":"2026-02-05T14:18:29.582446136Z","closed_at":"2026-02-05T14:18:29.582367138Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.8.3","depends_on_id":"br-2ei.4.4.1","type":"blocks","created_at":"2026-02-05T07:49:36.101704160Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.3","depends_on_id":"br-2ei.4.4.2","type":"blocks","created_at":"2026-02-05T07:49:36.191870458Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.3","depends_on_id":"br-2ei.4.5.1","type":"blocks","created_at":"2026-02-05T07:49:36.296206809Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.3","depends_on_id":"br-2ei.4.5.2","type":"blocks","created_at":"2026-02-05T07:49:36.386410167Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.3","depends_on_id":"br-2ei.4.5.3","type":"blocks","created_at":"2026-02-05T07:49:36.473247380Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.3","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T07:49:36.558886727Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.3","depends_on_id":"br-2ei.4.8","type":"parent-child","created_at":"2026-02-05T07:49:31.525185255Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.8.4","title":"Share Tests: failure modes + recovery","description":"Failure-mode and recovery tests for share/export pipeline.\n\nCoverage:\n- Missing project -> clear error + exit code, no partial bundle output.\n- Invalid scrub preset -> error with list of valid presets.\n- Corrupt/missing attachment -> error or skip per legacy spec (document exact behavior), with logged path.\n- Read-only output dir -> error and no partial artifacts.\n- Partial bundle cleanup on failure (best-effort) to avoid confusing users.\n\nLogging/artifacts:\n- Capture stderr/stdout and include exact error strings + remediation hints.\n- Store partial output tree (if any) for debugging under tests/artifacts/share/failures/<timestamp>/.\n\nDependencies:\n- br-2ei.4.1, br-2ei.4.2, br-2ei.4.4.*, br-2ei.4.7\n\n## Acceptance Criteria\n1. Each failure mode is covered by a dedicated test case with expected exit code and error message assertions.\n2. Tests verify no partial bundle artifacts are left behind (or that cleanup happens per spec).\n3. Corrupt/missing attachments follow legacy behavior exactly (error vs skip) and log the affected path.\n4. Artifacts (stdout/stderr + partial trees) are stored under `tests/artifacts/share/failures/<timestamp>/`.\n5. Tests are deterministic and do not rely on external services.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:49:46.368523653Z","created_by":"ubuntu","updated_at":"2026-02-05T14:18:29.676450940Z","closed_at":"2026-02-05T14:18:29.676390456Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.8.4","depends_on_id":"br-2ei.4.1","type":"blocks","created_at":"2026-02-05T07:49:50.476879883Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.4","depends_on_id":"br-2ei.4.2","type":"blocks","created_at":"2026-02-05T07:49:50.568506731Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.4","depends_on_id":"br-2ei.4.4.1","type":"blocks","created_at":"2026-02-05T07:49:50.680999494Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.4","depends_on_id":"br-2ei.4.4.2","type":"blocks","created_at":"2026-02-05T07:49:50.786244505Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.4","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T07:49:50.883581511Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.4","depends_on_id":"br-2ei.4.8","type":"parent-child","created_at":"2026-02-05T07:49:46.368523653Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5","title":"CLI Parity: implement Typer-equivalent commands + frankentui output","description":"## Objective\nImplement **full CLI parity** with legacy Typer commands, flags, outputs, and exit codes, using frankentui for human output and stable JSON for automation.\n\n## Scope\n- All commands listed in `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md` (CLI inventory), including:\n  - share export/update/preview/verify/decrypt/wizard\n  - archive save/list/restore\n  - doctor check/repair/backups/restore\n  - products ensure/link/status/search/inbox/summarize-thread\n  - amctl env, am-run\n  - projects mark-identity/discovery-init/adopt\n  - guard install/uninstall/status/check\n  - file_reservations list/active/soon\n  - acks pending/remind/overdue + list-acks\n  - config set-port/show-port\n  - list-projects, mail status, migrate, clear-and-reset-everything, docs insert-blurbs\n- Help text parity (flag ordering, defaults, examples) and JSON output schemas.\n\n## Implementation Notes\n- Match legacy defaults (e.g., share thresholds, host/port defaults, archive list ordering).\n- Exit codes and error messages must match legacy (see CLI Behavior Notes section in spec).\n- JSON mode must be deterministic (stable field ordering and schema).\n\n## Tests\n- Unit tests for clap parsing & defaults.\n- Integration tests using temp dirs + temp DB to exercise real CLI paths.\n- Golden help output snapshots.\n- JSON schema fixtures for JSON mode.\n- E2E CLI script (br-2ei.9.5).\n\n## Logging/Artifacts\n- Save stdout/stderr + diffs under `tests/artifacts/cli/<timestamp>/`.\n- On JSON mismatch, emit structured JSON diff.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"epic","assignee":"DustyTower","created_at":"2026-02-05T05:06:50.526774224Z","created_by":"ubuntu","updated_at":"2026-02-06T20:18:15.391968820Z","closed_at":"2026-02-06T20:18:15.391944985Z","close_reason":"All CLI commands implemented with full legacy parity: 40+ commands, 43 integration tests, JSON/TTY output modes, frankentui rendering. All child beads done.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.1","title":"CLI: serve-http/serve-stdio parity (flags, defaults, exit codes)","description":"Ensure `am serve-http` and `am serve-stdio` behave like legacy CLI.\n\nRequirements:\n- Flags: --host/--port/--path override env defaults.\n- serve-http starts HTTP listener with configured base path.\n- serve-stdio runs fastmcp stdio transport.\n- Exit codes: non-zero on bind failures.\n\nAcceptance:\n- Manual smoke tests with curl and stdio.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:11:18.491790676Z","created_by":"ubuntu","updated_at":"2026-02-05T05:38:36.353215725Z","closed_at":"2026-02-05T05:38:36.353198122Z","close_reason":"Added serve-http config override helper and tests","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.1","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.10","title":"CLI: docs insert-blurbs parity (scan/insert/idempotent)","description":"Port the legacy docs insert-blurbs command and verify idempotent, safe behavior.\n\nScope (match legacy Typer behavior):\n- Flags: --scan-dir/-d (repeat), --yes, --dry-run, --max-depth.\n- Behavior: scan target dirs for AGENTS.md/CLAUDE.md/README-like files, insert the Agent Mail blurb block if missing.\n- Idempotency: repeated runs should detect existing blocks and avoid duplicates.\n- Safety: dry-run prints planned changes without touching files; --yes bypasses prompts.\n\nImplementation notes:\n- Preserve file encoding + line endings; avoid rewriting unchanged files.\n- Provide clear per-file status: inserted / already-present / skipped / error.\n\nTests:\n- Unit: parsing flags + default scan paths + depth handling.\n- Integration: temp dirs with fixture files (missing blurb, existing blurb, partial blurb, non-matching files).\n- Dry-run verification: no file changes; output lists planned actions.\n- Idempotency: run twice and assert no second diff.\n\nLogging/artifacts:\n- On failure, store before/after file contents under tests/artifacts/cli/docs/<timestamp>/.\n- Emit unified diffs for mismatches.\n\n## Acceptance Criteria\n1. docs insert-blurbs matches legacy flags, prompts, and default scan behavior.\n2. Idempotency is proven by tests (no duplicate insertions).\n3. Dry-run is safe and emits clear planned-change output.\n4. Tests run in temp dirs and capture artifacts on failure.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T15:13:48.089263761Z","created_by":"ubuntu","updated_at":"2026-02-06T08:09:54.828438727Z","closed_at":"2026-02-06T08:09:54.828418930Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.10","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T15:13:48.089263761Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.11","title":"CLI: migrate command parity (legacy DB/archive migrations)","description":"Port and verify the legacy migrate command.\n\nWork:\n- Extract exact legacy behavior (what is migrated, prompts, exit codes, and safety checks).\n- Implement equivalent behavior in Rust (no silent destructive actions).\n- If legacy is a no-op or informational, preserve that behavior and document it.\n\nTests:\n- Unit: parsing + flag handling (if any), exit code semantics.\n- Integration: temp DB/storage_root; simulate pre-migration state if needed.\n- Negative cases: invalid paths, missing files, permission errors.\n\nLogging/artifacts:\n- Capture stdout/stderr in tests/artifacts/cli/migrate/<timestamp>/.\n- On mismatch, print expected vs actual key lines.\n\n## Acceptance Criteria\n1. migrate matches legacy behavior and exit codes exactly.\n2. If the legacy command is a no-op, that is explicitly documented and tested.\n3. Integration tests are deterministic and operate only on temp dirs.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T15:14:16.606606259Z","created_by":"ubuntu","updated_at":"2026-02-06T16:40:52.655705560Z","closed_at":"2026-02-06T16:40:52.655680143Z","close_reason":"Implemented Rust migrate parity (legacy output lines) + schema migrations wiring + unit test; kept gates green","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.11","depends_on_id":"br-2ei.16","type":"blocks","created_at":"2026-02-05T15:17:12.728738274Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.11","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T15:14:16.606606259Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.12","title":"CLI: clear-and-reset-everything parity (force + archive safety)","description":"Port and verify the legacy clear-and-reset-everything command.\n\nScope:\n- Flags: --force/-f, --archive/--no-archive.\n- Behavior: with --archive, create archive snapshot before clearing.\n- Safety: without --force, command should refuse (legacy behavior) or prompt; must match legacy.\n- Ensure all operations are confined to project storage_root/DB paths.\n\nTests:\n- Unit: flag parsing + default behaviors + exit codes for missing --force.\n- Integration: temp DB + storage_root seeded with data; verify:\n  - with --archive, archive is created and contains expected manifest.\n  - with --no-archive, data is cleared but no archive artifacts created.\n  - without --force, no changes occur.\n- Negative: missing/locked DB, unreadable storage dir; ensure errors are surfaced clearly.\n\nLogging/artifacts:\n- Store before/after tree snapshots + outputs under tests/artifacts/cli/clear_reset/<timestamp>/.\n- Print explicit list of files removed/archived (expected vs actual) on mismatch.\n\n## Acceptance Criteria\n1. clear-and-reset-everything matches legacy flags, safety gates, and exit codes.\n2. Archive creation (when enabled) is validated and deterministic.\n3. Tests never touch non-temp paths and fail fast with clear diagnostics.","status":"closed","priority":1,"issue_type":"task","assignee":"RusticOtter","created_at":"2026-02-05T15:14:31.173350973Z","created_by":"ubuntu","updated_at":"2026-02-06T02:49:19.393627373Z","closed_at":"2026-02-06T02:49:19.393603509Z","close_reason":"Implemented clear-and-reset-everything parity (force gate + archive/no-archive tri-state + pre-reset archive + delete DB WAL/SHM + wipe storage root)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.12","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T15:14:31.173350973Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.13","title":"CLI: amctl env + am-run build slot parity (local lease fallback)","description":"Port and verify build-slot helper commands: amctl env + am-run.\n\nScope (match legacy behavior):\n- amctl env: prints environment variables (SLUG, PROJECT_UID, BRANCH, AGENT, CACHE_KEY, ARTIFACT_DIR) derived from repo/project context; supports --path/-p and --agent/-a.\n- am-run: acquires build slot (server tool if available; local JSON lease fallback), runs a command, renews periodically, releases on exit.\n- Flags: --path/-p, --agent/-a, --ttl-seconds, --shared/--exclusive, --block-on-conflicts/--no-block-on-conflicts.\n\nImplementation notes:\n- Local lease fallback should be deterministic and conflict-aware (shared vs exclusive).\n- Ensure env vars exported for child process (AM_SLOT, SLUG, PROJECT_UID, BRANCH, AGENT, CACHE_KEY).\n- Exit codes: non-zero if block-on-conflicts and conflicts exist (legacy).\n\nTests:\n- Unit: parsing + env derivation (stable fixtures for project UID + slug).\n- Integration: temp repo with a mock server disabled to force local lease path.\n- Conflict scenarios: shared vs exclusive, block-on-conflicts true/false.\n- Command propagation: verify env vars visible to child process.\n\nLogging/artifacts:\n- Capture stdout/stderr under tests/artifacts/cli/build_slots/<timestamp>/.\n- On mismatch, emit expected vs actual env var sets.\n\n## Acceptance Criteria\n1. amctl env and am-run match legacy flags, env var outputs, and exit codes.\n2. Local lease fallback behaves correctly with shared/exclusive conflicts.\n3. Integration tests are deterministic and run only in temp dirs.","status":"closed","priority":1,"issue_type":"task","assignee":"RusticOtter","created_at":"2026-02-05T15:14:40.242202280Z","created_by":"ubuntu","updated_at":"2026-02-06T03:28:51.257822257Z","closed_at":"2026-02-06T03:28:51.257789886Z","close_reason":"Completed: amctl env + am-run parity + tests + gates","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.13","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T15:14:40.242202280Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.14","title":"CLI: projects subcommands parity (mark-identity/discovery-init/adopt)","description":"Port and verify legacy projects subcommands.\n\nScope (match legacy Typer behavior):\n- projects mark-identity (project_path, --commit/--no-commit): writes identity markers + optional git commit.\n- projects discovery-init (project_path, --product/-P): initialize project metadata for discovery.\n- projects adopt (source, target, --dry-run/--apply): migrate project metadata from source to target.\n\nSafety requirements:\n- Never run destructive git/fs commands; commit only when --commit is set.\n- Dry-run must emit exact planned changes without modifying files.\n\nTests:\n- Unit: clap parsing + defaults.\n- Integration: temp repos with seeded metadata; verify outputs + file changes.\n- Negative cases: invalid paths, missing project metadata, conflicts.\n\nLogging/artifacts:\n- Save before/after snapshots under tests/artifacts/cli/projects/<timestamp>/.\n- Emit unified diffs on mismatches.\n\n## Acceptance Criteria\n1. projects subcommands match legacy flags/defaults/exit codes.\n2. Dry-run and --commit behaviors are safe and deterministic.\n3. Integration tests run in temp repos only and capture artifacts on failure.","status":"closed","priority":2,"issue_type":"task","assignee":"WhiteAnchor","created_at":"2026-02-05T15:14:48.056997359Z","created_by":"ubuntu","updated_at":"2026-02-06T19:14:09.416197324Z","closed_at":"2026-02-06T19:14:09.416171556Z","close_reason":"Implemented projects mark-identity/discovery-init/adopt parity + integration coverage","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.14","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T15:14:48.056997359Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.15","title":"Share wizard parity: script launch + error handling","description":"Ensure share wizard matches legacy behavior (script invocation + error semantics).\n\nScope:\n- Command should attempt to execute legacy script path (scripts/share_to_github_pages.py).\n- If script missing/unreadable, exit non-zero with legacy error message.\n- When script exists, pass through args/env as legacy does (document exact call).\n\nTests:\n- Unit: parsing + default behavior.\n- Integration: temp repo with a stub script that records invocation; verify path, args, and exit codes.\n- Negative: missing script; assert error text and exit code.\n\nLogging/artifacts:\n- Capture stdout/stderr under tests/artifacts/cli/share_wizard/<timestamp>/.\n\n## Acceptance Criteria\n1. share wizard invokes the correct script path with legacy-compatible args/env.\n2. Missing-script failure matches legacy message + exit code.\n3. Integration tests are deterministic and run in temp dirs only.","status":"closed","priority":2,"issue_type":"task","assignee":"CoralDog","created_at":"2026-02-05T15:15:32.081608730Z","created_by":"ubuntu","updated_at":"2026-02-06T12:17:24.883966641Z","closed_at":"2026-02-06T12:17:24.883944259Z","close_reason":"Implemented share wizard script resolution + legacy-shaped missing-script output; added deterministic tests; fixed stdio capture concurrency.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.15","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T15:15:32.081608730Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.16","title":"Main binary: fail fast for unsupported subcommands and direct users to am CLI","description":"Problem: crates/mcp-agent-mail/src/main.rs exposes many non-serve subcommands but currently prints 'Command not yet implemented' and exits success.\\n\\nScope:\\n- For unsupported commands in mcp-agent-mail binary, return non-zero exit code.\\n- Emit actionable guidance to use the full CLI binary (am / mcp-agent-mail-cli).\\n- Keep serve/config behavior unchanged.\\n- Add regression tests for exit code + message semantics.\\n\\nAcceptance:\\n1. Unsupported command exits non-zero.\\n2. Error output includes pointer to am/mcp-agent-mail-cli.\\n3. Existing serve/config paths remain unchanged.\\n4. Tests cover new behavior.","status":"closed","priority":1,"issue_type":"task","assignee":"DustyTower","created_at":"2026-02-06T19:08:09.890791555Z","created_by":"ubuntu","updated_at":"2026-02-06T19:14:05.296197017Z","closed_at":"2026-02-06T19:14:05.296170998Z","close_reason":"Implemented unsupported-command fail-fast in mcp-agent-mail binary with CLI guidance + regression test; fmt/check/clippy/test all green","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.16","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-06T19:08:09.890791555Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.2","title":"CLI: implement guard subcommands (install/uninstall/status/check)","description":"Wire `am guard ...` commands to mcp-agent-mail-guard.\n\nCommands:\n- am guard install [--repo PATH] [--prepush]\n- am guard uninstall [--repo PATH]\n- am guard status [--repo PATH]\n- am guard check [--repo PATH] [--advisory] (used by hook plugin)\n\nMust match legacy defaults and env vars.\n\n## Acceptance Criteria\n1. CLI surface (commands/flags/defaults/exit codes) matches the CLI parity inventory (br-2ei.5.6).\n2. Commands delegate to mcp-agent-mail-guard and preserve idempotency semantics.\n3. Unit tests cover argument parsing + error cases (non-repo paths, missing repo).\n4. E2E guard suite (br-2ei.9.3) uses these commands successfully.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:11:24.884001192Z","created_by":"ubuntu","updated_at":"2026-02-05T06:31:56.949414368Z","closed_at":"2026-02-05T06:31:56.949353513Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.2","depends_on_id":"br-2ei.3.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.2","depends_on_id":"br-2ei.3.3","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.2","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.2","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T05:55:17.665850195Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.3","title":"CLI: implement share subcommands (export/update/preview/verify/decrypt/wizard)","description":"Wire `am share ...` commands to mcp-agent-mail-share with full legacy parity.\n\nCommands (legacy):\n- export / update / preview / verify / decrypt / wizard (interactive)\n\nMust match legacy Typer surface:\n- flags + defaults\n- interactive wizard flow for share export\n- hosting hints detection output (Cloudflare Pages / Netlify / AWS S3 signals)\n- stable/deterministic outputs when inputs are identical\n\nImplementation notes:\n- CLI should delegate core work to `mcp-agent-mail-share` and render human output via frankentui.\n- Machine mode (`--json`) must produce schema-stable output.\n\n## Acceptance Criteria\n1. CLI surface (commands/flags/defaults/exit codes) matches the CLI parity inventory (br-2ei.5.6).\n2. share commands delegate to `mcp-agent-mail-share` and produce deterministic outputs when inputs are identical.\n3. Hosting hints detection output is present and matches legacy semantics/signals (from spec `br-2ei.4.7`).\n4. Unit tests cover argument parsing and obvious error paths (missing DB, invalid scrub preset, invalid output dir, missing recipients).\n5. E2E share suite (br-2ei.9.4) uses these commands successfully.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:11:39.240636392Z","created_by":"ubuntu","updated_at":"2026-02-05T14:27:12.525669868Z","closed_at":"2026-02-05T14:27:12.525595357Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.3","depends_on_id":"br-2ei.4","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.3","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.3","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T05:55:17.761658357Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.4","title":"CLI: implement doctor commands (check/repair/backups/restore)","description":"## Objective\nPort **doctor** commands (`check`, `repair`, `backups`, `restore`) with legacy behavior and safety semantics.\n\n## Scope (Legacy Behavior Notes)\n- `doctor check`:\n  - `--json` outputs machine-readable diagnostics + summary counts.\n  - Checks include: stale locks, `PRAGMA integrity_check`, orphaned recipients, FTS row count mismatch, expired reservations, WAL/SHM presence.\n  - `--verbose` prints up to 5 detail lines per diagnostic.\n- `doctor repair`:\n  - `--dry-run` previews, `--yes` skips confirmations.\n  - Creates backups unless dry-run.\n  - Heals stale locks, releases expired reservations, deletes orphaned recipients (prompt unless `--yes`).\n- `doctor backups`: list backups as table or JSON.\n- `doctor restore`: restore backup with `--dry-run`/`--yes` gating.\n\n## Tests\n- Unit tests for argument parsing and flag defaults.\n- Integration tests against temp DB + storage_root:\n  - simulate stale locks, orphans, WAL/SHM files\n  - verify check output, repair side effects, backup listing and restore behavior\n\n## Logging/Artifacts\n- Store outputs + diffs under `tests/artifacts/cli/doctor/<timestamp>/`.\n- Print explicit mismatches for diagnostics counts and line content.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T05:11:51.799905939Z","created_by":"ubuntu","updated_at":"2026-02-06T16:32:26.236420676Z","closed_at":"2026-02-06T16:32:26.236393214Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.4","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.4","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T05:55:17.847248690Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.5","title":"CLI UX: frankentui rendering for tables/progress + JSON output modes","description":"## Objective\nEnsure CLI **human output parity** with legacy, using frankentui for tables/panels and graceful nonTTY output.\n\n## Scope\n- Table outputs (projects, inbox, acks, file reservations, backups) rendered via frankentui.\n- Progress indicators for long-running commands (share/export, archive restore, doctor repair).\n- Color/formatting disabled automatically when stdout/stderr is not a TTY.\n- JSON mode bypasses UI rendering and prints machine schema only.\n\n## Tests\n- Snapshot tests for frankentui table rendering (TTY vs nonTTY).\n- Integration tests that exercise table output with representative data.\n- JSON mode tests confirm no UI artifacts are present.\n\n## Logging/Artifacts\n- Store rendered snapshots under `tests/fixtures/cli_ui/`.\n- On mismatch, save actual outputs under `tests/artifacts/cli/ui/<timestamp>/` and emit unified diff.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T05:11:59.633674324Z","created_by":"ubuntu","updated_at":"2026-02-06T16:38:23.664072659Z","closed_at":"2026-02-06T16:38:23.664049706Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.5","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.5","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T05:55:17.922891984Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.6","title":"CLI parity spec: inventory legacy Typer commands/flags + golden help","description":"Extract and lock down the legacy Python Typer CLI surface so the Rust CLI cannot silently drift.\n\nDeliverables:\n- Command inventory: every command + subcommand, with flags, env var mappings, defaults, and exit codes.\n- Help output capture strategy:\n  - Either golden snapshots of `am --help` and key subcommands, OR a structured JSON inventory checked by unit tests.\n- Document any intentional improvements/deltas explicitly (and add tests for new behavior).\n\nSources:\n- legacy_python_mcp_agent_mail_code/* Typer app\n- Existing docs: EXISTING_MCP_AGENT_MAIL_STRUCTURE.md + README parity sections\n\nTests:\n- Unit test that asserts the Rust CLI exposes the full command inventory (names + flags).\n- E2E harness (br-2ei.9.5) consumes this inventory for verification.\n\n## Acceptance Criteria\n1. A deterministic CLI inventory artifact exists (golden help snapshots and/or structured inventory).\n2. Unit tests assert the Rust CLI matches the inventory (commands + flags + defaults).\n3. Any intentional deltas are explicitly listed and tested (no accidental drift).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:54:05.866507590Z","created_by":"ubuntu","updated_at":"2026-02-05T08:05:09.490318553Z","closed_at":"2026-02-05T08:05:09.490297684Z","close_reason":"Added structured CLI inventory artifact (legacy_cli_inventory.json) and updated CLI command table reference","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.6","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T05:54:05.866507590Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.7","title":"CLI Tests: unit + integration + golden help + JSON stability","description":"## Objective\nComprehensive CLI test suite covering parsing, help output, JSON mode, integration behavior, and exit codes.\n\n## Scope\n- Unit tests for clap parsing/defaults (br-2ei.5.7.1).\n- Integration tests for real command execution in temp dirs (br-2ei.5.7.2).\n- Golden help output snapshots (br-2ei.5.7.3).\n- JSON output stability tests (br-2ei.5.7.4).\n\n## Tests\n- `cargo test -p mcp-agent-mail-cli` covering all above categories.\n- E2E CLI harness (br-2ei.9.5) for highsignal smoke.\n\n## Logging/Artifacts\n- Help snapshots under `tests/fixtures/cli_help/`.\n- JSON fixtures under `tests/fixtures/cli_json/`.\n- Failure artifacts under `tests/artifacts/cli/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"epic","assignee":"GreenDune","created_at":"2026-02-05T07:50:04.178085704Z","created_by":"ubuntu","updated_at":"2026-02-06T20:18:26.493533914Z","closed_at":"2026-02-06T20:18:26.493484551Z","close_reason":"All 4 children closed: unit parsing, integration runs, golden help, JSON stability.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.7","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T07:50:04.178085704Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.7.1","title":"CLI Tests: unit parsing + defaults","description":"Unit tests for CLI parsing and defaults.\n\nCoverage:\n- clap arg parsing for serve, share, guard, doctor, mail/acks/reservations commands.\n- products commands, archive commands, docs insert-blurbs, migrate, clear-and-reset-everything, amctl env, am-run.\n- default values (ports, paths, output format) match legacy spec (br-2ei.5.6).\n- env var overrides (where legacy supported).\n- exit code semantics for invalid args.\n\nLogging:\n- When failures occur, print full parsed-args diff and environment snapshot.\n\nDependencies:\n- br-2ei.5.1, br-2ei.5.2, br-2ei.5.3, br-2ei.5.4, br-2ei.5.5, br-2ei.5.6\n\n## Acceptance Criteria\n1. Unit tests cover parsing for all major subcommands and validate defaults against the legacy spec.\n2. Env var overrides are tested with explicit fixtures for supported variables.\n3. Invalid arg combinations return the expected exit code and error message.\n4. Failures print a parsed-args diff and environment snapshot to aid debugging.\n5. Tests are deterministic and do not require network or external binaries.","status":"closed","priority":1,"issue_type":"task","assignee":"PurpleHawk","created_at":"2026-02-05T07:50:15.690264115Z","created_by":"ubuntu","updated_at":"2026-02-06T18:25:31.777040538Z","closed_at":"2026-02-06T18:25:31.777014369Z","close_reason":"Unit parsing/defaults tests implemented in crates/mcp-agent-mail-cli/src/lib.rs; cargo test -p mcp-agent-mail-cli --lib passes (199 tests)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2di","type":"blocks","created_at":"2026-02-05T16:19:25.657693903Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5","type":"blocks","created_at":"2026-02-05T16:21:40.751758849Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.1","type":"blocks","created_at":"2026-02-05T07:50:20.373617293Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.10","type":"blocks","created_at":"2026-02-05T15:16:54.544322444Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.11","type":"blocks","created_at":"2026-02-05T15:16:54.635714595Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.12","type":"blocks","created_at":"2026-02-05T15:16:54.727486511Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.13","type":"blocks","created_at":"2026-02-05T15:16:54.816281409Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.14","type":"blocks","created_at":"2026-02-05T15:16:54.907456982Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.15","type":"blocks","created_at":"2026-02-05T15:16:54.995411988Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.2","type":"blocks","created_at":"2026-02-05T07:50:20.468649871Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.3","type":"blocks","created_at":"2026-02-05T07:50:20.559362277Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.4","type":"blocks","created_at":"2026-02-05T07:50:20.648289664Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.5","type":"blocks","created_at":"2026-02-05T07:50:20.739664527Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T07:50:20.830895600Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.7","type":"parent-child","created_at":"2026-02-05T07:50:15.690264115Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.8","type":"blocks","created_at":"2026-02-05T15:16:54.360938694Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.9","type":"blocks","created_at":"2026-02-05T15:16:54.452731689Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-3np","type":"blocks","created_at":"2026-02-05T16:19:25.564436308Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-9jl","type":"blocks","created_at":"2026-02-05T16:19:25.751159098Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.7.2","title":"CLI Tests: integration runs + exit codes","description":"Integration tests that run the CLI binary end-to-end in temp dirs.\n\nCoverage:\n- serve-stdio and serve-http startup/shutdown (dry-run where possible).\n- guard install/status/uninstall in a temp git repo.\n- share export/update/verify/preview/decrypt + wizard (script stub) with seeded project data.\n- doctor check/repair stubs (no destructive actions).\n- products commands, archive save/list/restore, docs insert-blurbs, migrate, clear-and-reset-everything, amctl env/am-run.\n\nLogging/artifacts:\n- Store stdout/stderr for each command under tests/artifacts/cli/integration/<timestamp>/.\n- Print expected vs actual exit codes and key output lines.\n\nDependencies:\n- br-2ei.5.15.5, br-2ei.5.6\n\n## Acceptance Criteria\n1. Integration tests execute the CLI binary in isolated temp dirs and clean up all processes they start.\n2. Commands listed in coverage are exercised and assert expected exit codes plus required output markers.\n3. All stdout/stderr is captured and written under tests/artifacts/cli/integration/<timestamp>/ with per-case headers.\n4. Tests do not use destructive git/fs commands; guard install/uninstall uses a temp repo only.\n5. Failures print clear diagnostics (command line, exit code, key output lines).","status":"closed","priority":1,"issue_type":"task","assignee":"RusticGlen","created_at":"2026-02-05T07:50:30.939428162Z","created_by":"ubuntu","updated_at":"2026-02-06T20:18:20.668047276Z","closed_at":"2026-02-06T20:18:20.668024965Z","close_reason":"43 integration tests passing - all acceptance criteria met.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2di","type":"blocks","created_at":"2026-02-05T16:19:33.007082077Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5","type":"blocks","created_at":"2026-02-05T16:21:40.840599791Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.1","type":"blocks","created_at":"2026-02-05T07:50:37.625955500Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.10","type":"blocks","created_at":"2026-02-05T15:16:55.268271539Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.11","type":"blocks","created_at":"2026-02-05T15:16:55.360282856Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.12","type":"blocks","created_at":"2026-02-05T15:16:55.453346375Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.13","type":"blocks","created_at":"2026-02-05T15:16:55.547451777Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.14","type":"blocks","created_at":"2026-02-05T15:16:55.641765331Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.15","type":"blocks","created_at":"2026-02-05T15:16:55.734754850Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.2","type":"blocks","created_at":"2026-02-05T07:50:37.721192313Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.3","type":"blocks","created_at":"2026-02-05T07:50:37.815858081Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.4","type":"blocks","created_at":"2026-02-05T07:50:37.911140008Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.5","type":"blocks","created_at":"2026-02-05T07:50:38.010689399Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T07:50:38.102457903Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.7","type":"parent-child","created_at":"2026-02-05T07:50:30.939428162Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.8","type":"blocks","created_at":"2026-02-05T15:16:55.089660439Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.9","type":"blocks","created_at":"2026-02-05T15:16:55.180406182Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-3np","type":"blocks","created_at":"2026-02-05T16:19:32.913614748Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-9jl","type":"blocks","created_at":"2026-02-05T16:19:33.103218362Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.7.2.1","title":"Bug: integration test run_am missing stdout/stderr capture when stdin piped","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-06T18:50:43.768204986Z","created_by":"ubuntu","updated_at":"2026-02-06T18:50:43.768204986Z","closed_at":"2026-02-06T18:50:43.768204986Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.7.2.1","depends_on_id":"br-2ei.5.7.2","type":"parent-child","created_at":"2026-02-06T18:50:43.768204986Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.7.3","title":"CLI Tests: golden help snapshots","description":"Golden help output snapshots for CLI parity.\n\nCoverage:\n- Top-level help output.\n- Key subcommands: serve, share, guard, doctor, products, archive, docs insert-blurbs, migrate, clear-and-reset-everything, amctl env, am-run.\n- Ensure help text, flag ordering, defaults, and examples match legacy spec (br-2ei.5.6).\n\nLogging/artifacts:\n- Store golden outputs under tests/fixtures/cli_help/.\n- On mismatch, print unified diffs and save actual outputs under tests/artifacts/cli/help/<timestamp>/.\n\nDependencies:\n- br-2ei.5.15.6\n\n## Acceptance Criteria\n1. Golden help snapshots exist for top-level and listed subcommands and are checked in under `tests/fixtures/cli_help/`.\n2. Tests compare help output exactly (including flag ordering and defaults), with normalization limited to documented nondeterminism.\n3. Non-TTY execution produces colorless output and is part of the snapshot set.\n4. On mismatch, a unified diff is printed and actual outputs are stored under `tests/artifacts/cli/help/<timestamp>/`.\n5. Tests are deterministic and run in CI without needing network or external tools.","status":"closed","priority":1,"issue_type":"task","assignee":"PurpleHawk","created_at":"2026-02-05T07:50:47.384522408Z","created_by":"ubuntu","updated_at":"2026-02-06T18:15:13.942427652Z","closed_at":"2026-02-06T18:15:13.942403938Z","close_reason":"Implemented help snapshot integration test + fixtures under tests/fixtures/cli_help; cargo test -p mcp-agent-mail-cli help_snapshots passes","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2di","type":"blocks","created_at":"2026-02-05T16:19:39.152716318Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5","type":"blocks","created_at":"2026-02-05T16:21:40.931385103Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.1","type":"blocks","created_at":"2026-02-05T07:50:52.154619572Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.10","type":"blocks","created_at":"2026-02-05T15:16:56.008440818Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.11","type":"blocks","created_at":"2026-02-05T15:16:56.099826767Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.12","type":"blocks","created_at":"2026-02-05T15:16:56.187563061Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.13","type":"blocks","created_at":"2026-02-05T15:16:56.284729729Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.14","type":"blocks","created_at":"2026-02-05T15:16:56.376921036Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.15","type":"blocks","created_at":"2026-02-05T15:16:56.470511628Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.2","type":"blocks","created_at":"2026-02-05T07:50:52.245573523Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.3","type":"blocks","created_at":"2026-02-05T07:50:52.336195479Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.4","type":"blocks","created_at":"2026-02-05T07:50:52.426020015Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.5","type":"blocks","created_at":"2026-02-05T07:50:52.515717862Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T07:50:52.601998356Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.7","type":"parent-child","created_at":"2026-02-05T07:50:47.384522408Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.8","type":"blocks","created_at":"2026-02-05T15:16:55.825336985Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.9","type":"blocks","created_at":"2026-02-05T15:16:55.918105278Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-3np","type":"blocks","created_at":"2026-02-05T16:19:39.013361447Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-9jl","type":"blocks","created_at":"2026-02-05T16:19:39.250672830Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.7.4","title":"CLI Tests: JSON output stability","description":"JSON output stability tests for CLI commands that expose machine-readable data.\n\nCoverage:\n- Ensure JSON output schemas match legacy (field names, nesting, nullability).\n- Verify stable ordering where legacy is stable (or document normalization).\n- Commands: guard status/check, share verify/preview, doctor check, list-projects, list-acks, products search/inbox/status, archive list, acks pending/remind/overdue, file_reservations list/active/soon.\n\nLogging/artifacts:\n- Store expected JSON fixtures under tests/fixtures/cli_json/.\n- On mismatch, emit JSON diff and save actual outputs under tests/artifacts/cli/json/<timestamp>/.\n\nDependencies:\n- br-2ei.5.15.6\n\n## Acceptance Criteria\n1. Tests run under `cargo test -p mcp-agent-mail-cli` (or workspace equivalent) and cover all listed JSON-producing commands.\n2. JSON schemas match legacy fixtures (field names/types/nullability); any normalization rules are documented in the fixtures.\n3. Ordering is stable where required (or normalized before comparison) and asserted in tests.\n4. On mismatch, tests print a JSON diff and store actual outputs under `tests/artifacts/cli/json/<timestamp>/`.\n5. Tests are deterministic and pass on a clean temp env (no reliance on machine-specific paths).","status":"closed","priority":1,"issue_type":"task","assignee":"PurpleHawk","created_at":"2026-02-05T07:51:01.253361843Z","created_by":"ubuntu","updated_at":"2026-02-06T18:17:44.975960142Z","closed_at":"2026-02-06T18:17:44.975937740Z","close_reason":"Generated JSON fixtures under tests/fixtures/cli_json and cli_json_snapshots integration test passes","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2di","type":"blocks","created_at":"2026-02-05T16:19:45.277037639Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5","type":"blocks","created_at":"2026-02-05T16:21:41.018623798Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.1","type":"blocks","created_at":"2026-02-05T07:51:06.732190931Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.10","type":"blocks","created_at":"2026-02-05T15:16:56.751647760Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.11","type":"blocks","created_at":"2026-02-05T15:16:56.844039363Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.12","type":"blocks","created_at":"2026-02-05T15:16:56.936984349Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.13","type":"blocks","created_at":"2026-02-05T15:16:57.031358878Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.14","type":"blocks","created_at":"2026-02-05T15:16:57.124581116Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.15","type":"blocks","created_at":"2026-02-05T15:16:57.219280176Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.2","type":"blocks","created_at":"2026-02-05T07:51:06.825343050Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.3","type":"blocks","created_at":"2026-02-05T07:51:06.919542630Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.4","type":"blocks","created_at":"2026-02-05T07:51:07.010359283Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.5","type":"blocks","created_at":"2026-02-05T07:51:07.101986571Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T07:51:07.193432639Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.7","type":"parent-child","created_at":"2026-02-05T07:51:01.253361843Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.8","type":"blocks","created_at":"2026-02-05T15:16:56.563589374Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.9","type":"blocks","created_at":"2026-02-05T15:16:56.656163861Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-3np","type":"blocks","created_at":"2026-02-05T16:19:45.183463238Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-9jl","type":"blocks","created_at":"2026-02-05T16:19:45.371365328Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.8","title":"CLI: products subcommands parity (ensure/link/status/search/inbox/summarize-thread)","description":"Port and verify the legacy product-bus CLI commands.\n\nScope (match legacy Typer behavior):\n- commands: products ensure, products link, products status, products search, products inbox, products summarize-thread.\n- flags/args: product_key? defaults, --name/-n, --limit/-l, --urgent-only/--all, --include-bodies/--no-bodies, --since-ts, --per-thread-limit/-n, --no-llm.\n- outputs: human (frankentui table) + --json mode with stable schemas.\n- exit codes: invalid args, missing product, no links, etc.\n\nImplementation notes:\n- Use existing product tools / DB queries (avoid new business logic).\n- Ensure consistent sorting and deterministic timestamps where legacy normalizes.\n- Surface errors with clear, legacy-matching messages.\n\nTests (must be comprehensive):\n- Unit: clap parsing, default values, env overrides (if any), invalid arg combos.\n- Integration: temp DB + temp storage_root, exercise each command with 0/1/n results.\n- JSON stability: golden fixtures for each commands JSON output.\n- E2E: include in scripts/e2e_cli.sh (or a dedicated product E2E case) and save artifacts.\n\nLogging/artifacts:\n- Store stdout/stderr under tests/artifacts/cli/products/<timestamp>/ on failure.\n- Print expected vs actual diffs for JSON payload mismatches.\n\n## Acceptance Criteria\n1. All listed products commands exist and match legacy flags/defaults/exit codes.\n2. Human output uses frankentui tables; non-TTY disables color.\n3. JSON mode outputs are schema-stable and covered by fixtures.\n4. Integration tests run in isolation (temp dirs) and are deterministic.\n5. E2E path captures artifacts and fails fast on mismatch.","status":"closed","priority":1,"issue_type":"task","assignee":"RusticOtter","created_at":"2026-02-05T15:13:29.512773709Z","created_by":"ubuntu","updated_at":"2026-02-06T02:20:58.455989543Z","closed_at":"2026-02-06T02:20:58.455963574Z","close_reason":"Completed products CLI parity (positional inbox agent, legacy fallback behavior) + added deterministic integration tests","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.8","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T15:13:29.512773709Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.9","title":"CLI: archive save/list/restore parity (safe + deterministic)","description":"Port and verify the legacy archive commands (save/list/restore).\n\nScope (match legacy Typer behavior):\n- archive save: project filters (repeat), scrub preset, optional label.\n- archive list: --limit/-n, --json output; stable ordering.\n- archive restore: requires archive_file, --force/-f, --dry-run; explicit warnings.\n\nSafety requirements:\n- No destructive actions without explicit flags (match legacy prompts).\n- Restore should validate manifest presence + show scope before applying.\n- Dry-run prints exact actions without mutating storage.\n\nTests:\n- Unit: clap parsing + defaults; invalid flags produce correct exit codes.\n- Integration: temp storage_root + temp DB; create archive from seeded data, list it, and restore into a clean temp dir.\n- Negative cases: missing archive path, malformed manifest, restore without --force (if legacy requires).\n- JSON fixtures for list output.\n\nLogging/artifacts:\n- Store stdout/stderr under tests/artifacts/cli/archive/<timestamp>/ on failure.\n- Emit diffs for list JSON mismatch.\n\n## Acceptance Criteria\n1. archive save/list/restore exist and match legacy flags/defaults/exit codes.\n2. list output is deterministic and JSON-stable.\n3. restore honors --dry-run and --force semantics; no destructive behavior in tests.\n4. Integration tests pass in isolated temp dirs with detailed artifacts on failure.","status":"closed","priority":1,"issue_type":"task","assignee":"RusticOtter","created_at":"2026-02-05T15:13:37.540954876Z","created_by":"ubuntu","updated_at":"2026-02-06T01:34:01.636562491Z","closed_at":"2026-02-06T01:34:01.636539307Z","close_reason":"Implemented archive save/list/restore parity + roundtrip test (no env mutation); clippy/fmt/test green","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.9","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T15:13:37.540954876Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.6","title":"Integration: enforce local-crate usage (asupersync/sqlmodel/fastmcp/frankentui) + agent detection","description":"## Objective\nEnforce **local-crate usage** and eliminate upstream duplicates, ensuring the port fully leverages `/dp` crates as required.\n\n## Scope\n- **fastmcp_rust** for MCP server/router and resource handling.\n- **sqlmodel_rust** for SQLite DB models, migrations, and queries.\n- **asupersync** for async/runtime + I/O (replace tokio where applicable).\n- **frankentui** for all terminal/CLI rendering.\n- **beads_rust** for any beads integration.\n- **coding_agent_session_search** for agent detection.\n\n## Implementation Notes\n- Audit Cargo.toml + code to remove direct tokio usage and other upstream deps duplicated by local crates.\n- Add compile-time or CI checks to detect forbidden deps (`tokio`, `rusqlite`, etc.).\n\n## Tests\n- Unit tests for agent detection and asupersync-based execution paths.\n- CI checks or tests to assert forbidden deps are absent.\n\n## Logging/Artifacts\n- Emit dependency audit reports under `tests/artifacts/deps/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-02-05T05:06:57.327442629Z","created_by":"ubuntu","updated_at":"2026-02-06T17:03:37.950335321Z","closed_at":"2026-02-06T17:03:37.950311025Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.6","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.6.1","title":"Audit: eliminate tokio and upstream duplicates (use asupersync/sqlmodel)","description":"## Objective\nAudit and remove any `tokio` usage or upstream duplicates to align with asupersync/sqlmodel_rust/fastmcp_rust.\n\n## Scope\n- Locate tokio usage in all crates (runtime, fs, net, channels, timers).\n- Replace with asupersync equivalents or sync code paths.\n- Remove redundant deps (`tokio`, `rusqlite`, `reqwest` if replaced by asupersync).\n\n## Tests\n- Compile/test pass without tokio.\n- Unit tests for replacement paths (timers, spawning, async I/O).\n\n## Logging/Artifacts\n- Emit a dependency diff report under `tests/artifacts/deps/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T05:13:17.777775741Z","created_by":"ubuntu","updated_at":"2026-02-06T08:13:12.942728778Z","closed_at":"2026-02-06T08:13:12.942705705Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.6.1","depends_on_id":"br-2ei.6","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.6.2","title":"Integrate coding_agent_session_search for installed-agent detection (tokio-free surface)","description":"## Objective\nIntegrate `/dp/coding_agent_session_search` for installedagent detection with a tokiofree surface.\n\n## Scope\n- Expose a helper API in Rust port to detect installed/active coding agents (Claude/Codex/Gemini/etc.).\n- Match legacy behavior for discovery and output (if present in Python toolchain).\n- Ensure this integrates cleanly with CLI commands that report environment or agent availability.\n\n## Tests\n- Unit tests with mocked environment/session directories.\n- Integration test in temp dir verifying detection output schema.\n\n## Logging/Artifacts\n- Store detection reports under `tests/artifacts/agents/<timestamp>/` on failure.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":2,"issue_type":"task","assignee":"GreenDune","created_at":"2026-02-05T05:13:25.051447400Z","created_by":"ubuntu","updated_at":"2026-02-06T17:01:37.313039607Z","closed_at":"2026-02-06T17:01:37.313019099Z","close_reason":"Implemented tokio-free installed-agent detection via coding_agent_session_search + deterministic tests; cargo fmt/clippy/test passing","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.6.2","depends_on_id":"br-2ei.6","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.6.2","depends_on_id":"br-2ei.6.1","type":"blocks","created_at":"2026-02-05T15:18:11.670479892Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.6.3","title":"Upstream dependency: asupersync Http1Request.peer_addr","description":"This repo needs accurate client peer address (SocketAddr) on each HTTP request to match legacy Python behavior for:\n- localhost bypass (allow_localhost_unauthenticated)\n- bearer token injection for base-path passthrough\n- rate limit identity derivation (host when JWT sub missing)\n\nUpstream work lives in /dp/asupersync.\n\nRequired API surface (asupersync):\n1. Expose the remote peer address on Http1Request (or equivalent request context):\n   - Prefer: `Http1Request.peer_addr: Option<SocketAddr>` (or accessor)\n   - Must be present even when no forwarded headers are set\n2. Ensure forwarded headers do NOT overwrite peer_addr (legacy uses actual client host for localhost checks).\n3. Maintain tokio-free surface (asupersync conventions).\n\nDownstream work (this repo):\n- Update mcp-agent-mail-server to read peer_addr and derive client_host string, including IPv4-mapped IPv6 handling.\n- Wire into localhost detection helper + rate limit identity.\n\nExternal references:\n- asupersync beads created by another agent: bd-32eba (and children) (prefix may be corrected later).\n\n## Acceptance Criteria\n1. /dp/asupersync exposes peer_addr in the HTTP request type used by mcp-agent-mail-server.\n2. This repo can compile against the updated asupersync without tokio.\n3. br-1bm.3.1 can be implemented using this API with no hacks.","status":"closed","priority":0,"issue_type":"task","assignee":"ubuntu","created_at":"2026-02-05T06:08:02.941793644Z","created_by":"ubuntu","updated_at":"2026-02-05T08:31:31.290546761Z","closed_at":"2026-02-05T08:31:31.290526042Z","close_reason":"Added Http1Request.peer_addr and wired through Http1Server/Listener (asupersync)","external_ref":"/dp/asupersync:bd-32eba","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.6.3","depends_on_id":"br-2ei.6","type":"parent-child","created_at":"2026-02-05T06:08:02.941793644Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.7","title":"Benchmarks: tool latency + archive throughput + share/export budgets","description":"\nTests:\n- Bench smoke tests (fast path) to validate fixtures, JSON summary output, and golden hashes.\n- CI guardrails: compare p50/p95 metrics against budgets; fail on regressions.\n- E2E: optional bench-smoke path in scripts/e2e_test.sh to validate determinism and logging.\n\n## Acceptance Criteria\n1. Bench suite is deterministic with stable fixture hashes and JSON summaries.\n2. Budgets are enforced in CI (fail on regression with clear diff).\n3. Bench-smoke path runs quickly and validates logging + golden output checks.","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-02-05T05:07:03.312826328Z","created_by":"ubuntu","updated_at":"2026-02-06T16:43:17.482366145Z","closed_at":"2026-02-06T16:43:17.482341790Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.7","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.7.1","title":"Bench: establish baseline budgets + golden outputs for hot tool paths","description":"Capture baseline performance numbers and lock them in (profile-first per extreme optimization workflow).\n\nWork:\n- Baseline runs:\n  - Use `hyperfine --warmup 3 --runs 10` for representative commands.\n  - Record p50/p95/p99, throughput, and allocations where possible.\n- Profiling:\n  - Capture flamegraphs for top 3 hot paths (tool handler, archive write, share export).\n  - Identify hotspot functions and record in the budget doc.\n- Golden outputs:\n  - Capture golden outputs for stable surfaces (JSON, help text, share manifest ordering, archive artifacts).\n  - Record sha256 checksums to prove behavior unchanged in later optimizations.\n- Opportunity matrix:\n  - For each hotspot, score ImpactConfidence/Effort; only pursue Score  2.0.\n- Isomorphism proof template:\n  - Document ordering/tie-breaking/RNG/float invariants for each optimization.\n\n## Acceptance Criteria\n- Budget doc exists (e.g., benches/BUDGETS.md or docs/perf-budgets.md) with:\n  - target p50/p95/p99 for most-called tools\n  - max allocations for archive writes and share/export\n  - documented baseline commands + hardware notes\n  - flamegraph links/paths\n- Golden outputs are validated via `sha256sum -c` (or equivalent) in CI.\n- Optimization workflow (profile  change  prove) is documented and enforced.\n- Bench harness emits machine-readable JSON summaries and stores detailed logs/artifacts per run.\n- A bench smoke step (CI or `scripts/e2e_test.sh` optional path) validates budgets + golden outputs without network access.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T05:13:31.777132727Z","created_by":"ubuntu","updated_at":"2026-02-05T15:12:06.976807154Z","closed_at":"2026-02-05T15:12:06.976716022Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.7.1","depends_on_id":"br-2ei.7","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.7.2","title":"Bench: archive write throughput (message + attachments + commit batching)","description":"## Objective\nBenchmark archive write throughput for messages + attachments + commit batching with deterministic fixtures.\n\n## Scope\n- Measure endtoend archive write cost for:\n  - single message (no attachments)\n  - message with small inline attachment\n  - message with file-backed attachment\n  - batch send (N messages) to exercise commit queue batching\n- Capture p50/p95/p99 latency + throughput (msgs/sec).\n\n## Implementation Notes\n- Use controlled temp storage_root and temp DB.\n- Ensure git commit queue behavior matches legacy (max batch size + max wait).\n\n## Tests\n- Criterion benches in `crates/mcp-agent-mail/benches/`.\n- Optional hyperfine runner for CLI-level throughput.\n\n## Logging/Artifacts\n- Save JSON summaries and raw timing samples under `tests/artifacts/bench/archive/<timestamp>/`.\n- Emit regression diffs against baseline budgets.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":2,"issue_type":"task","assignee":"GreenDune","created_at":"2026-02-05T05:13:37.368254570Z","created_by":"ubuntu","updated_at":"2026-02-06T08:13:06.216656062Z","closed_at":"2026-02-06T08:13:06.216632718Z","close_reason":"Implemented archive write throughput benches + budgets + artifact harness","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.7.2","depends_on_id":"br-2ei.2.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.7.2","depends_on_id":"br-2ei.2.5","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.7.2","depends_on_id":"br-2ei.7","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.7.2","depends_on_id":"br-2ei.7.1","type":"blocks","created_at":"2026-02-05T06:58:02.715728602Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.7.3","title":"Bench: share/export pipeline (snapshot+scrub+bundle) budgets","description":"Add benchmarks for the share/export pipeline (snapshot + scrub + bundle) using the extreme-optimization workflow.\n\nWork:\n- Measure end-to-end share/export for representative DB sizes:\n  - tiny fixture (fast path)\n  - medium fixture (includes attachments)\n  - optional large synthetic fixture (chunking path)\n- Track:\n  - runtime p50/p95/p99\n  - output bundle size\n  - chunking overhead vs non-chunked\n- Use hyperfine for CLI-level measurement and Criterion for internal pipeline timing.\n- Capture flamegraph and hotspot list before any optimization.\n- Assert bundle determinism via stable hashes (manifest + DB + attachments).\n\nLogging/artifacts:\n- Store benchmark outputs, flamegraphs, and JSON summaries under tests/artifacts/bench/share/<timestamp>/.\n- On budget regression, emit a structured diff of expected vs actual p50/p95/p99 and output sizes.\n\n## Acceptance Criteria\n- Bench harness exists and runs locally with a single command.\n- Deterministic fixtures/generators and machine-readable summary JSON.\n- Output bundle determinism enforced with hash checks.\n- Budgets recorded in br-2ei.7.1 doc; pass/fail thresholds enforced.\n- Hotspot evidence recorded (top 5 functions by time).\n- Isomorphism proof template used if any optimization is proposed.\n- Bench artifacts (logs/JSON/flamegraphs) are captured in `tests/artifacts/bench/share/<timestamp>/`.\n\nDependencies:\n- br-2ei.7.1, br-2ei.4.5, br-2ei.7","status":"closed","priority":3,"issue_type":"task","created_at":"2026-02-05T05:13:51.914580151Z","created_by":"ubuntu","updated_at":"2026-02-06T15:23:01.476400757Z","closed_at":"2026-02-06T15:23:01.476380218Z","close_reason":"Implemented share/export bench harness + budgets + determinism checks + hotspot summary; updated BUDGETS; stabilized share SQL ordering; fixed tooling_locks conformance","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.7.3","depends_on_id":"br-1uf","type":"blocks","created_at":"2026-02-05T16:17:54.340603465Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.7.3","depends_on_id":"br-2ei.4.5","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.7.3","depends_on_id":"br-2ei.7","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.7.3","depends_on_id":"br-2ei.7.1","type":"blocks","created_at":"2026-02-05T06:58:02.797620961Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.8","title":"Docs: add Rust-port README + dev workflow (fmt/clippy/test/conformance/bench)","description":"Add a top-level README.md for this Rust port.\n\nMust include:\n- What the project is (Rust port of mcp_agent_mail)\n- How to run MCP server: stdio and HTTP\n- How to run conformance tests\n- How to regenerate fixtures (legacy venv python command)\n- How to run benches\n- Notes on per-agent CARGO_TARGET_DIR to avoid multi-agent target lock contention\n\nAcceptance:\n- README is accurate and matches current code + scripts.\n","status":"closed","priority":3,"issue_type":"task","created_at":"2026-02-05T05:07:09.183372429Z","created_by":"ubuntu","updated_at":"2026-02-05T05:38:39.476350794Z","closed_at":"2026-02-05T05:38:39.476334223Z","close_reason":"Added top-level README with run/test/conformance/bench instructions","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.8","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9","title":"E2E Test Suite: harness + scripts + artifacts","description":"E2E test suite covering full legacy parity across HTTP, CLI, guard, archive, share, notifications, and LLM.\n\nScripts:\n- scripts/e2e_test.sh (driver)\n- scripts/e2e_http.sh (HTTP parity)\n- scripts/e2e_cli.sh (CLI stability)\n- scripts/e2e_guard.sh (guard enforcement)\n- scripts/e2e_archive.sh (archive side effects)\n- scripts/e2e_share.sh (share/export determinism)\n- scripts/e2e_notifications.sh (signal files)\n- scripts/e2e_llm.sh (llm_mode smoke)\n\nLogging/artifacts:\n- Each script writes artifacts under tests/artifacts/<area>/<timestamp>/ with:\n  - request/response transcripts (for HTTP)\n  - stdout/stderr captures (CLI/guard)\n  - file tree + hashes (archive/share)\n  - expected vs actual diffs on mismatch\n\nDeterminism + safety:\n- Use temp dirs and deterministic fixtures.\n- No destructive git/fs commands; fail fast on any mismatch.\n\nTests:\n- E2E harness unit tests for log helpers and artifact capture.\n- Integration tests for each script entry to validate deterministic outputs.\n- CI runs scripts/e2e_test.sh with selective paths and captures artifacts.\n\n## Acceptance Criteria\n1. All E2E scripts run via scripts/e2e_test.sh and produce artifacts with clear diffs.\n2. Coverage includes HTTP parity, CLI stability, guard enforcement, archive parity, share/export determinism, notifications, and LLM smoke.\n3. E2E harness is deterministic and avoids destructive commands.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-05T05:52:30.044860332Z","created_by":"ubuntu","updated_at":"2026-02-06T20:18:32.666696688Z","closed_at":"2026-02-06T20:18:32.666673765Z","close_reason":"15 E2E test suites passing, all scripts implemented and exercised (stdio, HTTP, guard, macros, archive, CLI, notifications, LLM, rate-limit, JWT, etc.)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:52:30.044860332Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9","depends_on_id":"br-2ei.5","type":"blocks","created_at":"2026-02-05T15:18:14.778532018Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9.1","title":"E2E: harness scaffolding (runner + log helpers + artifacts)","description":"Create the shared E2E harness used by all other E2E scripts.\n\nDeliverables:\n- scripts/e2e_test.sh: top-level runner (can run all suites or a named suite).\n- scripts/e2e_lib.sh: helpers for:\n  - mktemp workspace + cleanup (AM_E2E_KEEP_TMP=1)\n  - artifact dir selection (tests/artifacts/<suite>/<timestamp>/)\n  - logging (case banners, expected vs actual)\n  - stable hashing + file tree dumps\n  - retry helpers for flaky ports/binds\n\nRequirements:\n- Detailed logging by default; include env dump (redacting secrets).\n- All scripts must be safe (no destructive git/fs commands).\n- The runner must set CARGO_TARGET_DIR if not already set (recommended per-agent directory).\n\n## Acceptance Criteria\n1. scripts/e2e_test.sh exists and can run at least one suite.\n2. scripts/e2e_lib.sh provides logging + artifact helpers used by all suites.\n3. All suites write artifacts under tests/artifacts/<suite>/<timestamp>/.\n4. All suites exit non-zero on mismatch and print expected vs actual.\n5. AM_E2E_KEEP_TMP=1 retains temp dirs.\n6. Runner respects/sets CARGO_TARGET_DIR (no multi-agent target contention).\n7. Harness uses only temp dirs and does not run destructive git/fs commands.","acceptance_criteria":"1. scripts/e2e_test.sh exists and can run at least one suite\n2. scripts/e2e_lib.sh provides logging + artifact helpers\n3. All scripts write artifacts under tests/artifacts/<suite>/<timestamp>/\n4. All scripts exit non-zero on mismatch and print expected vs actual\n5. AM_E2E_KEEP_TMP=1 retains temp dirs\n6. Runner respects/sets CARGO_TARGET_DIR (no multi-agent target contention)\n7. No destructive git/fs commands used (temp dirs only)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:52:47.452322784Z","created_by":"ubuntu","updated_at":"2026-02-05T06:20:14.780147870Z","closed_at":"2026-02-05T06:20:14.780077948Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9.1","depends_on_id":"br-2ei.9","type":"parent-child","created_at":"2026-02-05T05:52:47.452322784Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9.2","title":"E2E: archive write/read side effects (messages + reservations + attachments)","description":"End-to-end verification of git archive side effects (messages + reservations + attachments) *and* notification signals.\n\nScript:\n- scripts/e2e_archive.sh (invoked by scripts/e2e_test.sh)\n\nFlow (high-signal, deterministic):\n1. Use a temp storage_root + temp DB path.\n2. Launch server/router (stdio or in-process harness) and execute:\n   - ensure_project\n   - register_agent(s)\n   - send_message (with 0, 1, and multiple recipients)\n   - file_reservation_paths (exclusive + shared)\n   - renew/release reservation\n   - send_message with a small inline attachment and a file-backed attachment\n3. Verify git archive:\n   - expected directories exist\n   - canonical messages path format and frontmatter JSON parse\n   - inbox/outbox copies exist and match canonical\n   - file_reservations artifacts exist (sha1(pattern).json + id-<id>.json)\n   - attachments manifests exist; content hashes match references\n   - git log contains expected commit summaries\n4. Notifications (signals) parity:\n   - enable notifications (NOTIFICATIONS_ENABLED + NOTIFICATIONS_SIGNALS_DIR in temp)\n   - after send_message, assert signal files exist for `to` + `cc` recipients only (NOT bcc)\n   - after fetch_inbox, assert the signal file for that agent is cleared\n\nLogging/artifacts:\n- Dump file tree + sizes, and sha256 hashes for large artifacts.\n- On failure, print unified diffs for markdown/frontmatter mismatches.\n- For notifications, capture signal JSON payloads (expected vs actual) on mismatch.\n- Write all outputs to tests/artifacts/archive/<timestamp>/.\n\nNotes:\n- Avoid external deps; use git CLI only for inspecting commits.\n- Never use destructive git/fs commands.\n\n## Acceptance Criteria\n1. scripts/e2e_archive.sh runs via scripts/e2e_test.sh archive.\n2. Script produces tests/artifacts/archive/<timestamp>/ with:\n   - archive file tree + sizes\n   - sha256 hashes for large artifacts\n   - per-case expected vs actual logs\n3. Script exits non-zero on first mismatch and prints a clear failing case header.\n4. Archive invariants are asserted: canonical/inbox/outbox match, reservation artifacts present, attachment manifests/hashes match.\n5. Notifications invariants are asserted when enabled: signals emitted for to+cc only and cleared on fetch_inbox.","status":"closed","priority":0,"issue_type":"task","assignee":"StormyStream","created_at":"2026-02-05T05:53:07.432876569Z","created_by":"ubuntu","updated_at":"2026-02-06T09:32:47.428422542Z","closed_at":"2026-02-06T09:32:47.428397766Z","close_reason":"Implemented archive E2E suite + fixed attachment artifacts committed with message bundle (extra_paths). Verified: cargo fmt/clippy/test + E2E archive suite green.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9.2","depends_on_id":"br-2ei.12.2","type":"blocks","created_at":"2026-02-05T07:34:52.461587201Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.2","depends_on_id":"br-2ei.2.2","type":"blocks","created_at":"2026-02-05T05:53:07.432876569Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.2","depends_on_id":"br-2ei.2.3","type":"blocks","created_at":"2026-02-05T05:53:07.432876569Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.2","depends_on_id":"br-2ei.2.4","type":"blocks","created_at":"2026-02-05T05:53:07.432876569Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.2","depends_on_id":"br-2ei.2.5","type":"blocks","created_at":"2026-02-05T05:53:07.432876569Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.2","depends_on_id":"br-2ei.9","type":"parent-child","created_at":"2026-02-05T05:53:07.432876569Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.2","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T14:07:31.001964142Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9.3","title":"E2E: guard enforcement in temp git repo (pre-commit + renames)","description":"End-to-end verification of the guard system in a real temp git repo.\n\nScript:\n- scripts/e2e_guard.sh\n\nFlow:\n1. Create a temp git repo with a tracked file.\n2. Install the agent-mail guard (via CLI `am guard install` or MCP tool).\n3. Create an exclusive file reservation held by another agent for the file (or a matching pattern).\n4. Modify + stage the file, attempt `git commit`:\n   - Expected: blocked (non-zero), stderr contains clear conflict info.\n5. Release the reservation and retry commit:\n   - Expected: allowed.\n6. Rename scenario:\n   - Create reservation matching old/new path; stage rename; ensure guard checks both sides.\n7. stdin-nul + ignorecase:\n   - run guard check with --stdin-nul input (NUL-delimited paths) and verify correct conflict detection.\n   - set core.ignorecase true and verify case-insensitive match behavior matches legacy.\n\nLogging/artifacts:\n- Capture hook output, git status/diff summaries, and reservation records.\n- Store under tests/artifacts/guard/<timestamp>/.\n\nSafety:\n- Operate only within temp dirs.\n- Never run destructive git/fs commands.\n\n## Acceptance Criteria\n1. scripts/e2e_guard.sh runs via scripts/e2e_test.sh guard.\n2. Script demonstrates a blocked commit when an exclusive reservation conflicts, including clear stderr output.\n3. Script demonstrates an allowed commit after reservation release.\n4. Rename case asserts both old and new paths are checked.\n5. stdin-nul and core.ignorecase behaviors are validated and match legacy.\n6. Artifacts under tests/artifacts/guard/<timestamp>/ include hook output + git summaries + reservation JSON.","status":"closed","priority":1,"issue_type":"task","assignee":"RusticGlen","created_at":"2026-02-05T05:53:18.903635568Z","created_by":"ubuntu","updated_at":"2026-02-06T17:42:09.313814727Z","closed_at":"2026-02-06T17:42:09.313790110Z","close_reason":"E2E guard suite now passes: pre-commit blocks on exclusive reservation, allows after release; rename old+new, stdin-nul, core.ignorecase covered.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9.3","depends_on_id":"br-2ei.3.1","type":"blocks","created_at":"2026-02-05T14:07:27.894140772Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.3","depends_on_id":"br-2ei.3.2","type":"blocks","created_at":"2026-02-05T14:07:27.982001326Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.3","depends_on_id":"br-2ei.3.3","type":"blocks","created_at":"2026-02-05T05:53:18.903635568Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.3","depends_on_id":"br-2ei.5.2","type":"blocks","created_at":"2026-02-05T05:53:18.903635568Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.3","depends_on_id":"br-2ei.9","type":"parent-child","created_at":"2026-02-05T05:53:18.903635568Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.3","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T14:07:27.803790200Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9.4","title":"E2E: share/export bundle (manifest + DB + attachments + determinism)","description":"End-to-end verification of share/export bundle creation.\n\nScript:\n- scripts/e2e_share.sh\n\nFlow:\n1. Seed a realistic mailbox DB + attachments (via conformance seeding or direct tool calls).\n2. Run `am share export` (or equivalent) to produce a bundle directory.\n3. Verify bundle correctness:\n   - manifest.json exists and validates expected fields\n   - export DB exists, passes PRAGMA integrity_check\n   - FTS/views exist and basic queries succeed\n   - attachments directory contains all referenced paths\n   - chunking behavior triggers appropriately when DB size threshold exceeded (can simulate with padding)\n4. Determinism check:\n   - Run export twice from same inputs; compare stable hashes of key outputs (manifest + DB + attachment manifests).\n5. Preview + verify subcommands:\n   - Run `am share preview` on the bundle and assert expected summary fields.\n   - Run `am share verify` (or equivalent) and assert success for valid bundle.\n   - Corrupt manifest/attachment reference and assert `verify` fails with clear error.\n6. Signing/encryption (when enabled):\n   - Run signed export and verify signature.\n   - Run encrypted export and verify decrypt roundtrip.\n\nLogging/artifacts:\n- Dump bundle tree + sizes, log PRAGMA results, and hashes.\n- Store under tests/artifacts/share/<timestamp>/.\n\nExit criteria:\n- Any mismatch -> non-zero.\n\n## Acceptance Criteria\n1. scripts/e2e_share.sh runs via scripts/e2e_test.sh share.\n2. Script produces tests/artifacts/share/<timestamp>/ including bundle tree, PRAGMA results, and hashes.\n3. Script asserts manifest/db/attachments consistency and fails on missing referenced paths.\n4. Script asserts deterministic output across two runs from identical inputs (documented hash set).\n5. Preview/verify subcommands are exercised and emit expected success/error semantics.\n6. When signing/encryption are enabled, E2E validates signature and decrypt roundtrip using deterministic fixtures.","status":"closed","priority":1,"issue_type":"task","assignee":"PearlOwl","created_at":"2026-02-05T05:53:34.886696183Z","created_by":"ubuntu","updated_at":"2026-02-06T20:28:30.416548708Z","closed_at":"2026-02-06T20:28:30.416522649Z","close_reason":"E2E share/export test suite created: scripts/e2e_share.sh with 24 assertions across 11 cases (dry-run, full export, DB integrity, FTS, manifest, determinism, verify valid/nonexistent/corrupted, ZIP, scrub presets). Runs via scripts/e2e_test.sh share. Artifacts at tests/artifacts/share/<timestamp>/","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9.4","depends_on_id":"br-1uf","type":"blocks","created_at":"2026-02-05T16:17:49.476267906Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.4.1","type":"blocks","created_at":"2026-02-05T14:06:53.918099605Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.4.2","type":"blocks","created_at":"2026-02-05T14:06:54.006077170Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.4.3","type":"blocks","created_at":"2026-02-05T14:06:54.092389831Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.4.4.1","type":"blocks","created_at":"2026-02-05T14:06:54.182943385Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.4.4.2","type":"blocks","created_at":"2026-02-05T14:06:54.271276309Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.4.5","type":"blocks","created_at":"2026-02-05T05:53:34.886696183Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.4.6","type":"blocks","created_at":"2026-02-05T08:50:00.556279549Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T14:06:54.361917468Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.5.3","type":"blocks","created_at":"2026-02-05T05:53:34.886696183Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.9","type":"parent-child","created_at":"2026-02-05T05:53:34.886696183Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T14:06:53.826537062Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-3np","type":"blocks","created_at":"2026-02-05T16:17:49.572962733Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9.5","title":"E2E: CLI stability (help text, exit codes, JSON mode)","description":"End-to-end verification that the CLI is stable for humans and automation.\n\nScript:\n- scripts/e2e_cli.sh\n\nChecks:\n- `am --help` and key subcommand `--help` outputs are stable (golden snapshots) OR at minimum contain required commands/flags.\n- Exit codes match expectations for common failure modes (bad args, missing config, bind failure).\n- Machine JSON mode:\n  - `--json` produces schema-stable output for commands that support it (products, archive list, doctor, acks, file_reservations, list-projects/list-acks).\n- Human mode:\n  - frankentui tables render without panic when TTY and degrade gracefully when not.\n\nCoverage additions:\n- products commands, archive save/list/restore, docs insert-blurbs, migrate, clear-and-reset-everything, amctl env/am-run.\n- share wizard error path (missing script) with clear exit code.\n\nLogging/artifacts:\n- Save captured help/output snapshots under tests/artifacts/cli/<timestamp>/.\n\nExit criteria:\n- Any mismatch -> non-zero.\n\n## Acceptance Criteria\n1. scripts/e2e_cli.sh runs via scripts/e2e_test.sh cli.\n2. Script captures help outputs and/or validates against the CLI parity inventory (br-2ei.5.6).\n3. Script validates exit codes for representative failure modes.\n4. Script validates JSON output mode is parseable and schema-stable for covered commands.\n5. Artifacts saved under tests/artifacts/cli/<timestamp>/.","notes":"2026-02-06: CyanBridge expanded scripts/e2e_cli.sh coverage (inventory root checks, additional JSON shape checks, bind-failure semantics, share-wizard missing-script path, docs/am-run/archive/products semantics) and revalidated with ./scripts/e2e_test.sh cli + fmt/check/clippy.","status":"closed","priority":2,"issue_type":"task","assignee":"CyanBridge","created_at":"2026-02-05T05:53:45.764307877Z","created_by":"ubuntu","updated_at":"2026-02-06T19:15:05.329983153Z","closed_at":"2026-02-06T19:07:15.295363321Z","close_reason":"E2E CLI stability suite implemented: 20 test cases, 99 assertions, 100% pass. Covers help text, exit codes, JSON mode, DB-dependent commands. Pushed as 16df695.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9.5","depends_on_id":"br-2di","type":"blocks","created_at":"2026-02-05T16:19:51.279714636Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5","type":"blocks","created_at":"2026-02-05T16:21:45.571437067Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.1","type":"blocks","created_at":"2026-02-05T14:07:11.048069628Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.10","type":"blocks","created_at":"2026-02-05T15:16:57.498701889Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.11","type":"blocks","created_at":"2026-02-05T15:16:57.594086941Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.12","type":"blocks","created_at":"2026-02-05T15:16:57.688130126Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.13","type":"blocks","created_at":"2026-02-05T15:16:57.788190936Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.14","type":"blocks","created_at":"2026-02-05T15:16:57.880623446Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.15","type":"blocks","created_at":"2026-02-05T15:16:57.975865058Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.2","type":"blocks","created_at":"2026-02-05T05:53:45.764307877Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.3","type":"blocks","created_at":"2026-02-05T05:53:45.764307877Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.4","type":"blocks","created_at":"2026-02-05T05:53:45.764307877Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.5","type":"blocks","created_at":"2026-02-05T05:53:45.764307877Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T14:07:11.132445303Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.7","type":"blocks","created_at":"2026-02-05T16:21:45.667151611Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.8","type":"blocks","created_at":"2026-02-05T15:16:57.309945017Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.9","type":"blocks","created_at":"2026-02-05T15:16:57.406599751Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.9","type":"parent-child","created_at":"2026-02-05T05:53:45.764307877Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T14:07:10.958601487Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-3np","type":"blocks","created_at":"2026-02-05T16:19:51.186136809Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-9jl","type":"blocks","created_at":"2026-02-05T16:19:51.377666059Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9.6","title":"E2E: HTTP server parity suite (auth/rate-limit/streamable/mail/CORS/logging)","description":"Add a single HTTP-focused E2E script that exercises the *user-visible* HTTP server surface end-to-end, using the shared harness (br-2ei.9.1).\n\nScript:\n- scripts/e2e_http.sh\n\nCoverage (must be parity-oriented, not \"best-effort\"):\n1. Health + well-known endpoints: /health/* and /.well-known/* payloads + status codes.\n2. Bearer auth:\n   - Authorization required when configured\n   - OPTIONS + /health bypass\n   - constant-time compare (behavioral checks)\n3. JWT auth:\n   - HS256 and JWKS modes (use deterministic test vectors)\n   - aud/iss validation\n   - role claim parsing\n   - failure semantics always 401 {\"detail\":\"Unauthorized\"}\n4. Rate limiting:\n   - Redis backend allow/deny sequences\n   - Redis failure -> memory fallback\n   - identity derivation (sub vs host)\n5. Peer addr + localhost bypass:\n   - localhost allowed only when NO forwarded headers\n   - IPv4/IPv6/IPv4-mapped IPv6 cases\n6. Streamable HTTP MCP:\n   - Accept/Content-Type normalization\n   - base path /api and /api/ semantics\n   - passthrough behavior\n   - localhost Authorization injection when configured\n7. /mail SSR UI:\n   - fetch key pages and assert DOM markers\n   - sanitize XSS payloads\n8. CORS:\n   - OPTIONS preflight headers\n   - default allow-* semantics\n9. Request logging + OTEL:\n   - logs emitted only when enabled\n   - OTEL misconfig doesn't crash\n10. Tool filtering profiles (context reduction):\n   - With filtering disabled: tool list matches full baseline.\n   - With filtering enabled (minimal + one custom include/exclude case):\n     - `tools/list` is filtered\n     - `resource://tooling/directory` reflects filtered tools/clusters\n11. Instrumentation (query tracking):\n   - With instrumentation enabled, at least one DB-backed tool call emits a `tool_query_stats` log entry.\n12. ACK TTL background worker (+ optional escalation):\n   - With ACK_TTL enabled (ttl=0), create an ack_required message and assert logs contain `ack_overdue`.\n   - With escalation mode file_reservation, assert a reservation is created (resource read or DB query) without crashing.\n\nArtifacts/logging:\n- tests/artifacts/http/<timestamp>/\n- For each case: record request (curl args), response status, headers, body, and expected-vs-actual.\n- When applicable, include server stdout/stderr logs and config env snapshot (redacting secrets).\n\n## Acceptance Criteria\n1. scripts/e2e_http.sh exists and can be run via scripts/e2e_test.sh http.\n2. Script exits non-zero on first mismatch and prints expected vs actual.\n3. Artifacts include per-case HTTP transcripts + server logs.\n4. Script is deterministic (no random ports without recording, stable vectors).\n5. Tool filtering checks cover at least: disabled baseline + minimal profile + one custom include/exclude case.\n6. Instrumentation check asserts presence of `tool_query_stats` in captured server logs.\n7. ACK TTL check asserts presence of `ack_overdue` (and file_reservation escalation when enabled).","status":"closed","priority":1,"issue_type":"task","assignee":"CoralDog","created_at":"2026-02-05T06:08:22.826465268Z","created_by":"ubuntu","updated_at":"2026-02-06T17:38:21.198477689Z","closed_at":"2026-02-06T17:38:21.198452152Z","close_reason":"Implemented unified HTTP E2E suite (scripts/e2e_http.sh + tests/e2e/test_http.sh). Fixed mail UI inbox rendering to match templates and corrected mail_ui XSS assertions. Verified: AM_E2E_KEEP_TMP=1 ./scripts/e2e_test.sh http (pass).","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm","type":"blocks","created_at":"2026-02-05T16:21:53.112065981Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.1.5","type":"blocks","created_at":"2026-02-05T06:08:39.251281411Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.10.6","type":"blocks","created_at":"2026-02-05T07:34:16.695583357Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.2.5","type":"blocks","created_at":"2026-02-05T06:08:39.333666265Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.3.4","type":"blocks","created_at":"2026-02-05T06:08:39.420350399Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.4.6","type":"blocks","created_at":"2026-02-05T06:08:39.503300748Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.5.5","type":"blocks","created_at":"2026-02-05T06:08:39.587091700Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.6.4","type":"blocks","created_at":"2026-02-05T06:08:39.675539136Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.7","type":"blocks","created_at":"2026-02-05T06:08:39.758756769Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.8","type":"blocks","created_at":"2026-02-05T06:08:39.841729059Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.9","type":"blocks","created_at":"2026-02-05T06:08:39.924846663Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-2ei.10.3","type":"blocks","created_at":"2026-02-05T06:57:36.927404078Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-2ei.11.3","type":"blocks","created_at":"2026-02-05T06:57:37.009782894Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-2ei.9","type":"parent-child","created_at":"2026-02-05T06:08:22.826465268Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:39.169446083Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9.7","title":"E2E: LLM llm_mode smoke (stubbed)","description":"E2E: LLM llm_mode smoke (stubbed, offline).\n\nScope:\n- Start server with LLM enabled and stubbed completion client.\n- Exercise `summarize_thread` with llm_mode=true and `macro_prepare_thread` llm_mode path.\n- Validate refined summary fields and error fallback when stub returns invalid JSON.\n\nLogging/artifacts:\n- Capture HTTP transcripts + tool payloads.\n- Store artifacts under tests/artifacts/llm/<timestamp>/.\n- Emit expected vs actual JSON diffs on mismatch.\n\nDependencies:\n- br-2ei.9.1 (E2E harness)\n- br-2ei.13.2 (LLM impl)\n- br-2ei.13.3 (LLM tests/spec)\n\n## Acceptance Criteria\n1. E2E test uses a deterministic stubbed LLM client and runs via `scripts/e2e_test.sh` (llm path).\n2. `summarize_thread` with llm_mode=true returns refined fields that match expected JSON fixtures.\n3. `macro_prepare_thread` with llm_mode=true exercises the LLM path and returns refined summaries.\n4. Invalid JSON from the stub triggers the legacy fallback behavior (non-LLM summary + logged error) and is asserted.\n5. Artifacts (requests/responses + diffs) are written to `tests/artifacts/llm/<timestamp>/`.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T08:15:12.039153780Z","created_by":"ubuntu","updated_at":"2026-02-06T17:03:06.967900215Z","closed_at":"2026-02-06T17:03:06.967878724Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9.7","depends_on_id":"br-2ei.13","type":"blocks","created_at":"2026-02-05T16:21:59.682688990Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.7","depends_on_id":"br-2ei.13.2","type":"blocks","created_at":"2026-02-05T08:15:20.655784860Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.7","depends_on_id":"br-2ei.13.3","type":"blocks","created_at":"2026-02-05T08:15:25.092127090Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.7","depends_on_id":"br-2ei.9","type":"parent-child","created_at":"2026-02-05T08:15:12.039153780Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.7","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T08:15:17.568158415Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9.8","title":"E2E: Notifications signal files","description":"E2E: Notifications (signal files) parity.\n\nScope:\n- Start server with notifications enabled.\n- send_message to multiple recipients (to/cc/bcc) and assert signal files for to+cc only.\n- fetch_inbox clears signal for that agent; verify pending list updates.\n- debounce behavior: repeated sends within window do not spam signals (per legacy spec).\n\nLogging/artifacts:\n- Capture filesystem snapshots of signals dir before/after.\n- Store artifacts under tests/artifacts/notifications/<timestamp>/.\n- Emit expected vs actual file lists + JSON diffs on mismatch.\n\nDependencies:\n- br-2ei.9.1 (E2E harness)\n- br-2ei.12.2 (Notifications impl)\n- br-2ei.12.3 (Notifications tests/spec)\n\n## Acceptance Criteria\n1. E2E test runs via `scripts/e2e_test.sh` notifications path and uses temp dirs (no destructive commands).\n2. After send_message, signals are emitted for `to` + `cc` recipients only; `bcc` produces none.\n3. fetch_inbox clears the signal for that agent and the pending list is updated accordingly.\n4. Debounce behavior is verified: repeated sends within the debounce window do not create duplicate signal entries (assert via file list + timestamps or sequence numbers).\n5. Failures emit clear diffs and artifacts are written to `tests/artifacts/notifications/<timestamp>/`.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T08:15:49.568178405Z","created_by":"ubuntu","updated_at":"2026-02-06T17:03:06.969373873Z","closed_at":"2026-02-06T17:03:06.969354547Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9.8","depends_on_id":"br-2ei.12","type":"blocks","created_at":"2026-02-05T16:22:05.558269310Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.8","depends_on_id":"br-2ei.12.2","type":"blocks","created_at":"2026-02-05T08:16:04.913015385Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.8","depends_on_id":"br-2ei.12.3","type":"blocks","created_at":"2026-02-05T08:16:08.094559926Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.8","depends_on_id":"br-2ei.9","type":"parent-child","created_at":"2026-02-05T08:15:49.568178405Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.8","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T08:15:59.389033120Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2he","title":"Share: viewer assets + export data + scaffolding","description":"## Objective\nImplement share pipeline Steps 1012: copy viewer assets, export viewer bootstrap data, and write bundle scaffolding.\n\n## Scope\n- Copy `viewer_assets` into bundle output.\n- Export `messages.json` + `meta.json` for viewer bootstrap (limit default 500).\n- Write scaffolding files: `manifest.json`, README, `_headers`, `HOW_TO_DEPLOY`, `.nojekyll`, `index.html`.\n\n## Tests\n- Integration tests verifying asset presence and bootstrap JSON schema.\n- Snapshot tests for scaffolding files.\n\n## Logging/Artifacts\n- Store scaffolding outputs under `tests/artifacts/share/scaffolding/<timestamp>/`.\n\n## Acceptance Criteria\n1. Viewer assets are copied with correct file list and content.\n2. Exported JSON matches legacy schema and limits.\n3. Bundle scaffolding files are created and deterministic.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T16:16:23.424466902Z","created_by":"ubuntu","updated_at":"2026-02-05T17:54:16.508557943Z","closed_at":"2026-02-05T17:54:16.508539979Z","close_reason":"Viewer assets/export/scaffolding already implemented in bundle.rs with tests; viewer_* tests pass (manifest_* blocked by current core config compile errors)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2he","depends_on_id":"br-1uf","type":"parent-child","created_at":"2026-02-05T16:16:28.198739271Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2sal","title":"CLI projects adopt: cover conflict + same-project edge cases in integration tests","description":"Related to br-2ei.5.7 integration coverage.\\n\\nAdd external integration tests for projects adopt edge cases:\\n- source and target resolve to same project (no-op success path)\\n- duplicate agent names across source/target projects should fail in apply mode and preserve artifacts\\n\\nKeep scope test-only and deterministic.","status":"closed","priority":1,"issue_type":"task","assignee":"IvoryBarn","created_at":"2026-02-06T19:53:53.959274943Z","created_by":"ubuntu","updated_at":"2026-02-06T19:55:20.152635861Z","closed_at":"2026-02-06T19:55:20.152613429Z","close_reason":"Completed: added same-project and duplicate-agent-conflict adopt integration tests","source_repo":".","compaction_level":0,"original_size":0}
{"id":"br-2snt","title":"CLI projects parity: finalize behavior + add integration coverage","description":"Related to br-2ei.5 and br-2ei.5.14.\\n\\nScope:\\n- audit existing projects subcommands (mark-identity/discovery-init/adopt) for legacy behavior mismatches\\n- implement any missing flag/exit-code/path-validation parity\\n- add/extend integration tests for dry-run/apply and error paths\\n- keep outputs deterministic for CLI/E2E follow-on tasks\\n\\nDeliverables:\\n- code changes in CLI command handling\\n- integration tests and/or fixtures proving parity behavior\\n- summary back to coordination thread with touched files","status":"closed","priority":1,"issue_type":"task","assignee":"IvoryBarn","created_at":"2026-02-06T19:04:38.352904968Z","created_by":"ubuntu","updated_at":"2026-02-06T19:12:23.066489126Z","closed_at":"2026-02-06T19:12:23.066467005Z","close_reason":"Completed: added projects integration coverage and parity assertions","source_repo":".","compaction_level":0,"original_size":0}
{"id":"br-2xqi","title":"CLI help snapshots: add projects subcommand coverage","description":"Related to br-2ei.5.7 (golden help snapshots).\\n\\nAdd explicit help snapshot coverage for:\\n- projects mark-identity --help\\n- projects discovery-init --help\\n- projects adopt --help\\n\\nUpdate fixture set and ensure deterministic snapshot test behavior.","status":"closed","priority":1,"issue_type":"task","assignee":"IvoryBarn","created_at":"2026-02-06T19:13:04.771733830Z","created_by":"ubuntu","updated_at":"2026-02-06T19:14:42.754703092Z","closed_at":"2026-02-06T19:14:42.754681281Z","close_reason":"Completed: added projects subcommand help snapshot cases + fixtures","source_repo":".","compaction_level":0,"original_size":0}
{"id":"br-2yw0","title":"Guard parity: unit + integration tests","description":"## Objective\nAdd unit/integration tests for guard behavior beyond the E2E repo test.\n\n## Scope\n- Path matching (pathspec + fnmatch fallback).\n- Precommit scanning (staged files, rename handling).\n- Prepush scanning (commit range).\n- Gate on `WORKTREES_ENABLED`/`GIT_IDENTITY_ENABLED` per legacy guard.py.\n\n## Tests\n- Unit tests for pathspec matches and denylist/allowlist behavior.\n- Integration tests using temp git repo with staged changes and renames.\n\n## Logging/Artifacts\n- Store guard decision logs under `tests/artifacts/guard/<timestamp>/`.\n\n## Acceptance Criteria\n1. Guard behavior matches legacy for staged/renamed files and gate flags.\n2. Unit/integration tests are deterministic and isolate temp repos.","status":"closed","priority":2,"issue_type":"task","assignee":"CoralDog","created_at":"2026-02-05T16:20:57.657586279Z","created_by":"ubuntu","updated_at":"2026-02-06T12:36:36.933732035Z","closed_at":"2026-02-06T12:36:36.933706597Z","close_reason":"Added guard unit/integration tests for gate parsing + pre-push path enumeration (rev-list + diff-tree), including renames + net-diff-empty case; refactored truthy parsing for testability.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2yw0","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T16:21:03.377702360Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-36w","title":"Config parity: .env loading + env var coverage","description":"## Objective\nMatch legacy configuration behavior, including `.env` loading and full env var coverage.\n\n## Scope\n- `.env` loading behavior (pythondecouple parity):\n  - if .env missing  empty repository fallback; env vars only.\n  - canonical env var set only if missing when alias present (LLM bridge).\n- Ensure all env vars from spec are supported:\n  - WORKTREES_ENABLED + GIT_IDENTITY_ENABLED gate\n  - ALLOW_ABSOLUTE_ATTACHMENT_PATHS\n  - TOOLS_LOG_ENABLED, LOG_RICH_ENABLED\n  - NOTIFICATIONS_* defaults\n  - HTTP_* (CORS/JWT/RBAC/rate limit)\n  - LLM_* defaults\n- CSV parsing for list settings (roles, tools, clusters).\n- Match default values exactly.\n\n## Tests\n- Unit tests for .env presence/absence handling.\n- Tabledriven env parsing tests for bools/ints/CSV lists.\n\n## Logging/Artifacts\n- Store parsed config snapshots under `tests/artifacts/config/<timestamp>/`.\n\n## Acceptance Criteria\n1. Rust config matches legacy defaults and parsing semantics.\n2. `.env` loading behavior matches pythondecouple (graceful missing file).\n3. All env variables from spec are supported and tested.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T16:18:09.094825172Z","created_by":"ubuntu","updated_at":"2026-02-05T18:02:50.832107234Z","closed_at":"2026-02-05T18:02:50.832088128Z","close_reason":"Implemented .env loading + env var coverage + tests; checks blocked by sqlmodel-sqlite duplicate defs","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-36w","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T16:18:12.895192349Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-3gs","title":"Share: sign manifest + encrypt bundle + deterministic ZIP","description":"## Objective\nImplement share pipeline Steps 1315: Ed25519 signing, age encryption, and deterministic ZIP packaging.\n\n## Scope\n- **sign_manifest**: sign manifest.json with Ed25519 seed; optionally output public key.\n- **encrypt_bundle**: age encryption when recipients provided; output `.age` file; retain clear bundle if required by legacy.\n- **package_directory_as_zip**: deterministic ZIP (stable ordering, timestamps, compression settings).\n\n## Tests\n- Unit tests for signature verification and age encrypt/decrypt.\n- Integration tests for deterministic ZIP hash.\n\n## Logging/Artifacts\n- Store signatures, public keys, and zip hashes under `tests/artifacts/share/crypto/<timestamp>/`.\n\n## Acceptance Criteria\n1. Manifest signatures validate correctly with provided public key.\n2. Encryption outputs readable bundles via `share decrypt`.\n3. ZIP packaging is deterministic (stable hash across runs).","status":"closed","priority":1,"issue_type":"task","assignee":"CopperOwl","created_at":"2026-02-05T16:16:36.383969609Z","created_by":"ubuntu","updated_at":"2026-02-06T06:53:02.811535263Z","closed_at":"2026-02-06T06:53:02.811510687Z","close_reason":"Verified sign/encrypt/zip implementation via mcp-agent-mail-share tests (age roundtrip + deterministic zip)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-3gs","depends_on_id":"br-1uf","type":"parent-child","created_at":"2026-02-05T16:16:41.980704900Z","created_by":"ubuntu","metadata":"{}","thread_id":""}],"comments":[{"id":4,"issue_id":"br-3gs","author":"CopperOwl","text":"Claimed br-3gs.\n\nPlan:\n- Audit existing share crypto + deterministic ZIP implementation in crates/mcp-agent-mail-share for legacy parity gaps.\n- Add/adjust tests (signature verify, age encrypt/decrypt, deterministic ZIP hash) and required tests/artifacts/share/crypto/<timestamp>/ artifacts.\n- Run gates (cargo fmt --check, cargo clippy --all-targets -- -D warnings, cargo test -p mcp-agent-mail-share) and close br-3gs.","created_at":"2026-02-06T03:38:29Z"}]}
{"id":"br-3h94","title":"Error type mapping parity (CAPABILITY_DENIED, NOT_FOUND, etc.)","description":"## Objective\nEnsure error type mapping and JSON error shapes match legacy across tools/resources.\n\n## Scope\n- Error codes list: `CAPABILITY_DENIED`, `NOT_FOUND`, `INVALID_ARGUMENT`, `TYPE_ERROR`, `MISSING_FIELD`, `DATABASE_POOL_EXHAUSTED`, `TIMEOUT`, `GIT_INDEX_LOCK`, `RESOURCE_EXHAUSTED`, `CONTACT_REQUIRED`, `CONTACT_BLOCKED`, `OS_ERROR`, `DATABASE_ERROR`, `RESOURCE_BUSY`, `PERMISSION_ERROR`, `CONNECTION_ERROR`, `UNHANDLED_EXCEPTION`.\n- Map internal errors to these codes consistently.\n- Ensure tool/resource responses include legacy error fields and HTTP error status where applicable.\n\n## Tests\n- Unit tests for error mapping table.\n- Conformance tests for representative error cases (missing fields, invalid args, capability denied, not found).\n\n## Logging/Artifacts\n- Store error responses under `tests/artifacts/errors/<timestamp>/`.\n\n## Acceptance Criteria\n1. All error codes and shapes match legacy.\n2. Conformance tests include error cases for each category.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T16:18:30.739623609Z","created_by":"ubuntu","updated_at":"2026-02-06T06:17:59.988606898Z","closed_at":"2026-02-06T06:17:59.988584837Z","close_reason":"completed","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-3h94","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T16:18:35.625592551Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-3hsb","title":"Conformance: Add static resource query-param fixtures","description":"Add conformance fixtures for static resources without path params that accept optional query params (legacy URI templates like resource://projects{?format}).\n\nScope:\n- Add fixture cases for:\n  - resource://config/environment?format=json\n  - resource://projects?format=json\n  - resource://tooling/directory?format=json\n  - resource://tooling/schemas?format=json\n  - resource://tooling/metrics?format=json\n  - resource://tooling/locks?format=json\n- Update the legacy Python fixture generator to avoid duplicating format=json when the URI already includes it.\n- Regenerate crates/mcp-agent-mail-conformance/tests/conformance/fixtures/python_reference.json and ensure cargo test -p mcp-agent-mail-conformance passes.","status":"closed","priority":1,"issue_type":"task","assignee":"MistyReef","created_at":"2026-02-07T01:23:20.203242500Z","created_by":"ubuntu","updated_at":"2026-02-07T01:50:46.303770304Z","closed_at":"2026-02-07T01:50:46.303745137Z","close_reason":"Completed conformance fixture parity and router/tool/resource alignment; cargo test -p mcp-agent-mail-conformance passes.","source_repo":".","compaction_level":0,"original_size":0}
{"id":"br-3ie","title":"MCP Agent Mail Rust: 100% feature parity + conformance + benchmarks","description":"Goal: complete the Rust port of legacy_python_mcp_agent_mail_code with 100% behavior/feature coverage, proven by fixture-based conformance tests + benchmarks (similar standard as rich_rust/beads_rust).\n\nNon-negotiables:\n- Prefer local crates over upstream ecosystem where applicable:\n  - MCP: /dp/fastmcp_rust\n  - SQLite: /dp/sqlmodel_rust\n  - IO/concurrency: /dp/asupersync (avoid tokio unless unavoidable)\n  - Console UI: /dp/frankentui\n  - Beads: /dp/beads_rust\n  - Agent detection: /dp/coding_agent_session_search\n- No destructive commands or file deletions without explicit permission.\n\nAcceptance criteria:\n-  passes\n-  passes\n- \nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 2 tests\ntest load_and_validate_fixture_schema ... ok\ntest run_fixtures_against_rust_server_router ... ok\n\ntest result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.08s\n\n\nrunning 7 tests\ntest config::tests::test_default_config ... ok\ntest error::tests::test_error_types ... ok\ntest config::tests::test_from_env ... ok\ntest error::tests::test_recoverable ... ok\ntest models::tests::test_invalid_agent_names ... ok\ntest models::tests::test_generate_agent_name ... ok\ntest models::tests::test_valid_agent_names ... ok\n\ntest result: ok. 7 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 8 tests\ntest pool::tests::test_sqlite_path_parsing ... ok\ntest timestamps::tests::test_iso_to_micros ... ok\ntest timestamps::tests::test_epoch_boundary ... ok\ntest timestamps::tests::test_negative_timestamps ... ok\ntest timestamps::tests::test_now_micros ... ok\ntest timestamps::tests::test_round_trip ... ok\ntest timestamps::tests::test_micros_to_iso ... ok\ntest pool::tests::test_schema_init_in_memory ... ok\n\ntest result: ok. 8 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 1 test\ntest crates/mcp-agent-mail-core/src/models.rs - models::is_valid_agent_name (line 318) ... ok\n\ntest result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\nall doctests ran in 0.18s; merged doctests compilation took 0.17s\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s passes\n- Conformance harness covers *all* MCP tools and resources, including error cases + nondeterministic field normalization.\n- Benchmarks include DB/tool hot paths + archive write throughput once storage layer is implemented.\n","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-02-05T05:04:26.956492167Z","created_by":"ubuntu","updated_at":"2026-02-05T05:05:57.078349046Z","closed_at":"2026-02-05T05:05:57.078301787Z","close_reason":"Superseded by br-2ei (correct prefix + clean description)","external_ref":"bd-179","source_repo":".","compaction_level":0,"original_size":0}
{"id":"br-3np","title":"CLI: share export/update parity (interactive + defaults)","description":"## Objective\nImplement `share export` and `share update` commands with legacy behavior (including `--interactive`).\n\n## Scope\n- Flags: `--output/-o`, `--interactive/-i`, `--project/-p` (repeat), thresholds, scrub preset, chunk settings, `--dry-run`, `--zip`, `--signing-key`, `--signing-public-out`, `--age-recipient` (repeat).\n- Defaults: inline=64KiB, detach=25MiB, chunk threshold=20MiB, chunk size=4MiB; scrub preset `standard`.\n- Validation: invalid preset exits 1; enforce chunk size >=1024; autoadjust detach threshold if <= inline.\n- `share export`:\n  - `--dry-run` creates temp output + prints summary only.\n  - `--interactive` wizard prompts and overrides flags.\n- `share update`:\n  - loads config from existing `manifest.json` and stored export config.\n  - default `--zip` is **false** (contrast export default true).\n\n## Tests\n- Unit tests for flag parsing + defaults.\n- Integration tests with temp bundle export/update; verify manifest config updates.\n- Golden output for `--dry-run` summary.\n\n## Logging/Artifacts\n- Store CLI outputs under `tests/artifacts/cli/share/<timestamp>/`.\n\n## Acceptance Criteria\n1. share export/update match legacy flags, defaults, and exit codes.\n2. interactive mode overrides flags and produces identical outputs to legacy.\n3. dry-run produces no bundle artifacts but prints expected summary.","status":"closed","priority":1,"issue_type":"task","assignee":"PearlOwl","created_at":"2026-02-05T16:16:51.526681473Z","created_by":"ubuntu","updated_at":"2026-02-06T18:02:13.427048743Z","closed_at":"2026-02-06T18:02:13.427025710Z","close_reason":"Implemented share export/update parity (interactive wizard + defaults + dry-run summary + update sync + signing/zip/age warnings) and verified via cargo test gates.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-3np","depends_on_id":"br-1uf","type":"blocks","created_at":"2026-02-05T16:17:33.896970708Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-3np","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T16:16:56.127446696Z","created_by":"ubuntu","metadata":"{}","thread_id":""}],"comments":[{"id":5,"issue_id":"br-3np","author":"PearlOwl","text":"Progress: implemented  wizard + real  summary; ensured export pipeline copies viewer assets; fixed export snapshot finalization to rebuild  when schema mismatched and to drop legacy FTS triggers so message updates dont fail. Manual dry-run against repo  now succeeds.","created_at":"2026-02-06T07:52:17Z"},{"id":6,"issue_id":"br-3np","author":"PearlOwl","text":"Progress details (no backticks): share export interactive wizard implemented; real dry-run prints summary without writing to output; export now copies viewer assets; share snapshot finalization rebuilds fts_messages when schema mismatched and drops legacy FTS triggers so later UPDATE messages operations do not fail. Manual dry-run against ./storage.sqlite3 succeeds.","created_at":"2026-02-06T07:52:34Z"}]}
{"id":"br-3op","title":"Share: bundle attachments (inline/detach/external/missing)","description":"## Objective\nImplement share pipeline Step 8: attachment bundling and classification.\n\n## Scope\n- Thresholds: inline <= 64KiB, detach >= 25MiB (defaults, override via CLI).\n- Classify attachments into inline (embed), detached (file), external (URL), missing.\n- Generate attachment manifest entries with hashes and metadata.\n- Honor `convert_images` and attachment embed policy.\n\n## Tests\n- Unit tests for threshold logic and classification.\n- Integration tests with sample attachments (inline, large, external, missing).\n\n## Logging/Artifacts\n- Store attachment manifests and hashes under `tests/artifacts/share/attachments/<timestamp>/`.\n\n## Acceptance Criteria\n1. Attachment classification matches legacy thresholds and rules.\n2. Manifests include correct hashes and metadata.\n3. Missing/external attachments are handled gracefully with clear markers.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T16:15:56.123691848Z","created_by":"ubuntu","updated_at":"2026-02-05T18:00:56.435100382Z","closed_at":"2026-02-05T18:00:56.435066689Z","close_reason":"Attachment bundling/classification already implemented in bundle.rs; bundle_* tests pass","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-3op","depends_on_id":"br-1uf","type":"parent-child","created_at":"2026-02-05T16:16:02.590128847Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-9jl","title":"CLI: share verify/decrypt parity (signature + age)","description":"## Objective\nImplement `share verify` and `share decrypt` with legacy semantics.\n\n## Scope\n- `share verify`:\n  - Validate SRI hashes and optional Ed25519 signature.\n  - `--public-key` uses provided base64 key; else use manifest signature.\n- `share decrypt`:\n  - `--output` defaults to filename sans `.age` (or `_decrypted`).\n  - `--identity` (age key file) is mutually exclusive with `--passphrase`.\n\n## Tests\n- Unit tests for signature verification and decrypt flag validation.\n- Integration tests decrypting a bundle produced by share export.\n\n## Logging/Artifacts\n- Store verification results under `tests/artifacts/cli/share_verify/<timestamp>/`.\n\n## Acceptance Criteria\n1. share verify/decrypt match legacy flags, defaults, and exit codes.\n2. Signature validation and age decrypt succeed on valid inputs and fail loudly on invalid.\n3. Mutualexclusion flag handling matches legacy.","status":"closed","priority":1,"issue_type":"task","assignee":"GreenDune","created_at":"2026-02-05T16:17:17.420980860Z","created_by":"ubuntu","updated_at":"2026-02-06T07:15:14.917640762Z","closed_at":"2026-02-06T07:15:14.917621787Z","close_reason":"Added CLI integration tests for share verify/decrypt parity; validated exit codes + defaults","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-9jl","depends_on_id":"br-1uf","type":"blocks","created_at":"2026-02-05T16:17:44.284948962Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-9jl","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T16:17:23.973796081Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-ave","title":"Share: sqlite snapshot + project scope","description":"## Objective\nImplement share pipeline Steps 12: `create_sqlite_snapshot` and `apply_project_scope` with exact legacy semantics.\n\n## Scope\n- **create_sqlite_snapshot**:\n  - Resolve destination path; create parent dirs.\n  - Error if destination exists (never overwrite).\n  - Open source DB; run `PRAGMA wal_checkpoint(PASSIVE)` when enabled.\n  - Use sqlite backup API to copy source  destination.\n- **apply_project_scope**:\n  - Load projects (id, slug, human_key); error if none.\n  - If identifiers empty  no deletions.\n  - Match identifiers caseinsensitive by slug or human_key; error on unknown.\n  - Delete order per spec (agent_links, sibling_suggestions, messages + recipients, file_reservations, agents, projects).\n\n## Tests\n- Unit tests for identifier matching + error cases.\n- Integration tests with temp DB and multiple projects; verify deletions and counts.\n\n## Logging/Artifacts\n- Save before/after row counts under `tests/artifacts/share/snapshot/<timestamp>/`.\n\n## Acceptance Criteria\n1. Snapshot creation refuses overwrite and produces byteidentical DB backup.\n2. Project scoping deletes only disallowed project data in the specified order.\n3. Tests are deterministic and isolated to temp DB paths.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T16:15:05.665286231Z","created_by":"ubuntu","updated_at":"2026-02-05T17:52:39.363640110Z","closed_at":"2026-02-05T17:52:39.363620834Z","close_reason":"Implemented backup snapshot + scope parity","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-ave","depends_on_id":"br-1uf","type":"parent-child","created_at":"2026-02-05T16:15:11.619634150Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-ekhi","title":"Bug: CLI acks/list-acks queries referenced nonexistent inbox table","status":"closed","priority":1,"issue_type":"bug","assignee":"DustyDeer","created_at":"2026-02-06T18:33:50.759265420Z","created_by":"ubuntu","updated_at":"2026-02-06T18:33:50.759265420Z","closed_at":"2026-02-06T18:33:50.759265420Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"br-hk3v","title":"Dev UX: am runner script + /api<->/mcp HTTP path alias","description":"## Problem\nRunning the local HTTP server currently requires multiple manual exports (bearer token from a separate envfile, HTTP_PATH override, LOG_RICH_ENABLED) and is error-prone. In this environment some clients expect /mcp/ while the server defaults to /api/.\n\n## Goals\n- One easy entrypoint: am serve starts the server with sane defaults and rich console enabled by default.\n- Auto-load HTTP_BEARER_TOKEN from a dev envfile (default: ~/mcp_agent_mail/.env) if not already set.\n- Support BOTH /api/ and /mcp/ for the MCP HTTP endpoint (alias each other so either client works).\n- Keep backward compatibility for existing E2E scripts that hardcode /api/.\n\n## Implementation\n1) Add scripts/am shell wrapper:\n- am serve (default) runs: cargo run -p mcp-agent-mail -- serve --host 127.0.0.1 --port 8765\n- Defaults: HTTP_PATH=/mcp/ and LOG_RICH_ENABLED=true\n- Options: --path mcp|api, --env-file <path>, --host, --port, --no-auth\n- If HTTP_BEARER_TOKEN is unset, attempt to read it from env file (strip quotes).\n\n2) Server: accept /api and /mcp as synonyms for the MCP base path:\n- If configured base is /api, also accept requests under /mcp by rewriting the request path to the configured base before passing to HttpRequestHandler (configured with base_path=config.http_path).\n- If configured base is /mcp, also accept /api similarly.\n- Do not change behavior for arbitrary nested bases (for example /api/mcp).\n\n3) Docs: update README.md with scripts/am usage and the /api + /mcp alias note.\n\n## Tests\n- Unit tests for the alias path logic (path_allowed + canonicalization).\n\n## Acceptance Criteria\n- scripts/am serve works without manual exports in a typical dev setup (token file present).\n- With default config (HTTP_PATH unset), both POST /api/ and POST /mcp/ reach the MCP handler.\n- Full quality gates pass: cargo fmt --check, cargo check --all-targets, cargo clippy --all-targets -- -D warnings, cargo test.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T01:31:23.230475657Z","created_by":"ubuntu","updated_at":"2026-02-07T01:50:46.201686047Z","closed_at":"2026-02-07T01:50:46.201652053Z","close_reason":"Completed: scripts/am added, /api<->/mcp aliasing wired + tests, README updated, quality gates green.","source_repo":".","compaction_level":0,"original_size":0}
{"id":"br-xy39","title":"HTTP CORS parity (dev defaults + allowlist)","description":"## Objective\nImplement CORS behavior parity for HTTP server.\n\n## Scope\n- Env vars: `HTTP_CORS_ENABLED`, `HTTP_CORS_ORIGINS`, `HTTP_CORS_ALLOW_CREDENTIALS`, `HTTP_CORS_ALLOW_METHODS`, `HTTP_CORS_ALLOW_HEADERS`.\n- Default: enabled in development, disabled in production (legacy behavior).\n- Allowlist handling: empty origins  `*`.\n\n## Tests\n- Integration tests for preflight OPTIONS and response headers.\n- E2E coverage in HTTP suite.\n\n## Logging/Artifacts\n- Capture CORS headers under `tests/artifacts/http/cors/<timestamp>/`.\n\n## Acceptance Criteria\n1. CORS headers match legacy defaults and configuration.\n2. Preflight responses are correct (status and headers).","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T16:19:01.692103864Z","created_by":"ubuntu","updated_at":"2026-02-05T16:20:28.309033007Z","closed_at":"2026-02-05T16:20:28.309016766Z","close_reason":"Duplicate of br-1bm.7 (CORS parity already tracked)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-xy39","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T16:19:06.449676690Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
