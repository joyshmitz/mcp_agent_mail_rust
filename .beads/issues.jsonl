{"id":"bd-179","title":"MCP Agent Mail Rust: 100% feature parity + conformance + benchmarks","description":"Goal: complete the Rust port of legacy_python_mcp_agent_mail_code with 100% behavior/feature coverage, proven by fixture-based conformance tests + benchmarks (similar standard as rich_rust/beads_rust).\n\nNon-negotiables:\n- Prefer local crates over upstream ecosystem where applicable:\n  - MCP: /dp/fastmcp_rust\n  - SQLite: /dp/sqlmodel_rust\n  - IO/concurrency: /dp/asupersync (avoid tokio unless unavoidable)\n  - Console UI: /dp/frankentui\n  - Beads: /dp/beads_rust\n  - Agent detection: /dp/coding_agent_session_search\n- No destructive commands or file deletions without explicit permission.\n\nAcceptance criteria:\n-  passes\n-  passes\n- \nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 2 tests\ntest load_and_validate_fixture_schema ... ok\ntest run_fixtures_against_rust_server_router ... ok\n\ntest result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.08s\n\n\nrunning 7 tests\ntest config::tests::test_default_config ... ok\ntest error::tests::test_error_types ... ok\ntest config::tests::test_from_env ... ok\ntest error::tests::test_recoverable ... ok\ntest models::tests::test_invalid_agent_names ... ok\ntest models::tests::test_generate_agent_name ... ok\ntest models::tests::test_valid_agent_names ... ok\n\ntest result: ok. 7 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 8 tests\ntest pool::tests::test_sqlite_path_parsing ... ok\ntest timestamps::tests::test_iso_to_micros ... ok\ntest timestamps::tests::test_epoch_boundary ... ok\ntest timestamps::tests::test_negative_timestamps ... ok\ntest timestamps::tests::test_now_micros ... ok\ntest timestamps::tests::test_round_trip ... ok\ntest timestamps::tests::test_micros_to_iso ... ok\ntest pool::tests::test_schema_init_in_memory ... ok\n\ntest result: ok. 8 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 1 test\ntest crates/mcp-agent-mail-core/src/models.rs - models::is_valid_agent_name (line 318) ... ok\n\ntest result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\nall doctests ran in 0.18s; merged doctests compilation took 0.17s\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s passes\n- Conformance harness covers *all* MCP tools and resources, including error cases + nondeterministic field normalization.\n- Benchmarks include DB/tool hot paths + archive write throughput once storage layer is implemented.\n","status":"tombstone","priority":0,"issue_type":"epic","created_at":"2026-02-05T05:04:26.956492167Z","created_by":"ubuntu","updated_at":"2026-02-05T05:38:40.435532507Z","closed_at":"2026-02-05T05:05:57.078301787Z","close_reason":"Superseded by br-2ei (correct prefix + clean description)","source_repo":".","deleted_at":"2026-02-05T05:38:40.435526636Z","deleted_by":"ubuntu","delete_reason":"bad prefix legacy epic; superseded by br-2ei","original_type":"epic","compaction_level":0,"original_size":0}
{"id":"br-1bm","title":"HTTP Server Parity: Legacy Python Exact Match","description":"## Objective\nPort the **HTTP server stack** to Rust with exact legacy Python behavior: auth, rate limiting, streamable HTTP transport, mail UI endpoints, logging, and background workers.\n\n## Scope\n- Middleware: bearer auth, JWT + RBAC, rate limiting.\n- Streamable HTTP MCP transport (stateless ASGI adapter behavior, header normalization, base path mounting).\n- Mail UI routes and static assets.\n- Request logging + OTEL no‑op parity.\n- Background workers (ack TTL, file reservation cleanup, tool metrics, retention/quota).\n- Health + well‑known endpoints.\n\n## Tests\n- Unit + integration tests per subsystem (JWT, rate limit, streamable HTTP, mail UI, logging, workers).\n- E2E HTTP suite (br-2ei.9.6) covering auth, CORS, streamable, and UI endpoints.\n\n## Logging/Artifacts\n- HTTP transcripts + diffs under `tests/artifacts/http/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":1,"issue_type":"epic","created_at":"2026-02-05T05:32:32.057076856Z","created_by":"ubuntu","updated_at":"2026-02-05T16:18:23.375074348Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:48:14.330942304Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm","depends_on_id":"br-36w","type":"blocks","created_at":"2026-02-05T16:18:23.374551664Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.1","title":"JWT Auth Parity (HS256 + JWKS + role claim)","description":"Objective:\nImplement JWT authentication exactly as in legacy Python (mcp_agent_mail/http.py). This includes HS256 HMAC and JWKS verification paths, audience/issuer validation, role extraction, and error semantics. Must be 1:1 on outputs and failure modes.\n\nLegacy Reference Behavior (must match):\n- If JWT enabled and Authorization missing or not Bearer: 401 {\"detail\":\"Unauthorized\"}\n- Decode token using:\n  - If JWKS URL set: fetch JWKS, select key by header.kid, verify\n  - Else if secret set: verify with HMAC secret\n  - Algorithms from HTTP_JWT_ALGORITHMS (default HS256)\n- Validate audience/issuer if configured; otherwise ignore\n- On any failure: 401 {\"detail\":\"Unauthorized\"}\n- Extract roles from claim HTTP_JWT_ROLE_CLAIM (default \"role\")\n  - String -> singleton set\n  - List/tuple -> set of strings\n  - Else -> empty\n- If roles empty, use HTTP_RBAC_DEFAULT_ROLE\n- Store claims for rate limit identity (sub) and any downstream uses\n\nImplementation Considerations:\n- JWKS fetch must be async-safe via asupersync HTTP client (no tokio)\n- Cache JWKS by URL with TTL to avoid per-request latency\n- Must not change external response schema or status codes\n- Log auth failures at debug/trace (no extra HTTP output)\n\nTests and E2E (with detailed logging):\nUnit tests:\n- Missing Authorization header -> 401\n- Non-Bearer Authorization -> 401\n- HS256 valid/invalid signatures\n- JWKS valid/invalid (kid missing, bad signature)\n- Audience/issuer mismatch -> 401\n- Role claim variants (string, list, missing)\nIntegration tests:\n- Start server with HTTP_JWT_* env vars; make requests with valid/invalid JWT\n- Verify RBAC path uses roles correctly\nE2E:\n- Covered by `br-1bm.1.5` (uses shared harness `br-2ei.9.1`).\n\nNotes:\n- Localhost bypass logic is owned by `br-1bm.3` + `br-1bm.8`; JWT must still match legacy in the non-bypass path.\n\n## Acceptance Criteria\n- JWT behavior matches legacy for all vectors extracted in `br-1bm.1.1`.\n- Role extraction matches Python behavior across all supported claim shapes.\n- `br-1bm.1.5` unit+integration+E2E suite passes and produces high-signal artifacts on failure.","status":"in_progress","priority":1,"issue_type":"task","assignee":"CopperBarn","created_at":"2026-02-05T05:32:46.671284098Z","created_by":"ubuntu","updated_at":"2026-02-06T01:18:24.295578853Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.1","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.1.1","title":"JWT Parity: extract legacy behavior + test vectors","description":"Purpose:\nExtract exact legacy JWT behavior and define concrete test vectors so Rust matches Python 1:1.\n\nLegacy Implementation Notes (from http.py):\n- Header parse: token.split(\".\",1)[0]; base64url decode with padding; JSON parse. Any error -> None.\n- If jwks_url set:\n  - httpx.AsyncClient(timeout=5) GET jwks_url -> .json()\n  - JsonWebKey.import_key_set(jwks)\n  - kid = header.get(\"kid\"); key = find_by_kid(kid) if present else key_set.keys[0]\n- Else if secret set:\n  - JsonWebKey.import_key(secret, {\"kty\":\"oct\"})\n- If key None -> Unauthorized.\n- jwt.decode(token, key) using algs from HTTP_JWT_ALGORITHMS (default [\"HS256\"]). Any error -> Unauthorized.\n- If audience configured: claims.validate_aud(audience)\n- If issuer configured: if str(claims.get(\"iss\") or \"\") != issuer -> Unauthorized (no fallback)\n- claims.validate() (handles exp/nbf/iat if present)\n- Returns dict(claims) on success.\n\nConcrete Test Vectors (must implement):\n1) Missing Authorization header -> 401 {\"detail\":\"Unauthorized\"}\n2) Authorization not Bearer -> 401\n3) Header parse fail (malformed base64 / non-JSON header) -> 401\n4) JWKS path:\n   - jwks_url set, kid present, matching key -> success\n   - jwks_url set, kid present, no matching key -> 401\n   - jwks_url set, kid missing -> uses first key in key_set\n   - jwks fetch fails / invalid JSON -> 401\n5) Secret path:\n   - jwt_secret set, HS256 valid -> success\n   - jwt_secret set, signature invalid -> 401\n6) Algorithms:\n   - alg not in HTTP_JWT_ALGORITHMS -> 401\n7) Audience:\n   - jwt_audience set, token aud matches -> success\n   - jwt_audience set, token aud mismatch -> 401\n8) Issuer:\n   - jwt_issuer set, token iss matches exactly -> success\n   - jwt_issuer set, token iss missing or different -> 401\n9) Claims validate:\n   - exp in past -> 401\n   - nbf in future -> 401\n   - exp/nbf absent -> ok\n10) Role claim:\n   - role claim string -> roles={string}\n   - role claim list -> roles={strings}\n   - role claim missing/invalid -> roles empty -> default role applied downstream\n\nDeliverable:\n- A markdown or JSON matrix of inputs -> expected HTTP status/body and roles extracted.\n- Must be explicit enough that Rust tests can be derived directly.\n\nDependencies: none (spec extraction only).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:37:09.570324403Z","created_by":"ubuntu","updated_at":"2026-02-05T07:37:27.060998320Z","closed_at":"2026-02-05T07:37:27.060980056Z","close_reason":"Extracted legacy JWT behavior + explicit test vectors in bead description","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.1.1","depends_on_id":"br-1bm.1","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.1.2","title":"JWT Parity: JWKS fetch (kid selection, legacy no-cache)","description":"## Objective\nImplement legacy JWKS handling for JWT verification (no implicit caching).\n\n## Scope\n- Fetch JWKS from `HTTP_JWT_JWKS_URL` on demand.\n- Parse with authlib-compatible JWK set.\n- If token header has `kid`, select matching key; otherwise use first key.\n- If fetch or parsing fails, treat token as unauthorized.\n\n## Tests\n- Unit tests with fixture JWKS (kid match, no kid, missing kid).\n- Integration test with mocked JWKS HTTP endpoint.\n\n## Logging/Artifacts\n- Log structured error when JWKS fetch fails (but return Unauthorized).\n- Store JWKS test transcripts under `tests/artifacts/http/jwt/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:37:13.638466525Z","created_by":"ubuntu","updated_at":"2026-02-05T16:11:01.266321868Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.1.2","depends_on_id":"br-1bm.1","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.1.2","depends_on_id":"br-1bm.1.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.1.3","title":"JWT Parity: HS256 HMAC validation","description":"## Objective\nImplement HS256 JWT validation parity using shared secret.\n\n## Scope\n- Accept `HTTP_JWT_SECRET` for HMAC key.\n- Decode token, validate signature, `aud` (optional), `iss` (optional), and exp/nbf.\n- If validation fails, return 401 Unauthorized.\n\n## Tests\n- Unit tests for valid/invalid signatures, exp/nbf, aud/iss mismatches.\n- Integration tests for Authorization header with Bearer token.\n\n## Logging/Artifacts\n- Store decoded claims (redacted) in test artifacts under `tests/artifacts/http/jwt/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:37:17.486504145Z","created_by":"ubuntu","updated_at":"2026-02-05T16:11:09.105320306Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.1.3","depends_on_id":"br-1bm.1","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.1.3","depends_on_id":"br-1bm.1.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.1.4","title":"JWT Parity: claim validation + RBAC role extraction","description":"## Objective\nJWT claim validation and RBAC role extraction parity.\n\n## Scope\n- Extract roles from claim `HTTP_JWT_ROLE_CLAIM` (string or list).\n- If no roles, use `HTTP_RBAC_DEFAULT_ROLE`.\n- RBAC enforcement:\n  - readers can access resources; writers required for most tools\n  - `HTTP_RBAC_READONLY_TOOLS` accessible by readers\n  - unknown tool name → require writer\n- Localhost bypass when `HTTP_ALLOW_LOCALHOST_UNAUTHENTICATED` enabled and no forwarded headers.\n\n## Tests\n- Unit tests for role extraction (string, list, missing).\n- Integration tests for RBAC allow/deny outcomes on tools/resources.\n\n## Logging/Artifacts\n- Store RBAC decision traces under `tests/artifacts/http/rbac/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:37:21.209581347Z","created_by":"ubuntu","updated_at":"2026-02-05T16:11:15.241482505Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.1.4","depends_on_id":"br-1bm.1","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.1.4","depends_on_id":"br-1bm.1.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.1.4","depends_on_id":"br-1bm.1.3","type":"blocks","created_at":"2026-02-05T05:37:39.080720838Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.1.5","title":"JWT Parity: unit + integration + E2E tests","description":"Build comprehensive JWT parity tests with detailed logging + artifacts.\n\nTest layers:\n- Unit tests:\n  - parsing/validation failures\n  - HS256 success/failure\n  - JWKS success/failure\n  - audience/issuer mismatch\n  - role claim parsing\n- Integration tests:\n  - spin up server with env config\n  - hit representative HTTP endpoints\n- E2E script:\n  - scripted curl/httpx cases\n  - log expected vs actual status/body\n  - store artifacts under `tests/artifacts/jwt/<timestamp>/`\n\n## Acceptance Criteria\n- Vector coverage:\n  - All vectors defined in `br-1bm.1.1` are exercised.\n- Deterministic logs:\n  - E2E output includes a per-case diff on mismatch (expected vs actual JSON).\n  - Artifacts include server logs + client transcripts.\n- Exit behavior:\n  - Script exits non-zero on first mismatch.\n- No secret leakage:\n  - Logs do not print shared secrets or private keys.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:37:26.048333340Z","created_by":"ubuntu","updated_at":"2026-02-05T06:33:20.587563217Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.1.5","depends_on_id":"br-1bm.1","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.1.5","depends_on_id":"br-1bm.1.4","type":"blocks","created_at":"2026-02-05T05:37:41.877811316Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.1.5","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:55.883829187Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.10","title":"HTTP Background Workers Parity: ack TTL + escalation + metrics emit + cleanup","description":"## Objective\nImplement HTTP background workers with exact legacy behavior (startup gating, loop intervals, best‑effort error handling).\n\n## Scope\n- Workers: file reservation cleanup, ACK TTL scan + escalation, tool metrics emit, retention/quota report.\n- Startup: spawn only when at least one enable flag is true; store tasks for shutdown cancellation.\n- All worker loops wrapped in try/except; never crash server.\n\n## Tests\n- Unit tests for enable/disable gating.\n- Integration tests for each worker behavior in isolation.\n\n## Logging/Artifacts\n- Capture worker logs under `tests/artifacts/http/workers/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":1,"issue_type":"epic","created_at":"2026-02-05T07:32:28.058041886Z","created_by":"ubuntu","updated_at":"2026-02-05T16:13:13.328016910Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.10","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T07:32:28.058041886Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.10.1","title":"Workers Spec: extract legacy ack TTL + escalation + metrics/cleanup worker semantics","description":"Extract exact legacy Python HTTP background worker behavior into a self-contained spec.\n\nLegacy sources:\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/http.py`:\n  - _startup task creation conditions\n  - _worker_ack_ttl (query + logging + escalation)\n  - _worker_tool_metrics (snapshot + log)\n  - _worker_cleanup (expire stale reservations)\n  - _worker_retention_quota (best-effort reporting)\n- Config defaults in `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/config.py`\n- Tests:\n  - `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_http_workers_and_options.py` (ACK TTL)\n\nMust capture verbatim:\n- Worker enable flags + defaults:\n  - FILE_RESERVATIONS_CLEANUP_ENABLED / INTERVAL\n  - ACK_TTL_ENABLED / ACK_TTL_SECONDS / ACK_TTL_SCAN_INTERVAL_SECONDS\n  - ACK_ESCALATION_* (enabled/mode/claim_ttl/exclusive/holder_name)\n  - TOOL_METRICS_EMIT_ENABLED / INTERVAL\n  - RETENTION_REPORT_ENABLED / INTERVAL + RETENTION_MAX_AGE_DAYS + ignore patterns\n  - QUOTA_ENABLED + quota thresholds (even if best-effort)\n- ACK TTL worker semantics:\n  - SQL query that selects overdue ack-required messages\n  - timezone normalization behavior for SQLite timestamps\n  - rich panel vs plain fallback logging\n  - escalation mode `file_reservation`:\n    - path_pattern format (inbox path for created_ts YYYY/MM)\n    - holder agent resolution/auto-create behavior\n    - DB insert shape + archive artifact write shape\n- Tool metrics emit:\n  - snapshot shape and sorting rules\n- Cleanup worker:\n  - how stale file reservations are found and expired\n\nDeliverables:\n- Add a “HTTP Background Workers” section to `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md`.\n\n## Acceptance Criteria\n- Spec is complete enough to implement without re-reading Python.\n- Spec includes the exact SQL statements and path_pattern format.\n- Spec includes failure handling expectations (never crash server).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:32:42.715316596Z","created_by":"ubuntu","updated_at":"2026-02-05T07:58:32.321908509Z","closed_at":"2026-02-05T07:58:32.321887118Z","close_reason":"Added HTTP Background Workers spec (ack TTL, escalation, metrics emit, cleanup, retention/quota) to EXISTING_MCP_AGENT_MAIL_STRUCTURE.md","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.10.1","depends_on_id":"br-1bm.10","type":"parent-child","created_at":"2026-02-05T07:32:42.715316596Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.10.2","title":"Workers Impl: ACK TTL scan + escalation (log + file_reservation)","description":"## Objective\nImplement ACK TTL scanning + escalation parity.\n\n## Scope (from spec)\n- Interval: `ACK_TTL_SCAN_INTERVAL_SECONDS` (default 60s).\n- Query unacknowledged `ack_required` messages; compute age vs `ACK_TTL_SECONDS`.\n- Log overdue via rich panel and structlog; fallback plain print.\n- Escalation mode `file_reservation`:\n  - Resolve recipient name; optional holder override `ACK_ESCALATION_CLAIM_HOLDER_NAME`.\n  - Auto-create holder agent if missing; write `profile.json` to archive.\n  - Create file reservation for inbox path pattern `agents/{name}/inbox/{YYYY}/{MM}/*.md`.\n  - Write archive artifact.\n- Best‑effort: suppress exceptions; never fail server.\n\n## Tests\n- Unit tests for age calculation + threshold.\n- Integration test for file reservation escalation path.\n\n## Logging/Artifacts\n- Store escalation artifacts under `tests/artifacts/http/ack_ttl/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T07:32:55.972684006Z","created_by":"ubuntu","updated_at":"2026-02-05T16:13:20.178152153Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.10.2","depends_on_id":"br-1bm.10","type":"parent-child","created_at":"2026-02-05T07:32:55.972684006Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.10.2","depends_on_id":"br-1bm.10.1","type":"blocks","created_at":"2026-02-05T07:33:43.795538585Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.10.3","title":"Workers Impl: tool metrics emit loop (tool_metrics_snapshot logging)","description":"## Objective\nEmit periodic tool metrics snapshots from background worker.\n\n## Scope\n- Interval: `max(5, TOOL_METRICS_EMIT_INTERVAL_SECONDS)`.\n- Snapshot of `TOOL_METRICS` dict sorted by tool name.\n- Each entry includes `name`, `calls`, `errors`, `cluster`, `capabilities`, `complexity`.\n- Log via structlog logger `tool.metrics` with event `tool_metrics_snapshot`.\n\n## Tests\n- Unit tests for snapshot structure and ordering.\n- Integration test with a few tool invocations, then worker emits expected log payload.\n\n## Logging/Artifacts\n- Save emitted snapshots under `tests/artifacts/http/metrics/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T07:33:03.809583907Z","created_by":"ubuntu","updated_at":"2026-02-05T16:13:26.114183543Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.10.3","depends_on_id":"br-1bm.10","type":"parent-child","created_at":"2026-02-05T07:33:03.809583907Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.10.3","depends_on_id":"br-1bm.10.1","type":"blocks","created_at":"2026-02-05T07:33:43.981645329Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.10.4","title":"Workers Impl: file reservations cleanup (expire stale)","description":"## Objective\nBackground worker for file reservation cleanup (expired + stale) parity.\n\n## Scope\n- Interval: `FILE_RESERVATIONS_CLEANUP_INTERVAL_SECONDS`.\n- Phase 1: release expired (`expires_ts < now`).\n- Phase 2: release stale by inactivity heuristics (agent activity, mail activity, git commits, expiry proximity).\n- Write archive artifacts for released reservations.\n- Log via rich panel + structlog `file_reservations_cleanup`.\n\n## Tests\n- Unit tests for stale detection heuristics.\n- Integration tests releasing expired and stale reservations.\n\n## Logging/Artifacts\n- Store cleanup reports under `tests/artifacts/http/file_reservations/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T07:33:10.639336897Z","created_by":"ubuntu","updated_at":"2026-02-05T16:13:31.726160042Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.10.4","depends_on_id":"br-1bm.10","type":"parent-child","created_at":"2026-02-05T07:33:10.639336897Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.10.4","depends_on_id":"br-1bm.10.1","type":"blocks","created_at":"2026-02-05T07:33:44.068109290Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.10.5","title":"Workers Impl: retention/quota report loop (best-effort)","description":"## Objective\nRetention/quota reporting worker parity (best‑effort).\n\n## Scope\n- Enabled when `RETENTION_REPORT_ENABLED` or `QUOTA_ENABLED` is true.\n- Interval: `max(60, RETENTION_REPORT_INTERVAL_SECONDS)`.\n- Walk storage_root, compute old messages, inbox counts, attachment bytes per project.\n- Ignore patterns from `RETENTION_IGNORE_PROJECT_PATTERNS`.\n- Log summary via structlog `maintenance` logger.\n- Emit quota warnings when limits exceeded (`QUOTA_ATTACHMENTS_LIMIT_BYTES`, `QUOTA_INBOX_LIMIT_COUNT`).\n\n## Tests\n- Integration tests with temp storage_root and fake projects.\n- Unit tests for ignore patterns and limit detection.\n\n## Logging/Artifacts\n- Store report JSON under `tests/artifacts/http/retention/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-05T07:33:18.880305805Z","created_by":"ubuntu","updated_at":"2026-02-05T16:13:41.489159486Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.10.5","depends_on_id":"br-1bm.10","type":"parent-child","created_at":"2026-02-05T07:33:18.880305805Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.10.5","depends_on_id":"br-1bm.10.1","type":"blocks","created_at":"2026-02-05T07:33:44.158130884Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.10.6","title":"Workers Tests: ACK TTL + metrics emit + cleanup + retention","description":"## Objective\nComprehensive tests for all background workers (ack TTL, metrics emit, cleanup, retention/quota).\n\n## Scope\n- Unit tests for each worker’s core logic and gating flags.\n- Integration tests running worker loops with deterministic intervals (short sleep) and temp DB/storage.\n- E2E validation via HTTP suite (br-2ei.9.6) where possible.\n\n## Logging/Artifacts\n- Store worker logs and diffs under `tests/artifacts/http/workers/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T07:33:32.489216204Z","created_by":"ubuntu","updated_at":"2026-02-05T16:13:47.582441924Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.10.6","depends_on_id":"br-1bm.10","type":"parent-child","created_at":"2026-02-05T07:33:32.489216204Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.10.6","depends_on_id":"br-1bm.10.2","type":"blocks","created_at":"2026-02-05T07:33:44.244450112Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.10.6","depends_on_id":"br-1bm.10.3","type":"blocks","created_at":"2026-02-05T14:06:38.045327096Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.10.6","depends_on_id":"br-1bm.10.4","type":"blocks","created_at":"2026-02-05T14:06:38.145684595Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.10.6","depends_on_id":"br-1bm.10.5","type":"blocks","created_at":"2026-02-05T14:06:38.232870379Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.2","title":"Redis Rate Limiting Parity (token bucket)","description":"Objective:\nImplement Redis-backed token-bucket rate limiting exactly as legacy Python when HTTP_RATE_LIMIT_BACKEND=redis and HTTP_RATE_LIMIT_ENABLED=true. Must match key format, Lua script semantics, TTL, and fallback behavior.\n\nLegacy Reference Behavior:\n- Enabled when settings.http.rate_limit_enabled.\n- Key format: \"rl:{kind}:{endpoint}:{identity}\".\n- Identity uses request.client.host unless JWT claims sub present (then use \"sub:{sub}\").\n- Lua token bucket (HMGET/HMSET, EXPIRE with ceil(burst/max(rate,0.001))).\n- Burst defaults to max(1, rpm) when configured burst is 0.\n- On Redis failure, fallback to in-memory bucket.\n- HTTP response payloads identical (429 + {\"detail\":\"Rate limit exceeded\"}).\n\nImplementation Considerations:\n- Use asupersync Redis client (no tokio, no external redis crate).\n- Ensure monotonic time source for token math.\n- Memory buckets cleanup identical to Python (evict after 1h idle).\n\nTests and E2E (with detailed logging):\n- Vector/spec extraction: `br-1bm.2.1`\n- Implementation: `br-1bm.2.2`..`br-1bm.2.4`\n- Tests: `br-1bm.2.5` (uses shared harness `br-2ei.9.1`)\n\n## Acceptance Criteria\n- Redis backend decisions match Python for identical sequences (vectors from `br-1bm.2.1`).\n- Fallback-to-memory path is correct and observable via logs (without changing HTTP outputs).\n- `br-1bm.2.5` unit+integration+E2E suite passes with high-signal artifacts on failure.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:32:59.767161877Z","created_by":"ubuntu","updated_at":"2026-02-05T06:39:21.410846691Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.2","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2","depends_on_id":"br-1bm.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2","depends_on_id":"br-1bm.3","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.2.1","title":"Rate Limit Parity: extract legacy Lua + vectors","description":"Purpose:\nExtract exact legacy Redis token-bucket behavior and test vectors for parity.\n\nLegacy Lua Script (verbatim):\nlocal key = KEYS[1]\nlocal now = tonumber(ARGV[1])\nlocal rate = tonumber(ARGV[2])\nlocal burst = tonumber(ARGV[3])\nlocal state = redis.call('HMGET', key, 'tokens', 'ts')\nlocal tokens = tonumber(state[1]) or burst\nlocal ts = tonumber(state[2]) or now\nlocal delta = now - ts\ntokens = math.min(burst, tokens + delta * rate)\nlocal allowed = 0\nif tokens >= 1 then\n  tokens = tokens - 1\n  allowed = 1\nend\nredis.call('HMSET', key, 'tokens', tokens, 'ts', now)\nredis.call('EXPIRE', key, math.ceil(burst / math.max(rate, 0.001)))\nreturn allowed\n\nCall pattern:\n- EVAL lua 1 \"rl:{key}\" now rate_per_sec burst\n- allowed = bool(int(result or 0) == 1)\n\nIn-memory fallback:\n- tokens, ts = buckets.get(key, (burst, now))\n- elapsed = max(0, now - ts)\n- tokens = min(burst, tokens + elapsed * rate)\n- if tokens < 1 -> deny, else tokens -= 1 -> allow\n- cleanup buckets idle > 3600s\n\nTest Vectors (examples to codify):\n1) per_minute<=0 -> allow always (no Redis call)\n2) burst default = max(1, rpm) when configured burst == 0\n3) First request at t0 with tokens missing -> tokens=burst -> allow, new tokens=burst-1\n4) Subsequent request before 1/rate sec -> deny if tokens <1\n5) After sufficient elapsed, tokens replenished to min(burst, tokens + elapsed*rate)\n6) Redis failure (exception) -> fallback to memory bucket and still enforce limits\n7) TTL calculation: EXPIRE = ceil(burst / max(rate, 0.001))\n\nDeliverable:\n- Matrix of (rpm, burst, time sequence, expected allow/deny, expected TTL)\n- Explicit Redis key format: \"rl:{kind}:{endpoint}:{identity}\"","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:38:01.226828600Z","created_by":"ubuntu","updated_at":"2026-02-05T07:38:06.586289822Z","closed_at":"2026-02-05T07:38:06.586222836Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.2.1","depends_on_id":"br-1bm.2","type":"parent-child","created_at":"2026-02-05T05:38:01.226828600Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.2.2","title":"Rate Limit Parity: Redis Lua implementation","description":"## Objective\nImplement Redis token-bucket rate limiting parity using Lua script.\n\n## Scope\n- Lua script matches legacy:\n  - HMGET tokens/ts\n  - tokens refill by `delta * rate`\n  - consume 1 token if available\n  - HMSET tokens/ts and EXPIRE by `ceil(burst / max(rate, 0.001))`\n- Per‑endpoint key format: `rl:{kind}:{endpoint}:{identity}`.\n- Fallback to in‑memory on Redis errors.\n\n## Tests\n- Unit tests for Lua script behavior (via embedded Redis or mocked eval).\n- Integration test with Redis backend enabled; verify allow/deny at limits.\n\n## Logging/Artifacts\n- Store rate limit traces under `tests/artifacts/http/rate_limit/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:38:06.336149143Z","created_by":"ubuntu","updated_at":"2026-02-05T16:11:24.253881829Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.2.2","depends_on_id":"br-1bm.2","type":"parent-child","created_at":"2026-02-05T05:38:06.336149143Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2.2","depends_on_id":"br-1bm.2.1","type":"blocks","created_at":"2026-02-05T05:38:25.448726996Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.2.3","title":"Rate Limit Parity: identity derivation (host/sub)","description":"## Objective\nImplement legacy identity derivation for rate limiting keys.\n\n## Scope\n- Default identity: `request.client.host` (or `ip-unknown`).\n- If JWT claims present, prefer `sub` for stability (`identity = \"sub:<sub>\"`).\n- Endpoint key: tool name if tools call, `*` otherwise.\n- Key format: `{kind}:{endpoint}:{identity}` where kind ∈ {tools,resources,other}.\n\n## Tests\n- Unit tests for key derivation with/without JWT claims.\n- Integration tests ensure per‑tool rate limit separation.\n\n## Logging/Artifacts\n- Store derived keys under `tests/artifacts/http/rate_limit/<timestamp>/` on mismatch.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:38:11.555148799Z","created_by":"ubuntu","updated_at":"2026-02-05T16:11:31.854652267Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.2.3","depends_on_id":"br-1bm.1","type":"blocks","created_at":"2026-02-05T05:38:28.472191315Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2.3","depends_on_id":"br-1bm.2","type":"parent-child","created_at":"2026-02-05T05:38:11.555148799Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2.3","depends_on_id":"br-1bm.3","type":"blocks","created_at":"2026-02-05T05:38:31.440415087Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.2.4","title":"Rate Limit Parity: memory fallback + cleanup","description":"## Objective\nImplement in‑memory token bucket fallback + cleanup parity.\n\n## Scope\n- Token bucket: refill by `elapsed * rate_per_sec`, cap at burst.\n- Deny when tokens < 1; decrement when allowed.\n- Cleanup: every 60s, evict buckets not touched in last hour.\n- If Redis backend fails, fall back to memory without failing requests.\n\n## Tests\n- Unit tests for token refill/consume math and cleanup eviction.\n- Integration test: Redis failure path uses memory.\n\n## Logging/Artifacts\n- Store bucket state traces under `tests/artifacts/http/rate_limit/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:38:15.478842333Z","created_by":"ubuntu","updated_at":"2026-02-05T16:11:37.567207531Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.2.4","depends_on_id":"br-1bm.2","type":"parent-child","created_at":"2026-02-05T05:38:15.478842333Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2.4","depends_on_id":"br-1bm.2.1","type":"blocks","created_at":"2026-02-05T05:38:36.248864408Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.2.5","title":"Rate Limit Parity: unit + integration + E2E tests","description":"Comprehensive tests for rate limiting parity, with detailed logging + artifacts.\n\nTest layers:\n- Unit tests:\n  - key format\n  - burst/rate defaults\n  - deterministic token math\n  - TTL calculation\n  - in-memory cleanup\n  - identity derivation fuzz vectors (table-driven):\n    - sub present vs missing\n    - host present vs missing\n    - IPv4 / IPv6 / IPv4-mapped IPv6\n    - localhost vs non-localhost\n    - forwarded headers present/absent\n    - malformed inputs (empty, whitespace, invalid IP)\n    - expected stable key formatting\n- Integration tests:\n  - Redis-backed allow/deny sequences using vectors from `br-1bm.2.1`\n  - fallback path when Redis is unavailable\n  - identity derivation integration: request matrix verifying key selection and limiter behavior\n- E2E script:\n  - run request bursts against HTTP server\n  - log expected vs actual allow/deny decisions\n  - capture Redis state snapshots (best effort)\n  - store artifacts under `tests/artifacts/rate_limit/<timestamp>/`\n  - include identity fuzz matrix and per-case decision traces\n\n## Acceptance Criteria\n- Unit tests validate both Redis and fallback implementations against the same vector suite.\n- Identity derivation fuzz vectors cover IPv4/IPv6/localhost/forwarded header cases with explicit expected keys.\n- Integration tests are deterministic (fixed timestamps/time mocking as needed).\n- E2E script:\n  - prints per-request decision trace\n  - writes a summary JSON (pass/fail + diffs)\n  - exits non-zero on mismatch\n- Failures include enough context to debug (identity, key, tokens, ttl).","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:38:19.738397651Z","created_by":"ubuntu","updated_at":"2026-02-05T14:15:08.627434683Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.2.5","depends_on_id":"br-1bm.2","type":"parent-child","created_at":"2026-02-05T05:38:19.738397651Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2.5","depends_on_id":"br-1bm.2.2","type":"blocks","created_at":"2026-02-05T05:38:39.208248679Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2.5","depends_on_id":"br-1bm.2.3","type":"blocks","created_at":"2026-02-05T05:38:44.191099431Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2.5","depends_on_id":"br-1bm.2.4","type":"blocks","created_at":"2026-02-05T05:38:47.255125276Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.2.5","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:55.976511422Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.3","title":"Client Peer Address + Localhost Bypass Parity","description":"Objective:\nAccurately detect client host/peer address for localhost bypass, RBAC, and rate limiting identity. Must match legacy Python logic, including IPv4-mapped IPv6 handling and forwarded-header safeguards.\n\nLegacy Reference Behavior:\n- Determine client_host from request.client.host\n- If forwarded headers present (x-forwarded-for/proto/host or forwarded), treat as non-local\n- Localhost if client_host in {\"127.0.0.1\",\"::1\",\"localhost\"} or IPv4-mapped ::ffff:127.0.0.1\n- When localhost allowed and bearer token set, auto-inject Authorization in base path passthrough\n\nImplementation Plan:\n1. Integrate peer_addr from asupersync Http1Request (blocked on upstream `br-2ei.6.3`).\n2. Add helper to normalize peer_addr to client_host string (supports IPv4-mapped IPv6).\n3. Update allow_local_unauthenticated checks to use peer_addr + forwarded headers.\n4. Use client_host for rate-limit identity when JWT sub absent.\n\nTests and E2E (with detailed logging):\n- Unit tests for address parsing + forwarded header behavior.\n- Integration tests with simulated Http1Request peer_addr.\n- E2E coverage via `br-1bm.3.4` (uses shared harness `br-2ei.9.1`).\n\n## Acceptance Criteria\n- Localhost bypass behavior matches legacy Python for all address forms and forwarded-header cases.\n- Rate-limit identity uses peer_addr-derived host when JWT sub is missing.\n- `br-1bm.3.4` unit+integration+E2E suite passes and produces high-signal artifacts on failure.","status":"in_progress","priority":1,"issue_type":"task","assignee":"ubuntu","created_at":"2026-02-05T05:33:10.708760957Z","created_by":"ubuntu","updated_at":"2026-02-05T08:38:52.923665836Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.3","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}],"comments":[{"id":2,"issue_id":"br-1bm.3","author":"Dicklesworthstone","text":"Integrated peer_addr (asupersync), localhost helper + rate-limit identity, and added unit/integration tests. E2E still pending in br-1bm.3.4 (blocked by br-2ei.9.1).","created_at":"2026-02-05T08:38:52Z"}]}
{"id":"br-1bm.3.1","title":"Peer Addr Parity: integrate asupersync Http1Request.peer_addr","description":"Integrate `peer_addr` from `asupersync::Http1Request` into server logic.\n\nThis task is blocked on upstream asupersync work tracked as `br-2ei.6.3`.\n\nWork:\n- Once `Http1Request.peer_addr` is available, plumb it through the HTTP server request handling.\n- Expose a helper to derive a stable `client_host` string from peer_addr (legacy-equivalent formatting).\n- Ensure forwarded headers do not override peer_addr.\n\n## Acceptance Criteria\n- Server has access to peer_addr for each request and uses it consistently for:\n  - localhost bypass decisions\n  - rate-limit identity (when JWT sub absent)\n- `client_host` formatting matches legacy for:\n  - IPv4\n  - IPv6\n  - IPv4-mapped IPv6\n- Tests:\n  - Unit tests validate formatting and “forwarded headers do not override peer_addr”.\n  - Integration tests validate peer_addr is populated in the request path (using simulated Http1Request / test harness).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:39:05.220643258Z","created_by":"ubuntu","updated_at":"2026-02-05T08:38:05.917468187Z","closed_at":"2026-02-05T08:38:05.917450805Z","close_reason":"Integrated peer_addr from asupersync and wired into server logic","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.3.1","depends_on_id":"br-1bm.3","type":"parent-child","created_at":"2026-02-05T05:39:05.220643258Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.3.1","depends_on_id":"br-2ei.6.3","type":"blocks","created_at":"2026-02-05T06:08:07.059047396Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.3.2","title":"Peer Addr Parity: localhost detection helper","description":"Implement localhost detection helper for peer_addr-based bypass logic.\n\nRequirements:\n- Handle IPv4, IPv6, and IPv4-mapped IPv6 localhost forms.\n- Treat forwarded headers as disqualifying for localhost bypass (no spoofing).\n- Use this helper consistently in bearer auth, RBAC decisions, and any other localhost-only paths.\n\n## Acceptance Criteria\n- Correct detection:\n  - `127.0.0.1`, `::1`, and IPv4-mapped `::ffff:127.0.0.1` are treated as localhost.\n  - Non-localhost private IPs are *not* treated as localhost.\n- Forwarded headers:\n  - Presence of `X-Forwarded-For`/`Forwarded` (per legacy) disables localhost bypass.\n- Tests:\n  - Unit tests cover all address forms and forwarded-header cases.\n  - Integration test verifies bypass behavior is controlled exclusively by peer_addr + forwarded headers (not client-provided host headers).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:39:09.028452900Z","created_by":"ubuntu","updated_at":"2026-02-05T08:38:09.584845027Z","closed_at":"2026-02-05T08:38:09.584827845Z","close_reason":"Added peer_addr localhost helper + forwarded header safeguards + tests","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.3.2","depends_on_id":"br-1bm.3","type":"parent-child","created_at":"2026-02-05T05:39:09.028452900Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.3.2","depends_on_id":"br-1bm.3.1","type":"blocks","created_at":"2026-02-05T05:39:26.736664544Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.3.3","title":"Peer Addr Parity: rate-limit identity plumbing","description":"Implement rate-limit identity plumbing for peer_addr-derived host.\n\nRule:\n- Use JWT `sub` as the default rate-limit identity when present.\n- Otherwise, use `client_host` derived from peer_addr.\n- Identity string must match legacy formatting and be used consistently for rate limiter key creation.\n\n## Acceptance Criteria\n- Identity derivation matches legacy precedence and formatting.\n- Forwarded headers do not affect identity (peer_addr only).\n- Tests:\n  - Unit tests cover precedence (JWT sub vs peer_addr) and formatting.\n  - Integration test asserts Redis key prefix + identity combine exactly as legacy expects.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:39:12.867654737Z","created_by":"ubuntu","updated_at":"2026-02-05T08:38:13.146794229Z","closed_at":"2026-02-05T08:38:13.146772948Z","close_reason":"Rate-limit identity now uses peer_addr; helper covers JWT sub precedence","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.3.3","depends_on_id":"br-1bm.3","type":"parent-child","created_at":"2026-02-05T05:39:12.867654737Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.3.3","depends_on_id":"br-1bm.3.1","type":"blocks","created_at":"2026-02-05T05:39:30.103821388Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.3.4","title":"Peer Addr Parity: unit + integration + E2E tests","description":"Add comprehensive tests for peer_addr + localhost bypass logic, with detailed logging + artifacts.\n\nTest layers:\n- Unit tests:\n  - host parsing/formatting\n  - localhost detection (IPv4/IPv6/mapped)\n  - forwarded-header disqualification\n- Integration tests:\n  - simulate Http1Request peer_addr values through server request path\n  - validate identity derivation used by rate limiter\n- E2E script:\n  - start server\n  - send requests with/without Authorization\n  - include forwarded header cases\n  - log expected vs actual outcomes and store artifacts under `tests/artifacts/peer_addr/<timestamp>/`\n\n## Acceptance Criteria\n- Unit tests cover all address forms + forwarded-header cases.\n- Integration tests prove peer_addr is used and forwarded headers cannot spoof it.\n- E2E script writes:\n  - HTTP transcripts\n  - server logs\n  - summary JSON (pass/fail + diffs)\n- Failures provide actionable diffs (which header/value differed).","status":"closed","priority":1,"issue_type":"task","assignee":"RusticOtter","created_at":"2026-02-05T05:39:17.375993949Z","created_by":"ubuntu","updated_at":"2026-02-06T00:11:53.064799444Z","closed_at":"2026-02-06T00:11:53.064773245Z","close_reason":"Added peer_addr E2E suite + fixed asupersync HTTP/1 flush so responses are sent","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.3.4","depends_on_id":"br-1bm.3","type":"parent-child","created_at":"2026-02-05T05:39:17.375993949Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.3.4","depends_on_id":"br-1bm.3.2","type":"blocks","created_at":"2026-02-05T05:39:34.102447983Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.3.4","depends_on_id":"br-1bm.3.3","type":"blocks","created_at":"2026-02-05T05:39:37.109851077Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.3.4","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:56.060674456Z","created_by":"ubuntu","metadata":"{}","thread_id":""}],"comments":[{"id":1,"issue_id":"br-1bm.3.4","author":"Dicklesworthstone","text":"Added unit/integration tests in mcp-agent-mail-server (peer_addr localhost + forwarded header + rate-limit identity). E2E script still blocked on br-2ei.9.1 harness.","created_at":"2026-02-05T08:38:33Z"}]}
{"id":"br-1bm.4","title":"Stateless Streamable HTTP MCP Parity","description":"Objective:\nReproduce legacy Python stateless Streamable HTTP behavior for MCP requests, including header normalization, base path mount semantics, passthrough route, and localhost Authorization injection. Must be wire-compatible for existing MCP clients.\n\nLegacy Reference Behavior:\n- Per-request StreamableHTTPServerTransport, stateless=True\n- Accept header forced to \"application/json, text/event-stream\"\n- Content-Type added for POST if missing\n- Base path mounted at both /base and /base/ (no redirect)\n- Direct POST handler at base path that forwards to mounted app\n- If localhost + allow_localhost_unauthenticated + bearer token set, inject Authorization if missing\n- Responses passed through without extra wrapping\n\nImplementation Considerations:\n- Use fastmcp_rust transport primitives (no tokio)\n- Preserve request/response JSON-RPC payloads exactly\n- Avoid breaking SSE/streaming semantics\n\nTests and E2E (with detailed logging):\n- Spec + fixtures: `br-1bm.4.1`\n- Implementation: `br-1bm.4.2`..`br-1bm.4.5`\n- Tests: `br-1bm.4.6` (uses shared harness `br-2ei.9.1`)\n\nDependencies:\n- peer address parity (`br-1bm.3`) for localhost detection.\n\n## Acceptance Criteria\n- Wire behavior matches legacy Python for all fixture cases from `br-1bm.4.1`.\n- Streaming responses remain incremental (not buffered) and have correct headers.\n- `br-1bm.4.6` unit+integration+E2E suite passes with high-signal artifacts on failure.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:33:19.242331091Z","created_by":"ubuntu","updated_at":"2026-02-05T06:39:44.206098931Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.4","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4","depends_on_id":"br-1bm.3","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.4.1","title":"Streamable HTTP Parity: extract legacy behaviors + fixtures","description":"Purpose:\nExtract exact legacy HTTP streamable behaviors and define fixture cases for parity.\n\nLegacy Behavior (from http.py):\n- Mount base:\n  - mount_base = settings.http.path or \"/api\"\n  - if not startswith(\"/\"): prefix \"/\"\n  - base_no_slash = mount_base.rstrip(\"/\") or \"/\"\n  - base_with_slash = base_no_slash if \"/\" else base_no_slash + \"/\"\n  - fastapi_app.mount(base_no_slash, stateless_app)\n  - fastapi_app.mount(base_with_slash, stateless_app)\n- Direct POST handler at base_no_slash:\n  - Forwards to stateless_app with path=base_with_slash\n  - Collects response status/headers/body by intercepting send()\n  - Parses body as JSON (empty => {})\n- Header normalization:\n  - Remove any existing Accept headers\n  - Add Accept: \"application/json, text/event-stream\"\n  - If POST and Content-Type missing, add Content-Type: \"application/json\"\n- Localhost Authorization injection in passthrough:\n  - If allow_localhost_unauthenticated and client_host in {127.0.0.1, ::1, localhost} and no Authorization header, inject Bearer token when configured\n\nFixture Cases (minimum):\n1) Request to /api and /api/ both route to stateless app (no redirect)\n2) POST /api with missing Accept -> Accept forced to \"application/json, text/event-stream\"\n3) POST /api with existing Accept -> replaced (single header) with forced value\n4) POST /api missing Content-Type -> set to application/json\n5) POST /api with Content-Type present -> preserved\n6) Direct POST handler returns exact status/body from stateless app\n7) Localhost injection adds Authorization when missing (only if allow_localhost_unauthenticated + bearer token)\n8) Forwarded headers present -> no localhost injection\n\nDeliverable:\n- Written fixture table (inputs -> expected headers + status + body)\n- Use as baseline for br-1bm.4.* implementation/tests","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:39:51.705065959Z","created_by":"ubuntu","updated_at":"2026-02-05T07:38:24.514040016Z","closed_at":"2026-02-05T07:38:24.513965806Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.4.1","depends_on_id":"br-1bm.4","type":"parent-child","created_at":"2026-02-05T05:39:51.705065959Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.4.2","title":"Streamable HTTP Parity: header normalization","description":"## Objective\nNormalize headers for streamable HTTP requests to match legacy FastAPI adapter behavior.\n\n## Scope\n- Ensure `Accept: application/json, text/event-stream` is present (replace any existing Accept).\n- Ensure `Content-Type: application/json` is present for POST when missing.\n- Preserve other headers unmodified.\n\n## Tests\n- Unit tests for header normalization logic.\n- Integration tests via HTTP client lacking Accept header (httpx default).\n\n## Logging/Artifacts\n- Capture request/response headers under `tests/artifacts/http/streamable/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:39:57.051364879Z","created_by":"ubuntu","updated_at":"2026-02-05T16:11:49.109975991Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.4.2","depends_on_id":"br-1bm.4","type":"parent-child","created_at":"2026-02-05T05:39:57.051364879Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.2","depends_on_id":"br-1bm.4.1","type":"blocks","created_at":"2026-02-05T05:40:24.386470843Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.4.3","title":"Streamable HTTP Parity: base path mount + passthrough","description":"## Objective\nMount streamable HTTP transport at base path with passthrough semantics.\n\n## Scope\n- Mount stateless ASGI app at both `base_no_slash` and `base_with_slash`.\n- Ensure requests under base path are handled by streamable transport without extra wrappers.\n- For unmatched paths, return 404 JSON.\n\n## Tests\n- Integration tests for both `/api` and `/api/` base paths.\n- Verify requests are routed to MCP transport and non-base paths return 404.\n\n## Logging/Artifacts\n- Store routing traces under `tests/artifacts/http/streamable/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:40:00.975157750Z","created_by":"ubuntu","updated_at":"2026-02-05T16:12:01.963349311Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.4.3","depends_on_id":"br-1bm.4","type":"parent-child","created_at":"2026-02-05T05:40:00.975157750Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.3","depends_on_id":"br-1bm.4.1","type":"blocks","created_at":"2026-02-05T05:40:27.257455205Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.4.4","title":"Streamable HTTP Parity: localhost auth injection","description":"## Objective\nLocalhost auth bypass behavior parity for streamable HTTP.\n\n## Scope\n- When `HTTP_ALLOW_LOCALHOST_UNAUTHENTICATED=true`, allow localhost requests **without Authorization**, unless forwarded headers are present.\n- Supported localhost checks: `127.0.0.1`, `::1`, `localhost`, IPv4‑mapped IPv6 (`::ffff:127.0.0.1`).\n- If forwarded headers exist, do **not** bypass.\n\n## Tests\n- Unit tests for localhost detection + forwarded header suppression.\n- Integration tests for localhost requests with/without Authorization.\n\n## Logging/Artifacts\n- Capture auth decisions under `tests/artifacts/http/auth/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:40:05.682494755Z","created_by":"ubuntu","updated_at":"2026-02-05T16:12:08.299610988Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.4.4","depends_on_id":"br-1bm.3","type":"blocks","created_at":"2026-02-05T05:40:38.923281128Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.4","depends_on_id":"br-1bm.4","type":"parent-child","created_at":"2026-02-05T05:40:05.682494755Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.4","depends_on_id":"br-1bm.4.1","type":"blocks","created_at":"2026-02-05T05:40:35.525843824Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.4.5","title":"Streamable HTTP Parity: stateless transport pass-through","description":"## Objective\nImplement stateless StreamableHTTP transport pass‑through with no response wrapping.\n\n## Scope\n- Per‑request `StreamableHTTPServerTransport` with `stateless=true` and `json_response` enabled.\n- Run MCP server with `create_initialization_options()` and no session ID.\n- Pass MCP responses through as-is; no JSON unwrap/rewrap.\n- Suppress noisy streamable HTTP logs (set to WARNING).\n\n## Tests\n- Integration tests for JSON-RPC request/response roundtrip.\n- Ensure SSE responses work for streaming paths.\n\n## Logging/Artifacts\n- Save request/response transcripts under `tests/artifacts/http/streamable/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:40:10.252618982Z","created_by":"ubuntu","updated_at":"2026-02-05T16:12:19.808693231Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.4.5","depends_on_id":"br-1bm.4","type":"parent-child","created_at":"2026-02-05T05:40:10.252618982Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.5","depends_on_id":"br-1bm.4.1","type":"blocks","created_at":"2026-02-05T05:40:32.362475538Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.4.6","title":"Streamable HTTP Parity: unit + integration + E2E tests","description":"Comprehensive tests for streamable HTTP parity, with detailed logging + artifacts.\n\nTest layers:\n- Unit tests:\n  - header normalization\n  - base path normalization\n  - Authorization injection logic\n- Integration tests:\n  - `/api` and `/api/` parity\n  - passthrough correctness (status/headers/body)\n- E2E script:\n  - cover missing headers\n  - cover localhost auth injection\n  - cover streaming response sanity\n  - log expected vs actual results and store artifacts under `tests/artifacts/http_streamable/<timestamp>/`\n\n## Acceptance Criteria\n- Tests are driven by fixtures/spec from `br-1bm.4.1` where possible.\n- E2E script captures:\n  - full HTTP transcript (request + response)\n  - server logs\n  - a summary JSON with pass/fail + diffs\n- Streaming test asserts incremental delivery (multiple chunks observed).\n- Tests run reliably on dev machine with clear diagnostics on failure.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:40:16.185638720Z","created_by":"ubuntu","updated_at":"2026-02-05T06:31:34.994170229Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.4.6","depends_on_id":"br-1bm.4","type":"parent-child","created_at":"2026-02-05T05:40:16.185638720Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.6","depends_on_id":"br-1bm.4.2","type":"blocks","created_at":"2026-02-05T05:40:43.603009717Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.6","depends_on_id":"br-1bm.4.3","type":"blocks","created_at":"2026-02-05T05:40:47.563411188Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.6","depends_on_id":"br-1bm.4.4","type":"blocks","created_at":"2026-02-05T05:40:51.243017744Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.6","depends_on_id":"br-1bm.4.5","type":"blocks","created_at":"2026-02-05T05:40:56.025356571Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.4.6","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:56.145694434Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.5","title":"Mail SSR UI Parity (/mail/*)","description":"Objective:\nImplement the legacy Python SSR Mail UI endpoints under `/mail/*` with identical behavior and output expectations. This includes templates, markdown rendering, sanitization, and static assets. Must be safe and stable for human overseer usage.\n\nLegacy Reference Behavior:\n- `/mail` and `/mail/*` routes render HTML using Jinja templates\n- Markdown rendering via markdown2; sanitization via bleach + optional CSS sanitizer\n- Supports inbox list, thread view, compose, human overseer actions\n- Static assets served from legacy web/ and templates/ directories\n\nImplementation Considerations:\n- Preserve HTML structure and CSS class names to keep UI stable.\n- Sanitization allowlist must match legacy (or be stricter only if it doesn’t break expected markup).\n- Cache headers should match legacy defaults for static assets.\n\nTests and E2E (with detailed logging):\n- Inventory/spec: `br-1bm.5.1`\n- Implementation: `br-1bm.5.2`..`br-1bm.5.4`\n- Tests: `br-1bm.5.5` (uses shared harness `br-2ei.9.1`)\n\n## Acceptance Criteria\n- `/mail` routes and rendered HTML structure match legacy for representative fixtures.\n- Sanitization prevents XSS while preserving expected formatting.\n- Static assets are served with correct content-type + caching headers.\n- `br-1bm.5.5` unit+integration+E2E suite passes with high-signal artifacts on failure.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:33:28.128698742Z","created_by":"ubuntu","updated_at":"2026-02-05T06:39:53.193330679Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.5","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.5.1","title":"Mail UI Parity: inventory routes/templates/assets","description":"Purpose:\nInventory all legacy /mail UI routes, templates, and static assets to define the exact UI surface for the Rust port.\n\nLegacy Route Map (from http.py):\n- GET  /mail/api/locks (JSON)\n- GET  /mail (HTML)\n- GET  /mail/api/unified-inbox (JSON)\n- GET  /mail/projects (HTML)\n- GET  /mail/{project} (HTML)\n- POST /mail/api/projects/{project_id}/siblings/{other_id} (JSON)\n- GET  /mail/unified-inbox (HTML)\n- GET  /mail/{project}/inbox/{agent} (HTML)\n- GET  /mail/{project}/message/{mid} (HTML)\n- POST /mail/{project}/inbox/{agent}/mark-read (form)\n- POST /mail/{project}/inbox/{agent}/mark-all-read (form)\n- GET  /mail/{project}/thread/{thread_id} (HTML)\n- GET  /mail/{project}/search (HTML)\n- GET  /mail/{project}/file_reservations (HTML)\n- GET  /mail/{project}/attachments (HTML)\n- GET  /mail/{project}/overseer/compose (HTML)\n- POST /mail/{project}/overseer/send (form)\n- GET  /mail/archive/guide (HTML)\n- GET  /mail/archive/activity (HTML)\n- GET  /mail/archive/commit/{sha} (HTML)\n- GET  /mail/archive/timeline (HTML)\n- GET  /mail/archive/browser (HTML)\n- GET  /mail/archive/browser/{project}/file (HTML)\n- GET  /mail/archive/network (HTML)\n- GET  /mail/api/projects/{project}/agents (JSON)\n- GET  /mail/archive/time-travel (HTML)\n- GET  /mail/archive/time-travel/snapshot (HTML)\n\nTemplates & Assets:\n- templates root: mcp_agent_mail/templates (Jinja2)\n- sanitizer: bleach + optional CSSSanitizer (allowed tags/attrs list in http.py)\n- static SPA: /web directory (if exists) mounted at \"/\" via StaticFiles\n- CSS/JS asset paths referenced in templates (must be preserved)\n\nAdditional Notes:\n- UI is optional: failure to load templates should not crash server\n- /web SPA fallback uses index.html for non-API 404s\n\nDeliverable:\n- Template list (filenames)\n- Asset manifest (CSS/JS/images) with paths\n- Route-to-template mapping","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:41:11.443448819Z","created_by":"ubuntu","updated_at":"2026-02-05T07:39:20.258580675Z","closed_at":"2026-02-05T07:39:20.258519770Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.5.1","depends_on_id":"br-1bm.5","type":"parent-child","created_at":"2026-02-05T05:41:11.443448819Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.5.2","title":"Mail UI Parity: markdown rendering + sanitization","description":"## Objective\nParity for markdown rendering + sanitization in mail UI and share viewer.\n\n## Scope\n- Server‑side markdown render for message bodies using markdown2 extras (fenced code, tables, strike, lists).\n- HTML sanitization with bleach (CSS sanitizer enabled; safe images/links only).\n- Client‑side rendering fallbacks via marked.js + DOMPurify for UI previews.\n\n## Tests\n- Unit tests for markdown → HTML conversion and sanitizer allowlist.\n- Integration tests rendering sample messages with code blocks, tables, links, images, and unsafe HTML.\n\n## Logging/Artifacts\n- Store rendered HTML snapshots under `tests/artifacts/ui/markdown/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:41:15.456034900Z","created_by":"ubuntu","updated_at":"2026-02-05T16:12:53.426853917Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.5.2","depends_on_id":"br-1bm.5","type":"parent-child","created_at":"2026-02-05T05:41:15.456034900Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.5.2","depends_on_id":"br-1bm.5.1","type":"blocks","created_at":"2026-02-05T05:41:34.643924817Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.5.3","title":"Mail UI Parity: template rendering + data binding","description":"## Objective\nParity for mail UI template rendering and data binding.\n\n## Scope\n- Render Jinja templates: `mail_index`, `mail_project`, `mail_inbox`, `mail_thread`, `mail_message`, `mail_attachments`, `mail_claims`, `mail_file_reservations`, `mail_unified_inbox`, `mail_search`.\n- Archive templates: `archive_browser`, `archive_timeline`, `archive_network`, `archive_activity`, `archive_commit`, `archive_guide`, `archive_time_travel`.\n- Overseer compose UI: `overseer_compose` with markdown preview.\n- Error template for missing project/agent/message.\n\n## Tests\n- Integration tests that render each template with fixture data and assert key fields present.\n- Snapshot tests for critical pages (index, project, inbox, message, archive views).\n\n## Logging/Artifacts\n- Save rendered HTML snapshots under `tests/artifacts/ui/templates/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:41:19.188774583Z","created_by":"ubuntu","updated_at":"2026-02-05T16:13:00.652953231Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.5.3","depends_on_id":"br-1bm.5","type":"parent-child","created_at":"2026-02-05T05:41:19.188774583Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.5.3","depends_on_id":"br-1bm.5.1","type":"blocks","created_at":"2026-02-05T05:41:37.975640120Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.5.4","title":"Mail UI Parity: static assets + caching","description":"## Objective\nServe static mail UI assets with legacy behavior and caching semantics.\n\n## Scope\n- Serve `viewer_assets/` (index.html, viewer.js, styles.css, vendor assets, service worker).\n- Serve optional SPA `web/` directory when present, with fallback to index.html on 404 (non‑API paths).\n- Ensure static files are mounted at root and do not conflict with API base path.\n\n## Tests\n- Integration tests for static asset serving and SPA fallback routing.\n- Verify correct content types and presence of assets.\n\n## Logging/Artifacts\n- Store asset response headers under `tests/artifacts/ui/static/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:41:24.807396589Z","created_by":"ubuntu","updated_at":"2026-02-05T16:13:07.371217836Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.5.4","depends_on_id":"br-1bm.5","type":"parent-child","created_at":"2026-02-05T05:41:24.807396589Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.5.4","depends_on_id":"br-1bm.5.1","type":"blocks","created_at":"2026-02-05T05:41:42.251144821Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.5.5","title":"Mail UI Parity: unit + integration + E2E tests","description":"Comprehensive tests for Mail UI parity, with detailed logging + artifacts.\n\nTest layers:\n- Unit tests:\n  - markdown rendering + sanitization (golden inputs)\n  - explicit XSS regression suite (script tags, event handlers, inline JS URLs, SVG payloads)\n  - normalization rules documented (what is stripped/escaped)\n- Integration tests:\n  - template rendering snapshot tests (normalized where required)\n  - static asset fetch tests (content-type + caching headers)\n  - snapshot coverage for data binding edge cases (empty inbox, many messages, long subject/body, unicode)\n- E2E script:\n  - launch HTTP server\n  - fetch `/mail` routes\n  - validate DOM markers / key strings for each page\n  - capture HTML responses + server logs\n  - store artifacts under `tests/artifacts/mail_ui/<timestamp>/`\n  - include explicit XSS probe payloads and assert they are neutralized in rendered HTML\n\n## Acceptance Criteria\n- Snapshot tests cover at least: inbox empty, inbox with messages, thread view, compose page, search results.\n- Sanitization tests include explicit malicious payload fixtures and assert neutralization (no executable content).\n- E2E script:\n  - logs expected vs actual for each route\n  - writes a summary JSON (pass/fail + diffs)\n  - exits non-zero on mismatch\n- Running tests does not require external services (except optional DB fixtures); all fixtures are local.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:41:30.070251234Z","created_by":"ubuntu","updated_at":"2026-02-05T14:14:43.371934389Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.5.5","depends_on_id":"br-1bm.5","type":"parent-child","created_at":"2026-02-05T05:41:30.070251234Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.5.5","depends_on_id":"br-1bm.5.2","type":"blocks","created_at":"2026-02-05T05:41:47.673854697Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.5.5","depends_on_id":"br-1bm.5.3","type":"blocks","created_at":"2026-02-05T05:41:50.835253684Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.5.5","depends_on_id":"br-1bm.5.4","type":"blocks","created_at":"2026-02-05T05:41:55.016360728Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.5.5","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:56.231317288Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.6","title":"HTTP Request Logging + OTEL Parity","description":"Objective:\nImplement HTTP request logging exactly as legacy Python. OTEL settings exist in config but legacy does not instrument HTTP; parity is a no-op for OTEL flags.\n\nLegacy Reference Behavior:\n- When HTTP_REQUEST_LOG_ENABLED, emit structlog + rich panel output (fallback to plain text if rich unavailable).\n- Logging must not interfere with responses or error handling.\n- OTEL flags are parsed but do not initialize instrumentation in legacy.\n\nImplementation Considerations:\n- Use frankentui for rich output while matching legacy formatting/colors.\n- Ensure log output is disabled when not configured (no noise).\n- Do not change stdout/stderr behavior expected by MCP clients.\n\nTests and E2E (with detailed logging):\n- Spec extraction: br-1bm.6.1\n- Implementation: br-1bm.6.2 + br-1bm.6.3\n- Tests: br-1bm.6.4 (uses shared harness br-2ei.9.1)\n\n## Acceptance Criteria\n- Logging output matches spec extracted in br-1bm.6.1 (fields + ordering).\n- OTEL flags remain a no-op (no crash, no spans).\n- br-1bm.6.4 unit+integration+E2E suite passes with high-signal artifacts on failure.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:42:07.451798461Z","created_by":"ubuntu","updated_at":"2026-02-05T07:52:18.423928437Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.6","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:42:07.451798461Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.6.1","title":"HTTP Logging Parity: extract legacy behavior","description":"Extracted legacy HTTP logging behavior (mcp_agent_mail/src/mcp_agent_mail/http.py + config.py + tests):\n\nLegacy sources:\n- http.py: _configure_logging(), ExpectedErrorFilter, RequestLoggingMiddleware\n- config.py: LOG_JSON_ENABLED, LOG_RICH_ENABLED, LOG_LEVEL, LOG_INCLUDE_TRACE defaults\n- tests: test_expected_error_filter.py, test_logging_and_redis_fallback.py::test_log_json_enabled_path,\n  test_server.py::test_rich_logger_does_not_throw\n\nExact behavior to port:\n\n1) _configure_logging(settings) (idempotent, global _LOGGING_CONFIGURED)\n- structlog processors in order:\n  - structlog.contextvars.merge_contextvars\n  - structlog.processors.TimeStamper(fmt=\"iso\")\n  - structlog.processors.add_log_level\n  - then:\n    - if settings.log_json_enabled: structlog.processors.JSONRenderer()\n    - else: structlog.processors.KeyValueRenderer(key_order=[\"event\",\"path\",\"status\"])\n- structlog.configure wrapper_class: make_filtering_bound_logger(level=settings.log_level.upper() else INFO)\n- logging.basicConfig(level=settings.log_level.upper() else INFO)\n- Suppress noisy loggers:\n  - mcp.server.streamable_http -> WARNING\n  - mcp.server.lowlevel.server -> WARNING\n  - aiosqlite -> INFO\n  - git.util -> INFO\n  - git.cmd -> INFO\n  - filelock -> INFO\n  - sse_starlette.sse -> INFO\n\n2) ExpectedErrorFilter (applied ONLY to logger \"fastmcp.tools.tool_manager\")\n- Filters only when record.exc_info is present.\n- Patterns (case-insensitive substring):\n  - \"not found in project\"\n  - \"index.lock\"\n  - \"git_index_lock\"\n  - \"resource_busy\"\n  - \"temporarily locked\"\n  - \"recoverable=true\"\n  - \"use register_agent\"\n  - \"available agents:\"\n- Also treats exceptions with attribute recoverable=True as expected.\n- Also inspects __cause__ chain for patterns or recoverable=True.\n- If expected:\n  - record.exc_info = None; record.exc_text = None (traceback suppressed)\n  - if level >= ERROR: downgrade to INFO + levelname=\"INFO\"\n\n3) RequestLoggingMiddleware (enabled only when HTTP_REQUEST_LOG_ENABLED true)\n- Measures latency with time.time(); duration_ms = int((time.time()-start)*1000)\n- Fields:\n  - method = request.method\n  - path = request.url.path\n  - status = response.status_code\n  - client_ip = request.client.host if request.client else \"-\"\n- Structlog emission:\n  - structlog.get_logger(\"http\").info(\"request\", method=..., path=..., status=..., duration_ms=..., client_ip=...)\n- Rich output attempt (unconditional, not gated by LOG_RICH_ENABLED):\n  - Console(width=100)\n  - title = Text.assemble(\n      (method, \"bold blue\"), \"  \", (path, \"bold white\"), \"  \",\n      (status_code, \"bold green\" if 200<=status<400 else \"bold red\"), \"  \",\n      (f\"{dur_ms}ms\", \"bold yellow\"),\n    )\n  - body = Text.assemble((\"client: \", \"cyan\"), (client, \"white\"))\n  - Panel(body, title=title, border_style=\"dim\")\n- Fallback on any exception:\n  - print(\"http method={method} path={path} status={status} ms={dur_ms} client={client}\")\n\n4) LOG_RICH_ENABLED / LOG_INCLUDE_TRACE\n- LOG_RICH_ENABLED is used in llm.py cost logging (rich panel vs structlog); not consulted by HTTP request logging.\n- LOG_INCLUDE_TRACE exists in settings and tests (test_rich_logger_does_not_throw) but has no behavioral effect in HTTP logging.\n\n5) LOG_JSON_ENABLED\n- Only selects structlog JSONRenderer vs KeyValueRenderer; request logging emits via structlog and inherits renderer.\n- Legacy test only asserts LOG_JSON_ENABLED path does not crash on app build.\n\nDeliverables for implementers/tests:\n- Golden log examples (sanitized):\n  - 2xx / 4xx / 5xx requests (structlog + rich panel + fallback string)\n  - ExpectedErrorFilter case (traceback suppressed + level downgraded to INFO)\n- Explicit note: request logging uses request.client.host (not X-Forwarded-For), and duration is int ms.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:42:18.137231805Z","created_by":"ubuntu","updated_at":"2026-02-05T07:52:58.789104620Z","closed_at":"2026-02-05T07:52:58.789086847Z","close_reason":"Legacy HTTP logging behavior extracted and documented in bead description","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.6.1","depends_on_id":"br-1bm.6","type":"parent-child","created_at":"2026-02-05T05:42:18.137231805Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.6.2","title":"HTTP Logging Parity: request logging middleware","description":"Implement HTTP logging + ExpectedErrorFilter in Rust to match legacy behavior documented in br-1bm.6.1.\n\nKey parity requirements (from legacy):\n- Request logging is enabled ONLY by HTTP_REQUEST_LOG_ENABLED.\n- LOG_JSON_ENABLED selects structlog JSONRenderer vs KeyValueRenderer; request logs inherit this renderer.\n- LOG_RICH_ENABLED does NOT gate HTTP request logging (legacy always attempts rich output).\n- LOG_INCLUDE_TRACE has no effect on HTTP logging (exists only in config/tests).\n\nImplementation notes:\n- Mirror _configure_logging() idempotent setup and logger suppression.\n- ExpectedErrorFilter must behave exactly (pattern list + recoverable flag + cause chain); apply only to logger \"fastmcp.tools.tool_manager\".\n- Request logging uses request.client.host (no forwarded-header trust) and duration_ms = int(ms).\n- Rich output should mirror legacy layout; if rich not available, emit the exact fallback string.\n- Prefer frankentui for the rich/TTY rendering, but keep formatting/ordering/color semantics identical to legacy.\n\n## Acceptance Criteria\n- Output parity:\n  - Snapshot tests for structlog JSONRenderer branch and KeyValueRenderer branch.\n  - Rich panel layout matches legacy (method/path/status/duration/client, colors, width=100).\n  - Plain-text fallback line matches legacy format exactly.\n- Correctness:\n  - Logged fields are derived exactly (method, path, status, duration_ms, client_ip).\n  - ExpectedErrorFilter suppresses tracebacks and downgrades to INFO for expected/recoverable errors.\n- Performance:\n  - Near-zero overhead when HTTP_REQUEST_LOG_ENABLED is false.\n- Tests:\n  - Unit tests for ExpectedErrorFilter classifier and formatter.\n  - Integration tests validate logs emitted/absent without changing HTTP responses.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:42:22.022319697Z","created_by":"ubuntu","updated_at":"2026-02-05T07:47:30.488330616Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.6.2","depends_on_id":"br-1bm.6","type":"parent-child","created_at":"2026-02-05T05:42:22.022319697Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.6.2","depends_on_id":"br-1bm.6.1","type":"blocks","created_at":"2026-02-05T05:42:34.829012504Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.6.3","title":"HTTP Logging Parity: OTEL config no-op","description":"## Objective\nEnsure OTEL config variables are accepted but behave as no‑op (legacy parity).\n\n## Scope\n- Env vars: `HTTP_OTEL_ENABLED`, `OTEL_SERVICE_NAME`, `OTEL_EXPORTER_OTLP_ENDPOINT`.\n- When enabled, **do not** crash if OTEL exporter unavailable; effectively no‑op.\n- Preserve request logging behavior independent of OTEL settings.\n\n## Tests\n- Unit tests verifying no errors when OTEL vars are set.\n- Integration tests with OTEL enabled and missing exporter (should still serve requests).\n\n## Logging/Artifacts\n- Store OTEL config logs under `tests/artifacts/http/logging/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T05:42:26.087167604Z","created_by":"ubuntu","updated_at":"2026-02-05T16:13:55.080204192Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.6.3","depends_on_id":"br-1bm.6","type":"parent-child","created_at":"2026-02-05T05:42:26.087167604Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.6.3","depends_on_id":"br-1bm.6.1","type":"blocks","created_at":"2026-02-05T05:42:39.672384539Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.6.4","title":"HTTP Logging Parity: unit + integration + E2E tests","description":"Comprehensive tests for HTTP logging parity (request logs + structlog renderers + ExpectedErrorFilter), with detailed artifacts.\n\nTest layers:\n- Unit tests:\n  - formatting normalization (TTY vs non-TTY)\n  - conditional enablement: HTTP_REQUEST_LOG_ENABLED only\n  - LOG_JSON_ENABLED toggles JSONRenderer vs KeyValueRenderer (key_order=[event,path,status])\n  - field derivation (client_ip from request.client.host, latency int ms)\n  - ExpectedErrorFilter classifier:\n    - expected patterns detected and downgraded\n    - tracebacks suppressed for expected errors\n    - cause-chain inspection behavior\n- Integration tests:\n  - server with logging enabled emits logs\n  - server with logging disabled emits none\n  - LOG_JSON_ENABLED branch executed on app build (no crash)\n  - OTEL flags enabled: no-op parity (no spans, no behavior change)\n- E2E (part of scripts/e2e_http.sh, br-2ei.9.6):\n  - launch server with logging on\n  - issue representative requests (2xx/4xx/5xx)\n  - capture server stderr/stdout logs + HTTP transcripts\n  - store artifacts under tests/artifacts/http/<timestamp>/\n\nLegacy test references:\n- test_logging_and_redis_fallback.py::test_log_json_enabled_path\n- test_server.py::test_rich_logger_does_not_throw\n- test_expected_error_filter.py\n\n## Acceptance Criteria\n- Unit + integration tests cover the enable/disable matrix and TTY/non-TTY output.\n- Snapshot/golden log assertions are driven by the spec outputs from br-1bm.6.1.\n- ExpectedErrorFilter behavior matches legacy tests and pattern list.\n- E2E artifacts include clear expected-vs-actual field diffs and captured logs.\n- Tests run deterministically (fixed timestamps/latency fakes where required).","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:42:30.521330089Z","created_by":"ubuntu","updated_at":"2026-02-05T07:47:58.051121116Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.6.4","depends_on_id":"br-1bm.6","type":"parent-child","created_at":"2026-02-05T05:42:30.521330089Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.6.4","depends_on_id":"br-1bm.6.2","type":"blocks","created_at":"2026-02-05T05:42:43.034853482Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.6.4","depends_on_id":"br-1bm.6.3","type":"blocks","created_at":"2026-02-05T05:42:46.092367952Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.6.4","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:56.319100804Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.7","title":"CORS Parity Validation","description":"Objective:\nValidate and complete CORS behavior parity with legacy Python: origins, allow_methods, allow_headers, allow_credentials, and OPTIONS responses. Ensure behavior matches when lists are empty or \"*\".\n\nLegacy Reference Behavior:\n- If CORS enabled, allow_origins defaults to [\"*\"] when empty\n- allow_methods default [\"*\"]\n- allow_headers default [\"*\"]\n- Credentials flag respected\n\nImplementation Plan:\n- Ensure CORS config parsing matches legacy defaults.\n- Verify OPTIONS responses include appropriate headers.\n- Ensure origin matching allows all when list is empty.\n\nTests and E2E (with detailed logging):\n- Unit tests for allowlist matching and default behavior.\n- Integration tests for OPTIONS + GET/POST with Origin set.\n- E2E coverage via `br-2ei.9.6` (HTTP parity suite) with header transcripts.\n\n## Acceptance Criteria\n- CORS headers match legacy defaults and behavior across:\n  - empty lists\n  - explicit \"*\"\n  - allow_credentials on/off\n- Preflight (OPTIONS) behavior matches legacy (status + headers).\n- E2E artifacts include explicit header diffs on mismatch.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:43:03.472355999Z","created_by":"ubuntu","updated_at":"2026-02-05T08:23:06.874227229Z","closed_at":"2026-02-05T08:23:06.874209255Z","close_reason":"CORS parity: env defaults + wildcard handling + header override + tests","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.7","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:43:03.472355999Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.7","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:56.401992322Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.8","title":"Bearer Auth Parity","description":"Objective:\nEnsure Bearer token auth middleware behavior matches legacy Python, including localhost bypass logic and forwarded-header safeguards.\n\nLegacy Reference Behavior:\n- If bearer token configured, require Authorization: Bearer <token>\n- If allow_localhost_unauthenticated and client is localhost (no forwarded headers), bypass Authorization\n- OPTIONS and /health/* always allowed\n- Constant-time comparison for token equality\n\nImplementation Plan:\n- Verify Rust middleware path covers OPTIONS + /health/* bypass.\n- Enforce constant-time token compare.\n- Use peer_addr + forwarded headers for localhost detection (`br-1bm.3`).\n\nTests and E2E (with detailed logging):\n- Unit tests for token comparison + bypass conditions.\n- Integration tests for /health endpoints, OPTIONS, and standard POSTs.\n- E2E coverage via `br-2ei.9.6` (HTTP parity suite) including forwarded-header negative cases.\n\n## Acceptance Criteria\n- Responses and bypass behavior match legacy exactly (status + JSON body).\n- Constant-time compare is used (no early-return string compare).\n- E2E artifacts include explicit allow/deny traces and header diffs on mismatch.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:43:12.124733018Z","created_by":"ubuntu","updated_at":"2026-02-05T06:40:29.656247547Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.8","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:43:12.124733018Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.8","depends_on_id":"br-1bm.3","type":"blocks","created_at":"2026-02-05T05:43:23.276913856Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.8","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:56.484645140Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1bm.9","title":"Health + Well-Known Endpoints Parity Tests","description":"Objective:\nVerify health and well-known endpoints match legacy behavior and remain stable. Ensure status codes and JSON payloads are identical.\n\nEndpoints:\n- GET /health/liveness -> {\"status\":\"alive\"}\n- GET /health/readiness -> {\"status\":\"ready\"} OR 503 {\"detail\":\"...\"}\n- GET /.well-known/oauth-authorization-server -> {\"mcp_oauth\": false}\n- GET /.well-known/oauth-authorization-server/mcp -> {\"mcp_oauth\": false}\n\nTests and E2E (with detailed logging):\n- Unit tests for readiness error formatting.\n- Integration tests for each endpoint and method mismatch (405).\n- E2E coverage via `br-2ei.9.6` (HTTP parity suite): hit each endpoint, log status/body, fail on mismatch.\n\n## Acceptance Criteria\n- JSON payloads and status codes identical to legacy for all endpoints.\n- Method mismatch behavior matches legacy (e.g., 405).\n- E2E artifacts include per-endpoint transcript and diffs on mismatch.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T05:43:18.747115290Z","created_by":"ubuntu","updated_at":"2026-02-05T06:40:36.900420537Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1bm.9","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T05:43:18.747115290Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-1bm.9","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:56.567818709Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1e5h","title":"DB concurrency parity: backoff + circuit breaker","description":"## Objective\nImplement database lock contention handling and circuit breaker per legacy concurrency model.\n\n## Scope\n- Exponential backoff with jitter on SQLITE_BUSY/locked errors.\n- Circuit breaker: after 5 consecutive failures, open for 30s (fail fast with `DATABASE_POOL_EXHAUSTED`/`RESOURCE_BUSY`).\n- Connection pooling defaults: base 3 + overflow 4, recycle 30min, busy timeout 5s.\n\n## Tests\n- Unit tests simulating lock contention and backoff sequence.\n- Integration tests for circuit breaker open/close behavior.\n\n## Logging/Artifacts\n- Store backoff/circuit logs under `tests/artifacts/db/concurrency/<timestamp>/`.\n\n## Acceptance Criteria\n1. Backoff and circuit breaker match legacy thresholds and timings.\n2. Errors are mapped to legacy error codes.\n3. Tests are deterministic and do not rely on real contention.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T16:18:50.675607847Z","created_by":"ubuntu","updated_at":"2026-02-05T16:18:55.369564429Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1e5h","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T16:18:55.369503695Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1nh","title":"Share: scrub snapshot presets + secret regex","description":"## Objective\nImplement share pipeline Step 3: `scrub_snapshot` with legacy presets and secret redaction.\n\n## Scope\n- Presets: `standard`, `strict`, `archive` with exact flags (redact_body, drop_attachments, scrub_secrets, clear_ack_state, clear_recipients, clear_file_reservations, clear_agent_links).\n- Secret regex patterns (GH tokens, slack, sk‑, bearer, JWT, etc.) replaced with `[REDACTED]`.\n- Attachment metadata scrub: remove keys (download_url, headers, authorization, signed_url, bearer_token).\n- Body redaction for strict: replace with `\"[Message body redacted]\"`.\n- Return `ScrubSummary` with counts (agents_total, ack_flags_cleared, recipients_cleared, etc.).\n\n## Tests\n- Unit tests for each preset and regex redaction.\n- Integration tests on seeded snapshot DB with attachments and secrets.\n\n## Logging/Artifacts\n- Save scrub summary JSON and diffs under `tests/artifacts/share/scrub/<timestamp>/`.\n\n## Acceptance Criteria\n1. Preset behavior matches legacy exactly (counts + outputs).\n2. Secret patterns are redacted without altering non‑secrets.\n3. Attachments scrubbed per key list with correct counts.","status":"in_progress","priority":1,"issue_type":"task","assignee":"GreenSparrow","created_at":"2026-02-05T16:15:20.358844765Z","created_by":"ubuntu","updated_at":"2026-02-05T17:52:59.154928230Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1nh","depends_on_id":"br-1uf","type":"parent-child","created_at":"2026-02-05T16:15:23.418674217Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-1uf","title":"Share/Export Pipeline Parity (Static Bundle)","description":"## Objective\nImplement the full **Share/Export pipeline** (static bundle) as specified in `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md` (Share/Export section). This includes DB snapshotting, scrub presets, search indexes, viewer assets, bundle scaffolding, signing/encryption, and deterministic ZIP packaging.\n\n## Scope (15 Steps)\n1. create_sqlite_snapshot\n2. apply_project_scope\n3. scrub_snapshot (presets + secret regex)\n4. build_search_indexes (FTS5)\n5. build_materialized_views\n6. create_performance_indexes\n7. finalize_snapshot_for_export\n8. bundle_attachments\n9. maybe_chunk_database\n10. copy_viewer_assets\n11. export_viewer_data\n12. write_bundle_scaffolding\n13. sign_manifest\n14. encrypt_bundle\n15. package_directory_as_zip\n\n## Tests\n- Unit tests per step for deterministic behavior.\n- Integration tests for end‑to‑end export/update flows.\n- E2E coverage via `br-2ei.9.4`.\n\n## Logging/Artifacts\n- Share pipeline artifacts under `tests/artifacts/share/<timestamp>/`.\n- JSON summaries + diffs for each step.\n\n## Acceptance Criteria\n1. All steps are implemented per spec with legacy parity.\n2. Deterministic bundles (stable hashes) are enforced in tests.\n3. E2E share/export suite passes with detailed artifacts.","status":"in_progress","priority":1,"issue_type":"epic","created_at":"2026-02-05T16:14:52.252531998Z","created_by":"ubuntu","updated_at":"2026-02-05T18:04:38.461082681Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-1uf","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T16:14:56.877509340Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-27m","title":"Share: search indexes + materialized views + perf indexes","description":"## Objective\nImplement share pipeline Steps 4–6: FTS5 search indexes, materialized views, and performance indexes for static viewer.\n\n## Scope\n- **build_search_indexes**: create `fts_messages` virtual table; populate with subject/body/importance/project/thread_key/created_ts; optimize.\n- **build_materialized_views**: create `message_overview_mv`, `attachments_by_message_mv`, `fts_search_overview_mv` (if FTS enabled).\n- **create_performance_indexes**: add lowercase columns and covering indexes for fast viewer filtering.\n\n## Tests\n- Unit tests for FTS presence/absence path.\n- Integration tests verifying view row counts and index existence.\n\n## Logging/Artifacts\n- Store schema dumps under `tests/artifacts/share/indexes/<timestamp>/`.\n\n## Acceptance Criteria\n1. FTS and MV tables match legacy schemas and row counts.\n2. Performance indexes created without errors, idempotent.\n3. Viewer search works against generated bundle DB.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T16:15:32.931924389Z","created_by":"ubuntu","updated_at":"2026-02-05T18:00:45.523981969Z","closed_at":"2026-02-05T18:00:45.523958655Z","close_reason":"Validated share index/view parity; ensured message_recipients table exists","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-27m","depends_on_id":"br-1uf","type":"parent-child","created_at":"2026-02-05T16:15:36.800683710Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-28u","title":"Share: chunk database (4MiB chunks)","description":"## Objective\nImplement share pipeline Step 9: database chunking for large bundles.\n\n## Scope\n- Default threshold: 20MiB; chunk size 4MiB.\n- Split DB file into sequential chunks with deterministic naming/order.\n- Update manifest to reference chunks and original size.\n\n## Tests\n- Integration test with synthetic DB large enough to trigger chunking.\n- Verify chunk count, sizes, and reassembly hash match original.\n\n## Logging/Artifacts\n- Store chunk metadata under `tests/artifacts/share/chunking/<timestamp>/`.\n\n## Acceptance Criteria\n1. Chunking triggers only above threshold and produces correct chunk sizes.\n2. Reassembly yields byte‑identical DB.\n3. Manifest updated with chunk metadata.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T16:16:09.803257199Z","created_by":"ubuntu","updated_at":"2026-02-05T17:49:54.658358572Z","closed_at":"2026-02-05T17:49:54.658340589Z","close_reason":"Chunking already implemented in bundle.rs with tests; verified chunk_* tests pass","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-28u","depends_on_id":"br-1uf","type":"parent-child","created_at":"2026-02-05T16:16:14.635619585Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2b9","title":"Share: finalize snapshot for export (VACUUM/page size/journal)","description":"## Objective\nImplement share pipeline Step 7: finalize snapshot for export.\n\n## Scope\n- Set `journal_mode=DELETE` and `page_size=1024`.\n- Run `VACUUM` and `ANALYZE` to compact snapshot.\n- Ensure resulting DB is read‑only friendly and minimal.\n\n## Tests\n- Integration test verifying PRAGMA settings and DB integrity.\n- Ensure file size shrinks relative to pre‑finalize snapshot.\n\n## Logging/Artifacts\n- Store PRAGMA outputs and file size stats under `tests/artifacts/share/finalize/<timestamp>/`.\n\n## Acceptance Criteria\n1. Snapshot PRAGMAs match legacy values and persist.\n2. VACUUM/ANALYZE executed without errors; DB integrity check passes.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T16:15:44.574009526Z","created_by":"ubuntu","updated_at":"2026-02-05T17:46:47.843807215Z","closed_at":"2026-02-05T17:46:47.843785945Z","close_reason":"Added page_size + shrink tests; validate finalize PRAGMAs/VACUUM","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2b9","depends_on_id":"br-1uf","type":"parent-child","created_at":"2026-02-05T16:15:48.886878450Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2di","title":"CLI: share preview parity (hotkeys + exit codes)","description":"## Objective\nImplement `share preview` command with legacy server behavior and hotkeys.\n\n## Scope\n- Defaults: host `127.0.0.1`, port `9000`, `--open-browser` default false.\n- Serve static bundle with no-cache headers.\n- Hotkeys: `r` reload, `d` deploy request, `q` quit.\n- Exit code **42** when deploy requested via `d`.\n\n## Tests\n- Integration test with temp bundle; verify server responds and hotkeys trigger.\n- Assert exit code 42 on deploy request.\n\n## Logging/Artifacts\n- Store preview server logs under `tests/artifacts/cli/share_preview/<timestamp>/`.\n\n## Acceptance Criteria\n1. share preview matches legacy defaults and hotkey behavior.\n2. Exit codes match legacy (42 on deploy request).\n3. No-cache headers are set on responses.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T16:17:04.316431054Z","created_by":"ubuntu","updated_at":"2026-02-05T16:17:44.188309500Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2di","depends_on_id":"br-1uf","type":"blocks","created_at":"2026-02-05T16:17:44.188268904Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2di","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T16:17:08.106147106Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei","title":"MCP Agent Mail Rust: 100% feature parity + conformance + benchmarks","description":"## Objective\nDeliver a Rust port of legacy `mcp_agent_mail` with **100% behavior parity**, including MCP tools/resources, HTTP transport, CLI, storage/git archive, mail UI, share/export pipeline, and background workers. The port must use the local crates (`/dp/fastmcp_rust`, `/dp/sqlmodel_rust`, `/dp/asupersync`, `/dp/frankentui`, `/dp/beads_rust`, `/dp/coding_agent_session_search`) and avoid tokio where asupersync is the intended runtime.\n\n## Scope (Non‑Negotiable)\n- **Parity with legacy Python** as specified in `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md` and verified by conformance fixtures.\n- **MCP server**: tools/resources, tool filtering, TOON output format, instrumentation, notifications, LLM integration.\n- **HTTP server**: streamable HTTP transport, auth/JWT/RBAC, rate limiting, logging, background workers, mail UI.\n- **CLI**: all Typer-equivalent commands + flags + exit codes + outputs (human + JSON).\n- **Storage**: git archive artifacts, locks, attachments, notifications signals.\n- **Share/Export**: full static bundle pipeline + crypto + deterministic packaging.\n- **Quality gates**: conformance + unit/integration + E2E + benchmarks with artifacts.\n\n## Deliverables\n- **Conformance harness** covering all tools/resources (fixture-based).\n- **E2E suite** (HTTP/CLI/archive/share/guard) with detailed artifacts.\n- **Bench suite** with budgets and regression checks.\n- **Feature parity report** (`FEATURE_PARITY.md`) kept accurate.\n\n## Tests\n- Conformance tests for all tools/resources + TOON + LLM (stubbed).\n- Unit/integration tests per subsystem (storage, DB, HTTP, CLI, share).\n- E2E scripts with deterministic fixtures.\n- Benchmark smoke + budgets.\n\n## Logging/Artifacts\n- Standardized artifacts under `tests/artifacts/...` for all failure modes.\n- JSON diff outputs for conformance/CLI/HTTP comparisons.\n- Bench summaries + flamegraphs where applicable.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":0,"issue_type":"epic","created_at":"2026-02-05T05:05:51.223489285Z","created_by":"ubuntu","updated_at":"2026-02-05T16:07:47.053054924Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"br-2ei.1","title":"Conformance Harness: cover all tools/resources + artifact parity","description":"## Objective\nBuild a **fixture-based conformance harness** that proves the Rust port matches legacy Python outputs for all tools and resources, including edge cases, error shapes, and output format options.\n\n## Scope\n- **Tools**: all MCP tools (identity, messaging, contacts, reservations, build slots, products, macros, etc.).\n- **Resources**: every `resource://` URI (including query params + TOON format).\n- **Errors**: invalid input, missing required fields, type errors, capability denied, not found — matching legacy JSON shapes.\n- **Formatting**: TOON envelope output and fallback behavior.\n- **LLM**: stubbed llm_mode paths to verify deterministic behavior.\n\n## Implementation Notes\n- Python fixture generator should run legacy tool/resource calls and capture outputs with deterministic ordering.\n- Rust harness must load fixtures, invoke Rust tools/resources, and compare with **strict JSON diff** (allowing only documented normalization).\n- Include CLI helper to re-run fixture generation (br-2ei.1.4).\n\n## Tests\n- Conformance test suite `crates/mcp-agent-mail-conformance/tests/conformance.rs` covering:\n  - full tool set\n  - full resource set with query variants\n  - TOON output\n  - error cases\n- Fixture schema validation (guard against shape drift).\n\n## Logging/Artifacts\n- Store diffs and actual outputs under `tests/artifacts/conformance/<timestamp>/`.\n- Emit high-signal JSON diffs on mismatch (expected vs actual).\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":1,"issue_type":"epic","created_at":"2026-02-05T05:06:15.213350684Z","created_by":"ubuntu","updated_at":"2026-02-05T16:18:44.142010772Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.1","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.1","depends_on_id":"br-2ei.10.3","type":"blocks","created_at":"2026-02-05T06:57:56.032096692Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.1","depends_on_id":"br-2ei.15","type":"blocks","created_at":"2026-02-05T15:17:07.303258917Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.1","depends_on_id":"br-3h94","type":"blocks","created_at":"2026-02-05T16:18:44.141971508Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.1.1","title":"Fixtures: missing tool coverage (guard install/uninstall + force_release)","description":"Track conformance fixture coverage for the last missing MCP tools (as reported by python_reference.json). This is a meta-epic; each tool gets its own child task with concrete fixture scenarios, normalization rules, and Rust runner integration.\n\nMissing tools to cover:\n- install_precommit_guard\n- uninstall_precommit_guard\n- force_release_file_reservation\n\nNon-negotiables:\n- Add BOTH positive and negative/error-path cases.\n- Record expected shapes from legacy Python and keep fixtures deterministic (normalize only true nondeterminism like timestamps/paths).\n- Include detailed logs in the fixture generator so failures are diagnosable.\n\nChild tasks under this epic should each include:\n- Legacy behavior matrix (inputs -> expected outputs)\n- Fixture generator changes\n- Rust conformance runner changes\n- Any required normalization rules documented inline\n\n## Success Criteria\n1. python_reference fixtures include deterministic cases for all missing tools.\n2. Rust conformance runner executes those cases and compares exact outputs after normalization.\n3. Failures are actionable: fixture generator logs show per-case setup + expected vs actual.","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-02-05T05:10:18.916319777Z","created_by":"ubuntu","updated_at":"2026-02-05T06:34:21.285026898Z","closed_at":"2026-02-05T06:34:21.284931268Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.1.1","depends_on_id":"br-2ei.1","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.1.1.1","title":"Fixtures: precommit guard install/uninstall tool cases","description":"Add conformance fixture coverage for:\n- install_precommit_guard(project_key, code_repo_path)\n- uninstall_precommit_guard(code_repo_path)\n\nFixture scenarios (must be stable + diagnostic):\n- Install into a fresh git repo (no existing hooks): succeeds; chain-runner + plugin present.\n- Install idempotency: second install is a no-op (or same result) and does not clobber preserved hook state.\n- Install when repo already has a pre-commit hook: legacy-preserve behavior matches (e.g., .orig + chain-runner semantics).\n- Uninstall: removes only agent-mail components and restores preserved hook when applicable.\n- Uninstall idempotency: running twice is safe.\n- Error paths: non-existent path, not-a-git-repo dir, permission denied / read-only hooks dir.\n\nNormalization rules:\n- Paths must be stored as relative or redacted (never machine-absolute).\n- Timestamps should be normalized if present.\n\nImplementation:\n- Extend python_reference fixture generator to create a temp repo and exercise the tools.\n- Update Rust conformance runner to execute these cases and compare to fixtures.\n- Log each subcase with: repo layout summary, expected vs actual tool result, and any created hook paths.\n\n## Acceptance Criteria\n1. python_reference.json contains deterministic cases for install_precommit_guard/uninstall_precommit_guard (positive + error cases).\n2. Rust conformance runner executes these cases and matches legacy outputs after documented normalization.\n3. Fixture generator logs include per-case repo layout + created hook paths + expected vs actual result.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:52:01.241854819Z","created_by":"ubuntu","updated_at":"2026-02-05T06:34:21.126079048Z","closed_at":"2026-02-05T06:34:21.126008285Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.1.1.1","depends_on_id":"br-2ei.1.1","type":"parent-child","created_at":"2026-02-05T05:52:01.241854819Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.1.1.1","depends_on_id":"br-2ei.3.4","type":"blocks","created_at":"2026-02-05T05:52:01.241854819Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.1.1.2","title":"Fixtures: force_release_file_reservation tool cases","description":"Add conformance fixture coverage for:\n- force_release_file_reservation(project_key, agent_name, file_reservation_id, notify_previous, note)\n\nFixture scenarios (must be deterministic):\n- DENY: reservation is not abandoned (recent agent activity / recent mail / recent archive activity).\n- ALLOW: reservation appears abandoned per legacy heuristics; reservation is released and archive artifacts updated.\n- ALLOW + notify_previous=true: a notification message is sent to the previous holder including the provided note + heuristic summary.\n- Edge cases:\n  - reservation already released -> no-op vs error (match legacy)\n  - reservation expired -> expected behavior (match legacy)\n  - invalid reservation id -> error shape parity\n\nDeterminism strategy:\n- In the fixture generator, explicitly set timestamps/last_active markers to known fixed values.\n- Normalize nondeterministic fields (timestamps, commit SHAs) only if the legacy fixture includes them.\n\nImplementation:\n- Extend python_reference fixture generator to set up agents + reservations + activity signals, then call the tool.\n- Update Rust conformance runner to execute these cases and compare.\n- Log each subcase with the measured heuristic signals and final allow/deny.\n\n## Acceptance Criteria\n1. python_reference.json contains deterministic force_release cases covering allow/deny + notify + edge cases.\n2. Rust conformance runner matches legacy outputs after documented normalization.\n3. Fixture generator logs print the heuristic signals used for the decision and the final allow/deny.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:52:13.014200455Z","created_by":"ubuntu","updated_at":"2026-02-05T06:34:21.204000576Z","closed_at":"2026-02-05T06:34:21.203927558Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.1.1.2","depends_on_id":"br-2ei.1.1","type":"parent-child","created_at":"2026-02-05T05:52:13.014200455Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.1.1.2","depends_on_id":"br-2ei.2.7","type":"blocks","created_at":"2026-02-05T05:52:13.014200455Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.1.2","title":"Fixtures: add negative/error cases (invalid params, contact enforcement, policy coercions)","description":"Add high-signal error cases to conformance so we lock in edge behavior.\n\nCandidates:\n- ensure_project: relative path -> error\n- register_agent: invalid name under strict enforcement -> error or coercion depending on config\n- send_message: CONTACT_BLOCKED / CONTACT_REQUIRED flows\n- file_reservation_paths: conflicts returned shape; TTL min enforcement\n- renew_file_reservations: invalid ids/paths\n- search_messages: FTS syntax vs LIKE fallback edge cases\n- resources: missing required query params -> error\n\nApproach:\n- Add cases to python fixture generator where legacy behavior is clear.\n- Normalize only nondeterministic fields.\n\nAcceptance:\n- Tests fail on any drift.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:10:53.695321528Z","created_by":"ubuntu","updated_at":"2026-02-05T05:38:33.464730817Z","closed_at":"2026-02-05T05:38:33.464713414Z","close_reason":"Added negative/error conformance cases and updated fixtures/generator","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.1.2","depends_on_id":"br-2ei.1","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.1.3","title":"Conformance: assert git archive artifacts (messages/inbox/outbox/reservations/attachments) match legacy","description":"## Objective\nConformance verification that git archive artifacts **exactly** match legacy Python outputs for messages, inbox/outbox copies, file reservations, attachments, and manifests.\n\n## Scope\n- Canonical message markdown (frontmatter JSON, body, ordering).\n- Per-recipient inbox/outbox copies (path layout + contents).\n- File reservation artifacts: `file_reservations/{sha1}.json` and `file_reservations/id-<id>.json`.\n- Attachment manifests, checksums, WebP/original handling.\n- Commit metadata (author, summary format, path filtering).\n\n## Implementation Notes\n- Use legacy fixture captures from conformance generator for archive side effects.\n- Compare file trees (names + sizes) and file contents; normalize timestamp lines only if legacy normalizes.\n- Explicitly validate frontmatter JSON schema and message body integrity.\n\n## Tests\n- Conformance fixtures for archive artifacts stored under `tests/conformance/fixtures/archive/*`.\n- Rust test reads legacy artifacts and compares produced Rust artifacts.\n\n## Logging/Artifacts\n- On failure, emit unified diffs and archive file tree snapshots.\n- Store mismatch artifacts under `tests/artifacts/conformance/archive/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-05T05:11:01.868813386Z","created_by":"ubuntu","updated_at":"2026-02-05T16:08:03.691314004Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.1.3","depends_on_id":"br-2ei.1","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.1.3","depends_on_id":"br-2ei.2.3","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.1.3","depends_on_id":"br-2ei.2.4","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.1.3","depends_on_id":"br-2ei.2.5","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.1.4","title":"Conformance: CLI helper to regenerate fixtures (Rust wrapper)","description":"Add a CLI helper command/script to regenerate conformance fixtures deterministically.\n\nScope:\n- Provide a single command (for example: cargo run -p mcp-agent-mail-conformance -- regen) that:\n  - spins up legacy Python reference runner\n  - captures tool/resource outputs\n  - writes fixtures with normalized nondeterminism\n- Ensure it matches the existing python_reference/generate_fixtures.py flow, but is discoverable and repeatable from Rust tooling.\n\nRequirements:\n- Deterministic output ordering and stable file paths.\n- Clear logging of environment prerequisites and failure causes.\n- Non-destructive: writes only to fixtures directory and temp dirs.\n\nTests:\n- Unit: CLI parsing + dry-run mode.\n- Integration: run in CI with a stubbed Python runner (or skip if env missing, but with a clear skip reason).\n\n## Acceptance Criteria\n1. Single command regenerates fixtures end-to-end in a controlled environment.\n2. Output is deterministic and matches the existing schema.\n3. Failures are actionable and logged with context (paths, commands, exit codes).","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T15:15:06.916875235Z","created_by":"ubuntu","updated_at":"2026-02-06T00:42:59.006338791Z","closed_at":"2026-02-06T00:42:59.006316449Z","close_reason":"Implemented conformance regen CLI wrapper + testable output override","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.1.4","depends_on_id":"br-2ei.1","type":"parent-child","created_at":"2026-02-05T15:15:06.916875235Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.10","title":"Tool Filtering Profiles Parity (full/core/minimal/messaging/custom)","description":"## Objective\nImplement tool filtering profiles to match legacy behavior exactly (full/core/minimal/messaging/custom).\n\n## Scope (from spec)\n- Env vars: `TOOLS_FILTER_ENABLED`, `TOOLS_FILTER_PROFILE`, `TOOLS_FILTER_MODE`, `TOOLS_FILTER_CLUSTERS`, `TOOLS_FILTER_TOOLS`.\n- Validation: normalize to lowercase; invalid profile → `full`, invalid mode → `include`.\n- Profile definitions: \n  - `full`: no filtering\n  - `core`: clusters [identity, messaging, file_reservations, workflow_macros] + tools [health_check, ensure_project]\n  - `minimal`: explicit tool list only (health_check, ensure_project, register_agent, send_message, fetch_inbox, acknowledge_message)\n  - `messaging`: clusters [identity, messaging, contact] + tools [health_check, ensure_project, search_messages]\n  - `custom`: include/exclude logic with clusters/tools lists\n- Application: remove tools from registry and metadata maps at server startup; log removed/exposed counts.\n\n## Tests\n- Unit tests for settings parsing and `_should_expose_tool` logic.\n- Integration tests for registry filtering (count removed/exposed).\n- Conformance fixtures in `mcp-agent-mail-conformance` to ensure parity.\n\n## Logging/Artifacts\n- Capture filter decisions and removal summaries in test logs.\n- Store diffs under `tests/artifacts/tool_filter/<timestamp>/` on mismatch.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-05T06:54:46.298194912Z","created_by":"ubuntu","updated_at":"2026-02-05T23:37:19.854483133Z","closed_at":"2026-02-05T23:37:19.854451584Z","close_reason":"All children done: spec, impl, tests. Tool filtering profiles fully working with conformance validation.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.10","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T06:54:46.298194912Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.10","depends_on_id":"br-36w","type":"blocks","created_at":"2026-02-05T16:18:23.648274405Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.10.1","title":"Tool Filter Spec: extract legacy profiles + custom mode semantics + vectors","description":"Extract the exact legacy Python tool filtering behavior into a self-contained spec + test vectors.\n\nLegacy sources:\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/config.py` (env parsing)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/app.py` (TOOL_FILTER_PROFILES + _should_expose_tool + _apply_tool_filter)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_tool_filter_and_notifications.py` (ground-truth behavioral tests)\n  - NOTE: this file also covers Notifications; notifications parity is tracked separately in `br-2ei.12`.\n\nMust capture verbatim:\n- The predefined profile definitions (`full`, `core`, `minimal`, `messaging`) including:\n  - clusters list\n  - tools list\n  - special-case semantics when profile clusters list is empty\n- Custom mode semantics:\n  - include vs exclude\n  - behavior when both clusters/tools lists are empty\n- Unknown/invalid profile and mode fallback rules.\n- Logging/debug behavior:\n  - what is logged at startup (removed count, exposed count)\n\nDeliverables:\n- Add a “Tool Filtering Profiles” section to `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md` including:\n  - the exact profile tables\n  - exact decision logic (pseudocode is OK but must be unambiguous)\n  - exact env var parsing + defaults\n- Add machine-usable vectors under `crates/mcp-agent-mail-conformance/tests/conformance/fixtures/tool_filter/`:\n  - expected tool list and tooling-directory outputs for at least:\n    - filtering disabled\n    - minimal profile\n    - core profile\n    - custom include (clusters + tools)\n    - custom exclude (clusters)\n\n## Acceptance Criteria\n- Spec is complete enough to implement without re-reading Python.\n- Vectors include exact expected tool names and cluster assignments.\n- Vectors include stable ordering expectations (how lists are sorted).\n- Regeneration instructions are included (command + expected output path).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T06:55:00.999918625Z","created_by":"ubuntu","updated_at":"2026-02-05T15:37:01.542535974Z","closed_at":"2026-02-05T15:37:01.542518271Z","close_reason":"Spec in EXISTING_MCP_AGENT_MAIL_STRUCTURE.md + 6 profile vectors (45+ assertions) + 7 custom filter vectors (30+ assertions) in conformance fixtures","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.10.1","depends_on_id":"br-2ei.10","type":"parent-child","created_at":"2026-02-05T06:55:00.999918625Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.10.2","title":"Tool Filter Impl: apply filtering to FastMCP tool registry + tooling resources","description":"Implement tool filtering profiles in the Rust server exactly as legacy Python.\n\nWork:\n- Config:\n  - Parse `TOOLS_FILTER_*` env vars into `mcp-agent-mail-core` config.\n  - Ensure invalid values fall back exactly like legacy (profile->full, mode->include).\n- Decision logic:\n  - Implement `_should_expose_tool` equivalent using cluster mapping + tool name.\n  - Implement predefined profiles (`full`, `core`, `minimal`, `messaging`) exactly as extracted in `br-2ei.10.1`.\n  - Implement custom include/exclude semantics exactly as extracted.\n- Registry filtering:\n  - Apply filtering at server startup (post-registration) like legacy `_apply_tool_filter`.\n  - Ensure filtered tools are removed from:\n    - FastMCP tool registry (so they do not appear in `tools/list`)\n    - tool cluster directory metadata (`resource://tooling/directory`)\n    - any tool metadata registries used for schemas/capabilities\n- Observability:\n  - Log a single high-signal line at startup when filtering is enabled:\n    - profile\n    - removed tool count\n    - exposed tool count\n  - Keep a stable internal list of filtered tools for debugging.\n\n## Acceptance Criteria\n- When filtering is disabled (default), the exposed tool list is identical to current behavior.\n- For each profile/custom mode, exposed tools match the vectors from `br-2ei.10.1`.\n- Filtering affects both:\n  - MCP `tools/list`\n  - `resource://tooling/directory` (clusters + tool lists)\n- Tests:\n  - Unit tests replicate legacy `test_tool_filter_and_notifications.py` tool-filter cases.\n  - Integration test exercises server start with filtering enabled and asserts the tool list is filtered.\n- No tokio runtime is introduced.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T06:55:31.347678353Z","created_by":"ubuntu","updated_at":"2026-02-05T15:37:51.826555612Z","closed_at":"2026-02-05T15:37:51.826537037Z","close_reason":"Already implemented: Config (config.rs ToolFilterSettings + should_expose_tool), Server (conditional registration), Resources (tool_filter_allows in directory/schemas/metrics/recent), Conformance (cases.json + test)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.10.2","depends_on_id":"br-2ei.10","type":"parent-child","created_at":"2026-02-05T06:55:31.347678353Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.10.2","depends_on_id":"br-2ei.10.1","type":"blocks","created_at":"2026-02-05T06:55:36.213759154Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.10.3","title":"Tool Filter Tests: conformance fixtures + unit/integration + E2E smoke","description":"## Objective\nAdd comprehensive tests for tool filtering profiles and custom include/exclude behavior.\n\n## Scope\n- Conformance fixtures for each profile (`full`, `core`, `minimal`, `messaging`, `custom`).\n- Unit tests for settings parsing (CSV splitting, trimming, invalid values).\n- Integration tests verifying tool registry pruning and metadata map updates.\n- E2E smoke: verify server exposes expected tool list via `resource://tooling/directory`.\n\n## Logging/Artifacts\n- Store expected vs actual tool lists under `tests/artifacts/tool_filter/<timestamp>/` on failure.\n- Emit diffs with removed/exposed counts.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T06:55:56.026244045Z","created_by":"ubuntu","updated_at":"2026-02-05T23:37:15.641407891Z","closed_at":"2026-02-05T23:37:15.641383315Z","close_reason":"Conformance fixtures cover all 5 profiles (full/core/minimal/messaging/custom) + custom include/exclude. Config parsing implemented with CSV splitting and normalization.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.10.3","depends_on_id":"br-2ei.10","type":"parent-child","created_at":"2026-02-05T06:55:56.026244045Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.10.3","depends_on_id":"br-2ei.10.2","type":"blocks","created_at":"2026-02-05T06:56:02.926170119Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.11","title":"Instrumentation Parity: query tracking + slow query logging","description":"## Objective\nParity for **query instrumentation and slow query logging**, including QueryTracker data shape, per‑tool injection, and logging behavior.\n\n## Scope (Spec‑Driven)\n- Env vars: `INSTRUMENTATION_ENABLED`, `INSTRUMENTATION_SLOW_QUERY_MS`, `TOOLS_LOG_ENABLED`.\n- QueryTracker fields: `total`, `total_time_ms` (round 2dp), `per_table` sorted by count desc then name, `slow_query_ms`, `slow_queries[]` (max 50; durations rounded 2dp).\n- Table name extraction regex order: INSERT INTO, UPDATE, FROM; strip schema prefixes/quotes.\n- Tool wrapper integration: start tracker at tool entry, attach stats to response/logs.\n- Logging: rich logger panel when enabled; structlog fallback; never crash on logging errors.\n\n## Tests\n- Unit tests for table extraction and rounding rules.\n- Integration tests for per‑tool stats with representative queries.\n- E2E log capture (br-2ei.11.3).\n\n## Logging/Artifacts\n- Save sample tracker outputs under `tests/artifacts/instrumentation/<timestamp>/`.\n- On mismatch, emit JSON diff of expected vs actual tracker output.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":2,"issue_type":"epic","created_at":"2026-02-05T06:56:13.877654086Z","created_by":"ubuntu","updated_at":"2026-02-05T16:09:40.770227397Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.11","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T06:56:13.877654086Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.11.1","title":"Instrumentation Spec: extract legacy QueryTracker + log fields + thresholds","description":"Extract the exact legacy Python instrumentation behavior into a self-contained spec.\n\nLegacy sources:\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/config.py` (env parsing)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/db.py` (QueryTracker)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/app.py` (tool wrapper: start/stop tracking + log `tool_query_stats`)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/rich_logger.py` (slow query presentation)\n\nMust capture:\n- Exact env defaults and parsing behavior.\n- Exact stats shape:\n  - total queries\n  - total_time_ms rounding\n  - per_table sorting rules\n  - slow_query_ms field\n  - slow query capture limit + what is recorded per slow query\n- Exact SQL table extraction heuristics (regexes) and cleaning behavior.\n- Exact log emission semantics:\n  - log event name (`tool_query_stats`)\n  - which fields are emitted (tool/project/agent/queries/query_time_ms/per_table/slow_query_ms)\n  - when logging happens (only when instrumentation enabled and tracker active)\n\nDeliverables:\n- Add an “Instrumentation / Query Tracking” section to `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md`.\n- Provide test vectors for table-name extraction and tracker aggregation under `crates/mcp-agent-mail-db/tests/fixtures/instrumentation/`.\n\n## Acceptance Criteria\n- Spec is detailed enough to implement without re-reading Python.\n- Vectors include:\n  - SELECT/INSERT/UPDATE statements with quoted identifiers and schema-qualified names\n  - edge cases where table name cannot be extracted\n  - slow query threshold boundary cases","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T06:56:26.966466761Z","created_by":"ubuntu","updated_at":"2026-02-05T15:20:20.291386328Z","closed_at":"2026-02-05T15:20:20.291364527Z","close_reason":"Spec complete in EXISTING_MCP_AGENT_MAIL_STRUCTURE.md + 28 table extraction vectors + 13 tracker aggregation vectors in fixtures","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.11.1","depends_on_id":"br-2ei.11","type":"parent-child","created_at":"2026-02-05T06:56:26.966466761Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.11.2","title":"Instrumentation Impl: query tracker in db layer + per-tool logging (tokio-free)","description":"## Objective\nImplement QueryTracker in DB layer and wire per‑tool logging without tokio.\n\n## Scope\n- Add QueryTracker struct with fields + rounding rules per spec.\n- Instrument all DB query entry points to record table name, duration, and counts.\n- Expose tracker data to tool handlers (attach to tool responses or logs as legacy).\n- Honor `INSTRUMENTATION_ENABLED` and `INSTRUMENTATION_SLOW_QUERY_MS`.\n- Respect `TOOLS_LOG_ENABLED` for rich logging; fall back to structlog/stdio.\n\n## Tests\n- Unit tests for tracker accumulation and slow query capture (threshold + cap 50).\n- Integration test: tool call executes known queries and tracker output matches expected JSON.\n\n## Logging/Artifacts\n- Save tracker JSON under `tests/artifacts/instrumentation/<timestamp>/` on failure.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T06:56:37.195912390Z","created_by":"ubuntu","updated_at":"2026-02-05T16:09:52.332766420Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.11.2","depends_on_id":"br-2ei.11","type":"parent-child","created_at":"2026-02-05T06:56:37.195912390Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.11.2","depends_on_id":"br-2ei.11.1","type":"blocks","created_at":"2026-02-05T06:56:45.899487821Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.11.3","title":"Instrumentation Tests: unit + integration + E2E log capture","description":"## Objective\nTest instrumentation end‑to‑end (unit + integration + E2E log capture).\n\n## Scope\n- Unit tests for regex extraction and rounding rules.\n- Integration test: run tool call, assert tracker output and log record shape.\n- E2E: enable instrumentation env vars and verify logs + tool response metadata.\n\n## Logging/Artifacts\n- Store log captures under `tests/artifacts/instrumentation/<timestamp>/`.\n- Emit diffs on mismatch (expected vs actual tracker JSON).\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T06:56:56.813594907Z","created_by":"ubuntu","updated_at":"2026-02-05T16:10:02.881633578Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.11.3","depends_on_id":"br-2ei.11","type":"parent-child","created_at":"2026-02-05T06:56:56.813594907Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.11.3","depends_on_id":"br-2ei.11.2","type":"blocks","created_at":"2026-02-05T06:57:04.824216159Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.12","title":"Notifications Parity: push-signal files (emit/clear/list + debounce + integration)","description":"## Objective\nImplement **notifications (signal files)** with legacy parity, including debounce, metadata, and integration points.\n\n## Scope (from spec)\n- Env vars: `NOTIFICATIONS_ENABLED`, `NOTIFICATIONS_SIGNALS_DIR`, `NOTIFICATIONS_INCLUDE_METADATA`, `NOTIFICATIONS_DEBOUNCE_MS`.\n- Signal path: `{signals_dir}/projects/{project_slug}/agents/{agent}.signal`.\n- Payload: timestamp + project + agent, plus optional message metadata (id/from/subject/importance).\n- Debounce: in‑memory `(project,agent)` map with ms timestamps; skip if within window.\n- `emit_notification_signal`: best‑effort, atomic write, returns bool.\n- `clear_notification_signal`: delete file, best‑effort, returns bool.\n- `list_pending_signals`: parse JSON files, include parse error entries.\n- Integration: emit after `send_message` for **to+cc only** (never bcc); clear after `fetch_inbox`.\n\n## Tests\n- Unit tests for payload shapes + debounce semantics.\n- Integration tests for send/fetch paths with temp signals dir.\n- Fixtures: `signal_payloads.json`, `debounce_scenarios.json`, `list_scenarios.json`.\n\n## Logging/Artifacts\n- On failure, store signal file tree + JSON under `tests/artifacts/notifications/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-05T07:28:00.374857564Z","created_by":"ubuntu","updated_at":"2026-02-05T23:36:49.593986615Z","closed_at":"2026-02-05T23:36:49.593947813Z","close_reason":"All children done: signal files impl, debounce, to/cc emission, fetch_inbox clearing, 9+ tests","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.12","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T07:28:00.374857564Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.12","depends_on_id":"br-36w","type":"blocks","created_at":"2026-02-05T16:18:23.463700592Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.12.1","title":"Notifications Spec: extract legacy signal-file semantics + vectors","description":"Extract exact legacy Python notifications behavior into a self-contained spec + vectors.\n\nLegacy sources:\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/config.py` (notifications settings parsing)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/storage.py` (emit/clear/list implementations + debounce state)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/app.py` (integration points: send_message emits, fetch_inbox clears)\n- Tests: `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_tool_filter_and_notifications.py::TestNotifications`\n\nMust capture verbatim:\n- File path layout:\n  - `{signals_dir}/projects/{project_slug}/agents/{agent_name}.signal`\n- JSON payload shape:\n  - required keys (project, agent, timestamp)\n  - optional message metadata fields and when included (NOTIFICATIONS_INCLUDE_METADATA)\n- Debounce semantics:\n  - keying (project+agent)\n  - time source and window comparisons\n  - what state is stored (in-memory map), and reset behavior in tests\n- Error handling:\n  - what functions return on failure (bool / empty list)\n  - directory creation behavior\n- Integration semantics:\n  - send_message: to+cc only, not bcc\n  - fetch_inbox: clears signal best-effort when enabled\n\nDeliverables:\n- Add a “Notifications (Signals)” section to `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md`.\n- Add vectors/fixtures for JSON payloads (metadata on/off) under `crates/mcp-agent-mail-storage/tests/fixtures/notifications/`.\n\n## Acceptance Criteria\n- Spec is complete enough to implement without re-reading Python.\n- Vectors cover:\n  - enabled + include_metadata=true\n  - enabled + include_metadata=false\n  - debounce=0 (always emit)\n  - debounce>0 (skip repeated)\n  - list_pending_signals filtering by project_slug\n- Regeneration notes exist (command + path).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:28:46.226613997Z","created_by":"ubuntu","updated_at":"2026-02-05T15:25:26.159461290Z","closed_at":"2026-02-05T15:25:26.159443557Z","close_reason":"Spec in EXISTING_MCP_AGENT_MAIL_STRUCTURE.md + 6 payload vectors + 7 debounce scenarios + 8 list scenarios in fixtures","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.12.1","depends_on_id":"br-2ei.12","type":"parent-child","created_at":"2026-02-05T07:28:46.226613997Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.12.2","title":"Notifications Impl: signals config + storage helpers + tool integration","description":"Implement notifications (signal files) in Rust to match legacy Python.\n\nWork:\n- Config (core): parse and store:\n  - NOTIFICATIONS_ENABLED\n  - NOTIFICATIONS_SIGNALS_DIR (tilde expansion)\n  - NOTIFICATIONS_INCLUDE_METADATA\n  - NOTIFICATIONS_DEBOUNCE_MS\n- Storage helpers (tokio-free):\n  - emit_notification_signal(config, project_slug, agent_name, message_meta) -> bool\n  - clear_notification_signal(config, project_slug, agent_name) -> bool\n  - list_pending_signals(config, project_slug?) -> Vec<serde_json::Value / struct>\n- File semantics:\n  - create parent dirs if missing\n  - atomic-ish write (write temp then rename) to avoid partial JSON\n  - JSON payload matches spec from `br-2ei.12.1`\n- Debounce:\n  - in-memory map keyed by (project_slug, agent_name)\n  - duration window uses monotonic or wall clock in a way that matches Python tests\n  - allow distinct agents even within window\n- Tool integration:\n  - `send_message`: after archive write succeeds, emit signals for `to` + `cc` recipients only\n  - `fetch_inbox`: when enabled, clear signal file for that agent best-effort\n\nConstraints:\n- Keep overhead near-zero when disabled.\n- No tokio runtime.\n\n## Acceptance Criteria\n1. Behavior matches spec/vectors from `br-2ei.12.1`.\n2. send_message emits signals for to+cc only; bcc never emits.\n3. fetch_inbox clears signals best-effort when enabled.\n4. No changes to tool outputs aside from any legacy-consistent side effects.\n5. No tokio runtime introduced.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:28:57.609595222Z","created_by":"ubuntu","updated_at":"2026-02-05T15:27:54.336935245Z","closed_at":"2026-02-05T15:27:54.336917542Z","close_reason":"Already implemented: config in core/config.rs, storage in storage/lib.rs (emit/clear/list + debounce), tools integration in messaging.rs (to+cc only, fetch_inbox clear). Tests passing.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.12.2","depends_on_id":"br-2ei.12","type":"parent-child","created_at":"2026-02-05T07:28:57.609595222Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.12.2","depends_on_id":"br-2ei.12.1","type":"blocks","created_at":"2026-02-05T07:30:09.368367845Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.12.3","title":"Notifications Tests: unit + integration (deterministic + high-signal diffs)","description":"## Objective\nUnit + integration tests for notification signals with deterministic fixtures and high‑signal diffs.\n\n## Scope\n- Validate payload schema for include_metadata on/off.\n- Debounce behavior across multiple emissions.\n- list_pending_signals parse success + error entry behavior.\n- Integration: send_message triggers signals for to+cc only; fetch_inbox clears.\n\n## Logging/Artifacts\n- Capture signal directory snapshots and JSON diffs under `tests/artifacts/notifications/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:29:06.075726731Z","created_by":"ubuntu","updated_at":"2026-02-05T23:36:45.194242043Z","closed_at":"2026-02-05T23:36:45.194217237Z","close_reason":"9 notification signal tests implemented in storage crate (conformance + integration)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.12.3","depends_on_id":"br-2ei.12","type":"parent-child","created_at":"2026-02-05T07:29:06.075726731Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.12.3","depends_on_id":"br-2ei.12.2","type":"blocks","created_at":"2026-02-05T07:30:09.451503945Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.13","title":"LLM Parity: env bridge + completion helper + summarize_thread llm_mode","description":"## Objective\nImplement **LLM integration parity** (LiteLLM-like behavior) with env bridging, model selection, caching, and summarize_thread refinement.\n\n## Scope (from spec)\n- Env vars + defaults: `LLM_ENABLED`, `LLM_DEFAULT_MODEL`, `LLM_TEMPERATURE`, `LLM_MAX_TOKENS`, `LLM_CACHE_ENABLED`, `LLM_CACHE_BACKEND`, `LLM_CACHE_REDIS_URL`, `LLM_COST_LOGGING_ENABLED`.\n- Provider env bridge: GEMINI_API_KEY→GOOGLE_API_KEY, GROK_API_KEY→XAI_API_KEY (only if canonical missing).\n- Model selection: `_choose_best_available_model()` by available provider keys; `_resolve_model_alias()` for `best/auto`.\n- Completion helper: `complete_system_user` with fallback model on failure.\n- JSON parsing `_parse_json_safely` (direct → fenced → brace slice).\n- Thread summarization: heuristic summary always, optional LLM refinement with merge rules (action keywords prioritized).\n- Project similarity scoring: LLM optional with heuristic fallback.\n- Cache behavior: redis w DNS sanity check; fallback to memory on failure.\n- Cost logging: rich panel if enabled else structlog; never crash on logging errors.\n\n## Tests\n- Unit tests for env bridge + model selection + json parsing.\n- Integration tests for summarize_thread llm_mode merge behavior (stubbed LLM).\n- Conformance fixtures for deterministic LLM stub outputs (br-2ei.13.4).\n\n## Logging/Artifacts\n- Store LLM stub transcripts and JSON diffs under `tests/artifacts/llm/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-05T07:31:21.491871639Z","created_by":"ubuntu","updated_at":"2026-02-05T23:35:27.964711209Z","closed_at":"2026-02-05T23:35:27.964681303Z","close_reason":"All children done: env bridge, completion client (asupersync HttpClient), model selection, JSON parsing, merge logic, summarize_thread wired - 20+ tests","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.13","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T07:31:21.491871639Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.13","depends_on_id":"br-36w","type":"blocks","created_at":"2026-02-05T16:18:23.557570208Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.13.1","title":"LLM Spec: extract legacy llm.py behaviors + config + vectors","description":"Extract the exact legacy Python LLM behavior into a self-contained spec + vectors.\n\nLegacy sources:\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/llm.py` (env bridge, cache, cost logging, model selection, completion helper)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/config.py` (LLM settings parsing + defaults)\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/app.py` (summarize_thread llm refinement integration)\n- Tests:\n  - `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_llm_and_utils.py`\n  - `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_entrypoints_and_llm.py`\n  - `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_entry_and_llm_errors.py`\n  - `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_summarize_threads_llm_on.py`\n  - `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_summarize_threads_llm_off.py`\n\nMust capture verbatim:\n- Provider env bridge mapping table (canonical env var -> aliases) and lookup order:\n  - os.environ first, then `.env` via decouple; only set canonical if missing.\n- Model alias resolution and “choose best available model” logic (provider key precedence).\n- Cache behavior:\n  - memory vs redis backend selection\n  - redis DNS sanity check + fallback-to-local behavior\n  - log line emitted on redis fallback\n- Cost logging behavior:\n  - callback registration via litellm.success_callback\n  - log only when response_cost > 0\n  - rich panel if log_rich_enabled; otherwise structlog\n  - never crash on logging errors\n- Completion call behavior:\n  - request shape (system/user messages)\n  - fallback-to-alt-model-on-error logic\n  - output normalization rules (extract content/model/provider)\n- Summarize_thread LLM refinement:\n  - llm_mode gating (requires LLM_ENABLED)\n  - single-thread prompt + expected JSON schema\n  - merge behavior for key_points (TODO/ACTION/FIXME/NEXT/BLOCKED heuristics)\n  - multi-thread prompt + expected JSON schema\n  - summarize_thread_product follows same LLM refinement path (if WORKTREES_ENABLED)\n  - JSON parsing uses `_parse_json_safely` (raw JSON, fenced block, brace-slice)\n  - error handling/logs: thread_summary.llm_skipped + summarize_thread.llm_skipped\n\nDeliverables:\n- Add/extend an “LLM” section in `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md` with the above rules.\n- Add deterministic vectors under `crates/mcp-agent-mail-tools/tests/fixtures/llm/`:\n  - env-bridge mapping cases\n  - summarize_thread refinement response JSON samples\n\n## Acceptance Criteria\n- Spec is complete enough to implement without re-reading Python.\n- Vectors cover success + failure:\n  - missing provider keys\n  - fallback-to-alt-model path\n  - invalid JSON in refinement response\n- Spec includes guidance on how Rust should keep tests offline (stub client) while matching semantics.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:31:36.104473377Z","created_by":"ubuntu","updated_at":"2026-02-05T15:33:15.598335234Z","closed_at":"2026-02-05T15:33:15.598316619Z","close_reason":"Spec in EXISTING_MCP_AGENT_MAIL_STRUCTURE.md + 5 env bridge vectors + 10 model selection vectors + 11 JSON parsing vectors + 5 summarize response vectors","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.13.1","depends_on_id":"br-2ei.13","type":"parent-child","created_at":"2026-02-05T07:31:36.104473377Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.13.2","title":"LLM Impl: tokio-free completion client (asupersync) + summarize_thread refinement","description":"Implement legacy LLM behavior in Rust.\n\nWork:\n- Config (core): parse missing LLM env vars to match spec `br-2ei.13.1`:\n  - LLM_COST_LOGGING_ENABLED\n  - LLM_CACHE_BACKEND / LLM_CACHE_REDIS_URL\n- Provider env bridge:\n  - apply mapping table (e.g., GEMINI_API_KEY -> GOOGLE_API_KEY) at startup / before first call\n  - do not crash if .env missing\n- LLM client abstraction:\n  - introduce a small trait/interface so tests can inject a stub (no network)\n  - implement real client(s) using asupersync HTTP:\n    - at minimum: OpenAI-compatible chat completions + Google Gemini + Anthropic (as in legacy “best available” selection)\n    - implement fallback-to-alt-model selection logic\n  - normalize output into a stable struct `{content, model, provider, estimated_cost_usd?}`\n- Cache (best-effort):\n  - memory cache when enabled\n  - optional redis cache if configured and reachable; if unreachable, fall back to memory/local\n- Cost logging:\n  - when enabled, emit a single structured log event per completion with model/provider/cost when known\n  - never let logging break normal flow\n- Tool integration:\n  - `summarize_thread` supports llm_mode=true and llm_model override\n  - implement refinement step exactly like spec (parse JSON response, validate shape, merge)\n  - keep llm_mode path fully deterministic under stub client\n\nConstraints:\n- No tokio runtime.\n- No network access required for unit tests.\n\n## Acceptance Criteria\n1. `complete_system_user` works end-to-end with stub client and returns normalized output.\n2. Real client implementation uses asupersync (no reqwest/tokio).\n3. `summarize_thread` llm_mode semantics match spec and remain safe on invalid JSON (fallback behavior is spec-accurate).\n4. All new config/env behavior is covered by unit tests.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:31:48.149361512Z","created_by":"ubuntu","updated_at":"2026-02-05T16:08:02.749159340Z","closed_at":"2026-02-05T16:08:02.749141376Z","close_reason":"Implemented in crates/mcp-agent-mail-tools/src/llm.rs: env bridge, model selection, completion client (asupersync HttpClient), JSON parsing, merge logic, wired into summarize_thread. 20 tests.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.13.2","depends_on_id":"br-2ei.13","type":"parent-child","created_at":"2026-02-05T07:31:48.149361512Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.13.2","depends_on_id":"br-2ei.13.1","type":"blocks","created_at":"2026-02-05T07:32:18.795007885Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.13.3","title":"LLM Tests: env bridge + completion normalization + summarize_thread llm_mode","description":"Add comprehensive tests for LLM parity.\n\nWork:\n- Unit tests (LLM module): mirror legacy tests:\n  - provider env bridge mapping (GEMINI_API_KEY -> GOOGLE_API_KEY, etc)\n  - completion helper returns normalized fields even when provider/router is missing/unavailable\n  - cost-logging enabled path does not panic\n  - cache enabled path does not panic; redis unavailable falls back\n- Tool-level tests:\n  - `summarize_thread` multi-thread mode with llm_mode=true uses stubbed completion response JSON and returns refined aggregate keys\n  - invalid JSON refinement response triggers spec-accurate fallback (no crash)\n- Integration tests:\n  - start server with LLM enabled + stub client injected\n  - exercise `summarize_thread` and `macro_prepare_thread` llm_mode paths\n- E2E:\n  - coordinate with `br-2ei.9.7` to run a stubbed llm_mode smoke, capture tool payloads + diffs\n\n## Acceptance Criteria\n- `cargo test` includes LLM unit + tool + integration tests and passes.\n- Tests are offline/deterministic (no network, no real API keys required).\n- Failure output includes minimal diffs on JSON mismatches.\n- E2E smoke validates llm_mode flows with artifact logs under tests/artifacts/llm/.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:31:57.009703582Z","created_by":"ubuntu","updated_at":"2026-02-05T16:08:27.029825034Z","closed_at":"2026-02-05T16:08:27.029806880Z","close_reason":"20 unit tests in llm.rs covering: JSON parsing (11 vectors), model selection, env bridge, merge logic (single + multi thread), prompt building. Tests match fixture vectors.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.13.3","depends_on_id":"br-2ei.13","type":"parent-child","created_at":"2026-02-05T07:31:57.009703582Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.13.3","depends_on_id":"br-2ei.13.2","type":"blocks","created_at":"2026-02-05T07:32:18.882197533Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.13.4","title":"LLM Conformance: deterministic llm_mode fixtures (stubbed)","description":"## Objective\nDeterministic conformance fixtures for llm_mode paths using stubbed completions.\n\n## Scope\n- Fixtures: env bridge cases, model selection, json parsing fallbacks, summarize_thread responses.\n- Stubbed LLM client returns fixed outputs for known prompts.\n- Validate merge logic for key_points/action_items.\n\n## Logging/Artifacts\n- Save fixture diffs and stub transcripts under `tests/artifacts/llm/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T07:32:06.642906159Z","created_by":"ubuntu","updated_at":"2026-02-05T16:10:32.589339476Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.13.4","depends_on_id":"br-2ei.1","type":"blocks","created_at":"2026-02-05T07:32:19.053806428Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.13.4","depends_on_id":"br-2ei.13","type":"parent-child","created_at":"2026-02-05T07:32:06.642906159Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.13.4","depends_on_id":"br-2ei.13.2","type":"blocks","created_at":"2026-02-05T07:32:18.966229530Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.14","title":"TOON Output Format Parity: tools + resources (format=toon envelope)","description":"## Objective\nImplement TOON output format parity for tools and resources, including envelope, stats, and fallback behavior.\n\n## Scope (from spec)\n- Env vars: `MCP_AGENT_MAIL_OUTPUT_FORMAT`, `TOON_DEFAULT_FORMAT`, `TOON_TRU_BIN`, `TOON_BIN`, `TOON_STATS`.\n- Tool format application: if requested format=toon, encode JSON payload via external `tru` binary; on failure return JSON envelope with `toon_error`.\n- Resource format application: `format=toon` query param; synchronous encoding.\n- Envelope schema:\n  - Success: `{format:\"toon\", data:<encoded>, meta:{requested, source, encoder, toon_stats{json_tokens, toon_tokens, saved_tokens, saved_percent}, toon_stats_raw}}`\n  - Fallback: `{format:\"json\", data:<original>, meta:{requested, source, toon_error}}`\n- Stats parsing from `tru` stderr when enabled, truncated to 2000 chars on parse failure.\n\n## Tests\n- Unit tests for envelope schema and fallback when encoder missing/fails.\n- Integration tests invoking tool/resource with `format=toon` and verifying envelope.\n- Conformance fixtures comparing to legacy envelope outputs.\n\n## Logging/Artifacts\n- Store raw encoder stderr and envelope diffs under `tests/artifacts/toon/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-05T07:35:38.532820388Z","created_by":"ubuntu","updated_at":"2026-02-06T00:14:48.060557256Z","closed_at":"2026-02-06T00:14:48.060521288Z","close_reason":"All children closed (spec/impl/tests/e2e); TOON format parity implemented","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.14","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T07:35:38.532820388Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.14.1","title":"TOON Spec: extract encoder detection + envelope schema + stats + fallback","description":"Extract exact legacy Python toon-format behavior into a self-contained spec + vectors.\n\nLegacy sources:\n- `legacy_python_mcp_agent_mail_code/mcp_agent_mail/src/mcp_agent_mail/app.py`:\n  - format handling for tools (format arg)\n  - encoder detection (`_looks_like_toon_rust_encoder`)\n  - encoder invocation (`_run_toon_encode`) and stderr parsing for stats\n  - fallback behavior on encoder error\n- Resources: where query param `format=toon` is handled and how it wraps blocks\n- Config env vars:\n  - TOON_DEFAULT_FORMAT\n  - TOON_STATS\n  - TOON_TRU_BIN / TOON_BIN\n- Tests:\n  - `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/test_toon_formatting.py`\n  - `legacy_python_mcp_agent_mail_code/mcp_agent_mail/tests/e2e/test_toon_format_e2e.py`\n\nMust capture verbatim:\n- Envelope JSON shape for tools and resources:\n  - required keys: format, data, meta\n  - meta fields (encoder name, toon_stats fields, toon_error on fallback)\n- Encoder selection precedence:\n  - which env vars are consulted and in what order\n  - how “encoder looks valid” is determined\n- Stats parsing:\n  - how json_tokens/toon_tokens are extracted from stderr\n- Fallback:\n  - non-zero exit, empty stdout, missing encoder -> fall back to JSON envelope\n\nDeliverables:\n- Add a “Toon Output Format” section to `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md`.\n- Add vectors under `crates/mcp-agent-mail-tools/tests/fixtures/toon/`:\n  - sample JSON payloads and expected envelopes\n  - sample stderr lines and expected parsed stats\n\n## Acceptance Criteria\n- Spec is complete enough to implement without re-reading Python.\n- Vectors cover:\n  - successful encode\n  - encoder missing/invalid\n  - encoder returns non-zero\n  - TOON_STATS on/off\n- Spec explicitly states how resources apply toon formatting (query param).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:35:51.901356626Z","created_by":"ubuntu","updated_at":"2026-02-05T14:31:38.135865541Z","closed_at":"2026-02-05T14:31:38.135780882Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.14.1","depends_on_id":"br-2ei.14","type":"parent-child","created_at":"2026-02-05T07:35:51.901356626Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.14.2","title":"TOON Impl: format=toon wrappers for tools + resources (stub-friendly)","description":"Implement toon formatting in Rust per spec `br-2ei.14.1`.\n\nWork:\n- Config parsing (core): add missing TOON_* env vars and defaults.\n- Encoder selection + validation:\n  - resolve encoder binary path from TOON_TRU_BIN / TOON_BIN (and any legacy defaults)\n  - implement a validity check equivalent to legacy `_looks_like_toon_rust_encoder`\n- Encoder invocation:\n  - spawn encoder process with payload via stdin or args (match legacy)\n  - capture stdout/stderr + exit code\n  - parse stderr for token stats when TOON_STATS enabled\n- Envelope:\n  - wrap successful encode in {format:\"toon\", data:\"<TOON>\", meta:{...}}\n  - on failure, return JSON envelope with meta.toon_error (spec-accurate)\n- Tool integration:\n  - support `format` argument across tools (at least those in legacy tests/e2e)\n  - ideally implement as a single response-wrapper layer so all tools inherit it\n- Resource integration:\n  - support `?format=toon` query param on resources and wrap returned blocks accordingly\n\nConstraints:\n- No tokio runtime.\n- Must be testable with a stub encoder binary (no real tru required).\n\n## Acceptance Criteria\n1. Tool calls with format=toon match legacy envelopes and pass unit/integration tests.\n2. Resource reads with format=toon match legacy envelopes and pass tests.\n3. Fallback behavior on encoder failure matches spec.\n4. No impact to default JSON behavior.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:36:01.395611114Z","created_by":"ubuntu","updated_at":"2026-02-05T14:45:51.253235315Z","closed_at":"2026-02-05T14:45:51.253150725Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.14.2","depends_on_id":"br-2ei.14","type":"parent-child","created_at":"2026-02-05T07:36:01.395611114Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.14.2","depends_on_id":"br-2ei.14.1","type":"blocks","created_at":"2026-02-05T07:36:28.263232165Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.14.3","title":"TOON Tests: unit + integration + offline stub encoder","description":"Add comprehensive tests for toon formatting parity.\n\nWork:\n- Unit tests:\n  - encoder path resolution + validity check\n  - stderr stats parsing (TOON_STATS)\n  - fallback behavior on non-zero exit / missing encoder\n- Integration tests (mirror legacy `test_toon_formatting.py`):\n  - tool output envelope for format=toon (health_check)\n  - resource output envelope for format=toon (resource://projects, resource://config/environment)\n  - resource query param format=toon is honored\n  - fallback on encoder error returns JSON envelope with meta.toon_error\n- E2E-ish test (mirror legacy `test_toon_format_e2e.py` but offline):\n  - call a small sequence of tools + one resource with format=toon\n  - write a structured log artifact for debugging failures\n\nImplementation detail:\n- Provide a deterministic stub encoder for tests (script or tiny Rust test helper) that:\n  - reads JSON payload and outputs fixed toon text\n  - optionally emits token stats to stderr\n\n## Acceptance Criteria\n- `cargo test` covers toon formatting paths and passes.\n- Tests are deterministic/offline and do not require tru/toon installed.\n- Failure output includes the envelope diff and captured stub stderr.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:36:11.883852255Z","created_by":"ubuntu","updated_at":"2026-02-05T14:55:21.602314400Z","closed_at":"2026-02-05T14:55:21.602252894Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.14.3","depends_on_id":"br-2ei.14","type":"parent-child","created_at":"2026-02-05T07:36:11.883852255Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.14.3","depends_on_id":"br-2ei.14.2","type":"blocks","created_at":"2026-02-05T07:36:28.351699752Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.14.4","title":"TOON E2E: add scripts/e2e_toon.sh suite (artifacts + diffs)","description":"Add a dedicated toon-format E2E suite to prove the end-to-end behavior stays correct.\n\nScript:\n- scripts/e2e_toon.sh (wired into scripts/e2e_test.sh)\n\nFlow:\n- Start server/router in a temp workspace.\n- Run a representative set of tool calls with format=toon:\n  - health_check\n  - ensure_project\n  - register_agent\n- Read at least one resource with format=toon query param:\n  - resource://inbox/{agent}?project=...&format=toon\n- Validate:\n  - envelope shape\n  - format=\"toon\" on success\n  - fallback behavior when encoder is intentionally broken (meta.toon_error)\n\nArtifacts:\n- tests/artifacts/toon/<timestamp>/\n- Capture requests + responses and encoder stdout/stderr.\n\n## Acceptance Criteria\n- scripts/e2e_toon.sh runs via scripts/e2e_test.sh toon.\n- Script is deterministic and emits clear diffs on mismatch.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T07:36:19.307490353Z","created_by":"ubuntu","updated_at":"2026-02-05T14:57:41.529318840Z","closed_at":"2026-02-05T14:57:41.529258938Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.14.4","depends_on_id":"br-2ei.14","type":"parent-child","created_at":"2026-02-05T07:36:19.307490353Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.14.4","depends_on_id":"br-2ei.14.2","type":"blocks","created_at":"2026-02-05T07:36:28.442541944Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.14.4","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T07:36:28.528752779Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.15","title":"Resources: query-param parsing parity (format=... and legacy filters)","description":"Implement legacy query-parameter parsing for resource URIs (beyond tool filtering).\n\nScope:\n- Identify all resource query params supported by legacy Python (e.g., format=toon/json, include_bodies, urgent_only, since_ts, active_only, ttl_seconds, limit).\n- Ensure parsing is consistent across fastmcp router + resource handlers (no accidental 400s for known params).\n- Normalize/validate params exactly like legacy: defaults, error messages, and type coercions.\n\nImplementation notes:\n- Where fastmcp routing drops query params, add an adapter layer or custom parser.\n- Document supported params in a parity table and keep it in sync with conformance fixtures.\n\nTests:\n- Unit: param parsing for each resource, invalid values, missing params.\n- Conformance: add fixture cases for each resource query variant.\n- E2E: include resource queries in scripts/e2e_http.sh (or existing HTTP parity suite) with diffs on mismatch.\n\nLogging/artifacts:\n- On mismatch, emit expected vs actual JSON diffs.\n- Store HTTP transcripts under tests/artifacts/http/resources/<timestamp>/.\n\n## Acceptance Criteria\n1. All legacy-supported resource query params are parsed and honored.\n2. Invalid params yield legacy-matching errors.\n3. Conformance + E2E cover at least one query variant per resource.","status":"in_progress","priority":1,"issue_type":"task","created_at":"2026-02-05T15:14:56.963670801Z","created_by":"ubuntu","updated_at":"2026-02-05T18:03:42.184207397Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.15","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T15:14:56.963670801Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.16","title":"DB: schema migration story (sqlmodel MigrationRunner + tests)","description":"Define and implement the schema migration strategy using sqlmodel_rust (MigrationRunner), matching legacy behavior.\n\nScope:\n- Establish a migrations table/versioning scheme.\n- Ensure init is idempotent and safe on existing DBs.\n- Provide a CLI entry point if legacy supports (or document as internal).\n\nTests:\n- Unit: migration ordering + version tracking.\n- Integration: create DB at older version, run migrate, verify schema + data preserved.\n- Negative: corrupted schema, missing tables; ensure diagnostics are clear and non-destructive.\n\nLogging/artifacts:\n- Store migration logs under tests/artifacts/db/migrations/<timestamp>/.\n- On mismatch, print schema diffs (expected vs actual).\n\n## Acceptance Criteria\n1. Migrations are deterministic, idempotent, and match legacy expectations.\n2. Running migrate on a fresh DB is a no-op beyond init.\n3. Tests validate upgrade path without data loss.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T15:15:23.185487024Z","created_by":"ubuntu","updated_at":"2026-02-05T15:15:23.185487024Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.16","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T15:15:23.185487024Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.17","title":"Perf: speed up resource://file_reservations cleanup scan","description":"## Objective\nFix a real-world perf failure: `resource://file_reservations/{slug}` timed out when cleanup scanned *all* historical file_reservations rows.\n\n## Scope\n- DB: add a query that lists **unreleased** reservations (`released_ts IS NULL`) regardless of expiry, so cleanup no longer scans released history.\n- Tools resource: use the unreleased-only query for cleanup; keep output semantics unchanged.\n- Remove redundant DB queries (avoid double `list_agents`).\n\n## Perf Baseline\n- Before: `resource://file_reservations/...` hit the 60s resources/read timeout in practice (cleanup scanned full history).\n- After: should return within the MCP timeout under the same DB state.\n\n## Acceptance Criteria\n1. Cleanup loop never loads released reservations (history) into memory.\n2. Output JSON remains stable (ordering + fields).\n3. `cargo fmt --check`, `cargo clippy --all-targets -- -D warnings`, `cargo test` all PASS.","status":"closed","priority":1,"issue_type":"task","assignee":"CoralBeacon","created_at":"2026-02-06T01:10:01.002283763Z","created_by":"ubuntu","updated_at":"2026-02-06T02:18:09.295156550Z","closed_at":"2026-02-06T02:18:09.295131293Z","close_reason":"Fixed git/fs activity semantics + expires_ts clamp regression; keep unreleased-only cleanup scan; verified via fmt/check/clippy/test (mcp-agent-mail-tools)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.17","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-06T01:10:01.002283763Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2","title":"Storage: Git archive write/read pipeline + attachments","description":"Implement the git-backed mailbox archive described in EXISTING_MCP_AGENT_MAIL_STRUCTURE.md.\n\nLegacy Python writes messages + file reservations + attachments into a per-project git repo and uses it as an auditable artifact store.\n\nScope (must match legacy behavior):\n- Archive root creation + .gitattributes\n- Per-project advisory locks (.archive.lock + owner metadata)\n- Commit batching queue (max 10, max wait 50ms)\n- Message write pipeline:\n  - canonical messages/YYYY/MM/*.md\n  - agents/<Agent>/inbox + outbox copies\n  - thread digest files (messages/threads/<thread_id>.md) if present in legacy\n  - git commit message format\n- File reservation artifacts (file_reservations/<sha1(pattern)>.json + id-<id>.json)\n- Attachment pipeline:\n  - compute content hashes\n  - convert images to WebP when enabled\n  - inline small attachments (< 64KiB) into markdown\n  - keep originals when configured\n  - write manifests + audit logs\n- Read helpers for resources that include commit metadata.\n\nConstraints:\n- Prefer git2 library; avoid shelling out when possible.\n- Prefer asupersync for IO/concurrency.\n\n## Success Criteria\n1. Artifact conformance (br-2ei.1.3) can assert archive artifacts match legacy (layout + frontmatter + body + attachment manifests).\n2. E2E archive suite (br-2ei.9.2) passes and produces rich artifacts/logs.\n3. Benchmarks include archive write throughput and lock/commit batching overhead budgets.\n4. No cross-process corruption: advisory locks are cross-platform and stale-lock recovery is safe.","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-02-05T05:06:24.771240880Z","created_by":"ubuntu","updated_at":"2026-02-05T06:32:27.969412199Z","closed_at":"2026-02-05T06:32:27.969352095Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2.1","title":"Archive: initialize archive root + per-project git repos + .gitattributes","description":"Implement archive initialization in mcp-agent-mail-storage.\n\nRequirements:\n- Determine archive root from Config.storage_root (default ~/.mcp_agent_mail_git_mailbox_repo).\n- Ensure root exists.\n- For each project slug, ensure a git repo exists at <root>/<slug>/.\n- Ensure expected top-level dirs exist: agents/, messages/, attachments/, file_reservations/.\n- Write .gitattributes (at least: enforce LF for *.md and binary for images).\n- Ensure git author identity set from config (name/email) for commits.\n\nImplementation:\n- Use git2 to init and commit initial scaffolding if repo newly created.\n\nAcceptance:\n- Idempotent: calling multiple times does not change repo.\n- Unit test with temp dir.\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:09:03.245769103Z","created_by":"ubuntu","updated_at":"2026-02-05T05:54:58.115198238Z","closed_at":"2026-02-05T05:51:33.438544202Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2.1","depends_on_id":"br-2ei.2","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.1","depends_on_id":"br-2ei.2.8","type":"blocks","created_at":"2026-02-05T05:54:58.115151750Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2.2","title":"Archive: per-project advisory locks + commit batching queue","description":"Implement concurrency control for archive writes.\n\nSpec:\n- Per-project advisory lock file: <project>/.archive.lock (+ optional owner metadata JSON).\n- Commit queue batching: max 10 commits or max wait 50ms.\n- Stale lock cleanup on startup.\n\nImplementation notes:\n- Use filesystem lock (cross-platform) + busy-timeout retry. Prefer asupersync primitives if available.\n- Keep API simple for callers: `with_project_lock(project_slug, || ...)`.\n- Batching should preserve ordering for operations within a single process.\n\nAcceptance:\n- Unit tests simulate concurrent lock acquisition.\n- Bench: lock acquisition overhead is low.\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:09:10.275499179Z","created_by":"ubuntu","updated_at":"2026-02-05T05:59:10.781991766Z","closed_at":"2026-02-05T05:59:10.781924088Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2.2","depends_on_id":"br-2ei.2","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.2","depends_on_id":"br-2ei.2.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.2","depends_on_id":"br-2ei.2.8","type":"blocks","created_at":"2026-02-05T05:54:58.195154847Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2.3","title":"Archive: message write pipeline (canonical + inbox/outbox + commit) + frontmatter format","description":"Implement message archival writes that mirror legacy Python.\n\nSpec (EXISTING_MCP_AGENT_MAIL_STRUCTURE.md):\n- Canonical: messages/YYYY/MM/<timestamp>__<subject_slug>__<id>.md\n- Outbox: agents/<sender>/outbox/YYYY/MM/... (same rel path)\n- Inboxes: agents/<recipient>/inbox/YYYY/MM/...\n- Frontmatter: JSON preceded by ---json header line, then Markdown body.\n- Git commit summary: \"message <id> from <sender> to <recipients>\".\n\nInputs:\n- Message record + recipients + markdown body + attachments metadata.\n\nOutputs:\n- Files written atomically.\n- Git commit performed (or batched) and commit info stored/returned where needed.\n\nAcceptance:\n- Deterministic path + slug generation.\n- Conformance can assert files exist and parse.\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:09:23.321591344Z","created_by":"ubuntu","updated_at":"2026-02-05T05:59:12.811257421Z","closed_at":"2026-02-05T05:59:12.811191858Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2.3","depends_on_id":"br-2ei.2","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.3","depends_on_id":"br-2ei.2.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.3","depends_on_id":"br-2ei.2.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.3","depends_on_id":"br-2ei.2.8","type":"blocks","created_at":"2026-02-05T05:54:58.279552433Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2.4","title":"Archive: file reservation artifacts (sha1(pattern).json + id-<id>.json)","description":"Implement archive writes for file reservations.\n\nSpec:\n- file_reservations/<sha1(path_pattern)>.json\n- file_reservations/id-<id>.json\n\nRequirements:\n- JSON includes {id, agent, path_pattern, exclusive, reason, created_ts, expires_ts, released_ts} at minimum.\n- Writes are atomic.\n- Archive writes happen on reservation create/update/release and are committed (or batched).\n\nAcceptance:\n- Resource `resource://file_reservations/{slug}` can be backed by archive artifacts (optional) and/or DB.\n- Conformance can assert artifact existence.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:09:35.083785229Z","created_by":"ubuntu","updated_at":"2026-02-05T05:59:15.036374259Z","closed_at":"2026-02-05T05:59:15.036307894Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2.4","depends_on_id":"br-2ei.2","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.4","depends_on_id":"br-2ei.2.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.4","depends_on_id":"br-2ei.2.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.4","depends_on_id":"br-2ei.2.8","type":"blocks","created_at":"2026-02-05T05:54:58.363912498Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2.5","title":"Archive: attachment pipeline (hashing, WebP conversion, manifests, inline small)","description":"Implement attachment handling for both tool message sending and share/export.\n\nSpec:\n- attachments/<sha1[:2]>/<sha1>.webp\n- attachments/originals/<sha1[:2]>/<sha1>.<ext>\n- attachments/_manifests/<sha1>.json\n- attachments/_audit/<sha1>.log\n\nBehavior:\n- Convert images to WebP when enabled; disable when stderr not tty? (mirror legacy policy).\n- Inline attachments <= 64KiB into markdown; store larger attachments as files and reference via manifest.\n- Optionally keep originals.\n- Ensure deterministic hashing + stable paths.\n\nAcceptance:\n- Conformance can assert archive artifacts and message frontmatter attachment refs.\n- Works cross-platform.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:09:49.770615401Z","created_by":"ubuntu","updated_at":"2026-02-05T06:05:10.101840243Z","closed_at":"2026-02-05T06:05:10.101777995Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2.5","depends_on_id":"br-2ei.2","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.5","depends_on_id":"br-2ei.2.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.5","depends_on_id":"br-2ei.2.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.5","depends_on_id":"br-2ei.2.3","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.5","depends_on_id":"br-2ei.2.8","type":"blocks","created_at":"2026-02-05T05:54:58.445702962Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2.6","title":"Archive: read helpers + commit metadata (mailbox-with-commits/outbox/inbox views)","description":"Implement archive reads used by resources that include commit context.\n\nScope:\n- Given a canonical message path, map to git commit that introduced it.\n- Provide lightweight commit metadata (sha, summary, authored_ts) for mailbox/outbox views.\n- Support `whois(include_recent_commits=true)` by reading recent archive commits filtered by author.\n\nImplementation:\n- Prefer git2 for log traversal.\n- Cache where sensible to avoid O(N) per request.\n\nAcceptance:\n- Resource outputs match legacy Python shapes for mailbox-with-commits and whois.\n- Benchmarks cover common read paths.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:10:02.774438616Z","created_by":"ubuntu","updated_at":"2026-02-05T06:08:17.925340091Z","closed_at":"2026-02-05T06:08:17.925279166Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2.6","depends_on_id":"br-2ei.2","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.6","depends_on_id":"br-2ei.2.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.6","depends_on_id":"br-2ei.2.3","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2.7","title":"Reservations: implement force_release_file_reservation (inactivity heuristics + optional notify)","description":"Implement force-release stale file reservations (MCP tool).\n\nSpec:\n- Validate reservation appears abandoned:\n  - agent inactive beyond threshold\n  - no recent mail activity\n  - no recent filesystem/git activity (archive)\n- When released, optionally notify previous holder with a human-readable note.\n\nImplementation plan:\n- Define which activity signals we can reliably measure in Rust:\n  - `agent.last_active_ts` in DB\n  - last message activity timestamps (inbox/outbox/canonical)\n  - archive activity timestamps (last commit touching agent/mail artifacts)\n- Implement heuristics with conservative defaults and an explicit “why” explanation string.\n- Write release to DB + archive artifacts (so humans can audit forced releases).\n- If `notify_previous=true`: send a threaded message to the previous holder explaining the forced release and including the heuristics snapshot.\n\n## Acceptance Criteria\n- Safety / correctness:\n  - Force-release is denied unless heuristics strongly indicate abandonment (tests cover deny path).\n  - When allowed, release updates both DB state and archive artifacts (tests assert both).\n  - No-op behavior when reservation already released/expired is well-defined.\n- Observability:\n  - Tool output includes a machine-parseable explanation (what signals were checked + thresholds + timestamps used).\n  - Optional notify message includes the explanation and the operator’s note.\n- Conformance:\n  - Fixture-based conformance tests cover at least: allow path, deny path, and allow-with-notify path.\n- Tests:\n  - Unit tests cover heuristic evaluation boundary conditions (just-below/just-above thresholds).\n  - Integration test runs through the full tool pipeline and validates resulting archive messages + reservation state.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:10:29.903046515Z","created_by":"ubuntu","updated_at":"2026-02-05T06:30:28.285447850Z","closed_at":"2026-02-05T06:30:28.285367769Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2.7","depends_on_id":"br-2ei.2","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.7","depends_on_id":"br-2ei.2.4","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.2.7","depends_on_id":"br-2ei.2.6","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.2.8","title":"Archive spec: exact paths/frontmatter/commit + .gitattributes + attachment policy","description":"Extract the exact legacy git-archive behavior into a self-contained spec + test vectors.\n\nMust extract verbatim from legacy Python:\n- Archive root path rules (defaults + env/CLI overrides)\n- Repo initialization behavior:\n  - exact directory layout\n  - exact .gitattributes content (line endings + binary rules)\n  - initial commit behavior + message (if any)\n- Message path format rules:\n  - timestamp formatting\n  - subject slug rules (unicode, punctuation, truncation)\n  - ID formatting\n- Frontmatter format:\n  - exact header line(s)\n  - JSON formatting rules (pretty vs compact, key ordering if any)\n  - trailing newlines\n- Outbox/inbox copy rules\n- Commit batching semantics (what gets grouped into a commit, commit message format)\n- Reservation artifact JSON schema and naming (sha1 inputs, casing)\n- Attachment policy:\n  - hashing algorithm(s)\n  - WebP conversion policy triggers\n  - inline thresholds and exact markdown embedding format\n  - manifest/audit log formats\n\nDeliverables:\n- Explicit spec section in EXISTING_MCP_AGENT_MAIL_STRUCTURE.md (or equivalent) with concrete examples.\n- Test vectors for slug/frontmatter and a golden file tree for 1-2 representative messages.\n\nAcceptance:\n- Implementers can build br-2ei.2.* without consulting Python again.\n- Unit tests can assert byte-for-byte markdown + JSON artifact equality.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:54:29.422073298Z","created_by":"ubuntu","updated_at":"2026-02-05T05:59:38.804611487Z","closed_at":"2026-02-05T05:59:38.804548929Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.2.8","depends_on_id":"br-2ei.2","type":"parent-child","created_at":"2026-02-05T05:54:29.422073298Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.3","title":"Guard: pre-commit/pre-push enforcement + install/uninstall tooling","description":"Implement the Agent Mail guard system (pre-commit / pre-push hooks) that prevents edits when exclusive file reservations conflict.\n\nSpec source:\n- EXISTING_MCP_AGENT_MAIL_STRUCTURE.md section \"Guard Behavior (Pre-Commit / Pre-Push)\"\n\nScope:\n- `mcp-agent-mail-guard` crate:\n  - install_guard(project, repo): resolves hooks dir (core.hooksPath or default), writes chain-runner hooks, writes plugin scripts under hooks.d/<hook>.\n  - uninstall_guard(repo): removes our plugins; removes chain-runner only if safe (no other plugins) and restores .orig if applicable.\n  - guard_status(repo): reports resolved hooks path + presence of pre-commit/pre-push + mode.\n  - guard_check(repo, paths, advisory): checks active file reservations and returns conflicts (pattern, holder, expires_ts).\n- MCP tools:\n  - install_precommit_guard(project_key, code_repo_path)\n  - uninstall_precommit_guard(code_repo_path)\n- CLI wiring:\n  - `am guard install|uninstall|status|check` delegates to the guard crate.\n\nImplementation notes:\n- Use git2 to discover repo + read config.\n- Path matching: prefer pathspec (gitignore syntax) with symmetric fnmatch fallback.\n- Must respect env vars: AGENT_MAIL_GUARD_MODE, AGENT_MAIL_BYPASS, AGENT_NAME.\n\n## Success Criteria\n1. Guard tool outputs match legacy fixtures (install/uninstall/status/check).\n2. Unit + integration tests cover: hooksPath/worktrees, idempotent install/uninstall, path matching, rename handling, conflict detection.\n3. E2E guard suite (br-2ei.9.3) blocks commits on conflicts and allows after release, with clear stderr and rich artifacts.","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-02-05T05:06:34.458664027Z","created_by":"ubuntu","updated_at":"2026-02-05T06:32:18.466527207Z","closed_at":"2026-02-05T06:32:18.466466844Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.3","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.3.1","title":"Guard: resolve repo + hooks dir (core.hooksPath, worktrees) via git2","description":"Implement robust hooks directory resolution.\n\nRequirements:\n- Input: repo working tree path (code_repo_path).\n- Discover git repo (supports worktrees).\n- Determine hooks dir:\n  - If core.hooksPath is set: resolve relative to repo root per git semantics.\n  - Else: use default hooks dir for the repository common dir.\n- Return resolved hooks_dir as a real filesystem path.\n\nMust handle:\n- .git is a file containing gitdir: ...\n- worktrees where hooks live in common dir\n- bare repo (if encountered) -> treat as invalid for hook install\n\nDeliverable:\n- `mcp_agent_mail_guard::resolve_hooks_dir(repo: &Path) -> GuardResult<PathBuf>` (or equivalent internal helper) with unit tests.\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:07:47.277296976Z","created_by":"ubuntu","updated_at":"2026-02-05T05:18:05.735479435Z","closed_at":"2026-02-05T05:18:05.735461692Z","close_reason":"Implemented resolve_hooks_dir via git2 + commondir parsing; added unit tests incl. worktree case.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.3.1","depends_on_id":"br-2ei.3","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.3.2","title":"Guard: install/uninstall chain-runner hooks + agent-mail plugin scripts","description":"Implement install/uninstall mechanics (pre-commit and optionally pre-push).\n\nInstall behavior (match legacy):\n- Ensure hooks.d/<hook>/ directory exists.\n- Write/overwrite top-level hook script (chain-runner) that executes hooks.d/<hook>/* in lexical order.\n- Preserve existing non-chain hook as <hook>.orig.\n- Install our plugin under hooks.d/<hook>/50-agent-mail (or equivalent) that executes the actual guard check.\n- Create Windows shims (.cmd/.ps1) if needed to invoke the chain-runner.\n\nUninstall behavior:\n- Remove our plugins (hooks.d/<hook>/50-agent-mail.*).\n- Only remove chain-runner if it is ours AND there are no other plugins remaining AND no .orig restoration is needed.\n- If .orig exists and chain-runner is removed, restore it.\n\nDeliverables:\n- `install_guard(project_key, repo)` writes files and chmods +x on unix.\n- `uninstall_guard(repo)` removes/restores safely.\n- Unit tests use temp git repos.\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:08:05.382529734Z","created_by":"ubuntu","updated_at":"2026-02-05T05:25:45.469594914Z","closed_at":"2026-02-05T05:25:45.469578243Z","close_reason":"Implemented install_guard/uninstall_guard: resolves hooks dir, installs python chain-runner + Windows shims, installs plugin stub, preserves/restores existing hook via .orig; added unit test for preserve/restore.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.3.2","depends_on_id":"br-2ei.3","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.3.2","depends_on_id":"br-2ei.3.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.3.3","title":"Guard: implement conflict detection (reservations + path matching + rename handling)","description":"Implement the actual guard decision logic.\n\nInputs:\n- repo path\n- list of paths to check (from staged diff for pre-commit, from commit range for pre-push)\n- AGENT_NAME env var identifies current agent\n- mode: block vs warn (AGENT_MAIL_GUARD_MODE)\n- bypass env: AGENT_MAIL_BYPASS=1\n\nLogic:\n- If guard disabled (WORKTREES_ENABLED or GIT_IDENTITY_ENABLED false): allow.\n- Load active file reservations for the project identity associated with repo (project_identity_mode logic).\n- If any exclusive reservation matches any path (symmetric matching) and reservation holder != AGENT_NAME and unexpired: conflict.\n- For renames: treat both old and new paths as touched.\n\nDeliverables:\n- Pure function that returns conflicts (pattern, holder, expires_ts) for a given path list.\n- Helper to obtain staged paths from git: `git diff --cached --name-only -z --diff-filter=ACMRDTU` and rename pairs from `--name-status -M -z`.\n- Helper to obtain pre-push paths from stdin refs (`git rev-list`) with fallback to `git diff --name-status -M -z <remote>..<local>`.\n\nTests:\n- Synthetic reservations + path lists.\n- Temp repo with staged rename.\n\n## Acceptance Criteria\n1. Guard conflict detection matches legacy behavior for:\n   - exclusive vs shared reservations\n   - holder == AGENT_NAME bypass\n   - expired/released reservations\n   - rename pairs (old + new paths considered touched)\n2. Unit tests cover synthetic and real-repo staged rename scenarios.\n3. Hook output is clear enough that the E2E guard suite can assert expected failure messaging.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:08:19.800578519Z","created_by":"ubuntu","updated_at":"2026-02-05T06:16:39.864330762Z","closed_at":"2026-02-05T06:16:39.864261040Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.3.3","depends_on_id":"br-2ei.3","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.3.3","depends_on_id":"br-2ei.3.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.3.4","title":"Guard Tools: install_precommit_guard/uninstall_precommit_guard wiring","description":"Wire MCP tools to the Rust guard crate (fixture generation + conformance assertions live under br-2ei.1.*; keep this issue implementation-only).\n\nTools:\n- install_precommit_guard(project_key, code_repo_path)\n- uninstall_precommit_guard(code_repo_path)\n\nRequirements:\n- Call into mcp-agent-mail-guard for repo discovery + hooks dir resolution.\n- Idempotent + safe:\n  - Install preserves existing hooks and writes chain-runner + agent-mail plugin(s).\n  - Uninstall removes only agent-mail components; restores preserved hooks when applicable.\n- Error parity:\n  - Invalid repo paths, non-repo dirs, permission errors map to the same error semantics as legacy.\n- Output parity:\n  - JSON-RPC result shape must match legacy fixtures exactly.\n\nTests:\n- Unit tests: parameter validation + error mapping.\n- Integration test: temp git repo, run tool handler install then uninstall, assert expected hook files created/removed.\n\n## Acceptance Criteria\n1. Tool handlers call mcp-agent-mail-guard and are idempotent and safe (no clobber of existing hooks).\n2. Errors for invalid paths/non-repos/permission issues match legacy (status + message shape).\n3. Unit + integration tests cover install/uninstall success, preserve/restore behavior, and error mapping.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:08:32.548948635Z","created_by":"ubuntu","updated_at":"2026-02-05T06:25:07.728723226Z","closed_at":"2026-02-05T06:25:07.728662662Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.3.4","depends_on_id":"br-2ei.3","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.3.4","depends_on_id":"br-2ei.3.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.3.5","title":"Guard: add unit + integration tests (git repos, worktrees, hooksPath, conflicts)","description":"Add focused tests to ensure guard behavior remains correct.\n\nTests should cover:\n- hooks dir resolution: default vs core.hooksPath vs worktree common dir.\n- install/uninstall idempotency and preservation of existing hooks.\n- path matching: pathspec (if enabled) vs fnmatch fallback.\n- conflict detection: exclusive reservations by other agent blocks; shared reservations do not.\n- rename pairs considered touched.\n\n## Acceptance Criteria\n1. `cargo test -p mcp-agent-mail-guard` includes unit + integration coverage for the above behaviors.\n2. Tests include detailed assertions/messages so failures show exact mismatch (paths, patterns, holder, env mode).\n3. Tests run in temp dirs and are hermetic (no reliance on developer machine state).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:08:46.185640629Z","created_by":"ubuntu","updated_at":"2026-02-05T06:17:15.030854934Z","closed_at":"2026-02-05T06:17:15.030779843Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.3.5","depends_on_id":"br-2ei.3","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.3.5","depends_on_id":"br-2ei.3.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.3.5","depends_on_id":"br-2ei.3.3","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4","title":"Share/Export: static bundle pipeline (SQLite snapshot + scrub + attachments + signing/encryption)","description":"Port legacy share/export pipeline to Rust (mcp-agent-mail-share + CLI).\n\nSpec source:\n- EXISTING_MCP_AGENT_MAIL_STRUCTURE.md section \"Share / Export Pipeline (Static Bundle)\"\n\nScope:\n- Snapshot SQLite safely (WAL checkpoint + sqlite backup) into export DB.\n- Apply project scoping (delete rows from other projects).\n- Scrub presets: standard/strict/archive.\n- Build FTS + materialized views; add indexes.\n- Finalize DB for export (journal_mode=DELETE, page_size=1024, VACUUM, ANALYZE).\n- Bundle attachments:\n  - Inline <= 64KiB\n  - Detach >= 25MiB\n  - Copy others into attachments/<sha256[:2]>/<sha256>.<ext>\n  - Rewrite messages.attachments JSON to bundle paths / data URIs\n- Chunk DB if >= 20MiB.\n- Bundle scaffolding: manifest.json, README, deploy hints, _headers.\n- Optional: sign manifest (Ed25519), encrypt bundle (age), package zip.\n\nConstraints:\n- Prefer sqlmodel_rust for SQLite operations.\n- Prefer asupersync for IO.\n\n## Success Criteria\n1. CLI share commands work end-to-end and match legacy behavior where specified.\n2. Bundle output is deterministic for identical inputs (stable ordering + hashing).\n3. E2E share suite (br-2ei.9.4) passes and produces a verifiable bundle tree + hashes.\n4. Benchmarks exist for share/export throughput and enforce regression budgets.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-05T05:06:43.381856509Z","created_by":"ubuntu","updated_at":"2026-02-05T14:22:00.077127Z","closed_at":"2026-02-05T14:22:00.077065013Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.1","title":"Share: SQLite snapshot + project scoping (WAL checkpoint + backup)","description":"Implement share/export phase 1: snapshot + project scoping.\n\nThis task consumes the extracted spec from `br-2ei.4.7`.\n\nWork (in `crates/mcp-agent-mail-share/`):\n- Open the live SQLite DB via `sqlmodel_rust` with appropriate busy-timeout.\n- Perform legacy-equivalent WAL checkpoint behavior before snapshot.\n- Use the SQLite backup API to create an export DB file (no mutation of live DB).\n- Apply project scoping rules to the export DB:\n  - delete rows for non-selected projects per spec\n  - preserve referential integrity (foreign keys / cascade behavior per spec)\n- Run any required integrity checks on the export DB (per spec).\n\n## Acceptance Criteria\n- Export DB creation is read-only w.r.t. the live DB (unit test asserts live DB unchanged).\n- Export DB passes `PRAGMA integrity_check` (and any other required PRAGMAs from spec).\n- Scoping correctness:\n  - Given a fixture DB with multiple projects + cross-table references, the scoped export contains only the selected project(s) and no dangling references.\n  - Exact table list + deletion semantics match the spec from `br-2ei.4.7`.\n- Determinism:\n  - Snapshot+scope on the same fixture produces a stable sha256 for the resulting DB file (after any required normalize/finalize steps for this phase).\n- Tests:\n  - Unit tests cover: busy/locked DB behavior, multi-project scoping, and integrity checks.\n  - Conformance fixture comparison is wired (Rust output vs Python fixture) for at least one scoped DB.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:12:07.493892557Z","created_by":"ubuntu","updated_at":"2026-02-05T08:09:50.930750975Z","closed_at":"2026-02-05T08:09:50.930719165Z","close_reason":"Implemented create_sqlite_snapshot (VACUUM INTO) + apply_project_scope with 8 tests (3 snapshot + 4 scope + 1 conformance against Python fixture). All passing.","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.1","depends_on_id":"br-2ei.4","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.1","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T05:55:07.893842107Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.2","title":"Share: scrub presets (standard/strict/archive)","description":"Implement scrub logic on the scoped export DB.\n\nThis task must follow the extracted scrub rules from `br-2ei.4.7` exactly.\n\nPresets:\n- `standard`: remove obvious secrets, keep most content\n- `strict`: more aggressive scrubbing/redaction\n- `archive`: minimal/none (match legacy precisely)\n\nDeliverable (in `crates/mcp-agent-mail-share/`):\n- Deterministic scrub transformations for each preset.\n- A single entrypoint that takes (export_db_path, preset, scrub_seed/config) and produces a scrubbed DB (in-place or copy per spec).\n\n## Acceptance Criteria\n- Parity:\n  - For every preset, the scrub operations match the per-table/per-column rules extracted in `br-2ei.4.7`.\n  - “Delete vs redact” decisions match legacy.\n- Determinism:\n  - Running scrub twice on the same input DB yields byte-identical scrubbed DB output (or stable sha256 if finalization steps change file layout).\n  - Any ordering/normalization rules required for determinism are implemented and documented.\n- Tests:\n  - Unit tests cover each preset against conformance fixture DBs (from `br-2ei.4.7`) and assert expected hashes.\n  - Edge-case tests cover: NULLs, empty strings, unicode text, large blobs, missing optional tables/columns (if legacy tolerates).\n- Safety:\n  - Scrub does not panic on unexpected rows; it either scrubs conservatively or fails with a clear error that is surfaced to caller.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:12:12.920255187Z","created_by":"ubuntu","updated_at":"2026-02-05T08:15:01.040933972Z","closed_at":"2026-02-05T08:15:01.040873117Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.2","depends_on_id":"br-2ei.4","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.2","depends_on_id":"br-2ei.4.1","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.2","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T05:55:07.981100993Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.3","title":"Share: build FTS/views + export-finalize DB (indexes, journal_mode=DELETE, VACUUM, ANALYZE)","description":"Implement export DB finalization (FTS, views, indexes, and compacting).\n\nThis task consumes:\n- The scoped+scrubbed export DB produced by `br-2ei.4.1` + `br-2ei.4.2`.\n- The DDL/PRAGMA ordering spec extracted in `br-2ei.4.7`.\n\nWork (in `crates/mcp-agent-mail-share/`):\n- Build any required FTS index(es) and materialized views used by the static viewer.\n- Add export-only indexes (e.g., `subject_lower`, `sender_lower`) exactly as specified.\n- Apply export-finalize pragmas (e.g., `journal_mode=DELETE`, `page_size=1024`, and any `synchronous` choice per spec).\n- Run `VACUUM` + `ANALYZE` in the correct order.\n\n## Acceptance Criteria\n- Functional:\n  - Viewer-critical queries work against the finalized DB (unit test executes a representative set of queries and asserts expected row counts).\n  - FTS searches return expected results on a fixture DB.\n- Integrity + portability:\n  - Finalized DB passes `PRAGMA integrity_check`.\n  - Finalized DB opens in `sqlite3` CLI (sanity) and is not tied to WAL side files.\n- Determinism:\n  - Finalization produces stable output for the same input fixture (stable sha256 for resulting DB file).\n- Performance:\n  - Finalization time for a small fixture stays under an explicit budget (tracked in benchmark task `br-2ei.7.3`).\n- Tests:\n  - Unit tests cover: FTS DDL application, index creation, and VACUUM/ANALYZE ordering.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:12:24.355619779Z","created_by":"ubuntu","updated_at":"2026-02-05T08:19:23.533636149Z","closed_at":"2026-02-05T08:19:23.533568121Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.3","depends_on_id":"br-2ei.4","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.3","depends_on_id":"br-2ei.4.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.3","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T05:55:08.066003069Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.4","title":"Share: bundle attachments + rewrite messages.attachments JSON","description":"Implement attachment bundling + `messages.attachments` rewrite for share/export.\n\nThis epic splits the work so multiple agents can implement in parallel without stepping on each other.\n\nChild tasks:\n- `br-2ei.4.4.1`: attachment bundling pipeline (hashing, inline/detach decision, path layout, copying/dedupe).\n- `br-2ei.4.4.2`: rewrite `messages.attachments` JSON in the export DB to bundle references (schema + ordering) and validate references.\n\nNotes:\n- Thresholds/semantics MUST come from the legacy spec in `br-2ei.4.7` (do not guess).\n- Output must be deterministic (stable ordering, stable paths).\n\n## Success Criteria\n1. All child tasks are complete.\n2. Unit tests cover threshold boundaries, stable path layout, duplicate reuse, and stable JSON rewrite ordering.\n3. Share/export E2E (`br-2ei.9.4`) proves:\n   - bundle contains all referenced attachment paths\n   - detached attachments are represented exactly as legacy expects\n   - determinism holds across two exports from identical inputs","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-05T05:12:37.955382434Z","created_by":"ubuntu","updated_at":"2026-02-05T14:05:14.902960589Z","closed_at":"2026-02-05T14:05:14.902899625Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.4","depends_on_id":"br-2ei.2.5","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.4","depends_on_id":"br-2ei.4","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.4","depends_on_id":"br-2ei.4.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.4","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T05:55:08.149056843Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.4.1","title":"Share Attachments: bundling pipeline (hashing + copy/dedupe + inline/detach)","description":"Implement the attachment bundling pipeline for share/export.\n\nWork:\n- Decide representation for each attachment (per spec `br-2ei.4.7`):\n  - inline as `data:` URI when <= threshold\n  - detached marker when >= threshold\n  - otherwise copy into deterministic content-addressed path layout\n- Copy files into the bundle (deterministic naming) and dedupe identical content.\n- Produce a machine-usable bundling index (hash -> bundle path / inline / detached marker) for downstream rewrite step.\n\n## Acceptance Criteria\n- Threshold boundaries match the legacy spec exactly (no hard-coded guessing).\n- Paths are deterministic and content-addressed.\n- Duplicate attachments are not recopied.\n- Missing files are handled per spec (clear error or “missing marker” if legacy tolerates).\n- Unit tests cover:\n  - inline boundary\n  - detach boundary\n  - dedupe behavior\n  - extension inference rules (if any)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:03:30.718092122Z","created_by":"ubuntu","updated_at":"2026-02-05T08:26:49.552943955Z","closed_at":"2026-02-05T08:26:49.552857672Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.4.1","depends_on_id":"br-2ei.4.2","type":"blocks","created_at":"2026-02-05T07:03:38.917255798Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.4.1","depends_on_id":"br-2ei.4.4","type":"parent-child","created_at":"2026-02-05T07:03:30.718092122Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.4.1","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T07:03:39.002849166Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.4.2","title":"Share Attachments: rewrite messages.attachments JSON in export DB","description":"Rewrite `messages.attachments` JSON in the export DB to reference bundled attachment representations.\n\nWork:\n- Parse legacy attachment JSON schema from the export DB rows.\n- Rewrite per attachment to:\n  - bundle-relative path\n  - inline `data:` URI\n  - detached marker/metadata\n- Preserve legacy schema + ordering rules exactly.\n- Validate that rewritten references resolve against the bundle output produced by `br-2ei.4.4.1`.\n\n## Acceptance Criteria\n- JSON rewrite output matches the legacy schema and ordering rules (spec `br-2ei.4.7`).\n- No broken references: every non-detached reference resolves to a file present in the bundle.\n- Invalid/unknown JSON is handled per spec (fail-fast vs best-effort).\n- Unit tests cover:\n  - ordering determinism\n  - mixed inline/file/detached cases\n  - malformed JSON handling\n- Integration test runs against a fixture DB with attachments and asserts expected rewritten JSON + hashes.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:03:52.101600759Z","created_by":"ubuntu","updated_at":"2026-02-05T14:04:44.034479958Z","closed_at":"2026-02-05T14:04:44.034420727Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.4.2","depends_on_id":"br-2ei.4.4","type":"parent-child","created_at":"2026-02-05T07:03:52.101600759Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.4.2","depends_on_id":"br-2ei.4.4.1","type":"blocks","created_at":"2026-02-05T07:03:58.881861480Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.5","title":"Share: chunking + manifest/scaffolding + viewer assets","description":"Finish share/export bundle packaging after export DB + bundled attachments are ready.\n\nThis epic is split to enable parallel implementation:\n- `br-2ei.4.5.1`: chunking engine + chunk config writer (large DB path)\n- `br-2ei.4.5.2`: viewer assets integration + static hosting headers\n- `br-2ei.4.5.3`: manifest + scaffolding (README/_headers) + determinism glue\n\nNotes:\n- Thresholds and manifest schema MUST come from the extracted spec in `br-2ei.4.7`.\n- Determinism is mandatory: stable file ordering + stable manifest ordering.\n\n## Success Criteria\n1. All child tasks are complete.\n2. Bundle directory is self-contained and previewable.\n3. `manifest.json` conforms to the legacy schema and is deterministically serialized.\n4. Chunking works for the threshold boundary cases and is reflected in the manifest.\n5. Share/export E2E (`br-2ei.9.4`) passes and produces stable hashes across two identical runs.","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-02-05T05:12:55.110282213Z","created_by":"ubuntu","updated_at":"2026-02-05T14:16:17.477136091Z","closed_at":"2026-02-05T14:16:17.477037476Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.5","depends_on_id":"br-2ei.4","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5","depends_on_id":"br-2ei.4.3","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5","depends_on_id":"br-2ei.4.4","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T05:55:08.236817675Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.5.1","title":"Share Bundle: DB chunking engine + chunk config writer","description":"Implement the “large DB” chunking path for share/export.\n\nWork:\n- If DB size exceeds the legacy threshold (spec `br-2ei.4.7`), split DB into `chunks/`.\n- Emit any required chunk config file (e.g., `mailbox.sqlite3.config.json`) with deterministic ordering.\n- Ensure chunk naming and boundaries are deterministic.\n\n## Acceptance Criteria\n- Threshold and output layout match the legacy spec exactly.\n- Below threshold: no chunking outputs emitted (unless legacy does).\n- Above threshold: bundle contains deterministic `chunks/` layout + required config.\n- Unit tests cover threshold boundary cases and deterministic naming.\n- Integration test verifies chunked bundle can still be queried/used by the viewer (basic sanity query).","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T07:04:20.724767495Z","created_by":"ubuntu","updated_at":"2026-02-05T14:08:33.267369554Z","closed_at":"2026-02-05T14:08:33.267305123Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.5.1","depends_on_id":"br-2ei.4.3","type":"blocks","created_at":"2026-02-05T07:04:33.635936135Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5.1","depends_on_id":"br-2ei.4.5","type":"parent-child","created_at":"2026-02-05T07:04:20.724767495Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5.1","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T07:04:33.722371550Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.5.2","title":"Share Bundle: viewer assets integration + static hosting headers","description":"Integrate the static viewer assets into the share/export bundle.\n\nWork:\n- Copy/embed viewer HTML/CSS/JS assets into the bundle with legacy-correct paths.\n- Emit any static-hosting metadata required by legacy (e.g., `_headers`).\n- Ensure assets are deterministic (stable file ordering, stable content).\n\n## Acceptance Criteria\n- Asset set + paths match the legacy spec in `br-2ei.4.7`.\n- Fetching the viewer entry page resolves all referenced assets within the bundle.\n- Headers metadata is emitted exactly as expected (cache-control/content-type rules).\n- Unit/integration tests validate:\n  - required files present\n  - expected content-type mapping or header rules","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T07:04:49.375227530Z","created_by":"ubuntu","updated_at":"2026-02-05T14:13:20.955943069Z","closed_at":"2026-02-05T14:13:20.955882986Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.5.2","depends_on_id":"br-2ei.4.5","type":"parent-child","created_at":"2026-02-05T07:04:49.375227530Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5.2","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T07:04:54.689274505Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.5.3","title":"Share Bundle: manifest.json + scaffolding (README/_headers) + determinism glue","description":"Write the final bundle scaffold and `manifest.json` for share/export.\n\nWork:\n- Write `manifest.json` per legacy schema (spec `br-2ei.4.7`), including:\n  - export_config\n  - project_scope\n  - scrub preset + version\n  - DB metadata (sizes/hashes; chunks metadata when chunked)\n  - attachment metadata/hashes\n  - viewer/runtime flags\n  - hosting hints (detected targets + signals) when present\n- Ensure deterministic serialization:\n  - stable key ordering\n  - stable array ordering\n- Write bundle README / HOW_TO_DEPLOY with “how to preview/deploy”, including legacy hosting hints:\n  - Cloudflare Pages / Netlify / AWS S3 signals and the corresponding deploy steps\n- Ensure `_headers`/static-hosting metadata and viewer assets are referenced correctly (and are written exactly like legacy when applicable).\n\n## Acceptance Criteria\n- `manifest.json` conforms to the legacy schema and is deterministically serialized.\n- Manifest includes hashes for DB (and chunks when present) and bundled attachments per spec.\n- README/HOW_TO_DEPLOY + headers scaffolding exists and is correct per legacy spec (including hosting hints/signals).\n- Unit tests cover:\n  - manifest determinism (serialize twice -> identical)\n  - chunked vs non-chunked manifest variants\n  - required fields presence\n- E2E `br-2ei.9.4` can validate determinism across two exports from identical inputs.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T07:05:07.782474918Z","created_by":"ubuntu","updated_at":"2026-02-05T14:16:17.377020775Z","closed_at":"2026-02-05T14:16:17.376952517Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.5.3","depends_on_id":"br-2ei.4.3","type":"blocks","created_at":"2026-02-05T07:05:16.810266743Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5.3","depends_on_id":"br-2ei.4.4.2","type":"blocks","created_at":"2026-02-05T07:05:16.895398721Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5.3","depends_on_id":"br-2ei.4.5","type":"parent-child","created_at":"2026-02-05T07:05:07.782474918Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5.3","depends_on_id":"br-2ei.4.5.1","type":"blocks","created_at":"2026-02-05T07:05:16.980221638Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5.3","depends_on_id":"br-2ei.4.5.2","type":"blocks","created_at":"2026-02-05T07:05:17.064353973Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.5.3","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T07:05:17.145302228Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.6","title":"Share: optional signing (Ed25519) + encryption (age) + zip packaging","description":"Implement optional bundle hardening features (signing, encryption, zip packaging).\n\nThis task extends the plain directory bundle from `br-2ei.4.5`.\n\nWork (in `crates/mcp-agent-mail-share/`):\n- Signing (Ed25519):\n  - Generate signing key if requested (or load provided key).\n  - Write public key into bundle.\n  - Sign `manifest.json` and include signature + metadata (algorithm, key id) per spec.\n  - Provide verify flow (`--verify` or library fn) that validates signature before use.\n- Encryption (age):\n  - Encrypt the bundle for one or more recipients.\n  - Emit `.age` output plus any required metadata.\n  - Provide decrypt flow for tests.\n- Zip packaging:\n  - Package bundle into zip (or tar) with stable ordering + timestamps as required for determinism.\n\n## Acceptance Criteria\n- Roundtrip works:\n  - Signing verify succeeds for a signed bundle.\n  - Verification fails with a clear error for a tampered manifest.\n  - Encryption decrypt yields byte-identical bundle output (or stable content hash if metadata differs) in test mode.\n- Determinism:\n  - Packaging output is deterministic given identical inputs (stable hash for the archive file).\n  - File ordering inside archive is stable.\n- UX:\n  - CLI flags and errors are explicit (what failed, what to do).\n  - Feature is optional and does not change default share behavior when disabled.\n- Tests:\n  - Unit tests cover sign/verify and encrypt/decrypt flows using deterministic test keys.\n  - E2E `br-2ei.9.4` covers at least one signed bundle and one encrypted bundle path (can be separate runs).","status":"closed","priority":3,"issue_type":"task","created_at":"2026-02-05T05:13:06.191406916Z","created_by":"ubuntu","updated_at":"2026-02-05T14:18:00.062072278Z","closed_at":"2026-02-05T14:18:00.061970166Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.6","depends_on_id":"br-2ei.4","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.6","depends_on_id":"br-2ei.4.5","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.6","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T05:55:08.321718960Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.7","title":"Share spec: extract scrub rules + SQL/DDL + manifest schema + vectors","description":"Extract the exact legacy share/export behavior into a self-contained spec + test vectors.\n\nThis is *spec extraction*, not implementation. The result must be detailed enough that implementers can complete `br-2ei.4.1`..`br-2ei.4.6` without re-reading Python.\n\nMust extract verbatim (copy exact SQL/DDL, constants, and ordering rules) from legacy Python:\n- SQLite snapshot procedure:\n  - WAL checkpoint details\n  - backup API usage (incl. flags / sequencing)\n  - any timeouts / retries / busy handling\n- Project scoping:\n  - tables affected\n  - exact WHERE clauses / join conditions\n  - any “include/exclude” semantics\n- Scrub presets (standard/strict/archive):\n  - exact transformations per table/column\n  - deletion vs redaction rules\n  - normalization rules (timestamps, ids, null handling, ordering)\n- FTS + views/materialization DDL\n- Export-finalize pragmas + maintenance ordering:\n  - journal_mode/page_size/synchronous\n  - VACUUM/ANALYZE ordering\n  - any integrity checks\n- Attachment bundling rules:\n  - how files are copied\n  - rewrite semantics for `messages.attachments` JSON\n- Chunking thresholds + output naming rules\n- Static hosting + deploy scaffolding:\n  - hosting-hints detection signals (Cloudflare Pages / Netlify / AWS S3) and how they’re presented\n  - `_headers` / other hosting metadata files (exact contents + when written)\n  - README/HOW_TO_DEPLOY guidance text and any env-signal heuristics\n- `manifest.json` schema:\n  - required fields\n  - stable ordering requirements (key order, array order)\n  - versioning / compatibility expectations (even if “none”)\n\nDeliverables:\n- Add/extend a dedicated “Share/Export Spec” section in `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md` with the above as an explicit checklist.\n- Add conformance fixtures for share/export (DB + expected outputs) under `crates/mcp-agent-mail-conformance/tests/conformance/fixtures/share/`.\n  - Include *expected hashes* (sha256) for each preset run.\n\n## Acceptance Criteria\n- The spec includes verbatim SQL/DDL and lists every table/column scrub rule for each preset.\n- Spec includes the exact hosting-hints detection signals and scaffolding file contents.\n- Fixtures cover at least:\n  - minimal DB (smallest useful)\n  - DB with attachments\n  - DB requiring scrub/redaction\n- For each preset, the fixture includes deterministic expected outputs (hashes + any required normalized JSON/manifest snapshots).\n- A brief “How to regenerate fixtures from legacy Python” note is included (command + expected output paths).\n- Implementers can complete `br-2ei.4.*` using only the spec + fixtures (no Python code consultation).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:54:17.642425426Z","created_by":"ubuntu","updated_at":"2026-02-05T07:54:58.212246444Z","closed_at":"2026-02-05T07:54:58.212223401Z","close_reason":"Added missing share/export fixture DDL files (expected_fts_ddl.sql, expected_views_ddl.sql); spec already present in EXISTING_MCP_AGENT_MAIL_STRUCTURE.md","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.7","depends_on_id":"br-2ei.4","type":"parent-child","created_at":"2026-02-05T05:54:17.642425426Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.8","title":"Share Tests: unit + integration + determinism + failure modes","description":"Add comprehensive unit + integration tests for the share/export pipeline (beyond E2E), with high-signal diffs and artifact logging.\n\nScope:\n- Unit tests for each pipeline stage: snapshot/scoping, scrub rules, FTS/index build, attachment rewrite, chunking, manifest/scaffolding, signing/encryption (optional).\n- Integration tests that run the full export pipeline against a small seeded DB + attachment set.\n- Determinism tests: identical inputs => identical output bundle hashes (manifest + DB + attachment layout).\n- Failure-mode tests: corrupt attachment, missing project, read-only output dir, invalid scrub preset.\n\nLogging/artifacts standard:\n- Each test emits a structured diff on mismatch (expected vs actual paths, JSON keys, hashes).\n- Store artifacts under tests/artifacts/share/<timestamp>/ for integration tests.\n\nDependencies:\n- These tests should depend on the relevant share implementation tasks (br-2ei.4.1–4.6, br-2ei.4.4.*, br-2ei.4.5.*) and spec extraction (br-2ei.4.7).\n\n## Success Criteria\n1. All child tasks (br-2ei.4.8.1–4.8.4) are complete and passing in CI.\n2. Unit, integration, determinism, and failure-mode tests run deterministically and without external services.\n3. Artifact logging standards are met (structured diffs + artifact trees under `tests/artifacts/share/<timestamp>/`).\n4. Determinism tests prove identical outputs for identical inputs (hash-based or byte-for-byte where specified).\n5. Failure-mode tests prove clean error handling with no confusing partial bundles.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-05T07:48:34.503442481Z","created_by":"ubuntu","updated_at":"2026-02-05T14:21:37.229946132Z","closed_at":"2026-02-05T14:21:37.229884346Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.8","depends_on_id":"br-2ei.4","type":"parent-child","created_at":"2026-02-05T07:48:34.503442481Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.8.1","title":"Share Tests: unit coverage for pipeline stages","description":"Unit tests for share pipeline stages (stage-level parity, deterministic outputs).\n\nCoverage:\n- Snapshot + scoping: correct WAL checkpoint + backup semantics; only requested project rows remain.\n- Scrub presets: standard/strict/archive rules match spec; verify SQL deletes + JSON redactions.\n- FTS/index build: expected tables/views and indexes created; query results stable.\n- Attachment rewrite: data-URI for <=64KiB, detach >=25MiB, copy/dedupe for middle range.\n- Messages.attachments JSON rewrite matches legacy schema and ordering.\n\nLogging/artifacts:\n- For each stage, emit a structured diff (expected vs actual SQL objects, JSON keys, attachment paths).\n- Snapshot tests should log the canonical manifest rows + attachment rewrite mapping.\n\nDependencies:\n- br-2ei.4.1, br-2ei.4.2, br-2ei.4.3, br-2ei.4.4.1, br-2ei.4.4.2, br-2ei.4.7\n\n## Acceptance Criteria\n1. Each pipeline stage has dedicated unit tests with deterministic fixtures and asserts parity with the extracted spec.\n2. Snapshot/scoping tests validate WAL checkpoint + backup semantics and that non-target project rows are removed.\n3. Scrub preset tests validate SQL deletes + JSON redactions and produce structured diffs on mismatch.\n4. Attachment rewrite tests cover size thresholds and schema ordering for messages.attachments.\n5. Logging includes structured diffs and manifest/attachment mappings to aid debugging.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:48:54.682178929Z","created_by":"ubuntu","updated_at":"2026-02-05T14:18:29.489172519Z","closed_at":"2026-02-05T14:18:29.489080406Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.8.1","depends_on_id":"br-2ei.4.1","type":"blocks","created_at":"2026-02-05T07:49:04.852299738Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.1","depends_on_id":"br-2ei.4.2","type":"blocks","created_at":"2026-02-05T07:49:04.945429675Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.1","depends_on_id":"br-2ei.4.3","type":"blocks","created_at":"2026-02-05T07:49:05.038929328Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.1","depends_on_id":"br-2ei.4.4.1","type":"blocks","created_at":"2026-02-05T07:49:05.134356218Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.1","depends_on_id":"br-2ei.4.4.2","type":"blocks","created_at":"2026-02-05T07:49:05.228917179Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.1","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T07:49:05.322494558Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.1","depends_on_id":"br-2ei.4.8","type":"parent-child","created_at":"2026-02-05T07:48:54.682178929Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.8.2","title":"Share Tests: integration pipeline + bundle verification","description":"Integration tests for full share/export pipeline (seeded DB + attachments -> bundle tree).\n\nCoverage:\n- Full pipeline run with a small seeded project DB and attachments.\n- Validate manifest.json content, DB snapshot integrity (PRAGMA integrity_check), attachment layout, and rewritten messages.attachments JSON.\n- Verify chunking behavior at size thresholds and manifest references.\n- If signing/encryption enabled, validate signature/age output with deterministic fixtures (where possible).\n\nLogging/artifacts:\n- Store bundle tree under tests/artifacts/share/full/<timestamp>/.\n- Emit diff summaries for manifest/attachments/DB schema on mismatch.\n- Capture and log size breakdowns (DB, attachments, manifest).\n\nDependencies:\n- br-2ei.4.1, br-2ei.4.2, br-2ei.4.3, br-2ei.4.4.*, br-2ei.4.5.*, br-2ei.4.6, br-2ei.4.7\n\n## Acceptance Criteria\n1. Integration test runs the full share pipeline in a temp workspace and produces a bundle tree under `tests/artifacts/share/full/<timestamp>/`.\n2. `manifest.json`, DB integrity, and attachment layout are validated against expected fixtures (including messages.attachments rewrite).\n3. Chunking threshold behavior is exercised and verified in the manifest.\n4. If signing/encryption is enabled, verify signature and decrypt in test mode with deterministic keys/fixtures.\n5. Failures print clear diffs for manifest/attachments/DB schema and include size breakdown logs.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:49:14.509596907Z","created_by":"ubuntu","updated_at":"2026-02-05T14:21:37.138504159Z","closed_at":"2026-02-05T14:21:37.138442703Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.1","type":"blocks","created_at":"2026-02-05T07:49:21.201560088Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.2","type":"blocks","created_at":"2026-02-05T07:49:21.294378799Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.3","type":"blocks","created_at":"2026-02-05T07:49:21.385449961Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.4.1","type":"blocks","created_at":"2026-02-05T07:49:21.477730629Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.4.2","type":"blocks","created_at":"2026-02-05T07:49:21.569989206Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.5.1","type":"blocks","created_at":"2026-02-05T07:49:21.660690982Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.5.2","type":"blocks","created_at":"2026-02-05T07:49:21.749106445Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.5.3","type":"blocks","created_at":"2026-02-05T07:49:21.840338169Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.6","type":"blocks","created_at":"2026-02-05T07:49:21.931913820Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T07:49:22.032750784Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.2","depends_on_id":"br-2ei.4.8","type":"parent-child","created_at":"2026-02-05T07:49:14.509596907Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.8.3","title":"Share Tests: determinism + reproducibility","description":"Determinism + reproducibility tests for share/export output.\n\nCoverage:\n- Run share pipeline twice with identical inputs -> identical:\n  - manifest.json (byte-for-byte)\n  - DB snapshot hashes\n  - attachment file paths + hashes\n  - bundle directory tree ordering\n- Verify stable ordering in manifest (projects, attachments, chunks).\n- Verify stable hash function inputs (no timestamp/hostname nondeterminism).\n\nLogging/artifacts:\n- Emit per-file hash lists and diff on mismatch.\n- Store hash inventories under tests/artifacts/share/determinism/<timestamp>/.\n\nDependencies:\n- br-2ei.4.5.* (manifest + chunking), br-2ei.4.4.*, br-2ei.4.7\n\n## Acceptance Criteria\n1. Two identical runs produce byte-for-byte identical `manifest.json` and identical hash inventories for DB + attachments.\n2. Manifest ordering (projects/attachments/chunks) is stable and asserted.\n3. Tests enforce that timestamps/hostnames do not leak into hash inputs.\n4. On mismatch, per-file hash diffs are printed and inventories are stored under `tests/artifacts/share/determinism/<timestamp>/`.\n5. Tests are deterministic across machines (normalize temp paths where necessary).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:49:31.525185255Z","created_by":"ubuntu","updated_at":"2026-02-05T14:18:29.582446136Z","closed_at":"2026-02-05T14:18:29.582367138Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.8.3","depends_on_id":"br-2ei.4.4.1","type":"blocks","created_at":"2026-02-05T07:49:36.101704160Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.3","depends_on_id":"br-2ei.4.4.2","type":"blocks","created_at":"2026-02-05T07:49:36.191870458Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.3","depends_on_id":"br-2ei.4.5.1","type":"blocks","created_at":"2026-02-05T07:49:36.296206809Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.3","depends_on_id":"br-2ei.4.5.2","type":"blocks","created_at":"2026-02-05T07:49:36.386410167Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.3","depends_on_id":"br-2ei.4.5.3","type":"blocks","created_at":"2026-02-05T07:49:36.473247380Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.3","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T07:49:36.558886727Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.3","depends_on_id":"br-2ei.4.8","type":"parent-child","created_at":"2026-02-05T07:49:31.525185255Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.4.8.4","title":"Share Tests: failure modes + recovery","description":"Failure-mode and recovery tests for share/export pipeline.\n\nCoverage:\n- Missing project -> clear error + exit code, no partial bundle output.\n- Invalid scrub preset -> error with list of valid presets.\n- Corrupt/missing attachment -> error or skip per legacy spec (document exact behavior), with logged path.\n- Read-only output dir -> error and no partial artifacts.\n- Partial bundle cleanup on failure (best-effort) to avoid confusing users.\n\nLogging/artifacts:\n- Capture stderr/stdout and include exact error strings + remediation hints.\n- Store partial output tree (if any) for debugging under tests/artifacts/share/failures/<timestamp>/.\n\nDependencies:\n- br-2ei.4.1, br-2ei.4.2, br-2ei.4.4.*, br-2ei.4.7\n\n## Acceptance Criteria\n1. Each failure mode is covered by a dedicated test case with expected exit code and error message assertions.\n2. Tests verify no partial bundle artifacts are left behind (or that cleanup happens per spec).\n3. Corrupt/missing attachments follow legacy behavior exactly (error vs skip) and log the affected path.\n4. Artifacts (stdout/stderr + partial trees) are stored under `tests/artifacts/share/failures/<timestamp>/`.\n5. Tests are deterministic and do not rely on external services.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T07:49:46.368523653Z","created_by":"ubuntu","updated_at":"2026-02-05T14:18:29.676450940Z","closed_at":"2026-02-05T14:18:29.676390456Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.4.8.4","depends_on_id":"br-2ei.4.1","type":"blocks","created_at":"2026-02-05T07:49:50.476879883Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.4","depends_on_id":"br-2ei.4.2","type":"blocks","created_at":"2026-02-05T07:49:50.568506731Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.4","depends_on_id":"br-2ei.4.4.1","type":"blocks","created_at":"2026-02-05T07:49:50.680999494Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.4","depends_on_id":"br-2ei.4.4.2","type":"blocks","created_at":"2026-02-05T07:49:50.786244505Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.4","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T07:49:50.883581511Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.4.8.4","depends_on_id":"br-2ei.4.8","type":"parent-child","created_at":"2026-02-05T07:49:46.368523653Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5","title":"CLI Parity: implement Typer-equivalent commands + frankentui output","description":"## Objective\nImplement **full CLI parity** with legacy Typer commands, flags, outputs, and exit codes, using frankentui for human output and stable JSON for automation.\n\n## Scope\n- All commands listed in `EXISTING_MCP_AGENT_MAIL_STRUCTURE.md` (CLI inventory), including:\n  - share export/update/preview/verify/decrypt/wizard\n  - archive save/list/restore\n  - doctor check/repair/backups/restore\n  - products ensure/link/status/search/inbox/summarize-thread\n  - amctl env, am-run\n  - projects mark-identity/discovery-init/adopt\n  - guard install/uninstall/status/check\n  - file_reservations list/active/soon\n  - acks pending/remind/overdue + list-acks\n  - config set-port/show-port\n  - list-projects, mail status, migrate, clear-and-reset-everything, docs insert-blurbs\n- Help text parity (flag ordering, defaults, examples) and JSON output schemas.\n\n## Implementation Notes\n- Match legacy defaults (e.g., share thresholds, host/port defaults, archive list ordering).\n- Exit codes and error messages must match legacy (see CLI Behavior Notes section in spec).\n- JSON mode must be deterministic (stable field ordering and schema).\n\n## Tests\n- Unit tests for clap parsing & defaults.\n- Integration tests using temp dirs + temp DB to exercise real CLI paths.\n- Golden help output snapshots.\n- JSON schema fixtures for JSON mode.\n- E2E CLI script (br-2ei.9.5).\n\n## Logging/Artifacts\n- Save stdout/stderr + diffs under `tests/artifacts/cli/<timestamp>/`.\n- On JSON mismatch, emit structured JSON diff.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"in_progress","priority":1,"issue_type":"epic","created_at":"2026-02-05T05:06:50.526774224Z","created_by":"ubuntu","updated_at":"2026-02-05T18:05:09.925128524Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.1","title":"CLI: serve-http/serve-stdio parity (flags, defaults, exit codes)","description":"Ensure `am serve-http` and `am serve-stdio` behave like legacy CLI.\n\nRequirements:\n- Flags: --host/--port/--path override env defaults.\n- serve-http starts HTTP listener with configured base path.\n- serve-stdio runs fastmcp stdio transport.\n- Exit codes: non-zero on bind failures.\n\nAcceptance:\n- Manual smoke tests with curl and stdio.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:11:18.491790676Z","created_by":"ubuntu","updated_at":"2026-02-05T05:38:36.353215725Z","closed_at":"2026-02-05T05:38:36.353198122Z","close_reason":"Added serve-http config override helper and tests","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.1","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.10","title":"CLI: docs insert-blurbs parity (scan/insert/idempotent)","description":"Port the legacy docs insert-blurbs command and verify idempotent, safe behavior.\n\nScope (match legacy Typer behavior):\n- Flags: --scan-dir/-d (repeat), --yes, --dry-run, --max-depth.\n- Behavior: scan target dirs for AGENTS.md/CLAUDE.md/README-like files, insert the Agent Mail blurb block if missing.\n- Idempotency: repeated runs should detect existing blocks and avoid duplicates.\n- Safety: dry-run prints planned changes without touching files; --yes bypasses prompts.\n\nImplementation notes:\n- Preserve file encoding + line endings; avoid rewriting unchanged files.\n- Provide clear per-file status: inserted / already-present / skipped / error.\n\nTests:\n- Unit: parsing flags + default scan paths + depth handling.\n- Integration: temp dirs with fixture files (missing blurb, existing blurb, partial blurb, non-matching files).\n- Dry-run verification: no file changes; output lists planned actions.\n- Idempotency: run twice and assert no second diff.\n\nLogging/artifacts:\n- On failure, store before/after file contents under tests/artifacts/cli/docs/<timestamp>/.\n- Emit unified diffs for mismatches.\n\n## Acceptance Criteria\n1. docs insert-blurbs matches legacy flags, prompts, and default scan behavior.\n2. Idempotency is proven by tests (no duplicate insertions).\n3. Dry-run is safe and emits clear planned-change output.\n4. Tests run in temp dirs and capture artifacts on failure.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T15:13:48.089263761Z","created_by":"ubuntu","updated_at":"2026-02-05T15:14:09.493517044Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.10","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T15:13:48.089263761Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.11","title":"CLI: migrate command parity (legacy DB/archive migrations)","description":"Port and verify the legacy migrate command.\n\nWork:\n- Extract exact legacy behavior (what is migrated, prompts, exit codes, and safety checks).\n- Implement equivalent behavior in Rust (no silent destructive actions).\n- If legacy is a no-op or informational, preserve that behavior and document it.\n\nTests:\n- Unit: parsing + flag handling (if any), exit code semantics.\n- Integration: temp DB/storage_root; simulate pre-migration state if needed.\n- Negative cases: invalid paths, missing files, permission errors.\n\nLogging/artifacts:\n- Capture stdout/stderr in tests/artifacts/cli/migrate/<timestamp>/.\n- On mismatch, print expected vs actual key lines.\n\n## Acceptance Criteria\n1. migrate matches legacy behavior and exit codes exactly.\n2. If the legacy command is a no-op, that is explicitly documented and tested.\n3. Integration tests are deterministic and operate only on temp dirs.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T15:14:16.606606259Z","created_by":"ubuntu","updated_at":"2026-02-05T15:17:12.728802244Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.11","depends_on_id":"br-2ei.16","type":"blocks","created_at":"2026-02-05T15:17:12.728738274Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.11","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T15:14:16.606606259Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.12","title":"CLI: clear-and-reset-everything parity (force + archive safety)","description":"Port and verify the legacy clear-and-reset-everything command.\n\nScope:\n- Flags: --force/-f, --archive/--no-archive.\n- Behavior: with --archive, create archive snapshot before clearing.\n- Safety: without --force, command should refuse (legacy behavior) or prompt; must match legacy.\n- Ensure all operations are confined to project storage_root/DB paths.\n\nTests:\n- Unit: flag parsing + default behaviors + exit codes for missing --force.\n- Integration: temp DB + storage_root seeded with data; verify:\n  - with --archive, archive is created and contains expected manifest.\n  - with --no-archive, data is cleared but no archive artifacts created.\n  - without --force, no changes occur.\n- Negative: missing/locked DB, unreadable storage dir; ensure errors are surfaced clearly.\n\nLogging/artifacts:\n- Store before/after tree snapshots + outputs under tests/artifacts/cli/clear_reset/<timestamp>/.\n- Print explicit list of files removed/archived (expected vs actual) on mismatch.\n\n## Acceptance Criteria\n1. clear-and-reset-everything matches legacy flags, safety gates, and exit codes.\n2. Archive creation (when enabled) is validated and deterministic.\n3. Tests never touch non-temp paths and fail fast with clear diagnostics.","status":"in_progress","priority":1,"issue_type":"task","assignee":"RusticOtter","created_at":"2026-02-05T15:14:31.173350973Z","created_by":"ubuntu","updated_at":"2026-02-06T02:22:51.681524244Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.12","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T15:14:31.173350973Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.13","title":"CLI: amctl env + am-run build slot parity (local lease fallback)","description":"Port and verify build-slot helper commands: amctl env + am-run.\n\nScope (match legacy behavior):\n- amctl env: prints environment variables (SLUG, PROJECT_UID, BRANCH, AGENT, CACHE_KEY, ARTIFACT_DIR) derived from repo/project context; supports --path/-p and --agent/-a.\n- am-run: acquires build slot (server tool if available; local JSON lease fallback), runs a command, renews periodically, releases on exit.\n- Flags: --path/-p, --agent/-a, --ttl-seconds, --shared/--exclusive, --block-on-conflicts/--no-block-on-conflicts.\n\nImplementation notes:\n- Local lease fallback should be deterministic and conflict-aware (shared vs exclusive).\n- Ensure env vars exported for child process (AM_SLOT, SLUG, PROJECT_UID, BRANCH, AGENT, CACHE_KEY).\n- Exit codes: non-zero if block-on-conflicts and conflicts exist (legacy).\n\nTests:\n- Unit: parsing + env derivation (stable fixtures for project UID + slug).\n- Integration: temp repo with a mock server disabled to force local lease path.\n- Conflict scenarios: shared vs exclusive, block-on-conflicts true/false.\n- Command propagation: verify env vars visible to child process.\n\nLogging/artifacts:\n- Capture stdout/stderr under tests/artifacts/cli/build_slots/<timestamp>/.\n- On mismatch, emit expected vs actual env var sets.\n\n## Acceptance Criteria\n1. amctl env and am-run match legacy flags, env var outputs, and exit codes.\n2. Local lease fallback behaves correctly with shared/exclusive conflicts.\n3. Integration tests are deterministic and run only in temp dirs.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T15:14:40.242202280Z","created_by":"ubuntu","updated_at":"2026-02-05T15:14:40.242202280Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.13","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T15:14:40.242202280Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.14","title":"CLI: projects subcommands parity (mark-identity/discovery-init/adopt)","description":"Port and verify legacy projects subcommands.\n\nScope (match legacy Typer behavior):\n- projects mark-identity (project_path, --commit/--no-commit): writes identity markers + optional git commit.\n- projects discovery-init (project_path, --product/-P): initialize project metadata for discovery.\n- projects adopt (source, target, --dry-run/--apply): migrate project metadata from source to target.\n\nSafety requirements:\n- Never run destructive git/fs commands; commit only when --commit is set.\n- Dry-run must emit exact planned changes without modifying files.\n\nTests:\n- Unit: clap parsing + defaults.\n- Integration: temp repos with seeded metadata; verify outputs + file changes.\n- Negative cases: invalid paths, missing project metadata, conflicts.\n\nLogging/artifacts:\n- Save before/after snapshots under tests/artifacts/cli/projects/<timestamp>/.\n- Emit unified diffs on mismatches.\n\n## Acceptance Criteria\n1. projects subcommands match legacy flags/defaults/exit codes.\n2. Dry-run and --commit behaviors are safe and deterministic.\n3. Integration tests run in temp repos only and capture artifacts on failure.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T15:14:48.056997359Z","created_by":"ubuntu","updated_at":"2026-02-05T15:14:48.056997359Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.14","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T15:14:48.056997359Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.15","title":"Share wizard parity: script launch + error handling","description":"Ensure share wizard matches legacy behavior (script invocation + error semantics).\n\nScope:\n- Command should attempt to execute legacy script path (scripts/share_to_github_pages.py).\n- If script missing/unreadable, exit non-zero with legacy error message.\n- When script exists, pass through args/env as legacy does (document exact call).\n\nTests:\n- Unit: parsing + default behavior.\n- Integration: temp repo with a stub script that records invocation; verify path, args, and exit codes.\n- Negative: missing script; assert error text and exit code.\n\nLogging/artifacts:\n- Capture stdout/stderr under tests/artifacts/cli/share_wizard/<timestamp>/.\n\n## Acceptance Criteria\n1. share wizard invokes the correct script path with legacy-compatible args/env.\n2. Missing-script failure matches legacy message + exit code.\n3. Integration tests are deterministic and run in temp dirs only.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T15:15:32.081608730Z","created_by":"ubuntu","updated_at":"2026-02-05T15:15:39.263085571Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.15","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T15:15:32.081608730Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.2","title":"CLI: implement guard subcommands (install/uninstall/status/check)","description":"Wire `am guard ...` commands to mcp-agent-mail-guard.\n\nCommands:\n- am guard install [--repo PATH] [--prepush]\n- am guard uninstall [--repo PATH]\n- am guard status [--repo PATH]\n- am guard check [--repo PATH] [--advisory] (used by hook plugin)\n\nMust match legacy defaults and env vars.\n\n## Acceptance Criteria\n1. CLI surface (commands/flags/defaults/exit codes) matches the CLI parity inventory (br-2ei.5.6).\n2. Commands delegate to mcp-agent-mail-guard and preserve idempotency semantics.\n3. Unit tests cover argument parsing + error cases (non-repo paths, missing repo).\n4. E2E guard suite (br-2ei.9.3) uses these commands successfully.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-05T05:11:24.884001192Z","created_by":"ubuntu","updated_at":"2026-02-05T06:31:56.949414368Z","closed_at":"2026-02-05T06:31:56.949353513Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.2","depends_on_id":"br-2ei.3.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.2","depends_on_id":"br-2ei.3.3","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.2","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.2","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T05:55:17.665850195Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.3","title":"CLI: implement share subcommands (export/update/preview/verify/decrypt/wizard)","description":"Wire `am share ...` commands to mcp-agent-mail-share with full legacy parity.\n\nCommands (legacy):\n- export / update / preview / verify / decrypt / wizard (interactive)\n\nMust match legacy Typer surface:\n- flags + defaults\n- interactive wizard flow for share export\n- hosting hints detection output (Cloudflare Pages / Netlify / AWS S3 signals)\n- stable/deterministic outputs when inputs are identical\n\nImplementation notes:\n- CLI should delegate core work to `mcp-agent-mail-share` and render human output via frankentui.\n- Machine mode (`--json`) must produce schema-stable output.\n\n## Acceptance Criteria\n1. CLI surface (commands/flags/defaults/exit codes) matches the CLI parity inventory (br-2ei.5.6).\n2. share commands delegate to `mcp-agent-mail-share` and produce deterministic outputs when inputs are identical.\n3. Hosting hints detection output is present and matches legacy semantics/signals (from spec `br-2ei.4.7`).\n4. Unit tests cover argument parsing and obvious error paths (missing DB, invalid scrub preset, invalid output dir, missing recipients).\n5. E2E share suite (br-2ei.9.4) uses these commands successfully.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:11:39.240636392Z","created_by":"ubuntu","updated_at":"2026-02-05T14:27:12.525669868Z","closed_at":"2026-02-05T14:27:12.525595357Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.3","depends_on_id":"br-2ei.4","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.3","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.3","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T05:55:17.761658357Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.4","title":"CLI: implement doctor commands (check/repair/backups/restore)","description":"## Objective\nPort **doctor** commands (`check`, `repair`, `backups`, `restore`) with legacy behavior and safety semantics.\n\n## Scope (Legacy Behavior Notes)\n- `doctor check`:\n  - `--json` outputs machine-readable diagnostics + summary counts.\n  - Checks include: stale locks, `PRAGMA integrity_check`, orphaned recipients, FTS row count mismatch, expired reservations, WAL/SHM presence.\n  - `--verbose` prints up to 5 detail lines per diagnostic.\n- `doctor repair`:\n  - `--dry-run` previews, `--yes` skips confirmations.\n  - Creates backups unless dry-run.\n  - Heals stale locks, releases expired reservations, deletes orphaned recipients (prompt unless `--yes`).\n- `doctor backups`: list backups as table or JSON.\n- `doctor restore`: restore backup with `--dry-run`/`--yes` gating.\n\n## Tests\n- Unit tests for argument parsing and flag defaults.\n- Integration tests against temp DB + storage_root:\n  - simulate stale locks, orphans, WAL/SHM files\n  - verify check output, repair side effects, backup listing and restore behavior\n\n## Logging/Artifacts\n- Store outputs + diffs under `tests/artifacts/cli/doctor/<timestamp>/`.\n- Print explicit mismatches for diagnostics counts and line content.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T05:11:51.799905939Z","created_by":"ubuntu","updated_at":"2026-02-05T16:08:22.244535346Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.4","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.4","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T05:55:17.847248690Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.5","title":"CLI UX: frankentui rendering for tables/progress + JSON output modes","description":"## Objective\nEnsure CLI **human output parity** with legacy, using frankentui for tables/panels and graceful non‑TTY output.\n\n## Scope\n- Table outputs (projects, inbox, acks, file reservations, backups) rendered via frankentui.\n- Progress indicators for long-running commands (share/export, archive restore, doctor repair).\n- Color/formatting disabled automatically when stdout/stderr is not a TTY.\n- JSON mode bypasses UI rendering and prints machine schema only.\n\n## Tests\n- Snapshot tests for frankentui table rendering (TTY vs non‑TTY).\n- Integration tests that exercise table output with representative data.\n- JSON mode tests confirm no UI artifacts are present.\n\n## Logging/Artifacts\n- Store rendered snapshots under `tests/fixtures/cli_ui/`.\n- On mismatch, save actual outputs under `tests/artifacts/cli/ui/<timestamp>/` and emit unified diff.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T05:11:59.633674324Z","created_by":"ubuntu","updated_at":"2026-02-05T16:08:29.665841235Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.5","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.5","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T05:55:17.922891984Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.6","title":"CLI parity spec: inventory legacy Typer commands/flags + golden help","description":"Extract and lock down the legacy Python Typer CLI surface so the Rust CLI cannot silently drift.\n\nDeliverables:\n- Command inventory: every command + subcommand, with flags, env var mappings, defaults, and exit codes.\n- Help output capture strategy:\n  - Either golden snapshots of `am --help` and key subcommands, OR a structured JSON inventory checked by unit tests.\n- Document any intentional improvements/deltas explicitly (and add tests for new behavior).\n\nSources:\n- legacy_python_mcp_agent_mail_code/* Typer app\n- Existing docs: EXISTING_MCP_AGENT_MAIL_STRUCTURE.md + README parity sections\n\nTests:\n- Unit test that asserts the Rust CLI exposes the full command inventory (names + flags).\n- E2E harness (br-2ei.9.5) consumes this inventory for verification.\n\n## Acceptance Criteria\n1. A deterministic CLI inventory artifact exists (golden help snapshots and/or structured inventory).\n2. Unit tests assert the Rust CLI matches the inventory (commands + flags + defaults).\n3. Any intentional deltas are explicitly listed and tested (no accidental drift).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:54:05.866507590Z","created_by":"ubuntu","updated_at":"2026-02-05T08:05:09.490318553Z","closed_at":"2026-02-05T08:05:09.490297684Z","close_reason":"Added structured CLI inventory artifact (legacy_cli_inventory.json) and updated CLI command table reference","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.6","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T05:54:05.866507590Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.7","title":"CLI Tests: unit + integration + golden help + JSON stability","description":"## Objective\nComprehensive CLI test suite covering parsing, help output, JSON mode, integration behavior, and exit codes.\n\n## Scope\n- Unit tests for clap parsing/defaults (br-2ei.5.7.1).\n- Integration tests for real command execution in temp dirs (br-2ei.5.7.2).\n- Golden help output snapshots (br-2ei.5.7.3).\n- JSON output stability tests (br-2ei.5.7.4).\n\n## Tests\n- `cargo test -p mcp-agent-mail-cli` covering all above categories.\n- E2E CLI harness (br-2ei.9.5) for high‑signal smoke.\n\n## Logging/Artifacts\n- Help snapshots under `tests/fixtures/cli_help/`.\n- JSON fixtures under `tests/fixtures/cli_json/`.\n- Failure artifacts under `tests/artifacts/cli/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":1,"issue_type":"epic","created_at":"2026-02-05T07:50:04.178085704Z","created_by":"ubuntu","updated_at":"2026-02-05T16:08:36.911836881Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.7","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T07:50:04.178085704Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.7.1","title":"CLI Tests: unit parsing + defaults","description":"Unit tests for CLI parsing and defaults.\n\nCoverage:\n- clap arg parsing for serve, share, guard, doctor, mail/acks/reservations commands.\n- products commands, archive commands, docs insert-blurbs, migrate, clear-and-reset-everything, amctl env, am-run.\n- default values (ports, paths, output format) match legacy spec (br-2ei.5.6).\n- env var overrides (where legacy supported).\n- exit code semantics for invalid args.\n\nLogging:\n- When failures occur, print full parsed-args diff and environment snapshot.\n\nDependencies:\n- br-2ei.5.1, br-2ei.5.2, br-2ei.5.3, br-2ei.5.4, br-2ei.5.5, br-2ei.5.6\n\n## Acceptance Criteria\n1. Unit tests cover parsing for all major subcommands and validate defaults against the legacy spec.\n2. Env var overrides are tested with explicit fixtures for supported variables.\n3. Invalid arg combinations return the expected exit code and error message.\n4. Failures print a parsed-args diff and environment snapshot to aid debugging.\n5. Tests are deterministic and do not require network or external binaries.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T07:50:15.690264115Z","created_by":"ubuntu","updated_at":"2026-02-05T16:21:40.751814093Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2di","type":"blocks","created_at":"2026-02-05T16:19:25.657693903Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5","type":"blocks","created_at":"2026-02-05T16:21:40.751758849Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.1","type":"blocks","created_at":"2026-02-05T07:50:20.373617293Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.10","type":"blocks","created_at":"2026-02-05T15:16:54.544322444Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.11","type":"blocks","created_at":"2026-02-05T15:16:54.635714595Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.12","type":"blocks","created_at":"2026-02-05T15:16:54.727486511Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.13","type":"blocks","created_at":"2026-02-05T15:16:54.816281409Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.14","type":"blocks","created_at":"2026-02-05T15:16:54.907456982Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.15","type":"blocks","created_at":"2026-02-05T15:16:54.995411988Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.2","type":"blocks","created_at":"2026-02-05T07:50:20.468649871Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.3","type":"blocks","created_at":"2026-02-05T07:50:20.559362277Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.4","type":"blocks","created_at":"2026-02-05T07:50:20.648289664Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.5","type":"blocks","created_at":"2026-02-05T07:50:20.739664527Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T07:50:20.830895600Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.7","type":"parent-child","created_at":"2026-02-05T07:50:15.690264115Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.8","type":"blocks","created_at":"2026-02-05T15:16:54.360938694Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-2ei.5.9","type":"blocks","created_at":"2026-02-05T15:16:54.452731689Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-3np","type":"blocks","created_at":"2026-02-05T16:19:25.564436308Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.1","depends_on_id":"br-9jl","type":"blocks","created_at":"2026-02-05T16:19:25.751159098Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.7.2","title":"CLI Tests: integration runs + exit codes","description":"Integration tests that run the CLI binary end-to-end in temp dirs.\n\nCoverage:\n- serve-stdio and serve-http startup/shutdown (dry-run where possible).\n- guard install/status/uninstall in a temp git repo.\n- share export/update/verify/preview/decrypt + wizard (script stub) with seeded project data.\n- doctor check/repair stubs (no destructive actions).\n- products commands, archive save/list/restore, docs insert-blurbs, migrate, clear-and-reset-everything, amctl env/am-run.\n\nLogging/artifacts:\n- Store stdout/stderr for each command under tests/artifacts/cli/integration/<timestamp>/.\n- Print expected vs actual exit codes and key output lines.\n\nDependencies:\n- br-2ei.5.1–5.5, br-2ei.5.6\n\n## Acceptance Criteria\n1. Integration tests execute the CLI binary in isolated temp dirs and clean up all processes they start.\n2. Commands listed in coverage are exercised and assert expected exit codes plus required output markers.\n3. All stdout/stderr is captured and written under tests/artifacts/cli/integration/<timestamp>/ with per-case headers.\n4. Tests do not use destructive git/fs commands; guard install/uninstall uses a temp repo only.\n5. Failures print clear diagnostics (command line, exit code, key output lines).","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T07:50:30.939428162Z","created_by":"ubuntu","updated_at":"2026-02-05T16:21:40.840647060Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2di","type":"blocks","created_at":"2026-02-05T16:19:33.007082077Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5","type":"blocks","created_at":"2026-02-05T16:21:40.840599791Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.1","type":"blocks","created_at":"2026-02-05T07:50:37.625955500Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.10","type":"blocks","created_at":"2026-02-05T15:16:55.268271539Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.11","type":"blocks","created_at":"2026-02-05T15:16:55.360282856Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.12","type":"blocks","created_at":"2026-02-05T15:16:55.453346375Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.13","type":"blocks","created_at":"2026-02-05T15:16:55.547451777Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.14","type":"blocks","created_at":"2026-02-05T15:16:55.641765331Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.15","type":"blocks","created_at":"2026-02-05T15:16:55.734754850Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.2","type":"blocks","created_at":"2026-02-05T07:50:37.721192313Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.3","type":"blocks","created_at":"2026-02-05T07:50:37.815858081Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.4","type":"blocks","created_at":"2026-02-05T07:50:37.911140008Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.5","type":"blocks","created_at":"2026-02-05T07:50:38.010689399Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T07:50:38.102457903Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.7","type":"parent-child","created_at":"2026-02-05T07:50:30.939428162Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.8","type":"blocks","created_at":"2026-02-05T15:16:55.089660439Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-2ei.5.9","type":"blocks","created_at":"2026-02-05T15:16:55.180406182Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-3np","type":"blocks","created_at":"2026-02-05T16:19:32.913614748Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.2","depends_on_id":"br-9jl","type":"blocks","created_at":"2026-02-05T16:19:33.103218362Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.7.3","title":"CLI Tests: golden help snapshots","description":"Golden help output snapshots for CLI parity.\n\nCoverage:\n- Top-level help output.\n- Key subcommands: serve, share, guard, doctor, products, archive, docs insert-blurbs, migrate, clear-and-reset-everything, amctl env, am-run.\n- Ensure help text, flag ordering, defaults, and examples match legacy spec (br-2ei.5.6).\n\nLogging/artifacts:\n- Store golden outputs under tests/fixtures/cli_help/.\n- On mismatch, print unified diffs and save actual outputs under tests/artifacts/cli/help/<timestamp>/.\n\nDependencies:\n- br-2ei.5.1–5.6\n\n## Acceptance Criteria\n1. Golden help snapshots exist for top-level and listed subcommands and are checked in under `tests/fixtures/cli_help/`.\n2. Tests compare help output exactly (including flag ordering and defaults), with normalization limited to documented nondeterminism.\n3. Non-TTY execution produces colorless output and is part of the snapshot set.\n4. On mismatch, a unified diff is printed and actual outputs are stored under `tests/artifacts/cli/help/<timestamp>/`.\n5. Tests are deterministic and run in CI without needing network or external tools.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T07:50:47.384522408Z","created_by":"ubuntu","updated_at":"2026-02-05T16:21:40.931429507Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2di","type":"blocks","created_at":"2026-02-05T16:19:39.152716318Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5","type":"blocks","created_at":"2026-02-05T16:21:40.931385103Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.1","type":"blocks","created_at":"2026-02-05T07:50:52.154619572Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.10","type":"blocks","created_at":"2026-02-05T15:16:56.008440818Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.11","type":"blocks","created_at":"2026-02-05T15:16:56.099826767Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.12","type":"blocks","created_at":"2026-02-05T15:16:56.187563061Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.13","type":"blocks","created_at":"2026-02-05T15:16:56.284729729Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.14","type":"blocks","created_at":"2026-02-05T15:16:56.376921036Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.15","type":"blocks","created_at":"2026-02-05T15:16:56.470511628Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.2","type":"blocks","created_at":"2026-02-05T07:50:52.245573523Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.3","type":"blocks","created_at":"2026-02-05T07:50:52.336195479Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.4","type":"blocks","created_at":"2026-02-05T07:50:52.426020015Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.5","type":"blocks","created_at":"2026-02-05T07:50:52.515717862Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T07:50:52.601998356Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.7","type":"parent-child","created_at":"2026-02-05T07:50:47.384522408Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.8","type":"blocks","created_at":"2026-02-05T15:16:55.825336985Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-2ei.5.9","type":"blocks","created_at":"2026-02-05T15:16:55.918105278Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-3np","type":"blocks","created_at":"2026-02-05T16:19:39.013361447Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.3","depends_on_id":"br-9jl","type":"blocks","created_at":"2026-02-05T16:19:39.250672830Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.7.4","title":"CLI Tests: JSON output stability","description":"JSON output stability tests for CLI commands that expose machine-readable data.\n\nCoverage:\n- Ensure JSON output schemas match legacy (field names, nesting, nullability).\n- Verify stable ordering where legacy is stable (or document normalization).\n- Commands: guard status/check, share verify/preview, doctor check, list-projects, list-acks, products search/inbox/status, archive list, acks pending/remind/overdue, file_reservations list/active/soon.\n\nLogging/artifacts:\n- Store expected JSON fixtures under tests/fixtures/cli_json/.\n- On mismatch, emit JSON diff and save actual outputs under tests/artifacts/cli/json/<timestamp>/.\n\nDependencies:\n- br-2ei.5.1–5.6\n\n## Acceptance Criteria\n1. Tests run under `cargo test -p mcp-agent-mail-cli` (or workspace equivalent) and cover all listed JSON-producing commands.\n2. JSON schemas match legacy fixtures (field names/types/nullability); any normalization rules are documented in the fixtures.\n3. Ordering is stable where required (or normalized before comparison) and asserted in tests.\n4. On mismatch, tests print a JSON diff and store actual outputs under `tests/artifacts/cli/json/<timestamp>/`.\n5. Tests are deterministic and pass on a clean temp env (no reliance on machine-specific paths).","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T07:51:01.253361843Z","created_by":"ubuntu","updated_at":"2026-02-05T16:21:41.018677539Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2di","type":"blocks","created_at":"2026-02-05T16:19:45.277037639Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5","type":"blocks","created_at":"2026-02-05T16:21:41.018623798Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.1","type":"blocks","created_at":"2026-02-05T07:51:06.732190931Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.10","type":"blocks","created_at":"2026-02-05T15:16:56.751647760Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.11","type":"blocks","created_at":"2026-02-05T15:16:56.844039363Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.12","type":"blocks","created_at":"2026-02-05T15:16:56.936984349Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.13","type":"blocks","created_at":"2026-02-05T15:16:57.031358878Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.14","type":"blocks","created_at":"2026-02-05T15:16:57.124581116Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.15","type":"blocks","created_at":"2026-02-05T15:16:57.219280176Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.2","type":"blocks","created_at":"2026-02-05T07:51:06.825343050Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.3","type":"blocks","created_at":"2026-02-05T07:51:06.919542630Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.4","type":"blocks","created_at":"2026-02-05T07:51:07.010359283Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.5","type":"blocks","created_at":"2026-02-05T07:51:07.101986571Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T07:51:07.193432639Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.7","type":"parent-child","created_at":"2026-02-05T07:51:01.253361843Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.8","type":"blocks","created_at":"2026-02-05T15:16:56.563589374Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-2ei.5.9","type":"blocks","created_at":"2026-02-05T15:16:56.656163861Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-3np","type":"blocks","created_at":"2026-02-05T16:19:45.183463238Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.5.7.4","depends_on_id":"br-9jl","type":"blocks","created_at":"2026-02-05T16:19:45.371365328Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.8","title":"CLI: products subcommands parity (ensure/link/status/search/inbox/summarize-thread)","description":"Port and verify the legacy product-bus CLI commands.\n\nScope (match legacy Typer behavior):\n- commands: products ensure, products link, products status, products search, products inbox, products summarize-thread.\n- flags/args: product_key? defaults, --name/-n, --limit/-l, --urgent-only/--all, --include-bodies/--no-bodies, --since-ts, --per-thread-limit/-n, --no-llm.\n- outputs: human (frankentui table) + --json mode with stable schemas.\n- exit codes: invalid args, missing product, no links, etc.\n\nImplementation notes:\n- Use existing product tools / DB queries (avoid new business logic).\n- Ensure consistent sorting and deterministic timestamps where legacy normalizes.\n- Surface errors with clear, legacy-matching messages.\n\nTests (must be comprehensive):\n- Unit: clap parsing, default values, env overrides (if any), invalid arg combos.\n- Integration: temp DB + temp storage_root, exercise each command with 0/1/n results.\n- JSON stability: golden fixtures for each command’s JSON output.\n- E2E: include in scripts/e2e_cli.sh (or a dedicated product E2E case) and save artifacts.\n\nLogging/artifacts:\n- Store stdout/stderr under tests/artifacts/cli/products/<timestamp>/ on failure.\n- Print expected vs actual diffs for JSON payload mismatches.\n\n## Acceptance Criteria\n1. All listed products commands exist and match legacy flags/defaults/exit codes.\n2. Human output uses frankentui tables; non-TTY disables color.\n3. JSON mode outputs are schema-stable and covered by fixtures.\n4. Integration tests run in isolation (temp dirs) and are deterministic.\n5. E2E path captures artifacts and fails fast on mismatch.","status":"closed","priority":1,"issue_type":"task","assignee":"RusticOtter","created_at":"2026-02-05T15:13:29.512773709Z","created_by":"ubuntu","updated_at":"2026-02-06T02:20:58.455989543Z","closed_at":"2026-02-06T02:20:58.455963574Z","close_reason":"Completed products CLI parity (positional inbox agent, legacy fallback behavior) + added deterministic integration tests","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.8","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T15:13:29.512773709Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.5.9","title":"CLI: archive save/list/restore parity (safe + deterministic)","description":"Port and verify the legacy archive commands (save/list/restore).\n\nScope (match legacy Typer behavior):\n- archive save: project filters (repeat), scrub preset, optional label.\n- archive list: --limit/-n, --json output; stable ordering.\n- archive restore: requires archive_file, --force/-f, --dry-run; explicit warnings.\n\nSafety requirements:\n- No destructive actions without explicit flags (match legacy prompts).\n- Restore should validate manifest presence + show scope before applying.\n- Dry-run prints exact actions without mutating storage.\n\nTests:\n- Unit: clap parsing + defaults; invalid flags produce correct exit codes.\n- Integration: temp storage_root + temp DB; create archive from seeded data, list it, and restore into a clean temp dir.\n- Negative cases: missing archive path, malformed manifest, restore without --force (if legacy requires).\n- JSON fixtures for list output.\n\nLogging/artifacts:\n- Store stdout/stderr under tests/artifacts/cli/archive/<timestamp>/ on failure.\n- Emit diffs for list JSON mismatch.\n\n## Acceptance Criteria\n1. archive save/list/restore exist and match legacy flags/defaults/exit codes.\n2. list output is deterministic and JSON-stable.\n3. restore honors --dry-run and --force semantics; no destructive behavior in tests.\n4. Integration tests pass in isolated temp dirs with detailed artifacts on failure.","status":"closed","priority":1,"issue_type":"task","assignee":"RusticOtter","created_at":"2026-02-05T15:13:37.540954876Z","created_by":"ubuntu","updated_at":"2026-02-06T01:34:01.636562491Z","closed_at":"2026-02-06T01:34:01.636539307Z","close_reason":"Implemented archive save/list/restore parity + roundtrip test (no env mutation); clippy/fmt/test green","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.5.9","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T15:13:37.540954876Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.6","title":"Integration: enforce local-crate usage (asupersync/sqlmodel/fastmcp/frankentui) + agent detection","description":"## Objective\nEnforce **local-crate usage** and eliminate upstream duplicates, ensuring the port fully leverages `/dp` crates as required.\n\n## Scope\n- **fastmcp_rust** for MCP server/router and resource handling.\n- **sqlmodel_rust** for SQLite DB models, migrations, and queries.\n- **asupersync** for async/runtime + I/O (replace tokio where applicable).\n- **frankentui** for all terminal/CLI rendering.\n- **beads_rust** for any beads integration.\n- **coding_agent_session_search** for agent detection.\n\n## Implementation Notes\n- Audit Cargo.toml + code to remove direct tokio usage and other upstream deps duplicated by local crates.\n- Add compile-time or CI checks to detect forbidden deps (`tokio`, `rusqlite`, etc.).\n\n## Tests\n- Unit tests for agent detection and asupersync-based execution paths.\n- CI checks or tests to assert forbidden deps are absent.\n\n## Logging/Artifacts\n- Emit dependency audit reports under `tests/artifacts/deps/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":2,"issue_type":"epic","created_at":"2026-02-05T05:06:57.327442629Z","created_by":"ubuntu","updated_at":"2026-02-05T16:08:45.806537044Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.6","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.6.1","title":"Audit: eliminate tokio and upstream duplicates (use asupersync/sqlmodel)","description":"## Objective\nAudit and remove any `tokio` usage or upstream duplicates to align with asupersync/sqlmodel_rust/fastmcp_rust.\n\n## Scope\n- Locate tokio usage in all crates (runtime, fs, net, channels, timers).\n- Replace with asupersync equivalents or sync code paths.\n- Remove redundant deps (`tokio`, `rusqlite`, `reqwest` if replaced by asupersync).\n\n## Tests\n- Compile/test pass without tokio.\n- Unit tests for replacement paths (timers, spawning, async I/O).\n\n## Logging/Artifacts\n- Emit a dependency diff report under `tests/artifacts/deps/<timestamp>/`.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T05:13:17.777775741Z","created_by":"ubuntu","updated_at":"2026-02-05T16:08:52.043819233Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.6.1","depends_on_id":"br-2ei.6","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.6.2","title":"Integrate coding_agent_session_search for installed-agent detection (tokio-free surface)","description":"## Objective\nIntegrate `/dp/coding_agent_session_search` for installed‑agent detection with a tokio‑free surface.\n\n## Scope\n- Expose a helper API in Rust port to detect installed/active coding agents (Claude/Codex/Gemini/etc.).\n- Match legacy behavior for discovery and output (if present in Python toolchain).\n- Ensure this integrates cleanly with CLI commands that report environment or agent availability.\n\n## Tests\n- Unit tests with mocked environment/session directories.\n- Integration test in temp dir verifying detection output schema.\n\n## Logging/Artifacts\n- Store detection reports under `tests/artifacts/agents/<timestamp>/` on failure.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T05:13:25.051447400Z","created_by":"ubuntu","updated_at":"2026-02-05T16:08:59.718912845Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.6.2","depends_on_id":"br-2ei.6","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.6.2","depends_on_id":"br-2ei.6.1","type":"blocks","created_at":"2026-02-05T15:18:11.670479892Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.6.3","title":"Upstream dependency: asupersync Http1Request.peer_addr","description":"This repo needs accurate client peer address (SocketAddr) on each HTTP request to match legacy Python behavior for:\n- localhost bypass (allow_localhost_unauthenticated)\n- bearer token injection for base-path passthrough\n- rate limit identity derivation (host when JWT sub missing)\n\nUpstream work lives in /dp/asupersync.\n\nRequired API surface (asupersync):\n1. Expose the remote peer address on Http1Request (or equivalent request context):\n   - Prefer: `Http1Request.peer_addr: Option<SocketAddr>` (or accessor)\n   - Must be present even when no forwarded headers are set\n2. Ensure forwarded headers do NOT overwrite peer_addr (legacy uses actual client host for localhost checks).\n3. Maintain tokio-free surface (asupersync conventions).\n\nDownstream work (this repo):\n- Update mcp-agent-mail-server to read peer_addr and derive client_host string, including IPv4-mapped IPv6 handling.\n- Wire into localhost detection helper + rate limit identity.\n\nExternal references:\n- asupersync beads created by another agent: bd-32eba (and children) (prefix may be corrected later).\n\n## Acceptance Criteria\n1. /dp/asupersync exposes peer_addr in the HTTP request type used by mcp-agent-mail-server.\n2. This repo can compile against the updated asupersync without tokio.\n3. br-1bm.3.1 can be implemented using this API with no hacks.","status":"closed","priority":0,"issue_type":"task","assignee":"ubuntu","created_at":"2026-02-05T06:08:02.941793644Z","created_by":"ubuntu","updated_at":"2026-02-05T08:31:31.290546761Z","closed_at":"2026-02-05T08:31:31.290526042Z","close_reason":"Added Http1Request.peer_addr and wired through Http1Server/Listener (asupersync)","external_ref":"/dp/asupersync:bd-32eba","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.6.3","depends_on_id":"br-2ei.6","type":"parent-child","created_at":"2026-02-05T06:08:02.941793644Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.7","title":"Benchmarks: tool latency + archive throughput + share/export budgets","description":"\nTests:\n- Bench smoke tests (fast path) to validate fixtures, JSON summary output, and golden hashes.\n- CI guardrails: compare p50/p95 metrics against budgets; fail on regressions.\n- E2E: optional bench-smoke path in scripts/e2e_test.sh to validate determinism and logging.\n\n## Acceptance Criteria\n1. Bench suite is deterministic with stable fixture hashes and JSON summaries.\n2. Budgets are enforced in CI (fail on regression with clear diff).\n3. Bench-smoke path runs quickly and validates logging + golden output checks.","status":"open","priority":2,"issue_type":"epic","created_at":"2026-02-05T05:07:03.312826328Z","created_by":"ubuntu","updated_at":"2026-02-05T15:41:59.222427634Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.7","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.7.1","title":"Bench: establish baseline budgets + golden outputs for hot tool paths","description":"Capture baseline performance numbers and lock them in (profile-first per extreme optimization workflow).\n\nWork:\n- Baseline runs:\n  - Use `hyperfine --warmup 3 --runs 10` for representative commands.\n  - Record p50/p95/p99, throughput, and allocations where possible.\n- Profiling:\n  - Capture flamegraphs for top 3 hot paths (tool handler, archive write, share export).\n  - Identify hotspot functions and record in the budget doc.\n- Golden outputs:\n  - Capture golden outputs for stable surfaces (JSON, help text, share manifest ordering, archive artifacts).\n  - Record sha256 checksums to prove behavior unchanged in later optimizations.\n- Opportunity matrix:\n  - For each hotspot, score Impact×Confidence/Effort; only pursue Score ≥ 2.0.\n- Isomorphism proof template:\n  - Document ordering/tie-breaking/RNG/float invariants for each optimization.\n\n## Acceptance Criteria\n- Budget doc exists (e.g., benches/BUDGETS.md or docs/perf-budgets.md) with:\n  - target p50/p95/p99 for most-called tools\n  - max allocations for archive writes and share/export\n  - documented baseline commands + hardware notes\n  - flamegraph links/paths\n- Golden outputs are validated via `sha256sum -c` (or equivalent) in CI.\n- Optimization workflow (“profile → change → prove”) is documented and enforced.\n- Bench harness emits machine-readable JSON summaries and stores detailed logs/artifacts per run.\n- A bench smoke step (CI or `scripts/e2e_test.sh` optional path) validates budgets + golden outputs without network access.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T05:13:31.777132727Z","created_by":"ubuntu","updated_at":"2026-02-05T15:12:06.976807154Z","closed_at":"2026-02-05T15:12:06.976716022Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.7.1","depends_on_id":"br-2ei.7","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.7.2","title":"Bench: archive write throughput (message + attachments + commit batching)","description":"## Objective\nBenchmark archive write throughput for messages + attachments + commit batching with deterministic fixtures.\n\n## Scope\n- Measure end‑to‑end archive write cost for:\n  - single message (no attachments)\n  - message with small inline attachment\n  - message with file-backed attachment\n  - batch send (N messages) to exercise commit queue batching\n- Capture p50/p95/p99 latency + throughput (msgs/sec).\n\n## Implementation Notes\n- Use controlled temp storage_root and temp DB.\n- Ensure git commit queue behavior matches legacy (max batch size + max wait).\n\n## Tests\n- Criterion benches in `crates/mcp-agent-mail/benches/`.\n- Optional hyperfine runner for CLI-level throughput.\n\n## Logging/Artifacts\n- Save JSON summaries and raw timing samples under `tests/artifacts/bench/archive/<timestamp>/`.\n- Emit regression diffs against baseline budgets.\n\n## Acceptance Criteria\n1. All behavior and requirements described above are implemented with legacy parity.\n2. Unit/integration tests cover the described cases with deterministic outputs and logged artifacts.\n3. Any referenced E2E coverage passes and captures the expected logs/artifacts.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T05:13:37.368254570Z","created_by":"ubuntu","updated_at":"2026-02-05T16:09:10.423078852Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.7.2","depends_on_id":"br-2ei.2.2","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.7.2","depends_on_id":"br-2ei.2.5","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.7.2","depends_on_id":"br-2ei.7","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.7.2","depends_on_id":"br-2ei.7.1","type":"blocks","created_at":"2026-02-05T06:58:02.715728602Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.7.3","title":"Bench: share/export pipeline (snapshot+scrub+bundle) budgets","description":"Add benchmarks for the share/export pipeline (snapshot + scrub + bundle) using the extreme-optimization workflow.\n\nWork:\n- Measure end-to-end share/export for representative DB sizes:\n  - tiny fixture (fast path)\n  - medium fixture (includes attachments)\n  - optional large synthetic fixture (chunking path)\n- Track:\n  - runtime p50/p95/p99\n  - output bundle size\n  - chunking overhead vs non-chunked\n- Use hyperfine for CLI-level measurement and Criterion for internal pipeline timing.\n- Capture flamegraph and hotspot list before any optimization.\n- Assert bundle determinism via stable hashes (manifest + DB + attachments).\n\nLogging/artifacts:\n- Store benchmark outputs, flamegraphs, and JSON summaries under tests/artifacts/bench/share/<timestamp>/.\n- On budget regression, emit a structured diff of expected vs actual p50/p95/p99 and output sizes.\n\n## Acceptance Criteria\n- Bench harness exists and runs locally with a single command.\n- Deterministic fixtures/generators and machine-readable summary JSON.\n- Output bundle determinism enforced with hash checks.\n- Budgets recorded in br-2ei.7.1 doc; pass/fail thresholds enforced.\n- Hotspot evidence recorded (top 5 functions by time).\n- Isomorphism proof template used if any optimization is proposed.\n- Bench artifacts (logs/JSON/flamegraphs) are captured in `tests/artifacts/bench/share/<timestamp>/`.\n\nDependencies:\n- br-2ei.7.1, br-2ei.4.5, br-2ei.7","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-05T05:13:51.914580151Z","created_by":"ubuntu","updated_at":"2026-02-05T16:17:54.340644662Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.7.3","depends_on_id":"br-1uf","type":"blocks","created_at":"2026-02-05T16:17:54.340603465Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.7.3","depends_on_id":"br-2ei.4.5","type":"blocks","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.7.3","depends_on_id":"br-2ei.7","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.7.3","depends_on_id":"br-2ei.7.1","type":"blocks","created_at":"2026-02-05T06:58:02.797620961Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.8","title":"Docs: add Rust-port README + dev workflow (fmt/clippy/test/conformance/bench)","description":"Add a top-level README.md for this Rust port.\n\nMust include:\n- What the project is (Rust port of mcp_agent_mail)\n- How to run MCP server: stdio and HTTP\n- How to run conformance tests\n- How to regenerate fixtures (legacy venv python command)\n- How to run benches\n- Notes on per-agent CARGO_TARGET_DIR to avoid multi-agent target lock contention\n\nAcceptance:\n- README is accurate and matches current code + scripts.\n","status":"closed","priority":3,"issue_type":"task","created_at":"2026-02-05T05:07:09.183372429Z","created_by":"ubuntu","updated_at":"2026-02-05T05:38:39.476350794Z","closed_at":"2026-02-05T05:38:39.476334223Z","close_reason":"Added top-level README with run/test/conformance/bench instructions","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.8","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:37:36Z","created_by":"import","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9","title":"E2E Test Suite: harness + scripts + artifacts","description":"E2E test suite covering full legacy parity across HTTP, CLI, guard, archive, share, notifications, and LLM.\n\nScripts:\n- scripts/e2e_test.sh (driver)\n- scripts/e2e_http.sh (HTTP parity)\n- scripts/e2e_cli.sh (CLI stability)\n- scripts/e2e_guard.sh (guard enforcement)\n- scripts/e2e_archive.sh (archive side effects)\n- scripts/e2e_share.sh (share/export determinism)\n- scripts/e2e_notifications.sh (signal files)\n- scripts/e2e_llm.sh (llm_mode smoke)\n\nLogging/artifacts:\n- Each script writes artifacts under tests/artifacts/<area>/<timestamp>/ with:\n  - request/response transcripts (for HTTP)\n  - stdout/stderr captures (CLI/guard)\n  - file tree + hashes (archive/share)\n  - expected vs actual diffs on mismatch\n\nDeterminism + safety:\n- Use temp dirs and deterministic fixtures.\n- No destructive git/fs commands; fail fast on any mismatch.\n\nTests:\n- E2E harness unit tests for log helpers and artifact capture.\n- Integration tests for each script entry to validate deterministic outputs.\n- CI runs scripts/e2e_test.sh with selective paths and captures artifacts.\n\n## Acceptance Criteria\n1. All E2E scripts run via scripts/e2e_test.sh and produce artifacts with clear diffs.\n2. Coverage includes HTTP parity, CLI stability, guard enforcement, archive parity, share/export determinism, notifications, and LLM smoke.\n3. E2E harness is deterministic and avoids destructive commands.","status":"open","priority":1,"issue_type":"epic","created_at":"2026-02-05T05:52:30.044860332Z","created_by":"ubuntu","updated_at":"2026-02-05T15:44:30.546871870Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T05:52:30.044860332Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9","depends_on_id":"br-2ei.5","type":"blocks","created_at":"2026-02-05T15:18:14.778532018Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9.1","title":"E2E: harness scaffolding (runner + log helpers + artifacts)","description":"Create the shared E2E harness used by all other E2E scripts.\n\nDeliverables:\n- scripts/e2e_test.sh: top-level runner (can run all suites or a named suite).\n- scripts/e2e_lib.sh: helpers for:\n  - mktemp workspace + cleanup (AM_E2E_KEEP_TMP=1)\n  - artifact dir selection (tests/artifacts/<suite>/<timestamp>/)\n  - logging (case banners, expected vs actual)\n  - stable hashing + file tree dumps\n  - retry helpers for flaky ports/binds\n\nRequirements:\n- Detailed logging by default; include env dump (redacting secrets).\n- All scripts must be safe (no destructive git/fs commands).\n- The runner must set CARGO_TARGET_DIR if not already set (recommended per-agent directory).\n\n## Acceptance Criteria\n1. scripts/e2e_test.sh exists and can run at least one suite.\n2. scripts/e2e_lib.sh provides logging + artifact helpers used by all suites.\n3. All suites write artifacts under tests/artifacts/<suite>/<timestamp>/.\n4. All suites exit non-zero on mismatch and print expected vs actual.\n5. AM_E2E_KEEP_TMP=1 retains temp dirs.\n6. Runner respects/sets CARGO_TARGET_DIR (no multi-agent target contention).\n7. Harness uses only temp dirs and does not run destructive git/fs commands.","acceptance_criteria":"1. scripts/e2e_test.sh exists and can run at least one suite\n2. scripts/e2e_lib.sh provides logging + artifact helpers\n3. All scripts write artifacts under tests/artifacts/<suite>/<timestamp>/\n4. All scripts exit non-zero on mismatch and print expected vs actual\n5. AM_E2E_KEEP_TMP=1 retains temp dirs\n6. Runner respects/sets CARGO_TARGET_DIR (no multi-agent target contention)\n7. No destructive git/fs commands used (temp dirs only)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T05:52:47.452322784Z","created_by":"ubuntu","updated_at":"2026-02-05T06:20:14.780147870Z","closed_at":"2026-02-05T06:20:14.780077948Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9.1","depends_on_id":"br-2ei.9","type":"parent-child","created_at":"2026-02-05T05:52:47.452322784Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9.2","title":"E2E: archive write/read side effects (messages + reservations + attachments)","description":"End-to-end verification of git archive side effects (messages + reservations + attachments) *and* notification signals.\n\nScript:\n- scripts/e2e_archive.sh (invoked by scripts/e2e_test.sh)\n\nFlow (high-signal, deterministic):\n1. Use a temp storage_root + temp DB path.\n2. Launch server/router (stdio or in-process harness) and execute:\n   - ensure_project\n   - register_agent(s)\n   - send_message (with 0, 1, and multiple recipients)\n   - file_reservation_paths (exclusive + shared)\n   - renew/release reservation\n   - send_message with a small inline attachment and a file-backed attachment\n3. Verify git archive:\n   - expected directories exist\n   - canonical messages path format and frontmatter JSON parse\n   - inbox/outbox copies exist and match canonical\n   - file_reservations artifacts exist (sha1(pattern).json + id-<id>.json)\n   - attachments manifests exist; content hashes match references\n   - git log contains expected commit summaries\n4. Notifications (signals) parity:\n   - enable notifications (NOTIFICATIONS_ENABLED + NOTIFICATIONS_SIGNALS_DIR in temp)\n   - after send_message, assert signal files exist for `to` + `cc` recipients only (NOT bcc)\n   - after fetch_inbox, assert the signal file for that agent is cleared\n\nLogging/artifacts:\n- Dump file tree + sizes, and sha256 hashes for large artifacts.\n- On failure, print unified diffs for markdown/frontmatter mismatches.\n- For notifications, capture signal JSON payloads (expected vs actual) on mismatch.\n- Write all outputs to tests/artifacts/archive/<timestamp>/.\n\nNotes:\n- Avoid external deps; use git CLI only for inspecting commits.\n- Never use destructive git/fs commands.\n\n## Acceptance Criteria\n1. scripts/e2e_archive.sh runs via scripts/e2e_test.sh archive.\n2. Script produces tests/artifacts/archive/<timestamp>/ with:\n   - archive file tree + sizes\n   - sha256 hashes for large artifacts\n   - per-case expected vs actual logs\n3. Script exits non-zero on first mismatch and prints a clear failing case header.\n4. Archive invariants are asserted: canonical/inbox/outbox match, reservation artifacts present, attachment manifests/hashes match.\n5. Notifications invariants are asserted when enabled: signals emitted for to+cc only and cleared on fetch_inbox.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-05T05:53:07.432876569Z","created_by":"ubuntu","updated_at":"2026-02-05T14:07:31.002006411Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9.2","depends_on_id":"br-2ei.12.2","type":"blocks","created_at":"2026-02-05T07:34:52.461587201Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.2","depends_on_id":"br-2ei.2.2","type":"blocks","created_at":"2026-02-05T05:53:07.432876569Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.2","depends_on_id":"br-2ei.2.3","type":"blocks","created_at":"2026-02-05T05:53:07.432876569Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.2","depends_on_id":"br-2ei.2.4","type":"blocks","created_at":"2026-02-05T05:53:07.432876569Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.2","depends_on_id":"br-2ei.2.5","type":"blocks","created_at":"2026-02-05T05:53:07.432876569Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.2","depends_on_id":"br-2ei.9","type":"parent-child","created_at":"2026-02-05T05:53:07.432876569Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.2","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T14:07:31.001964142Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9.3","title":"E2E: guard enforcement in temp git repo (pre-commit + renames)","description":"End-to-end verification of the guard system in a real temp git repo.\n\nScript:\n- scripts/e2e_guard.sh\n\nFlow:\n1. Create a temp git repo with a tracked file.\n2. Install the agent-mail guard (via CLI `am guard install` or MCP tool).\n3. Create an exclusive file reservation held by another agent for the file (or a matching pattern).\n4. Modify + stage the file, attempt `git commit`:\n   - Expected: blocked (non-zero), stderr contains clear conflict info.\n5. Release the reservation and retry commit:\n   - Expected: allowed.\n6. Rename scenario:\n   - Create reservation matching old/new path; stage rename; ensure guard checks both sides.\n7. stdin-nul + ignorecase:\n   - run guard check with --stdin-nul input (NUL-delimited paths) and verify correct conflict detection.\n   - set core.ignorecase true and verify case-insensitive match behavior matches legacy.\n\nLogging/artifacts:\n- Capture hook output, git status/diff summaries, and reservation records.\n- Store under tests/artifacts/guard/<timestamp>/.\n\nSafety:\n- Operate only within temp dirs.\n- Never run destructive git/fs commands.\n\n## Acceptance Criteria\n1. scripts/e2e_guard.sh runs via scripts/e2e_test.sh guard.\n2. Script demonstrates a blocked commit when an exclusive reservation conflicts, including clear stderr output.\n3. Script demonstrates an allowed commit after reservation release.\n4. Rename case asserts both old and new paths are checked.\n5. stdin-nul and core.ignorecase behaviors are validated and match legacy.\n6. Artifacts under tests/artifacts/guard/<timestamp>/ include hook output + git summaries + reservation JSON.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:53:18.903635568Z","created_by":"ubuntu","updated_at":"2026-02-05T15:16:20.592540210Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9.3","depends_on_id":"br-2ei.3.1","type":"blocks","created_at":"2026-02-05T14:07:27.894140772Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.3","depends_on_id":"br-2ei.3.2","type":"blocks","created_at":"2026-02-05T14:07:27.982001326Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.3","depends_on_id":"br-2ei.3.3","type":"blocks","created_at":"2026-02-05T05:53:18.903635568Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.3","depends_on_id":"br-2ei.5.2","type":"blocks","created_at":"2026-02-05T05:53:18.903635568Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.3","depends_on_id":"br-2ei.9","type":"parent-child","created_at":"2026-02-05T05:53:18.903635568Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.3","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T14:07:27.803790200Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9.4","title":"E2E: share/export bundle (manifest + DB + attachments + determinism)","description":"End-to-end verification of share/export bundle creation.\n\nScript:\n- scripts/e2e_share.sh\n\nFlow:\n1. Seed a realistic mailbox DB + attachments (via conformance seeding or direct tool calls).\n2. Run `am share export` (or equivalent) to produce a bundle directory.\n3. Verify bundle correctness:\n   - manifest.json exists and validates expected fields\n   - export DB exists, passes PRAGMA integrity_check\n   - FTS/views exist and basic queries succeed\n   - attachments directory contains all referenced paths\n   - chunking behavior triggers appropriately when DB size threshold exceeded (can simulate with padding)\n4. Determinism check:\n   - Run export twice from same inputs; compare stable hashes of key outputs (manifest + DB + attachment manifests).\n5. Preview + verify subcommands:\n   - Run `am share preview` on the bundle and assert expected summary fields.\n   - Run `am share verify` (or equivalent) and assert success for valid bundle.\n   - Corrupt manifest/attachment reference and assert `verify` fails with clear error.\n6. Signing/encryption (when enabled):\n   - Run signed export and verify signature.\n   - Run encrypted export and verify decrypt roundtrip.\n\nLogging/artifacts:\n- Dump bundle tree + sizes, log PRAGMA results, and hashes.\n- Store under tests/artifacts/share/<timestamp>/.\n\nExit criteria:\n- Any mismatch -> non-zero.\n\n## Acceptance Criteria\n1. scripts/e2e_share.sh runs via scripts/e2e_test.sh share.\n2. Script produces tests/artifacts/share/<timestamp>/ including bundle tree, PRAGMA results, and hashes.\n3. Script asserts manifest/db/attachments consistency and fails on missing referenced paths.\n4. Script asserts deterministic output across two runs from identical inputs (documented hash set).\n5. Preview/verify subcommands are exercised and emit expected success/error semantics.\n6. When signing/encryption are enabled, E2E validates signature and decrypt roundtrip using deterministic fixtures.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T05:53:34.886696183Z","created_by":"ubuntu","updated_at":"2026-02-05T16:17:49.573035910Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9.4","depends_on_id":"br-1uf","type":"blocks","created_at":"2026-02-05T16:17:49.476267906Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.4.1","type":"blocks","created_at":"2026-02-05T14:06:53.918099605Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.4.2","type":"blocks","created_at":"2026-02-05T14:06:54.006077170Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.4.3","type":"blocks","created_at":"2026-02-05T14:06:54.092389831Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.4.4.1","type":"blocks","created_at":"2026-02-05T14:06:54.182943385Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.4.4.2","type":"blocks","created_at":"2026-02-05T14:06:54.271276309Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.4.5","type":"blocks","created_at":"2026-02-05T05:53:34.886696183Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.4.6","type":"blocks","created_at":"2026-02-05T08:50:00.556279549Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.4.7","type":"blocks","created_at":"2026-02-05T14:06:54.361917468Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.5.3","type":"blocks","created_at":"2026-02-05T05:53:34.886696183Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.9","type":"parent-child","created_at":"2026-02-05T05:53:34.886696183Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T14:06:53.826537062Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.4","depends_on_id":"br-3np","type":"blocks","created_at":"2026-02-05T16:17:49.572962733Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9.5","title":"E2E: CLI stability (help text, exit codes, JSON mode)","description":"End-to-end verification that the CLI is stable for humans and automation.\n\nScript:\n- scripts/e2e_cli.sh\n\nChecks:\n- `am --help` and key subcommand `--help` outputs are stable (golden snapshots) OR at minimum contain required commands/flags.\n- Exit codes match expectations for common failure modes (bad args, missing config, bind failure).\n- Machine JSON mode:\n  - `--json` produces schema-stable output for commands that support it (products, archive list, doctor, acks, file_reservations, list-projects/list-acks).\n- Human mode:\n  - frankentui tables render without panic when TTY and degrade gracefully when not.\n\nCoverage additions:\n- products commands, archive save/list/restore, docs insert-blurbs, migrate, clear-and-reset-everything, amctl env/am-run.\n- share wizard error path (missing script) with clear exit code.\n\nLogging/artifacts:\n- Save captured help/output snapshots under tests/artifacts/cli/<timestamp>/.\n\nExit criteria:\n- Any mismatch -> non-zero.\n\n## Acceptance Criteria\n1. scripts/e2e_cli.sh runs via scripts/e2e_test.sh cli.\n2. Script captures help outputs and/or validates against the CLI parity inventory (br-2ei.5.6).\n3. Script validates exit codes for representative failure modes.\n4. Script validates JSON output mode is parseable and schema-stable for covered commands.\n5. Artifacts saved under tests/artifacts/cli/<timestamp>/.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T05:53:45.764307877Z","created_by":"ubuntu","updated_at":"2026-02-05T16:21:45.667199211Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9.5","depends_on_id":"br-2di","type":"blocks","created_at":"2026-02-05T16:19:51.279714636Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5","type":"blocks","created_at":"2026-02-05T16:21:45.571437067Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.1","type":"blocks","created_at":"2026-02-05T14:07:11.048069628Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.10","type":"blocks","created_at":"2026-02-05T15:16:57.498701889Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.11","type":"blocks","created_at":"2026-02-05T15:16:57.594086941Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.12","type":"blocks","created_at":"2026-02-05T15:16:57.688130126Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.13","type":"blocks","created_at":"2026-02-05T15:16:57.788190936Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.14","type":"blocks","created_at":"2026-02-05T15:16:57.880623446Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.15","type":"blocks","created_at":"2026-02-05T15:16:57.975865058Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.2","type":"blocks","created_at":"2026-02-05T05:53:45.764307877Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.3","type":"blocks","created_at":"2026-02-05T05:53:45.764307877Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.4","type":"blocks","created_at":"2026-02-05T05:53:45.764307877Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.5","type":"blocks","created_at":"2026-02-05T05:53:45.764307877Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.6","type":"blocks","created_at":"2026-02-05T14:07:11.132445303Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.7","type":"blocks","created_at":"2026-02-05T16:21:45.667151611Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.8","type":"blocks","created_at":"2026-02-05T15:16:57.309945017Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.5.9","type":"blocks","created_at":"2026-02-05T15:16:57.406599751Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.9","type":"parent-child","created_at":"2026-02-05T05:53:45.764307877Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T14:07:10.958601487Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-3np","type":"blocks","created_at":"2026-02-05T16:19:51.186136809Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.5","depends_on_id":"br-9jl","type":"blocks","created_at":"2026-02-05T16:19:51.377666059Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9.6","title":"E2E: HTTP server parity suite (auth/rate-limit/streamable/mail/CORS/logging)","description":"Add a single HTTP-focused E2E script that exercises the *user-visible* HTTP server surface end-to-end, using the shared harness (br-2ei.9.1).\n\nScript:\n- scripts/e2e_http.sh\n\nCoverage (must be parity-oriented, not \"best-effort\"):\n1. Health + well-known endpoints: /health/* and /.well-known/* payloads + status codes.\n2. Bearer auth:\n   - Authorization required when configured\n   - OPTIONS + /health bypass\n   - constant-time compare (behavioral checks)\n3. JWT auth:\n   - HS256 and JWKS modes (use deterministic test vectors)\n   - aud/iss validation\n   - role claim parsing\n   - failure semantics always 401 {\"detail\":\"Unauthorized\"}\n4. Rate limiting:\n   - Redis backend allow/deny sequences\n   - Redis failure -> memory fallback\n   - identity derivation (sub vs host)\n5. Peer addr + localhost bypass:\n   - localhost allowed only when NO forwarded headers\n   - IPv4/IPv6/IPv4-mapped IPv6 cases\n6. Streamable HTTP MCP:\n   - Accept/Content-Type normalization\n   - base path /api and /api/ semantics\n   - passthrough behavior\n   - localhost Authorization injection when configured\n7. /mail SSR UI:\n   - fetch key pages and assert DOM markers\n   - sanitize XSS payloads\n8. CORS:\n   - OPTIONS preflight headers\n   - default allow-* semantics\n9. Request logging + OTEL:\n   - logs emitted only when enabled\n   - OTEL misconfig doesn't crash\n10. Tool filtering profiles (context reduction):\n   - With filtering disabled: tool list matches full baseline.\n   - With filtering enabled (minimal + one custom include/exclude case):\n     - `tools/list` is filtered\n     - `resource://tooling/directory` reflects filtered tools/clusters\n11. Instrumentation (query tracking):\n   - With instrumentation enabled, at least one DB-backed tool call emits a `tool_query_stats` log entry.\n12. ACK TTL background worker (+ optional escalation):\n   - With ACK_TTL enabled (ttl=0), create an ack_required message and assert logs contain `ack_overdue`.\n   - With escalation mode file_reservation, assert a reservation is created (resource read or DB query) without crashing.\n\nArtifacts/logging:\n- tests/artifacts/http/<timestamp>/\n- For each case: record request (curl args), response status, headers, body, and expected-vs-actual.\n- When applicable, include server stdout/stderr logs and config env snapshot (redacting secrets).\n\n## Acceptance Criteria\n1. scripts/e2e_http.sh exists and can be run via scripts/e2e_test.sh http.\n2. Script exits non-zero on first mismatch and prints expected vs actual.\n3. Artifacts include per-case HTTP transcripts + server logs.\n4. Script is deterministic (no random ports without recording, stable vectors).\n5. Tool filtering checks cover at least: disabled baseline + minimal profile + one custom include/exclude case.\n6. Instrumentation check asserts presence of `tool_query_stats` in captured server logs.\n7. ACK TTL check asserts presence of `ack_overdue` (and file_reservation escalation when enabled).","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T06:08:22.826465268Z","created_by":"ubuntu","updated_at":"2026-02-05T16:21:53.112112819Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm","type":"blocks","created_at":"2026-02-05T16:21:53.112065981Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.1.5","type":"blocks","created_at":"2026-02-05T06:08:39.251281411Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.10.6","type":"blocks","created_at":"2026-02-05T07:34:16.695583357Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.2.5","type":"blocks","created_at":"2026-02-05T06:08:39.333666265Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.3.4","type":"blocks","created_at":"2026-02-05T06:08:39.420350399Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.4.6","type":"blocks","created_at":"2026-02-05T06:08:39.503300748Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.5.5","type":"blocks","created_at":"2026-02-05T06:08:39.587091700Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.6.4","type":"blocks","created_at":"2026-02-05T06:08:39.675539136Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.7","type":"blocks","created_at":"2026-02-05T06:08:39.758756769Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.8","type":"blocks","created_at":"2026-02-05T06:08:39.841729059Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-1bm.9","type":"blocks","created_at":"2026-02-05T06:08:39.924846663Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-2ei.10.3","type":"blocks","created_at":"2026-02-05T06:57:36.927404078Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-2ei.11.3","type":"blocks","created_at":"2026-02-05T06:57:37.009782894Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-2ei.9","type":"parent-child","created_at":"2026-02-05T06:08:22.826465268Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.6","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T06:08:39.169446083Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9.7","title":"E2E: LLM llm_mode smoke (stubbed)","description":"E2E: LLM llm_mode smoke (stubbed, offline).\n\nScope:\n- Start server with LLM enabled and stubbed completion client.\n- Exercise `summarize_thread` with llm_mode=true and `macro_prepare_thread` llm_mode path.\n- Validate refined summary fields and error fallback when stub returns invalid JSON.\n\nLogging/artifacts:\n- Capture HTTP transcripts + tool payloads.\n- Store artifacts under tests/artifacts/llm/<timestamp>/.\n- Emit expected vs actual JSON diffs on mismatch.\n\nDependencies:\n- br-2ei.9.1 (E2E harness)\n- br-2ei.13.2 (LLM impl)\n- br-2ei.13.3 (LLM tests/spec)\n\n## Acceptance Criteria\n1. E2E test uses a deterministic stubbed LLM client and runs via `scripts/e2e_test.sh` (llm path).\n2. `summarize_thread` with llm_mode=true returns refined fields that match expected JSON fixtures.\n3. `macro_prepare_thread` with llm_mode=true exercises the LLM path and returns refined summaries.\n4. Invalid JSON from the stub triggers the legacy fallback behavior (non-LLM summary + logged error) and is asserted.\n5. Artifacts (requests/responses + diffs) are written to `tests/artifacts/llm/<timestamp>/`.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T08:15:12.039153780Z","created_by":"ubuntu","updated_at":"2026-02-05T16:21:59.682727712Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9.7","depends_on_id":"br-2ei.13","type":"blocks","created_at":"2026-02-05T16:21:59.682688990Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.7","depends_on_id":"br-2ei.13.2","type":"blocks","created_at":"2026-02-05T08:15:20.655784860Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.7","depends_on_id":"br-2ei.13.3","type":"blocks","created_at":"2026-02-05T08:15:25.092127090Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.7","depends_on_id":"br-2ei.9","type":"parent-child","created_at":"2026-02-05T08:15:12.039153780Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.7","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T08:15:17.568158415Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2ei.9.8","title":"E2E: Notifications signal files","description":"E2E: Notifications (signal files) parity.\n\nScope:\n- Start server with notifications enabled.\n- send_message to multiple recipients (to/cc/bcc) and assert signal files for to+cc only.\n- fetch_inbox clears signal for that agent; verify pending list updates.\n- debounce behavior: repeated sends within window do not spam signals (per legacy spec).\n\nLogging/artifacts:\n- Capture filesystem snapshots of signals dir before/after.\n- Store artifacts under tests/artifacts/notifications/<timestamp>/.\n- Emit expected vs actual file lists + JSON diffs on mismatch.\n\nDependencies:\n- br-2ei.9.1 (E2E harness)\n- br-2ei.12.2 (Notifications impl)\n- br-2ei.12.3 (Notifications tests/spec)\n\n## Acceptance Criteria\n1. E2E test runs via `scripts/e2e_test.sh` notifications path and uses temp dirs (no destructive commands).\n2. After send_message, signals are emitted for `to` + `cc` recipients only; `bcc` produces none.\n3. fetch_inbox clears the signal for that agent and the pending list is updated accordingly.\n4. Debounce behavior is verified: repeated sends within the debounce window do not create duplicate signal entries (assert via file list + timestamps or sequence numbers).\n5. Failures emit clear diffs and artifacts are written to `tests/artifacts/notifications/<timestamp>/`.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T08:15:49.568178405Z","created_by":"ubuntu","updated_at":"2026-02-05T16:22:05.558324614Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2ei.9.8","depends_on_id":"br-2ei.12","type":"blocks","created_at":"2026-02-05T16:22:05.558269310Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.8","depends_on_id":"br-2ei.12.2","type":"blocks","created_at":"2026-02-05T08:16:04.913015385Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.8","depends_on_id":"br-2ei.12.3","type":"blocks","created_at":"2026-02-05T08:16:08.094559926Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.8","depends_on_id":"br-2ei.9","type":"parent-child","created_at":"2026-02-05T08:15:49.568178405Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-2ei.9.8","depends_on_id":"br-2ei.9.1","type":"blocks","created_at":"2026-02-05T08:15:59.389033120Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2he","title":"Share: viewer assets + export data + scaffolding","description":"## Objective\nImplement share pipeline Steps 10–12: copy viewer assets, export viewer bootstrap data, and write bundle scaffolding.\n\n## Scope\n- Copy `viewer_assets` into bundle output.\n- Export `messages.json` + `meta.json` for viewer bootstrap (limit default 500).\n- Write scaffolding files: `manifest.json`, README, `_headers`, `HOW_TO_DEPLOY`, `.nojekyll`, `index.html`.\n\n## Tests\n- Integration tests verifying asset presence and bootstrap JSON schema.\n- Snapshot tests for scaffolding files.\n\n## Logging/Artifacts\n- Store scaffolding outputs under `tests/artifacts/share/scaffolding/<timestamp>/`.\n\n## Acceptance Criteria\n1. Viewer assets are copied with correct file list and content.\n2. Exported JSON matches legacy schema and limits.\n3. Bundle scaffolding files are created and deterministic.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T16:16:23.424466902Z","created_by":"ubuntu","updated_at":"2026-02-05T17:54:16.508557943Z","closed_at":"2026-02-05T17:54:16.508539979Z","close_reason":"Viewer assets/export/scaffolding already implemented in bundle.rs with tests; viewer_* tests pass (manifest_* blocked by current core config compile errors)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2he","depends_on_id":"br-1uf","type":"parent-child","created_at":"2026-02-05T16:16:28.198739271Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-2yw0","title":"Guard parity: unit + integration tests","description":"## Objective\nAdd unit/integration tests for guard behavior beyond the E2E repo test.\n\n## Scope\n- Path matching (pathspec + fnmatch fallback).\n- Pre‑commit scanning (staged files, rename handling).\n- Pre‑push scanning (commit range).\n- Gate on `WORKTREES_ENABLED`/`GIT_IDENTITY_ENABLED` per legacy guard.py.\n\n## Tests\n- Unit tests for pathspec matches and denylist/allowlist behavior.\n- Integration tests using temp git repo with staged changes and renames.\n\n## Logging/Artifacts\n- Store guard decision logs under `tests/artifacts/guard/<timestamp>/`.\n\n## Acceptance Criteria\n1. Guard behavior matches legacy for staged/renamed files and gate flags.\n2. Unit/integration tests are deterministic and isolate temp repos.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T16:20:57.657586279Z","created_by":"ubuntu","updated_at":"2026-02-05T16:21:03.377772813Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-2yw0","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T16:21:03.377702360Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-36w","title":"Config parity: .env loading + env var coverage","description":"## Objective\nMatch legacy configuration behavior, including `.env` loading and full env var coverage.\n\n## Scope\n- `.env` loading behavior (python‑decouple parity):\n  - if .env missing → empty repository fallback; env vars only.\n  - canonical env var set only if missing when alias present (LLM bridge).\n- Ensure all env vars from spec are supported:\n  - WORKTREES_ENABLED + GIT_IDENTITY_ENABLED gate\n  - ALLOW_ABSOLUTE_ATTACHMENT_PATHS\n  - TOOLS_LOG_ENABLED, LOG_RICH_ENABLED\n  - NOTIFICATIONS_* defaults\n  - HTTP_* (CORS/JWT/RBAC/rate limit)\n  - LLM_* defaults\n- CSV parsing for list settings (roles, tools, clusters).\n- Match default values exactly.\n\n## Tests\n- Unit tests for .env presence/absence handling.\n- Table‑driven env parsing tests for bools/ints/CSV lists.\n\n## Logging/Artifacts\n- Store parsed config snapshots under `tests/artifacts/config/<timestamp>/`.\n\n## Acceptance Criteria\n1. Rust config matches legacy defaults and parsing semantics.\n2. `.env` loading behavior matches python‑decouple (graceful missing file).\n3. All env variables from spec are supported and tested.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T16:18:09.094825172Z","created_by":"ubuntu","updated_at":"2026-02-05T18:02:50.832107234Z","closed_at":"2026-02-05T18:02:50.832088128Z","close_reason":"Implemented .env loading + env var coverage + tests; checks blocked by sqlmodel-sqlite duplicate defs","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-36w","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T16:18:12.895192349Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-3gs","title":"Share: sign manifest + encrypt bundle + deterministic ZIP","description":"## Objective\nImplement share pipeline Steps 13–15: Ed25519 signing, age encryption, and deterministic ZIP packaging.\n\n## Scope\n- **sign_manifest**: sign manifest.json with Ed25519 seed; optionally output public key.\n- **encrypt_bundle**: age encryption when recipients provided; output `.age` file; retain clear bundle if required by legacy.\n- **package_directory_as_zip**: deterministic ZIP (stable ordering, timestamps, compression settings).\n\n## Tests\n- Unit tests for signature verification and age encrypt/decrypt.\n- Integration tests for deterministic ZIP hash.\n\n## Logging/Artifacts\n- Store signatures, public keys, and zip hashes under `tests/artifacts/share/crypto/<timestamp>/`.\n\n## Acceptance Criteria\n1. Manifest signatures validate correctly with provided public key.\n2. Encryption outputs readable bundles via `share decrypt`.\n3. ZIP packaging is deterministic (stable hash across runs).","status":"in_progress","priority":1,"issue_type":"task","created_at":"2026-02-05T16:16:36.383969609Z","created_by":"ubuntu","updated_at":"2026-02-05T18:05:04.250862140Z","close_reason":"Added age encrypt/decrypt roundtrip test + deterministic zip test; verified crypto + zip functionality","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-3gs","depends_on_id":"br-1uf","type":"parent-child","created_at":"2026-02-05T16:16:41.980704900Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-3h94","title":"Error type mapping parity (CAPABILITY_DENIED, NOT_FOUND, etc.)","description":"## Objective\nEnsure error type mapping and JSON error shapes match legacy across tools/resources.\n\n## Scope\n- Error codes list: `CAPABILITY_DENIED`, `NOT_FOUND`, `INVALID_ARGUMENT`, `TYPE_ERROR`, `MISSING_FIELD`, `DATABASE_POOL_EXHAUSTED`, `TIMEOUT`, `GIT_INDEX_LOCK`, `RESOURCE_EXHAUSTED`, `CONTACT_REQUIRED`, `CONTACT_BLOCKED`, `OS_ERROR`, `DATABASE_ERROR`, `RESOURCE_BUSY`, `PERMISSION_ERROR`, `CONNECTION_ERROR`, `UNHANDLED_EXCEPTION`.\n- Map internal errors to these codes consistently.\n- Ensure tool/resource responses include legacy error fields and HTTP error status where applicable.\n\n## Tests\n- Unit tests for error mapping table.\n- Conformance tests for representative error cases (missing fields, invalid args, capability denied, not found).\n\n## Logging/Artifacts\n- Store error responses under `tests/artifacts/errors/<timestamp>/`.\n\n## Acceptance Criteria\n1. All error codes and shapes match legacy.\n2. Conformance tests include error cases for each category.","status":"in_progress","priority":1,"issue_type":"task","created_at":"2026-02-05T16:18:30.739623609Z","created_by":"ubuntu","updated_at":"2026-02-05T17:53:11.408499478Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-3h94","depends_on_id":"br-2ei","type":"parent-child","created_at":"2026-02-05T16:18:35.625592551Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-3ie","title":"MCP Agent Mail Rust: 100% feature parity + conformance + benchmarks","description":"Goal: complete the Rust port of legacy_python_mcp_agent_mail_code with 100% behavior/feature coverage, proven by fixture-based conformance tests + benchmarks (similar standard as rich_rust/beads_rust).\n\nNon-negotiables:\n- Prefer local crates over upstream ecosystem where applicable:\n  - MCP: /dp/fastmcp_rust\n  - SQLite: /dp/sqlmodel_rust\n  - IO/concurrency: /dp/asupersync (avoid tokio unless unavoidable)\n  - Console UI: /dp/frankentui\n  - Beads: /dp/beads_rust\n  - Agent detection: /dp/coding_agent_session_search\n- No destructive commands or file deletions without explicit permission.\n\nAcceptance criteria:\n-  passes\n-  passes\n- \nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 2 tests\ntest load_and_validate_fixture_schema ... ok\ntest run_fixtures_against_rust_server_router ... ok\n\ntest result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.08s\n\n\nrunning 7 tests\ntest config::tests::test_default_config ... ok\ntest error::tests::test_error_types ... ok\ntest config::tests::test_from_env ... ok\ntest error::tests::test_recoverable ... ok\ntest models::tests::test_invalid_agent_names ... ok\ntest models::tests::test_generate_agent_name ... ok\ntest models::tests::test_valid_agent_names ... ok\n\ntest result: ok. 7 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 8 tests\ntest pool::tests::test_sqlite_path_parsing ... ok\ntest timestamps::tests::test_iso_to_micros ... ok\ntest timestamps::tests::test_epoch_boundary ... ok\ntest timestamps::tests::test_negative_timestamps ... ok\ntest timestamps::tests::test_now_micros ... ok\ntest timestamps::tests::test_round_trip ... ok\ntest timestamps::tests::test_micros_to_iso ... ok\ntest pool::tests::test_schema_init_in_memory ... ok\n\ntest result: ok. 8 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 1 test\ntest crates/mcp-agent-mail-core/src/models.rs - models::is_valid_agent_name (line 318) ... ok\n\ntest result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\nall doctests ran in 0.18s; merged doctests compilation took 0.17s\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s passes\n- Conformance harness covers *all* MCP tools and resources, including error cases + nondeterministic field normalization.\n- Benchmarks include DB/tool hot paths + archive write throughput once storage layer is implemented.\n","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-02-05T05:04:26.956492167Z","created_by":"ubuntu","updated_at":"2026-02-05T05:05:57.078349046Z","closed_at":"2026-02-05T05:05:57.078301787Z","close_reason":"Superseded by br-2ei (correct prefix + clean description)","external_ref":"bd-179","source_repo":".","compaction_level":0,"original_size":0}
{"id":"br-3np","title":"CLI: share export/update parity (interactive + defaults)","description":"## Objective\nImplement `share export` and `share update` commands with legacy behavior (including `--interactive`).\n\n## Scope\n- Flags: `--output/-o`, `--interactive/-i`, `--project/-p` (repeat), thresholds, scrub preset, chunk settings, `--dry-run`, `--zip`, `--signing-key`, `--signing-public-out`, `--age-recipient` (repeat).\n- Defaults: inline=64KiB, detach=25MiB, chunk threshold=20MiB, chunk size=4MiB; scrub preset `standard`.\n- Validation: invalid preset exits 1; enforce chunk size >=1024; auto‑adjust detach threshold if <= inline.\n- `share export`:\n  - `--dry-run` creates temp output + prints summary only.\n  - `--interactive` wizard prompts and overrides flags.\n- `share update`:\n  - loads config from existing `manifest.json` and stored export config.\n  - default `--zip` is **false** (contrast export default true).\n\n## Tests\n- Unit tests for flag parsing + defaults.\n- Integration tests with temp bundle export/update; verify manifest config updates.\n- Golden output for `--dry-run` summary.\n\n## Logging/Artifacts\n- Store CLI outputs under `tests/artifacts/cli/share/<timestamp>/`.\n\n## Acceptance Criteria\n1. share export/update match legacy flags, defaults, and exit codes.\n2. interactive mode overrides flags and produces identical outputs to legacy.\n3. dry-run produces no bundle artifacts but prints expected summary.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T16:16:51.526681473Z","created_by":"ubuntu","updated_at":"2026-02-05T16:17:33.897026002Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-3np","depends_on_id":"br-1uf","type":"blocks","created_at":"2026-02-05T16:17:33.896970708Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-3np","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T16:16:56.127446696Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-3op","title":"Share: bundle attachments (inline/detach/external/missing)","description":"## Objective\nImplement share pipeline Step 8: attachment bundling and classification.\n\n## Scope\n- Thresholds: inline <= 64KiB, detach >= 25MiB (defaults, override via CLI).\n- Classify attachments into inline (embed), detached (file), external (URL), missing.\n- Generate attachment manifest entries with hashes and metadata.\n- Honor `convert_images` and attachment embed policy.\n\n## Tests\n- Unit tests for threshold logic and classification.\n- Integration tests with sample attachments (inline, large, external, missing).\n\n## Logging/Artifacts\n- Store attachment manifests and hashes under `tests/artifacts/share/attachments/<timestamp>/`.\n\n## Acceptance Criteria\n1. Attachment classification matches legacy thresholds and rules.\n2. Manifests include correct hashes and metadata.\n3. Missing/external attachments are handled gracefully with clear markers.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T16:15:56.123691848Z","created_by":"ubuntu","updated_at":"2026-02-05T18:00:56.435100382Z","closed_at":"2026-02-05T18:00:56.435066689Z","close_reason":"Attachment bundling/classification already implemented in bundle.rs; bundle_* tests pass","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-3op","depends_on_id":"br-1uf","type":"parent-child","created_at":"2026-02-05T16:16:02.590128847Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-9jl","title":"CLI: share verify/decrypt parity (signature + age)","description":"## Objective\nImplement `share verify` and `share decrypt` with legacy semantics.\n\n## Scope\n- `share verify`:\n  - Validate SRI hashes and optional Ed25519 signature.\n  - `--public-key` uses provided base64 key; else use manifest signature.\n- `share decrypt`:\n  - `--output` defaults to filename sans `.age` (or `_decrypted`).\n  - `--identity` (age key file) is mutually exclusive with `--passphrase`.\n\n## Tests\n- Unit tests for signature verification and decrypt flag validation.\n- Integration tests decrypting a bundle produced by share export.\n\n## Logging/Artifacts\n- Store verification results under `tests/artifacts/cli/share_verify/<timestamp>/`.\n\n## Acceptance Criteria\n1. share verify/decrypt match legacy flags, defaults, and exit codes.\n2. Signature validation and age decrypt succeed on valid inputs and fail loudly on invalid.\n3. Mutual‑exclusion flag handling matches legacy.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-05T16:17:17.420980860Z","created_by":"ubuntu","updated_at":"2026-02-05T16:17:44.284991973Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-9jl","depends_on_id":"br-1uf","type":"blocks","created_at":"2026-02-05T16:17:44.284948962Z","created_by":"ubuntu","metadata":"{}","thread_id":""},{"issue_id":"br-9jl","depends_on_id":"br-2ei.5","type":"parent-child","created_at":"2026-02-05T16:17:23.973796081Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-ave","title":"Share: sqlite snapshot + project scope","description":"## Objective\nImplement share pipeline Steps 1–2: `create_sqlite_snapshot` and `apply_project_scope` with exact legacy semantics.\n\n## Scope\n- **create_sqlite_snapshot**:\n  - Resolve destination path; create parent dirs.\n  - Error if destination exists (never overwrite).\n  - Open source DB; run `PRAGMA wal_checkpoint(PASSIVE)` when enabled.\n  - Use sqlite backup API to copy source → destination.\n- **apply_project_scope**:\n  - Load projects (id, slug, human_key); error if none.\n  - If identifiers empty → no deletions.\n  - Match identifiers case‑insensitive by slug or human_key; error on unknown.\n  - Delete order per spec (agent_links, sibling_suggestions, messages + recipients, file_reservations, agents, projects).\n\n## Tests\n- Unit tests for identifier matching + error cases.\n- Integration tests with temp DB and multiple projects; verify deletions and counts.\n\n## Logging/Artifacts\n- Save before/after row counts under `tests/artifacts/share/snapshot/<timestamp>/`.\n\n## Acceptance Criteria\n1. Snapshot creation refuses overwrite and produces byte‑identical DB backup.\n2. Project scoping deletes only disallowed project data in the specified order.\n3. Tests are deterministic and isolated to temp DB paths.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-05T16:15:05.665286231Z","created_by":"ubuntu","updated_at":"2026-02-05T17:52:39.363640110Z","closed_at":"2026-02-05T17:52:39.363620834Z","close_reason":"Implemented backup snapshot + scope parity","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-ave","depends_on_id":"br-1uf","type":"parent-child","created_at":"2026-02-05T16:15:11.619634150Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
{"id":"br-xy39","title":"HTTP CORS parity (dev defaults + allowlist)","description":"## Objective\nImplement CORS behavior parity for HTTP server.\n\n## Scope\n- Env vars: `HTTP_CORS_ENABLED`, `HTTP_CORS_ORIGINS`, `HTTP_CORS_ALLOW_CREDENTIALS`, `HTTP_CORS_ALLOW_METHODS`, `HTTP_CORS_ALLOW_HEADERS`.\n- Default: enabled in development, disabled in production (legacy behavior).\n- Allowlist handling: empty origins → `*`.\n\n## Tests\n- Integration tests for preflight OPTIONS and response headers.\n- E2E coverage in HTTP suite.\n\n## Logging/Artifacts\n- Capture CORS headers under `tests/artifacts/http/cors/<timestamp>/`.\n\n## Acceptance Criteria\n1. CORS headers match legacy defaults and configuration.\n2. Preflight responses are correct (status and headers).","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T16:19:01.692103864Z","created_by":"ubuntu","updated_at":"2026-02-05T16:20:28.309033007Z","closed_at":"2026-02-05T16:20:28.309016766Z","close_reason":"Duplicate of br-1bm.7 (CORS parity already tracked)","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"br-xy39","depends_on_id":"br-1bm","type":"parent-child","created_at":"2026-02-05T16:19:06.449676690Z","created_by":"ubuntu","metadata":"{}","thread_id":""}]}
