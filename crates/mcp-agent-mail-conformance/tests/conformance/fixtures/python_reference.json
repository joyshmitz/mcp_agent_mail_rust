{
  "version": "legacy-python@0.3.0",
  "generated_at": "1970-01-01T00:00:00Z",
  "tools": {
    "health_check": {
      "cases": [
        {
          "name": "default",
          "input": {},
          "expect": {
            "ok": {
              "status": "ok",
              "environment": "development",
              "http_host": "127.0.0.1",
              "http_port": 8765,
              "database_url": null,
              "pool_utilization": {
                "active": 0,
                "idle": 0,
                "total": 0,
                "pending": 0,
                "peak_active": 0,
                "utilization_pct": 0,
                "acquire_p50_ms": 0,
                "acquire_p95_ms": 0,
                "acquire_p99_ms": 0,
                "over_80_for_s": 0,
                "warning": false
              }
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/database_url",
              "/pool_utilization/acquire_p50_ms",
              "/pool_utilization/acquire_p95_ms",
              "/pool_utilization/acquire_p99_ms"
            ]
          }
        }
      ]
    },
    "ensure_project": {
      "cases": [
        {
          "name": "abs_path_backend",
          "input": {
            "human_key": "/abs/path/backend"
          },
          "expect": {
            "ok": {
              "id": 1,
              "slug": "abs-path-backend",
              "human_key": "/abs/path/backend",
              "created_at": null,
              "identity_mode_used": "dir",
              "canonical_path": null,
              "repo_root": null,
              "git_common_dir": null,
              "branch": null,
              "worktree_name": null,
              "core_ignorecase": null,
              "normalized_remote": null,
              "project_uid": "6b94bcb905177dba1f42",
              "discovery": null
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/canonical_path",
              "/created_at",
              "/git_common_dir"
            ]
          }
        },
        {
          "name": "relative_path_error",
          "input": {
            "human_key": "./backend"
          },
          "expect": {
            "err": {
              "message_contains": "absolute directory path"
            }
          }
        }
      ]
    },
    "ensure_product": {
      "cases": [
        {
          "name": "product_widget_bus",
          "input": {
            "product_key": "0123456789abcdef0123",
            "name": "WidgetBus"
          },
          "expect": {
            "ok": {
              "id": 1,
              "product_uid": "0123456789abcdef0123",
              "name": "WidgetBus",
              "created_at": null
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/created_at"
            ]
          }
        }
      ]
    },
    "products_link": {
      "cases": [
        {
          "name": "link_product_to_backend",
          "input": {
            "product_key": "0123456789abcdef0123",
            "project_key": "abs-path-backend"
          },
          "expect": {
            "ok": {
              "product": {
                "id": 1,
                "product_uid": "0123456789abcdef0123",
                "name": "WidgetBus"
              },
              "project": {
                "id": 1,
                "slug": "abs-path-backend",
                "human_key": "/abs/path/backend"
              },
              "linked": true
            }
          }
        }
      ]
    },
    "acquire_build_slot": {
      "cases": [
        {
          "name": "acquire_build_slot_default",
          "input": {
            "project_key": "abs-path-backend",
            "agent_name": "BlueLake",
            "slot": "build",
            "ttl_seconds": 3600,
            "exclusive": true
          },
          "expect": {
            "ok": {
              "granted": {
                "slot": "build",
                "agent": "BlueLake",
                "branch": null,
                "exclusive": true,
                "acquired_ts": null,
                "expires_ts": null
              },
              "conflicts": []
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/granted/acquired_ts",
              "/granted/expires_ts"
            ]
          }
        }
      ]
    },
    "renew_build_slot": {
      "cases": [
        {
          "name": "renew_build_slot_default",
          "input": {
            "project_key": "abs-path-backend",
            "agent_name": "BlueLake",
            "slot": "build",
            "extend_seconds": 600
          },
          "expect": {
            "ok": {
              "renewed": true,
              "expires_ts": null
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/expires_ts"
            ]
          }
        }
      ]
    },
    "release_build_slot": {
      "cases": [
        {
          "name": "release_build_slot_default",
          "input": {
            "project_key": "abs-path-backend",
            "agent_name": "BlueLake",
            "slot": "build"
          },
          "expect": {
            "ok": {
              "released": true,
              "released_at": null
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/released_at"
            ]
          }
        }
      ]
    },
    "register_agent": {
      "cases": [
        {
          "name": "blue_lake",
          "input": {
            "project_key": "abs-path-backend",
            "program": "codex-cli",
            "model": "gpt-5",
            "name": "BlueLake",
            "task_description": "sender"
          },
          "expect": {
            "ok": {
              "id": 1,
              "name": "BlueLake",
              "program": "codex-cli",
              "model": "gpt-5",
              "task_description": "sender",
              "inception_ts": null,
              "last_active_ts": null,
              "project_id": 1,
              "attachments_policy": "auto"
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/inception_ts",
              "/last_active_ts"
            ]
          }
        },
        {
          "name": "green_castle",
          "input": {
            "project_key": "abs-path-backend",
            "program": "codex-cli",
            "model": "gpt-5",
            "name": "GreenCastle",
            "task_description": "recipient"
          },
          "expect": {
            "ok": {
              "id": 2,
              "name": "GreenCastle",
              "program": "codex-cli",
              "model": "gpt-5",
              "task_description": "recipient",
              "inception_ts": null,
              "last_active_ts": null,
              "project_id": 1,
              "attachments_policy": "auto"
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/inception_ts",
              "/last_active_ts"
            ]
          }
        }
      ]
    },
    "create_agent_identity": {
      "cases": [
        {
          "name": "create_orange_fox",
          "input": {
            "project_key": "abs-path-backend",
            "program": "codex-cli",
            "model": "gpt-5",
            "name_hint": "OrangeFox",
            "task_description": "fresh identity"
          },
          "expect": {
            "ok": {
              "id": 3,
              "name": "OrangeFox",
              "program": "codex-cli",
              "model": "gpt-5",
              "task_description": "fresh identity",
              "inception_ts": null,
              "last_active_ts": null,
              "project_id": 1,
              "attachments_policy": "auto"
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/inception_ts",
              "/last_active_ts"
            ]
          }
        }
      ]
    },
    "request_contact": {
      "cases": [
        {
          "name": "bl_to_gc",
          "input": {
            "project_key": "abs-path-backend",
            "from_agent": "BlueLake",
            "to_agent": "GreenCastle",
            "ttl_seconds": 86400
          },
          "expect": {
            "ok": {
              "from": "BlueLake",
              "from_project": "/abs/path/backend",
              "to": "GreenCastle",
              "to_project": "/abs/path/backend",
              "status": "pending",
              "expires_ts": null
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/expires_ts"
            ]
          }
        }
      ]
    },
    "respond_contact": {
      "cases": [
        {
          "name": "gc_approves_bl",
          "input": {
            "project_key": "abs-path-backend",
            "from_agent": "BlueLake",
            "to_agent": "GreenCastle",
            "accept": true,
            "ttl_seconds": 86400
          },
          "expect": {
            "ok": {
              "from": "BlueLake",
              "to": "GreenCastle",
              "approved": true,
              "expires_ts": null,
              "updated": 1
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/expires_ts"
            ]
          }
        }
      ]
    },
    "list_contacts": {
      "cases": [
        {
          "name": "list_contacts_bluelake",
          "input": {
            "project_key": "abs-path-backend",
            "agent_name": "BlueLake"
          },
          "expect": {
            "ok": [
              {
                "to": "GreenCastle",
                "status": "approved",
                "reason": "",
                "updated_ts": null,
                "expires_ts": null
              }
            ]
          },
          "normalize": {
            "ignore_json_pointers": [
              "/0/expires_ts",
              "/0/updated_ts"
            ]
          }
        },
        {
          "name": "list_contacts_greencastle",
          "input": {
            "project_key": "abs-path-backend",
            "agent_name": "GreenCastle"
          },
          "expect": {
            "ok": []
          }
        }
      ]
    },
    "set_contact_policy": {
      "cases": [
        {
          "name": "set_contact_policy_gc_contacts_only",
          "input": {
            "project_key": "abs-path-backend",
            "agent_name": "GreenCastle",
            "policy": "contacts_only"
          },
          "expect": {
            "ok": {
              "agent": "GreenCastle",
              "policy": "contacts_only"
            }
          }
        }
      ]
    },
    "send_message": {
      "cases": [
        {
          "name": "urgent_ack_required",
          "input": {
            "project_key": "abs-path-backend",
            "sender_name": "BlueLake",
            "to": [
              "GreenCastle"
            ],
            "subject": "Hello",
            "body_md": "Test",
            "importance": "urgent",
            "ack_required": true
          },
          "expect": {
            "ok": {
              "deliveries": [
                {
                  "project": "/abs/path/backend",
                  "payload": {
                    "id": 2,
                    "project_id": 1,
                    "sender_id": 1,
                    "thread_id": null,
                    "subject": "Hello",
                    "importance": "urgent",
                    "ack_required": true,
                    "created_ts": null,
                    "attachments": [],
                    "body_md": "Test",
                    "from": "BlueLake",
                    "to": [
                      "GreenCastle"
                    ],
                    "cc": [],
                    "bcc": []
                  }
                }
              ],
              "count": 1,
              "attachments": []
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/deliveries/0/payload/created_ts"
            ]
          }
        },
        {
          "name": "nonexistent_sender_error",
          "input": {
            "project_key": "abs-path-backend",
            "sender_name": "NonExistentAgent",
            "to": [
              "GreenCastle"
            ],
            "subject": "Should fail",
            "body_md": "This should fail because sender doesn't exist."
          },
          "expect": {
            "err": {
              "message_contains": "not found"
            }
          }
        },
        {
          "name": "llm_thread_t1_root",
          "input": {
            "project_key": "abs-path-backend",
            "sender_name": "BlueLake",
            "to": [
              "GreenCastle"
            ],
            "subject": "LLM Thread T-1",
            "body_md": "- TODO: deploy to staging\n- discussed API changes\n",
            "thread_id": "T-1"
          },
          "expect": {
            "ok": {
              "deliveries": [
                {
                  "project": "/abs/path/backend",
                  "payload": {
                    "id": 3,
                    "project_id": 1,
                    "sender_id": 1,
                    "thread_id": "T-1",
                    "subject": "LLM Thread T-1",
                    "importance": "normal",
                    "ack_required": false,
                    "created_ts": null,
                    "attachments": [],
                    "body_md": "- TODO: deploy to staging\n- discussed API changes\n",
                    "from": "BlueLake",
                    "to": [
                      "GreenCastle"
                    ],
                    "cc": [],
                    "bcc": []
                  }
                }
              ],
              "count": 1,
              "attachments": []
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/deliveries/0/payload/created_ts"
            ]
          }
        },
        {
          "name": "llm_thread_t2_root",
          "input": {
            "project_key": "abs-path-backend",
            "sender_name": "BlueLake",
            "to": [
              "GreenCastle"
            ],
            "subject": "LLM Thread T-2",
            "body_md": "- NEXT: migrate DB\n- ACTION: run script\n",
            "thread_id": "T-2"
          },
          "expect": {
            "ok": {
              "deliveries": [
                {
                  "project": "/abs/path/backend",
                  "payload": {
                    "id": 4,
                    "project_id": 1,
                    "sender_id": 1,
                    "thread_id": "T-2",
                    "subject": "LLM Thread T-2",
                    "importance": "normal",
                    "ack_required": false,
                    "created_ts": null,
                    "attachments": [],
                    "body_md": "- NEXT: migrate DB\n- ACTION: run script\n",
                    "from": "BlueLake",
                    "to": [
                      "GreenCastle"
                    ],
                    "cc": [],
                    "bcc": []
                  }
                }
              ],
              "count": 1,
              "attachments": []
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/deliveries/0/payload/created_ts"
            ]
          }
        }
      ]
    },
    "reply_message": {
      "cases": [
        {
          "name": "reply_in_thread",
          "input": {
            "project_key": "abs-path-backend",
            "message_id": 2,
            "sender_name": "GreenCastle",
            "body_md": "Reply"
          },
          "expect": {
            "ok": {
              "id": 5,
              "project_id": 1,
              "sender_id": 2,
              "thread_id": "2",
              "subject": "Re: Hello",
              "importance": "urgent",
              "ack_required": true,
              "created_ts": null,
              "attachments": [],
              "body_md": "Reply",
              "from": "GreenCastle",
              "to": [
                "BlueLake"
              ],
              "cc": [],
              "bcc": [],
              "reply_to": 2,
              "deliveries": [
                {
                  "project": "/abs/path/backend",
                  "payload": {
                    "id": 5,
                    "project_id": 1,
                    "sender_id": 2,
                    "thread_id": "2",
                    "subject": "Re: Hello",
                    "importance": "urgent",
                    "ack_required": true,
                    "created_ts": null,
                    "attachments": [],
                    "body_md": "Reply",
                    "from": "GreenCastle",
                    "to": [
                      "BlueLake"
                    ],
                    "cc": [],
                    "bcc": []
                  }
                }
              ],
              "count": 1
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/created_ts",
              "/deliveries/0/payload/created_ts"
            ]
          }
        },
        {
          "name": "llm_thread_t1_reply",
          "input": {
            "project_key": "abs-path-backend",
            "message_id": 3,
            "sender_name": "GreenCastle",
            "body_md": "- ACK: will deploy\n- [ ] TODO: update docs\n`api/v2/users`\n@Carol\n"
          },
          "expect": {
            "ok": {
              "id": 6,
              "project_id": 1,
              "sender_id": 2,
              "thread_id": "T-1",
              "subject": "Re: LLM Thread T-1",
              "importance": "normal",
              "ack_required": false,
              "created_ts": null,
              "attachments": [],
              "body_md": "- ACK: will deploy\n- [ ] TODO: update docs\n`api/v2/users`\n@Carol\n",
              "from": "GreenCastle",
              "to": [
                "BlueLake"
              ],
              "cc": [],
              "bcc": [],
              "reply_to": 3,
              "deliveries": [
                {
                  "project": "/abs/path/backend",
                  "payload": {
                    "id": 6,
                    "project_id": 1,
                    "sender_id": 2,
                    "thread_id": "T-1",
                    "subject": "Re: LLM Thread T-1",
                    "importance": "normal",
                    "ack_required": false,
                    "created_ts": null,
                    "attachments": [],
                    "body_md": "- ACK: will deploy\n- [ ] TODO: update docs\n`api/v2/users`\n@Carol\n",
                    "from": "GreenCastle",
                    "to": [
                      "BlueLake"
                    ],
                    "cc": [],
                    "bcc": []
                  }
                }
              ],
              "count": 1
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/created_ts",
              "/deliveries/0/payload/created_ts"
            ]
          }
        },
        {
          "name": "llm_thread_t2_reply",
          "input": {
            "project_key": "abs-path-backend",
            "message_id": 4,
            "sender_name": "GreenCastle",
            "body_md": "- BLOCKED: waiting on infra\n"
          },
          "expect": {
            "ok": {
              "id": 7,
              "project_id": 1,
              "sender_id": 2,
              "thread_id": "T-2",
              "subject": "Re: LLM Thread T-2",
              "importance": "normal",
              "ack_required": false,
              "created_ts": null,
              "attachments": [],
              "body_md": "- BLOCKED: waiting on infra\n",
              "from": "GreenCastle",
              "to": [
                "BlueLake"
              ],
              "cc": [],
              "bcc": [],
              "reply_to": 4,
              "deliveries": [
                {
                  "project": "/abs/path/backend",
                  "payload": {
                    "id": 7,
                    "project_id": 1,
                    "sender_id": 2,
                    "thread_id": "T-2",
                    "subject": "Re: LLM Thread T-2",
                    "importance": "normal",
                    "ack_required": false,
                    "created_ts": null,
                    "attachments": [],
                    "body_md": "- BLOCKED: waiting on infra\n",
                    "from": "GreenCastle",
                    "to": [
                      "BlueLake"
                    ],
                    "cc": [],
                    "bcc": []
                  }
                }
              ],
              "count": 1
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/created_ts",
              "/deliveries/0/payload/created_ts"
            ]
          }
        }
      ]
    },
    "fetch_inbox": {
      "cases": [
        {
          "name": "gc_inbox_with_bodies",
          "input": {
            "project_key": "abs-path-backend",
            "agent_name": "GreenCastle",
            "include_bodies": true,
            "limit": 10
          },
          "expect": {
            "ok": [
              {
                "id": 4,
                "project_id": 1,
                "sender_id": 1,
                "thread_id": "T-2",
                "subject": "LLM Thread T-2",
                "importance": "normal",
                "ack_required": false,
                "created_ts": null,
                "attachments": [],
                "body_md": "- NEXT: migrate DB\n- ACTION: run script\n",
                "from": "BlueLake",
                "kind": "to"
              },
              {
                "id": 3,
                "project_id": 1,
                "sender_id": 1,
                "thread_id": "T-1",
                "subject": "LLM Thread T-1",
                "importance": "normal",
                "ack_required": false,
                "created_ts": null,
                "attachments": [],
                "body_md": "- TODO: deploy to staging\n- discussed API changes\n",
                "from": "BlueLake",
                "kind": "to"
              },
              {
                "id": 2,
                "project_id": 1,
                "sender_id": 1,
                "thread_id": null,
                "subject": "Hello",
                "importance": "urgent",
                "ack_required": true,
                "created_ts": null,
                "attachments": [],
                "body_md": "Test",
                "from": "BlueLake",
                "kind": "to"
              },
              {
                "id": 1,
                "project_id": 1,
                "sender_id": 1,
                "thread_id": null,
                "subject": "Contact request from BlueLake",
                "importance": "normal",
                "ack_required": true,
                "created_ts": null,
                "attachments": [],
                "body_md": "BlueLake requests permission to contact GreenCastle.",
                "from": "BlueLake",
                "kind": "to"
              }
            ]
          },
          "normalize": {
            "ignore_json_pointers": [
              "/0/created_ts",
              "/1/created_ts",
              "/2/created_ts",
              "/3/created_ts"
            ]
          }
        }
      ]
    },
    "mark_message_read": {
      "cases": [
        {
          "name": "mark_contact_request_read",
          "input": {
            "project_key": "abs-path-backend",
            "agent_name": "GreenCastle",
            "message_id": 1
          },
          "expect": {
            "ok": {
              "message_id": 1,
              "read": true,
              "read_at": null
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/read_at"
            ]
          }
        }
      ]
    },
    "acknowledge_message": {
      "cases": [
        {
          "name": "ack_contact_request",
          "input": {
            "project_key": "abs-path-backend",
            "agent_name": "GreenCastle",
            "message_id": 1
          },
          "expect": {
            "ok": {
              "message_id": 1,
              "acknowledged": true,
              "acknowledged_at": null,
              "read_at": null
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/acknowledged_at",
              "/read_at"
            ]
          }
        }
      ]
    },
    "search_messages": {
      "cases": [
        {
          "name": "search_hello",
          "input": {
            "project_key": "abs-path-backend",
            "query": "Hello",
            "limit": 10
          },
          "expect": {
            "ok": {
              "result": [
                {
                  "id": 2,
                  "subject": "Hello",
                  "importance": "urgent",
                  "ack_required": 1,
                  "created_ts": null,
                  "thread_id": null,
                  "from": "BlueLake"
                },
                {
                  "id": 5,
                  "subject": "Re: Hello",
                  "importance": "urgent",
                  "ack_required": 1,
                  "created_ts": null,
                  "thread_id": "2",
                  "from": "GreenCastle"
                }
              ]
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/result/0/created_ts",
              "/result/1/created_ts"
            ]
          }
        },
        {
          "name": "empty_query_returns_empty",
          "input": {
            "project_key": "abs-path-backend",
            "query": "",
            "limit": 10
          },
          "expect": {
            "ok": {
              "result": []
            }
          }
        },
        {
          "name": "project_not_found_error",
          "input": {
            "project_key": "ZzzNonExistentProject",
            "query": "Hello",
            "limit": 10
          },
          "expect": {
            "err": {
              "message_contains": "not found"
            }
          }
        }
      ]
    },
    "summarize_thread": {
      "cases": [
        {
          "name": "summarize_thread_root",
          "input": {
            "project_key": "abs-path-backend",
            "thread_id": "2",
            "include_examples": true,
            "llm_mode": false
          },
          "expect": {
            "ok": {
              "thread_id": "2",
              "summary": {
                "participants": [
                  "BlueLake",
                  "GreenCastle"
                ],
                "key_points": [],
                "action_items": [],
                "total_messages": 2,
                "open_actions": 0,
                "done_actions": 0,
                "mentions": []
              },
              "examples": [
                {
                  "id": 2,
                  "subject": "Hello",
                  "from": "BlueLake",
                  "created_ts": null
                },
                {
                  "id": 5,
                  "subject": "Re: Hello",
                  "from": "GreenCastle",
                  "created_ts": null
                }
              ]
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/examples/0/created_ts",
              "/examples/1/created_ts"
            ]
          }
        },
        {
          "name": "empty_thread_id_returns_empty_digest",
          "input": {
            "project_key": "abs-path-backend",
            "thread_id": "",
            "include_examples": true,
            "llm_mode": false
          },
          "expect": {
            "ok": {
              "threads": [],
              "aggregate": {
                "top_mentions": [],
                "action_items": [],
                "key_points": []
              }
            }
          }
        },
        {
          "name": "project_not_found_error",
          "input": {
            "project_key": "ZzzNonExistentProject",
            "thread_id": "2",
            "include_examples": true,
            "llm_mode": false
          },
          "expect": {
            "err": {
              "message_contains": "not found"
            }
          }
        },
        {
          "name": "summarize_thread_t1_llm",
          "input": {
            "project_key": "abs-path-backend",
            "thread_id": "T-1",
            "include_examples": true,
            "llm_mode": true
          },
          "expect": {
            "ok": {
              "thread_id": "T-1",
              "summary": {
                "participants": [
                  "BlueLake",
                  "GreenCastle"
                ],
                "key_points": [
                  "API migration planned for next sprint",
                  "Staging deployment needed before review",
                  "TODO: deploy to staging",
                  "TODO: update docs"
                ],
                "action_items": [
                  "Deploy to staging",
                  "Update API docs"
                ],
                "total_messages": 2,
                "open_actions": 1,
                "done_actions": 0,
                "mentions": [
                  {
                    "name": "Carol",
                    "count": 2
                  }
                ],
                "code_references": [
                  "api/v2/users"
                ]
              },
              "examples": [
                {
                  "id": 3,
                  "subject": "LLM Thread T-1",
                  "from": "BlueLake",
                  "created_ts": null
                },
                {
                  "id": 6,
                  "subject": "Re: LLM Thread T-1",
                  "from": "GreenCastle",
                  "created_ts": null
                }
              ]
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/examples/0/created_ts",
              "/examples/1/created_ts"
            ]
          }
        },
        {
          "name": "summarize_thread_multi_llm",
          "input": {
            "project_key": "abs-path-backend",
            "thread_id": "T-1,T-2",
            "llm_mode": true
          },
          "expect": {
            "ok": {
              "threads": [
                {
                  "thread_id": "T-1",
                  "summary": {
                    "participants": [
                      "BlueLake",
                      "GreenCastle"
                    ],
                    "key_points": [
                      "API v2 schema finalized"
                    ],
                    "action_items": [
                      "Update OpenAPI spec"
                    ],
                    "total_messages": 2,
                    "open_actions": 1,
                    "done_actions": 0,
                    "mentions": [
                      {
                        "name": "Carol",
                        "count": 1
                      }
                    ],
                    "code_references": [
                      "api/v2/users"
                    ]
                  }
                },
                {
                  "thread_id": "T-2",
                  "summary": {
                    "participants": [
                      "BlueLake",
                      "GreenCastle"
                    ],
                    "key_points": [
                      "Migration to new DB"
                    ],
                    "action_items": [
                      "Run migration script"
                    ],
                    "total_messages": 2,
                    "open_actions": 0,
                    "done_actions": 0,
                    "mentions": []
                  }
                }
              ],
              "aggregate": {
                "top_mentions": [
                  "Alice",
                  "Bob"
                ],
                "action_items": [
                  "Update OpenAPI spec",
                  "Run migration script"
                ],
                "key_points": [
                  "API schema and DB migration are the two main workstreams"
                ]
              }
            }
          }
        }
      ]
    },
    "search_messages_product": {
      "cases": [
        {
          "name": "product_search_hello",
          "input": {
            "product_key": "0123456789abcdef0123",
            "query": "Hello",
            "limit": 10
          },
          "expect": {
            "ok": {
              "result": [
                {
                  "id": 2,
                  "subject": "Hello",
                  "importance": "urgent",
                  "ack_required": 1,
                  "created_ts": null,
                  "thread_id": null,
                  "from": "BlueLake",
                  "project_id": 1
                },
                {
                  "id": 5,
                  "subject": "Re: Hello",
                  "importance": "urgent",
                  "ack_required": 1,
                  "created_ts": null,
                  "thread_id": "2",
                  "from": "GreenCastle",
                  "project_id": 1
                }
              ]
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/result/0/created_ts",
              "/result/1/created_ts"
            ]
          }
        }
      ]
    },
    "fetch_inbox_product": {
      "cases": [
        {
          "name": "product_inbox_green_castle_with_bodies",
          "input": {
            "product_key": "0123456789abcdef0123",
            "agent_name": "GreenCastle",
            "include_bodies": true,
            "limit": 10
          },
          "expect": {
            "ok": [
              {
                "id": 4,
                "project_id": 1,
                "sender_id": 1,
                "thread_id": "T-2",
                "subject": "LLM Thread T-2",
                "importance": "normal",
                "ack_required": false,
                "created_ts": null,
                "attachments": [],
                "body_md": "- NEXT: migrate DB\n- ACTION: run script\n",
                "from": "BlueLake",
                "kind": "to"
              },
              {
                "id": 3,
                "project_id": 1,
                "sender_id": 1,
                "thread_id": "T-1",
                "subject": "LLM Thread T-1",
                "importance": "normal",
                "ack_required": false,
                "created_ts": null,
                "attachments": [],
                "body_md": "- TODO: deploy to staging\n- discussed API changes\n",
                "from": "BlueLake",
                "kind": "to"
              },
              {
                "id": 2,
                "project_id": 1,
                "sender_id": 1,
                "thread_id": null,
                "subject": "Hello",
                "importance": "urgent",
                "ack_required": true,
                "created_ts": null,
                "attachments": [],
                "body_md": "Test",
                "from": "BlueLake",
                "kind": "to"
              },
              {
                "id": 1,
                "project_id": 1,
                "sender_id": 1,
                "thread_id": null,
                "subject": "Contact request from BlueLake",
                "importance": "normal",
                "ack_required": true,
                "created_ts": null,
                "attachments": [],
                "body_md": "BlueLake requests permission to contact GreenCastle.",
                "from": "BlueLake",
                "kind": "to"
              }
            ]
          },
          "normalize": {
            "ignore_json_pointers": [
              "/0/created_ts",
              "/1/created_ts",
              "/2/created_ts",
              "/3/created_ts"
            ]
          }
        }
      ]
    },
    "summarize_thread_product": {
      "cases": [
        {
          "name": "product_summarize_thread_root",
          "input": {
            "product_key": "0123456789abcdef0123",
            "thread_id": "2",
            "include_examples": true,
            "llm_mode": false
          },
          "expect": {
            "ok": {
              "thread_id": "2",
              "summary": {
                "participants": [
                  "BlueLake",
                  "GreenCastle"
                ],
                "key_points": [],
                "action_items": [],
                "total_messages": 2,
                "open_actions": 0,
                "done_actions": 0,
                "mentions": []
              },
              "examples": [
                {
                  "id": 2,
                  "subject": "Hello",
                  "from": "BlueLake",
                  "created_ts": null
                },
                {
                  "id": 5,
                  "subject": "Re: Hello",
                  "from": "GreenCastle",
                  "created_ts": null
                }
              ]
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/examples/0/created_ts",
              "/examples/1/created_ts"
            ]
          }
        },
        {
          "name": "product_summarize_thread_t1_llm",
          "input": {
            "product_key": "0123456789abcdef0123",
            "thread_id": "T-1",
            "include_examples": true,
            "llm_mode": true
          },
          "expect": {
            "ok": {
              "thread_id": "T-1",
              "summary": {
                "participants": [
                  "BlueLake",
                  "GreenCastle"
                ],
                "key_points": [
                  "API migration planned for next sprint",
                  "Staging deployment needed before review",
                  "TODO: deploy to staging",
                  "TODO: update docs"
                ],
                "action_items": [
                  "Deploy to staging",
                  "Update API docs"
                ],
                "total_messages": 2,
                "open_actions": 1,
                "done_actions": 0,
                "mentions": [
                  {
                    "name": "Carol",
                    "count": 2
                  }
                ],
                "code_references": [
                  "api/v2/users"
                ]
              },
              "examples": [
                {
                  "id": 3,
                  "subject": "LLM Thread T-1",
                  "from": "BlueLake",
                  "created_ts": null
                },
                {
                  "id": 6,
                  "subject": "Re: LLM Thread T-1",
                  "from": "GreenCastle",
                  "created_ts": null
                }
              ]
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/examples/0/created_ts",
              "/examples/1/created_ts"
            ]
          }
        }
      ]
    },
    "file_reservation_paths": {
      "cases": [
        {
          "name": "empty_paths_error",
          "input": {
            "project_key": "abs-path-backend",
            "agent_name": "BlueLake",
            "paths": []
          },
          "expect": {
            "err": {
              "message_contains": "paths list cannot be empty"
            }
          }
        },
        {
          "name": "reserve_src_glob",
          "input": {
            "project_key": "abs-path-backend",
            "agent_name": "BlueLake",
            "paths": [
              "src/**"
            ],
            "ttl_seconds": 3600,
            "exclusive": true,
            "reason": "br-123"
          },
          "expect": {
            "ok": {
              "granted": [
                {
                  "id": 1,
                  "path_pattern": "src/**",
                  "exclusive": true,
                  "reason": "br-123",
                  "expires_ts": null
                }
              ],
              "conflicts": []
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/granted/0/expires_ts"
            ]
          }
        }
      ]
    },
    "renew_file_reservations": {
      "cases": [
        {
          "name": "renew_by_agent_all",
          "input": {
            "project_key": "abs-path-backend",
            "agent_name": "BlueLake",
            "extend_seconds": 600
          },
          "expect": {
            "ok": {
              "renewed": 1,
              "file_reservations": [
                {
                  "id": 1,
                  "path_pattern": "src/**",
                  "old_expires_ts": null,
                  "new_expires_ts": null
                }
              ]
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/file_reservations/0/new_expires_ts",
              "/file_reservations/0/old_expires_ts"
            ]
          }
        },
        {
          "name": "extend_seconds_clamped_to_60",
          "input": {
            "project_key": "abs-path-backend",
            "agent_name": "BlueLake",
            "extend_seconds": 5
          },
          "expect": {
            "ok": {
              "renewed": 1,
              "file_reservations": [
                {
                  "id": 1,
                  "path_pattern": "src/**",
                  "old_expires_ts": null,
                  "new_expires_ts": null
                }
              ]
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/file_reservations/0/new_expires_ts",
              "/file_reservations/0/old_expires_ts"
            ]
          }
        },
        {
          "name": "agent_not_found_error",
          "input": {
            "project_key": "abs-path-backend",
            "agent_name": "ZzzNonExistentAgent",
            "extend_seconds": 600
          },
          "expect": {
            "err": {
              "message_contains": "not found"
            }
          }
        }
      ]
    },
    "release_file_reservations": {
      "cases": [
        {
          "name": "release_by_agent_all",
          "input": {
            "project_key": "abs-path-backend",
            "agent_name": "BlueLake"
          },
          "expect": {
            "ok": {
              "released": 1,
              "released_at": null
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/released_at"
            ]
          }
        }
      ]
    },
    "force_release_file_reservation": {
      "cases": [
        {
          "name": "force_release_missing",
          "input": {
            "project_key": "abs-path-backend",
            "agent_name": "BlueLake",
            "file_reservation_id": 9999
          },
          "expect": {
            "err": {
              "message_contains": "not found"
            }
          }
        }
      ]
    },
    "install_precommit_guard": {
      "cases": [
        {
          "name": "install_precommit_guard_default",
          "input": {
            "project_key": "abs-path-backend",
            "code_repo_path": "/tmp/agent-mail-fixtures/repo_install"
          },
          "expect": {
            "ok": {
              "hook": null
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/hook"
            ]
          }
        }
      ]
    },
    "uninstall_precommit_guard": {
      "cases": [
        {
          "name": "uninstall_precommit_guard_default",
          "input": {
            "code_repo_path": "/tmp/agent-mail-fixtures/repo_uninstall"
          },
          "expect": {
            "ok": {
              "removed": false
            }
          }
        }
      ]
    },
    "whois": {
      "cases": [
        {
          "name": "whois_bluelake",
          "input": {
            "project_key": "abs-path-backend",
            "agent_name": "BlueLake",
            "include_recent_commits": false
          },
          "expect": {
            "ok": {
              "id": 1,
              "name": "BlueLake",
              "program": "codex-cli",
              "model": "gpt-5",
              "task_description": "sender",
              "inception_ts": null,
              "last_active_ts": null,
              "project_id": 1,
              "attachments_policy": "auto",
              "recent_commits": []
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/inception_ts",
              "/last_active_ts"
            ]
          }
        },
        {
          "name": "whois_nonexistent_error",
          "input": {
            "project_key": "abs-path-backend",
            "agent_name": "ZzzNonExistentAgent"
          },
          "expect": {
            "err": {
              "message_contains": "not found"
            }
          }
        }
      ]
    },
    "macro_start_session": {
      "cases": [
        {
          "name": "macro_start_session_basic",
          "input": {
            "human_key": "/abs/path/macro-session",
            "program": "codex-cli",
            "model": "gpt-5",
            "agent_name": "PurpleBear",
            "inbox_limit": 5
          },
          "expect": {
            "ok": {
              "project": {
                "id": 2,
                "slug": "abs-path-macro-session",
                "human_key": "/abs/path/macro-session",
                "created_at": null
              },
              "agent": {
                "id": 4,
                "name": "PurpleBear",
                "program": "codex-cli",
                "model": "gpt-5",
                "task_description": "",
                "inception_ts": null,
                "last_active_ts": null,
                "project_id": 2,
                "attachments_policy": "auto"
              },
              "file_reservations": {
                "granted": [],
                "conflicts": []
              },
              "inbox": []
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/agent/inception_ts",
              "/agent/last_active_ts",
              "/project/created_at"
            ]
          }
        }
      ]
    },
    "macro_prepare_thread": {
      "cases": [
        {
          "name": "macro_prepare_thread_no_llm",
          "input": {
            "project_key": "abs-path-backend",
            "thread_id": "2",
            "program": "codex-cli",
            "model": "gpt-5",
            "agent_name": "BlueLake",
            "include_examples": true,
            "llm_mode": false
          },
          "expect": {
            "ok": {
              "project": {
                "id": 1,
                "slug": "abs-path-backend",
                "human_key": "/abs/path/backend",
                "created_at": null
              },
              "agent": {
                "id": 1,
                "name": "BlueLake",
                "program": "codex-cli",
                "model": "gpt-5",
                "task_description": "",
                "inception_ts": null,
                "last_active_ts": null,
                "project_id": 1,
                "attachments_policy": "auto"
              },
              "thread": {
                "thread_id": "2",
                "summary": {
                  "participants": [
                    "BlueLake",
                    "GreenCastle"
                  ],
                  "key_points": [],
                  "action_items": [],
                  "total_messages": 2,
                  "open_actions": 0,
                  "done_actions": 0,
                  "mentions": []
                },
                "examples": [
                  {
                    "id": 2,
                    "subject": "Hello",
                    "from": "BlueLake",
                    "created_ts": null
                  },
                  {
                    "id": 5,
                    "subject": "Re: Hello",
                    "from": "GreenCastle",
                    "created_ts": null
                  }
                ],
                "total_messages": 2
              },
              "inbox": [
                {
                  "id": 7,
                  "project_id": 1,
                  "sender_id": 2,
                  "thread_id": "T-2",
                  "subject": "Re: LLM Thread T-2",
                  "importance": "normal",
                  "ack_required": false,
                  "created_ts": null,
                  "attachments": [],
                  "from": "GreenCastle",
                  "kind": "to"
                },
                {
                  "id": 6,
                  "project_id": 1,
                  "sender_id": 2,
                  "thread_id": "T-1",
                  "subject": "Re: LLM Thread T-1",
                  "importance": "normal",
                  "ack_required": false,
                  "created_ts": null,
                  "attachments": [],
                  "from": "GreenCastle",
                  "kind": "to"
                },
                {
                  "id": 5,
                  "project_id": 1,
                  "sender_id": 2,
                  "thread_id": "2",
                  "subject": "Re: Hello",
                  "importance": "urgent",
                  "ack_required": true,
                  "created_ts": null,
                  "attachments": [],
                  "from": "GreenCastle",
                  "kind": "to"
                }
              ]
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/agent/inception_ts",
              "/agent/last_active_ts",
              "/inbox/0/created_ts",
              "/inbox/1/created_ts",
              "/inbox/2/created_ts",
              "/project/created_at",
              "/thread/examples/0/created_ts",
              "/thread/examples/1/created_ts"
            ]
          }
        },
        {
          "name": "macro_prepare_thread_llm",
          "input": {
            "project_key": "abs-path-backend",
            "thread_id": "T-1",
            "program": "codex-cli",
            "model": "gpt-5",
            "agent_name": "BlueLake",
            "include_examples": true,
            "llm_mode": true
          },
          "expect": {
            "ok": {
              "project": {
                "id": 1,
                "slug": "abs-path-backend",
                "human_key": "/abs/path/backend",
                "created_at": null
              },
              "agent": {
                "id": 1,
                "name": "BlueLake",
                "program": "codex-cli",
                "model": "gpt-5",
                "task_description": "",
                "inception_ts": null,
                "last_active_ts": null,
                "project_id": 1,
                "attachments_policy": "auto"
              },
              "thread": {
                "thread_id": "T-1",
                "summary": {
                  "participants": [
                    "BlueLake",
                    "GreenCastle"
                  ],
                  "key_points": [
                    "API migration planned for next sprint",
                    "Staging deployment needed before review",
                    "TODO: deploy to staging",
                    "TODO: update docs"
                  ],
                  "action_items": [
                    "Deploy to staging",
                    "Update API docs"
                  ],
                  "total_messages": 2,
                  "open_actions": 1,
                  "done_actions": 0,
                  "mentions": [
                    {
                      "name": "Carol",
                      "count": 2
                    }
                  ],
                  "code_references": [
                    "api/v2/users"
                  ]
                },
                "examples": [
                  {
                    "id": 3,
                    "subject": "LLM Thread T-1",
                    "from": "BlueLake",
                    "created_ts": null
                  },
                  {
                    "id": 6,
                    "subject": "Re: LLM Thread T-1",
                    "from": "GreenCastle",
                    "created_ts": null
                  }
                ],
                "total_messages": 2
              },
              "inbox": [
                {
                  "id": 7,
                  "project_id": 1,
                  "sender_id": 2,
                  "thread_id": "T-2",
                  "subject": "Re: LLM Thread T-2",
                  "importance": "normal",
                  "ack_required": false,
                  "created_ts": null,
                  "attachments": [],
                  "from": "GreenCastle",
                  "kind": "to"
                },
                {
                  "id": 6,
                  "project_id": 1,
                  "sender_id": 2,
                  "thread_id": "T-1",
                  "subject": "Re: LLM Thread T-1",
                  "importance": "normal",
                  "ack_required": false,
                  "created_ts": null,
                  "attachments": [],
                  "from": "GreenCastle",
                  "kind": "to"
                },
                {
                  "id": 5,
                  "project_id": 1,
                  "sender_id": 2,
                  "thread_id": "2",
                  "subject": "Re: Hello",
                  "importance": "urgent",
                  "ack_required": true,
                  "created_ts": null,
                  "attachments": [],
                  "from": "GreenCastle",
                  "kind": "to"
                }
              ]
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/agent/inception_ts",
              "/agent/last_active_ts",
              "/inbox/0/created_ts",
              "/inbox/1/created_ts",
              "/inbox/2/created_ts",
              "/project/created_at",
              "/thread/examples/0/created_ts",
              "/thread/examples/1/created_ts"
            ]
          }
        }
      ]
    },
    "macro_file_reservation_cycle": {
      "cases": [
        {
          "name": "macro_reserve_and_release",
          "input": {
            "project_key": "abs-path-backend",
            "agent_name": "BlueLake",
            "paths": [
              "src/**"
            ],
            "ttl_seconds": 3600,
            "exclusive": true,
            "reason": "br-123",
            "auto_release": true
          },
          "expect": {
            "ok": {
              "file_reservations": {
                "granted": [
                  {
                    "id": 2,
                    "path_pattern": "src/**",
                    "exclusive": true,
                    "reason": "br-123",
                    "expires_ts": null
                  }
                ],
                "conflicts": []
              },
              "released": {
                "released": 1,
                "released_at": null
              }
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/file_reservations/granted/0/expires_ts",
              "/released/released_at"
            ]
          }
        }
      ]
    },
    "macro_contact_handshake": {
      "cases": [
        {
          "name": "macro_handshake_auto_accept",
          "input": {
            "project_key": "abs-path-backend",
            "requester": "BlueLake",
            "target": "GreenCastle",
            "auto_accept": true,
            "ttl_seconds": 86400
          },
          "expect": {
            "ok": {
              "request": {
                "from": "BlueLake",
                "from_project": "/abs/path/backend",
                "to": "GreenCastle",
                "to_project": "/abs/path/backend",
                "status": "approved",
                "expires_ts": null
              },
              "response": {
                "from": "BlueLake",
                "from_project": "/abs/path/backend",
                "to": "GreenCastle",
                "to_project": "/abs/path/backend",
                "status": "approved",
                "expires_ts": null
              },
              "welcome_message": null
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/request/expires_ts",
              "/response/expires_ts"
            ]
          }
        }
      ]
    }
  },
  "resources": {
    "resource://config/environment": {
      "cases": [
        {
          "name": "default",
          "input": {},
          "expect": {
            "ok": {
              "environment": "development",
              "database_url": null,
              "http": {
                "host": "127.0.0.1",
                "port": 8765,
                "path": "/api/"
              }
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/database_url"
            ]
          }
        }
      ]
    },
    "resource://config/environment?format=json": {
      "cases": [
        {
          "name": "default_format_json",
          "input": {},
          "expect": {
            "ok": {
              "environment": "development",
              "database_url": null,
              "http": {
                "host": "127.0.0.1",
                "port": 8765,
                "path": "/api/"
              }
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/database_url"
            ]
          }
        }
      ]
    },
    "resource://projects": {
      "cases": [
        {
          "name": "all_projects",
          "input": {},
          "expect": {
            "ok": [
              {
                "id": 1,
                "slug": "abs-path-backend",
                "human_key": "/abs/path/backend",
                "created_at": null
              },
              {
                "id": 2,
                "slug": "abs-path-macro-session",
                "human_key": "/abs/path/macro-session",
                "created_at": null
              }
            ]
          },
          "normalize": {
            "ignore_json_pointers": [
              "/0/created_at",
              "/1/created_at"
            ]
          }
        }
      ]
    },
    "resource://projects?format=json": {
      "cases": [
        {
          "name": "all_projects_format_json",
          "input": {},
          "expect": {
            "ok": [
              {
                "id": 1,
                "slug": "abs-path-backend",
                "human_key": "/abs/path/backend",
                "created_at": null
              },
              {
                "id": 2,
                "slug": "abs-path-macro-session",
                "human_key": "/abs/path/macro-session",
                "created_at": null
              }
            ]
          },
          "normalize": {
            "ignore_json_pointers": [
              "/0/created_at",
              "/1/created_at"
            ]
          }
        }
      ]
    },
    "resource://project/abs-path-backend": {
      "cases": [
        {
          "name": "project_detail",
          "input": {},
          "expect": {
            "ok": {
              "id": 1,
              "slug": "abs-path-backend",
              "human_key": "/abs/path/backend",
              "created_at": null,
              "agents": [
                {
                  "id": 1,
                  "name": "BlueLake",
                  "program": "codex-cli",
                  "model": "gpt-5",
                  "task_description": "",
                  "inception_ts": null,
                  "last_active_ts": null,
                  "project_id": 1,
                  "attachments_policy": "auto"
                },
                {
                  "id": 2,
                  "name": "GreenCastle",
                  "program": "codex-cli",
                  "model": "gpt-5",
                  "task_description": "recipient",
                  "inception_ts": null,
                  "last_active_ts": null,
                  "project_id": 1,
                  "attachments_policy": "auto"
                },
                {
                  "id": 3,
                  "name": "OrangeFox",
                  "program": "codex-cli",
                  "model": "gpt-5",
                  "task_description": "fresh identity",
                  "inception_ts": null,
                  "last_active_ts": null,
                  "project_id": 1,
                  "attachments_policy": "auto"
                }
              ]
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/agents/0/inception_ts",
              "/agents/0/last_active_ts",
              "/agents/1/inception_ts",
              "/agents/1/last_active_ts",
              "/agents/2/inception_ts",
              "/agents/2/last_active_ts",
              "/created_at"
            ]
          }
        }
      ]
    },
    "resource://identity/abs-path-backend": {
      "cases": [
        {
          "name": "identity_project",
          "input": {},
          "expect": {
            "ok": {
              "slug": "data-projects-mcp-agent-mail-rust-abs-path-backend",
              "identity_mode_used": "dir",
              "canonical_path": null,
              "human_key": "/data/projects/mcp_agent_mail_rust/abs-path-backend",
              "repo_root": null,
              "git_common_dir": null,
              "branch": null,
              "worktree_name": null,
              "core_ignorecase": null,
              "normalized_remote": null,
              "project_uid": "82562053b4cd5b32e5a4",
              "discovery": null
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/canonical_path",
              "/git_common_dir"
            ]
          }
        }
      ]
    },
    "resource://agents/abs-path-backend": {
      "cases": [
        {
          "name": "agents_list",
          "input": {},
          "expect": {
            "ok": {
              "project": {
                "slug": "abs-path-backend",
                "human_key": "/abs/path/backend"
              },
              "agents": [
                {
                  "id": 1,
                  "name": "BlueLake",
                  "program": "codex-cli",
                  "model": "gpt-5",
                  "task_description": "",
                  "inception_ts": null,
                  "last_active_ts": null,
                  "project_id": 1,
                  "attachments_policy": "auto",
                  "unread_count": 3
                },
                {
                  "id": 2,
                  "name": "GreenCastle",
                  "program": "codex-cli",
                  "model": "gpt-5",
                  "task_description": "recipient",
                  "inception_ts": null,
                  "last_active_ts": null,
                  "project_id": 1,
                  "attachments_policy": "auto",
                  "unread_count": 3
                },
                {
                  "id": 3,
                  "name": "OrangeFox",
                  "program": "codex-cli",
                  "model": "gpt-5",
                  "task_description": "fresh identity",
                  "inception_ts": null,
                  "last_active_ts": null,
                  "project_id": 1,
                  "attachments_policy": "auto",
                  "unread_count": 0
                }
              ]
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/agents/0/inception_ts",
              "/agents/0/last_active_ts",
              "/agents/1/inception_ts",
              "/agents/1/last_active_ts",
              "/agents/2/inception_ts",
              "/agents/2/last_active_ts"
            ]
          }
        }
      ]
    },
    "resource://product/0123456789abcdef0123": {
      "cases": [
        {
          "name": "product_detail",
          "input": {},
          "expect": {
            "ok": {
              "id": 1,
              "product_uid": "0123456789abcdef0123",
              "name": "WidgetBus",
              "created_at": null,
              "projects": [
                {
                  "id": 1,
                  "slug": "abs-path-backend",
                  "human_key": "/abs/path/backend",
                  "created_at": null
                }
              ]
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/created_at",
              "/projects/0/created_at"
            ]
          }
        }
      ]
    },
    "resource://inbox/GreenCastle?project=abs-path-backend&include_bodies=true&limit=10": {
      "cases": [
        {
          "name": "inbox_resource",
          "input": {},
          "expect": {
            "ok": {
              "project": "/abs/path/backend",
              "agent": "GreenCastle",
              "count": 4,
              "messages": [
                {
                  "id": 4,
                  "project_id": 1,
                  "sender_id": 1,
                  "thread_id": "T-2",
                  "subject": "LLM Thread T-2",
                  "importance": "normal",
                  "ack_required": false,
                  "created_ts": null,
                  "attachments": [],
                  "body_md": "- NEXT: migrate DB\n- ACTION: run script\n",
                  "from": "BlueLake",
                  "kind": "to",
                  "commit": {
                    "hexsha": null,
                    "summary": "mail: BlueLake -> GreenCastle | LLM Thread T-2",
                    "authored_ts": null,
                    "insertions": 22,
                    "deletions": 0,
                    "diff_summary": {
                      "hunks": 1,
                      "excerpt": null
                    }
                  }
                },
                {
                  "id": 3,
                  "project_id": 1,
                  "sender_id": 1,
                  "thread_id": "T-1",
                  "subject": "LLM Thread T-1",
                  "importance": "normal",
                  "ack_required": false,
                  "created_ts": null,
                  "attachments": [],
                  "body_md": "- TODO: deploy to staging\n- discussed API changes\n",
                  "from": "BlueLake",
                  "kind": "to",
                  "commit": {
                    "hexsha": null,
                    "summary": "mail: BlueLake -> GreenCastle | LLM Thread T-1",
                    "authored_ts": null,
                    "insertions": 22,
                    "deletions": 0,
                    "diff_summary": {
                      "hunks": 1,
                      "excerpt": null
                    }
                  }
                },
                {
                  "id": 2,
                  "project_id": 1,
                  "sender_id": 1,
                  "thread_id": null,
                  "subject": "Hello",
                  "importance": "urgent",
                  "ack_required": true,
                  "created_ts": null,
                  "attachments": [],
                  "body_md": "Test",
                  "from": "BlueLake",
                  "kind": "to",
                  "commit": {
                    "hexsha": null,
                    "summary": "mail: BlueLake -> GreenCastle | Hello",
                    "authored_ts": null,
                    "insertions": 21,
                    "deletions": 0,
                    "diff_summary": {
                      "hunks": 1,
                      "excerpt": null
                    }
                  }
                },
                {
                  "id": 1,
                  "project_id": 1,
                  "sender_id": 1,
                  "thread_id": null,
                  "subject": "Contact request from BlueLake",
                  "importance": "normal",
                  "ack_required": true,
                  "created_ts": null,
                  "attachments": [],
                  "body_md": "BlueLake requests permission to contact GreenCastle.",
                  "from": "BlueLake",
                  "kind": "to",
                  "commit": {
                    "hexsha": null,
                    "summary": "mail: BlueLake -> GreenCastle | Contact request from BlueLake",
                    "authored_ts": null,
                    "insertions": 21,
                    "deletions": 0,
                    "diff_summary": {
                      "hunks": 1,
                      "excerpt": null
                    }
                  }
                }
              ]
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/messages/0/commit/authored_ts",
              "/messages/0/commit/diff_summary/excerpt",
              "/messages/0/commit/hexsha",
              "/messages/0/created_ts",
              "/messages/1/commit/authored_ts",
              "/messages/1/commit/diff_summary/excerpt",
              "/messages/1/commit/hexsha",
              "/messages/1/created_ts",
              "/messages/2/commit/authored_ts",
              "/messages/2/commit/diff_summary/excerpt",
              "/messages/2/commit/hexsha",
              "/messages/2/created_ts",
              "/messages/3/commit/authored_ts",
              "/messages/3/commit/diff_summary/excerpt",
              "/messages/3/commit/hexsha",
              "/messages/3/created_ts"
            ]
          }
        }
      ]
    },
    "resource://message/2?project=abs-path-backend": {
      "cases": [
        {
          "name": "message_detail",
          "input": {},
          "expect": {
            "ok": {
              "id": 2,
              "project_id": 1,
              "sender_id": 1,
              "thread_id": null,
              "subject": "Hello",
              "importance": "urgent",
              "ack_required": true,
              "created_ts": null,
              "attachments": [],
              "body_md": "Test",
              "from": "BlueLake"
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/created_ts"
            ]
          }
        }
      ]
    },
    "resource://thread/2?project=abs-path-backend&include_bodies=true": {
      "cases": [
        {
          "name": "thread_detail",
          "input": {},
          "expect": {
            "ok": {
              "project": "/abs/path/backend",
              "thread_id": "2",
              "messages": [
                {
                  "id": 2,
                  "project_id": 1,
                  "sender_id": 1,
                  "thread_id": null,
                  "subject": "Hello",
                  "importance": "urgent",
                  "ack_required": true,
                  "created_ts": null,
                  "attachments": [],
                  "body_md": "Test",
                  "from": "BlueLake"
                },
                {
                  "id": 5,
                  "project_id": 1,
                  "sender_id": 2,
                  "thread_id": "2",
                  "subject": "Re: Hello",
                  "importance": "urgent",
                  "ack_required": true,
                  "created_ts": null,
                  "attachments": [],
                  "body_md": "Reply",
                  "from": "GreenCastle"
                }
              ]
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/messages/0/created_ts",
              "/messages/1/created_ts"
            ]
          }
        }
      ]
    },
    "resource://file_reservations/abs-path-backend?active_only=false": {
      "cases": [
        {
          "name": "file_reservations_all",
          "input": {},
          "expect": {
            "ok": [
              {
                "id": 1,
                "agent": "BlueLake",
                "path_pattern": "src/**",
                "exclusive": true,
                "reason": "br-123",
                "created_ts": null,
                "expires_ts": null,
                "released_ts": null,
                "stale": false,
                "stale_reasons": [
                  "agent_recently_active",
                  "mail_activity_recent",
                  "path_pattern_unmatched"
                ],
                "last_agent_activity_ts": null,
                "last_mail_activity_ts": null,
                "last_filesystem_activity_ts": null,
                "last_git_activity_ts": null
              },
              {
                "id": 2,
                "agent": "BlueLake",
                "path_pattern": "src/**",
                "exclusive": true,
                "reason": "br-123",
                "created_ts": null,
                "expires_ts": null,
                "released_ts": null,
                "stale": false,
                "stale_reasons": [
                  "agent_recently_active",
                  "mail_activity_recent",
                  "path_pattern_unmatched"
                ],
                "last_agent_activity_ts": null,
                "last_mail_activity_ts": null,
                "last_filesystem_activity_ts": null,
                "last_git_activity_ts": null
              }
            ]
          },
          "normalize": {
            "ignore_json_pointers": [
              "/0/created_ts",
              "/0/expires_ts",
              "/0/last_agent_activity_ts",
              "/0/last_filesystem_activity_ts",
              "/0/last_git_activity_ts",
              "/0/last_mail_activity_ts",
              "/0/released_ts",
              "/1/created_ts",
              "/1/expires_ts",
              "/1/last_agent_activity_ts",
              "/1/last_filesystem_activity_ts",
              "/1/last_git_activity_ts",
              "/1/last_mail_activity_ts",
              "/1/released_ts"
            ]
          }
        }
      ]
    },
    "resource://tooling/directory": {
      "cases": [
        {
          "name": "tooling_directory",
          "input": {},
          "expect": {
            "ok": {
              "generated_at": null,
              "metrics_uri": "resource://tooling/metrics",
              "output_formats": {
                "default": "json",
                "tool_param": "format",
                "resource_query": "format",
                "values": [
                  "json",
                  "toon"
                ],
                "toon_envelope": {
                  "format": "toon",
                  "data": "<TOON>",
                  "meta": {
                    "requested": "toon"
                  }
                }
              },
              "clusters": [
                {
                  "name": "Infrastructure & Workspace Setup",
                  "purpose": "Bootstrap coordination and guardrails before agents begin editing.",
                  "tools": [
                    {
                      "name": "health_check",
                      "summary": "Report environment and HTTP wiring so orchestrators confirm connectivity.",
                      "use_when": "Beginning a session or during incident response triage.",
                      "related": [
                        "ensure_project"
                      ],
                      "expected_frequency": "Once per agent session or when connectivity is in doubt.",
                      "required_capabilities": [
                        "infrastructure"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Pre-flight",
                          "sample": "health_check()"
                        }
                      ],
                      "capabilities": [
                        "infrastructure"
                      ],
                      "complexity": "low"
                    },
                    {
                      "name": "ensure_project",
                      "summary": "Ensure project slug, schema, and archive exist for a shared repo identifier.",
                      "use_when": "First call against a repo or when switching projects.",
                      "related": [
                        "register_agent",
                        "file_reservation_paths"
                      ],
                      "expected_frequency": "Whenever a new repo/path is encountered.",
                      "required_capabilities": [
                        "infrastructure",
                        "storage"
                      ],
                      "usage_examples": [
                        {
                          "hint": "First action",
                          "sample": "ensure_project(human_key='/abs/path/backend')"
                        }
                      ],
                      "capabilities": [
                        "infrastructure",
                        "storage"
                      ],
                      "complexity": "low"
                    },
                    {
                      "name": "install_precommit_guard",
                      "summary": "Install Git pre-commit hook that enforces advisory file_reservations locally.",
                      "use_when": "Onboarding a repository into coordinated mode.",
                      "related": [
                        "file_reservation_paths",
                        "uninstall_precommit_guard"
                      ],
                      "expected_frequency": "Infrequent\u2014per repository setup.",
                      "required_capabilities": [
                        "infrastructure",
                        "repository"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Onboard",
                          "sample": "install_precommit_guard(project_key='backend', code_repo_path='~/repo')"
                        }
                      ],
                      "capabilities": [
                        "infrastructure",
                        "repository"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "uninstall_precommit_guard",
                      "summary": "Remove the advisory pre-commit hook from a repo.",
                      "use_when": "Decommissioning or debugging the guard hook.",
                      "related": [
                        "install_precommit_guard"
                      ],
                      "expected_frequency": "Rare; only when disabling guard enforcement.",
                      "required_capabilities": [
                        "infrastructure",
                        "repository"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Cleanup",
                          "sample": "uninstall_precommit_guard(code_repo_path='~/repo')"
                        }
                      ],
                      "capabilities": [
                        "infrastructure",
                        "repository"
                      ],
                      "complexity": "medium"
                    }
                  ]
                },
                {
                  "name": "Identity & Directory",
                  "purpose": "Register agents, mint unique identities, and inspect directory metadata.",
                  "tools": [
                    {
                      "name": "register_agent",
                      "summary": "Upsert an agent profile and refresh last_active_ts for a known persona.",
                      "use_when": "Resuming an identity or updating program/model/task metadata.",
                      "related": [
                        "create_agent_identity",
                        "whois"
                      ],
                      "expected_frequency": "At the start of each automated work session.",
                      "required_capabilities": [
                        "identity"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Resume persona",
                          "sample": "register_agent(project_key='/abs/path/backend', program='codex', model='gpt5')"
                        }
                      ],
                      "capabilities": [
                        "identity"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "create_agent_identity",
                      "summary": "Always create a new unique agent name (optionally using a sanitized hint).",
                      "use_when": "Spawning a brand-new helper that should not overwrite existing profiles.",
                      "related": [
                        "register_agent"
                      ],
                      "expected_frequency": "When minting fresh, short-lived identities.",
                      "required_capabilities": [
                        "identity"
                      ],
                      "usage_examples": [
                        {
                          "hint": "New helper",
                          "sample": "create_agent_identity(project_key='backend', name_hint='GreenCastle', program='codex', model='gpt5')"
                        }
                      ],
                      "capabilities": [
                        "identity"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "whois",
                      "summary": "Return enriched profile info plus recent archive commits for an agent.",
                      "use_when": "Dashboarding, routing coordination messages, or auditing activity.",
                      "related": [
                        "register_agent"
                      ],
                      "expected_frequency": "Ad hoc when context about an agent is required.",
                      "required_capabilities": [
                        "audit",
                        "identity"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Directory lookup",
                          "sample": "whois(project_key='backend', agent_name='BlueLake')"
                        }
                      ],
                      "capabilities": [
                        "audit",
                        "identity"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "set_contact_policy",
                      "summary": "Set inbound contact policy (open, auto, contacts_only, block_all).",
                      "use_when": "Adjusting how permissive an agent is about unsolicited messages.",
                      "related": [
                        "request_contact",
                        "respond_contact"
                      ],
                      "expected_frequency": "Occasional configuration change.",
                      "required_capabilities": [
                        "configure",
                        "contact"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Restrict inbox",
                          "sample": "set_contact_policy(project_key='backend', agent_name='BlueLake', policy='contacts_only')"
                        }
                      ],
                      "capabilities": [
                        "configure",
                        "contact"
                      ],
                      "complexity": "medium"
                    }
                  ]
                },
                {
                  "name": "Messaging Lifecycle",
                  "purpose": "Send, receive, and acknowledge threaded Markdown mail.",
                  "tools": [
                    {
                      "name": "send_message",
                      "summary": "Deliver a new message with attachments, WebP conversion, and policy enforcement.",
                      "use_when": "Starting new threads or broadcasting plans across projects.",
                      "related": [
                        "reply_message",
                        "request_contact"
                      ],
                      "expected_frequency": "Frequent\u2014core write operation.",
                      "required_capabilities": [
                        "messaging",
                        "write"
                      ],
                      "usage_examples": [
                        {
                          "hint": "New plan",
                          "sample": "send_message(project_key='backend', sender_name='GreenCastle', to=['BlueLake'], subject='Plan', body_md='...')"
                        }
                      ],
                      "capabilities": [
                        "messaging",
                        "write"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "reply_message",
                      "summary": "Reply within an existing thread, inheriting flags and default recipients.",
                      "use_when": "Continuing discussions or acknowledging decisions.",
                      "related": [
                        "send_message"
                      ],
                      "expected_frequency": "Frequent when collaborating inside a thread.",
                      "required_capabilities": [
                        "messaging",
                        "write"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Thread reply",
                          "sample": "reply_message(project_key='backend', message_id=42, sender_name='BlueLake', body_md='Got it!')"
                        }
                      ],
                      "capabilities": [
                        "messaging",
                        "write"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "fetch_inbox",
                      "summary": "Poll recent messages for an agent with filters (urgent_only, since_ts).",
                      "use_when": "After each work unit to ingest coordination updates.",
                      "related": [
                        "mark_message_read",
                        "acknowledge_message"
                      ],
                      "expected_frequency": "Frequent polling in agent loops.",
                      "required_capabilities": [
                        "messaging",
                        "read"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Poll",
                          "sample": "fetch_inbox(project_key='backend', agent_name='BlueLake', since_ts='2025-10-24T00:00:00Z')"
                        }
                      ],
                      "capabilities": [
                        "messaging",
                        "read"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "mark_message_read",
                      "summary": "Record read_ts for FYI messages without sending acknowledgements.",
                      "use_when": "Clearing inbox notifications once reviewed.",
                      "related": [
                        "acknowledge_message"
                      ],
                      "expected_frequency": "Whenever FYI mail is processed.",
                      "required_capabilities": [
                        "messaging",
                        "read"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Read receipt",
                          "sample": "mark_message_read(project_key='backend', agent_name='BlueLake', message_id=42)"
                        }
                      ],
                      "capabilities": [
                        "messaging",
                        "read"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "acknowledge_message",
                      "summary": "Set read_ts and ack_ts so senders know action items landed.",
                      "use_when": "Responding to ack_required messages.",
                      "related": [
                        "mark_message_read"
                      ],
                      "expected_frequency": "Each time a message requests acknowledgement.",
                      "required_capabilities": [
                        "ack",
                        "messaging"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Ack",
                          "sample": "acknowledge_message(project_key='backend', agent_name='BlueLake', message_id=42)"
                        }
                      ],
                      "capabilities": [
                        "ack",
                        "messaging"
                      ],
                      "complexity": "medium"
                    }
                  ]
                },
                {
                  "name": "Contact Governance",
                  "purpose": "Manage messaging permissions when policies are not open by default.",
                  "tools": [
                    {
                      "name": "request_contact",
                      "summary": "Create or refresh a pending AgentLink and notify the target with ack_required intro.",
                      "use_when": "Requesting permission before messaging another agent.",
                      "related": [
                        "respond_contact",
                        "set_contact_policy"
                      ],
                      "expected_frequency": "Occasional\u2014when new communication lines are needed.",
                      "required_capabilities": [
                        "contact"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Ask permission",
                          "sample": "request_contact(project_key='backend', from_agent='OpsBot', to_agent='BlueLake')"
                        }
                      ],
                      "capabilities": [
                        "contact"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "respond_contact",
                      "summary": "Approve or block a pending contact request, optionally setting expiry.",
                      "use_when": "Granting or revoking messaging permissions.",
                      "related": [
                        "request_contact"
                      ],
                      "expected_frequency": "As often as requests arrive.",
                      "required_capabilities": [
                        "contact"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Approve",
                          "sample": "respond_contact(project_key='backend', to_agent='BlueLake', from_agent='OpsBot', accept=True)"
                        }
                      ],
                      "capabilities": [
                        "contact"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "list_contacts",
                      "summary": "List outbound contact links, statuses, and expirations for an agent.",
                      "use_when": "Auditing who an agent may message or rotating expiring approvals.",
                      "related": [
                        "request_contact",
                        "respond_contact"
                      ],
                      "expected_frequency": "Periodic audits or dashboards.",
                      "required_capabilities": [
                        "audit",
                        "contact"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Audit",
                          "sample": "list_contacts(project_key='backend', agent_name='BlueLake')"
                        }
                      ],
                      "capabilities": [
                        "audit",
                        "contact"
                      ],
                      "complexity": "medium"
                    }
                  ]
                },
                {
                  "name": "Search & Summaries",
                  "purpose": "Surface signal from large mailboxes and compress long threads.",
                  "tools": [
                    {
                      "name": "search_messages",
                      "summary": "Run FTS5 queries across subject/body text to locate relevant threads.",
                      "use_when": "Triage or gathering context before editing.",
                      "related": [
                        "fetch_inbox",
                        "summarize_thread"
                      ],
                      "expected_frequency": "Regular during investigation phases.",
                      "required_capabilities": [
                        "search"
                      ],
                      "usage_examples": [
                        {
                          "hint": "FTS",
                          "sample": "search_messages(project_key='backend', query='\"build plan\" AND users', limit=20)"
                        }
                      ],
                      "capabilities": [
                        "search"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "summarize_thread",
                      "summary": "Extract participants, key points, and action items for one or more threads.",
                      "use_when": "Briefing new agents on long discussions, closing loops, or producing digests.",
                      "related": [
                        "search_messages"
                      ],
                      "expected_frequency": "When threads exceed quick skim length or at cadence checkpoints.",
                      "required_capabilities": [
                        "search",
                        "summarization"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Single thread",
                          "sample": "summarize_thread(project_key='backend', thread_id='TKT-123', include_examples=True)"
                        },
                        {
                          "hint": "Multi-thread digest",
                          "sample": "summarize_thread(project_key='backend', thread_id='TKT-123,UX-42,BUG-99')"
                        }
                      ],
                      "capabilities": [
                        "search",
                        "summarization"
                      ],
                      "complexity": "medium"
                    }
                  ]
                },
                {
                  "name": "File Reservations & Workspace Guardrails",
                  "purpose": "Coordinate file/glob ownership to avoid overwriting concurrent work.",
                  "tools": [
                    {
                      "name": "file_reservation_paths",
                      "summary": "Issue advisory file_reservations with overlap detection and Git artifacts.",
                      "use_when": "Before touching high-traffic surfaces or long-lived refactors.",
                      "related": [
                        "release_file_reservations",
                        "renew_file_reservations"
                      ],
                      "expected_frequency": "Whenever starting work on contested surfaces.",
                      "required_capabilities": [
                        "file_reservations",
                        "repository"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Lock file",
                          "sample": "file_reservation_paths(project_key='backend', agent_name='BlueLake', paths=['src/app.py'], ttl_seconds=7200)"
                        }
                      ],
                      "capabilities": [
                        "file_reservations",
                        "repository"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "release_file_reservations",
                      "summary": "Release active file_reservations (fully or by subset) and stamp released_ts.",
                      "use_when": "Finishing work so surfaces become available again.",
                      "related": [
                        "file_reservation_paths",
                        "renew_file_reservations"
                      ],
                      "expected_frequency": "Each time work on a surface completes.",
                      "required_capabilities": [
                        "file_reservations"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Unlock",
                          "sample": "release_file_reservations(project_key='backend', agent_name='BlueLake', paths=['src/app.py'])"
                        }
                      ],
                      "capabilities": [
                        "file_reservations"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "renew_file_reservations",
                      "summary": "Extend file_reservation expiry windows without allocating new file_reservation IDs.",
                      "use_when": "Long-running work needs more time but should retain ownership.",
                      "related": [
                        "file_reservation_paths",
                        "release_file_reservations"
                      ],
                      "expected_frequency": "Periodically during multi-hour work items.",
                      "required_capabilities": [
                        "file_reservations"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Extend",
                          "sample": "renew_file_reservations(project_key='backend', agent_name='BlueLake', extend_seconds=1800)"
                        }
                      ],
                      "capabilities": [
                        "file_reservations"
                      ],
                      "complexity": "medium"
                    }
                  ]
                },
                {
                  "name": "Workflow Macros",
                  "purpose": "Opinionated orchestrations that compose multiple primitives for smaller agents.",
                  "tools": [
                    {
                      "name": "macro_start_session",
                      "summary": "Ensure project, register/update agent, optionally file_reservation surfaces, and return inbox context.",
                      "use_when": "Kickstarting a focused work session with one call.",
                      "related": [
                        "ensure_project",
                        "register_agent",
                        "file_reservation_paths",
                        "fetch_inbox"
                      ],
                      "expected_frequency": "At the beginning of each autonomous session.",
                      "required_capabilities": [
                        "file_reservations",
                        "identity",
                        "messaging",
                        "workflow"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Bootstrap",
                          "sample": "macro_start_session(human_key='/abs/path/backend', program='codex', model='gpt5', file_reservation_paths=['src/api/*.py'])"
                        }
                      ],
                      "capabilities": [
                        "file_reservations",
                        "identity",
                        "messaging",
                        "workflow"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "macro_prepare_thread",
                      "summary": "Register or refresh an agent, summarise a thread, and fetch inbox context in one call.",
                      "use_when": "Briefing a helper before joining an ongoing discussion.",
                      "related": [
                        "register_agent",
                        "summarize_thread",
                        "fetch_inbox"
                      ],
                      "expected_frequency": "Whenever onboarding a new contributor to an active thread.",
                      "required_capabilities": [
                        "messaging",
                        "summarization",
                        "workflow"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Join thread",
                          "sample": "macro_prepare_thread(project_key='backend', thread_id='TKT-123', program='codex', model='gpt5', agent_name='ThreadHelper')"
                        }
                      ],
                      "capabilities": [
                        "messaging",
                        "summarization",
                        "workflow"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "macro_file_reservation_cycle",
                      "summary": "FileReservation a set of paths and optionally release them once work is complete.",
                      "use_when": "Wrapping a focused edit cycle that needs advisory locks.",
                      "related": [
                        "file_reservation_paths",
                        "release_file_reservations",
                        "renew_file_reservations"
                      ],
                      "expected_frequency": "Per guarded work block.",
                      "required_capabilities": [
                        "file_reservations",
                        "repository",
                        "workflow"
                      ],
                      "usage_examples": [
                        {
                          "hint": "FileReservation & release",
                          "sample": "macro_file_reservation_cycle(project_key='backend', agent_name='BlueLake', paths=['src/app.py'], auto_release=true)"
                        }
                      ],
                      "capabilities": [
                        "file_reservations",
                        "repository",
                        "workflow"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "macro_contact_handshake",
                      "summary": "Request contact approval, optionally auto-accept, and send a welcome message.",
                      "use_when": "Spinning up collaboration between two agents who lack permissions.",
                      "related": [
                        "request_contact",
                        "respond_contact",
                        "send_message"
                      ],
                      "expected_frequency": "When onboarding new agent pairs.",
                      "required_capabilities": [
                        "contact",
                        "messaging",
                        "workflow"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Automated handshake",
                          "sample": "macro_contact_handshake(project_key='backend', requester='OpsBot', target='BlueLake', auto_accept=true, welcome_subject='Hello', welcome_body='Excited to collaborate!')"
                        }
                      ],
                      "capabilities": [
                        "contact",
                        "messaging",
                        "workflow"
                      ],
                      "complexity": "medium"
                    }
                  ]
                }
              ],
              "playbooks": [
                {
                  "workflow": "Kick off new agent session (macro)",
                  "sequence": [
                    "health_check",
                    "macro_start_session",
                    "summarize_thread"
                  ]
                },
                {
                  "workflow": "Kick off new agent session (manual)",
                  "sequence": [
                    "health_check",
                    "ensure_project",
                    "register_agent",
                    "fetch_inbox"
                  ]
                },
                {
                  "workflow": "Start focused refactor",
                  "sequence": [
                    "ensure_project",
                    "file_reservation_paths",
                    "send_message",
                    "fetch_inbox",
                    "acknowledge_message"
                  ]
                },
                {
                  "workflow": "Join existing discussion",
                  "sequence": [
                    "macro_prepare_thread",
                    "reply_message",
                    "acknowledge_message"
                  ]
                },
                {
                  "workflow": "Manage contact approvals",
                  "sequence": [
                    "set_contact_policy",
                    "request_contact",
                    "respond_contact",
                    "send_message"
                  ]
                }
              ]
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/generated_at"
            ]
          }
        }
      ]
    },
    "resource://tooling/directory?format=json": {
      "cases": [
        {
          "name": "tooling_directory_format_json",
          "input": {},
          "expect": {
            "ok": {
              "generated_at": null,
              "metrics_uri": "resource://tooling/metrics",
              "output_formats": {
                "default": "json",
                "tool_param": "format",
                "resource_query": "format",
                "values": [
                  "json",
                  "toon"
                ],
                "toon_envelope": {
                  "format": "toon",
                  "data": "<TOON>",
                  "meta": {
                    "requested": "toon"
                  }
                }
              },
              "clusters": [
                {
                  "name": "Infrastructure & Workspace Setup",
                  "purpose": "Bootstrap coordination and guardrails before agents begin editing.",
                  "tools": [
                    {
                      "name": "health_check",
                      "summary": "Report environment and HTTP wiring so orchestrators confirm connectivity.",
                      "use_when": "Beginning a session or during incident response triage.",
                      "related": [
                        "ensure_project"
                      ],
                      "expected_frequency": "Once per agent session or when connectivity is in doubt.",
                      "required_capabilities": [
                        "infrastructure"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Pre-flight",
                          "sample": "health_check()"
                        }
                      ],
                      "capabilities": [
                        "infrastructure"
                      ],
                      "complexity": "low"
                    },
                    {
                      "name": "ensure_project",
                      "summary": "Ensure project slug, schema, and archive exist for a shared repo identifier.",
                      "use_when": "First call against a repo or when switching projects.",
                      "related": [
                        "register_agent",
                        "file_reservation_paths"
                      ],
                      "expected_frequency": "Whenever a new repo/path is encountered.",
                      "required_capabilities": [
                        "infrastructure",
                        "storage"
                      ],
                      "usage_examples": [
                        {
                          "hint": "First action",
                          "sample": "ensure_project(human_key='/abs/path/backend')"
                        }
                      ],
                      "capabilities": [
                        "infrastructure",
                        "storage"
                      ],
                      "complexity": "low"
                    },
                    {
                      "name": "install_precommit_guard",
                      "summary": "Install Git pre-commit hook that enforces advisory file_reservations locally.",
                      "use_when": "Onboarding a repository into coordinated mode.",
                      "related": [
                        "file_reservation_paths",
                        "uninstall_precommit_guard"
                      ],
                      "expected_frequency": "Infrequent\u2014per repository setup.",
                      "required_capabilities": [
                        "infrastructure",
                        "repository"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Onboard",
                          "sample": "install_precommit_guard(project_key='backend', code_repo_path='~/repo')"
                        }
                      ],
                      "capabilities": [
                        "infrastructure",
                        "repository"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "uninstall_precommit_guard",
                      "summary": "Remove the advisory pre-commit hook from a repo.",
                      "use_when": "Decommissioning or debugging the guard hook.",
                      "related": [
                        "install_precommit_guard"
                      ],
                      "expected_frequency": "Rare; only when disabling guard enforcement.",
                      "required_capabilities": [
                        "infrastructure",
                        "repository"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Cleanup",
                          "sample": "uninstall_precommit_guard(code_repo_path='~/repo')"
                        }
                      ],
                      "capabilities": [
                        "infrastructure",
                        "repository"
                      ],
                      "complexity": "medium"
                    }
                  ]
                },
                {
                  "name": "Identity & Directory",
                  "purpose": "Register agents, mint unique identities, and inspect directory metadata.",
                  "tools": [
                    {
                      "name": "register_agent",
                      "summary": "Upsert an agent profile and refresh last_active_ts for a known persona.",
                      "use_when": "Resuming an identity or updating program/model/task metadata.",
                      "related": [
                        "create_agent_identity",
                        "whois"
                      ],
                      "expected_frequency": "At the start of each automated work session.",
                      "required_capabilities": [
                        "identity"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Resume persona",
                          "sample": "register_agent(project_key='/abs/path/backend', program='codex', model='gpt5')"
                        }
                      ],
                      "capabilities": [
                        "identity"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "create_agent_identity",
                      "summary": "Always create a new unique agent name (optionally using a sanitized hint).",
                      "use_when": "Spawning a brand-new helper that should not overwrite existing profiles.",
                      "related": [
                        "register_agent"
                      ],
                      "expected_frequency": "When minting fresh, short-lived identities.",
                      "required_capabilities": [
                        "identity"
                      ],
                      "usage_examples": [
                        {
                          "hint": "New helper",
                          "sample": "create_agent_identity(project_key='backend', name_hint='GreenCastle', program='codex', model='gpt5')"
                        }
                      ],
                      "capabilities": [
                        "identity"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "whois",
                      "summary": "Return enriched profile info plus recent archive commits for an agent.",
                      "use_when": "Dashboarding, routing coordination messages, or auditing activity.",
                      "related": [
                        "register_agent"
                      ],
                      "expected_frequency": "Ad hoc when context about an agent is required.",
                      "required_capabilities": [
                        "audit",
                        "identity"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Directory lookup",
                          "sample": "whois(project_key='backend', agent_name='BlueLake')"
                        }
                      ],
                      "capabilities": [
                        "audit",
                        "identity"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "set_contact_policy",
                      "summary": "Set inbound contact policy (open, auto, contacts_only, block_all).",
                      "use_when": "Adjusting how permissive an agent is about unsolicited messages.",
                      "related": [
                        "request_contact",
                        "respond_contact"
                      ],
                      "expected_frequency": "Occasional configuration change.",
                      "required_capabilities": [
                        "configure",
                        "contact"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Restrict inbox",
                          "sample": "set_contact_policy(project_key='backend', agent_name='BlueLake', policy='contacts_only')"
                        }
                      ],
                      "capabilities": [
                        "configure",
                        "contact"
                      ],
                      "complexity": "medium"
                    }
                  ]
                },
                {
                  "name": "Messaging Lifecycle",
                  "purpose": "Send, receive, and acknowledge threaded Markdown mail.",
                  "tools": [
                    {
                      "name": "send_message",
                      "summary": "Deliver a new message with attachments, WebP conversion, and policy enforcement.",
                      "use_when": "Starting new threads or broadcasting plans across projects.",
                      "related": [
                        "reply_message",
                        "request_contact"
                      ],
                      "expected_frequency": "Frequent\u2014core write operation.",
                      "required_capabilities": [
                        "messaging",
                        "write"
                      ],
                      "usage_examples": [
                        {
                          "hint": "New plan",
                          "sample": "send_message(project_key='backend', sender_name='GreenCastle', to=['BlueLake'], subject='Plan', body_md='...')"
                        }
                      ],
                      "capabilities": [
                        "messaging",
                        "write"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "reply_message",
                      "summary": "Reply within an existing thread, inheriting flags and default recipients.",
                      "use_when": "Continuing discussions or acknowledging decisions.",
                      "related": [
                        "send_message"
                      ],
                      "expected_frequency": "Frequent when collaborating inside a thread.",
                      "required_capabilities": [
                        "messaging",
                        "write"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Thread reply",
                          "sample": "reply_message(project_key='backend', message_id=42, sender_name='BlueLake', body_md='Got it!')"
                        }
                      ],
                      "capabilities": [
                        "messaging",
                        "write"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "fetch_inbox",
                      "summary": "Poll recent messages for an agent with filters (urgent_only, since_ts).",
                      "use_when": "After each work unit to ingest coordination updates.",
                      "related": [
                        "mark_message_read",
                        "acknowledge_message"
                      ],
                      "expected_frequency": "Frequent polling in agent loops.",
                      "required_capabilities": [
                        "messaging",
                        "read"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Poll",
                          "sample": "fetch_inbox(project_key='backend', agent_name='BlueLake', since_ts='2025-10-24T00:00:00Z')"
                        }
                      ],
                      "capabilities": [
                        "messaging",
                        "read"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "mark_message_read",
                      "summary": "Record read_ts for FYI messages without sending acknowledgements.",
                      "use_when": "Clearing inbox notifications once reviewed.",
                      "related": [
                        "acknowledge_message"
                      ],
                      "expected_frequency": "Whenever FYI mail is processed.",
                      "required_capabilities": [
                        "messaging",
                        "read"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Read receipt",
                          "sample": "mark_message_read(project_key='backend', agent_name='BlueLake', message_id=42)"
                        }
                      ],
                      "capabilities": [
                        "messaging",
                        "read"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "acknowledge_message",
                      "summary": "Set read_ts and ack_ts so senders know action items landed.",
                      "use_when": "Responding to ack_required messages.",
                      "related": [
                        "mark_message_read"
                      ],
                      "expected_frequency": "Each time a message requests acknowledgement.",
                      "required_capabilities": [
                        "ack",
                        "messaging"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Ack",
                          "sample": "acknowledge_message(project_key='backend', agent_name='BlueLake', message_id=42)"
                        }
                      ],
                      "capabilities": [
                        "ack",
                        "messaging"
                      ],
                      "complexity": "medium"
                    }
                  ]
                },
                {
                  "name": "Contact Governance",
                  "purpose": "Manage messaging permissions when policies are not open by default.",
                  "tools": [
                    {
                      "name": "request_contact",
                      "summary": "Create or refresh a pending AgentLink and notify the target with ack_required intro.",
                      "use_when": "Requesting permission before messaging another agent.",
                      "related": [
                        "respond_contact",
                        "set_contact_policy"
                      ],
                      "expected_frequency": "Occasional\u2014when new communication lines are needed.",
                      "required_capabilities": [
                        "contact"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Ask permission",
                          "sample": "request_contact(project_key='backend', from_agent='OpsBot', to_agent='BlueLake')"
                        }
                      ],
                      "capabilities": [
                        "contact"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "respond_contact",
                      "summary": "Approve or block a pending contact request, optionally setting expiry.",
                      "use_when": "Granting or revoking messaging permissions.",
                      "related": [
                        "request_contact"
                      ],
                      "expected_frequency": "As often as requests arrive.",
                      "required_capabilities": [
                        "contact"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Approve",
                          "sample": "respond_contact(project_key='backend', to_agent='BlueLake', from_agent='OpsBot', accept=True)"
                        }
                      ],
                      "capabilities": [
                        "contact"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "list_contacts",
                      "summary": "List outbound contact links, statuses, and expirations for an agent.",
                      "use_when": "Auditing who an agent may message or rotating expiring approvals.",
                      "related": [
                        "request_contact",
                        "respond_contact"
                      ],
                      "expected_frequency": "Periodic audits or dashboards.",
                      "required_capabilities": [
                        "audit",
                        "contact"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Audit",
                          "sample": "list_contacts(project_key='backend', agent_name='BlueLake')"
                        }
                      ],
                      "capabilities": [
                        "audit",
                        "contact"
                      ],
                      "complexity": "medium"
                    }
                  ]
                },
                {
                  "name": "Search & Summaries",
                  "purpose": "Surface signal from large mailboxes and compress long threads.",
                  "tools": [
                    {
                      "name": "search_messages",
                      "summary": "Run FTS5 queries across subject/body text to locate relevant threads.",
                      "use_when": "Triage or gathering context before editing.",
                      "related": [
                        "fetch_inbox",
                        "summarize_thread"
                      ],
                      "expected_frequency": "Regular during investigation phases.",
                      "required_capabilities": [
                        "search"
                      ],
                      "usage_examples": [
                        {
                          "hint": "FTS",
                          "sample": "search_messages(project_key='backend', query='\"build plan\" AND users', limit=20)"
                        }
                      ],
                      "capabilities": [
                        "search"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "summarize_thread",
                      "summary": "Extract participants, key points, and action items for one or more threads.",
                      "use_when": "Briefing new agents on long discussions, closing loops, or producing digests.",
                      "related": [
                        "search_messages"
                      ],
                      "expected_frequency": "When threads exceed quick skim length or at cadence checkpoints.",
                      "required_capabilities": [
                        "search",
                        "summarization"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Single thread",
                          "sample": "summarize_thread(project_key='backend', thread_id='TKT-123', include_examples=True)"
                        },
                        {
                          "hint": "Multi-thread digest",
                          "sample": "summarize_thread(project_key='backend', thread_id='TKT-123,UX-42,BUG-99')"
                        }
                      ],
                      "capabilities": [
                        "search",
                        "summarization"
                      ],
                      "complexity": "medium"
                    }
                  ]
                },
                {
                  "name": "File Reservations & Workspace Guardrails",
                  "purpose": "Coordinate file/glob ownership to avoid overwriting concurrent work.",
                  "tools": [
                    {
                      "name": "file_reservation_paths",
                      "summary": "Issue advisory file_reservations with overlap detection and Git artifacts.",
                      "use_when": "Before touching high-traffic surfaces or long-lived refactors.",
                      "related": [
                        "release_file_reservations",
                        "renew_file_reservations"
                      ],
                      "expected_frequency": "Whenever starting work on contested surfaces.",
                      "required_capabilities": [
                        "file_reservations",
                        "repository"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Lock file",
                          "sample": "file_reservation_paths(project_key='backend', agent_name='BlueLake', paths=['src/app.py'], ttl_seconds=7200)"
                        }
                      ],
                      "capabilities": [
                        "file_reservations",
                        "repository"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "release_file_reservations",
                      "summary": "Release active file_reservations (fully or by subset) and stamp released_ts.",
                      "use_when": "Finishing work so surfaces become available again.",
                      "related": [
                        "file_reservation_paths",
                        "renew_file_reservations"
                      ],
                      "expected_frequency": "Each time work on a surface completes.",
                      "required_capabilities": [
                        "file_reservations"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Unlock",
                          "sample": "release_file_reservations(project_key='backend', agent_name='BlueLake', paths=['src/app.py'])"
                        }
                      ],
                      "capabilities": [
                        "file_reservations"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "renew_file_reservations",
                      "summary": "Extend file_reservation expiry windows without allocating new file_reservation IDs.",
                      "use_when": "Long-running work needs more time but should retain ownership.",
                      "related": [
                        "file_reservation_paths",
                        "release_file_reservations"
                      ],
                      "expected_frequency": "Periodically during multi-hour work items.",
                      "required_capabilities": [
                        "file_reservations"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Extend",
                          "sample": "renew_file_reservations(project_key='backend', agent_name='BlueLake', extend_seconds=1800)"
                        }
                      ],
                      "capabilities": [
                        "file_reservations"
                      ],
                      "complexity": "medium"
                    }
                  ]
                },
                {
                  "name": "Workflow Macros",
                  "purpose": "Opinionated orchestrations that compose multiple primitives for smaller agents.",
                  "tools": [
                    {
                      "name": "macro_start_session",
                      "summary": "Ensure project, register/update agent, optionally file_reservation surfaces, and return inbox context.",
                      "use_when": "Kickstarting a focused work session with one call.",
                      "related": [
                        "ensure_project",
                        "register_agent",
                        "file_reservation_paths",
                        "fetch_inbox"
                      ],
                      "expected_frequency": "At the beginning of each autonomous session.",
                      "required_capabilities": [
                        "file_reservations",
                        "identity",
                        "messaging",
                        "workflow"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Bootstrap",
                          "sample": "macro_start_session(human_key='/abs/path/backend', program='codex', model='gpt5', file_reservation_paths=['src/api/*.py'])"
                        }
                      ],
                      "capabilities": [
                        "file_reservations",
                        "identity",
                        "messaging",
                        "workflow"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "macro_prepare_thread",
                      "summary": "Register or refresh an agent, summarise a thread, and fetch inbox context in one call.",
                      "use_when": "Briefing a helper before joining an ongoing discussion.",
                      "related": [
                        "register_agent",
                        "summarize_thread",
                        "fetch_inbox"
                      ],
                      "expected_frequency": "Whenever onboarding a new contributor to an active thread.",
                      "required_capabilities": [
                        "messaging",
                        "summarization",
                        "workflow"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Join thread",
                          "sample": "macro_prepare_thread(project_key='backend', thread_id='TKT-123', program='codex', model='gpt5', agent_name='ThreadHelper')"
                        }
                      ],
                      "capabilities": [
                        "messaging",
                        "summarization",
                        "workflow"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "macro_file_reservation_cycle",
                      "summary": "FileReservation a set of paths and optionally release them once work is complete.",
                      "use_when": "Wrapping a focused edit cycle that needs advisory locks.",
                      "related": [
                        "file_reservation_paths",
                        "release_file_reservations",
                        "renew_file_reservations"
                      ],
                      "expected_frequency": "Per guarded work block.",
                      "required_capabilities": [
                        "file_reservations",
                        "repository",
                        "workflow"
                      ],
                      "usage_examples": [
                        {
                          "hint": "FileReservation & release",
                          "sample": "macro_file_reservation_cycle(project_key='backend', agent_name='BlueLake', paths=['src/app.py'], auto_release=true)"
                        }
                      ],
                      "capabilities": [
                        "file_reservations",
                        "repository",
                        "workflow"
                      ],
                      "complexity": "medium"
                    },
                    {
                      "name": "macro_contact_handshake",
                      "summary": "Request contact approval, optionally auto-accept, and send a welcome message.",
                      "use_when": "Spinning up collaboration between two agents who lack permissions.",
                      "related": [
                        "request_contact",
                        "respond_contact",
                        "send_message"
                      ],
                      "expected_frequency": "When onboarding new agent pairs.",
                      "required_capabilities": [
                        "contact",
                        "messaging",
                        "workflow"
                      ],
                      "usage_examples": [
                        {
                          "hint": "Automated handshake",
                          "sample": "macro_contact_handshake(project_key='backend', requester='OpsBot', target='BlueLake', auto_accept=true, welcome_subject='Hello', welcome_body='Excited to collaborate!')"
                        }
                      ],
                      "capabilities": [
                        "contact",
                        "messaging",
                        "workflow"
                      ],
                      "complexity": "medium"
                    }
                  ]
                }
              ],
              "playbooks": [
                {
                  "workflow": "Kick off new agent session (macro)",
                  "sequence": [
                    "health_check",
                    "macro_start_session",
                    "summarize_thread"
                  ]
                },
                {
                  "workflow": "Kick off new agent session (manual)",
                  "sequence": [
                    "health_check",
                    "ensure_project",
                    "register_agent",
                    "fetch_inbox"
                  ]
                },
                {
                  "workflow": "Start focused refactor",
                  "sequence": [
                    "ensure_project",
                    "file_reservation_paths",
                    "send_message",
                    "fetch_inbox",
                    "acknowledge_message"
                  ]
                },
                {
                  "workflow": "Join existing discussion",
                  "sequence": [
                    "macro_prepare_thread",
                    "reply_message",
                    "acknowledge_message"
                  ]
                },
                {
                  "workflow": "Manage contact approvals",
                  "sequence": [
                    "set_contact_policy",
                    "request_contact",
                    "respond_contact",
                    "send_message"
                  ]
                }
              ]
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/generated_at"
            ]
          }
        }
      ]
    },
    "resource://tooling/schemas": {
      "cases": [
        {
          "name": "tooling_schemas",
          "input": {},
          "expect": {
            "ok": {
              "generated_at": null,
              "global_optional": [
                "format"
              ],
              "output_formats": {
                "default": "json",
                "tool_param": "format",
                "resource_query": "format",
                "values": [
                  "json",
                  "toon"
                ],
                "toon_envelope": {
                  "format": "toon",
                  "data": "<TOON>",
                  "meta": {
                    "requested": "toon"
                  }
                }
              },
              "tools": {
                "send_message": {
                  "required": [
                    "project_key",
                    "sender_name",
                    "to",
                    "subject",
                    "body_md"
                  ],
                  "optional": [
                    "cc",
                    "bcc",
                    "attachment_paths",
                    "convert_images",
                    "importance",
                    "ack_required",
                    "thread_id",
                    "auto_contact_if_blocked"
                  ],
                  "shapes": {
                    "to": "list[str]",
                    "cc": "list[str] | str",
                    "bcc": "list[str] | str",
                    "importance": "low|normal|high|urgent",
                    "auto_contact_if_blocked": "bool"
                  }
                },
                "macro_contact_handshake": {
                  "required": [
                    "project_key",
                    "requester|agent_name",
                    "target|to_agent"
                  ],
                  "optional": [
                    "reason",
                    "ttl_seconds",
                    "auto_accept",
                    "welcome_subject",
                    "welcome_body"
                  ],
                  "aliases": {
                    "requester": [
                      "agent_name"
                    ],
                    "target": [
                      "to_agent"
                    ]
                  }
                }
              }
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/generated_at"
            ]
          }
        }
      ]
    },
    "resource://tooling/schemas?format=json": {
      "cases": [
        {
          "name": "tooling_schemas_format_json",
          "input": {},
          "expect": {
            "ok": {
              "generated_at": null,
              "global_optional": [
                "format"
              ],
              "output_formats": {
                "default": "json",
                "tool_param": "format",
                "resource_query": "format",
                "values": [
                  "json",
                  "toon"
                ],
                "toon_envelope": {
                  "format": "toon",
                  "data": "<TOON>",
                  "meta": {
                    "requested": "toon"
                  }
                }
              },
              "tools": {
                "send_message": {
                  "required": [
                    "project_key",
                    "sender_name",
                    "to",
                    "subject",
                    "body_md"
                  ],
                  "optional": [
                    "cc",
                    "bcc",
                    "attachment_paths",
                    "convert_images",
                    "importance",
                    "ack_required",
                    "thread_id",
                    "auto_contact_if_blocked"
                  ],
                  "shapes": {
                    "to": "list[str]",
                    "cc": "list[str] | str",
                    "bcc": "list[str] | str",
                    "importance": "low|normal|high|urgent",
                    "auto_contact_if_blocked": "bool"
                  }
                },
                "macro_contact_handshake": {
                  "required": [
                    "project_key",
                    "requester|agent_name",
                    "target|to_agent"
                  ],
                  "optional": [
                    "reason",
                    "ttl_seconds",
                    "auto_accept",
                    "welcome_subject",
                    "welcome_body"
                  ],
                  "aliases": {
                    "requester": [
                      "agent_name"
                    ],
                    "target": [
                      "to_agent"
                    ]
                  }
                }
              }
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/generated_at"
            ]
          }
        }
      ]
    },
    "resource://tooling/metrics": {
      "cases": [
        {
          "name": "tooling_metrics",
          "input": {},
          "expect": {
            "ok": {
              "generated_at": null,
              "tools": [
                {
                  "name": "acknowledge_message",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "messaging",
                  "capabilities": [
                    "ack",
                    "messaging"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "acquire_build_slot",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "build_slots",
                  "capabilities": [
                    "build"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "create_agent_identity",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "identity",
                  "capabilities": [
                    "identity"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "ensure_product",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "product_bus",
                  "capabilities": [
                    "product"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "ensure_project",
                  "calls": 2,
                  "errors": 1,
                  "cluster": "infrastructure",
                  "capabilities": [
                    "infrastructure",
                    "storage"
                  ],
                  "complexity": "low"
                },
                {
                  "name": "fetch_inbox",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "messaging",
                  "capabilities": [
                    "messaging",
                    "read"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "fetch_inbox_product",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "product_bus",
                  "capabilities": [
                    "messaging",
                    "read"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "file_reservation_paths",
                  "calls": 3,
                  "errors": 1,
                  "cluster": "file_reservations",
                  "capabilities": [
                    "file_reservations",
                    "repository"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "force_release_file_reservation",
                  "calls": 1,
                  "errors": 1,
                  "cluster": "file_reservations",
                  "capabilities": [
                    "file_reservations",
                    "repository"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "health_check",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "infrastructure",
                  "capabilities": [
                    "infrastructure"
                  ],
                  "complexity": "low"
                },
                {
                  "name": "install_precommit_guard",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "infrastructure",
                  "capabilities": [
                    "infrastructure",
                    "repository"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "list_contacts",
                  "calls": 2,
                  "errors": 0,
                  "cluster": "contact",
                  "capabilities": [
                    "audit",
                    "contact"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "macro_contact_handshake",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "workflow_macros",
                  "capabilities": [
                    "contact",
                    "messaging",
                    "workflow"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "macro_file_reservation_cycle",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "workflow_macros",
                  "capabilities": [
                    "file_reservations",
                    "repository",
                    "workflow"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "macro_prepare_thread",
                  "calls": 2,
                  "errors": 0,
                  "cluster": "workflow_macros",
                  "capabilities": [
                    "messaging",
                    "summarization",
                    "workflow"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "macro_start_session",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "workflow_macros",
                  "capabilities": [
                    "file_reservations",
                    "identity",
                    "messaging",
                    "workflow"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "mark_message_read",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "messaging",
                  "capabilities": [
                    "messaging",
                    "read"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "products_link",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "product_bus",
                  "capabilities": [
                    "product"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "register_agent",
                  "calls": 2,
                  "errors": 0,
                  "cluster": "identity",
                  "capabilities": [
                    "identity"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "release_build_slot",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "build_slots",
                  "capabilities": [
                    "build"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "release_file_reservations",
                  "calls": 2,
                  "errors": 0,
                  "cluster": "file_reservations",
                  "capabilities": [
                    "file_reservations"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "renew_build_slot",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "build_slots",
                  "capabilities": [
                    "build"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "renew_file_reservations",
                  "calls": 3,
                  "errors": 1,
                  "cluster": "file_reservations",
                  "capabilities": [
                    "file_reservations"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "reply_message",
                  "calls": 3,
                  "errors": 0,
                  "cluster": "messaging",
                  "capabilities": [
                    "messaging",
                    "write"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "request_contact",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "contact",
                  "capabilities": [
                    "contact"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "respond_contact",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "contact",
                  "capabilities": [
                    "contact"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "search_messages",
                  "calls": 3,
                  "errors": 1,
                  "cluster": "search",
                  "capabilities": [
                    "search"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "search_messages_product",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "product_bus",
                  "capabilities": [
                    "search"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "send_message",
                  "calls": 4,
                  "errors": 1,
                  "cluster": "messaging",
                  "capabilities": [
                    "messaging",
                    "write"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "set_contact_policy",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "contact",
                  "capabilities": [
                    "configure",
                    "contact"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "summarize_thread",
                  "calls": 5,
                  "errors": 1,
                  "cluster": "search",
                  "capabilities": [
                    "search",
                    "summarization"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "summarize_thread_product",
                  "calls": 2,
                  "errors": 0,
                  "cluster": "product_bus",
                  "capabilities": [
                    "search",
                    "summarization"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "uninstall_precommit_guard",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "infrastructure",
                  "capabilities": [
                    "infrastructure",
                    "repository"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "whois",
                  "calls": 2,
                  "errors": 1,
                  "cluster": "identity",
                  "capabilities": [
                    "audit",
                    "identity"
                  ],
                  "complexity": "medium"
                }
              ]
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/generated_at"
            ]
          }
        }
      ]
    },
    "resource://tooling/metrics?format=json": {
      "cases": [
        {
          "name": "tooling_metrics_format_json",
          "input": {},
          "expect": {
            "ok": {
              "generated_at": null,
              "tools": [
                {
                  "name": "acknowledge_message",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "messaging",
                  "capabilities": [
                    "ack",
                    "messaging"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "acquire_build_slot",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "build_slots",
                  "capabilities": [
                    "build"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "create_agent_identity",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "identity",
                  "capabilities": [
                    "identity"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "ensure_product",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "product_bus",
                  "capabilities": [
                    "product"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "ensure_project",
                  "calls": 2,
                  "errors": 1,
                  "cluster": "infrastructure",
                  "capabilities": [
                    "infrastructure",
                    "storage"
                  ],
                  "complexity": "low"
                },
                {
                  "name": "fetch_inbox",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "messaging",
                  "capabilities": [
                    "messaging",
                    "read"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "fetch_inbox_product",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "product_bus",
                  "capabilities": [
                    "messaging",
                    "read"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "file_reservation_paths",
                  "calls": 3,
                  "errors": 1,
                  "cluster": "file_reservations",
                  "capabilities": [
                    "file_reservations",
                    "repository"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "force_release_file_reservation",
                  "calls": 1,
                  "errors": 1,
                  "cluster": "file_reservations",
                  "capabilities": [
                    "file_reservations",
                    "repository"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "health_check",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "infrastructure",
                  "capabilities": [
                    "infrastructure"
                  ],
                  "complexity": "low"
                },
                {
                  "name": "install_precommit_guard",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "infrastructure",
                  "capabilities": [
                    "infrastructure",
                    "repository"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "list_contacts",
                  "calls": 2,
                  "errors": 0,
                  "cluster": "contact",
                  "capabilities": [
                    "audit",
                    "contact"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "macro_contact_handshake",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "workflow_macros",
                  "capabilities": [
                    "contact",
                    "messaging",
                    "workflow"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "macro_file_reservation_cycle",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "workflow_macros",
                  "capabilities": [
                    "file_reservations",
                    "repository",
                    "workflow"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "macro_prepare_thread",
                  "calls": 2,
                  "errors": 0,
                  "cluster": "workflow_macros",
                  "capabilities": [
                    "messaging",
                    "summarization",
                    "workflow"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "macro_start_session",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "workflow_macros",
                  "capabilities": [
                    "file_reservations",
                    "identity",
                    "messaging",
                    "workflow"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "mark_message_read",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "messaging",
                  "capabilities": [
                    "messaging",
                    "read"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "products_link",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "product_bus",
                  "capabilities": [
                    "product"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "register_agent",
                  "calls": 2,
                  "errors": 0,
                  "cluster": "identity",
                  "capabilities": [
                    "identity"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "release_build_slot",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "build_slots",
                  "capabilities": [
                    "build"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "release_file_reservations",
                  "calls": 2,
                  "errors": 0,
                  "cluster": "file_reservations",
                  "capabilities": [
                    "file_reservations"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "renew_build_slot",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "build_slots",
                  "capabilities": [
                    "build"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "renew_file_reservations",
                  "calls": 3,
                  "errors": 1,
                  "cluster": "file_reservations",
                  "capabilities": [
                    "file_reservations"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "reply_message",
                  "calls": 3,
                  "errors": 0,
                  "cluster": "messaging",
                  "capabilities": [
                    "messaging",
                    "write"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "request_contact",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "contact",
                  "capabilities": [
                    "contact"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "respond_contact",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "contact",
                  "capabilities": [
                    "contact"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "search_messages",
                  "calls": 3,
                  "errors": 1,
                  "cluster": "search",
                  "capabilities": [
                    "search"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "search_messages_product",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "product_bus",
                  "capabilities": [
                    "search"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "send_message",
                  "calls": 4,
                  "errors": 1,
                  "cluster": "messaging",
                  "capabilities": [
                    "messaging",
                    "write"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "set_contact_policy",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "contact",
                  "capabilities": [
                    "configure",
                    "contact"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "summarize_thread",
                  "calls": 5,
                  "errors": 1,
                  "cluster": "search",
                  "capabilities": [
                    "search",
                    "summarization"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "summarize_thread_product",
                  "calls": 2,
                  "errors": 0,
                  "cluster": "product_bus",
                  "capabilities": [
                    "search",
                    "summarization"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "uninstall_precommit_guard",
                  "calls": 1,
                  "errors": 0,
                  "cluster": "infrastructure",
                  "capabilities": [
                    "infrastructure",
                    "repository"
                  ],
                  "complexity": "medium"
                },
                {
                  "name": "whois",
                  "calls": 2,
                  "errors": 1,
                  "cluster": "identity",
                  "capabilities": [
                    "audit",
                    "identity"
                  ],
                  "complexity": "medium"
                }
              ]
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/generated_at"
            ]
          }
        }
      ]
    },
    "resource://tooling/locks": {
      "cases": [
        {
          "name": "tooling_locks",
          "input": {},
          "expect": {
            "ok": {
              "locks": [],
              "summary": {
                "total": 0,
                "active": 0,
                "stale": 0,
                "metadata_missing": 0
              }
            }
          }
        }
      ]
    },
    "resource://tooling/locks?format=json": {
      "cases": [
        {
          "name": "tooling_locks_format_json",
          "input": {},
          "expect": {
            "ok": {
              "locks": [],
              "summary": {
                "total": 0,
                "active": 0,
                "stale": 0,
                "metadata_missing": 0
              }
            }
          }
        }
      ]
    },
    "resource://tooling/capabilities/BlueLake?project=abs-path-backend": {
      "cases": [
        {
          "name": "tooling_capabilities",
          "input": {},
          "expect": {
            "ok": {
              "generated_at": null,
              "agent": "BlueLake",
              "project": "abs-path-backend",
              "capabilities": []
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/generated_at"
            ]
          }
        }
      ]
    },
    "resource://tooling/recent/60?agent=BlueLake&project=abs-path-backend": {
      "cases": [
        {
          "name": "tooling_recent",
          "input": {},
          "expect": {
            "ok": {
              "generated_at": null,
              "window_seconds": 60,
              "count": 22,
              "entries": [
                {
                  "timestamp": null,
                  "tool": "acquire_build_slot",
                  "project": "abs-path-backend",
                  "agent": "BlueLake",
                  "cluster": "build_slots"
                },
                {
                  "timestamp": null,
                  "tool": "renew_build_slot",
                  "project": "abs-path-backend",
                  "agent": "BlueLake",
                  "cluster": "build_slots"
                },
                {
                  "timestamp": null,
                  "tool": "release_build_slot",
                  "project": "abs-path-backend",
                  "agent": "BlueLake",
                  "cluster": "build_slots"
                },
                {
                  "timestamp": null,
                  "tool": "register_agent",
                  "project": "abs-path-backend",
                  "agent": "BlueLake",
                  "cluster": "identity"
                },
                {
                  "timestamp": null,
                  "tool": "request_contact",
                  "project": "abs-path-backend",
                  "agent": "BlueLake",
                  "cluster": "contact"
                },
                {
                  "timestamp": null,
                  "tool": "list_contacts",
                  "project": "abs-path-backend",
                  "agent": "BlueLake",
                  "cluster": "contact"
                },
                {
                  "timestamp": null,
                  "tool": "send_message",
                  "project": "abs-path-backend",
                  "agent": "BlueLake",
                  "cluster": "messaging"
                },
                {
                  "timestamp": null,
                  "tool": "send_message",
                  "project": "abs-path-backend",
                  "agent": "BlueLake",
                  "cluster": "messaging"
                },
                {
                  "timestamp": null,
                  "tool": "send_message",
                  "project": "abs-path-backend",
                  "agent": "BlueLake",
                  "cluster": "messaging"
                },
                {
                  "timestamp": null,
                  "tool": "file_reservation_paths",
                  "project": "abs-path-backend",
                  "agent": "BlueLake",
                  "cluster": "file_reservations"
                },
                {
                  "timestamp": null,
                  "tool": "file_reservation_paths",
                  "project": "abs-path-backend",
                  "agent": "BlueLake",
                  "cluster": "file_reservations"
                },
                {
                  "timestamp": null,
                  "tool": "renew_file_reservations",
                  "project": "abs-path-backend",
                  "agent": "BlueLake",
                  "cluster": "file_reservations"
                },
                {
                  "timestamp": null,
                  "tool": "renew_file_reservations",
                  "project": "abs-path-backend",
                  "agent": "BlueLake",
                  "cluster": "file_reservations"
                },
                {
                  "timestamp": null,
                  "tool": "release_file_reservations",
                  "project": "abs-path-backend",
                  "agent": "BlueLake",
                  "cluster": "file_reservations"
                },
                {
                  "timestamp": null,
                  "tool": "force_release_file_reservation",
                  "project": "abs-path-backend",
                  "agent": "BlueLake",
                  "cluster": "file_reservations"
                },
                {
                  "timestamp": null,
                  "tool": "whois",
                  "project": "abs-path-backend",
                  "agent": "BlueLake",
                  "cluster": "identity"
                },
                {
                  "timestamp": null,
                  "tool": "macro_prepare_thread",
                  "project": "abs-path-backend",
                  "agent": "BlueLake",
                  "cluster": "workflow_macros"
                },
                {
                  "timestamp": null,
                  "tool": "macro_prepare_thread",
                  "project": "abs-path-backend",
                  "agent": "BlueLake",
                  "cluster": "workflow_macros"
                },
                {
                  "timestamp": null,
                  "tool": "file_reservation_paths",
                  "project": "abs-path-backend",
                  "agent": "BlueLake",
                  "cluster": "file_reservations"
                },
                {
                  "timestamp": null,
                  "tool": "release_file_reservations",
                  "project": "abs-path-backend",
                  "agent": "BlueLake",
                  "cluster": "file_reservations"
                },
                {
                  "timestamp": null,
                  "tool": "macro_file_reservation_cycle",
                  "project": "abs-path-backend",
                  "agent": "BlueLake",
                  "cluster": "workflow_macros"
                },
                {
                  "timestamp": null,
                  "tool": "macro_contact_handshake",
                  "project": "abs-path-backend",
                  "agent": "BlueLake",
                  "cluster": "workflow_macros"
                }
              ]
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/entries/0/timestamp",
              "/entries/1/timestamp",
              "/entries/10/timestamp",
              "/entries/11/timestamp",
              "/entries/12/timestamp",
              "/entries/13/timestamp",
              "/entries/14/timestamp",
              "/entries/15/timestamp",
              "/entries/16/timestamp",
              "/entries/17/timestamp",
              "/entries/18/timestamp",
              "/entries/19/timestamp",
              "/entries/2/timestamp",
              "/entries/20/timestamp",
              "/entries/21/timestamp",
              "/entries/3/timestamp",
              "/entries/4/timestamp",
              "/entries/5/timestamp",
              "/entries/6/timestamp",
              "/entries/7/timestamp",
              "/entries/8/timestamp",
              "/entries/9/timestamp",
              "/generated_at"
            ]
          }
        }
      ]
    },
    "resource://views/urgent-unread/GreenCastle?project=abs-path-backend&limit=10": {
      "cases": [
        {
          "name": "urgent_unread",
          "input": {},
          "expect": {
            "ok": {
              "project": "/abs/path/backend",
              "agent": "GreenCastle",
              "count": 1,
              "messages": [
                {
                  "id": 2,
                  "project_id": 1,
                  "sender_id": 1,
                  "thread_id": null,
                  "subject": "Hello",
                  "importance": "urgent",
                  "ack_required": true,
                  "created_ts": null,
                  "attachments": [],
                  "from": "BlueLake",
                  "kind": "to"
                }
              ]
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/messages/0/created_ts"
            ]
          }
        }
      ]
    },
    "resource://views/ack-required/GreenCastle?project=abs-path-backend&limit=10": {
      "cases": [
        {
          "name": "ack_required",
          "input": {},
          "expect": {
            "ok": {
              "project": "/abs/path/backend",
              "agent": "GreenCastle",
              "count": 1,
              "messages": [
                {
                  "id": 2,
                  "project_id": 1,
                  "sender_id": 1,
                  "thread_id": null,
                  "subject": "Hello",
                  "importance": "urgent",
                  "ack_required": true,
                  "created_ts": null,
                  "attachments": [],
                  "kind": "to"
                }
              ]
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/messages/0/created_ts"
            ]
          }
        }
      ]
    },
    "resource://views/acks-stale/GreenCastle?project=abs-path-backend&ttl_seconds=60&limit=10": {
      "cases": [
        {
          "name": "acks_stale",
          "input": {},
          "expect": {
            "ok": {
              "project": "/abs/path/backend",
              "agent": "GreenCastle",
              "ttl_seconds": 60,
              "count": 0,
              "messages": []
            }
          }
        }
      ]
    },
    "resource://views/ack-overdue/GreenCastle?project=abs-path-backend&ttl_minutes=1&limit=10": {
      "cases": [
        {
          "name": "ack_overdue",
          "input": {},
          "expect": {
            "ok": {
              "project": "/abs/path/backend",
              "agent": "GreenCastle",
              "count": 0,
              "messages": []
            }
          }
        }
      ]
    },
    "resource://mailbox/GreenCastle?project=abs-path-backend&limit=10": {
      "cases": [
        {
          "name": "mailbox",
          "input": {},
          "expect": {
            "ok": {
              "project": "/abs/path/backend",
              "agent": "GreenCastle",
              "count": 4,
              "messages": [
                {
                  "id": 4,
                  "project_id": 1,
                  "sender_id": 1,
                  "thread_id": "T-2",
                  "subject": "LLM Thread T-2",
                  "importance": "normal",
                  "ack_required": false,
                  "created_ts": null,
                  "attachments": [],
                  "from": "BlueLake",
                  "kind": "to",
                  "commit": {
                    "hexsha": null,
                    "summary": "file_reservation: BlueLake src/**"
                  }
                },
                {
                  "id": 3,
                  "project_id": 1,
                  "sender_id": 1,
                  "thread_id": "T-1",
                  "subject": "LLM Thread T-1",
                  "importance": "normal",
                  "ack_required": false,
                  "created_ts": null,
                  "attachments": [],
                  "from": "BlueLake",
                  "kind": "to",
                  "commit": {
                    "hexsha": null,
                    "summary": "file_reservation: BlueLake src/**"
                  }
                },
                {
                  "id": 2,
                  "project_id": 1,
                  "sender_id": 1,
                  "thread_id": null,
                  "subject": "Hello",
                  "importance": "urgent",
                  "ack_required": true,
                  "created_ts": null,
                  "attachments": [],
                  "from": "BlueLake",
                  "kind": "to",
                  "commit": {
                    "hexsha": null,
                    "summary": "file_reservation: BlueLake src/**"
                  }
                },
                {
                  "id": 1,
                  "project_id": 1,
                  "sender_id": 1,
                  "thread_id": null,
                  "subject": "Contact request from BlueLake",
                  "importance": "normal",
                  "ack_required": true,
                  "created_ts": null,
                  "attachments": [],
                  "from": "BlueLake",
                  "kind": "to",
                  "commit": {
                    "hexsha": null,
                    "summary": "file_reservation: BlueLake src/**"
                  }
                }
              ]
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/messages/0/commit/hexsha",
              "/messages/0/created_ts",
              "/messages/1/commit/hexsha",
              "/messages/1/created_ts",
              "/messages/2/commit/hexsha",
              "/messages/2/created_ts",
              "/messages/3/commit/hexsha",
              "/messages/3/created_ts"
            ]
          }
        }
      ]
    },
    "resource://mailbox-with-commits/GreenCastle?project=abs-path-backend&limit=10": {
      "cases": [
        {
          "name": "mailbox_with_commits",
          "input": {},
          "expect": {
            "ok": {
              "project": "/abs/path/backend",
              "agent": "GreenCastle",
              "count": 4,
              "messages": [
                {
                  "id": 4,
                  "project_id": 1,
                  "sender_id": 1,
                  "thread_id": "T-2",
                  "subject": "LLM Thread T-2",
                  "importance": "normal",
                  "ack_required": false,
                  "created_ts": null,
                  "attachments": [],
                  "from": "BlueLake",
                  "kind": "to",
                  "commit": {
                    "hexsha": null,
                    "summary": "mail: BlueLake -> GreenCastle | LLM Thread T-2",
                    "authored_ts": null,
                    "insertions": 22,
                    "deletions": 0,
                    "diff_summary": {
                      "hunks": 1,
                      "excerpt": null
                    }
                  }
                },
                {
                  "id": 3,
                  "project_id": 1,
                  "sender_id": 1,
                  "thread_id": "T-1",
                  "subject": "LLM Thread T-1",
                  "importance": "normal",
                  "ack_required": false,
                  "created_ts": null,
                  "attachments": [],
                  "from": "BlueLake",
                  "kind": "to",
                  "commit": {
                    "hexsha": null,
                    "summary": "mail: BlueLake -> GreenCastle | LLM Thread T-1",
                    "authored_ts": null,
                    "insertions": 22,
                    "deletions": 0,
                    "diff_summary": {
                      "hunks": 1,
                      "excerpt": null
                    }
                  }
                },
                {
                  "id": 2,
                  "project_id": 1,
                  "sender_id": 1,
                  "thread_id": null,
                  "subject": "Hello",
                  "importance": "urgent",
                  "ack_required": true,
                  "created_ts": null,
                  "attachments": [],
                  "from": "BlueLake",
                  "kind": "to",
                  "commit": {
                    "hexsha": null,
                    "summary": "mail: BlueLake -> GreenCastle | Hello",
                    "authored_ts": null,
                    "insertions": 21,
                    "deletions": 0,
                    "diff_summary": {
                      "hunks": 1,
                      "excerpt": null
                    }
                  }
                },
                {
                  "id": 1,
                  "project_id": 1,
                  "sender_id": 1,
                  "thread_id": null,
                  "subject": "Contact request from BlueLake",
                  "importance": "normal",
                  "ack_required": true,
                  "created_ts": null,
                  "attachments": [],
                  "from": "BlueLake",
                  "kind": "to",
                  "commit": {
                    "hexsha": null,
                    "summary": "mail: BlueLake -> GreenCastle | Contact request from BlueLake",
                    "authored_ts": null,
                    "insertions": 21,
                    "deletions": 0,
                    "diff_summary": {
                      "hunks": 1,
                      "excerpt": null
                    }
                  }
                }
              ]
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/messages/0/commit/authored_ts",
              "/messages/0/commit/diff_summary/excerpt",
              "/messages/0/commit/hexsha",
              "/messages/0/created_ts",
              "/messages/1/commit/authored_ts",
              "/messages/1/commit/diff_summary/excerpt",
              "/messages/1/commit/hexsha",
              "/messages/1/created_ts",
              "/messages/2/commit/authored_ts",
              "/messages/2/commit/diff_summary/excerpt",
              "/messages/2/commit/hexsha",
              "/messages/2/created_ts",
              "/messages/3/commit/authored_ts",
              "/messages/3/commit/diff_summary/excerpt",
              "/messages/3/commit/hexsha",
              "/messages/3/created_ts"
            ]
          }
        }
      ]
    },
    "resource://outbox/BlueLake?project=abs-path-backend&limit=10&include_bodies=true": {
      "cases": [
        {
          "name": "outbox",
          "input": {},
          "expect": {
            "ok": {
              "project": "/abs/path/backend",
              "agent": "BlueLake",
              "count": 4,
              "messages": [
                {
                  "id": 4,
                  "project_id": 1,
                  "sender_id": 1,
                  "thread_id": "T-2",
                  "subject": "LLM Thread T-2",
                  "importance": "normal",
                  "ack_required": false,
                  "created_ts": null,
                  "attachments": [],
                  "body_md": "- NEXT: migrate DB\n- ACTION: run script\n",
                  "from": "BlueLake",
                  "to": [
                    "GreenCastle"
                  ],
                  "cc": [],
                  "bcc": [],
                  "commit": {
                    "hexsha": null,
                    "summary": "mail: BlueLake -> GreenCastle | LLM Thread T-2",
                    "authored_ts": null,
                    "insertions": 22,
                    "deletions": 0,
                    "diff_summary": {
                      "hunks": 1,
                      "excerpt": null
                    }
                  }
                },
                {
                  "id": 3,
                  "project_id": 1,
                  "sender_id": 1,
                  "thread_id": "T-1",
                  "subject": "LLM Thread T-1",
                  "importance": "normal",
                  "ack_required": false,
                  "created_ts": null,
                  "attachments": [],
                  "body_md": "- TODO: deploy to staging\n- discussed API changes\n",
                  "from": "BlueLake",
                  "to": [
                    "GreenCastle"
                  ],
                  "cc": [],
                  "bcc": [],
                  "commit": {
                    "hexsha": null,
                    "summary": "mail: BlueLake -> GreenCastle | LLM Thread T-1",
                    "authored_ts": null,
                    "insertions": 22,
                    "deletions": 0,
                    "diff_summary": {
                      "hunks": 1,
                      "excerpt": null
                    }
                  }
                },
                {
                  "id": 2,
                  "project_id": 1,
                  "sender_id": 1,
                  "thread_id": null,
                  "subject": "Hello",
                  "importance": "urgent",
                  "ack_required": true,
                  "created_ts": null,
                  "attachments": [],
                  "body_md": "Test",
                  "from": "BlueLake",
                  "to": [
                    "GreenCastle"
                  ],
                  "cc": [],
                  "bcc": [],
                  "commit": {
                    "hexsha": null,
                    "summary": "mail: BlueLake -> GreenCastle | Hello",
                    "authored_ts": null,
                    "insertions": 21,
                    "deletions": 0,
                    "diff_summary": {
                      "hunks": 1,
                      "excerpt": null
                    }
                  }
                },
                {
                  "id": 1,
                  "project_id": 1,
                  "sender_id": 1,
                  "thread_id": null,
                  "subject": "Contact request from BlueLake",
                  "importance": "normal",
                  "ack_required": true,
                  "created_ts": null,
                  "attachments": [],
                  "body_md": "BlueLake requests permission to contact GreenCastle.",
                  "from": "BlueLake",
                  "to": [
                    "GreenCastle"
                  ],
                  "cc": [],
                  "bcc": [],
                  "commit": {
                    "hexsha": null,
                    "summary": "mail: BlueLake -> GreenCastle | Contact request from BlueLake",
                    "authored_ts": null,
                    "insertions": 21,
                    "deletions": 0,
                    "diff_summary": {
                      "hunks": 1,
                      "excerpt": null
                    }
                  }
                }
              ]
            }
          },
          "normalize": {
            "ignore_json_pointers": [
              "/messages/0/commit/authored_ts",
              "/messages/0/commit/diff_summary/excerpt",
              "/messages/0/commit/hexsha",
              "/messages/0/created_ts",
              "/messages/1/commit/authored_ts",
              "/messages/1/commit/diff_summary/excerpt",
              "/messages/1/commit/hexsha",
              "/messages/1/created_ts",
              "/messages/2/commit/authored_ts",
              "/messages/2/commit/diff_summary/excerpt",
              "/messages/2/commit/hexsha",
              "/messages/2/created_ts",
              "/messages/3/commit/authored_ts",
              "/messages/3/commit/diff_summary/excerpt",
              "/messages/3/commit/hexsha",
              "/messages/3/created_ts"
            ]
          }
        }
      ]
    }
  }
}
